---
layout: ccie
title: lab考题分析1.10
date: 2023-07-03 10:17:29
tags: CCIE
---

继续考题分析1.10. 这题是对BGP peer group以及部分mpls的考察。
<!--more-->

# Bringing up VPNv4 and VPNv6 in SP1

下面是考题。
```
Configure routers r3,r4,r5,r6 in SP1 according to these requirements.

Configure r3 through r6mutual vpnv4 and vpnv6 route exchange

configgure r3 as a router-reflector

configure r4,r5 and r6 as clients of router-reflector

use minimal configuration for achieving this task

use peer-group GlobalSP

use lo0 ipv4 addresses for peering

configuration r3 through r6 to assign(allocate/bind) as few unique MPLS labels to all existing and future vpnv4 and vpnv6 routes as possible.

on routers r3 through r6，prevent any existing and future customer from discovering detail about the inter topology of SP1, it is not allowed to use ACLs to accomplish this requirement.
```

lab1.10的拓扑如下
![](https://rancho333.github.io/pictures/lab_1.10.png)

共设计到4台设备，分别是r3,r4,r5,r6，其中r1,r2的所有接口开启mpls，SP1中就是典型`f-VRF+MPLS`的拓扑。r3作为bgp的路由反射器，通过peer group与另外三台建立邻居，r4,5,6作为客户端。此外，配置mpls隐藏sp1内部拓扑，相同vpn使用同一个lable。

配置思路如下：
- 配置r3作为路由反射器，与r4,5,6建立iBGP邻居
- 配置mpls
- 分别配置r4,5,6与r3建立iBGP邻居

解法如下：
1. 配置r3
```
router bgp 10000
    bgp router-id 100.255.54.3          // 手动配置bgp router-id
    no bgp default ipv4-unicast         // 不默认激活ipv4邻居

    neighbor GlobalSP peer-group
    neighbor GlobalSP remote-as 10000
    neighbor GlobalSP update-source lo0        // 配置对等体

    neighbor 100.255.254.4 peer-group GlobalSP
    neighbor 100.255.254.5 peer-group GlobalSP
    neighbor 100.255.254.6 peer-group GlobalSP  // 给对等体添加成员

    address-family vpnv4
        neighbor 100.255.254.4 active
        neighbor 100.255.254.5 active
        neighbor 100.255.254.6 active           // 激活对等体中的邻居
        neighbor GlobalSP route-reflector-client    // 配置RR客户端
```

2. 配置mpls
```
r3,4,5,6：
mpls label all-vrfs protocol bgp-vpnv4 per-vrf
mpls label all-vrfs protocol bgp-vpnv6 per-vrf      // vpnv4和vpnv6所有的地址族，基于每一个vrf一个标签
no mpls ip propagate-ttl forwarded          // 在mpls域内的边界PE上关闭TTL繁衍，防止mpls内部拓扑被发现
```

3. 配置r4,5,6
```
router bgp 10000
    no bgp default ipv4-unicast
    bgp router-id 100.255.254.4/5/6

    neighbor 100.255.254.3 remote-as 10000
    neighbor 100.255.254.3 update-source lo0
address vpnv4
    neighbor 100.255.254.3 active
address vpnv6
    neighbor 100.255.254.3 active        // 在vpnv4和vpnv6下分别激活邻居
```

配置完成之后在r3上查看bgp邻居，在vpnv4和vpnv6下分别与r4,5,6建立bgp邻居，vpnv4下另外两个邻居r11和r21是在1.9中建立的。
![](https://rancho333.github.io/pictures/lab_1.10_neighbor.png)

label这玩意也不是太懂，加个配置就行了，现象后面再研究吧。R70的lo0已经预配通过BGP通告路由，R11现在可以ping通`10.7.255.70`.
![](https://rancho333.github.io/pictures/lab_1.10_ping_r70.png)

通过tracroute解析每一跳，可以发现SP1中的路径被隐藏。
![](https://rancho333.github.io/pictures/lab_1.10_tracroute_r70.png)