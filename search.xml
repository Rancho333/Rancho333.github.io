<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2021å¹´å¤©å¼˜è·‘å›¢æ•°æ®</title>
    <url>/2021/01/04/2021%E5%B9%B4%E5%A4%A9%E5%BC%98%E8%B7%91%E5%9B%A2%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<p>2021å¹´å¤©å¼˜è·‘å›¢æ•°æ®ç»Ÿè®¡</p>
<p>1æœˆ1å·è‡³1æœˆ3å·</p>
<span id="more"></span>
<table>
<thead>
<tr>
<th align="left">å§“å</th>
<th align="left">æ—¥æœŸ</th>
<th align="left">æ–¹å¼</th>
<th align="left">è·ç¦»/km</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Leon</td>
<td align="left">1.1</td>
<td align="left">çº¿ä¸Š</td>
<td align="left">20.21</td>
</tr>
<tr>
<td align="left">Rancho</td>
<td align="left">1.1+1.2</td>
<td align="left">çº¿ä¸Š+çº¿ä¸‹</td>
<td align="left">20.21+10</td>
</tr>
<tr>
<td align="left">Gary</td>
<td align="left">1.1</td>
<td align="left">çº¿ä¸Š</td>
<td align="left">4.3</td>
</tr>
<tr>
<td align="left">Jason</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸‹</td>
<td align="left">20</td>
</tr>
<tr>
<td align="left">Ceecee+å°æœ‹å‹</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸‹</td>
<td align="left">5+5</td>
</tr>
<tr>
<td align="left">æ¨å¤</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸‹</td>
<td align="left">15</td>
</tr>
<tr>
<td align="left">Lisa</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸‹</td>
<td align="left">5</td>
</tr>
<tr>
<td align="left">Lewis+å°æœ‹å‹</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸‹</td>
<td align="left">10+5</td>
</tr>
<tr>
<td align="left">å´å¾ç¥¥</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸‹</td>
<td align="left">10</td>
</tr>
<tr>
<td align="left">energy</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸Š</td>
<td align="left">4.73</td>
</tr>
<tr>
<td align="left">xiang</td>
<td align="left">1.2</td>
<td align="left">çº¿ä¸Š</td>
<td align="left">8.25</td>
</tr>
</tbody></table>
<p>2æœˆ10å·è‡³18å·æ˜¥èŠ‚è·‘æ­¥æ‰“å¡æ•°æ®ç»Ÿè®¡</p>
<table>
<thead>
<tr>
<th align="left">å§“å</th>
<th align="left">æ•°æ®</th>
<th align="left">ç´¯è®¡/km</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Lewis+å°æœ‹å‹</td>
<td align="left">5.03(10) + 7.68(13)</td>
<td align="left">12.71</td>
</tr>
<tr>
<td align="left">Rancho</td>
<td align="left">10.02(10) + 7.55(13) + 10.02(14) + 10.39(15) + 10.05(16) + 6.07(17) + 14.24(18)</td>
<td align="left">68.34</td>
</tr>
<tr>
<td align="left">Ceecee+å°æœ‹å‹</td>
<td align="left">7.55(13)</td>
<td align="left">7.55</td>
</tr>
<tr>
<td align="left">Xiang</td>
<td align="left">22.26(11) + 22.27(16)</td>
<td align="left">44.53</td>
</tr>
<tr>
<td align="left">Even</td>
<td align="left">8.88(12) + 13.14(14)</td>
<td align="left">22.02</td>
</tr>
<tr>
<td align="left">Leon</td>
<td align="left">8.88(12) + 12.21(13) + 13.14(14) + 15.21(15) + 14.91(17)</td>
<td align="left">64.35</td>
</tr>
<tr>
<td align="left">Jason</td>
<td align="left">9.01(10) + 4.87+7.68+5.16(13) + 9.85(15) + 9.02(17) + 6.06(18)</td>
<td align="left">51.65</td>
</tr>
<tr>
<td align="left">Linda</td>
<td align="left">7.05(13)</td>
<td align="left">7.05</td>
</tr>
<tr>
<td align="left">Jack XU</td>
<td align="left">3.03(14) + 3.03(16)</td>
<td align="left">6.06</td>
</tr>
<tr>
<td align="left">Vivian</td>
<td align="left">5.18(10) + 5.51(13) + 5.22(14) + 5.64(17) + 5.23(18)</td>
<td align="left">26.78</td>
</tr>
<tr>
<td align="left">ian.Yuan</td>
<td align="left">9.61(16) + 6.93(18)</td>
<td align="left">16.54</td>
</tr>
</tbody></table>
<p>2022å¹´1æœˆ1å·è‡³3å·å…ƒæ—¦è·‘æ­¥æ•°æ®ï¼š<br>| å§“å | æ•°æ® | ç´¯è®¡/km |<br>| :â€” | :â€” | :â€” |<br>| æ¨é¹é£ | 5.2+5.4 | 10.6 |<br>| Xiang | 15 | 15 |<br>| Rancho | 20.22 | 20.22 |<br>| æé£ | 5.03+5.03 | 10.06 |<br>| å¢æµ·é¾™ | 8.18+7.22 | 15.4|<br>| ç§¦æ™¯ | 5.31 | 5.31 |<br>| Lewis | 5.02 | 5.02 |<br>| Jack Xu | 3.57+5.18+6.51 | 15.26|<br>| Leon | 20.22 | 20.22 |<br>| Andy | 22.22 | 22.22 |<br>| å†›ç”Ÿ | 10.86+20.22 | 31.08|<br>| ä¸‡ä¿Šéœ | 3.7 | 3.7 |<br>| Keven | 5.2 | 5.2 |<br>| æ´‹æ¡”æ¢— | 5.48 | 5.48 |<br>| Silesfleur | 6.27 | 6.27 |<br>| Gary | 5.22+5.55 | 10.77 |<br>| 5km |  6äºº |<br>| 10km | 3äºº |<br>| 15km | 7äºº | </p>
<ol>
<li>Rancho + ç”· + XL</li>
<li>Ceecee Nie +å¥³+ M</li>
<li>Lewis+ç”·+XL</li>
<li>å¢æµ·é¾™ + ç”· + XL</li>
<li>Wind Wang+ç”·+XL</li>
<li>Milly Li +å¥³+M</li>
<li>Ferris+ç”·+XL</li>
<li>é™ˆæ¯“æ•Even +å¥³+L</li>
<li>xiang+ç”·+2XL</li>
<li>Leon + ç”· + 3XL</li>
<li>æ¨å¤ + ç”· + XL</li>
<li>å‘¨å†› + ç”· +  XL</li>
<li>ğŸƒJason Zhang +ç”·+L</li>
<li>zl  + å¥³ + xl</li>
<li>è®¸å¤©è¾‰-TianhuiXu  + ç”·+ L</li>
<li>å¤©å¤© +å¥³+M</li>
<li>æè¶…è¶… + å¥³ +  L</li>
<li>ä¸‡ä¿Šéœ+å¥³+M</li>
<li>Sandy Zhang+ç”· + XL</li>
<li>Jack XU +ç”·+XL</li>
<li>Lisa Q +å¥³+XL</li>
<li>Vivian Xue+å¥³+XL</li>
<li>Chad Xu +ç”·+3XL</li>
<li>Jenny Yang+å¥³XL</li>
<li>Keven kai+ç”· 3XL</li>
<li>Jeff Zhang+ç”·+XL</li>
<li>Don Liu +ç”·+3XL</li>
<li>Lindsay Zou +å¥³+XL</li>
<li>è–›æ™¶+å¥³+L</li>
<li>è¬ +ç”·+2XL</li>
<li>Maggie Yu + å¥³+2XL</li>
<li>ç§‹_ç§‹_ ï¼‹å¥³ï¼‹XL</li>
<li>donmi + ç”· + 2XL</li>
<li>Michael + ç”·+L</li>
<li>Tom Mo + ç”· + 3XL</li>
<li>çŸ¿å£«Orge +ç”·+L</li>
<li>Ely Sun + ç”· + L</li>
<li>Mark Wu+ç”·+3XL</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>Basic-L2-L3-test-for-CLS_VS_SONIC</title>
    <url>/2023/09/07/Basic-L2-L3-test-for-CLS-VS-SONIC/</url>
    <content><![CDATA[<h1 id="Environment-setup"><a href="#Environment-setup" class="headerlink" title="Environment setup"></a>Environment setup</h1><p>Firstly, we setup the test environment like below picture.</p>
<p><img src="https://rancho333.github.io/pictures/vs-sonic-environment.png"></p>
<span id="more"></span>

<p>vpc1 and vpc2 perform L2 basic test in vlan100. q2a-1 and q2a-2 establish eBGP neighbors to perform l3 basic test, so that vpc1,vpc2 and vpc3 can communicate.</p>
<h1 id="L2-basic-test"><a href="#L2-basic-test" class="headerlink" title="L2 basic test"></a>L2 basic test</h1><p>We create vlan100 and create SVI as vlan100 gateway. Eth1 and Eth2 are the vlan100 member ports. Please pay attention to the mapping relationship between the port name of eveng and the port name of sonic.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q2a-1:</span><br><span class="line">config vlan add 100                              &#x2F;&#x2F; create vlan100</span><br><span class="line">config vlan member add 100 Ethernet4 -u          &#x2F;&#x2F; add vlan member, SONiC Ethernet4 mapping eveng Ethernet1</span><br><span class="line">config vlan member add 100 Ethernet8 -u          &#x2F;&#x2F; SONiC Ethernet8 mapping eveng Ethernet2</span><br><span class="line">config interface ip add Vlan100 192.168.1.1&#x2F;24   &#x2F;&#x2F; create SVI</span><br></pre></td></tr></table></figure>

<p>After vlan configuration done, check the vlan state like below picture.<br><img src="https://rancho333.github.io/pictures/vs-sonic-vlan.png"></p>
<p>Config the vpc1 and vpc2 like below picture.<br><img src="https://rancho333.github.io/pictures/vs-sonic-vlan-vpc.png"></p>
<p>Make sure that vpc1 can ping the gateway and vpc2. Same as vpc2.<br><img src="https://rancho333.github.io/pictures/vs-sonic-vpc1-vpc2.png"></p>
<p>Check the mac address table and arp table on q2a-1 respectively.<br><img src="https://rancho333.github.io/pictures/vs-sonic-mac-arp.png"></p>
<h1 id="L3-basic-test"><a href="#L3-basic-test" class="headerlink" title="L3 basic test"></a>L3 basic test</h1><p>We create L3 interface on q2a-1 and q2a-2 respectively like below picture.<br><img src="https://rancho333.github.io/pictures/vs-sonic-if-ip.png"></p>
<p>After that, We can configure eBGP to propagate routes. For q2a-1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">router bgp 100                          &#x2F;&#x2F; Asign ASN 100 to q2a-1</span><br><span class="line"> neighbor 192.168.2.2 remote-as 200     &#x2F;&#x2F; Specify neighbor ip and ASN</span><br><span class="line"></span><br><span class="line">address-family ipv4 unicast</span><br><span class="line">  redistribute connected                &#x2F;&#x2F; redistribute connected routes into BGP (subnet of 192.168.1.0)</span><br></pre></td></tr></table></figure>

<p>For q2a-2, same as q2a-1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">router bgp 200</span><br><span class="line"> neighbor 192.168.2.1 remote-as 100</span><br><span class="line"></span><br><span class="line">address-family ipv4 unicast</span><br><span class="line">  redistribute connected</span><br></pre></td></tr></table></figure>

<p>Make sure q2a-1 and q2a-2 can establish BGP neighbor and send routes to each other.<br><img src="https://rancho333.github.io/pictures/vs-sonic-bgp-neighbor.png"></p>
<p>Check q2a-1 can learn 192.168.3.0 from BGP and q2a-2 can learn 192.168.1.0 form BGP.<br><img src="https://rancho333.github.io/pictures/vs-sonic-bgp-routes.png"></p>
<p>Finally, check vpc1-vpc3 and vpc2-vpc3 can communicate with each other.<br><img src="https://rancho333.github.io/pictures/vs-sonic-ping-finally.png"></p>
<p>WindowsSensor.MaverickGyr.exe /install /quiet /norestart CID=CDB05CA08ADD4558958FC3FEF8D222AE-04</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>Cè¯­è¨€å¼±ç¬¦å·weak</title>
    <url>/2020/03/03/C%E8%AF%AD%E8%A8%80%E5%BC%B1%E7%AC%A6%E5%8F%B7weak/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>ä¸Šä¸€ç¯‡æ–‡ç« ã€ŠENOSä¸Šæ®µé”™è°ƒè¯•è®°å½•ã€‹ä¸­æœ‰æåˆ°å¼±ç¬¦å·<code>weak</code>å¼•å‘çš„æ®µé”™ï¼Œè¿™ç¯‡æ–‡ç« æ¥å­¦ä¹ ä¸€ä¸‹weakçš„ç”¨æ³•ã€‚è¯´æ¥æƒ­æ„§ï¼Œå·¥ä½œäº†å¿«4å¹´ï¼Œç¬¬ä¸€æ¬¡è§åˆ°è¿™ä¸ªè¯­æ³•ã€‚</p>
<span id="more"></span>
<h1 id="weakå¼±ç¬¦å·å®šä¹‰"><a href="#weakå¼±ç¬¦å·å®šä¹‰" class="headerlink" title="weakå¼±ç¬¦å·å®šä¹‰"></a>weakå¼±ç¬¦å·å®šä¹‰</h1><p>ç½‘ä¸Šæ‰¾äº†ä¸‹weakç¬¦å·çš„å®šä¹‰ï¼š#pragma weak to define a weakglobal symbol. This pragma is used mainly in source files for building libraries. The linker does not produce an error if it is unable to resolve a weak symbol.<br>å¯¹äºå…¨å±€çš„å‡½æ•°å’Œå˜é‡ï¼Œèƒ½ä¸èƒ½é‡å‘½åæ˜¯æœ‰ä¸€å®šçš„è§„çŸ©çš„ï¼Œå¼ºã€å¼±ç¬¦å·å°±æ˜¯é’ˆå¯¹è¿™äº›å…¨å±€å‡½æ•°å’Œå˜é‡æ¥è¯´çš„ã€‚</p>
<table>
<thead>
<tr>
<th align="left">ç¬¦å·ç±»å‹</th>
<th align="left">å¯¹è±¡</th>
</tr>
</thead>
<tbody><tr>
<td align="left">å¼º</td>
<td align="left">å‡½æ•°åï¼Œèµ‹åˆå€¼çš„å…¨å±€å˜é‡</td>
</tr>
<tr>
<td align="left">å¼±</td>
<td align="left">æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</td>
</tr>
</tbody></table>
<p>å½“ä»£ç ä¸­å­˜åœ¨å¤šä¸ªå¼ºæˆ–å¼±çš„å…¨å±€å˜é‡æ—¶ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¼ºç¬¦å·åªèƒ½å®šä¹‰ä¸€æ¬¡ï¼Œå¦åˆ™ç¼–è¯‘error(æœªä½¿ç”¨weakä¿®é¥°çš„éƒ½æ˜¯å¼ºç¬¦å·)</li>
<li>å¼ºå¼±ç¬¦å·åŒæ—¶å­˜åœ¨ï¼Œä»¥å¼ºç¬¦å·ä¸ºå‡†</li>
<li>æ²¡æœ‰å¼ºç¬¦å·ï¼Œä»å¤šä¸ªå¼±ç¬¦å·ä¸­é€‰ä¸€ä¸ªï¼Œ<code>-fno-common</code>è¿™ç§æƒ…å†µä¸‹å¯ä»¥æ‰“å‡º<code>warning</code><br>è¿™ç©æ„çš„ç”¨é€”æœ‰ç‚¹ç±»ä¼¼äº<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ifndef name</span><br><span class="line">    #define name</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="ä»£ç æ¼”ç¤º"><a href="#ä»£ç æ¼”ç¤º" class="headerlink" title="ä»£ç æ¼”ç¤º"></a>ä»£ç æ¼”ç¤º</h1><h2 id="å¼±ç¬¦å·å£°æ˜"><a href="#å¼±ç¬¦å·å£°æ˜" class="headerlink" title="å¼±ç¬¦å·å£°æ˜"></a>å¼±ç¬¦å·å£°æ˜</h2><p>ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extern void weak0();</span><br><span class="line">#pragma weak weak0</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§æ–¹å¼</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void __attribute__((weak)) weak0();</span><br></pre></td></tr></table></figure>

<h2 id="è§„åˆ™æ¼”ç¤º"><a href="#è§„åˆ™æ¼”ç¤º" class="headerlink" title="è§„åˆ™æ¼”ç¤º"></a>è§„åˆ™æ¼”ç¤º</h2><p>ä¸‹é¢é€šè¿‡ä¸‰æ®µä»£ç æ¥æ¼”ç¤ºä¸Šè¯‰çš„3æ¡è§„åˆ™ã€‚</p>
<h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><p><code>main.c</code>é‡Œé¢è°ƒç”¨äº†2ä¸ªå£°æ˜ä¸ºå¼±ç¬¦å·çš„å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯<code>weak0</code>å’Œ<code>weak1</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;                                                                                                                                                                                              </span><br><span class="line">&#x2F;&#x2F;void __attribute__((weak)) weak0(void);</span><br><span class="line">&#x2F;&#x2F;void __attribute__((weak)) weak1(void);</span><br><span class="line">extern void weak0();</span><br><span class="line">extern void weak1();</span><br><span class="line">#pragma weak weak0</span><br><span class="line">#pragma weak weak1</span><br><span class="line"> </span><br><span class="line">int main(int argc, char **argv)&#123;</span><br><span class="line">    &#x2F;&#x2F;å°è¯•è°ƒç”¨å¼±ç¬¦å·å‡½æ•°weak0</span><br><span class="line">    if (weak0)&#123;</span><br><span class="line">        weak0();</span><br><span class="line">    &#125;   </span><br><span class="line">    else&#123;</span><br><span class="line">        printf(&quot;weak0&#x3D;%p\n&quot;, weak0);</span><br><span class="line">    &#125;   </span><br><span class="line">    &#x2F;&#x2F;å°è¯•è°ƒç”¨å¼±ç¬¦å·å‡½æ•°weak1</span><br><span class="line">    if (weak1)&#123;</span><br><span class="line">        weak1();</span><br><span class="line">    &#125;   </span><br><span class="line">    else&#123;</span><br><span class="line">        printf(&quot;weak1&#x3D;%p\n&quot;, weak1);</span><br><span class="line">    &#125;   </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="weak-c"><a href="#weak-c" class="headerlink" title="weak.c"></a>weak.c</h3><p><code>weak.c</code>ä¸­å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼ˆweak0å’Œweak1ï¼‰ï¼Œå¹¶å°†ä¹‹å£°æ˜ä¸ºå¼±ç¬¦å·</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ ‡è®°weak0ä¸ºå¼±ç¬¦å·</span><br><span class="line">#pragma weak weak0</span><br><span class="line">&#x2F;&#x2F;æ ‡è®°weak1ä¸ºå¼±ç¬¦å·</span><br><span class="line">void __attribute__((weak)) weak1(void);</span><br><span class="line"></span><br><span class="line">static char *label &#x3D; &quot;weak&quot;;</span><br><span class="line"></span><br><span class="line">void weak0(void)&#123;</span><br><span class="line">    printf(&quot;[%s]%s is called\n&quot;, label, __FUNCTION__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void weak1(void)&#123;</span><br><span class="line">    printf(&quot;[%s]%s is called\n&quot;, label, __FUNCTION__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="strong-c"><a href="#strong-c" class="headerlink" title="strong.c"></a>strong.c</h3><p><code>strong.c</code>ä¸­é‡å¤å®šä¹‰äº†è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä¸åšå£°æ˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä¸¤ä¸ªå‡½æ•°éƒ½[ä¸]å£°æ˜ä¸ºå¼±ç¬¦å·</span><br><span class="line">&#x2F;&#x2F;#pragma weak weak0</span><br><span class="line">&#x2F;&#x2F;void __attribute__((weak)) weak1(void);</span><br><span class="line"></span><br><span class="line">static char *label &#x3D; &quot;strong&quot;;</span><br><span class="line"></span><br><span class="line">void weak0(void)&#123;</span><br><span class="line">    printf(&quot;[%s]%s is called\n&quot;, label, __FUNCTION__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void weak1(void)&#123;</span><br><span class="line">    printf(&quot;[%s]%s is called\n&quot;, label, __FUNCTION__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸åŒç¼–è¯‘ç»„åˆåŠå…¶è¾“å‡ºæƒ…å†µ"><a href="#ä¸åŒç¼–è¯‘ç»„åˆåŠå…¶è¾“å‡ºæƒ…å†µ" class="headerlink" title="ä¸åŒç¼–è¯‘ç»„åˆåŠå…¶è¾“å‡ºæƒ…å†µ"></a>ä¸åŒç¼–è¯‘ç»„åˆåŠå…¶è¾“å‡ºæƒ…å†µ</h2><h3 id="å•ç‹¬ç¼–è¯‘main-c"><a href="#å•ç‹¬ç¼–è¯‘main-c" class="headerlink" title="å•ç‹¬ç¼–è¯‘main.c"></a>å•ç‹¬ç¼–è¯‘main.c</h3><p>æ­¤å¤„å¼±ç¬¦å·å‡½æ•°é“¾æ¥ä¸æˆåŠŸï¼Œä½†æ˜¯ä¸ä¼šæŠ¥ç¼–è¯‘é”™è¯¯ï¼Œå‡½æ•°åæ‰€ä»£è¡¨çš„åœ°å€ä¸º<code>nil</code><br><img src="https://rancho333.github.io/pictures/main.png"><br>å¦‚æœè¿™é‡Œä¾ç„¶è°ƒç”¨å®ƒï¼Œé‚£ä¹ˆä¾¿ä¼šå¦‚å‰é¢æ–‡ç« ä¸­æåˆ°çš„ä¸€æ ·äº§ç”Ÿæ®µé”™ã€‚<br><img src="https://rancho333.github.io/pictures/segmentation_fault.png"></p>
<h3 id="ç¼–è¯‘main-c-weak-c"><a href="#ç¼–è¯‘main-c-weak-c" class="headerlink" title="ç¼–è¯‘main.c+weak.c"></a>ç¼–è¯‘main.c+weak.c</h3><p>å¼±ç¬¦å·é“¾æ¥æˆåŠŸï¼Œå¯ä»¥æ­£å¸¸è°ƒç”¨ã€‚<br><img src="https://rancho333.github.io/pictures/weak.png"></p>
<h3 id="ç¼–è¯‘main-c-weak-c-strong-c"><a href="#ç¼–è¯‘main-c-weak-c-strong-c" class="headerlink" title="ç¼–è¯‘main.c+weak.c+strong.c"></a>ç¼–è¯‘main.c+weak.c+strong.c</h3><p>å½“å‡ºç°å¼ºç¬¦å·å®šä¹‰æ—¶ï¼Œå¼±ç¬¦å·å®šä¹‰ä¸èµ·ä½œç”¨<br><img src="https://rancho333.github.io/pictures/strong.png"></p>
]]></content>
      <tags>
        <tag>å¼±ç¬¦å·</tag>
      </tags>
  </entry>
  <entry>
    <title>ENOSä¸Šæ®µé”™è°ƒè¯•è®°å½•</title>
    <url>/2020/03/02/ENOS%E4%B8%8A%E6%AE%B5%E9%94%99%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>ç§»æ¤ENOSè¿‡ç¨‹ä¸­å‘ç°æŸäº›ç³»ç»Ÿç¼–è¯‘ç”Ÿæˆçš„å‘½ä»¤è¿è¡Œè¿‡ç¨‹ä¸­æŠ¥<code>segmentation fault</code>,æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ã€‚è¿™é‡Œè®°å½•ä¸€ä¸‹è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œæ¶‰åŠåˆ°<code>weak</code>å±æ€§ï¼Œ<code>-pthread</code>ï¼Œ<code>strace</code>ç­‰ã€‚</p>
<span id="more"></span>
<p><img src="https://rancho333.github.io/pictures/fault.png"></p>
<h2 id="æ®µé”™è°ƒè¯•æ‰‹æ®µè®°å½•"><a href="#æ®µé”™è°ƒè¯•æ‰‹æ®µè®°å½•" class="headerlink" title="æ®µé”™è°ƒè¯•æ‰‹æ®µè®°å½•"></a>æ®µé”™è°ƒè¯•æ‰‹æ®µè®°å½•</h2><p>äº§ç”Ÿæ®µé”™é¦–å…ˆæƒ³åˆ°çš„è‡ªç„¶æ˜¯é€šè¿‡<code>gdb</code>è¿›è¡Œé”™è¯¯åˆ†æï¼Œç”±äºtoolchainä¸­å¹¶æ²¡æœ‰æä¾›ï¼Œæ‰€ä»¥è‡ªè¡Œä¸‹è½½äº†ä¸€ä¸ªgdbæºç ï¼Œé€šè¿‡ç»å…¸<code>configure, make, make install</code>ä¸‰éƒ¨æ›²åç§»åˆ°æ¿å­ä¸Šï¼Œgdbè°ƒè¯•ä¿¡æ¯å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/gdb.png"></p>
<p>gdbä¸­å¹¶ä¸èƒ½çœ‹å‡ºä»€ä¹ˆæœ‰æ•ˆçš„ä¿¡æ¯ï¼Œä½†çœ‹èµ·æ¥å‡½æ•°æ ˆçš„è°ƒç”¨è¿˜æ²¡æœ‰åˆ°ccsçš„mainå‡½æ•°ä¸­ï¼ˆæ²¡æœ‰ä¸ccsç›¸å…³çš„æ‰“å°ï¼‰ï¼Œä¸Šä¸€ç¯‡æ–‡ç« ã€Šå…³äºåŠ¨æ€åº“ä»¥åŠconstructorå±æ€§çš„ä½¿ç”¨ã€‹ä¸­æœ‰æåˆ°ã€‚<br>é€šè¿‡<code>dmesg</code>æŸ¥çœ‹å†…æ ¸æŠ¥é”™ä¿¡æ¯ï¼š<br><img src="https://rancho333.github.io/pictures/dmesg.png"><br>å¯ä»¥çœ‹åˆ°<code>pc</code>å¯„å­˜å™¨å–å€çš„åœ°å€ä¸ºå…¨0 ï¼Œè¿™ä¸€èˆ¬æ˜¯å› ä¸ºç©ºæŒ‡é’ˆå¯¼è‡´ï¼Œæˆ‘ä»¬çŸ¥é“cpuæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºä¸ºå–å€ï¼Œåˆ†æï¼Œæ‰§è¡Œä¸‰ä¸ªæ­¥éª¤ï¼Œæ²¡å–åˆ°æŒ‡ä»¤åç»­è‡ªç„¶æ˜¯å•¥éƒ½æ²¡æœ‰äº†ã€‚</p>
<p>é€šè¿‡<code>strace ccs</code>å‘½ä»¤æ¥æŸ¥çœ‹ccsçš„è¯¦ç»†è°ƒç”¨è¿‡ç¨‹å…³äºåŠ¨æ€åº“çš„è°ƒç”¨è¿‡ç¨‹å°±ä¸è¡¨äº†ï¼Œè¿™é‡Œç›´æ¥çœ‹æŠ¥é”™çš„ä½ç½®ï¼š<br><img src="https://rancho333.github.io/pictures/strace.png"><br>å‘ç°æ‰§è¡Œå®ŒwriteæŒ‡ä»¤ä¹‹åå°±æŒ‚äº†ï¼Œç»è¿‡ä¸€ç•ªæ›²æŠ˜ä¹‹åå®šä½åˆ°ä»£ç ä¸­ï¼š<br><img src="https://rancho333.github.io/pictures/iv_signal.png"><br><code>iv_fd_set_cloexec</code>ä¸­æœ‰ä¸¤æ¬¡<code>fnctl</code>çš„è°ƒç”¨ï¼Œä¸straceä¸­çš„4æ¬¡fnctlè°ƒç”¨åˆšå¥½å¯¹ä¸Šï¼Œè€Œå‡½æ•°<code>iv_signal_init</code>è¢«<code>constructor</code>å±æ€§ä¿®é¥°ï¼Œè€Œè¯¥å‡½æ•°æ‰€åœ¨æ¨¡å—ï¼ˆlibtaskï¼‰æ˜¯è¢«ç¼–è¯‘æˆsoä¾›å…¶å®ƒæ¨¡å—è°ƒç”¨çš„ï¼Œå³æ‰€æœ‰è°ƒç”¨è¯¥åŠ¨æ€åº“çš„æ¨¡å—åœ¨æ‰§è¡Œmainå‡½æ•°ä¹‹å‰éƒ½ä¼šæ‰§è¡Œä¸€é<code>iv_signal_init</code>ï¼Œè¿›ä¸€æ­¥è¿½æŸ¥Makefileå‘ç°æŠ¥é”™çš„å‘½ä»¤å…¨éƒ¨éƒ½ä¾èµ–ä¸è¯¥åŠ¨æ€åº“ï¼Œä¸€åˆ‡éƒ½è¯´é€šäº†ï¼Œæ²¡æœ‰ç„å­¦ã€‚</p>
<p>åœ¨è¿›ä¸€æ­¥æ’æŸ¥ï¼Œinitä¸­æœ€å¯ç–‘çš„å°±æ˜¯<code>pthr_atfork</code>è¿™ä¸ªå‡½æ•°äº†ï¼ŒæŸ¥çœ‹è¯¥å‡½æ•°å®šä¹‰ï¼Œå‘ç°ä¸€ä¸ªä»æ²¡è§è¿‡çš„ç”¨æ³•<code>#pragma weak pthread_atfork</code>ï¼š<br><img src="https://rancho333.github.io/pictures/atfork.png"><br>åé¢ä¼šå†å†™ä¸€ç¯‡å…³äºè¿™ä¸ªå±æ€§çš„ç”¨æ³•ï¼Œç®€å•è¯´å°±æ˜¯è¢«<code>weak</code>ä¿®é¥°çš„ç¬¦å·å³ä½¿ä¸å­˜åœ¨ç¼–è¯‘ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚</p>
<h2 id="weakä¹‹åçš„è°ƒè¯•"><a href="#weakä¹‹åçš„è°ƒè¯•" class="headerlink" title="weakä¹‹åçš„è°ƒè¯•"></a>weakä¹‹åçš„è°ƒè¯•</h2><p>è¿™é‡Œå‘ç°libtaskä¸­æ—¢æ²¡æœ‰è‡ªå·±å®ç°<code>pthread_atfork</code>,ä¹Ÿæ²¡æœ‰åœ¨Makefileä¸­é“¾æ¥<code>-pthread</code>ï¼Œè€Œæ˜¯ä½¿ç”¨<code>ifdef HAVE_PRAGMA_WEAK</code>(åæ¥æˆ‘æ”¹æˆifndefäº†)æ¥è¿›è¡Œå±è”½ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è‡ªç„¶ä¼šæŠ¥é”™ï¼Œåœ¨è°ƒç”¨ä¹‹å‰æ‰“å°è¯¥å‡½æ•°çš„åœ°å€ï¼Œä¸å‡ºæ„æ–™çš„æ˜¯<code>NULL</code>ï¼Œç»´æŠ¤äººå‘˜æœ€åˆçš„ç”¨æ„å·²ç»ä¸å¯è€ƒè¯äº†ï¼Œç›´æ¥å»æ‰<code>HAVE_PRAGMA_WEAK</code>,ç¼–è¯‘ä¸­åŠ ä¸Š<code>-pthread</code>ã€‚<br><img src="https://rancho333.github.io/pictures/zhw_test.png"></p>
<p>è¿™é‡Œæœ‰å¿…è¦é¡ºå˜´æä¸€ä¸‹<code>-lpthread</code>å’Œ<code>-pthread</code>ï¼Œå¦‚æœä½¿ç”¨<code>-lpthread</code>çš„æ—¶å€™ä¼šæŠ¥ä¸€äº›<code>undefined reference to</code>çš„é”™è¯¯ï¼Œé”™è¯¯åŸå› å¯ä»¥è‡ªè¡Œç™¾åº¦ï¼Œæ¢æˆ<code>-pthread</code>å³å¯ã€‚</p>
]]></content>
      <tags>
        <tag>æ®µé”™è¯¯</tag>
      </tags>
  </entry>
  <entry>
    <title>GREç®€è¿°</title>
    <url>/2022/07/29/GRE%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æ‰¿æ¥ä¸Šæ–‡<a href="https://rancho333.github.io/2022/07/28/vpn%E6%8A%80%E6%9C%AF%E7%AE%80%E8%BF%B0/">vpnæŠ€æœ¯ç®€è¿°</a>ï¼Œæœ¬æ–‡æ¢è®¨ä¸‹GRE(general routing encapsulation),é€šç”¨è·¯ç”±å°è£…æŠ€æœ¯ï¼Œ GREæ˜¯VPNçš„ä¸€ç§ç®€å•å®ç°ã€‚</p>
<span id="more"></span>

<h1 id="GREä»‹ç»"><a href="#GREä»‹ç»" class="headerlink" title="GREä»‹ç»"></a>GREä»‹ç»</h1><p>åœ¨æ¢è®¨ä¸€ç§ç½‘ç»œæŠ€æœ¯ä¹‹å‰ï¼Œå¿…ç„¶éœ€è¦äº†è§£è¯¥æŠ€æœ¯çš„åº”ç”¨èƒŒæ™¯ï¼Œè§£å†³ä»€ä¹ˆé—®é¢˜ã€‚internetè™½ç„¶ç»Ÿä¸€äº†ä»Šå¤©çš„ç½‘ç»œä¸–ç•Œï¼Œä½†æ˜¯ç§æœ‰ç½‘ç»œï¼Œå¼‚æ„ç½‘ç»œä¾ç„¶å­˜åœ¨ï¼Œä»–ä»¬æœ‰ç€é€šè¿‡internetäº’è”çš„éœ€æ±‚ï¼Œè¿™å°±æ˜¯GREéœ€è¦è§£å†³çš„é—®é¢˜ã€‚</p>
<ul>
<li>ç§æœ‰ç½‘ç»œæ— æ³•é€šè¿‡internetäº’é€š</li>
<li>å¼‚æ„ç½‘ç»œ(IPXã€AppleTalk)ä¹‹é—´æ— æ³•é€šè¿‡internetè¿›è¡Œé€šä¿¡</li>
<li>ç§ç½‘ä¹‹é—´éƒ¨ç½²çš„åŠ¨æ€è·¯ç”±æ— æ³•è·¨è¶Šinternet<br>å¥½æ¯”é€å¿«é€’ï¼Œæ¯”å¦‚æŸå¿«é€’å…¬å¸åªæœ‰åŒ—äº¬ä¸Šæµ·çš„åˆ†éƒ¨ï¼Œæ²¡æœ‰ä¸¤åœ°ä¹‹é—´äº’é€šçš„èƒ½åŠ›ï¼Œè¿™æ—¶æŠŠéœ€è¦äº’é€šçš„åŒ…è£¹ç»™é¡ºä¸°ï¼Œé¡ºä¸°å°±æ˜¯internet, æŸå¿«é€’å°±æ˜¯ç§æœ‰ç½‘ç»œæˆ–å¼‚æ„ç½‘ç»œã€‚</li>
</ul>
<p>GREå¯ä»¥æŠŠæŸç§ç½‘ç»œçš„æŠ¥æ–‡å°è£…åœ¨ä»¥å¤ªç½‘ä¸Šè¿›è¡Œä¼ è¾“ï¼Œ1994å¹´GREé—®ä¸–ï¼ŒRFCç¼–å·æ˜¯RFC1701å’ŒRFC1702.</p>
<p>ä»»ä½•ä¸€ç§å°è£…æŠ€æœ¯ï¼Œå…¶åŸºæœ¬æ„æˆè¦ç´ éƒ½å¯ä»¥åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼šä¹˜å®¢åè®®ã€å°è£…åè®®ã€ä¼ è¾“åè®®ã€‚GREä¸­ä¹˜å®¢åè®®å¯ä»¥æ˜¯ip/ipx, å°è£…åè®®è‡ªç„¶å°±æ˜¯GREè‡ªèº«ï¼Œä¼ è¾“åè®®æ˜¯ipã€‚</p>
<p>greçš„å°è£…è¿‡ç¨‹å¯ä»¥åˆ†æˆä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯åœ¨ä¹˜å®¢åè®®ä¹‹å‰åŠ ä¸ŠgreæŠ¥æ–‡å¤´ï¼Œç¬¬äºŒæ­¥æ˜¯åœ¨ç¬¬ä¸€æ­¥çš„åŸºç¡€ä¸Šæ·»åŠ æ–°çš„ipæŠ¥æ–‡å¤´ã€‚</p>
<p>åœ¨äº§å“å®ç°çš„è§’åº¦ï¼Œä¸Šè¿°çš„å°è£…è¿‡ç¨‹æ˜¯é€šè¿‡ä¸€ä¸ªé€»è¾‘æ¥å£æ¥å®ç°çš„ï¼Œè¿™ä¸ªé€»è¾‘æ¥å£æ˜¯tunnelæ¥å£ï¼Œåœ¨ä¸‹æ–‡çš„å®éªŒä¸­ä¼šè®²åˆ°ã€‚å°è£…çš„åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/gre_encapsulation.png"></p>
<ul>
<li>ç§ç½‘æµé‡åˆ°è¾¾è·¯ç”±å™¨å…¥æ¥å£ï¼Œè·¯ç”±å™¨æŸ¥è¯¢è·¯ç”±è¡¨å¯¹æ­¤æµé‡è¿›è¡Œè½¬å‘</li>
<li>è·¯ç”±å™¨æ ¹æ®è·¯ç”±æŸ¥æ‰¾ç»“æœï¼Œå°†æ­¤æµé‡å¼•å¯¼åˆ°tunnelæ¥å£è¿›è¡Œgreå°è£…</li>
<li>å°è£…åçš„greæŠ¥æ–‡å†æ¬¡æŸ¥æ‰¾è·¯ç”±è¡¨è¿›è¡Œæµé‡è½¬å‘</li>
<li>è·¯ç”±å™¨æ ¹æ®è·¯ç”±æŸ¥æ‰¾ç»“æœï¼Œæ‰¾åˆ°å‡ºæ¥å£ï¼Œå°†æµé‡è½¬å‘åˆ°internet</li>
</ul>
<p>å¯¹äºè§£å°è£…ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“greæŠ¥æ–‡åˆ°è¾¾éš§é“ç»ˆç‚¹æ—¶ï¼Œtunnelé€šè¿‡åˆ¤æ–­è¿è¾“åè®®(IPæŠ¥æ–‡)çš„protocolå­—æ®µæ˜¯å¦ä¸º47æ¥åˆ¤å®šæŠ¥æ–‡æ˜¯ä¸æ˜¯greæŠ¥æ–‡ï¼Œå¦‚æœæ˜¯ï¼Œè§£å°è£…ï¼Œç„¶åè½¬å‘æˆ–è·¯ç”±ã€‚</p>
<h2 id="GREæŠ¥æ–‡è¯´æ˜"><a href="#GREæŠ¥æ–‡è¯´æ˜" class="headerlink" title="GREæŠ¥æ–‡è¯´æ˜"></a>GREæŠ¥æ–‡è¯´æ˜</h2><p>greæŠ¥æ–‡å¦‚å›¾æ‰€ç¤ºã€‚<br><img src="https://rancho333.github.io/pictures/gre_packet.png"></p>
<p>GREçš„æŠ¥æ–‡å¾ˆç®€å•ï¼Œæ³¨æ„å…¶ä¸­<code>recursion</code>å­—æ®µï¼Œè¯¥å­—æ®µè¡¨ç¤ºGREå°è£…çš„å±‚æ•°ï¼Œå®Œæˆä¸€æ¬¡GREå°è£…åŠ 1,å¦‚æœå¤§äº3åˆ™ä¸¢å¼ƒæŠ¥æ–‡ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢å¯¹GREæŠ¥æ–‡çš„æ— é™å°è£…ã€‚</p>
<h1 id="GREå®éªŒ"><a href="#GREå®éªŒ" class="headerlink" title="GREå®éªŒ"></a>GREå®éªŒ</h1><p>å®éªŒæ‹“æ‰‘å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/gre_topology.png"></p>
<p>R1å’ŒR3ä¸Šåˆ†åˆ«åˆ›å»ºloopbackæ¥å£ï¼Œå®ƒä»¬ä¹‹é—´é€šè¿‡greè¿›è¡Œé€šä¿¡ã€‚éš§é“çš„é€»è¾‘ç«¯å£åˆ†åˆ«æ˜¯R1å’ŒR2ä¸Šåˆ›å»ºçš„<code>tunnel 0</code>, å¯¹äºéœ€è¦é€šè¿‡GREè¿›è¡Œå°è£…çš„æŠ¥æ–‡ï¼Œéœ€è¦ä¿è¯ç›®çš„ipçš„ä¸‹ä¸€è·³æ˜¯<code>tunnel 0</code>ï¼›éš§é“ç‰©ç†ç«¯å£åˆ†åˆ«æ˜¯R1å’ŒR2çš„eth0æ¥å£ï¼Œéœ€è¦ä¿è¯ä¸¤è€…ä¹‹é—´è·¯ç”±å¯è¾¾ã€‚å…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">R1</a></li><li class="tab"><a href="#tab-2">R2</a></li><li class="tab"><a href="#tab-3">R3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.0           &#x2F;&#x2F; åˆ›å»ºlp0æ¥å£</span><br><span class="line">!</span><br><span class="line">interface Tunnel0                              &#x2F;&#x2F; åˆ›å»ºtunnelé€»è¾‘ç«¯å£</span><br><span class="line"> ip address 13.1.1.1 255.255.255.0              &#x2F;&#x2F; é…ç½®tunnel ipåœ°å€</span><br><span class="line"> tunnel source Ethernet0&#x2F;0                      &#x2F;&#x2F; é…ç½®tunnelæº</span><br><span class="line"> tunnel destination 23.1.1.3                    &#x2F;&#x2F; é…ç½®tunnelç›®çš„</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">ip route 3.3.3.3 255.255.255.255 Tunnel0        &#x2F;&#x2F; é™æ€è·¯ç”±ï¼Œä¹˜å®¢æŠ¥æ–‡ä¸é€»è¾‘éš§é“ä¹‹é—´è·¯ç”±å¯è¾¾</span><br><span class="line">ip route 23.1.1.0 255.255.255.0 12.1.1.2        &#x2F;&#x2F; é™æ€è·¯ç”±ï¼Œéš§é“ç‰©ç†ç«¯å£ä¹‹é—´è·¯ç”±å¯è¾¾</span><br><span class="line">!</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.2 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 23.1.1.2 255.255.255.0</span><br><span class="line">!</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-3"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback0                             &#x2F;&#x2F; è¯´æ˜å¦‚R1</span><br><span class="line"> ip address 3.3.3.3 255.255.255.255</span><br><span class="line">!</span><br><span class="line">interface Tunnel0</span><br><span class="line"> ip address 13.1.1.3 255.255.255.0</span><br><span class="line"> tunnel source Ethernet0&#x2F;0</span><br><span class="line"> tunnel destination 12.1.1.1</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 23.1.1.3 255.255.255.0</span><br><span class="line">!</span><br><span class="line">ip route 1.1.1.1 255.255.255.255 Tunnel0</span><br><span class="line">ip route 12.1.1.0 255.255.255.0 23.1.1.2</span><br></pre></td></tr></table></figure></div></div></div>
<p>é…ç½®çš„å…³é”®åœ¨äºå°†éœ€è¦è¿›å…¥éš§é“çš„æµé‡å¼•å¯¼åˆ°éš§é“é€»è¾‘ç«¯å£<code>tunnel 0</code>(è·¯ç”±ä¸‹ä¸€è·³æ˜¯tunnel), ç„¶åä¿è¯éš§é“ç‰©ç†ç«¯å£ä¹‹é—´çš„è·¯ç”±å¯è¾¾ã€‚å¯¹äº<code>tunnel 0</code>çš„è·¯ç”±ï¼Œä½¿ç”¨ospfæ¥ä»£æ›¿åˆ™æ˜¯ï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">R1</a></li><li class="tab"><a href="#tab-2">R3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">router ospf 110</span><br><span class="line"> network 1.1.1.1 0.0.0.0 area 0         &#x2F;&#x2F; å°†éœ€è¦greå°è£…çš„æµé‡åŠ å…¥ospfè®¡ç®—</span><br><span class="line"> network 13.1.1.0 0.0.0.255 area 0      &#x2F;&#x2F; å°†tunnel 0å°†å…¥ospfè®¡ç®—</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">router ospf 110</span><br><span class="line"> network 3.3.3.3 0.0.0.0 area 0</span><br><span class="line"> network 13.1.1.0 0.0.0.255 area 0</span><br></pre></td></tr></table></figure></div></div></div>

<p>æ³¨æ„æ­¤æ—¶tunnelä¸¤ç«¯éœ€è¦é…ç½®æˆä¸€ä¸ªç½‘æ®µã€‚æŸ¥çœ‹ä¸€ä¸‹ospfçš„é‚»å±…çŠ¶æ€åŠè·¯ç”±è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R3#show ip ospf neighbor </span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">1.1.1.1           0   FULL&#x2F;  -        00:00:35    13.1.1.1        Tunnel0</span><br><span class="line"></span><br><span class="line">R3#show ip route ospf | begin 1.1.1.1</span><br><span class="line">O        1.1.1.1 [110&#x2F;1001] via 13.1.1.1, 00:03:32, Tunnel0</span><br></pre></td></tr></table></figure>

<p>å¯¹äºospfæŠ¥æ–‡çš„greå°è£…ï¼š<br><img src="https://rancho333.github.io/pictures/gre_ospf.png"></p>
<p>å¯ä»¥çœ‹åˆ°ä¼ è¾“åè®®çš„æºç›®åœ°å€å°±æ˜¯éš§é“ç‰©ç†ç«¯å£çš„åœ°å€ï¼Œospf helloæŠ¥æ–‡çš„æºåœ°å€æ˜¯éš§é“é€»è¾‘ç«¯å£tunnelçš„åœ°å€ã€‚</p>
<p>æµ‹è¯•ä¸¤ä¸ªloopbackæ¥å£ä¹‹é—´çš„è¿é€šæ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R3#ping 1.1.1.1 source 3.3.3.3</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 1.1.1.1, timeout is 2 seconds:</span><br><span class="line">Packet sent with a source address of 3.3.3.3 </span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5&#x2F;5), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;1&#x2F;1 ms</span><br></pre></td></tr></table></figure>
<p>å¯¹äºicmpæŠ¥æ–‡çš„greå°è£…ï¼š<br><img src="https://rancho333.github.io/pictures/gre_ping.png"></p>
<h2 id="greå®éªŒçš„å‡ ä¸ªé—®é¢˜"><a href="#greå®éªŒçš„å‡ ä¸ªé—®é¢˜" class="headerlink" title="greå®éªŒçš„å‡ ä¸ªé—®é¢˜"></a>greå®éªŒçš„å‡ ä¸ªé—®é¢˜</h2><p>ciscoçš„tunnelé»˜è®¤å°è£…ç±»å‹å°±æ˜¯greï¼Œä¸ç”¨ç‰¹æ®ŠæŒ‡å®šã€‚åä¸ºtunnelçš„å°è£…ç±»å‹éœ€è¦æŒ‡å®šã€‚</p>
<p>tunnelæ¥å£çš„IPåœ°å€æ˜¯å¦å¿…é¡»è¦é…ç½®ï¼Ÿéš§é“ä¸¤ç«¯çš„tunnelæ¥å£ipåœ°å€æ˜¯å¦æœ‰æ‰€å…³è”ï¼Ÿtunnelæ¥å£ä½¿ç”¨çš„å…¬ç½‘ipè¿˜æ˜¯ç§ç½‘ip?</p>
<p>tunnelæ¥å£æ˜¯ä¸€ä¸ªä¸‰å±‚æ¥å£ï¼Œéœ€è¦è·¯ç”±ï¼Œæ‰€ä»¥å¿…é¡»é…ç½®ipåœ°å€ï¼Œå¦åˆ™ä¸èƒ½up. ä»ä¸Šé¢çš„æŠ“åŒ…æ¥çœ‹ï¼Œåªæœ‰ä½¿ç”¨ospfåè®®æ—¶ï¼Œtunnelçš„ipæ‰ä¼šä½“ç°åˆ°ä¹˜å®¢åè®®ä¸­ï¼Œèµ°é™æ€è·¯ç”±æ—¶åˆ™æ²¡æœ‰ä»»ä½•å­˜åœ¨æ„Ÿï¼Œè€ƒè™‘åˆ°å°†tunnelçœ‹æˆä¸€ä¸ªè™šæ‹Ÿçš„ç›´è¿é“¾æ¥ï¼Œå»ºè®®tunnelä¸¤ç«¯é…ç½®æˆåŒä¸€ç½‘æ®µ(å¦åˆ™ospfæ—¶é‚»å±…æ— æ³•å»ºç«‹)ï¼›tunnelçš„ipä¸ä¼šå‡ºç°åœ¨ä¼ è¾“åè®®ä¸­ï¼Œæ‰€ä»¥è®¾ç½®æˆç§ç½‘ipå³å¯ã€‚</p>
<p>tunnelæ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„éš§é“ï¼Œæ€ä¹ˆæ„ŸçŸ¥å¯¹æ–¹çš„çŠ¶æ€å‘¢ï¼Ÿå¦åˆ™ä¼šé€ æˆæ•°æ®é»‘æ´çš„é—®é¢˜ã€‚å¯ä»¥åœ¨tunnelæ¥å£ä¸‹å¼€å¯<code>keepalive</code>åŠŸèƒ½ï¼Œtunnelä¼šå‘é€ä¸€ä¸ªä¿æ´»æŠ¥æ–‡ç»™å¯¹ç«¯ï¼Œè§£å°è£…åå†è·¯ç”±å›æ¥ï¼Œè¿™æ ·å°±å¯ä»¥æ£€æµ‹é“¾è·¯ä»¥åŠå¯¹ç«¯è®¾å¤‡æ˜¯å¦æ­£å¸¸ã€‚ä¿æ´»æŠ¥æ–‡æŠ“åŒ…å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/gre_keepalive.png"></p>
<p>å¯ä»¥çœ‹åˆ°ä¼ è¾“åè®®ä¸ä¹˜å®¢åè®®çš„æŠ¥æ–‡æºç›®åœ°å€åˆšå¥½æ˜¯ç›¸åçš„ï¼Œå³R3çš„eth0å‘å‡ºçš„keepaliveï¼ŒR1çš„eth0æ”¶åˆ°ä¹‹åè§£å°è£…å†è·¯ç”±ï¼Œåˆä¼šé‡æ–°å‘é€ç»™R3çš„eth0ã€‚å‡è®¾R1ä¸Šçš„tunnel down(æˆ–è€…ipæ²¡é…)ï¼Œé‚£ä¹ˆå°±æ— æ³•å®Œæˆè§£å°è£…ã€‚</p>
<p>æœ€åä¸€ä¸ªé—®é¢˜æ˜¯å®‰å…¨æ€§çš„é—®é¢˜ã€‚æˆ‘ä»¬åœ¨æŠ“åŒ…è¿‡ç¨‹ä¸­å¯ä»¥ç›´æ¥çœ‹åˆ°ä¹˜å®¢åè®®çš„æŠ¥æ–‡å†…å®¹ï¼Œæ¯”å¦‚æˆ‘ä»¬çŸ¥é“ä¹˜å®¢åè®®æ˜¯icmpè¿˜æ˜¯ospfç­‰ï¼Œè¿™æ˜¯ä¸å®‰å…¨ã€‚GRE over IPSecå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åé¢ä¼šæ¥ç»­ç ”ç©¶ã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://forum.huawei.com/enterprise/zh/thread-256801.html">å¼ºå”ä¾ƒå¢™ VPNç¯‡ GRE</a></p>
]]></content>
      <tags>
        <tag>vpn</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexoä½¿ç”¨ä¼˜åŒ–</title>
    <url>/2019/07/14/Hexo%E4%BD%BF%E7%94%A8%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼šä½äºç«™ç‚¹æ ¹ç›®å½•ä¸‹ï¼Œä¸»è¦åŒ…å«Hexoæœ¬èº«çš„é…ç½®</span><br><span class="line">ä¸»é¢˜é…ç½®æ–‡ä»¶ï¼šä½äºä¸»é¢˜ç›®å½•ä¸‹ï¼Œä¸»è¦ç”¨äºé…ç½®ä¸»é¢˜ç›¸å…³çš„é€‰é¡¹</span><br></pre></td></tr></table></figure>

<p>ç‰ˆæœ¬è¯´æ˜, å½“å‰é…ç½®åŸºäºä»¥ä¸‹ç‰ˆæœ¬è¿›è¡Œä¿®æ”¹ï¼Œhexoä»£ç ç¯å¢ƒæ‰“åŒ…åœ¨<a href="https://hub.docker.com/repository/docker/rancho123/ubuntu">docker</a>ä¸­ï¼Œé¿å…ç”Ÿäº§ç¯å¢ƒæ”¹å˜å¸¦æ¥çš„é—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo: 5.4.0</span><br><span class="line">hexo-cli: 4.2.0</span><br><span class="line">next: 7.8.0</span><br></pre></td></tr></table></figure>

<h2 id="hexoçš„ä¸€äº›è§„åˆ™"><a href="#hexoçš„ä¸€äº›è§„åˆ™" class="headerlink" title="hexoçš„ä¸€äº›è§„åˆ™"></a>hexoçš„ä¸€äº›è§„åˆ™</h2><ol>
<li>æ”¾åœ¨<code>source</code>ä¸‹æ‰€æœ‰ä¸ä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶ï¼Œåœ¨<code>hexo g</code>çš„æ—¶å€™ä¼šæ‹·è´åˆ°<code>public</code>ä¸‹é¢</li>
<li>hexoé»˜è®¤æ¸²æŸ“æ‰€æœ‰çš„htmlå’Œmarkdownæ–‡ä»¶ </li>
</ol>
<h2 id="ä½¿ç”¨nextä¸»é¢˜"><a href="#ä½¿ç”¨nextä¸»é¢˜" class="headerlink" title="ä½¿ç”¨nextä¸»é¢˜"></a>ä½¿ç”¨nextä¸»é¢˜</h2><p>ç½‘ä¸Šä¸€æœå¤§éƒ¨åˆ†éƒ½æ˜¯Hexo+nextçš„ä½¿ç”¨ï¼Œæœ¬ç€ç«™åœ¨å‰äººçš„è‚©è†€ä¸ŠåŸåˆ™ï¼Œä½¿ç”¨nextä¸»é¢˜ã€‚<br>ä¸»é¢˜ä¸‹è½½ï¼š<code>git clone https://github.com/Rancho333/hexo-theme-next.git themes/next</code><br>å¯ç”¨ä¸»é¢˜ï¼Œæ‰“å¼€ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ°<code>theme</code>å­—æ®µï¼Œä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼š  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">theme: next</span><br></pre></td></tr></table></figure>

<h3 id="é€‰æ‹©scheme"><a href="#é€‰æ‹©scheme" class="headerlink" title="é€‰æ‹©scheme"></a>é€‰æ‹©scheme</h3><p>nextæä¾›4ç§ä¸åŒå¤–è§‚ï¼Œæ‰¾åˆ°<code>scheme</code>å­—æ®µï¼Œå¯ç”¨å…¶ä¸­ä¸€ç§schemeï¼Œè¿™é‡Œæˆ‘é€‰æ‹©Gemini.  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Schemes                                  </span></span><br><span class="line"><span class="comment">#scheme: Muse</span></span><br><span class="line"><span class="comment">#scheme: Mist</span></span><br><span class="line"><span class="comment">#scheme: Pisces</span></span><br><span class="line">scheme: Gemini</span><br></pre></td></tr></table></figure>

<h3 id="è®¾ç½®è¯­è¨€"><a href="#è®¾ç½®è¯­è¨€" class="headerlink" title="è®¾ç½®è¯­è¨€"></a>è®¾ç½®è¯­è¨€</h3><p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°<code>language</code>å­—æ®µï¼Œä¿®æ”¹ä¸º(ä¸­æ–‡ï¼Œè‹±æ–‡ä¸ºï¼šen)ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">language: zh-CN</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„éœ€è¦åœ¨<code>themes/next/languages/</code>ä¸‹é¢æœ‰å¯¹åº”çš„è¯­è¨€æ–‡ä»¶ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆï¼ˆä½¿ç”¨é»˜è®¤ï¼‰</p>
<h3 id="è®¾ç½®ä¾§æ "><a href="#è®¾ç½®ä¾§æ " class="headerlink" title="è®¾ç½®ä¾§æ "></a>è®¾ç½®ä¾§æ </h3><p>æ‰¾åˆ°<code>sidebar</code>å­—æ®µï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sidebar:</span><br><span class="line">  <span class="comment">#é å·¦æ”¾ç½®</span></span><br><span class="line">  position: left</span><br><span class="line">  <span class="comment">#æ˜¾ç¤ºæ—¶æœº</span></span><br><span class="line">  display: always</span><br></pre></td></tr></table></figure>

<h3 id="è®¾ç½®å¤´åƒ"><a href="#è®¾ç½®å¤´åƒ" class="headerlink" title="è®¾ç½®å¤´åƒ"></a>è®¾ç½®å¤´åƒ</h3><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°<code>avatar</code>å­—æ®µï¼Œå€¼è®¾ç½®æˆå¤´åƒçš„é“¾æ¥åœ°å€</p>
<h3 id="è®¾ç½®ä½œè€…æ˜µç§°"><a href="#è®¾ç½®ä½œè€…æ˜µç§°" class="headerlink" title="è®¾ç½®ä½œè€…æ˜µç§°"></a>è®¾ç½®ä½œè€…æ˜µç§°</h3><p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°<code>author</code>å­—æ®µï¼Œè¿›è¡Œè®¾ç½®  </p>
<h2 id="ä¿®æ”¹ç½‘å€å›¾æ ‡"><a href="#ä¿®æ”¹ç½‘å€å›¾æ ‡" class="headerlink" title="ä¿®æ”¹ç½‘å€å›¾æ ‡"></a>ä¿®æ”¹ç½‘å€å›¾æ ‡</h2><p>å¯ä»¥åœ¨<code>https://www.iconfont.cn/</code>ä¸Šæ‰¾åˆé€‚çš„å›¾æ ‡ï¼Œä¸‹è½½ä¸¤ä¸ªå°ºå¯¸(16x16å’Œ32x32)çš„pngæ ¼å¼å›¾ç‰‡ï¼Œæ”¾åˆ°ä¸»é¢˜ä¸‹çš„imagesæ–‡ä»¶å¤¹ä¸­ã€‚åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">favicon:                         </span><br><span class="line">  small: /images/R-16x16.png  </span><br><span class="line">  medium: /images/R-32x32.png </span><br></pre></td></tr></table></figure>
<p>æ›¿æ¢smallå’Œmediumä¸¤é¡¹ï¼Œåˆ†åˆ«å¯¹åº”ä¸¤ç§å°ºå¯¸çš„å›¾æ ‡ã€‚</p>
<h2 id="ç»™æ–‡ç« æ·»åŠ â€categoriesâ€å±æ€§"><a href="#ç»™æ–‡ç« æ·»åŠ â€categoriesâ€å±æ€§" class="headerlink" title="ç»™æ–‡ç« æ·»åŠ â€categoriesâ€å±æ€§"></a>ç»™æ–‡ç« æ·»åŠ â€categoriesâ€å±æ€§</h2><p>åˆ›å»º<code>categories</code>é¡µé¢  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo new page categories</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°<code>source/categories/index.md</code>æ–‡ä»¶ï¼Œé‡Œé¢çš„åˆå§‹å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---                                       </span><br><span class="line">title: categories</span><br><span class="line">date: 2019-07-12 12:14:44</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ <code>type: &quot;categories&quot;</code>åˆ°å†…å®¹ä¸­ï¼Œæ·»åŠ åå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---                                               </span><br><span class="line">title: categories</span><br><span class="line">date: 2019-07-12 12:14:44</span><br><span class="line"><span class="built_in">type</span>: <span class="string">&quot;categories&quot;</span></span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>ç»™æ–‡ç« æ·»åŠ <code>categories</code>å±æ€§ï¼Œæ‰“å¼€ä»»æ„ä¸€ç¯‡mdæ–‡ä»¶ï¼Œä¸ºå…¶æ·»åŠ æ¦‚è¿°ä¿¡ï¼Œæ·»åŠ åå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---                                              </span><br><span class="line">title: LinuxæŸ¥æ‰¾soæ–‡ä»¶æ‰€åœ¨pkg </span><br><span class="line">date: 2019-07-14 20:17:03</span><br><span class="line">categories: </span><br><span class="line">- Linuxç›¸å…³</span><br><span class="line">tags:</span><br><span class="line">- Linux</span><br><span class="line">- soæ–‡ä»¶</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>hexoä¸€ç¯‡æ–‡ç« åªèƒ½å±äºä¸€ä¸ªåˆ†ç±»ï¼Œå¦‚æ·»åŠ å¤šä¸ªåˆ†ç±»ï¼Œåˆ™æŒ‰ç…§åˆ†ç±»åµŒå¥—è¿›è¡Œå¤„ç†ã€‚</p>
<h2 id="ç»™æ–‡ç« æ·»åŠ â€tagsâ€å±æ€§"><a href="#ç»™æ–‡ç« æ·»åŠ â€tagsâ€å±æ€§" class="headerlink" title="ç»™æ–‡ç« æ·»åŠ â€tagsâ€å±æ€§"></a>ç»™æ–‡ç« æ·»åŠ â€tagsâ€å±æ€§</h2><p>åˆ›å»º<code>tags</code>é¡µé¢</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo new page tags</span><br></pre></td></tr></table></figure>

<p>åé¢çš„æ“ä½œä¸æ·»åŠ <code>categories</code>å±æ€§ç±»ä¼¼ï¼Œä¸€ç¯‡æ–‡ç« å¯ä»¥æ·»åŠ å¤šä¸ª<code>tags</code>  </p>
<h1 id="å…³äºå›¾ç‰‡"><a href="#å…³äºå›¾ç‰‡" class="headerlink" title="å…³äºå›¾ç‰‡"></a>å…³äºå›¾ç‰‡</h1><p>æœ‰æ—¶å€™ä¼šåˆ†äº«mdæ–‡ä»¶ç»™åˆ«äººï¼Œè¿™æ—¶å€™è¦æ±‚å›¾ç‰‡çš„æ ‡è¯†æ˜¯å› ç‰¹ç½‘å¯è¾¾çš„ï¼Œè€Œä¸èƒ½ä½¿ç”¨èµ„æºæ–‡ä»¶å¤¹è¿™ç§æ–¹å¼ã€‚å¯ä»¥å°†å›¾ç‰‡æ”¾åœ¨<code>public/pictures</code>æ–‡ä»¶å¤¹ä¸­ï¼Œ<code>hexo clean</code>å‘½ä»¤ä¼šåˆ é™¤è¯¥æ–‡ä»¶å¤¹ã€‚å›¾ç‰‡è°ƒç”¨ï¼š<code>![](https://rancho333.github.io/pictures/arp_protocol.png) </code></p>
<ol>
<li>å°†å›¾ç‰‡æºæ–‡ä»¶æ”¾åˆ°<code>source/pictures</code>è·¯å¾„ä¸‹ï¼ˆæºç å¯ä»¥å¤‡ä»½ï¼Œ<code>hexo clean</code>å‘½ä»¤ä¼šåˆ é™¤publicæ–‡ä»¶å¤¹ï¼‰</li>
<li><code>hexo g</code>ä¼šå°†<code>source</code>ä¸‹é¢éä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æ‹·è´åˆ°<code>public</code>ä¸‹é¢</li>
<li><code>public</code>é‡Œé¢çš„å†…å®¹ä¼šä¸Šä¼ åˆ°masteråˆ†æ”¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„é“¾æ¥è¿›è¡Œè®¿é—®</li>
</ol>
<h1 id="æ–‡ç« æœç´¢åŠŸèƒ½"><a href="#æ–‡ç« æœç´¢åŠŸèƒ½" class="headerlink" title="æ–‡ç« æœç´¢åŠŸèƒ½"></a>æ–‡ç« æœç´¢åŠŸèƒ½</h1><p>å®‰è£…æœç´¢åŠŸèƒ½æ’ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>
<p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">search:                                                                                                                                                                                          </span><br><span class="line">  path: search.xml    æœç´¢æ–‡ä»¶pathï¼Œæ‰€æœ‰çš„å¯æœç´¢å†…å®¹éƒ½é™æ€å†™åˆ°äº†è¯¥æ–‡ä»¶ä¸­</span><br><span class="line">  field: post         æœç´¢èŒƒå›´</span><br><span class="line">  format: html</span><br><span class="line">  <span class="built_in">limit</span>: 100         é™åˆ¶æœç´¢çš„æ¡ç›®</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">local_search:                                                                                       </span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span> </span><br></pre></td></tr></table></figure>

<h1 id="æŸ¥çœ‹æ’ä»¶ä»¥åŠè„šæœ¬"><a href="#æŸ¥çœ‹æ’ä»¶ä»¥åŠè„šæœ¬" class="headerlink" title="æŸ¥çœ‹æ’ä»¶ä»¥åŠè„šæœ¬"></a>æŸ¥çœ‹æ’ä»¶ä»¥åŠè„šæœ¬</h1><p><code>hexo --debug</code>å¯ä»¥æŸ¥çœ‹æ’ä»¶ä»¥åŠä½¿ç”¨çš„è„šæœ¬</p>
<h1 id="æ·»åŠ çœ‹æ¿å¨˜"><a href="#æ·»åŠ çœ‹æ¿å¨˜" class="headerlink" title="æ·»åŠ çœ‹æ¿å¨˜"></a>æ·»åŠ çœ‹æ¿å¨˜</h1><p>å®‰è£…æ’ä»¶<code>hexo-helper-live2d</code><br>å®‰è£…çœ‹æ¿æ¨¡å‹<code>live2d-widget-model-shizuku</code><br>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Live2D</span><br><span class="line"># https:&#x2F;&#x2F;github.com&#x2F;EYHN&#x2F;hexo-helper-live2d</span><br><span class="line">live2d:</span><br><span class="line">  enable: true</span><br><span class="line">  pluginRootPath: live2dw&#x2F;</span><br><span class="line">  pluginJsPath: lib&#x2F;</span><br><span class="line">  pluginModelPath: assets&#x2F; Relative)</span><br><span class="line"> </span><br><span class="line">  # è„šæœ¬åŠ è½½æº</span><br><span class="line">  scriptFrom: local # é»˜è®¤ä»æœ¬åœ°åŠ è½½è„šæœ¬</span><br><span class="line">  # scriptFrom: jsdelivr # ä» jsdelivr CDN åŠ è½½è„šæœ¬</span><br><span class="line">  # scriptFrom: unpkg # ä» unpkg CDN åŠ è½½è„šæœ¬</span><br><span class="line">  # scriptFrom: https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;live2d-widget@3.x&#x2F;lib&#x2F;L2Dwidget.min.js # ä»è‡ªå®šä¹‰åœ°å€åŠ è½½è„šæœ¬</span><br><span class="line">  tagMode: false # åªåœ¨æœ‰ &#123;&#123; live2d() &#125;&#125; æ ‡ç­¾çš„é¡µé¢ä¸ŠåŠ è½½ &#x2F; åœ¨æ‰€æœ‰é¡µé¢ä¸ŠåŠ è½½</span><br><span class="line">  log: false # æ˜¯å¦åœ¨æ§åˆ¶å°æ‰“å°æ—¥å¿—</span><br><span class="line"> </span><br><span class="line">  # é€‰æ‹©çœ‹æ¿å¨˜æ¨¡å‹</span><br><span class="line">  model:</span><br><span class="line">    use: live2d-widget-model-shizuku  # npm packageçš„åå­—</span><br><span class="line">    # use: wanko # &#x2F;live2d_models&#x2F; ç›®å½•ä¸‹çš„æ¨¡å‹æ–‡ä»¶å¤¹åç§°</span><br><span class="line">    # use: .&#x2F;wives&#x2F;wanko # ç«™ç‚¹æ ¹ç›®å½•ä¸‹çš„æ¨¡å‹æ–‡ä»¶å¤¹åç§°</span><br><span class="line">    # use: https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;live2d-widget-model-wanko@1.0.5&#x2F;assets&#x2F;wanko.model.json # è‡ªå®šä¹‰ç½‘ç»œæ•°æ®æº</span><br><span class="line">  display:</span><br><span class="line">    position: left # æ˜¾ç¤ºåœ¨å·¦è¾¹è¿˜æ˜¯å³è¾¹</span><br><span class="line">    width: 100 # å®½åº¦</span><br><span class="line">    height: 180 # é«˜åº¦</span><br><span class="line">  mobile:</span><br><span class="line">    show: false</span><br><span class="line">  react:</span><br><span class="line">    opacityDefault: 0.7 # é»˜è®¤é€æ˜åº¦</span><br></pre></td></tr></table></figure>

<h2 id="æ·»åŠ å­—æ•°ç»Ÿè®¡"><a href="#æ·»åŠ å­—æ•°ç»Ÿè®¡" class="headerlink" title="æ·»åŠ å­—æ•°ç»Ÿè®¡"></a>æ·»åŠ å­—æ•°ç»Ÿè®¡</h2><p>å®‰è£…æ’ä»¶<code>npm install hexo-wordcount --save</code><br>åœ¨<code>themes/next/layout/_macro/post.swig</code>æ–‡ä»¶çš„<code>busuazi</code>æ‰€åœ¨çš„æ¨¡å—çš„<code>endif</code>å‰é¢åŠ ä¸Šï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;span class&#x3D;&quot;post-meta-divider&quot;&gt;|&lt;&#x2F;span&gt;</span><br><span class="line">&lt;span title&#x3D;&quot;&#123;&#123; __(&#39;post.wordcount&#39;) &#125;&#125;&quot;&gt;&lt;span class&#x3D;&quot;post-meta-item-icon&quot;&gt;&lt;i class&#x3D;&quot;fa fa-file-word-o&quot;&gt;&lt;&#x2F;i&gt;&lt;&#x2F;span&gt;å­—æ•°ï¼š &#123;&#123; wordcount(post.content) &#125;&#125;&lt;&#x2F;span&gt;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>themes/next/layout/_partials/footer.swig</code>æ–‡ä»¶çš„æœ€åä¸€è¡Œä¹‹å‰åŠ ä¸Šï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div class&#x3D;&quot;theme-info&quot;&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;powered-by&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;span class&#x3D;&quot;post-count&quot;&gt;å…¨ç«™å…± &#123;&#123; totalcount(site) &#125;&#125; å­—&lt;&#x2F;span&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<h2 id="åœ†è§’è®¾ç½®"><a href="#åœ†è§’è®¾ç½®" class="headerlink" title="åœ†è§’è®¾ç½®"></a>åœ†è§’è®¾ç½®</h2><p>åœ¨ hexo/source/_data ç›®å½•ä¸‹æ–°å»º variables.styl æ–‡ä»¶ï¼Œå¡«å†™ä¸‹é¢å†…å®¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; åœ†è§’è®¾ç½®</span><br><span class="line">$border-radius-inner     &#x3D; 20px 20px 20px 20px;</span><br><span class="line">$border-radius           &#x3D; 20px;</span><br></pre></td></tr></table></figure>
<p>ä¸»é¢˜é…ç½®æ–‡ä»¶ next.yml å»é™¤ variables.styl çš„æ³¨é‡Šã€‚</p>
<h2 id="è®¾ç½®ç½‘ç«™èƒŒæ™¯"><a href="#è®¾ç½®ç½‘ç«™èƒŒæ™¯" class="headerlink" title="è®¾ç½®ç½‘ç«™èƒŒæ™¯"></a>è®¾ç½®ç½‘ç«™èƒŒæ™¯</h2><p>é™¤äº†è®¾ç½®èƒŒæ™¯å›¾ç‰‡ï¼Œè¿˜éœ€è¦è®¾ç½®åšå®¢æ–‡ç« åšå®¢æ–‡ç« é€æ˜åº¦æ‰èƒ½çœ‹åˆ°èƒŒæ™¯å›¾ç‰‡ã€‚<br>ä¸»é¢˜é…ç½®æ–‡ä»¶ next.yml å»é™¤ style.styl çš„æ³¨é‡Šã€‚<br>åœ¨ hexo/source/_data/style.styl æ–‡ä»¶ä¸­å†™å…¥ä¸‹é¢ä»£ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; è®¾ç½®èƒŒæ™¯å›¾ç‰‡</span><br><span class="line">body &#123;</span><br><span class="line">    background:url(&#x2F;images&#x2F;background.png);</span><br><span class="line">    background-repeat: no-repeat;</span><br><span class="line">    background-attachment:fixed; &#x2F;&#x2F;ä¸é‡å¤</span><br><span class="line">    background-size: cover;      &#x2F;&#x2F;å¡«å……</span><br><span class="line">    background-position:50% 50%;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>next ä¸»é¢˜çš„åšå®¢æ–‡ç« éƒ½æ˜¯ä¸é€æ˜çš„ï¼Œè¿™æ ·å³ä½¿è®¾ç½®äº†èƒŒæ™¯å›¾ç‰‡ä¹Ÿæ— æ³•çœ‹åˆ°ï¼Œåœ¨ hexo/source/_data/styles.styl ä¸­å†™å…¥ä¸‹é¢å†…å®¹ï¼Œä½¿åšå®¢æ–‡ç« é€æ˜åŒ–ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;åšå®¢å†…å®¹é€æ˜åŒ–</span><br><span class="line">&#x2F;&#x2F;æ–‡ç« å†…å®¹çš„é€æ˜åº¦è®¾ç½®</span><br><span class="line">.content-wrap &#123;</span><br><span class="line">  opacity: 0.9;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä¾§è¾¹æ¡†çš„é€æ˜åº¦è®¾ç½®</span><br><span class="line">.sidebar &#123;</span><br><span class="line">  opacity: 0.9;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;èœå•æ çš„é€æ˜åº¦è®¾ç½®</span><br><span class="line">.header-inner &#123;</span><br><span class="line">  background: rgba(255,255,255,0.9);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æœç´¢æ¡†ï¼ˆlocal-searchï¼‰çš„é€æ˜åº¦è®¾ç½®</span><br><span class="line">.popup &#123;</span><br><span class="line">  opacity: 0.9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç›®å½•ä¸è·³è½¬"><a href="#ç›®å½•ä¸è·³è½¬" class="headerlink" title="ç›®å½•ä¸è·³è½¬"></a>ç›®å½•ä¸è·³è½¬</h2><p>ä½¿ç”¨<code>doctoc</code>å·¥å…·å¯ä»¥è‡ªåŠ¨ç”Ÿæˆmdçš„ç›®å½•ï¼Œå¹¶æ”¯æŒè·³è½¬ï¼Œå®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š<br><code>npm i doctoc -g</code><br>ä½¿ç”¨æ–¹å¼<code>doctoc file.md</code>å°±ä¼šåœ¨æ–‡ç« é¡¶å±‚ç”Ÿæˆç›®å½•ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒæ•´ä½ç½®ã€‚<br>å¦‚æœç›®å½•æ›´æ–°,<code>doctoc -u file.md</code></p>
<h2 id="æœ¬åœ°éƒ¨ç½²"><a href="#æœ¬åœ°éƒ¨ç½²" class="headerlink" title="æœ¬åœ°éƒ¨ç½²"></a>æœ¬åœ°éƒ¨ç½²</h2><p><code>hexo s</code>å¯ä»¥å¼€å¯æœ¬åœ°éƒ¨ç½²ï¼Œè¿™æ ·å¯ä»¥å¿«é€ŸéªŒè¯ä¸€äº›feature.</p>
<h2 id="codeæ ‡ç­¾é¡µä½¿èƒ½"><a href="#codeæ ‡ç­¾é¡µä½¿èƒ½" class="headerlink" title="codeæ ‡ç­¾é¡µä½¿èƒ½"></a>codeæ ‡ç­¾é¡µä½¿èƒ½</h2><p>åœ¨åšäº¤æ¢æœºé…ç½®çš„æ—¶å€™å¾€å¾€è¦é…ç½®å¤šå°äº¤æ¢æœºï¼ŒæŠŠæ‰€æœ‰é…ç½®è´´å‡ºæ¥é•¿åº¦å¤ªé•¿ï¼Œä½¿ç”¨æ ‡ç­¾é¡µæ¯ä¸€å°äº¤æ¢æœºå ç”¨ä¸€ä¸ªæ ‡ç­¾ã€‚é…ç½®ä¸»é¢˜tabsé¡¹ç„¶åç”¨ç›¸åº”çš„è¯­æ³•ä¹¦å†™å³å¯å®ç°ï¼Œä¸»é¢˜é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Tabs tag</span><br><span class="line">tabs:</span><br><span class="line">  enable: true </span><br><span class="line">  transition:</span><br><span class="line">    tabs: true </span><br><span class="line">    labels: true </span><br><span class="line">  border_radius: 0</span><br></pre></td></tr></table></figure>
<p>è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% tabs tab,1 %&#125;      &#x2F;&#x2F; é»˜è®¤æ˜¾ç¤ºæ ‡ç­¾1</span><br><span class="line">&lt;!-- tab R1--&gt;        &#x2F;&#x2F; æ ‡ç­¾1åå­—æ˜¯R1</span><br><span class="line">*R1 infor*</span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&lt;!-- tab R2--&gt;       &#x2F;&#x2F; æ ‡ç­¾2åå­—æ˜¯R2</span><br><span class="line">*R2 infor*</span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&lt;!-- tab R3--&gt;       &#x2F;&#x2F; æ ‡ç­¾3åå­—æ˜¯R3</span><br><span class="line">*R3 infor*</span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">R1</a></li><li class="tab"><a href="#tab-2">R2</a></li><li class="tab"><a href="#tab-3">R3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><p><em>R1 infor</em></p></div><div class="tab-pane" id="tab-2"><p><em>R2 infor</em></p></div><div class="tab-pane" id="tab-3"><p><em>R3 infor</em></p></div></div></div>

<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong><br><a href="http://theme-next.iissnan.com/">NexTå®˜æ–¹</a></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxä¸‹ç¨‹åºè°ƒè¯•æ–¹æ³•ç®€è¿°</title>
    <url>/2020/08/05/Linux%E4%B8%8B%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ¬æ–‡æ—¨åœ¨ç»¼åˆæ€§çš„æè¿°Linuxä¸‹ç¨‹åºè°ƒè¯•çš„æ–¹æ³•å’Œæ€è·¯ï¼Œä¸ä¼šè¿‡äºç»†èŠ‚çš„æè¿°æŸç§å·¥å…·çš„ä½¿ç”¨ï¼Œå¦‚gdbï¼Œè¿™äº›æ–¹æ³•é€šè¿‡manä»¥åŠgoogleéƒ½èƒ½æ‰¾åˆ°ç­”æ¡ˆã€‚åŒ…å«çŸ¥è¯†ç‚¹ï¼šstrip, addr2line, strace, gdb, readelfã€‚</p>
<span id="more"></span>
<h2 id="stripç›¸å…³"><a href="#stripç›¸å…³" class="headerlink" title="stripç›¸å…³"></a>stripç›¸å…³</h2><p>åµŒå…¥å¼ç³»ç»Ÿè¦æ±‚å°å·§ç²¾ç®€ï¼Œæœ€å¤§é™åº¦å»é™¤å†—ä½™æ•°æ®ã€‚Linuxä¸‹ç¼–è¯‘å‡ºæ¥elfæ–‡ä»¶æ˜¯å¸¦æœ‰ç¬¦å·è¡¨çš„ï¼Œé€šè¿‡<code>nm</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹ï¼Œå¦‚ï¼š<br><img src="https://rancho333.github.io/pictures/nm.png"><br>è¿™äº›ç¬¦å·è¡¨æ˜¯è¿›è¡Œç¨‹åºè°ƒè¯•çš„å…³é”®ï¼Œä¾‹å¦‚é€šè¿‡<code>addr2line</code>è¿›è¡Œåœ°å€å’Œæ–‡ä»¶åæˆ–è¡Œæ•°çš„è½¬æ¢ï¼Œä¾‹å¦‚åœ¨<code>gdb</code>ä¸­é€šè¿‡<code>bt</code>æ˜¾ç¤ºå‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ï¼Œæ²¡æœ‰ç¬¦å·è¡¨è¿™äº›å·¥å…·éƒ½æ— æ³•æä¾›æœ‰ä»·å€¼ä¿¡æ¯ã€‚<br><code>strip</code>å‘½ä»¤å¯ä»¥å»æ‰è¿™äº›ç¬¦å·ä¿¡æ¯ï¼Œè¿›è€Œå‡å°æ–‡ä»¶å¤§å°ï¼ŒåŒæ—¶ä¸ä¼šå½±å“elfçš„æ­£å¸¸æ‰§è¡Œã€‚<br><img src="https://rancho333.github.io/pictures/compare.png"><br>å¯ä»¥çœ‹åˆ°ï¼Œ<code>strip app</code>ä¹‹åï¼Œappä¸­æ²¡æœ‰ç¬¦å·è¡¨ç›¸å…³ä¿¡æ¯äº†ã€‚<br>åœ¨è¿›è¡Œrootfsåˆ¶ä½œæ—¶ï¼Œå¯¹äºå‘è¡Œç‰ˆæœ¬ï¼Œæˆ‘ä»¬è¿›è¡Œ<code>strip</code>æ“ä½œï¼Œå¯¹äºå¼€å‘äººå‘˜è°ƒè¯•ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¿ç•™ç¬¦å·è¡¨ä¿¡æ¯ã€‚<br><img src="https://rancho333.github.io/pictures/strip.png"></p>
<h2 id="gdbç®€è¿°"><a href="#gdbç®€è¿°" class="headerlink" title="gdbç®€è¿°"></a>gdbç®€è¿°</h2><p>é‡åˆ°<code>core dump</code>æœ€å¸¸ä½¿ç”¨çš„å°±æ˜¯<code>gdb</code>äº†ï¼Œ<code>gdb</code>çš„ä¸€èˆ¬ä½¿ç”¨æ–¹æ³•<code>gdb app core</code>ã€‚å¸¸è§å­å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">cmd</th>
<th align="left">function</th>
</tr>
</thead>
<tbody><tr>
<td align="left">bt</td>
<td align="left">å›æº¯æ˜¾ç¤ºappå †æ ˆ</td>
</tr>
<tr>
<td align="left">bt full</td>
<td align="left">ä¸ä»…ä»…æ˜¾ç¤ºæ ˆå¸§ï¼Œè¿˜æ˜¾ç¤ºå±€éƒ¨å˜é‡</td>
</tr>
<tr>
<td align="left">info reg</td>
<td align="left">æ˜¾ç¤ºå¯„å­˜å™¨å†…å®¹</td>
</tr>
<tr>
<td align="left">run</td>
<td align="left">æ‰§è¡Œapp</td>
</tr>
<tr>
<td align="left">print val</td>
<td align="left">æ‰“å°å˜é‡valçš„å€¼</td>
</tr>
<tr>
<td align="left">break</td>
<td align="left">è®¾ç½®æ–­ç‚¹</td>
</tr>
</tbody></table>
<p>gdbä¸€èˆ¬ä½¿ç”¨<em>æ–­ç‚¹</em>å’Œ<em>å †æ ˆ</em>è¿›è¡Œç¨‹åºè°ƒè¯•ï¼Œæ³¨æ„è°ƒè¯•çš„ç¨‹åºä¸€å®šè¦æ˜¯<code>not stripped</code>çš„ã€‚<br>ç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/gdb.png"></p>
<h2 id="straceä»‹ç»"><a href="#straceä»‹ç»" class="headerlink" title="straceä»‹ç»"></a>straceä»‹ç»</h2><p>straceå¯ä»¥è·Ÿè¸ªappçš„<code>system call</code>å’Œ<code>signals</code>ï¼Œä¸€èˆ¬ä½¿ç”¨æ–¹æ³•<code>strace app</code>ï¼Œå¸¸è§å‚æ•°å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">cmd</th>
<th align="left">function</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-tt</td>
<td align="left">åœ¨æ¯è¡Œè¾“å‡ºçš„å‰é¢ï¼Œæ˜¾ç¤ºæ¯«ç§’çº§åˆ«çš„æ—¶é—´</td>
</tr>
<tr>
<td align="left">-T</td>
<td align="left">æ˜¾ç¤ºæ¯æ¬¡ç³»ç»Ÿè°ƒç”¨æ‰€èŠ±è´¹çš„æ—¶é—´</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">å¯¹äºæŸäº›ç›¸å…³è°ƒç”¨ï¼ŒæŠŠå®Œæ•´çš„ç¯å¢ƒå˜é‡ï¼Œæ–‡ä»¶statç»“æ„ç­‰æ‰“å‡ºæ¥</td>
</tr>
<tr>
<td align="left">-f</td>
<td align="left">è·Ÿè¸ªç›®æ ‡è¿›ç¨‹ï¼Œä»¥åŠç›®æ ‡è¿›ç¨‹åˆ›å»ºçš„æ‰€æœ‰å­è¿›ç¨‹</td>
</tr>
<tr>
<td align="left">-e</td>
<td align="left">æ§åˆ¶è¦è·Ÿè¸ªçš„äº‹ä»¶å’Œè·Ÿè¸ªè¡Œä¸º,æ¯”å¦‚æŒ‡å®šè¦è·Ÿè¸ªçš„ç³»ç»Ÿè°ƒç”¨åç§°</td>
</tr>
<tr>
<td align="left">-o</td>
<td align="left">æŠŠstraceçš„è¾“å‡ºå•ç‹¬å†™åˆ°æŒ‡å®šçš„æ–‡ä»¶</td>
</tr>
<tr>
<td align="left">-s</td>
<td align="left">å½“ç³»ç»Ÿè°ƒç”¨çš„æŸä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²æ—¶ï¼Œæœ€å¤šè¾“å‡ºæŒ‡å®šé•¿åº¦çš„å†…å®¹ï¼Œé»˜è®¤æ˜¯32ä¸ªå­—èŠ‚</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">æŒ‡å®šè¦è·Ÿè¸ªçš„è¿›ç¨‹pid, è¦åŒæ—¶è·Ÿè¸ªå¤šä¸ªpid, é‡å¤å¤šæ¬¡-pé€‰é¡¹å³å¯</td>
</tr>
<tr>
<td align="left">-i</td>
<td align="left">åœ¨æ‰“å°ç³»ç»Ÿè°ƒç”¨åŒæ—¶æ‰“å°æŒ‡ä»¤æŒ‡é’ˆ</td>
</tr>
</tbody></table>
<p>ä¸¾ä¸ªä¹‹å‰åœ¨ENOSé£è…¾ç§»æ¤è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œå…ˆä½¿ç”¨gdbåšä¸€ä¸ªåŸºæœ¬çš„é”™è¯¯å®šä½<br><img src="https://rancho333.github.io/pictures/strace1.png"><br>çœ‹èµ·æ¥åƒæ˜¯æ²¡æœ‰è¿›å…¥mainå‡½æ•°å°±å·²ç»æŒ‚äº†ã€‚<br>ä½¿ç”¨straceæŸ¥çœ‹å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ç³»ç»Ÿè°ƒç”¨å’Œä¿¡å·ï¼š<br><img src="https://rancho333.github.io/pictures/strace2.png"><br>æ‰¾åˆ°æºç ä¸­çš„å¯¹åº”ä½ç½®ï¼š<br><img src="https://rancho333.github.io/pictures/strace3.png"><br>iv_signal_initåœ¨mainå‡½æ•°ä¹‹å‰ä¼šæ‰§è¡Œå¹¶æŒ‚æ‰ï¼Œå°†ä¹‹æ³¨é‡Šæ‰æµ‹è¯•é€šè¿‡ã€‚</p>
<h2 id="soåº“ç›¸å…³"><a href="#soåº“ç›¸å…³" class="headerlink" title="soåº“ç›¸å…³"></a>soåº“ç›¸å…³</h2><p>ä½¿ç”¨<code>ldd</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹appçš„ä¾èµ–åº“ï¼Œ<code>readelf</code>å‘½ä»¤å¯ä»¥è·å–åˆ°æ›´å¤šçš„å†…å®¹<br><img src="https://rancho333.github.io/pictures/so.png"></p>
<p>å¦‚æœappçš„ä¾èµ–åº“æ‰¾ä¸åˆ°ï¼ŒæŠ¥é”™æ ¼å¼ä¸€èˆ¬å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/so_not_find.png"></p>
<p>è¿™é‡Œé¢ç¼ºå°‘ä¸€äº›åŠ¨æ€åº“ï¼ŒäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ†3ç§æƒ…å†µï¼š</p>
<ol>
<li>æ–‡ä»¶ä¸å­˜åœ¨</li>
<li>æ–‡ä»¶å­˜åœ¨ä½†è·¯å¾„ä¸å¯¹, /etc/ld.so.conf æ­¤æ–‡ä»¶è®°å½•äº†ç¼–è¯‘æ—¶ä½¿ç”¨çš„åŠ¨æ€åº“çš„è·¯å¾„</li>
<li>æœ‰äº›æ–‡ä»¶ä¸å¿…é¡»ï¼Œå¯ä»¥æ³¨é‡Šæ‰ï¼Œå‚è€ƒ<br>æ ¹æ®ä¸åŒçš„æƒ…å†µå¤„ç†ä¹‹ã€‚</li>
</ol>
]]></content>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>LinuxåŒç½‘å¡è®¾ç½®-å†…å¤–ç½‘</title>
    <url>/2021/01/26/Linux%E5%8F%8C%E7%BD%91%E5%8D%A1%E8%AE%BE%E7%BD%AE-%E5%86%85%E5%A4%96%E7%BD%91/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æäº†ä¸€å°æ ‘è“æ´¾4Bæ¥ç©ï¼Œæƒ³é€šè¿‡sshæ¥è¿›è¡Œç®¡ç†ã€‚ç”±äºå…¬å¸ç½‘ç»œç®¡æ§ï¼Œè€ƒè™‘é€šè¿‡å†…ç½‘ï¼ˆeth0ï¼‰æ¥è¿›è¡Œsshç®¡ç†ï¼Œé€šè¿‡å¤–ç½‘(wlan0)è¿›è¡Œä¸Šç½‘ã€‚</p>
<span id="more"></span>

<h1 id="ç½‘ç»œé…ç½®"><a href="#ç½‘ç»œé…ç½®" class="headerlink" title="ç½‘ç»œé…ç½®"></a>ç½‘ç»œé…ç½®</h1><p>æœ‰çº¿ç½‘å’Œæ— çº¿ç½‘éƒ½è¿æ¥å¥½åï¼Œé€šè¿‡DHCPè·å–ipï¼Œ<code>ip route</code>çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">default via 10.204.123.1 dev eth0 proto dhcp src 10.204.123.145 metric 202 </span><br><span class="line">default via 192.168.3.254 dev wlan0 proto dhcp src 192.168.3.38 metric 303 </span><br><span class="line">10.204.123.0&#x2F;24 dev eth0 proto dhcp scope link src 10.204.123.145 metric 202 </span><br><span class="line">192.168.0.0&#x2F;22 dev wlan0 proto dhcp scope link src 192.168.3.38 metric 303</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­10.204.0.0/16ç½‘æ®µæ˜¯å†…ç½‘ï¼Œè®¾å¤‡æ²¡æœ‰é€šè¿‡è®¤è¯ï¼Œä¸èƒ½é€šè¿‡å†…ç½‘ä¸Šå¤–ç½‘ã€‚è€ƒè™‘é€šè¿‡è¯¥ç½‘æ®µä¸è‡ªå·±çš„ä¸»æœºç›¸è¿ï¼Œå…¶ä½™ç½‘ç»œè¿æ¥èµ°192.168ç½‘æ®µã€‚<br>å…ˆå°†é»˜è®¤è·¯ç”±åˆ é™¤ï¼Œè¿™é‡Œéœ€è¦è¿æ¥æ˜¾ç¤ºå™¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">route del default</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæœ‰ä¸¤æ¡é»˜è®¤ç†ç”±ï¼Œè¯¥å‘½ä»¤æ‰§è¡Œä¸¤æ¬¡ã€‚</p>
<p>ä¹‹åæ·»åŠ é»˜è®¤è·¯ç”±å’Œé»˜è®¤ç½‘å…³ï¼Œå¯ä»¥å†™åˆ°<code>/etc/rc.local</code>ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#foreign net</span><br><span class="line">route add -net 0.0.0.0&#x2F;0 wlan0</span><br><span class="line">route add -net 0.0.0.0&#x2F;0 gw 192.168.3.254</span><br><span class="line"></span><br><span class="line">#local net</span><br><span class="line">route add -net 10.204.123.0&#x2F;16 eth0</span><br><span class="line">route add -net 10.204.123.0&#x2F;16 gw 10.204.123.1</span><br></pre></td></tr></table></figure>
<p>ä½¿èƒ½ä¹‹åï¼Œ<code>ip route</code>çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">default via 10.204.123.1 dev eth0 proto dhcp src 10.204.123.145 metric 202 </span><br><span class="line">default via 192.168.3.254 dev wlan0 proto dhcp src 192.168.3.38 metric 303 </span><br><span class="line">10.204.0.0&#x2F;16 via 10.204.123.1 dev eth0 </span><br><span class="line">10.204.0.0&#x2F;16 dev eth0 scope link </span><br><span class="line">10.204.123.0&#x2F;24 dev eth0 proto dhcp scope link src 10.204.123.145 metric 202 </span><br><span class="line">192.168.0.0&#x2F;22 dev wlan0 proto dhcp scope link src 192.168.3.38 metric 303 </span><br></pre></td></tr></table></figure>
<p><code>route -n</code>çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.3.254   0.0.0.0         UG    303    0        0 wlan0</span><br><span class="line">10.204.0.0      10.204.123.1    255.255.0.0     UG    0      0        0 eth0</span><br><span class="line">10.204.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br><span class="line">10.204.123.0    0.0.0.0         255.255.255.0   U     202    0        0 eth0</span><br><span class="line">192.168.0.0     0.0.0.0         255.255.252.0   U     303    0        0 wlan0</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°10.204ç½‘æ®µèµ°çš„æ˜¯10.204.123.1ç½‘å…³ï¼Œå…¶ä½™çš„ç½‘æ®µèµ°çš„éƒ½æ˜¯å¤–ç½‘192.168.3.254ç½‘å…³ã€‚</p>
<p>å¦‚æœè®¾å¤‡ä¸Šä½¿èƒ½äº†dhcpcdåŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨è·å–åˆ°ipã€è·¯ç”±ä¹‹åæ‰‹åŠ¨é…ç½®è·¯ç”±ã€‚å¯ä»¥é€šè¿‡wlan0ç½‘ç»œï¼ˆå¤–ç½‘ï¼‰é…ç½®eth0ï¼ˆå†…ç½‘ï¼‰çš„è·¯ç”±ã€‚</p>
]]></content>
      <tags>
        <tag>ç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxå¯†ç ä¿®æ”¹</title>
    <url>/2020/03/09/Linux%E5%AF%86%E7%A0%81%E4%BF%AE%E6%94%B9/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨åšäº¤æ¢æœºLinuxç³»ç»Ÿç§»æ¤çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°è¿›å…¥shellçš„å¯†ç è¿˜æ˜¯ä¸Šä¸€å®¶çš„é»˜è®¤å¯†ç ï¼Œè¿˜æ˜¯æ”¹æ”¹å§ã€‚ç®€å•äº¤ä»£ä¸€ä¸‹ï¼ŒENOSä¸ŠkernelåŠ è½½å®Œæˆä¹‹ååº”ç”¨çš„å¯åŠ¨é¡ºåºå¦‚ä¸‹å¦‚ï¼š</p>
<span id="more"></span>
<p><img src="https://rancho333.github.io/pictures/inittab.png"></p>
<p>è¿™é‡Œæ˜¯ä¸è¿›å…¥shellçš„ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥klishä½œä¸ºäº¤æ¢æœºçš„å‘½ä»¤è¡Œäº¤äº’ç•Œé¢ï¼Œç±»ä¼¼äºquaggaçš„vtyshã€‚ä¹‹ååœ¨<code>configure</code>è§†å›¾ä¸‹é¢æ‰§è¡Œ<code>start shell</code>è¿›å…¥linux shellçš„ã€‚<br><img src="https://rancho333.github.io/pictures/shell.png"><br>åœ¨fnconverté‡Œé¢ä¼šè·å–ç”¨æˆ·<code>root</code>çš„å¯†ç ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨<code>getspnam</code>è·å–<code>passwdæˆ–è€…shadow</code>çš„å£ä»¤ã€‚æ—¢ç„¶è¿™ç©æ„ä½¿ç”¨çš„æ˜¯Linuxçš„è´¦æˆ·å’Œå¯†ç ï¼Œé‚£å°±æ˜¯ä¿®æ”¹<code>/etc/passwd</code>æ–‡ä»¶äº†ã€‚<br><img src="https://rancho333.github.io/pictures/spnam.png"></p>
<h1 id="passwdæ–‡ä»¶ç®€ä»‹"><a href="#passwdæ–‡ä»¶ç®€ä»‹" class="headerlink" title="passwdæ–‡ä»¶ç®€ä»‹"></a>passwdæ–‡ä»¶ç®€ä»‹</h1><p>Linuxä¸­æ¯ä¸ªç”¨æˆ·åœ¨/etc/passwdæ–‡ä»¶ä¸­éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„è®°å½•è¡Œï¼Œæ¯ä¸€è¡Œè¢«å†’å·<code>:</code>åˆ†éš”ä¸º7ä¸ªå­—æ®µï¼Œå…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç”¨æˆ·åï¼šå£ä»¤ï¼šç”¨æˆ·æ ‡è¯†å·ï¼šç»„æ ‡è¯†å·ï¼šæ³¨é‡Šæ€§æè¿°ï¼šä¸»ç›®å½•ï¼šç™»é™†shell</span><br></pre></td></tr></table></figure>
<p>å‘è¡Œç‰ˆä¸­å£ä»¤å­—æ®µä¸€èˆ¬æ˜¯<code>*æˆ–x</code>ï¼Œ<code>*</code>è¡¨ç¤ºè´¦å·é”å®š, <code>x</code>è¡¨ç¤ºå¯†ç å­˜æ”¾åœ¨<code>/etc/shadown</code>æ–‡ä»¶ä¸­ï¼ˆè®¿é—®éœ€è¦sudoæƒé™ï¼Œè€Œpasswdæ–‡ä»¶ä¸éœ€è¦ï¼‰ï¼Œå½“ç„¶æˆ‘ä»¬çš„åµŒå…¥å¼ç³»ç»Ÿå¯†æ–‡æ˜¯ç›´æ¥æ”¾åœ¨passwdä¸­ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/passwd.png"></p>
<p>å…¶å®ƒå­—æ®µé™¤äº†<code>ç™»é™†shell</code>å°±æ²¡å•¥å¥½ç©çš„äº†ï¼Œæœ‰äº›è´¦å·å‡ºäºå®‰å…¨é™åˆ¶ï¼Œå¹¶ä¸ä¼šå…è®¸ç™»é™†è¿›shellï¼Œè€Œé‡‡ç”¨<code>nologin</code>çš„æ–¹å¼å¯ä»¥è®©è¿™äº›ç”¨æˆ·ä½¿ç”¨éƒ¨åˆ†ç³»ç»ŸåŠŸèƒ½ã€‚<br><img src="https://rancho333.github.io/pictures/nologin.png"></p>
<h2 id="ä¿®æ”¹ç”¨æˆ·å¯†ç "><a href="#ä¿®æ”¹ç”¨æˆ·å¯†ç " class="headerlink" title="ä¿®æ”¹ç”¨æˆ·å¯†ç "></a>ä¿®æ”¹ç”¨æˆ·å¯†ç </h2><p>å¸¸è§„çš„åœ¨linuxå‘½ä»¤è¡Œä¸‹é¢ä¿®æ”¹å¯†ç æ²¡å•¥å¥½è¯´çš„ï¼Œç›´æ¥æ•²<code>passwd</code>ç„¶åè¾“å…¥æ–°å¯†ç å°±è¡Œäº†ï¼Œä¹‹åä½ ä¼šå‘ç°<code>passwdæˆ–è€…shadow</code>ä¸­çš„å£ä»¤å‘ç”Ÿå˜åŒ–äº†ã€‚è¿™é‡Œä»‹ç»ä¸€ä¸‹å£ä»¤äº†åˆ—çš„ç»„æˆï¼Œä¸åŒçš„ç‰¹æ®Šå­—ç¬¦è¡¨ç¤ºä¸åŒçš„ç‰¹æ®Šæ„ä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. è¯¥åˆ—ç•™ç©ºï¼Œå³&quot;::&quot;ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·æ²¡æœ‰å¯†ç ã€‚</span><br><span class="line">2. è¯¥åˆ—ä¸º&quot;!&quot;ï¼Œå³&quot;:!:&quot;ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·è¢«é”ï¼Œè¢«é”å°†æ— æ³•ç™»é™†ï¼Œä½†æ˜¯å¯èƒ½å…¶ä»–çš„ç™»å½•æ–¹å¼æ˜¯ä¸å—é™åˆ¶çš„ï¼Œå¦‚sshå…¬é’¥è®¤è¯çš„æ–¹å¼ï¼Œsuçš„æ–¹å¼ã€‚</span><br><span class="line">3. è¯¥åˆ—ä¸º&quot;*&quot;ï¼Œå³&quot;:*:&quot;ï¼Œä¹Ÿè¡¨ç¤ºè¯¥ç”¨æˆ·è¢«é”ï¼Œå’Œ&quot;!&quot;æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</span><br><span class="line">4. è¯¥åˆ—ä»¥&quot;!&quot;æˆ–&quot;!!&quot;å¼€å¤´ï¼Œåˆ™ä¹Ÿè¡¨ç¤ºè¯¥ç”¨æˆ·è¢«é”ã€‚</span><br><span class="line">5. è¯¥åˆ—ä¸º&quot;!!&quot;ï¼Œå³&quot;:!!:&quot;ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·ä»æ¥æ²¡è®¾ç½®è¿‡å¯†ç ã€‚</span><br><span class="line">6. å¦‚æœæ ¼å¼ä¸º&quot;$id$salt$hashed&quot;ï¼Œåˆ™è¡¨ç¤ºè¯¥ç”¨æˆ·å¯†ç æ­£å¸¸ã€‚å…¶ä¸­$id$çš„idè¡¨ç¤ºå¯†ç çš„åŠ å¯†ç®—æ³•ï¼Œ$1$è¡¨ç¤ºä½¿ç”¨MD5ç®—æ³•ï¼Œ$2a$è¡¨ç¤ºä½¿ç”¨Blowfishç®—æ³•ï¼Œ&quot;$2y$&quot;æ˜¯å¦ä¸€ç®—æ³•é•¿åº¦çš„Blowfish,&quot;$5$&quot;è¡¨ç¤ºSHA-256ç®—æ³•ï¼Œè€Œ&quot;$6$&quot;è¡¨ç¤ºSHA-512ç®—æ³•ã€‚åŠ å¯†ç®—æ³•ä¼šæ ¹æ®saltè¿›è¡Œç‰¹å®šçš„åŠ å¯†ï¼Œhashedæ˜¯ç”Ÿæˆçš„å¯†æ–‡</span><br></pre></td></tr></table></figure>
<p>æˆ‘çœ‹è‡ªå·±çš„linuxæœåŠ¡å™¨ä¸Šé¢éƒ½æ˜¯ä½¿ç”¨SHA-512åŠ å¯†çš„ï¼Œè€ŒåµŒå…¥å¼ç³»ç»Ÿä¸Šé¢ç”¨çš„æ˜¯MD5ï¼Œä½¿ç”¨å‘½ä»¤<br><img src="https://rancho333.github.io/pictures/openssl.png"><br>å°±å¯ä»¥ç”Ÿæˆå¯†ç äº†ï¼Œå°†åŸæ¥çš„å£ä»¤å­—æ®µæ›¿æ¢æ‰å³å¯å®Œæˆå¯†ç çš„ä¿®æ”¹ã€‚</p>
<p>æœ‰ä¸ªå°é—®é¢˜ï¼Œå®éªŒè¿‡ç¨‹ä¸­ï¼Œå‘ç°åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸Šç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­ä¿®æ”¹å¯†ç ä¸æ˜¯æŒ‰ç…§<code>$id$salt$hashed</code>æ¨¡å¼ç”Ÿæˆçš„å£ä»¤ï¼Œè€Œæ˜¯ï¼š<br><img src="https://rancho333.github.io/pictures/abnormal.png"><br>ä½†æ˜¯åœ¨å‘è¡Œç‰ˆLinuxä¸Šé¢æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œæœ‰å¯èƒ½æ˜¯åµŒå…¥å¼ç³»ç»Ÿçš„æŸäº›å·®å¼‚å§ï¼Œè¿™é‡Œç•™ä¸ªè®°å½•ï¼</p>
]]></content>
      <tags>
        <tag>passwd</tag>
      </tags>
  </entry>
  <entry>
    <title>LinuxæŸ¥æ‰¾soæ–‡ä»¶æ‰€åœ¨pkg</title>
    <url>/2019/07/14/Linux%E6%9F%A5%E6%89%BEso%E6%96%87%E4%BB%B6%E6%89%80%E5%9C%A8pkg/</url>
    <content><![CDATA[<h2 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h2><p>åœ¨Ubuntu16.04 serverä¸Šå®‰è£…typoraæ—¶æŠ¥é”™ï¼š<code>Typora: error while loading shared libraries: libnss3.so</code>  </p>
<span id="more"></span>
<p><img src="https://rancho333.github.io/pictures/error.png"><br>ä½¿ç”¨findåœ¨æœºå™¨ä¸Šçš„ç¡®æ²¡æœ‰æ‰¾åˆ°è¯¥soæ–‡ä»¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¯¹äºname.soï¼Œå®‰è£…ä¸€ä¸ªnameåŒ…å°±è¡Œäº†(soæ–‡ä»¶ä¸pkgæ–‡ä»¶åç›¸åŒ)ï¼Œä½†æœ‰çš„æ—¶å€™æ˜¯ä¸ç›¸åŒçš„ï¼Œè¿™æ—¶éœ€è¦åˆ©ç”¨apt-fileæŸ¥æ‰¾soæ–‡ä»¶æ‰€å±çš„pkg.<br><img src="https://rancho333.github.io/pictures/diff.png"></p>
<h2 id="å®‰è£…apt-file"><a href="#å®‰è£…apt-file" class="headerlink" title="å®‰è£…apt-file"></a>å®‰è£…apt-file</h2><p>å®‰è£…å‘½ä»¤ï¼š<code>sudo apt-get install apt-file</code><br>updateï¼š<code>apt-file update</code>,å½“/etc/apt/source.listæ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦é‡æ–°update<br><img src="https://rancho333.github.io/pictures/update.png"></p>
<h2 id="æŸ¥æ‰¾è½¯ä»¶æ‰€ä¾èµ–çš„soæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–åŒ…"><a href="#æŸ¥æ‰¾è½¯ä»¶æ‰€ä¾èµ–çš„soæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="æŸ¥æ‰¾è½¯ä»¶æ‰€ä¾èµ–çš„soæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–åŒ…"></a>æŸ¥æ‰¾è½¯ä»¶æ‰€ä¾èµ–çš„soæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–åŒ…</h2><p>æŸ¥çœ‹è½¯ä»¶ä½ç½®ï¼š<code>whereis typora</code><br><img src="https://rancho333.github.io/pictures/where.png"></p>
<p>æŸ¥æ‰¾è½¯ä»¶ä¾èµ–soï¼š<code>ldd /usr/bin/typora</code><br><img src="https://rancho333.github.io/pictures/not_found.png"></p>
<p>å¯¹æ¯ä¸€ä¸ªæ ‡æœ‰<code>not found</code>çš„soæ–‡ä»¶æ‰§è¡Œå¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/search.png"></p>
<p>æ‰¾åˆ°pkgåç§°åï¼Œä½¿ç”¨<code>sudo apt-get install pkg-name</code>å®‰è£…å³å¯ã€‚</p>
]]></content>
      <categories>
        <category>Linuxç›¸å…³</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>soæ–‡ä»¶</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxç§‘å­¦ä¸Šç½‘è®°å½•</title>
    <url>/2019/09/06/Linux%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>ä¹‹å‰åœ¨AWSéƒ¨ç½²äº†è‡ªå·±çš„shadowsocksçš„æœåŠ¡ç«¯ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå‚è§ssçš„<a href="https://github.com/shadowsocks/shadowsocks/tree/master">github</a>ä¸Šé¢ä»‹ç»å°±å¯ä»¥å¾ˆå®¹æ˜“çš„éƒ¨ç½²èµ·æ¥äº†ï¼Œä¹‹ååœ¨windowsä¸ŠAndroidå®‰è£…äº†å¯¹åº”çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥é¡ºåˆ©ç§‘å­¦ä¸Šç½‘ï¼Œæ­¤å¤„å¯¹è¿™ä¸€éƒ¨åˆ†å°±ä¸å¤šåšè¯´æ˜äº†ã€‚æœ€è¿‘åšSONiCï¼ˆå“ˆï¼Œåˆæ˜¯SONiCï¼‰ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦åœ¨googleä¸Šä¸‹è½½ä¸€äº›èµ„æºï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨LinuxæœåŠ¡å™¨ä¸Šç¿»å¢™ï¼Œå¹¶ä¸”åœ¨dockerä¸­å¯ä»¥è®¿é—®googleã€‚</p>
<span id="more"></span>

<h2 id="åœ¨linuxä¸Šå®‰è£…ss"><a href="#åœ¨linuxä¸Šå®‰è£…ss" class="headerlink" title="åœ¨linuxä¸Šå®‰è£…ss"></a>åœ¨linuxä¸Šå®‰è£…ss</h2><p>Linuxç¯å¢ƒæ˜¯ubuntu 16.04 serverï¼Œæ²¡æœ‰å›¾å½¢ç•Œé¢ï¼Œçº¯å‘½ä»¤è¡Œã€‚<br>ä½¿ç”¨pipå®‰è£…</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install python-pip</span><br><span class="line">sudo apt-get install python-setuptools m2crypto</span><br><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ç›´æ¥ç”¨aptå®‰è£…</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install shadowsocks</span><br></pre></td></tr></table></figure>
<p>ä¸­é—´å¯èƒ½ä¼šæç¤ºéœ€è¦å®‰è£…ä¸€äº›ä¾èµ–ï¼ŒæŒ‰æç¤ºå®‰è£…å³å¯ã€‚</p>
<h2 id="å¯åŠ¨ss"><a href="#å¯åŠ¨ss" class="headerlink" title="å¯åŠ¨ss"></a>å¯åŠ¨ss</h2><p>ssçš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ç¨‹åºå…¶å®æ˜¯åŒä¸€ä¸ªï¼ˆæ‰¾ssçš„å®¢æˆ·ç«¯æ‰¾äº†åŠå¤©ï¼‰ï¼Œåªæ˜¯å¯åŠ¨çš„å‘½ä»¤ä¸ä¸€æ ·ã€‚å®¢æˆ·ç«¯æ˜¯sslocalå‘½ä»¤ï¼ŒæœåŠ¡ç«¯æ˜¯ssserverå‘½ä»¤ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥<code>sslocal --help</code>çœ‹ä¸€ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¹ æƒ¯ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼å¯åŠ¨å®¢æˆ·ç«¯ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;                                                                                                     </span><br><span class="line">    &quot;server&quot;:&quot;x.x.x.x&quot;,</span><br><span class="line">    &quot;server_port&quot;:443,</span><br><span class="line">    &quot;local_address&quot;:&quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;local_port&quot;:1080,</span><br><span class="line">    &quot;password&quot;:&quot;xxxx123456&quot;,</span><br><span class="line">    &quot;timeout&quot;:300,</span><br><span class="line">    &quot;method&quot;:&quot;aes-256-cfb&quot;,</span><br><span class="line">    &quot;fast_open&quot;:false</span><br><span class="line">&#125;</span><br><span class="line">server  æœåŠ¡ç«¯vpsçš„å…¬ç½‘IPåœ°å€</span><br><span class="line">server_port     æœåŠ¡ç«¯çš„ç«¯å£</span><br><span class="line">local_address   æœ¬åœ°ipï¼Œä¸€èˆ¬localhost</span><br><span class="line">local_port      æœ¬åœ°ç«¯å£</span><br><span class="line">password        æœåŠ¡ç«¯å¯†ç </span><br><span class="line">timeout         è¶…æ—¶æ—¶é—´ï¼Œåº”å’ŒæœåŠ¡ç«¯ä¸€è‡´</span><br><span class="line">method          åŠ å¯†æ–¹å¼ï¼Œå’ŒæœåŠ¡ç«¯ä¸€è‡´</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸€å®šæ³¨æ„é…ç½®æ–‡ä»¶çš„ä¿¡æ¯ï¼Œè¯·å‚ç…§æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ï¼Œä¹‹åå¯ä»¥å¯åŠ¨å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sslocal -c &#x2F;home&#x2F;mudao&#x2F;shadowsocks.json -d -start</span><br></pre></td></tr></table></figure>

<h2 id="é…ç½®privoxyä»£ç†"><a href="#é…ç½®privoxyä»£ç†" class="headerlink" title="é…ç½®privoxyä»£ç†"></a>é…ç½®privoxyä»£ç†</h2><p>ssæ˜¯sock5ä»£ç†ï¼Œéœ€è¦åœ¨localé…ç½®privoxyå°†httpã€httpsè½¬æ¢æˆsock5æµé‡æ‰èƒ½èµ°åˆ°vpsã€‚</p>
<ul>
<li><p>å®‰è£…privoxy</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt-get install privoxy</span><br></pre></td></tr></table></figure></li>
<li><p>é…ç½®privoxy</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;privoxy&#x2F;config</span><br><span class="line">forward-socks5t &#x2F; 127.0.0.1:1080 .</span><br><span class="line">listen-address 127.0.0.1:8118</span><br><span class="line">ç¡®ä¿è¿™ä¸¤è¡Œçš„å­˜åœ¨</span><br></pre></td></tr></table></figure></li>
<li><p>å¯åŠ¨privoxy</p>
<ul>
<li>å¼€å¯privoxyæœåŠ¡<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo service privoxy start</span><br></pre></td></tr></table></figure></li>
<li>è®¾ç½®httpå’Œhttpså…¨å±€ä»£ç†<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export http_proxy&#x3D;&#39;http:&#x2F;&#x2F;localhost:8118&#39;</span><br><span class="line">export https_proxy&#x3D;&#39;https:&#x2F;&#x2F;localhost:8118&#39;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>æµ‹è¯•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl cip.cc</span><br></pre></td></tr></table></figure>
<p>ä¼šæ˜¾ç¤ºå‡ºä½ é…ç½®æ–‡ä»¶ä¸­vpsçš„åœ°å€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IP      : x.x.x.x</span><br><span class="line">åœ°å€    : æ—¥æœ¬  ä¸œäº¬éƒ½  ä¸œäº¬</span><br><span class="line">è¿è¥å•†  : amazon.com</span><br><span class="line"></span><br><span class="line">æ•°æ®äºŒ  : ç¾å›½ | Amazonæ•°æ®ä¸­å¿ƒ</span><br><span class="line"></span><br><span class="line">æ•°æ®ä¸‰  : æ—¥æœ¬ä¸œäº¬éƒ½ä¸œäº¬ | äºšé©¬é€Š</span><br><span class="line"></span><br><span class="line">URL     : http:&#x2F;&#x2F;www.cip.cc&#x2F;x.x.x.x</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ç„¶åå†å¯ä»¥è¿™æ ·ç©ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl &quot;http:&#x2F;&#x2F;pv.sohu.com&#x2F;cityjson?ie&#x3D;utf-8&quot;</span><br></pre></td></tr></table></figure>
<p>æœç‹çš„è¿™ä¸ªæ¥å£å¯ä»¥è¿”å›ä½ çš„IPåœ°å€</p>
<h2 id="é…ç½®PAC"><a href="#é…ç½®PAC" class="headerlink" title="é…ç½®PAC"></a>é…ç½®PAC</h2><p>å¾ˆæ˜æ˜¾çš„ï¼Œæˆ‘ä»¬ä¸æƒ³æ²¡è¢«å¢™çš„ç½‘ç«™ä¹Ÿèµ°ä»£ç†ï¼Œè¿™æ—¶å°±éœ€è¦PACäº†ã€‚</p>
<ul>
<li><p>å®‰è£…GFWList2Privoxy</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install --user gfwlist2privoxy</span><br></pre></td></tr></table></figure></li>
<li><p>è·å–gfwlistæ–‡ä»¶ï¼Œç”Ÿæˆactionsfile</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;tmp</span><br><span class="line">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;gfwlist&#x2F;gfwlist&#x2F;master&#x2F;gfwlist.txt</span><br><span class="line">~&#x2F;.local&#x2F;bin&#x2F;gfwlist2privoxy -i gfwlist.txt -f gfwlist.action -p 127.0.0.1:1080 -t socks5</span><br><span class="line">sudo cp gfwlist.action &#x2F;etc&#x2F;privoxy&#x2F;</span><br></pre></td></tr></table></figure>
<p>å“ˆï¼Œå¯ä»¥åœ¨gfwlist.actionä¸­æ‰¾ä¸€ä¸‹googleï¼Œå¾ˆå¤šï¼Œæ˜¯ä¸æ˜¯ã€‚æ©ï¼Œå¤§åé¼é¼çš„facebookï¼Œyoutubeï¼Œnetflixéƒ½åœ¨é‡Œé¢å“¦ï¼Œå¤©æœçš„GFWå°†è¿™äº›å…¨éƒ¨å¢™äº†ã€‚<br>å¦‚æœè®¿é—®æŸäº›å›½å¤–ç½‘ç«™é€Ÿåº¦æ…¢çš„è¯ï¼ˆæ¯”å¦‚æ—¶å¸¸æŠ½ç–¯çš„githubï¼‰ï¼Œå°±å°†å®ƒåŠ åˆ°é‡Œé¢å»å§ï¼</p>
</li>
</ul>
<p>æœ‰äº†é…ç½®æ–‡ä»¶ä¹‹åï¼Œåœ¨<code>/etc/privoxy/config</code>æ–‡ä»¶ä¸­åŠ ä¸Š<code>actionsfile gfwlist.action</code>å°±å¯ä»¥äº†</p>
<ul>
<li>é‡å¯Privoxyï¼Œæµ‹è¯•ä»£ç†æ˜¯å¦èµ°pacæ¨¡å¼<ul>
<li>æ˜¯å¦èƒ½google<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget www.google.com</span><br></pre></td></tr></table></figure></li>
<li>æ˜¯å¦èƒ½pac(æ˜¾ç¤ºè‡ªå·±ip)<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl &quot;http:&#x2F;&#x2F;pv.sohu.com&#x2F;cityjson?ie&#x3D;utf-8&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>æ³¨æ„<br>å¦‚æœè¿˜æ˜¯æ˜¾ç¤ºä»£ç†æœåŠ¡å™¨çš„IPï¼Œåˆ™æŠŠ/etc/privoxy/configä¸­çš„forward-socks5 / 127.0.0.1:1080 .è¿™ä¸€è¡Œæ³¨é‡Šäº†ï¼Œç„¶åé‡å¯privoxy<br>å¦‚æœä¸æ³¨é‡Šè¿™è¡Œï¼Œæ‰€æœ‰çš„æµé‡éƒ½èµ°ä»£ç†ï¼Œæˆ‘ä»¬åˆšæ‰åšçš„pacæ¨¡å¼ï¼Œå®ƒå°±ä¸èµ°äº†ã€‚</li>
</ul>
<h2 id="dockerä¸­ä½¿ç”¨ä»£ç†æµé‡"><a href="#dockerä¸­ä½¿ç”¨ä»£ç†æµé‡" class="headerlink" title="dockerä¸­ä½¿ç”¨ä»£ç†æµé‡"></a>dockerä¸­ä½¿ç”¨ä»£ç†æµé‡</h2><p>å—¯å—¯ï¼Œæˆ‘çš„åˆå¿ƒæ˜¯ä¸ºäº†åœ¨dockerä¸­ç¼–è¯‘sonicï¼Œè‡ªç„¶éœ€è¦è®©dockerä¹Ÿèƒ½ç§‘å­¦ä¸Šç½‘äº†ã€‚<br>åˆ›å»ºdockerçš„é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim  ~&#x2F;.docker&#x2F;config.json</span><br><span class="line">&#123;                  </span><br><span class="line">&quot;proxies&quot;:</span><br><span class="line">&#123;</span><br><span class="line">   &quot;default&quot;:</span><br><span class="line">   &#123;</span><br><span class="line">     &quot;httpProxy&quot;: &quot;http:&#x2F;&#x2F;localhost:8118&quot;,</span><br><span class="line">     &quot;httpsProxy&quot;: &quot;http:&#x2F;&#x2F;localhost:8118&quot;,</span><br><span class="line">     &quot;noProxy&quot;: &quot;localhost&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä½¿ç”¨<code>docker run -e &quot;http_proxy=http://localhost:8118&quot; -e &quot;https_proxy=http://localhost:8118&quot;</code></p>
<p>dockeré»˜è®¤æ˜¯bridgeçš„ç½‘ç»œæ¨¡å¼ï¼Œç«¯å£æ˜¯éœ€è¦åšè½¬å‘æ˜ å°„çš„ã€‚ä¸ºäº†ç›´æ¥ç”¨å®¿ä¸»æœºçš„ipå’Œç«¯å£ï¼Œæˆ‘ä»¬æ¢æˆç”¨hostçš„ç½‘ç»œæ¨¡å¼ï¼Œè®©å¥¹å’Œå®¿ä¸»æœºå¯ä»¥ç”¨åŒä¸€ä¸ªNetwork Namespace<br>ä¹Ÿå°±æ˜¯ä½¿ç”¨<code>docker run -e &quot;http_proxy=http://localhost:8118&quot; -e &quot;https_proxy=http://localhost:8118&quot; --net host</code>æ¥å¯åŠ¨ä¸€ä¸ªcontainer</p>
<p>æ³¨æ„åˆ°ä¸Šé¢<code>https_proxy</code>ä½¿ç”¨çš„ä»£ç†å’Œ<code>http_proxy</code>æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘åœ¨ä½¿ç”¨ä¸­å‘ç°æœ‰å¦‚ä¸‹æŠ¥é”™ï¼š<br><img src="https://rancho333.github.io/pictures/timeout.png"><br>æ›´æ”¹å®Œä¹‹åå°±å¥½äº†ï¼ŒåŸç†æš‚æ—¶ä¸æ¸…æ¥šï¼Œçœ‹æœºç¼˜æ›´æ–°å§ï¼</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a href="https://huangweitong.com/229.html">Linux ä½¿ç”¨ ShadowSocks + Privoxy å®ç° PAC ä»£ç†</a></p>
<p><a href="https://blog.diosfun.com/2018/09/21/Ubuntu18-04%E5%AE%89%E8%A3%85shadowsocks%E5%AE%A2%E6%88%B7%E7%AB%AF/">Ubuntu18.04å®‰è£…shadowsockså®¢æˆ·ç«¯</a></p>
<p><a href="https://kebingzao.com/2019/02/22/docker-container-proxy/">docker å®¹å™¨å†…ä½¿ç”¨å®¿ä¸»æœºçš„ä»£ç†é…ç½®</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>ç§‘å­¦ä¸Šç½‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxç³»ç»Ÿç§»æ¤ç®€è¿°</title>
    <url>/2020/03/16/Linux%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>ä¹‹å‰ä¹Ÿåšè¿‡ä¸€äº›ç§»æ¤æ€§çš„ä¸œè¥¿ï¼Œä¸è¿‡éƒ½æ˜¯åˆ«äººæ­å¥½æ¡†æ¶ï¼Œè‡ªå·±å¡«å……ä¸€äº›æ¨¡å—ï¼Œè¿™æ¬¡æœ‰æœºä¼šå®Œæˆç³»ç»Ÿçº§çš„ç§»æ¤ï¼Œéå¸¸æ„Ÿè°¢å¼ æ€»ä»¥åŠèƒ¡è€å¸ˆçš„æŒ‡ç‚¹å¸®åŠ©ï¼Œæ”¶è·è‰¯å¤šï¼</p>
<span id="more"></span>
<h1 id="ç§»æ¤æ€»è¿°"><a href="#ç§»æ¤æ€»è¿°" class="headerlink" title="ç§»æ¤æ€»è¿°"></a>ç§»æ¤æ€»è¿°</h1><p>åµŒå…¥å¼ç³»ç»Ÿç§»æ¤åˆ†ä¸ºå››ä¸ªå¤§å—ï¼Œåˆ†åˆ«æ˜¯æ„å»ºäº¤å‰ç¼–è¯‘å·¥å…·ï¼Œrootfsçš„åˆ¶ä½œï¼Œkernelçš„é…ç½®ã€ç¼–è¯‘ã€ç§»æ¤ï¼ŒBootLoaderçš„ç§»æ¤ã€‚éœ€è¦ç§»æ¤çš„ç³»ç»Ÿå¯ä»¥åœ¨MIPSä¸Šè·‘èµ·æ¥ï¼Œæˆ‘åªéœ€è¦é¡ºç€åŸæœ‰çš„ç¼–è¯‘æ¡†æ¶å®ŒæˆARM64çš„ç¼–è¯‘ï¼Œä¹‹åå†ä¸Šæ¿å­åšå…·ä½“çš„è°ƒè¯•ã€‚</p>
<h2 id="æ„å»ºäº¤å‰ç¼–è¯‘å·¥å…·"><a href="#æ„å»ºäº¤å‰ç¼–è¯‘å·¥å…·" class="headerlink" title="æ„å»ºäº¤å‰ç¼–è¯‘å·¥å…·"></a>æ„å»ºäº¤å‰ç¼–è¯‘å·¥å…·</h2><p>toolchainä¸€èˆ¬èŠ¯ç‰‡å‚å®¶ä¼šæä¾›ï¼Œå½“ç„¶è‡ªå·±é€šè¿‡buildrootæ„å»ºä¹Ÿæ˜¯å¯ä»¥çš„ã€‚<br>ä½¿ç”¨buildrootæ„å»ºäº¤å‰ç¼–è¯‘å·¥å…·ï¼Œä¸‹è½½buildroot2015</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;buildroot.uclibc.org&#x2F;downloads&#x2F;buildroot-2015.08.tar.gz</span><br></pre></td></tr></table></figure>
<p><code>make menuconfig ARCH=arm64</code>é…ç½®buildrootï¼Œå°†targetå’Œtoolchainä¸¤é¡¹é…ç½®æˆå¦‚ä¸‹æ‰€ç¤º<br><img src="https://rancho333.github.io/pictures/buildroot.png"><br>ä¹‹å<code>make</code>ç­‰å¾…å®Œæˆå³å¯ï¼Œbuildrootæœ‰äº›æºç ä¸‹è½½é€Ÿåº¦å¾ˆæ…¢ï¼Œä¸‹è½½ç½‘ç«™ä¹Ÿä¸å°½ç›¸åŒï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œä¸åƒLinuxå‘è¡Œç‰ˆå¯ä»¥æ”¹æˆå›½å†…é•œåƒè½¯ä»¶æºï¼Œæœ‰çš„å¯èƒ½ä¼šç­‰å¾…æ¯”è¾ƒé•¿çš„æ—¶é—´ã€‚<br>å°†ç”Ÿæˆçš„toolchainæ‰“åŒ…ï¼Œé‡Šæ”¾åˆ°æœåŠ¡å™¨dockerç¼–è¯‘ç¯å¢ƒä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/toolchain.png"><br>ä¹‹åå¯ä»¥æ ¹æ®containeræ„å»ºimageå°†ç¼–è¯‘ç¯å¢ƒå‘å¸ƒå‡ºå»ï¼Œå¤§å®¶å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚</p>
<h2 id="kernelçš„é…ç½®ã€ç¼–è¯‘ã€ç§»æ¤"><a href="#kernelçš„é…ç½®ã€ç¼–è¯‘ã€ç§»æ¤" class="headerlink" title="kernelçš„é…ç½®ã€ç¼–è¯‘ã€ç§»æ¤"></a>kernelçš„é…ç½®ã€ç¼–è¯‘ã€ç§»æ¤</h2><p>kernelçš„é…ç½®ç»“æœä¿å­˜åœ¨<code>.config</code>æ–‡ä»¶ä¸­ï¼Œæ ¹æ®å®é™…çš„éœ€æ±‚ä¼šé€‰é…ä¸€äº›å†…æ ¸é€‰é¡¹ï¼Œå¦‚å¼€å¯natä»¥åŠvethç›¸å…³çš„é…ç½®<br><img src="https://rancho333.github.io/pictures/nat.png"><br><img src="https://rancho333.github.io/pictures/veth.png"><br>è¿™äº›é…ç½®å®é™…ä¸Šæ˜¯ç³»ç»Ÿæ„å»ºå®Œæˆåè·‘èµ·æ¥æŠ¥é”™æ‰çŸ¥é“éœ€è¦çš„ï¼Œåªéœ€è¦åœ¨<code>make menuconfig</code>ä¸­æœç´¢å¯¹åº”å…³é”®å­—å³å¯æ‰¾åˆ°ç¼–è¯‘é€‰é¡¹ã€‚<br>å…³äºå†…æ ¸ç¼–è¯‘çš„ä¸€äº›è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« <br><a href="https://rancho333.github.io/2020/03/11/kernel%E7%BC%96%E8%AF%91%E7%AE%80%E8%BF%B0/">kernelç¼–è¯‘ç®€è¿°</a></p>
<h2 id="rootfsçš„åˆ¶ä½œ"><a href="#rootfsçš„åˆ¶ä½œ" class="headerlink" title="rootfsçš„åˆ¶ä½œ"></a>rootfsçš„åˆ¶ä½œ</h2><p>åœ¨è¿™ä¸€æ­¥å…¶å®èŠ±çš„æ—¶é—´æ˜¯æœ€å¤šçš„ï¼Œå› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°å¤§é‡çš„ä¸Šå±‚åº”ç”¨æ¨¡å—çš„ç¼–è¯‘ï¼Œç„¶åè¿™äº›æ¨¡å—çš„ä¾èµ–åº“åœ¨äº¤å‰å·¥å…·é“¾ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œè¿˜æœ‰éƒ¨åˆ†æ˜¯éœ€è¦ç¼–è¯‘ä¸€äº›ç‹¬ç«‹çš„Linuxå‘½ä»¤ã€‚è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œä¸‹è½½æºç ï¼Œç¼–è¯‘å‡ºåº“ï¼Œä¹‹åæ”¾åˆ°äº¤å‰å·¥å…·é“¾å’Œæ–‡ä»¶ç³»ç»Ÿä¸­å³å¯ã€‚<br>è¿™é‡Œè¯´ä¸‹å¼€æºä»£ç äº¤å‰ç¼–è¯‘çš„ç»å…¸ä¸‰éƒ¨æ›²<code>configure, make, make install</code>ï¼Œåœ¨configureä¸­ä¼šæŒ‡å®šäº¤å‰ç¼–è¯‘å·¥å…·ï¼Œç¼–è¯‘ç”Ÿæˆæ–‡ä»¶çš„installè·¯å¾„,å…³äºåŠ¨æ€åº“çš„ä¸€äº›ç†è§£å¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« <br><a href="https://rancho333.github.io/2020/02/26/%E5%85%B3%E4%BA%8E%E5%8A%A8%E6%80%81%E5%BA%93%E4%BB%A5%E5%8F%8Aconstructor%E5%B1%9E%E6%80%A7%E7%9A%84%E4%BD%BF%E7%94%A8/">å…³äºåŠ¨æ€åº“ä»¥åŠconstructorå±æ€§çš„ä½¿ç”¨</a><br>å—¯ï¼Œrootfsä»¥å‰ä¸€ç›´ç”¨buildrootæ¥åˆ¶ä½œï¼Œè¿™é‡Œå‘ç°ä¸€ä¸ªä¸ä¸€æ ·çš„æ–¹å¼</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. ä½¿ç”¨mktempå‘½ä»¤åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶</span><br><span class="line">2. ä½¿ç”¨shellå‘½ä»¤æ„å»ºæ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯echoå‘½ä»¤ç„¶åé‡å®šå‘åˆ°ä¸´æ—¶æ–‡ä»¶</span><br><span class="line">3. ä½¿ç”¨gen_init_cpioå’Œå‹ç¼©è½¯ä»¶æ„å»ºcpioæ ¼å¼çš„å‹ç¼©åŒ…</span><br><span class="line">4. åˆ é™¤ä¸´æ—¶æ–‡ä»¶</span><br></pre></td></tr></table></figure>
<p><img src="https://rancho333.github.io/pictures/rootfs.png"></p>
<h2 id="BootLoaderçš„ç§»æ¤"><a href="#BootLoaderçš„ç§»æ¤" class="headerlink" title="BootLoaderçš„ç§»æ¤"></a>BootLoaderçš„ç§»æ¤</h2><p>ç»™çš„å¼€å‘æ¿ä¸Šç›´æ¥çƒ§æœ‰ubootï¼Œæ‰€ä»¥è¿™é‡Œä¸æ¶‰åŠè‡ªå·±æ„å»ºbootloaderäº†ã€‚åœ¨bring upçš„è¿‡ç¨‹ä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜å¡äº†å¾ˆä¹…ï¼š<br><img src="https://rancho333.github.io/pictures/panic.png"><br>è¿”å›é”™è¯¯8çš„å«ä¹‰<code>æ–‡ä»¶æ²¡æœ‰å¯æ‰§è¡Œæƒé™</code>,ç¡®è®¤è¿‡busyboxçš„æ‰§è¡Œæƒé™ï¼Œå¹¶ä¸”æ˜¯é™æ€ç¼–è¯‘ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åŒå¹³å°çš„å…¶å®ƒæœºå™¨ä¸Šæ‰§è¡Œã€‚<br>çœŸå®çš„é”™è¯¯æ˜¯kernelåœ¨rootfsä¸­æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”è¾ƒè¯¦ç»†çš„æè¿°è§ä¸Šæ–‡æåˆ°çš„<code>kernelç¼–è¯‘ç®€è¿°</code>ã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://www.cnblogs.com/kernel-style/p/3397705.html">linux initå¯åŠ¨åˆ†æ</a></p>
]]></content>
      <tags>
        <tag>ç³»ç»Ÿç§»æ¤</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxè·¯ç”±ä¿¡æ¯å­¦ä¹ </title>
    <url>/2021/02/08/Linux%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p><code>route</code>å‘½ä»¤ç”¨æ¥æŸ¥çœ‹Linuxå†…æ ¸è·¯ç”±è¡¨ã€‚</p>
<span id="more"></span>

<h1 id="è¡¨é¡¹å†…å®¹è¯´æ˜"><a href="#è¡¨é¡¹å†…å®¹è¯´æ˜" class="headerlink" title="è¡¨é¡¹å†…å®¹è¯´æ˜"></a>è¡¨é¡¹å†…å®¹è¯´æ˜</h1><p><code>route</code>å‘½ä»¤è¾“å‡ºå¦‚ä¸‹ï¼Œä½¿ç”¨<code>-n</code>é€‰é¡¹è¡¨ç¤ºä¸è§£æåå­—ï¼Œå¯ä»¥åŠ å¿«ä¿¡æ¯è¾“å‡ºé€Ÿåº¦ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">default         10.204.112.1    0.0.0.0         UG    0      0        0 ens160</span><br><span class="line">10.10.30.0      *               255.255.255.0   U     0      0        0 ens192</span><br><span class="line">10.204.112.0    *               255.255.254.0   U     0      0        0 ens160</span><br><span class="line">link-local      *               255.255.0.0     U     1000   0        0 ens192</span><br><span class="line">172.17.0.0      *               255.255.0.0     U     0      0        0 docker0</span><br></pre></td></tr></table></figure>
<p>å­—æ®µè§£é‡Šå¦‚ä¸‹ï¼š<br>| å­—æ®µ | è¯´æ˜ |<br>| :â€” | :â€” |<br>| Destination | ç›®æ ‡ç½‘æ®µæˆ–ä¸»æœº |<br>| Gateway | ç½‘å…³åœ°å€ï¼Œ *æˆ–å…¨0è¡¨ç¤ºç›®æ ‡æ˜¯æœ¬ä¸»æœºæ‰€å±çš„ç½‘ç»œï¼Œä¸éœ€è¦è·¯ç”± |<br>| Genmask | ç½‘ç»œæ©ç  |<br>| Flags | U:è·¯ç”±æ—¶æ´»åŠ¨çš„ï¼›H:ç›®æ ‡æ˜¯ä¸ªä¸»æœºï¼›G:è·¯ç”±æŒ‡å‘ç½‘å…³ï¼›R:æ¢å¤åŠ¨æ€è·¯ç”±äº§ç”Ÿçš„è¡¨é¡¹ï¼›D:ç”±è·¯ç”±çš„åå°ç¨‹åºåŠ¨æ€çš„å®‰è£…ï¼›M:ç”±è·¯ç”±çš„åå°ç¨‹åºä¿®æ”¹; !:æ‹’ç»è·¯ç”± |<br>| Metric | è·¯ç”±è·ç¦»ï¼Œåˆ°è¾¾æŒ‡å®šç½‘ç»œæ‰€éœ€è¦çš„ä¸­è½¬æ•°(linuxå†…æ ¸ä¸­æ²¡æœ‰ä½¿ç”¨) |<br>| Ref | è·¯ç”±é¡¹å¼•ç”¨æ¬¡æ•°(linuxå†…æ ¸ä¸­æ²¡æœ‰ä½¿ç”¨) |<br>| Use | æ­¤è·¯ç”±é¡¹è¢«è·¯ç”±è½¯ä»¶æŸ¥æ‰¾çš„æ¬¡æ•° |<br>| Iface | è¯¥è·¯ç”±è¡¨é¡¹çš„è¾“å‡ºæ¥å£ |</p>
<p>Linuxä¸Šæœ‰ä¸‰ç§è·¯ç”±ç±»å‹ï¼š</p>
<ul>
<li>ä¸»æœºè·¯ç”±ã€‚è·¯ç”±è¡¨ä¸­æŒ‡å‘å•ä¸ªIPåœ°å€æˆ–ä¸»æœºåçš„è·¯ç”±è®°å½•ã€‚ä¸»æœºè·¯ç”±çš„Flagså­—æ®µä¸ºHã€‚</li>
<li>ç½‘ç»œè·¯ç”±ã€‚ä»£è¡¨ä¸»æœºå¯ä»¥åˆ°è¾¾çš„ç½‘ç»œã€‚ç½‘ç»œè·¯ç”±çš„Flagså­—æ®µä¸ºNã€‚</li>
<li>é»˜è®¤è·¯ç”±ã€‚å½“ä¸»æœºä¸èƒ½å†è·¯ç”±è¡¨ä¸­æŸ¥æ‰¾åˆ°ç›®æ ‡ä¸»æœºçš„IPåœ°å€æˆ–ç½‘ç»œè·¯ç”±æ—¶ï¼Œæ•°æ®åŒ…å°±è¢«å‘é€åˆ°é»˜è®¤è·¯ç”±ä¸Šã€‚é»˜è®¤è·¯ç”±çš„Flagså­—æ®µä¸ºGã€‚</li>
</ul>
<p>å¯¹äºä¸€ä¸ªç‰©ç†ç½‘å¡ï¼ŒLinuxé»˜è®¤åªæ”¯æŒä¸€æ¡é»˜è®¤è·¯ç”±ã€‚å½“ç„¶å¯ä»¥é€šè¿‡routeå‘½ä»¤æ‰‹åŠ¨æ·»åŠ å¤šæ¡é»˜è®¤è·¯ç”±ï¼Œå½“é‡æ–°å¯åŠ¨ç½‘å£æ—¶ï¼Œä¼šæŠŠå…¶å®ƒé»˜è®¤è·¯ç”±å»æ‰ï¼Œåªå‰©ä¸‹ä¸€æ¡è¯¥ç½‘å£ç”Ÿæˆçš„é»˜è®¤è·¯ç”±ã€‚</p>
<h1 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h1><h2 id="æ·»åŠ æˆ–åˆ é™¤è·¯ç”±"><a href="#æ·»åŠ æˆ–åˆ é™¤è·¯ç”±" class="headerlink" title="æ·»åŠ æˆ–åˆ é™¤è·¯ç”±"></a>æ·»åŠ æˆ–åˆ é™¤è·¯ç”±</h2><p>route {add | del } [-net|-host] [ç½‘åŸŸæˆ–ä¸»æœº] netmask [mask] [gw|dev]</p>
<p>route add default gw 192.168.5.1</p>
<p>route add -net 10.204.0.0/16 eth0<br>route add -net 10.204.0.0/26 gw 10.204.123.1</p>
<h2 id="æŸ¥è¯¢è·¯ç”±ä¿¡æ¯"><a href="#æŸ¥è¯¢è·¯ç”±ä¿¡æ¯" class="headerlink" title="æŸ¥è¯¢è·¯ç”±ä¿¡æ¯"></a>æŸ¥è¯¢è·¯ç”±ä¿¡æ¯</h2><p>route -nee</p>
<p>eeé€‰é¡¹è¡¨ç¤ºè¯¦ç»†ä¿¡æ¯</p>
]]></content>
      <tags>
        <tag>è·¯ç”±</tag>
      </tags>
  </entry>
  <entry>
    <title>Makefileå­¦ä¹ </title>
    <url>/2019/08/26/Makefile%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>å­¦è½¯ä»¶çš„æ—¶å€™æ¥è§¦è¿‡ä¸€äº›makefileï¼Œä½†æ˜¯ä¹‹åçš„å·¥ä½œä¸­ä¸€ç›´æ²¡æ€ä¹ˆç”¨ä¸Šã€‚æœ€è¿‘åœ¨åšç™½ç›’äº¤æ¢æœºSONiCä»¥åŠONLçš„ç¼–è¯‘å·¥ä½œï¼Œé‡Œé¢ç”¨makefileå’Œpythonå®Œæˆæ•´ä¸ªå·¥ç¨‹çš„ç¼–è¯‘ï¼Œæœ‰äº›å®å¤§ä¸éœ‡æ’¼ï¼Œå…³é”®å¾ˆå¤šåœ°æ–¹çœ‹ä¸æ‡‚å“‡ã€‚ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹ï¼Œè¿™é‡Œä½œä¸ºç¬”è®°ï¼Œå‚è€ƒçš„æ˜¯é™ˆçš“çš„ã€Šè·Ÿæˆ‘ä¸€èµ·å†™Makefileã€‹ã€‚</p>
<span id="more"></span>
<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ä¼šä¸ä¼šå†™makefileä»ä¸€ä¸ªä¾§é¢è¯´æ˜ä¸€ä¸ªäººæ˜¯å¦å…·å¤‡å®Œæˆå¤§å‹å·¥ç¨‹çš„èƒ½åŠ›ã€‚</p>
<p>makefileå…³ç³»åˆ°äº†æ•´ä¸ªå·¥ç¨‹çš„ç¼–è¯‘è§„åˆ™ã€‚æºæ–‡ä»¶ï¼ˆç±»å‹ã€åŠŸèƒ½ã€æ¨¡å—ï¼‰æ”¾åœ¨è‹¥å¹²ç›®å½•ï¼Œmakefileæ˜¯ç¼–è¯‘è§„åˆ™ï¼ŒæŒ‡å®šé‚£äº›æ–‡ä»¶éœ€è¦å…ˆç¼–è¯‘ï¼Œåç¼–è¯‘ï¼Œé‡æ–°ç¼–è¯‘ã€‚å…¶ä¸­ä¹Ÿå¯ä»¥æ‰§è¡Œæ“ä½œç³»ç»Ÿçš„å‘½ä»¤ã€‚</p>
<p>makeæ˜¯è§£é‡Šmakefileä¸­æŒ‡ä»¤çš„å‘½ä»¤å·¥å…·ã€‚</p>
<h2 id="å…³äºç¨‹åºçš„ç¼–è¯‘ä¸é“¾æ¥"><a href="#å…³äºç¨‹åºçš„ç¼–è¯‘ä¸é“¾æ¥" class="headerlink" title="å…³äºç¨‹åºçš„ç¼–è¯‘ä¸é“¾æ¥"></a>å…³äºç¨‹åºçš„ç¼–è¯‘ä¸é“¾æ¥</h2><p>ç¼–è¯‘æµç¨‹ï¼šé¢„å¤„ç†ï¼ˆ.iï¼‰ï¼Œç¼–è¯‘(.s)ï¼Œæ±‡ç¼–(.o)ï¼Œé“¾æ¥(binary)ã€‚</p>
<p>ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨éœ€è¦çš„æ˜¯è¯­æ³•çš„æ­£ç¡®ï¼Œå‡½æ•°ä¸å˜é‡çš„å£°æ˜çš„æ­£ç¡®ï¼ˆå‘Šè¯‰å¤´æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ï¼Œå®šä¹‰åº”è¯¥æ”¾åœ¨Cæ–‡ä»¶ä¸­ï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªæºæ–‡ä»¶éƒ½åº”è¯¥å¯¹åº”äºä¸€ä¸ªä¸­é—´ç›®æ ‡æ–‡ä»¶ï¼ˆ.oæ–‡ä»¶ï¼‰ã€‚å¦‚æœå‡½æ•°æœªè¢«å£°æ˜ï¼Œç¼–è¯‘å™¨å¯ä»¥ç”ŸæˆObiect Fileã€‚</p>
<p>é“¾æ¥æ—¶ï¼Œä¸»è¦é“¾æ¥å‡½æ•°ä¸å…¨å±€å˜é‡ã€‚å°†ä¸­é—´ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆåº”ç”¨ç¨‹åºã€‚ä¸­é—´ç›®æ ‡æ–‡ä»¶å¤ªå¤šï¼Œå°†å…¶æ‰“åŒ…ï¼Œwindowsä¸‹è¿™ç§åŒ…å«â€œåº“æ–‡ä»¶â€(library file)ï¼Œä¹Ÿå°±æ˜¯.libæ–‡ä»¶ï¼Œåœ¨UNIXä¸‹æ˜¯Archive File,ä¹Ÿå°±æ˜¯.aæ–‡ä»¶ã€‚åœ¨Object Fileä¸­å¯»æ‰¾å‡½æ•°çš„å®ç°ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±æŠ¥é”™ã€‚</p>
<h2 id="Makefileä»‹ç»"><a href="#Makefileä»‹ç»" class="headerlink" title="Makefileä»‹ç»"></a>Makefileä»‹ç»</h2><p>Makefileè§„åˆ™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">target ... : prerequisites ...</span><br><span class="line">    command</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>targetæ˜¯ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯Object Fileï¼Œä¹Ÿå¯ä»¥æ˜¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼ˆLablelï¼‰ã€‚<br>prerequisiteså³ä¾èµ–ã€‚<br>commandæ˜¯makeéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä»»æ„shellå‘½ä»¤ã€‚</p>
<p>Makefileä¸­æ ¸å¿ƒå†…å®¹ï¼š<br><em><strong>prerequisitesä¸­å¦‚æœæœ‰ä¸€ä¸ªä»¥ä¸Šçš„æ–‡ä»¶å¿…targetæ–‡ä»¶è¦æ–°ï¼ˆæˆ–è€…targetä¸å­˜åœ¨ï¼‰çš„è¯ï¼Œcommandæ‰€å®šä¹‰çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œ</strong></em></p>
<p>Makefileè‡ªåŠ¨æ¨å¯¼åŠŸèƒ½ï¼Œå¯¹äº[.o]æ–‡ä»¶ï¼Œä»–ä¼šæŠŠ[.c]æ–‡ä»¶è‡ªåŠ¨åŠ åœ¨ä¾èµ–å…³ç³»ä¸­ï¼Œå¹¶ä¸”[command]gcc -c file.cä¹Ÿä¼šè¢«æ¨å¯¼å‡ºæ¥ã€‚</p>
<h2 id="Makefileæ€»è¿°"><a href="#Makefileæ€»è¿°" class="headerlink" title="Makefileæ€»è¿°"></a>Makefileæ€»è¿°</h2>]]></content>
  </entry>
  <entry>
    <title>Markdownå­¦ä¹ ç¬”è®°</title>
    <url>/2019/07/14/Markdown%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="Markdownå­¦ä¹ ç¬”è®°"><a href="#Markdownå­¦ä¹ ç¬”è®°" class="headerlink" title="Markdownå­¦ä¹ ç¬”è®°"></a>Markdownå­¦ä¹ ç¬”è®°</h1><p>æœ€æ—©æ¥è§¦Markdown(ä¸‹é¢ç®€ç§°md)æ ‡è®°è¯­è¨€æ˜¯åœ¨æœ‰é“äº‘ç¬”è®°ä¸Šï¼Œå½“æ—¶çš„å­¦ä¹ è®¡åˆ’å°±æ˜¯ç”¨mdå†™çš„,åæ¥çœ‹åˆ°githubä¸ŠreadmeåŸºæœ¬ä¸Š<br>éƒ½æ˜¯ç”¨mdå†™çš„ï¼Œåˆ°å¦‚ä»Šæ­å»ºè‡ªå·±çš„Blog,mdåšä¸ºä¸»è¦çš„ç¼–å†™blogæ–¹å¼ï¼ŒèŠ±ç‚¹æ—¶é—´ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹mdã€‚</p>
<span id="more"></span>

<h2 id="Markdownç®€ä»‹"><a href="#Markdownç®€ä»‹" class="headerlink" title="Markdownç®€ä»‹"></a>Markdownç®€ä»‹</h2><p>mdæ˜¯ä¸€ç§è½»é‡çº§çš„æ ‡è®°è¯­è¨€ï¼Œmdç¼–å†™çš„æ–‡æ¡£å¯ä»¥å¯¼å‡ºHYMLã€Wordã€å›¾åƒã€PDFç­‰å¤šç§æ ¼å¼çš„æ–‡æ¡£,mdç¼–å†™çš„æ–‡æ¡£åç¼€åä¸º<br>.mdï¼Œmarkdownã€‚<br>mdå¯ä»¥ç”¨æ¥æ’°å†™ç”µå­ä¹¦ï¼Œå¸®åŠ©æ–‡æ¡£æˆ–åœ¨è®ºå›ä¸Šå‘è¡¨æ¶ˆæ¯ã€‚ä¾‹å¦‚ï¼šGitHubã€ç®€ä¹¦ã€‚<br>ä¸ªäººç†è§£ï¼Œmdå°±æ˜¯æ¯”è¾ƒç®€å•çš„æ ¼å¼åŒ–æ–‡æœ¬è¯­è¨€ã€‚</p>
<h2 id="Markdownæ ‡é¢˜"><a href="#Markdownæ ‡é¢˜" class="headerlink" title="Markdownæ ‡é¢˜"></a>Markdownæ ‡é¢˜</h2><ol>
<li>ä½¿ç”¨=å’Œ-æ ‡è®°ä¸€çº§å’ŒäºŒçº§æ ‡é¢˜  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿™æ˜¯ä¸€çº§æ ‡é¢˜  </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;   </span><br><span class="line">è¿™æ˜¯äºŒçº§æ ‡é¢˜   </span><br><span class="line">-----------  </span><br></pre></td></tr></table></figure>
<p>ä¸ªäººä¸€èˆ¬ä¸ä¹ æƒ¯è¿™ç§ç”¨æ³•ï¼Œä¸€èˆ¬é‡‡ç”¨#æ¥æ ‡è®°æ ‡é¢˜<br>2. ä½¿ç”¨#æ ‡è®°<br>ä½¿ç”¨#å¯ä»¥è¡¨ç¤º1-6çº§æ ‡é¢˜ï¼Œä¸€çº§æ ‡é¢˜å¯¹åº”ä¸€ä¸ª#å·ï¼Œå¦‚ä¸‹   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ä¸€çº§æ ‡é¢˜   </span><br><span class="line">## äºŒçº§æ ‡é¢˜   </span><br><span class="line">### ä¸‰çº§æ ‡é¢˜   </span><br><span class="line">#### å››çº§æ ‡é¢˜   </span><br><span class="line">##### äº”çº§æ ‡é¢˜  </span><br><span class="line">###### å…­çº§æ ‡é¢˜  </span><br></pre></td></tr></table></figure>

<p>æ˜¾ç¤ºæ•ˆæœå°±ä¸åœ¨è¿™é‡Œè´´å›¾äº†ï¼Œè‡ªå·±æ•²æ•²çœ‹ä¸‹æ•ˆæœï¼Œæ³¨æ„#åé¢ä¸æ ‡é¢˜ä¹‹é—´æœ‰ä¸ªç©ºæ ¼ï¼Œç©ºæ ¼è¿™ç§åŸºæœ¬åˆ†å‰²è¯­æ³•åœ¨mdé‡Œé¢è¦æ³¨æ„ã€‚    </p>
<h2 id="Markdownæ®µè½ä¸æ¢è¡Œ"><a href="#Markdownæ®µè½ä¸æ¢è¡Œ" class="headerlink" title="Markdownæ®µè½ä¸æ¢è¡Œ"></a>Markdownæ®µè½ä¸æ¢è¡Œ</h2><p>mdçš„æ¢è¡Œå°±æ˜¯åœ¨è¡Œå°¾åŠ ä¸Šä¸¤ä¸ªä»¥ä¸Šçš„ç©ºæ ¼ï¼Œç„¶åæ¢è¡Œå†™å…¶ä»–æ–‡å­—ï¼Œæœ‰çš„mdç¼–è¾‘å™¨å¯èƒ½åªéœ€è¦å›è½¦å°±å¯ä»¥ï¼ˆè‡ªåŠ¨åŠ ä¸Šä¸¤ä¸ªç©ºæ ¼ï¼Ÿï¼‰,æˆ‘ç”¨çš„æ˜¯Visual Studio Code,éœ€è¦è‡ªå·±åŠ ã€‚æ®µè½çš„å‰åå¿…é¡»éƒ½æ˜¯ç©ºè¡Œï¼Œç©ºè¡ŒæŒ‡çš„æ˜¯è¡Œå†…ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚  </p>
<h2 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h2><p>mdæ”¯æŒä»¥ä¸‹å‡ ç§å­—ä½“  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*æ–œä½“æ–‡æœ¬*  </span><br><span class="line">_æ–œä½“æ–‡æœ¬_</span><br><span class="line">**ç²—ä½“æ–‡æœ¬**  </span><br><span class="line">__ç²—ä½“æ–‡æœ¬__  </span><br><span class="line">***ç²—æ–œä½“æ–‡æœ¬***  </span><br><span class="line">___ç²—æ–œä½“æ–‡æœ¬___    </span><br></pre></td></tr></table></figure>
<p><em>æ–œä½“æ–‡æœ¬</em><br><em>æ–œä½“æ–‡æœ¬</em><br><strong>ç²—ä½“æ–‡æœ¬</strong><br><strong>ç²—ä½“æ–‡æœ¬</strong><br><em><strong>ç²—æ–œä½“æ–‡æœ¬</strong></em><br><em><strong>ç²—æ–œä½“æ–‡æœ¬</strong></em><br>å»ºè®®é‡‡ç”¨*æˆ–_ä¸€ç§é£æ ¼æ¥ä¹¦å†™ï¼Œæˆ‘ä½¿ç”¨*.  </p>
<h2 id="åˆ†å‰²çº¿"><a href="#åˆ†å‰²çº¿" class="headerlink" title="åˆ†å‰²çº¿"></a>åˆ†å‰²çº¿</h2><p>åœ¨ä¸€è¡Œä¸­ä½¿ç”¨ä¸‰ä¸ªä»¥ä¸Šçš„æ˜Ÿå·ã€å‡å·ã€åº•çº¿æ¥å»ºç«‹ä¸€ä¸ªåˆ†å‰²çº¿ï¼Œè¡Œå†…ä¸èƒ½æœ‰å…¶å®ƒä¸œè¥¿ï¼Œä½†å¯ä»¥åœ¨ç¬¦å·ä¹‹é—´æ’å…¥ç©ºæ ¼ã€‚å»ºè®®é‡‡å–ä¸€ç§å†™æ³•å°±è¡Œï¼Œæˆ‘é‡‡ç”¨***.  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">***  </span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---  </span><br><span class="line">___  </span><br></pre></td></tr></table></figure>
<p>æ•ˆæœä¸€æ ·ã€‚    </p>
<h2 id="åˆ é™¤çº¿"><a href="#åˆ é™¤çº¿" class="headerlink" title="åˆ é™¤çº¿"></a>åˆ é™¤çº¿</h2><p>åœ¨æ–‡å­—ä¸¤ç«¯åˆ†åˆ«åŠ ä¸Šä¸¤ä¸ªæ³¢æµªçº¿ï¼Œå¦‚    </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~~Cassiopeia~~  </span><br></pre></td></tr></table></figure>
<p><del>Cassiopeia</del>  </p>
<h2 id="ä¸‹åˆ’çº¿"><a href="#ä¸‹åˆ’çº¿" class="headerlink" title="ä¸‹åˆ’çº¿"></a>ä¸‹åˆ’çº¿</h2><p>mdå’ŒHTMLè¯­æ³•å…¼å®¹ï¼Œå¯ä»¥é€šè¿‡HTMLçš„æ ‡ç­¾æ¥å®ç°æ•ˆæœï¼Œå¦‚ä¸‹ï¼š   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;u&gt;ä¸‹åˆ’çº¿&lt;\u&gt;  </span><br></pre></td></tr></table></figure>
<p><u>ä¸‹åˆ’çº¿</u>  </p>
<h2 id="è„šæ³¨"><a href="#è„šæ³¨" class="headerlink" title="è„šæ³¨"></a>è„šæ³¨</h2><p>è„šæ³¨æ˜¯å¯¹æ–‡æœ¬çš„è¡¥å……è¯´æ˜ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š    </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">éœ€è¦æ·»åŠ è„šæ³¨çš„æ–‡å­— [^tag]ã€‚  </span><br><span class="line">[^tag]: Rancho is a handsome boy!  </span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ·»åŠ è„šæ³¨çš„æ–‡å­— [^tag]ã€‚<br>[^tag]: Rancho is a handsome boy!<br>è¿™é‡Œè„šæ³¨æ˜¾ç¤ºä¸æˆåŠŸï¼Œä¸çŸ¥é“åŸå› ï¼Œåœ¨æœ‰é“äº‘é‡Œé¢çœŸè¯šã€‚    </p>
<h2 id="Markdownåˆ—è¡¨"><a href="#Markdownåˆ—è¡¨" class="headerlink" title="Markdownåˆ—è¡¨"></a>Markdownåˆ—è¡¨</h2><p>æ— åºåˆ—è¡¨ä½¿ç”¨*ã€+ã€-ä½œä¸ºåˆ—è¡¨æ ‡è®°ã€‚<br>æœ‰åºåˆ—è¡¨ä½¿ç”¨æ•°å­—åŠ .å·æ¥è¡¨ç¤ºï¼Œå¦‚ï¼š    </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. ç¬¬ä¸€é¡¹  </span><br><span class="line">2. ç¬¬äºŒé¡¹  </span><br><span class="line">3. ç¬¬ä¸‰é¡¹  </span><br></pre></td></tr></table></figure>
<p>æ³¨æ„.å·åé¢çš„ç©ºæ ¼ã€‚    </p>
<ol>
<li>ç¬¬ä¸€é¡¹    </li>
<li>ç¬¬äºŒé¡¹    </li>
<li>ç¬¬ä¸‰é¡¹    <h3 id="åˆ—è¡¨åµŒå¥—"><a href="#åˆ—è¡¨åµŒå¥—" class="headerlink" title="åˆ—è¡¨åµŒå¥—"></a>åˆ—è¡¨åµŒå¥—</h3>åˆ—è¡¨åµŒå¥—åœ¨å­åˆ—è¡¨ä¸­çš„é€‰é¡¹æ·»åŠ å››ä¸ªç©ºæ ¼ï¼š  </li>
<li>ç¬¬ä¸€é¡¹    <ol>
<li>åµŒå¥—1  </li>
<li>åµŒå¥—2  </li>
</ol>
</li>
<li>ç¬¬äºŒé¡¹  <ol>
<li>åµŒå¥—1  </li>
<li>åµŒå¥—2    <h2 id="MarkdownåŒºå—"><a href="#MarkdownåŒºå—" class="headerlink" title="MarkdownåŒºå—"></a>MarkdownåŒºå—</h2>åœ¨æ®µè½å¼€å¤´ä½¿ç”¨&gt;ç¬¦å·ï¼Œåé¢åŠ ä¸€ä¸ªç©ºæ ¼  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; åŒºå—æµ‹è¯•1  </span><br><span class="line">&gt;&gt; åŒºå—æµ‹è¯•2  </span><br><span class="line">&gt;&gt;&gt; åŒºå—æµ‹è¯•3  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>åŒºå—æµ‹è¯•1  </p>
<blockquote>
<p>åŒºå—æµ‹è¯•2  </p>
<blockquote>
<p>åŒºå—æµ‹è¯•3  </p>
</blockquote>
</blockquote>
</blockquote>
<h2 id="Markdownä»£ç å—"><a href="#Markdownä»£ç å—" class="headerlink" title="Markdownä»£ç å—"></a>Markdownä»£ç å—</h2>ä½¿ç”¨```åŒ…è£¹ä¸€æ®µä»£ç ï¼Œå¹¶æŒ‡å®šä¸€ç§è¯­è¨€(ä¹Ÿå¯ä»¥ä¸æŒ‡å®š)<br>å¯¹äºå•è¡Œçš„ä»£ç å—ï¼Œç”¨`åŒ…è£¹å³å¯ï¼Œä»£ç å—ä¸­çš„æ•°æ®ä¸ä¼šè¢«mdè¯­æ³•æ‰€è§£é‡Šã€‚  <h2 id="Markdowné“¾æ¥"><a href="#Markdowné“¾æ¥" class="headerlink" title="Markdowné“¾æ¥"></a>Markdowné“¾æ¥</h2>ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹:    <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[é“¾æ¥åç§°](é“¾æ¥åœ°å€)    </span><br><span class="line">æˆ–è€…    </span><br><span class="line">&lt;é“¾æ¥åœ°å€&gt;  </span><br></pre></td></tr></table></figure>
å¦‚ï¼š<br>è¿™æ˜¯æˆ‘çš„Blog <a href="https://rancho333.github.io/">Rancho</a>    <h2 id="Markdownå›¾ç‰‡"><a href="#Markdownå›¾ç‰‡" class="headerlink" title="Markdownå›¾ç‰‡"></a>Markdownå›¾ç‰‡</h2>ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹:    <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![](https:&#x2F;&#x2F;rancho333.github.io&#x2F;pictures&#x2F;Rancho.png)  </span><br></pre></td></tr></table></figure>
<img src="https://rancho333.github.io/pictures/Rancho.png"><br>mdæ²¡æ³•æŒ‡å®šå›¾ç‰‡çš„é«˜åº¦ä¸å®½åº¦ï¼Œå¯ä»¥ä½¿ç”¨<code>&lt;image&gt;</code>æ ‡ç­¾  </li>
</ol>
</li>
</ol>
<p>ä½¿ç”¨èµ„æºæ–‡ä»¶å¤¹åï¼Œå°†å›¾ç‰‡èµ„æºæ”¾ç½®åœ¨å¯¹åº”çš„æ–‡ç« èµ„æºæ–‡ä»¶å¤¹é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% asset_img image_name.png image_name %&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥è°ƒç”¨å›¾ç‰‡èµ„æº</p>
<h2 id="Markdownè¡¨æ ¼"><a href="#Markdownè¡¨æ ¼" class="headerlink" title="Markdownè¡¨æ ¼"></a>Markdownè¡¨æ ¼</h2><p>mdä½¿ç”¨|æ¥åˆ†éš”ä¸åŒçš„å•å…ƒæ ¼ï¼Œä½¿ç”¨-æ¥åˆ†éš”è¡¨å¤´å’Œå…¶å®ƒè¡Œã€‚åœ¨å‡å·çš„ä¸åŒä¾§åŠ å…¥:ä»£è¡¨æ–¹å‘å¯¹é½ã€‚  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">| å·¦å¯¹é½ | å³å¯¹é½ | å±…ä¸­å¯¹é½ |  </span><br><span class="line">| :---- | ----: | :-----:  |  </span><br><span class="line">| å•å…ƒæ ¼ | å•å…ƒæ ¼ | å•å…ƒæ ¼ |  </span><br><span class="line">| å•å…ƒæ ¼ | å•å…ƒæ ¼ | å•å…ƒæ ¼ |  </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">å·¦å¯¹é½</th>
<th align="right">å³å¯¹é½</th>
<th align="center">å±…ä¸­å¯¹é½</th>
</tr>
</thead>
<tbody><tr>
<td align="left">å•å…ƒæ ¼</td>
<td align="right">å•å…ƒæ ¼</td>
<td align="center">å•å…ƒæ ¼</td>
</tr>
<tr>
<td align="left">å•å…ƒæ ¼</td>
<td align="right">å•å…ƒæ ¼</td>
<td align="center">å•å…ƒæ ¼</td>
</tr>
</tbody></table>
<hr>
<h2 id="Markdoené«˜çº§æŠ€å·§"><a href="#Markdoené«˜çº§æŠ€å·§" class="headerlink" title="Markdoené«˜çº§æŠ€å·§"></a>Markdoené«˜çº§æŠ€å·§</h2><h3 id="æ”¯æŒHTMLå…ƒç´ "><a href="#æ”¯æŒHTMLå…ƒç´ " class="headerlink" title="æ”¯æŒHTMLå…ƒç´ "></a>æ”¯æŒHTMLå…ƒç´ </h3><p>ä¸åœ¨mdè¦†ç›–èŒƒå›´ä¹‹å†…çš„æ ‡ç­¾ï¼Œå¯ä»¥ä½¿ç”¨HTMLçš„æ ‡ç­¾ï¼Œå¦‚<code>&lt;kbd&gt; &lt;b&gt; &lt;i&gt; &lt;em&gt; &lt;sup&gt; &lt;sub&gt; &lt;br&gt;</code><br>ä½¿ç”¨<kbd>Ctrl</kbd>+<kbd>Alt<kbd>+<kbd>Del</kbd>é‡å¯ç”µè„‘  </p>
<h3 id="è½¬ä¹‰"><a href="#è½¬ä¹‰" class="headerlink" title="è½¬ä¹‰"></a>è½¬ä¹‰</h3><p>mdä½¿ç”¨å¾ˆå¤šç‰¹æ®Šç¬¦å·è¡¨ç¤ºç‰¹å®šçš„æ„ä¹‰ï¼Œå¦‚æœéœ€è¦æ˜¾ç¤ºè¿™äº›ç‰¹å®šçš„ç¬¦å·éœ€è¦å€ŸåŠ©è½¬ä¹‰å­—ç¬¦ï¼Œå³åæ–œæ .ç”¨ä»£ç å—ä¹Ÿèƒ½å¾—åˆ°ç›¸åŒçš„æ•ˆæœã€‚  </p>
<h3 id="å…¬å¼"><a href="#å…¬å¼" class="headerlink" title="å…¬å¼"></a>å…¬å¼</h3><p>æ•°å­¦ä¸å¥½ï¼Œçœ‹ç€å¤´ç–¼ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼^-^ </p>
<h2 id="è‡ªåŠ¨ç”Ÿè¾°ç›®å½•"><a href="#è‡ªåŠ¨ç”Ÿè¾°ç›®å½•" class="headerlink" title="è‡ªåŠ¨ç”Ÿè¾°ç›®å½•"></a>è‡ªåŠ¨ç”Ÿè¾°ç›®å½•</h2><p>linuxä¸Šå®‰è£…<code>doctoc</code>å¯ä»¥æ ¹æ®mdçš„æ ‡é¢˜è‡ªåŠ¨ç”Ÿæˆç›®å½•, ä½¿ç”¨æ–¹æ³•ä¸º<code>doctoc file.md</code></p>
<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong><br><a href="https://www.runoob.com/markdown/md-tutorial.html">èœé¸Ÿæ•™ç¨‹</a> </p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>OSPFå­¦ä¹ </title>
    <url>/2021/04/19/OSPF%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>è·Ÿç€ä¸Šæ–‡<a href="https://rancho333.github.io/2021/04/08/SONiC%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E7%AE%80%E8%BF%B0/">SONiCè·¯ç”±åè®®ç®€è¿°</a>, è¿™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹OSPFåè®®çš„å­¦ä¹ å†…å®¹ã€‚</p>
<span id="more"></span>

<p>è¿™ç¯‡æ–‡æ¡£åº”å½“å›ç­”ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li>ä»€ä¹ˆæ˜¯Router ID? æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆè¦åˆ’åˆ†åŒºåŸŸï¼Ÿä¸ºä½•éœ€è¦éª¨å¹²åŒºåŸŸï¼Ÿæ€æ ·åˆç†åˆ’åˆ†åŒºåŸŸï¼Ÿ</li>
<li>costå€¼æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</li>
<li>LSAæè¿°çš„ç½‘ç»œç±»å‹æœ‰å“ªäº›ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆè¦é€‰ä¸¾DR/BDR? å®ƒä»¬æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</li>
</ol>
<h2 id="OSPFæ¦‚è¿°"><a href="#OSPFæ¦‚è¿°" class="headerlink" title="OSPFæ¦‚è¿°"></a>OSPFæ¦‚è¿°</h2><p>TCP/IPåè®®ä¸­ï¼Œå¯»æ‰¾ä¸€å°è®¡ç®—æœºåˆ°å¦ä¸€å°è®¡ç®—çš„è·¯ç”±æ—¶å¾ˆé‡è¦çš„ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªè€ƒé‡ï¼š</p>
<ol>
<li>è¦åˆ¤æ–­æ˜¯å¦èƒ½æ‰¾åˆ°è·¯ç”±</li>
<li>æ‰¾åˆ°è·¯ç”±åæ‰¾ä¸€æ¡æœ€çŸ­çš„è·¯ï¼ˆèŠ±è´¹æœ€å°ï¼‰</li>
<li>ä¸èƒ½è‡ªç¯</li>
<li>èƒ½åŠ¨æ€å¤„ç†è·¯ç”±çš„å˜åŒ–</li>
</ol>
<p>OSPF(open shortest path firstï¼Œå¼€æ”¾æœ€çŸ­è·¯å¾„ä¼˜å…ˆ)æ˜¯ä¸€ç§åŸºäºé“¾è·¯çŠ¶æ€çš„åŠ¨æ€è·¯ç”±åè®®, æœ€æ–°çš„RFCæ˜¯2328ï¼Œåè®®çš„åŸºæœ¬æ€è·¯å¦‚ä¸‹ï¼šåœ¨ASä¸­æ¯ä¸€å°è¿è¡ŒOSPFçš„è·¯ç”±å™¨æ”¶é›†<em>å„è‡ªçš„æ¥å£/é‚»æ¥ä¿¡æ¯</em>ç§°ä¸ºé“¾è·¯çŠ¶æ€ï¼Œé€šè¿‡Floodingç®—æ³•åœ¨æ•´ä¸ªç³»ç»Ÿå¹¿æ’­è‡ªå·±çš„é“¾è·¯çŠ¶æ€ï¼Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªåŒæ­¥LSDBï¼Œæ ¹æ®è¿™ä¸€æ•°æ®åº“ï¼Œè·¯ç”±å™¨è®¡ç®—å‡ºä»¥è‡ªå·±ä¸ºæ ¹ï¼Œå…¶å®ƒç½‘ç»œèŠ‚ç‚¹ä¸ºå¶çš„ä¸€æ ¹æœ€çŸ­è·¯å¾„æ ‘ï¼Œä»è€Œè®¡ç®—å‡ºè‡ªå·±åˆ°è¾¾ç³»ç»Ÿå†…éƒ¨å¯è¾¾çš„æœ€ä½³è·¯ç”±ã€‚</p>
<p>ç›¸è¾ƒäºRIPå‘¨æœŸæ€§çš„æ´ªæ³›è‡ªå·±çš„è·¯ç”±è¡¨ï¼Œæ— æ³•äº†è§£ç½‘ç»œçš„æ‹“æ‰‘ç»“æ„ï¼Œåªæ˜¯é€šè¿‡è·¯ç”±æ›´æ–°ä»¥åŠç®€å•çš„æœºåˆ¶æ¥å­¦ä¹ è·¯ç”±(ä¾ç…§ä¼ é—»çš„æ›´æ–°)ï¼Œ OSPFäº¤äº’çš„æ˜¯é“¾è·¯çŠ¶æ€ï¼Œæ¯å°OSPFè·¯ç”±å™¨éƒ½çŸ¥æ™“ç½‘ç»œæ‹“æ‰‘ã€‚</p>
<p>ä¸€å¥è¯è¯´æ˜ospfåè®®ï¼Œ ospfå°±æ˜¯å¯»æ‰¾å»æŸä¸ªç»ˆç‚¹è®¡ç®—æœºçš„æœ€çŸ­è·¯å¾„çš„æ–¹æ³•ã€‚</p>
<h3 id="ospfåè®®åŸºæœ¬ç‰¹å¾"><a href="#ospfåè®®åŸºæœ¬ç‰¹å¾" class="headerlink" title="ospfåè®®åŸºæœ¬ç‰¹å¾"></a>ospfåè®®åŸºæœ¬ç‰¹å¾</h3><ul>
<li>é€‚åº”èŒƒå›´ â€”â€” OSPFæ”¯æŒå„ç§è§„æ¨¡çš„ç½‘ç»œï¼Œæœ€å¤šå¯ä»¥æ”¯æŒå‡ ç™¾å°è·¯ç”±å™¨</li>
<li>å¿«é€Ÿæ”¶æ•› â€”â€” å½“ç½‘è·¯æ‹“æ‰‘ç»“æ„å‘ç”Ÿå˜åŒ–ï¼ŒOSPFç«‹å³å‘é€æ›´æ–°æŠ¥æ–‡ï¼Œä½¿ä¹‹åœ¨ASä¸­åŒæ­¥</li>
<li>æ— è‡ªç¯ â€”â€” OSPFé€šè¿‡æ”¶é›†åˆ°çš„é“¾è·¯çŠ¶æ€ç”¨æœ€çŸ­è·¯å¾„æ ‘ç®—æ³•è®¡ç®—è·¯ç”±ï¼Œä»ç®—æ³•æœ¬èº«ä¿è¯äº†ä¸ä¼šç”Ÿæˆè‡ªç¯è·¯ç”±</li>
<li>å­ç½‘æ©ç  â€”â€” OSPFåœ¨æè¿°è·¯ç”±æ—¶æºå¸¦ç½‘æ®µçš„æ©ç ä¿¡æ¯ï¼Œæ‰€ä»¥OSPFåè®®ä¸å—è‡ªç„¶æ©ç çš„é™åˆ¶ï¼Œå¯¹VLSMæ”¯æŒçš„å¾ˆå¥½</li>
<li>åŒºåŸŸåˆ’åˆ† â€”â€” å…è®¸ASçš„ç½‘ç»œåˆ’åˆ†æˆåŒºåŸŸæ¥åˆ’åˆ†ï¼ŒåŒºåŸŸé—´ä¼ é€çš„è·¯ç”±ä¿¡æ¯è¢«è¿›ä¸€æ­¥æŠ½è±¡ï¼Œä»è€Œå‡å°‘äº†å ç”¨ç½‘ç»œçš„å¸¦å®½ä»¥åŠCPUçš„è®¡ç®—å‹åŠ›</li>
<li>ç­‰ä»·è·¯ç”± â€”â€” æ”¯æŒåˆ°åŒä¸€ç›®çš„åœ°å€çš„å¤šæ¡ç­‰ä»·è·¯ç”±ï¼Œè¿™äº›ç­‰ä»·è·¯ç”±ä¼šè¢«åŒæ—¶å‘ç°å’Œä½¿ç”¨</li>
<li>è·¯ç”±åˆ†çº§ â€”â€” OSPFä½¿ç”¨4ç±»ä¸åŒçš„è·¯ç”±ï¼ŒæŒ‰ä¼˜å…ˆçº§ï¼šåŒºåŸŸå†…è·¯ç”±ã€åŒºåŸŸé—´è·¯ç”±ã€ç¬¬ä¸€ç±»å¤–éƒ¨è·¯ç”±ã€ç¬¬äºŒç±»å¤–éƒ¨è·¯ç”±</li>
<li>æ”¯æŒéªŒè¯ â€”â€” æ”¯æŒåŸºäºæ¥å£çš„æŠ¥æ–‡éªŒè¯ä»¥ä¿è¯è·¯ç”±è®¡ç®—çš„å®‰å…¨æ€§</li>
<li>ç»„æ’­å‘é€ â€”â€” OSPFåœ¨æœ‰ç»„æ’­å‘é€èƒ½åŠ›çš„é“¾è·¯å±‚ä¸Šä»¥ç»„æ’­åœ°å€å‘é€åè®®æŠ¥æ–‡ï¼Œæ—¢è¾¾åˆ°äº†å¹¿æ’­çš„ä½œç”¨ï¼Œåˆæœ€å¤§ç¨‹åº¦çš„å‡å°‘äº†å¯¹å…¶å®ƒç½‘ç»œè®¾å¤‡çš„å¹²æ‰°</li>
</ul>
<h3 id="ospfç›¸å…³æœ¯è¯­"><a href="#ospfç›¸å…³æœ¯è¯­" class="headerlink" title="ospfç›¸å…³æœ¯è¯­"></a>ospfç›¸å…³æœ¯è¯­</h3><ul>
<li>RouterID æ˜¯ä¸€ä¸ª32-bitsçš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ASå†…çš„ä¸€å°è·¯ç”±å™¨ï¼ŒOSPFç›´æ¥åŸºäºIPï¼Œåè®®å·æ˜¯89,å¯¹äºRouter IDï¼š<ul>
<li>Router IDä¸€èˆ¬éœ€è¦æ‰‹å·¥é…ç½®</li>
<li>å¦‚æœæ²¡æœ‰é…ç½®ï¼Œé¦–å…ˆé€‰å–æœ€å¤§çš„loopbackæ¥å£åœ°å€ï¼Œå…¶æ¬¡é€‰æ‹©æœ€å¤§çš„ç‰©ç†æ¥å£åœ°å€</li>
<li>å¦‚æœä¸€å°è·¯ç”±å™¨çš„Router IDåœ¨è¿è¡Œä¸­æ”¹å˜ï¼Œåˆ™å¿…é¡»é‡å¯OSPFåè®®æˆ–é‡å¯è·¯ç”±å™¨æ‰èƒ½ä½¿æ–°çš„Router IDç”Ÿæ•ˆ</li>
</ul>
</li>
<li>AreaåŒºåŸŸ åŒºåŸŸå·æ˜¯ä¸€ä¸ª32bitsçš„æ•´æ•°ï¼Œä¸€èˆ¬ç”¨åè¿›åˆ¶æ•´æ•°æ¥æ ‡è¯†<br>  ospfå¼•å…¥åŒºåŸŸçš„æ¦‚å¿µæ˜¯ä¸ºäº†éš”ç¦»å’ŒåŒºåˆ†ASå†…çš„å„éƒ¨åˆ†ï¼Œå¹¶ç”±æ­¤å‡å°‘è·¯ç”±å™¨å¿…é¡»ç»´æŠ¤çš„æ•´ä¸ªASçš„ä¿¡æ¯é‡ï¼ˆCPUè®¡ç®—å’Œçº¿è·¯ä¼ è¾“ï¼‰ã€‚OSPFä½¿ç”¨Areaå®ç°äº†åˆ†å±‚â€”â€”ä¸¤å±‚æ¨¡å¼ï¼Œå³transit areaå’Œregular areasã€‚transit area(backbone æˆ– area 0)è´Ÿè´£çš„ä¸»è¦åŠŸèƒ½æ˜¯IPåŒ…å¿«é€Ÿå’Œæœ‰æ•ˆçš„ä¼ è¾“ï¼Œäº’è”OSPFå…¶å®ƒåŒºåŸŸç±»å‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œregular areaä¸å…è®¸å…¶ä»–åŒºåŸŸçš„æµé‡é€šè¿‡å®ƒåˆ°è¾¾å¦å¤–ä¸€ä¸ªåŒºåŸŸï¼Œå¿…é¡»ç©¿è¶Štransit areaã€‚regular areasè¿˜å¯æœ‰å¾ˆå¤šå­ç±»å‹ï¼Œå¦‚stub areaï¼Œnot-so-stubby areaã€‚<ul>
<li>ABR(area border router) è¿æ¥ä¸åŒçš„areaï¼ŒåŒºåŸŸä¹‹é—´é€šè¿‡ABRå°†ä¸€ä¸ªåŒºåŸŸå†…çš„å·²è®¡ç®—å‡ºçš„è·¯ç”±å°è£…æˆType3ç±»çš„LSAå‘é€åˆ°å¦ä¸€ä¸ªåŒºåŸŸæ¥ä¼ é€’è·¯ç”±ä¿¡æ¯ã€‚æ­¤æ—¶LSAä¸­åŒ…å«çš„ä¸å†æ˜¯é“¾è·¯çŠ¶æ€ä¿¡æ¯ï¼Œè€Œæ˜¯çº¯ç²¹çš„è·¯ç”±ä¿¡æ¯ã€‚æˆ–è€…è¯´ï¼Œæ­¤æ—¶çš„OSPFæ˜¯åŸºäºD-Vç®—æ³•è€Œä¸æ˜¯é“¾è·¯çŠ¶æ€ç®—æ³•ã€‚D-Vç®—æ³•æ— æ³•ä¿è¯æ¶ˆé™¤è·¯ç”±è‡ªç¯ï¼Œ<em>è‡ªç¯äº§ç”Ÿçš„ä¸»è¦æ˜¯</em>å› ä¸ºç”Ÿæˆè¯¥æ¡è·¯ç”±ä¿¡æ¯çš„è·¯ç”±å™¨æ²¡æœ‰åŠ å…¥ç”Ÿæˆè€…çš„ä¿¡æ¯ï¼Œå³æ¯ä¸€æ¡è·¯ç”±ä¿¡æ¯éƒ½æ— æ³•çŸ¥é“æœ€åˆæ˜¯ç”±è°æ‰€ç”Ÿæˆã€‚OSPFåè®®åœ¨ç”ŸæˆLSAæ—¶é¦–å…ˆå°†è‡ªå·±çš„Router IDåŠ å…¥åˆ°LSAä¸­ï¼Œä½†æ˜¯å¦‚æœè¯¥è·¯ç”±ä¿¡æ¯ä¼ é€’è¶…è¿‡ä¸¤ä¸ªåŒºåŸŸåï¼Œå°±ä¼šä¸§å¤±æœ€åˆçš„ç”Ÿæˆè€…ä¿¡æ¯ã€‚<br>  è§£å†³æ–¹æ³•æ˜¯ï¼šæ‰€æœ‰ABRå°†æœ¬åŒºåŸŸå†…çš„è·¯ç”±ä¿¡æ¯å°è£…æˆLSAï¼Œç»Ÿä¸€çš„å‘é€ç»™ä¸€ä¸ªç‰¹å®šçš„åŒºåŸŸï¼Œå†ç”±è¯¥åŒºåŸŸå°†è¿™äº›ä¿¡æ¯è½¬å‘ç»™å…¶å®ƒåŒºåŸŸã€‚åœ¨è¿™ä¸ªç‰¹å®šåŒºåŸŸå†…ï¼Œæ¯ä¸€æ¡LSAéƒ½ç¡®å®šçš„çŸ¥é“ç”Ÿæˆè€…ä¿¡æ¯ã€‚åœ¨å…¶å®ƒåŒºåŸŸå†…æ‰€æœ‰çš„åˆ°åŒºåŸŸå¤–çš„è·¯ç”±éƒ½ä¼šå‘é€åˆ°è¿™ä¸ªç‰¹å®šåŒºåŸŸä¸­ï¼Œæ‰€ä»¥å°±ä¸ä¼šäº§ç”Ÿè‡ªç¯ã€‚</li>
<li>ASBR(autonomous system border router)ï¼šä¸€ä¸ªOSPFè·¯ç”±å™¨ï¼Œä½†å®ƒè¿æ¥åˆ°å¦ä¸€ä¸ªASï¼Œæˆ–è€…åœ¨åŒä¸€ä¸ªASçš„ç½‘ç»œåŒºåŸŸä¸­ï¼Œä½†è¿è¡Œä¸åŒäºOSPFçš„IGP </li>
</ul>
</li>
<li>costå€¼ OSPFé€‰æ‹©è·¯å¾„æ˜¯ä¾é æ•´ä¸ªé“¾è·¯costå€¼çš„æ€»å’Œã€‚è®¡ç®—æ–¹æ³•æ˜¯ï¼š10^8/é“¾è·¯å¸¦å®½ã€‚è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚ç¼ºçœæƒ…å†µä¸‹ï¼Œæ¥å£æŒ‰ç…§å½“å‰çš„æ³¢ç‰¹ç‡è‡ªåŠ¨è®¡ç®—æ¥å£è¿è¡ŒOSPFåè®®æ‰€éœ€çš„å¼€é”€ã€‚</li>
<li>DR/BDRï¼šå¦‚æœç½‘ç»œä¸Šæœ‰Nå°è·¯ç”±å™¨ï¼Œéœ€è¦å»ºç«‹n*(n-1)/2ä¸ªé‚»æ¥å…³ç³»ï¼Œä½¿ç”¨DR(designated router)æ¥è¿›è¡Œä¿¡æ¯ä¼ é€’ï¼Œæ‰€æœ‰è·¯ç”±å™¨éƒ½åªå°†è·¯ç”±ä¿¡æ¯å‘é€ç»™DRå’ŒBDRï¼Œå†ç”±DRå°†è·¯ç”±ä¿¡æ¯å‘é€ç»™æœ¬ç½‘æ®µå†…å…¶å®ƒè·¯ç”±å™¨ï¼Œè¿™æ ·åªéœ€è¦å»ºç«‹(n-2)*2+1ä¸ªé‚»æ¥å…³ç³»ã€‚é€šè¿‡helloæŠ¥æ–‡è¿›è¡Œé€‰ä¸¾ï¼Œpriorityå¤§äº0çš„è¿›è¡Œé€‰ä¸¾ï¼Œpriorityä¸€æ ·ï¼Œrouter IDå¤§çš„å½“é€‰ã€‚DRä¸å¯è¢«æŠ¢å ï¼Œé™¤éå¤±æ•ˆï¼Œå¤±æ•ˆåBDRæ¥æ›¿æˆä¸ºDRï¼ŒåŒæ—¶é€‰ä¸¾å‡ºæ–°çš„BDRã€‚DRæ˜¯æŸä¸ªç½‘æ®µä¸­æ¦‚å¿µï¼Œæ˜¯é’ˆå¯¹è·¯ç”±å™¨çš„æ¥å£è€Œè¨€çš„ã€‚ä¸¤å°DROtherè·¯ç”±å™¨ä¹‹é—´ä¸è¿›è¡Œè·¯ç”±ä¿¡æ¯çš„äº¤æ¢ï¼Œä½†ä»äº’ç›¸å‘é€HELLOæŠ¥æ–‡ï¼Œä»–ä»¬ä¹‹é—´çš„é‚»å±…çŠ¶æ€æœºåœç•™åœ¨2-WayçŠ¶æ€ã€‚</li>
</ul>
<h3 id="OSPFç½‘ç»œç±»å‹"><a href="#OSPFç½‘ç»œç±»å‹" class="headerlink" title="OSPFç½‘ç»œç±»å‹"></a>OSPFç½‘ç»œç±»å‹</h3><p>æ ¹æ®é“¾è·¯å±‚åè®®ç±»å‹ï¼ŒOSPFå°†ç½‘ç»œåˆ†ä¸ºå››ç§ç±»å‹ï¼š</p>
<ol>
<li>broadcastï¼šé“¾è·¯å±‚åè®®æ˜¯Ethernetã€FDDIã€Token Ring,ä»¥ç»„æ’­çš„æ–¹å¼å‘é€åè®®æŠ¥æ–‡ï¼Œé€‰ä¸¾DR/BDR.</li>
<li>NBMA(Non broadcast multiaccess):é“¾è·¯å±‚åè®®æ˜¯FRã€ATMã€HDLCæˆ–X.25ã€‚æ‰‹å·¥æŒ‡å®šé‚»å±…ã€‚</li>
<li>p2p(point-to-point)ï¼šé“¾è·¯å±‚åè®®æ˜¯PPPæˆ–LAPB</li>
<li>p2mp(point-to-multipoint):æ²¡æœ‰ä¸€ç§é“¾è·¯å±‚åè®®ä¼šè¢«ç¼ºçœçš„è®¤ä¸ºæ˜¯p2mpç±»å‹ï¼Œp2mpå¿…ç„¶æ˜¯ç”±å…¶å®ƒç½‘ç»œç±»å‹å¼ºåˆ¶æ›´æ”¹çš„ï¼Œå¸¸è§çš„åšæ³•æ˜¯å°†éå…¨è”é€šçš„NBMAæ”¹ä¸ºç‚¹åˆ°å¤šç‚¹çš„ç½‘ç»œã€‚<br>ç”±äºç°åœ¨é“¾è·¯å±‚åè®®ä¸€èˆ¬å°±æ˜¯Ethernetï¼Œæ‰€ä»¥å…¶å®ƒç±»å‹åªåšä¸€ä¸ªç®€å•äº†è§£ã€‚</li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="http://www.h3c.com/cn/d_200805/605874_30003_0.htm">OSPFæŠ€æœ¯ä»‹ç»</a><br><a href="http://ccietea.com/Folder_TechNotes/OSPF.pdf">OSPFç¬”è®°</a></p>
]]></content>
      <tags>
        <tag>é€šä¿¡åè®®</tag>
      </tags>
  </entry>
  <entry>
    <title>PVLANæµ…æ</title>
    <url>/2022/10/12/PVLAN%E6%B5%85%E6%9E%90/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>Vlané‡Œé¢æœ‰ä¸¤ä¸ªå¸¸è§çš„æ¦‚å¿µï¼šé€ä¼ ä¸ç»ˆç»“ã€‚æ‰€è°“vlané€ä¼ å°±æ˜¯æŸä¸ªvlanä¸ä»…åœ¨ä¸€å°äº¤æ¢æœºä¸Šæœ‰æ•ˆï¼Œå®ƒè¿˜è¦é€šè¿‡æŸç§æ–¹æ³•å»¶ä¼¸åˆ°åˆ«çš„ä»¥å¤ªç½‘äº¤æ¢æœºä¸Šï¼Œåœ¨åˆ«çš„è®¾å¤‡ä¸Šç…§æ ·æœ‰æ•ˆï¼Œvlané€ä¼ å¯ä»¥é€šè¿‡802.1QæŠ€æœ¯å®ç°ã€‚<br>ç»ˆç»“çš„æ„æ€ç›¸å¯¹ï¼ŒæŸä¸ªvlançš„æœ‰æ•ˆåŸŸä¸èƒ½å†å»¶ä¼¸åˆ°åˆ«çš„è®¾å¤‡ï¼Œæˆ–è€…ä¸èƒ½é€šè¿‡æŸæ¡é“¾è·¯å»¶ä¼¸åˆ°åˆ«çš„è®¾å¤‡ã€‚vlançš„ç»ˆç»“å¯ä»¥ä½¿ç”¨PVLANæŠ€æœ¯ã€‚</p>
<span id="more"></span>

<p>æœ¬æ–‡ä¸»è¦æµ…æä¸‹PVLANçš„æ¦‚å¿µä»¥åŠå®éªŒéªŒè¯ä¸‹ã€‚</p>
<h1 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h1><p>æŠŠvlanç»ˆç»“æ‰ï¼Œä¹Ÿå°±æ˜¯ç¡®å®švlançš„è¾¹ç•Œåœ¨å“ªé‡Œç»ˆæ­¢ï¼ŒpvlanæŠ€æœ¯å¯ä»¥å¾ˆå¥½çš„å®ç°è¿™ä¸ªåŠŸèƒ½ï¼ŒåŒæ—¶è¾¾åˆ°èŠ‚çœvlançš„ç›®çš„ã€‚ciscoçš„PVLANæ„æ€æ˜¯private vlanï¼Œåä¸ºçš„æ„æ€æ˜¯primary vlan. ä¸åŒå«æ³•ï¼ŒåŸºæœ¬ç›¸åŒçš„å®ç°ã€‚</p>
<p>PVLANä¸­çš„vlanåˆ†æˆä¸¤ç±»ï¼šprimary vlanå’Œsecondary vlan(å­vlan)ã€‚å®ç°äº†æ¥å…¥ç”¨æˆ·äºŒå±‚æŠ¥æ–‡çš„éš”ç¦»ï¼ŒåŒæ—¶ä¸Šå±‚äº¤æ¢æœºä¸‹å‘çš„æŠ¥æ–‡å¯ä»¥è¢«æ¯ä¸€ä¸ªç”¨æˆ·æ¥æ”¶åˆ°ï¼Œç®€åŒ–äº†é…ç½®ï¼ŒèŠ‚çœäº†vlanèµ„æºã€‚</p>
<p>æœ¬æ–‡ç”¨ä»¥ä¸‹æ‹“æ‰‘æ¥å®éªŒè¯´æ˜ï¼š<br><img src="https://rancho333.github.io/pictures/pvlan_topology.png"></p>
<p>pvlanä¸­æ€»æ˜¯ä¼šæœ‰ä¸€ä¸ªprimary vlanï¼Œprimary vlanä¸­æœ‰promiscuous portã€‚æ‰€æœ‰çš„ç«¯å£éƒ½èƒ½å’Œpromiscuous porté€šä¿¡ã€‚åœ¨primary vlanä¸­å¯ä»¥å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªsecondary vlanï¼Œsecondary vlanæœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>community vlan: community vlanä¸­çš„æˆå‘˜ç«¯å£å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œå¹¶ä¸”å¯ä»¥å’Œpromiscuous porté€šä¿¡</li>
<li>isolated vlanï¼šæˆå‘˜ç«¯å£ä¹‹é—´ä¸èƒ½é€šä¿¡ï¼Œä½†æ˜¯å¯ä»¥å’Œpromiscuous porté€šä¿¡ã€‚</li>
</ul>
<p>secondary vlanå§‹ç»ˆå¯ä»¥å’Œpromiscuous porté€šä¿¡ï¼Œä½†æ˜¯ä¸åŒçš„secondary vlanä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚</p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>å®éªŒæ‹“æ‰‘å¦‚ä¸Šæ‰€ç¤ºã€‚åšä¸€äº›ç®€å•è¯´æ˜ï¼š</p>
<ul>
<li>primary vlançš„æ•°å€¼æ˜¯100</li>
<li>secondary community vlançš„æ•°å€¼æ˜¯101</li>
<li>secondary isolated vlançš„æ•°å€¼æ˜¯102</li>
<li>vpc3å’Œvpc4åœ¨community vlanä¸­å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œå¹¶ä¸”å¯ä»¥å’Œè¿æ¥åˆ°promiscuous portçš„vpc2é€šä¿¡</li>
<li>vpc5å’Œvpc6åœ¨isolated vlanä¸­åªèƒ½å’Œvpc2é€šä¿¡</li>
<li>vpc2å¯ä»¥å’Œæ‰€æœ‰å…¶å®ƒvpcé€šä¿¡</li>
</ul>
<p>æ¥ä¸‹æ¥å°±æ˜¯é…ç½®äº†ã€‚</p>
<p>é¦–å…ˆåˆ›å»ºprimary vlanå’Œsecondary vlanã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S(config)#vtp mode off                  &#x2F;&#x2F; é¦–å…ˆå…³é—­vtpï¼Œåªæœ‰vtpv3æ”¯æŒpvlanï¼Œå¹²è„†å…³æ‰å…å¾—å¤æ‚</span><br><span class="line">Setting device to VTP Off mode for VLANS.</span><br><span class="line"></span><br><span class="line">S(config)#vlan 100              </span><br><span class="line">S(config-vlan)#private-vlan primary             &#x2F;&#x2F; åˆ›å»ºprimary vlan</span><br><span class="line">S(config-vlan)#private-vlan association add 101     &#x2F;&#x2F; ä¸secondary vlanå…³è”</span><br><span class="line">S(config-vlan)#private-vlan association add 102</span><br><span class="line"></span><br><span class="line">S(config)#vlan 101</span><br><span class="line">S(config-vlan)#private-vlan community           &#x2F;&#x2F; åˆ›å»ºsecondary community vlan</span><br><span class="line"></span><br><span class="line">S(config)#vlan 102</span><br><span class="line">S(config-vlan)#private-vlan isolated            &#x2F;&#x2F; åˆ›å»ºsecondary isolated vlan</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥é…ç½®æ¥å£æ‰€å±çš„vlan.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S(config)#interface range ethernet 0&#x2F;1-2        &#x2F;&#x2F; community vlanæ‰€å±çš„ä¸¤ä¸ªç«¯å£, å±äºCV 101</span><br><span class="line">S(config-if-range)#switchport mode private-vlan host    &#x2F;&#x2F; æŒ‡æ˜è¿™äº›ç«¯å£æ˜¯ä¸»æœºç«¯å£ï¼Œç±»ä¼¼äºaccess port</span><br><span class="line">S(config-if-range)#switchport private-vlan host-association 100 101     &#x2F;&#x2F; æŒ‡æ˜ç«¯å£æ‰€å±çš„primary vlanæ˜¯100ï¼Œsecondary vlanæ˜¯101</span><br><span class="line"></span><br><span class="line">S(config)#interface ethernet 0&#x2F;0</span><br><span class="line">S(config-if)#switchport mode private-vlan promiscuous           &#x2F;&#x2F; æŒ‡æ˜è¯¥ç«¯å£æ˜¯promiscuous port</span><br><span class="line">S(config-if)#switchport private-vlan mapping 100 101            &#x2F;&#x2F; å°†primary vlanä¸secondary vlanæ˜ å°„</span><br><span class="line"></span><br><span class="line">S(config)#interface ethernet 0&#x2F;3 </span><br><span class="line">S(config)#interface ethernet 1&#x2F;0       </span><br><span class="line">S(config-if)#switchport mode private-vlan host      &#x2F;&#x2F; é…ç½®ç«¯å£å±äºsecondary isolated vlan</span><br><span class="line">S(config-if)#switchport private-vlan host-association 100 102</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ä¸‹é…ç½®çš„çŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; å¯¹äºpromiscuous port</span><br><span class="line">S#show interfaces ethernet 0&#x2F;0 switchport | include mapping     </span><br><span class="line">Administrative private-vlan mapping: 100 (VLAN0100) 101 (VLAN0101) 102 (VLAN0102)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¯¹äºhostç«¯å£</span><br><span class="line">S#show interfaces ethernet 0&#x2F;1 switchport | include host-association</span><br><span class="line">Administrative private-vlan host-association: 100 (VLAN0100) 101 (VLAN0101) </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¯¹äºisolatedç«¯å£</span><br><span class="line">S#show interfaces ethernet 0&#x2F;3 switchport | include host-association</span><br><span class="line">Administrative private-vlan host-association: 100 (VLAN0100) 102 (VLAN0102)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æŸ¥çœ‹primary vlanå’Œsecondary vlanï¼Œä»¥åŠsecondaryçš„ç±»å‹</span><br><span class="line">S#show vlan private-vlan </span><br><span class="line"></span><br><span class="line">Primary Secondary Type              Ports</span><br><span class="line">------- --------- ----------------- ------------------------------------------</span><br><span class="line">100     101       community         Et0&#x2F;0, Et0&#x2F;1, Et0&#x2F;2</span><br><span class="line">100     102       isolated          Et0&#x2F;3, Et1&#x2F;0</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥pingæµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; å¯¹äºcommunity vlançš„æˆå‘˜</span><br><span class="line">vpc3&gt; ping  192.168.1.2 -c 1            &#x2F;&#x2F; å¯ä»¥pingé€špromiscuous port</span><br><span class="line"></span><br><span class="line">84 bytes from 192.168.1.2 icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;1.775 ms</span><br><span class="line"></span><br><span class="line">vpc3&gt; ping  192.168.1.4 -c 1            &#x2F;&#x2F; å¯ä»¥pingé€šåŒsecondary communityçš„æˆå‘˜</span><br><span class="line"></span><br><span class="line">84 bytes from 192.168.1.4 icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;1.159 ms</span><br><span class="line"></span><br><span class="line">vpc3&gt; ping  192.168.1.5 -c 1        &#x2F;&#x2F; ä¸èƒ½pingé€šå…¶å®ƒsecondary vlançš„æˆå‘˜</span><br><span class="line"></span><br><span class="line">host (192.168.1.5) not reachable</span><br></pre></td></tr></table></figure>
<p>vpc2åŒæ ·å¯ä»¥pingé€švpc3å’Œvpc4ï¼Œè¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; å¯¹äºisolated vlançš„æˆå‘˜</span><br><span class="line">vpc5&gt; ping 192.168.1.6 -c 1         &#x2F;&#x2F; ä¸èƒ½pingé€šåŒvlançš„å…¶å®ƒæˆå‘˜</span><br><span class="line"></span><br><span class="line">host (192.168.1.6) not reachable</span><br><span class="line"></span><br><span class="line">vpc5&gt; ping 192.168.1.2 -c 1     &#x2F;&#x2F; å¯ä»¥pingé€špromiscuous port</span><br><span class="line"></span><br><span class="line">84 bytes from 192.168.1.2 icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.815 ms</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; promiscuous portåˆ™å¯ä»¥pingé€šisolated vlanå†…çš„æ‰€æœ‰æˆå‘˜</span><br><span class="line">vpc2&gt; ping 192.168.1.5 -c 1</span><br><span class="line"></span><br><span class="line">84 bytes from 192.168.1.5 icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;1.050 ms</span><br><span class="line"></span><br><span class="line">vpc2&gt; ping 192.168.1.6 -c 1</span><br><span class="line"></span><br><span class="line">84 bytes from 192.168.1.6 icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.475 ms</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹ï¼š<br>pvlançš„å®ç°ï¼š</p>
<ol>
<li>ä¸€å®šå­˜åœ¨ä¸€ä¸ªprimary vlan, é‡Œé¢æœ‰ä¸€ä¸ªç«¯å£promiscuous portåˆ™å¯ä»¥pingé€šisolated</li>
<li>å¯ä»¥å­˜åœ¨å¤šä¸ªsecondary vlanï¼Œsecondary vlanä¹‹é—´ä¸èƒ½é€šä¿¡ï¼Œä½†éƒ½å¯ä¸promiscuous porté€šä¿¡</li>
<li>secondary vlanåˆ†ä¸ºcommunity vlanå’Œisolated vlanä¸secondary<ul>
<li>community vlanæˆå‘˜ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡</li>
<li>isolated vlanæˆå‘˜ä¹‹é—´ä¸èƒ½ç›¸äº’é€šä¿¡</li>
<li>æ‰€æœ‰secondary vlanæˆå‘˜éƒ½èƒ½ä¸promiscuous porté€šä¿¡</li>
</ul>
</li>
<li>pvlanä½œç”¨åŸŸå¯ä»¥å»¶ä¼¸åˆ°å…¶å®ƒäº¤æ¢æœºï¼Œä½†æ˜¯è¦ä¿è¯äº¤æ¢æœºä¹‹é—´çš„é“¾è·¯æ˜¯trunkï¼Œå¹¶å…è®¸primary vlanå’Œsecondary vlané€šè¿‡ </li>
<li>ä¸Šè¡Œè®¾å¤‡åªå…³å¿ƒprimary vlanè€Œä¸ä¼šæ„ŸçŸ¥secondary vlanï¼Œä»è€ŒèŠ‚çœvlanèµ„æº</li>
</ol>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="http://www.h3c.com/cn/d_201505/868804_30003_0.htm">PVLANæŠ€æœ¯ç™½çš®ä¹¦</a></p>
]]></content>
  </entry>
  <entry>
    <title>Questone2A_25G_line_rate_test</title>
    <url>/2023/03/27/Questone2A_25G_line_rate_test/</url>
    <content><![CDATA[<h1 id="environment-description"><a href="#environment-description" class="headerlink" title="environment description"></a>environment description</h1><p>The experimental topology is shown in the figure:</p>
<p><img src="https://rancho333.github.io/pictures/questone2a_25G_topology.png"></p>
<span id="more"></span>

<p>We only need add one ixia 100G port to topology, and set the line rate of 25 percent to test Questone2A 25G ports.<br><img src="https://rancho333.github.io/pictures/questone2a_25G_ixia_topology.png"></p>
<p>For Questone2A, follow the below cmds to set up test enviorments.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vlan clear              	</span><br><span class="line">vlan remove 1 pbm&#x3D;ce       </span><br><span class="line">vlan remove 1 pbm&#x3D;xe </span><br><span class="line"></span><br><span class="line">vlan create 103 pbm&#x3D;xe0,ce0 ubm&#x3D;xe0,ce0; pvlan set xe0,ce0 103</span><br><span class="line">vlan create 100 pbm&#x3D;xe1,xe2 ubm&#x3D;xe1,xe2; pvlan set xe1,xe2 100</span><br><span class="line">vlan create 101 pbm&#x3D;xe3,xe4 ubm&#x3D;xe3,xe4; pvlan set xe3,xe4 101</span><br><span class="line">vlan create 102 pbm&#x3D;xe5,xe6 ubm&#x3D;xe5,xe6; pvlan set xe5,xe6 102</span><br><span class="line">vlan create 104 pbm&#x3D;xe7,ce0 ubm&#x3D;xe7,ce0; pvlan set xe7,ce0 104</span><br></pre></td></tr></table></figure>

<p>We test three different(20,25,30) line rate speed, and expect no packets loss when line rate under 25 percent.</p>
<p>We use default preemphasis and differnet FEC setting to test line rate of 25G port.</p>
<h2 id="FEC-fc"><a href="#FEC-fc" class="headerlink" title="FEC fc"></a>FEC fc</h2><p>For fec mode of fcï¼Œports status show as below picture.<br><img src="https://rancho333.github.io/pictures/questone2a_25g_fec_fc.png"></p>
<h3 id="Line-rate-20-percent"><a href="#Line-rate-20-percent" class="headerlink" title="Line rate 20 percent"></a>Line rate 20 percent</h3><p>Just set line rate 20 percent on ixia like below picture.<br><img src="https://rancho333.github.io/pictures/questone2a_line_rate_20.png"></p>
<p>Test results show as below picture and meet expectations.<br><img src="https://rancho333.github.io/pictures/questone2a_line_rate_20_result.png"></p>
<h3 id="Line-rate-25-percent"><a href="#Line-rate-25-percent" class="headerlink" title="Line rate 25 percent"></a>Line rate 25 percent</h3><p>Test results show as below picture and meet expectations.<br><img src="https://rancho333.github.io/pictures/questone2a_line_rate_25.png"></p>
<h3 id="Line-rate-30-percent"><a href="#Line-rate-30-percent" class="headerlink" title="Line rate 30 percent"></a>Line rate 30 percent</h3><p>Test results show as below picture and packets loss.<br><img src="https://rancho333.github.io/pictures/questone2a_line_rate_30.png"></p>
<h2 id="Fec-none"><a href="#Fec-none" class="headerlink" title="Fec none"></a>Fec none</h2><p>For fec mode of none, ports status show as below picture.<br><img src="https://rancho333.github.io/pictures/questone2a_25_fec_none.png"></p>
<h3 id="Line-rate-20-percent-1"><a href="#Line-rate-20-percent-1" class="headerlink" title="Line rate 20 percent"></a>Line rate 20 percent</h3><p>For fec mode of none, ports status show as below picture.<br><img src="https://rancho333.github.io/pictures/questone2a_line_rate_20_none.png"></p>
<h3 id="Line-rate-25-percent-1"><a href="#Line-rate-25-percent-1" class="headerlink" title="Line rate 25 percent"></a>Line rate 25 percent</h3><p>For fec mode of none, ports status show as below picture.<br><img src="https://rancho333.github.io/pictures/questone2a_line_rate_25_none.png"></p>
<h3 id="Line-rate-30-percent-1"><a href="#Line-rate-30-percent-1" class="headerlink" title="Line rate 30 percent"></a>Line rate 30 percent</h3><p>Test results show as below picture and packets loss.<br><img src="https://rancho333.github.io/pictures/questone2a_line_rate_30_none.png"></p>
]]></content>
  </entry>
  <entry>
    <title>Questone2A_snake_traffic_test</title>
    <url>/2023/04/03/Questone2A_snake_traffic_test/</url>
    <content><![CDATA[<h1 id="environment-description"><a href="#environment-description" class="headerlink" title="environment description"></a>environment description</h1><p>The experimental topology is shown in the figure:</p>
<p><img src="https://rancho333.github.io/pictures/questone2a_100G_snake_traffic_topology.png"></p>
<span id="more"></span>

<p>After the line is connected, do some configuration on ixia to make the port up. On sonic, link training and auto negotiation are disabled by default, and FEC is enabled. Set the corresponding interface on ixia to match it.</p>
<p>Make sure the port is up:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@sonic:&#x2F;home&#x2F;admin# show interfaces status Ethernet49-56</span><br><span class="line">  Interface        Lanes    Speed    MTU    FEC    Alias    Vlan    Oper    Admin             Type    Asym PFC</span><br><span class="line">-----------  -----------  -------  -----  -----  -------  ------  ------  -------  ---------------  ----------</span><br><span class="line"> Ethernet49  41,42,43,44     100G   9100     rs   100GE1  routed      up       up  QSFP28 or later         N&#x2F;A</span><br><span class="line"> Ethernet50  45,46,47,48     100G   9100     rs   100GE2  routed      up       up  QSFP28 or later         N&#x2F;A</span><br><span class="line"> Ethernet51  73,74,75,76     100G   9100     rs   100GE3  routed      up       up          Unknown         N&#x2F;A</span><br><span class="line"> Ethernet52  77,78,79,80     100G   9100     rs   100GE4  routed      up       up  QSFP28 or later         N&#x2F;A</span><br><span class="line"> Ethernet53      1,2,3,4     100G   9100     rs   100GE5  routed      up       up  QSFP28 or later         N&#x2F;A</span><br><span class="line"> Ethernet54  21,22,23,24     100G   9100     rs   100GE6  routed      up       up  QSFP28 or later         N&#x2F;A</span><br><span class="line"> Ethernet55     5,6,7,8,     100G   9100     rs   100GE7  routed      up       up  QSFP28 or later         N&#x2F;A</span><br><span class="line"> Ethernet56  25,26,27,28     100G   9100     rs   100GE8  routed      up       up  QSFP28 or later         N&#x2F;A</span><br></pre></td></tr></table></figure>

<h1 id="snake-traffic-test-for-100G"><a href="#snake-traffic-test-for-100G" class="headerlink" title="snake traffic test for 100G"></a>snake traffic test for 100G</h1><p>The ixia eth7 port sends out Layer 2 packets, the two sonic ports are in the same vlan, and the ixia eth8 port receives packets for statistics to check whether packets are lost. Similarly, eth8 sends packets, and eth7 receives packets. In this way, the bidirectional Layer 2 wire-speed streaming test is realized. The detailed steps are as follows:</p>
<p>sonic configuration:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drivshell&gt;vlan clear</span><br><span class="line">vlan clear</span><br><span class="line">drivshell&gt;vlan remove 1 pbm&#x3D;ce</span><br><span class="line">vlan remove 1 pbm&#x3D;ce</span><br><span class="line">drivshell&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">drivshell&gt;vlan create 100 pbm&#x3D;ce1,ce2 ubm&#x3D;ce1,ce2; pvlan set ce1,ce2 100</span><br><span class="line">vlan create 101 pbm&#x3D;ce3,ce4 ubm&#x3D;ce3,ce4; pvlan set ce3,ce4 101</span><br><span class="line">vlan create 102 pbm&#x3D;ce5,ce7 ubm&#x3D;ce5,ce7; pvlan set ce5,ce7 102</span><br><span class="line">vlan create 100 pbm&#x3D;ce1,ce2 ubm&#x3D;ce1,ce2; pvlan set ce1,ce2 100</span><br><span class="line">vlan create 102 pbm&#x3D;ce5,ce7 ubm&#x3D;ce5,ce7; pvlan set ce5,ce7 102</span><br><span class="line">vlan create 103 pbm&#x3D;ce0,ce6 ubm&#x3D;ce0,ce6; pvlan set ce0,ce6 103</span><br><span class="line">drivshell&gt;vlan create 101 pbm&#x3D;ce3,ce4 ubm&#x3D;ce3,ce4; pvlan set ce3,ce4 101</span><br><span class="line">drivshell&gt;vlan create 102 pbm&#x3D;ce5,ce7 ubm&#x3D;ce5,ce7; pvlan set ce5,ce7 102</span><br><span class="line">drivshell&gt;vlan create 103 pbm&#x3D;ce0,ce6 ubm&#x3D;ce0,ce6; pvlan set ce0,ce6 103</span><br><span class="line">drivshell&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">drivshell&gt;vlan show</span><br><span class="line">vlan show</span><br><span class="line">vlan 1	ports none (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000), untagged none (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN</span><br><span class="line">vlan 100	ports ce1-ce2 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000800000400000000), untagged ce1-ce2 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000800000400000000) MCAST_FLOOD_UNKNOWN</span><br><span class="line">vlan 101	ports ce3-ce4 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000002), untagged ce3-ce4 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000002) MCAST_FLOOD_UNKNOWN</span><br><span class="line">vlan 102	ports ce5,ce7 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018000), untagged ce5,ce7 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018000) MCAST_FLOOD_UNKNOWN</span><br><span class="line">vlan 103	ports ce0,ce6 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000004), untagged ce0,ce6 (0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000004) MCAST_FLOOD_UNKNOWN</span><br><span class="line">drivshell&gt;</span><br></pre></td></tr></table></figure>


<p>Then create two Layer 2 stream:<br><img src="https://rancho333.github.io/pictures/questone2a_100G_snake_traffic_traffic.png"></p>
<p>The picture shows eth7 sending and eth8 receiving and checking. Similarly, reverse flow is created to realize bidirectional streaming test. Note that it is better to modify the source and destination MAC addresses of Layer 2 packets.</p>
<p>Final streaming test:<br><img src="https://rancho333.github.io/pictures/questone2a_snake_traffic_100G_result.png"></p>
<p>As you can seeï¼Œ no packet loss.</p>
<p>Check the packets counters in Bcmsh.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drivshell&gt;show c CLMIB_RPOK.ce</span><br><span class="line">show c CLMIB_RPOK.ce</span><br><span class="line">CLMIB_RPOK.ce0		    :	     23,803,850,505		    +13 	      1&#x2F;s</span><br><span class="line">CLMIB_RPOK.ce1		    :	     30,512,888,521		    +13 	      1&#x2F;s</span><br><span class="line">CLMIB_RPOK.ce2		    :	     23,803,849,548		     +8</span><br><span class="line">CLMIB_RPOK.ce3		    :	     30,512,889,476		     +8</span><br><span class="line">CLMIB_RPOK.ce4		    :	     23,803,848,543		    +11 	      1&#x2F;s</span><br><span class="line">CLMIB_RPOK.ce5		    :	     30,512,890,437		    +11 	      1&#x2F;s</span><br><span class="line">drivshell&gt;show c CLMIB_RFCS</span><br><span class="line">show c CLMIB_RFCS</span><br><span class="line">drivshell&gt;</span><br></pre></td></tr></table></figure>

<h1 id="snake-traffic-test-for-25G"><a href="#snake-traffic-test-for-25G" class="headerlink" title="snake traffic test for 25G"></a>snake traffic test for 25G</h1><p>Ixia donâ€™t have 25G ports, so i use 100G of ixia connet to 100G port of Questone2A and just send 25% line rate to test 25G port of Questone2A. The test environment tpology is show as below picture.<br><img src="https://rancho333.github.io/pictures/questone2a_snake_traffic_25G_topology.png"></p>
<p>sonic configuration:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drivshell&gt;vlan clear</span><br><span class="line">vlan clear</span><br><span class="line">drivshell&gt;vlan remove 1 pbm&#x3D;ce</span><br><span class="line">vlan remove 1 pbm&#x3D;ce</span><br><span class="line">drivshell&gt;vlan remove 1 pbm&#x3D;xe</span><br><span class="line">vlan remove 1 pbm&#x3D;xe</span><br><span class="line"></span><br><span class="line">drivshell&gt;vlan create 100 pbm&#x3D;xe1,xe2 ubm&#x3D;xe1,xe2; pvlan set xe1,xe2 100</span><br><span class="line">23,xe24; pvlan set xe23,xe24 111</span><br><span class="line">vlan create 112 pbm&#x3D;xe25,xe26 ubm&#x3D;xe25,xe26; pvlan set xe25,xe26 112</span><br><span class="line">vlan create 113 pbm&#x3D;xe27,xe28 ubm&#x3D;xe27,xe28; pvlan set xe27,xe28 113</span><br><span class="line">vlan create 114 pbm&#x3D;xe29,xe30 ubm&#x3D;xe29,xe30; pvlan set xe29,xe30 114</span><br><span class="line">pbm&#x3D;xe31,xe32 ubm&#x3D;xe31,xe32; pvlan set xe31,xe32 115</span><br><span class="line">vlan create 116 pbm&#x3D;xe33,xe34 ubm&#x3D;xe33,xe34; pvlan set xe33,xe34 116</span><br><span class="line">vlan create 117 pbm&#x3D;xe35,xe36 ubm&#x3D;xe35,xe36; pvlan set xe35,xe36 117</span><br><span class="line">vlan create 118 pbm&#x3D;xe37,xe38 ubm&#x3D;xe37,xe38; pvlan set xe37,xe38 vlan create 101 pbm&#x3D;xe3,xe4 ubm&#x3D;xe3,xe4; pvlan set xe3,xe4 101</span><br><span class="line">vlan create 102 pbm&#x3D;xe5,xe6 ubm&#x3D;xe5,xe6; pvlan set xe5,xe6 102</span><br><span class="line">vlan create 100 pbm&#x3D;xe1,xe2 ubm&#x3D;xe1,xe2; pvlan set xe1,xe2 100</span><br><span class="line">vlan create 101 pbm&#x3D;xe3,xe4 ubm&#x3D;xe3,xe4; pvlan set xe3,xe4 101</span><br><span class="line">vlan create 102 pbm&#x3D;xe5,xe6 ubm&#x3D;xe5,xe6; pvlan set xe5,xe6 102</span><br><span class="line">vlan create 103 pbm&#x3D;xe7,xe8 ubm&#x3D;xe7,xe8; pvlan set xe7,xe8 103</span><br><span class="line">drivshell&gt;vlan create 101 pbm&#x3D;xe3,xevlan create 104 pbm&#x3D;xe9,xe10 ubm&#x3D;xe9,xe10; pvlan set xe9,xe10 104</span><br><span class="line">4 ubm&#x3D;xe3,xe4; pvlan set xe3,xe4 101</span><br><span class="line">vlan create 104 pbm&#x3D;xe9,xe10 ubm&#x3D;xe9,xe10; pvlan set xe9,xe10 104</span><br><span class="line">vlan create 105 pbm&#x3D;xe11,xe12 ubm&#x3D;xe11,xe12; pvlan set xe11,xe12 105</span><br><span class="line">vlan create 106 pbm&#x3D;xe13,xe14 ubm&#x3D;xe13,xe14; pvlan set xe13,xe14 106</span><br><span class="line">vlan create 105 pbm&#x3D;xe11,xe12 ubm&#x3D;xe11,xe12; pvlan set xe11,xe12 105</span><br><span class="line">drivshell&gt;vlan create 102vlan create 107 pbm&#x3D;xe15,xe16 ubm&#x3D;xe15,xe16; pvlan set xe15,xe16 107</span><br><span class="line"> pbm&#x3D;xe5,xe6 ubm&#x3D;xe5,xe6; pvlan set vlan create 108 pbm&#x3D;xe17,xe18 ubm&#x3D;xe17,xe18; pvlan set xe17,xe18 108</span><br><span class="line">vlan create 109 pbm&#x3D;xe19,xe20 ubm&#x3D;xe19,xe20; pvlan set xe19,xe20 109</span><br><span class="line">xe5,xe6 102</span><br><span class="line">vlan create 108 pbm&#x3D;xe17,xe18 ubm&#x3D;xe17,xe18; pvlan set xe17,xe18 108</span><br><span class="line">drivshell&gt;vlan create 103 pbm&#x3D;xe7,xe8 ubm&#x3D;xe7,xe8; pvlan set xe7,xe8 103</span><br><span class="line">vlan create 109 pbm&#x3D;xe19,xe20 ubm&#x3D;xe19,xe20; pvlan set xe19,xe20 109</span><br><span class="line">vlan create 110 pbm&#x3D;xe21,xe22 ubm&#x3D;xe21,xe22; pvlan set xe21,xe22 110</span><br><span class="line">vlan create 111 pbm&#x3D;xe23,xe24 ubm&#x3D;xe23,xe24; pvlan set xe23,xe24 111</span><br><span class="line">vlan create 110 pbm&#x3D;xe21,xe22 ubm&#x3D;xe21,xe22; pvlan set xe21,xe22 110</span><br><span class="line">vlan create 111 pbm&#x3D;xe23,xe24 ubm&#x3D;xe23,xe24; pvlan set xe23,xe24 111</span><br><span class="line">vlan create 112 pbm&#x3D;xe25,xe26 ubm&#x3D;xe25,xe26; pvlan set xe25,xe26 112</span><br><span class="line">vlan create 113 pbm&#x3D;xe27,xe28 ubm&#x3D;xe27,xe28; pvlan set xe27,xe28 113</span><br><span class="line">drivshell&gt;vlan create 104 pbm&#x3D;xe9,xe10 ubm&#x3D;xe9,xe10; pvlan set xe9,xe10 104</span><br><span class="line">vlan create 112 pbm&#x3D;xe25,xe26 ubm&#x3D;xe25,xe26; pvlan set xe25,xe26 112</span><br><span class="line">drivshell&gt;vlan create 105 pbm&#x3D;xe11,xe12 ubm&#x3D;xe11,xe12; pvlan set xe11,xe12 105</span><br><span class="line">vlan create 113 pbm&#x3D;xe27,xe28 ubm&#x3D;xe27,xe28; pvlan set xe27,xe28 113</span><br><span class="line">vlan create 114 pbm&#x3D;xe29,xe30 ubm&#x3D;xe29,xe30; pvlan set xe29,xe30 114</span><br><span class="line">vlan create 115 pbm&#x3D;xe31,xe32 ubm&#x3D;xe31,xe32; pvlan set xe31,xe32 115</span><br><span class="line">vlan create 114 pbm&#x3D;xe29,xe30 ubm&#x3D;xe29,xe30; pvlan set xe29,xe30 114</span><br><span class="line">vlan create 115 pbm&#x3D;xe31,xe32 ubm&#x3D;xe31,xe32; pvlan set xe31,xe32 115</span><br><span class="line">vlan create 116 pbm&#x3D;xe33,xe34 ubm&#x3D;xe33,xe34; pvlan set xe33,xe34 116</span><br><span class="line">vlan create 117 pbm&#x3D;xe35,xe36 ubm&#x3D;xe35,xe36; pvlan set xe35,xe36 117</span><br><span class="line">vlan create 116 pbm&#x3D;xe33,xe34 ubm&#x3D;xe33,xe34; pvlan set xe33,xe34 116</span><br><span class="line">vlan create 117 pbm&#x3D;xe35,xe36 ubm&#x3D;xe35,xe36; pvlan set xe35,xe36 117</span><br><span class="line">vlan create 118 pbm&#x3D;xe37,xe38 ubm&#x3D;xe37,xe38; pvlan set xe37,xe38 118</span><br><span class="line">vlan create 119 pbm&#x3D;xe39,xe40 ubm&#x3D;xe39,xe40; pvlan set xe39,xe40 119</span><br><span class="line">vlan create 118 pbm&#x3D;xe37,xe38 ubm&#x3D;xe37,xe38; pvlan set xe37,xe38 118</span><br><span class="line">drivshell&gt;vlan create 106 pbm&#x3D;xe13,xe14 ubm&#x3D;xe13,xe14; pvlan set xe13,xe14 106</span><br><span class="line">vlan create 119 pbm&#x3D;xe39,xe40 ubm&#x3D;xe39,xe40; pvlan set xe39,xe40 119</span><br><span class="line">vlan create 120 pbm&#x3D;xe41,xe42 ubm&#x3D;xe41,xe42; pvlan set xe41,xe42 120</span><br><span class="line">vlan create 121 pbm&#x3D;xe43,xe44 ubm&#x3D;xe43,xe44; pvlan set xe43,xe44 121</span><br><span class="line">vlan create 120 pbm&#x3D;xe41,xe42 ubm&#x3D;xe41,xe42; pvlan set xe41,xe42 120</span><br><span class="line">drivshell&gt;vlan vlan create 122 pbm&#x3D;xe45,xe46 ubm&#x3D;xe45,xe46; pvlan set xe45,xe46 122</span><br><span class="line">create 107 pbm&#x3D;xe15,xe16 ubm&#x3D;xe15,xe16; pvlan set xe15,xe16 107</span><br><span class="line">drivshell&gt;vlan create 108 pbm&#x3D;xe17,xe18 ubm&#x3D;xe17,xe18; pvlan set xe17,xe18 108</span><br><span class="line">drivshell&gt;vlan create 109 pbm&#x3D;xe19,xe20 ubm&#x3D;xe19,xe20; pvlan set xe19,xe20 109</span><br><span class="line">vlan create 122 pbm&#x3D;xe45,xe46 ubm&#x3D;xe45,xe46; pvlan set xe45,xe46 122</span><br><span class="line">vlan create 123 pbm&#x3D;ce6,xe0 ubm&#x3D;ce6,xe0; pvlan set ce6,xe0 123</span><br><span class="line">vlan create 124 pbm&#x3D;ce7,xe47 ubm&#x3D;ce7,xe47; pvlan set ce7,xe47 124</span><br><span class="line">vlan create 123 pbm&#x3D;ce6,xe0 ubm&#x3D;ce6,xe0; pvlan set ce6,xe0 123</span><br><span class="line">drivshell&gt;vlan create 110 pbm&#x3D;xe21,xe22 ubm&#x3D;xe21,xe22; pvlan set xe21,xe22 110</span><br><span class="line">drivshell&gt;vlan create 111 pbm&#x3D;xe23,xe24 ubm&#x3D;xe23,xe24; pvlan set xe23,xe24 111</span><br><span class="line">drivshell&gt;vlan create 112 pbm&#x3D;xe25,xe26 ubm&#x3D;xe25,xe26; pvlan set xe25,xe26 112</span><br><span class="line">drivshell&gt;vlan create 113 pbm&#x3D;xe27,xe28 ubm&#x3D;xe27,xe28; pvlan set xe27,xe28 113</span><br><span class="line">drivshell&gt;vlan create 114 pbm&#x3D;xe29,xe30 ubm&#x3D;xe29,xe30; pvlan set xe29,xe30 114</span><br><span class="line">drivshell&gt;vlan create 115 pbm&#x3D;xe31,xe32 ubm&#x3D;xe31,xe32; pvlan set xe31,xe32 115</span><br><span class="line">drivshell&gt;vlan create 116 pbm&#x3D;xe33,xe34 ubm&#x3D;xe33,xe34; pvlan set xe33,xe34 116</span><br><span class="line">drivshell&gt;vlan create 117 pbm&#x3D;xe35,xe36 ubm&#x3D;xe35,xe36; pvlan set xe35,xe36 117</span><br><span class="line">drivshell&gt;vlan create 118 pbm&#x3D;xe37,xe38 ubm&#x3D;xe37,xe38; pvlan set xe37,xe38 118</span><br><span class="line">drivshell&gt;vlan create 119 pbm&#x3D;xe39,xe40 ubm&#x3D;xe39,xe40; pvlan set xe39,xe40 119</span><br><span class="line">drivshell&gt;vlan create 120 pbm&#x3D;xe41,xe42 ubm&#x3D;xe41,xe42; pvlan set xe41,xe42 120</span><br><span class="line">drivshell&gt;vlan create 121 pbm&#x3D;xe43,xe44 ubm&#x3D;xe43,xe44; pvlan set xe43,xe44 121</span><br><span class="line">drivshell&gt;vlan create 122 pbm&#x3D;xe45,xe46 ubm&#x3D;xe45,xe46; pvlan set xe45,xe46 122</span><br><span class="line">drivshell&gt;vlan create 123 pbm&#x3D;ce6,xe0 ubm&#x3D;ce6,xe0; pvlan set ce6,xe0 123</span><br><span class="line">drivshell&gt;vlan create 124 pbm&#x3D;ce7,xe47 ubm&#x3D;ce7,xe47; pvlan set ce7,xe47 124</span><br><span class="line">drivshell&gt;</span><br></pre></td></tr></table></figure>

<p>ixia is configured as follows:<br><img src="https://rancho333.github.io/pictures/questone2a_snake_traffic_25G_ixia.png"></p>
<p>Finally, start the test to check the packet loss:<br><img src="https://rancho333.github.io/pictures/questone2a_snake_traffic_25G_result.png"></p>
<p>Check the packets counters in Bcmsh.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drivshell&gt;show c CLMIB_TPKT.xe</span><br><span class="line">show c CLMIB_TPKT.xe</span><br><span class="line">CLMIB_TPKT.xe0		    :	      1,347,751,223		     +6</span><br><span class="line">CLMIB_TPKT.xe1		    :	      1,347,716,171		   +154 	      8&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe2		    :	      1,347,683,168		    +12</span><br><span class="line">CLMIB_TPKT.xe3		    :	      1,347,660,881		   +148 	      8&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe4		    :	      1,347,633,886		    +18</span><br><span class="line">CLMIB_TPKT.xe5		    :	      1,347,611,124		   +142 	      8&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe6		    :	      1,347,585,268		    +24</span><br><span class="line">CLMIB_TPKT.xe7		    :	      1,347,562,390		   +136 	      8&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe8		    :	      1,347,536,351		    +30</span><br><span class="line">CLMIB_TPKT.xe9		    :	      1,347,513,095		   +130 	      8&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe10 	    :	      1,347,486,710		    +38 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe11 	    :	      1,347,463,552		   +125 	      8&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe12 	    :	      1,347,389,466		    +45 	      2&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe13 	    :	      1,347,366,188		   +118 	      7&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe14 	    :	      1,347,341,022		    +50 	      2&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe15 	    :	      1,347,317,516		   +109 	      5&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe16 	    :	      1,347,292,618		    +57 	      3&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe17 	    :	      1,347,269,117		   +102 	      4&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe18 	    :	      1,347,243,912		    +64 	      3&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe19 	    :	      1,347,215,748		    +95 	      3&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe20 	    :	      1,347,191,194		    +69 	      3&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe21 	    :	      1,347,166,549		    +88 	      3&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe22 	    :	      1,347,141,524		    +78 	      4&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe23 	    :	      1,347,116,886		    +83 	      3&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe24 	    :	      1,348,186,469		    +83 	      4&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe25 	    :	      1,348,161,948		    +74 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe26 	    :	      1,348,136,316		    +90 	      4&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe27 	    :	      1,348,106,807		    +69 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe28 	    :	      1,348,079,919		    +95 	      4&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe29 	    :	      1,348,048,460		    +62 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe30 	    :	      1,348,018,298		   +102 	      4&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe31 	    :	      1,347,983,062		    +57 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe32 	    :	      1,347,951,303		   +107 	      4&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe33 	    :	      1,347,917,231		    +50 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe34 	    :	      1,347,886,358		   +116 	      5&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe35 	    :	      1,347,853,385		    +45 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe36 	    :	      1,347,092,884		   +121 	      5&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe37 	    :	      1,347,067,278		    +38 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe38 	    :	      1,347,043,968		   +127 	      5&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe39 	    :	      1,347,017,351		    +32 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe40 	    :	      1,346,994,279		   +135 	      6&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe41 	    :	      1,346,968,532		    +26 	      1&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe42 	    :	      1,346,946,104		   +142 	      6&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe43 	    :	      1,346,917,004		    +19</span><br><span class="line">CLMIB_TPKT.xe44 	    :	      1,346,894,475		   +148 	      7&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe45 	    :	      1,346,866,979		    +12</span><br><span class="line">CLMIB_TPKT.xe46 	    :	      1,346,843,674		   +154 	      7&#x2F;s</span><br><span class="line">CLMIB_TPKT.xe47 	    :	      1,346,816,974		     +6</span><br><span class="line">drivshell&gt;</span><br><span class="line">drivshell&gt;show c CLMIB_RFCS</span><br><span class="line">show c CLMIB_RFCS</span><br><span class="line">drivshell&gt;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>RSTP802.1wç®€è¿°</title>
    <url>/2022/07/07/RSTP802-1w%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p><code>ã€ŠSTP(802.1d)ç®€è¿°ã€‹</code>ä¸­æè¿°äº†STPåè®®å®ç°loop-freeçš„åŸç†ï¼Œä¸¾ä¾‹è¯´æ˜äº†æ ¹æ¡¥åŠç«¯å£çš„é€‰ä¸¾è§„åˆ™ï¼Œå½“å‘ç”Ÿé“¾è·¯æ•…éšœæ—¶çš„æ”¶æ•›è¿‡ç¨‹ï¼Œæœ€ååˆ—ä¸¾äº†åŠ å¿«STPæ”¶æ•›çš„ç‰¹æ€§åŠå®‰å…¨ç‰¹æ€§ã€‚STPçš„æœ€å¤§æ”¶æ•›æ—¶é—´å¯è¾¾50ç§’å·¦å³ï¼Œä¸ºäº†åŠ å¿«æ”¶æ•›æ—¶é—´ï¼ŒRSTP(rapid STP)è¯ç”Ÿäº†ã€‚RSTPä¸»è¦é€šè¿‡<code>P/Aæœºåˆ¶</code>å‡å°‘ç«¯å£çŠ¶æ€åˆ‡æ¢æ—¶é—´ï¼Œé€šè¿‡å¤„ç†<code>inferior BPDU</code>å‡å°‘BPDUè€åŒ–æ—¶é—´ï¼Œå¹¶ä¸”é›†æˆäº†portfastã€uplinkfastã€backbonefastæœºåˆ¶ã€‚ä¸‹é¢ä¸»è¦é˜è¿°ä¸¤è€…ä¹‹é—´çš„å·®å¼‚ï¼Œä»¥åŠRSTPå®ç°å¿«é€Ÿæ”¶æ•›çš„ä¸€äº›ç»†èŠ‚ã€‚</p>
<span id="more"></span>

<h1 id="RSTPä¸STPçš„å·®å¼‚"><a href="#RSTPä¸STPçš„å·®å¼‚" class="headerlink" title="RSTPä¸STPçš„å·®å¼‚"></a>RSTPä¸STPçš„å·®å¼‚</h1><p>RSTPä¸­æ ¹æ¡¥çš„é€‰ä¸¾è§„åˆ™ï¼Œç«¯å£çš„é€‰ä¸¾è§„åˆ™å’ŒSTPä¿æŒä¸€è‡´ã€‚superior BPDUä¾ç„¶æ˜¯å…¶ä¸­çš„æ ¸å¿ƒã€‚å·®å¼‚ä¸»è¦ä½“ç°åœ¨ä¸‹é¢å‡ ç‚¹ã€‚</p>
<h2 id="ç«¯å£çŠ¶æ€"><a href="#ç«¯å£çŠ¶æ€" class="headerlink" title="ç«¯å£çŠ¶æ€"></a>ç«¯å£çŠ¶æ€</h2><p>STPä¸­çš„disabledã€blockingã€listeningä¸‰ç§çŠ¶æ€åˆå¹¶åˆ°RSTPçš„discardingã€‚STPä¸­çš„ç«¯å£çŠ¶æ€è¿‡äºç»†åˆ†ï¼Œæ¯”å¦‚blockingåªèƒ½æ¥æ”¶BPDUï¼Œè€Œlisteningå¯ä»¥æ¥æ”¶å’Œå‘é€BPDUï¼Œä¸¤è€…éƒ½ä¸èƒ½å­¦ä¹ MACåœ°å€ã€‚è¿‡å¤šçš„çŠ¶æ€åˆ‡å—å¢åŠ äº†æ”¶æ•›æ—¶é—´ã€‚å½“ç„¶ï¼Œå¤šçš„çŠ¶æ€å¯ä»¥æå¤§çš„å‡å°‘ç½‘ç»œç¯è·¯çš„é£é™©ã€‚ä¸¤è€…ç«¯å£çŠ¶æ€å¯¹æ¯”å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">STP</th>
<th align="left">RSTP</th>
<th align="left">æ˜¯å¦åœ¨æ´»åŠ¨çš„æ‹“æ‰‘ä¸­</th>
<th align="left">æ˜¯å¦å­¦ä¹ macåœ°å€</th>
</tr>
</thead>
<tbody><tr>
<td align="left">disabled</td>
<td align="left">discarding</td>
<td align="left">no</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">blocking</td>
<td align="left">discarding</td>
<td align="left">no</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">listening</td>
<td align="left">discarding</td>
<td align="left">no</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">learning</td>
<td align="left">learning</td>
<td align="left">yes</td>
<td align="left">yes</td>
</tr>
<tr>
<td align="left">forwarding</td>
<td align="left">forwarding</td>
<td align="left">yes</td>
<td align="left">yes</td>
</tr>
</tbody></table>
<p>ç©¶å…¶åŸå› ï¼ŒRSTPä¸­é€šè¿‡P/Aæœºåˆ¶ä¸»åŠ¨åå•†å¯ä»¥ç›´æ¥å°†ç«¯å£ä»discardingçŠ¶æ€è½¬æ¢åˆ°forwardingï¼Œè€Œä¸æ˜¯STPä¸­é€šè¿‡å®šæ—¶å™¨æœºåˆ¶ç»è¿‡forward_delayåå†åˆ‡æ¢çŠ¶æ€ã€‚</p>
<h2 id="ç«¯å£è§’è‰²"><a href="#ç«¯å£è§’è‰²" class="headerlink" title="ç«¯å£è§’è‰²"></a>ç«¯å£è§’è‰²</h2><p><img src="https://rancho333.github.io/pictures/rstp_election.png"></p>
<p>RSTPä¸­å¢åŠ äº†ä¸€ç§ç«¯å£è§’è‰²<code>backup port</code>. å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒS2çš„eth2ç«¯å£ä¸ºBPã€‚éæ ¹äº¤æ¢æœºæ”¶åˆ°è‡ªå·±å‘å‡ºçš„BPDUæ—¶ï¼Œå¯¹æ¯”ç«¯å£ä¸Šå‘å‡ºå’Œæ”¶åˆ°çš„BPDUï¼Œå¦‚æœå‘å‡ºçš„æ˜¯<code>superior BPDU</code>ï¼Œé‚£ä¹ˆæˆä¸ºDPï¼Œå¦åˆ™æˆä¸ºBPã€‚æ³¨æ„ä¸APç«¯å£çš„å·®å¼‚ï¼š</p>
<ul>
<li>APæ˜¯ç«¯å£æ”¶åˆ°ä»<code>å…¶å®ƒäº¤æ¢æœº</code>å‘æ¥çš„superior BPDUï¼Œæ˜¯RPçš„å¤‡ä»½ï¼Œè¿™æ˜¯uplinkfastå®ç°çš„åŸç†</li>
<li>BPæ˜¯ç«¯å£æ”¶åˆ°ä»<code>è‡ªèº«äº¤æ¢æœº</code>å‘æ¥çš„superior BPDU, æ˜¯DPçš„å¤‡ä»½ï¼Œuplinkfastå¯¹BPä¸ç”Ÿæ•ˆï¼ŒBPåœ¨ç°å®ç½‘ç»œä¸­å¾ˆå°‘è§ï¼ŒåŸºæœ¬ç”¨ä¸åˆ°ã€‚å›¾ä¸­é€šè¿‡åœ¨S2å’ŒS3ä¸­åŠ ä¸€ä¸ªhubæ¥å®ç°ï¼Œå¦‚æœæ²¡æœ‰hubï¼ŒS2çš„eth1å’Œeth2éƒ½æ˜¯DPã€‚</li>
</ul>
<h2 id="BPDUçš„å˜åŒ–"><a href="#BPDUçš„å˜åŒ–" class="headerlink" title="BPDUçš„å˜åŒ–"></a>BPDUçš„å˜åŒ–</h2><p><img src="https://rancho333.github.io/pictures/rstp_bpdu.png"></p>
<p>RSTPçš„BPDUä¸STPçš„ä¸»è¦åœ¨ä¸‰ä¸ªå­—æ®µä¸Šæœ‰å·®å¼‚ï¼š</p>
<ul>
<li>protocol version identifierï¼šstpä¸º0ï¼Œrstpä¸º2. rstpå‘ä¸‹å…¼å®¹stp</li>
<li>BPDU type: stpä¸º0, rstpä¸º2ã€‚rstpä¸­æ²¡æœ‰ç±»å‹ä¸º0x80çš„TCNæŠ¥æ–‡ï¼Œåœ¨é…ç½®BPDUä¸­ä½¿ç”¨TC flagæ›¿ä»£</li>
<li>flagsï¼šstpä¸­åªä½¿ç”¨TCå’ŒTCAä¸¤ä¸ªflagsï¼Œrstpä¸­ä½¿ç”¨ä¸Šäº†å‰©ä¸‹çš„6 bits, å…¶ä¸­bit3å’Œbit2è¡¨ç¤ºç«¯å£è§’è‰²ï¼š<ul>
<li>0x00 è¡¨ç¤ºæœªçŸ¥ç±»å‹</li>
<li>0x01 è¡¨ç¤ºRP</li>
<li>0x10 è¡¨ç¤ºAPæˆ–BP</li>
<li>0x11 è¡¨ç¤ºDP</li>
</ul>
</li>
</ul>
<h3 id="BPDUçš„å‘é€"><a href="#BPDUçš„å‘é€" class="headerlink" title="BPDUçš„å‘é€"></a>BPDUçš„å‘é€</h3><p>STPä¸­æ ¹æ¡¥å‘¨æœŸ(hello time)å‘é€BPDUï¼Œéæ ¹æ¡¥ä»RPæ”¶åˆ°ç„¶åä»DPä¸­ç»§å‡ºå»ã€‚RSTPéæ ¹æ¡¥è‡ªå·±ç”ŸæˆBPDU(æ ¹æ®ç¼“å­˜çš„æ ¹æ¡¥cache)ï¼Œå‘¨æœŸ(hello time)é€šè¿‡DPå‘å¤–å‘é€</p>
<h3 id="BPDUçš„è¶…æ—¶"><a href="#BPDUçš„è¶…æ—¶" class="headerlink" title="BPDUçš„è¶…æ—¶"></a>BPDUçš„è¶…æ—¶</h3><p>STPä¸Šå¦‚æœç«¯å£æœ‰å­˜å‚¨çš„BPDUï¼Œmax_ageæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°superior BPDUåä¾¿ä¼šå¯¹å…¶è¶…æ—¶ã€‚RSTPé€šè¿‡BPDUå®ç°ç±»ä¼¼ospfä¸­çš„keepaliveæœºåˆ¶ï¼Œå¦‚æœè¿ç»­ä¸‰ä¸ªhello_timeæ—¶é—´å†…æ²¡æœ‰ä»é‚»å±…æ”¶åˆ°BPDUï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¯¥é“¾è·¯æ•…éšœï¼Œå¹¶ä¸”ç«‹å³æ¸…é™¤æ‰€æœ‰MACåœ°å€ã€‚</p>
<h3 id="è¾¹ç¼˜ç«¯å£"><a href="#è¾¹ç¼˜ç«¯å£" class="headerlink" title="è¾¹ç¼˜ç«¯å£"></a>è¾¹ç¼˜ç«¯å£</h3><p>STPçš„æ”¶æ•›ä¼˜åŒ–é‡Œé¢æœ‰<code>portfast</code>çš„æ¦‚å¿µï¼Œåœ¨rstpä¸­åˆ™ç§°ä¹‹ä¸º<code>edge port</code>, å³è¿æ¥ä¸»æœºçš„ç«¯å£ã€‚å¼€å¯edge portçš„ç«¯å£ä¸éœ€è¦ç»å†discardingã€learningçš„è¿‡åº¦ï¼Œè€Œæ˜¯ç›´æ¥å˜æˆforwardingï¼Œç«¯å£upã€downä¹Ÿä¸ä¼šäº§ç”ŸTCã€‚æ³¨æ„è¾¹ç¼˜ç«¯å£çš„é“¾è·¯ç±»å‹åªèƒ½æ˜¯p2p, å³å…¨åŒå·¥é“¾è·¯ï¼ŒåŒºåˆ«äºåŠåŒå·¥é“¾è·¯(sharedç±»å‹)ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯RSTPä¸­åŒæ ·éœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨æŒ‡å®šedge portã€‚uplinkfastå’Œbackbonefastç‰¹æ€§åˆ™æ˜¯è‡ªåŠ¨è¿è¡Œçš„ã€‚</p>
<h3 id="PAåå•†æœºåˆ¶-é‡è¦åŒºåˆ«"><a href="#PAåå•†æœºåˆ¶-é‡è¦åŒºåˆ«" class="headerlink" title="PAåå•†æœºåˆ¶(é‡è¦åŒºåˆ«)"></a>PAåå•†æœºåˆ¶(é‡è¦åŒºåˆ«)</h3><p><img src="https://rancho333.github.io/pictures/rstp_pa_mechanism.png"></p>
<p>PAæœºåˆ¶çš„åŸºæœ¬åŸç†å°±æ˜¯ï¼šå°†ä¸‹æ¸¸blockä¹‹åï¼Œå†å°†ä¸Šæ¸¸forwardingï¼Œè¿™ç§è¿‡ç¨‹å‘ä¸‹ä¼ å¯¼ï¼Œç›´è‡³æ•´ä¸ªRSTPå¼€å§‹è¿è½¬ï¼Œä¸‹æ¸¸blockçš„æ—¶å€™ä¾ç„¶å¯ä»¥ä¼ è¾“BPDUï¼Œè¿›è¡Œè§’è‰²é€‰ä¸¾ã€‚éœ€è¦æŠŠSTPçš„é€‰ä¸¾æœºåˆ¶è”æƒ³èµ·æ¥ï¼Œä¸è¦å­¤ç«‹çš„çœ‹å¾…PAæœºåˆ¶ã€‚<br>é€šè¿‡ä¸Šå›¾æ¥ä»‹ç»P/Aåå•†æœºåˆ¶çš„åŸç†ã€‚</p>
<ol>
<li>å½“è®¾å¤‡ä¸Šç”µåï¼ŒS1ã€S2å‡è®¤ä¸ºè‡ªå·±æ˜¯æ ¹æ¡¥å¹¶å‘å¤–å‘é€BPDU(proposal flagç½®ä½)ï¼Œç«¯å£çŠ¶æ€å‡ä¸ºblocking</li>
<li>S2çš„eth0æ”¶åˆ°S1çš„eth0å‘æ¥çš„superior BPDUï¼Œç¡®å®šS1æ˜¯æ ¹æ¡¥ï¼ŒS2çš„eth0æˆä¸ºRP(ç«‹å³åˆ‡æ¢æˆforwarding)ï¼Œå°†æ‰€æœ‰éè¾¹ç¼˜DP(eth1,eth2)çŠ¶æ€ç½®ä¸ºblock, å¹¶é€šè¿‡éè¾¹ç¼˜DPå‘é€BPDU(æ ¹æ¡¥æ˜¯S1ï¼Œproposal flagç½®ä½)ï¼Œä¹‹åå‘æ ¹æ¡¥å‘é€BPDU(TCç½®ä½, agreementç½®ä½ï¼Œè¯¥BPDUæ˜¯proposal BPDUçš„ä¸€ä¸ªæ‹·è´, æ‰€ä»¥BIDå’Œsender BIDéƒ½æ˜¯S1ï¼Œåªæ˜¯å»æ‰äº†proposalçš„flagï¼Œå¢åŠ äº†agreementçš„flagï¼Œè¿™å¯ä»¥è®©æ¥æ”¶åˆ°agreementçš„ç«¯å£çŸ¥é“å…·ä½“æ˜¯é‚£ä¸ªç«¯å£å‘å‡ºçš„proposal)ï¼Œå…·ä½“æŠ¥æ–‡å¦‚ä¸‹å›¾ï¼š</li>
</ol>
<p><img src="https://rancho333.github.io/pictures/rstp_pa_packet.png"></p>
<ol start="3">
<li>S1æ”¶åˆ°agreementç½®ä½çš„BPDUåï¼Œå°†eth0ç”±blockç½®ä¸ºforwardingï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°ï¼Œåˆ™ä¼šé€šè¿‡discardingã€learningåˆ‡æ¢åˆ°forwardingçŠ¶æ€(æ¯”å¦‚ä¸‹æ¸¸è®¾å¤‡è¿è¡ŒSTPæ—¶å°±ä¼šå‡ºç°è¿™ç§åœºæ™¯)</li>
<li>ä»¥ä¸Šä¸ºä¸€ä¸ªåŒæ­¥çš„å®Œæˆæµç¨‹ï¼Œä¹‹åS2ä¸S3ï¼ŒS2ä¸S4ä¹‹é—´ä¼šè¿›è¡ŒåŒæ ·çš„åŒæ­¥åå•†åŠ¨ä½œã€‚å³S2å‘S3,S4å‘é€proposalæŠ¥æ–‡ï¼ŒS3,S4é€‰å‡ºRPï¼Œblockéè¾¹ç¼˜DPï¼Œå¹¶å‘ä¸‹æ¸¸å‘é€proposalæŠ¥æ–‡(æ”¹å®ä¾‹ä¸­æ²¡æœ‰)ï¼ŒS3,S4å‘S2å‘é€agreementæŠ¥æ–‡ï¼Œå¹¶å°†è‡ªèº«RPç½®ä½forwardingï¼ŒS2å°†æ”¶åˆ°agreementæŠ¥æ–‡çš„DPç½®ä½forwardingçŠ¶æ€</li>
<li>ç«¯å£çŠ¶æ€å˜æˆforwardingï¼Œä¹‹åå‘é€çš„BPDUå°±ä¸ä¼šæœ‰proposalç½®ä½äº†ã€‚</li>
<li>PAåŒæ­¥æœºåˆ¶å…¶å®å°±æ˜¯ä¼ é€’ä¸€ç»„PAæŠ¥æ–‡(Aæ˜¯Pçš„æ‹·è´), ç”±äºæ²¡æœ‰å®šæ—¶å™¨æœºåˆ¶ï¼Œä»¥ä¸Šæµç¨‹å‘ç”Ÿéå¸¸å¿«ï¼Œäºšç§’çº§å°±å¯å®Œæˆç«¯å£çŠ¶æ€çš„åˆ‡æ¢ã€‚</li>
<li>å¦‚æœå‘å‡ºP=1çš„æŠ¥æ–‡æ²¡æœ‰æ”¶åˆ°A=1çš„å›å¤ï¼Œåˆ™ä½¿ç”¨STPä¸€æ ·çš„æœºåˆ¶è¿›è¡ŒçŠ¶æ€è½¬æ¢ã€‚æ¯”å¦‚DP-APä¹‹é—´ï¼Œè¾¹ç¼˜ç«¯å£ä½†æ˜¯æ²¡æœ‰é…ç½®portfastçš„æ—¶å€™ã€‚</li>
</ol>
<h3 id="æ‹“æ‰‘å˜åŒ–æœºåˆ¶-é‡è¦åŒºåˆ«"><a href="#æ‹“æ‰‘å˜åŒ–æœºåˆ¶-é‡è¦åŒºåˆ«" class="headerlink" title="æ‹“æ‰‘å˜åŒ–æœºåˆ¶(é‡è¦åŒºåˆ«)"></a>æ‹“æ‰‘å˜åŒ–æœºåˆ¶(é‡è¦åŒºåˆ«)</h3><p>RSTPçš„æ‹“æ‰‘å˜åŒ–æœºåˆ¶ä¸STPæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œè§¦å‘æœºåˆ¶å’Œä¼ æ’­TCä¿¡æ¯éƒ½æœ‰åŒºåˆ«ã€‚<br>STPä¸­é“¾è·¯æ•…éšœä¼šè§¦å‘TC(topology changeï¼Œup or down)ï¼ŒRSTPä¸­ä¸ä¼šè®²é“¾è·¯æ•…éšœè§†ä½œTCã€‚RSTPä¸­åªæœ‰<code>éè¾¹ç¼˜DPç«¯å£</code>çŠ¶æ€è½¬æ¢æˆforwardingæ—¶æ‰ä¼šè§†ä½œTCã€‚å½“RSTPæ£€æµ‹åˆ°TCæ—¶ï¼š</p>
<ul>
<li>å¼€å¯2å€hello timeä½œä¸ºTCæŒç»­æ—¶é—´ã€‚åœ¨éè¾¹ç¼˜DPå’ŒRPä¸Šç”Ÿæ•ˆã€‚</li>
<li>flushè¯¥ç«¯å£ä¸Šå­¦åˆ°çš„MACåœ°å€è¡¨</li>
<li>åœ¨TCæŒç»­æ—¶é—´å†…,BPDUä¸­TCç½®ä½ï¼Œä»éè¾¹ç¼˜DPå’ŒRPå‘å¤–å‘é€ã€‚</li>
</ul>
<p>å½“äº†é‚»å±…æ”¶åˆ°TCæŠ¥æ–‡åï¼š</p>
<ul>
<li>flushé™¤æ”¶åˆ°TCæŠ¥æ–‡ä¹‹å¤–çš„æ‰€æœ‰ç«¯å£ä¸Šçš„MACåœ°å€è¡¨</li>
<li>å¼€å¯TCæŒç»­æ—¶é—´è®¡æ—¶å™¨ï¼Œåœ¨éè¾¹ç¼˜DPå’ŒRPä¸Šç”Ÿæ•ˆï¼Œå¹¶å‘é€TCç½®ä½BPDUã€‚</li>
</ul>
<p>åŒºåˆ«äºSTPä¸­åªå‘RPå‘é€TCNï¼Œç­‰å¾…æ ¹æ¡¥å‘é€TC/TCAç½®ä½BPDUï¼Œç„¶åç­‰å¾…forward_delayçš„æ—¶é—´è®©MACåœ°å€è¡¨è¶…æ—¶ï¼ŒRSTPå¯ä»¥å¾ˆå¿«è®©å…¨ç½‘çŸ¥é“TCå¹¶flush macåœ°å€è¡¨ï¼Œè¿™æ ·åšæœ‰åˆ©æœ‰å¼Šï¼Œå¯èƒ½ä¼šå¢åŠ æ½œåœ¨çš„floodingæµé‡ï¼Œä½†åŒæ—¶ä¹Ÿå¿«é€Ÿçš„æ¸…ç†äº†æ½œåœ¨çš„æ— æ•ˆMACåœ°å€è¡¨ä¿¡æ¯ã€‚</p>
<h3 id="å…¼å®¹æ€§é—®é¢˜"><a href="#å…¼å®¹æ€§é—®é¢˜" class="headerlink" title="å…¼å®¹æ€§é—®é¢˜"></a>å…¼å®¹æ€§é—®é¢˜</h3><p>RSTPå‘ä¸‹å…¼å®¹STPï¼Œä½†æ˜¯å¿«é€Ÿæ”¶æ•›çš„ç‰¹æ€§å°±æ²¡æœ‰äº†ã€‚STPä¸ä¼šå¤„ç†RSTPçš„æŠ¥æ–‡ã€‚</p>
<h2 id="ç®€å•æ€»ç»“"><a href="#ç®€å•æ€»ç»“" class="headerlink" title="ç®€å•æ€»ç»“"></a>ç®€å•æ€»ç»“</h2><p>STPä¸­è™½ç„¶é€šè¿‡portfastã€uplinkfastã€backbonefastçš„æœºåˆ¶ä¸€å®šç¨‹åº¦ä¸ŠåŠ å¿«äº†STPåœ¨ç‰¹å®šåœºæ™¯ä¸‹çš„æ”¶æ•›ï¼Œä½†è¿™äº›ç‰¹æ€§æ—¶ç§æœ‰äº†ï¼Œä¸ªå‚å®¶å®ç°æœ‰å·®å¼‚ï¼Œè€ŒRSTPä¸­å°†å…¶é›†æˆåˆ°äº†æ ‡å‡†ä¹‹ä¸­ã€‚è€ŒP/Aåå•†æœºåˆ¶ï¼ŒTCæ‹“æ‰‘å˜åŒ–æœºåˆ¶çš„å¼•å…¥æ›´æ˜¯å°†æ‹“æ‰‘æ”¶æ•›æ—¶é—´é™åˆ°äº†ä¸€ç§’å†…ï¼Œç›¸å¯¹äºSTPæ˜¯å·¨å¤§çš„æå‡ã€‚ä½†æ˜¯RSTPä¹Ÿå¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>å¿…stpé…ç½®å¤æ‚</li>
<li>æ¶ˆè€—æ›´å¤šçš„CPUèµ„æº</li>
<li>ä½¿ç”¨æ ¹æ¡¥cacheä¿¡æ¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´count-in-infinityçš„é—®é¢˜</li>
</ul>
<p>RSTPæ¯”STPæ”¶æ•›æ›´å¿«çš„åŸå› æ˜¯ï¼š</p>
<ol>
<li>PAæœºåˆ¶</li>
<li>TCæœºåˆ¶</li>
<li>é‚»å±…keepaliveæœºåˆ¶(3ä¸ªhello time)</li>
<li>é›†æˆbackbonefastï¼Œé…ç½®è¾¹ç¼˜ç«¯å£(uplinkfastå®é™…æ˜¯PAæœºåˆ¶)</li>
</ol>
<h2 id="ä¸¤ä¸ªå®éªŒ"><a href="#ä¸¤ä¸ªå®éªŒ" class="headerlink" title="ä¸¤ä¸ªå®éªŒ"></a>ä¸¤ä¸ªå®éªŒ</h2><p><img src="https://rancho333.github.io/pictures/rstp_convergence_experiment.png"></p>
<p>å®éªŒæ‹“æ‰‘å¦‚ä¸Šï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>vpc1å’Œvpc2åœ¨åŒä¸€ç½‘æ®µï¼Œvpc1æŒç»­ping vpc2</li>
<li>æ¨¡æ‹ŸTCï¼Œè§‚å¯Ÿpingä¸­æ–­æ—¶é—´ä»¥åŠç«¯å£è§’è‰²ã€çŠ¶æ€å˜åŒ–</li>
</ol>
<p>æ³¨æ„å®éªŒä¹‹å‰éœ€è¦æ­£ç¡®é…ç½®è¾¹ç¼˜ç«¯å£ï¼Œciscoä¸Šå’Œé…ç½®stpä¸­portfastç‰¹æ€§å‘½ä»¤ä¸€è‡´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Switch(config-if)#spanning-tree portfast edge        &#x2F;&#x2F; å°†æ¥å£é…ç½®æˆè¾¹ç¼˜ç«¯å£</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ ¹æ®P/Aåå•†æœºåˆ¶ï¼Œå½“S2çš„eth0 downæ‰åï¼Œeth1ä¼šåœ¨discardingã€learningã€forwardingçŠ¶æ€é—´è¿›è¡Œæ—¶å»¶è½¬æ¢(30ç§’)ã€‚åŸå› æ˜¯ä»eth1å‘å‡ºçš„proposalæŠ¥æ–‡æ²¡æœ‰æ”¶åˆ°agreementå›å¤ã€‚<br>STPä¸­portfaståªæ˜¯è®©ç«¯å£è·³è¿‡çŠ¶æ€åˆ‡æ¢ï¼Œå¹¶ä¸”çŠ¶æ€å˜æ¢ä¸ä¼šäº§ç”ŸTCNï¼Œä½†æ˜¯RSTPä¸­è¾¹ç¼˜ç«¯å£å’ŒPAæœºåˆ¶æœ‰ç›¸äº’ä½œç”¨ï¼Œ<em>æ³¨æ„</em>ï¼</p>
<h3 id="backbonefastç‰¹æ€§æµ‹è¯•"><a href="#backbonefastç‰¹æ€§æµ‹è¯•" class="headerlink" title="backbonefastç‰¹æ€§æµ‹è¯•"></a>backbonefastç‰¹æ€§æµ‹è¯•</h3><p>åœ¨S2ä¸Šshutdownç«¯å£eth0ï¼ŒS2çš„eth2å‘é€inferior BPDUï¼Œæ¨¡æ‹Ÿbackbonefastç‰¹æ€§æµ‹è¯•ã€‚pingç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/rstp_convergence_ping.png"></p>
<p>æ²¡æœ‰å‘ç°ä¸¢åŒ…ï¼Œåªæ˜¯shutdownç¬é—´ä¸€ä¸ªåŒ…æ—¶å»¶å¤§äº†ä¸€äº›, ç›¸è¾ƒäºSTPå¼€å¯backfastä¹‹åä¾ç„¶æ–­æµ30ç§’(S3ä¸Šeth0çŠ¶æ€åˆ‡æ¢æ—¶å»¶)ï¼Œæå‡å¾ˆå·¨å¤§ã€‚S2ä¸Šç«¯å£çŠ¶æ€å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Switch#show spanning-tree | begin Interface</span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0&#x2F;1               Desg FWD 100       128.2    P2p Edge </span><br><span class="line">Et0&#x2F;2               Root FWD 100       128.3    P2p </span><br><span class="line">Et0&#x2F;3               Desg BLK 100       128.4    P2p</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°eth2é€šè¿‡PAåå•†ç«‹å³å˜æˆRPçš„forwardingçŠ¶æ€ï¼Œeth1ä¸Šé…ç½®äº†è¾¹ç¼˜ç«¯å£ï¼Œä¸å‚ä¸PAï¼Œæ‰€ä»¥ä¾ç„¶æ˜¯forwardingï¼Œeth3ä¸Šæ²¡æœ‰é…ç½®è¾¹ç¼˜ç«¯å£ï¼Œå¤„äºblocking,ç»è¿‡30ç§’æ—¶å»¶è½¬æ¢æˆforwardingã€‚</p>
<p>S3ä¸Šeth0ç«¯å£åˆ™åœ¨ç¬é—´æœ‰APå˜æˆDP forwardingçŠ¶æ€ï¼Œè¿™é‡Œä¸åšå±•ç¤ºã€‚</p>
<h3 id="uplinkfastç‰¹æ€§æµ‹è¯•"><a href="#uplinkfastç‰¹æ€§æµ‹è¯•" class="headerlink" title="uplinkfastç‰¹æ€§æµ‹è¯•"></a>uplinkfastç‰¹æ€§æµ‹è¯•</h3><p>åœ¨S3ä¸Šshutdownç«¯å£eth1ï¼Œeth0ä»APå˜æˆRP forwardingçŠ¶æ€ã€‚pingæµ‹è¯•ç»“æœä¿æŒå’Œä¸Šé¢ä¸€è‡´ï¼Œæ²¡æœ‰ä¸¢åŒ…ï¼Œåªæ˜¯æ—¶å»¶å¢åŠ ã€‚S3ä¸Šç«¯å£çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Switch#show spanning-tree | begin Interface</span><br><span class="line">Interface           Role Sts Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0&#x2F;0               Root FWD 100       128.1    P2p </span><br><span class="line">Et0&#x2F;2               Desg FWD 100       128.3    P2p Edge </span><br><span class="line">Et0&#x2F;3               Desg LRN 100       128.4    P2p</span><br></pre></td></tr></table></figure>
<p>å¯¹äºSTPï¼Œåœ¨vpc1æŒç»­ping vpc2åˆ·æ–°macåœ°å€çš„åœºæ™¯ä¸‹ï¼Œåœ¨S3ä¸Šå¼€å¯uplinkfastç‰¹æ€§ï¼Œshutdown S3çš„eth1åï¼Œå¤§æ¦‚éœ€è¦<code>15ç§’</code>æ‰èƒ½æ¢å¤é€šä¿¡ï¼Œeth0ä»APç›´æ¥è½¬æ¢æˆDP forwardingçŠ¶æ€ï¼Œå¹¶å‘é€TCNæŠ¥æ–‡åˆ°S2ï¼ŒS2ä»eth0å‘é€åˆ°æ ¹æ¡¥ï¼Œæ”¶åˆ°æ ¹æ¡¥å‘æ¥çš„TCæŠ¥æ–‡åï¼Œè®¾ç½®15ç§’çš„MACåœ°å€è¡¨è€åŒ–è¶…æ—¶ï¼ŒS2ä¸ŠVPC2çš„MACåœ°å€æŒ‡å‘eth0,15ç§’è¶…æ—¶åé‡æ–°å­¦ä¹ ï¼Œé€šä¿¡æ¢å¤ã€‚S3æ”¶åˆ°TCAååœæ­¢å‘é€TCNã€‚</p>
<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong><br><a href="https://www.cisco.com/c/en/us/support/docs/lan-switching/spanning-tree-protocol/24062-146.html">Understanding Rapid Spanning Tree Protocol (802.1w)</a></p>
<p><em>ã€Š802.1w-2001ã€‹</em></p>
<p><em>ã€Š802.1d-2004ã€‹</em></p>
]]></content>
      <tags>
        <tag>STP</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCä¸Šå±‚åº”ç”¨ä¹‹SWSS</title>
    <url>/2021/08/19/SONiC%E4%B8%8A%E5%B1%82%E5%BA%94%E7%94%A8%E4%B9%8BSWSS/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>SONiCä¸­ARPæµ‹è¯•ç”¨ä¾‹ç®€æ</title>
    <url>/2021/04/26/SONiC%E4%B8%ADARP%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E7%AE%80%E6%9E%90/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>æœ¬æ–‡ç®€è¦åˆ†æSONiC testbedä¸­ARPæµ‹è¯•ç”¨ä¾‹çš„å®ç°ï¼Œä½œä¸ºå¯¹<a href="https://rancho333.github.io/2020/12/25/ARP%E5%8D%8F%E8%AE%AE%E7%AE%80%E8%BF%B0%E5%8F%8A%E5%BA%94%E7%94%A8/">ARPåè®®ç®€è¿°åŠåº”ç”¨</a>çš„è¡¥å……ã€‚</p>
<span id="more"></span>
<h2 id="èƒŒæ™¯çŸ¥è¯†ç®€è¿°"><a href="#èƒŒæ™¯çŸ¥è¯†ç®€è¿°" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†ç®€è¿°"></a>èƒŒæ™¯çŸ¥è¯†ç®€è¿°</h2><p>ARPç›´æ¥åŸºäºä»¥å¤ªå¸§è¿›è¡Œå°è£…ï¼Œ<code>type</code>ç±»å‹ä¸º<code>0x0806</code>ï¼ŒæŠ¥æ–‡å¾ˆç®€å•ï¼Œåªæœ‰ä¸¤ç±»ï¼šARP requestæŠ¥æ–‡å’ŒARP replyæŠ¥æ–‡ã€‚å…¶ä¸­requestæŠ¥æ–‡å¯åˆ†ä¸ºä¸‰ç±»ï¼š<br>    1. å•æ’­requestï¼Œå‚è€ƒrfc1122ï¼Œä¸€ç§arpç¼“å­˜åˆ·æ–°æœºåˆ¶<br>    2. å¹¿æ’­requestï¼Œè¿™ä¹Ÿæ˜¯å¸¸è§çš„arpè¯·æ±‚æŠ¥æ–‡<br>    3. å…è´¹arpæŠ¥æ–‡ï¼Œsender ipå’Œdestination ipç›¸åŒ</p>
<h2 id="æµ‹è¯•ç”¨ä¾‹ç®€æ"><a href="#æµ‹è¯•ç”¨ä¾‹ç®€æ" class="headerlink" title="æµ‹è¯•ç”¨ä¾‹ç®€æ"></a>æµ‹è¯•ç”¨ä¾‹ç®€æ</h2><p>åœ¨<code>sonic-mgmt/tests/arp</code>ä¸‹å…±æœ‰4ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test_arpall.py</span><br><span class="line">test_neighbor_mac_noptf.py</span><br><span class="line">test_neighbor_mac.py</span><br><span class="line">test_wr_arp.py</span><br></pre></td></tr></table></figure>
<p>æœ¬æ–‡ä¼šåˆ†æ<code>test_arpall.py</code>æ–‡ä»¶ï¼Œå¯¹äºå…¶å®ƒä¸‰ä¸ªæ–‡ä»¶ä¼šç®€è¦è¯´æ˜ä¸€ä¸‹ï¼Œæœ€åå¯¹æµ‹è¯•å¤±è´¥çš„<code>test_wr_arp.py</code>åšä¸€ä¸ªåˆ†æã€‚</p>
<p><code>test_arpall.py</code>ä¸­è®¾è®¡äº†5ç§æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<ol>
<li>å‘é€å•æ’­arp request</li>
<li>å‘é€å¹¿æ’­arp request</li>
<li>å‘é€ä¸åŒç½‘æ®µçš„arp request(sender ipå­—æ®µå¼‚å¸¸)</li>
<li>å…è´¹arpæµ‹è¯•</li>
</ol>
<h3 id="å•æ’­arp-requestæµ‹è¯•"><a href="#å•æ’­arp-requestæµ‹è¯•" class="headerlink" title="å•æ’­arp requestæµ‹è¯•"></a>å•æ’­arp requestæµ‹è¯•</h3><p>æµ‹è¯•ä»£ç åœ¨<code>sonic-mgmt/tests/arp/test_arpall.py</code>æ–‡ä»¶ä¸­ï¼Œå¯¹è¯¥æ¨¡å—ä»£ç æˆªå–ç®€æå¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/arp_unicast_reply.png"></p>
<p>æŠ¥æ–‡æ„é€ ä»£ç åœ¨<code>sonic-mgmt/ansible/roles/test/files/ptftests/arptest.py</code>æ–‡ä»¶ä¸­ï¼Œå¯¹åº”çš„ARPåŒ…æ„é€ å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/verifyunicastarpreply.png"></p>
<p>åŸºæœ¬æµç¨‹å°±æ˜¯æ„é€ å•æ’­arp requestæŠ¥æ–‡ï¼Œä¹‹åè·å–dutçš„arpè¡¨ï¼Œçœ‹å‘é€arp requestçš„ç«¯å£arpæ¡ç›®æ˜¯å¦å­˜åœ¨ã€‚æ ¹æ®rfc1122ï¼Œè¿™æ˜¯unicast poo(å•æ’­è½®è¯¢)ï¼šå®šæ—¶å‘ARPç¼“å­˜æ¡ç›®ä¸­çš„ä¸»æœºå‘é€ç‚¹åˆ°ç‚¹çš„ARPè¯·æ±‚æŠ¥æ–‡ï¼Œå‡å¦‚åœ¨Næ¬¡è¿ç»­è¶…æ—¶æ—¶é—´è¿‡åï¼Œæ²¡æœ‰æ”¶åˆ°å¯¹åº”ä¸»æœºçš„ARPå“åº”æŠ¥æ–‡ï¼Œåˆ™å°†æ­¤æ¡ç›®ä»ARPç¼“å­˜ä¸­åˆ é™¤ã€‚</p>
<p>å…¶å®è¿™æ ·æµ‹è¯•å¹¶ä¸èƒ½æµ‹è¯•å‡ºunicast pollçš„å®šä¹‰ï¼Œå’Œæ™®é€šARP è¯·æ±‚æ²¡å•¥åŒºåˆ«ã€‚</p>
<h3 id="å¹¿æ’­arp-requestæµ‹è¯•"><a href="#å¹¿æ’­arp-requestæµ‹è¯•" class="headerlink" title="å¹¿æ’­arp requestæµ‹è¯•"></a>å¹¿æ’­arp requestæµ‹è¯•</h3><p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/arp_expect_reply.png"></p>
<p>å¯¹åº”çš„ARPåŒ…æ„é€ å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/expectreply.png"></p>
<p>å¦‚ä¸Šé¢çš„åˆ†æï¼Œå’Œå•æ’­arpè¯·æ±‚æ²¡å•¥åŒºåˆ«ï¼Œè™½ç„¶ser intf1çš„macæ”¹äº†ä¸€ä¸‹ï¼Œä½†æ— å…³ç´§è¦ã€‚</p>
<h3 id="æ”¶åˆ°çš„arpæŠ¥æ–‡è¯·æ±‚çš„ä¸æ˜¯æœ¬æ¥å£mac"><a href="#æ”¶åˆ°çš„arpæŠ¥æ–‡è¯·æ±‚çš„ä¸æ˜¯æœ¬æ¥å£mac" class="headerlink" title="æ”¶åˆ°çš„arpæŠ¥æ–‡è¯·æ±‚çš„ä¸æ˜¯æœ¬æ¥å£mac"></a>æ”¶åˆ°çš„arpæŠ¥æ–‡è¯·æ±‚çš„ä¸æ˜¯æœ¬æ¥å£mac</h3><p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/arp_no_reply_other_intf.png"><br>è¿™é‡Œassetåˆ¤æ–­çš„ipé”™äº†ï¼Œåº”è¯¥æ˜¯ä¸ç­‰äº10.10.1.22æ‰å¯¹ã€‚</p>
<p>å¯¹åº”çš„ARPåŒ…æ„é€ å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/srcoutrangenoreply.png"></p>
<h3 id="æ”¶åˆ°çš„arpè¯·æ±‚ä¸­çš„sender-ipä¸æœ¬æ¥å£ä¸åœ¨åŒä¸€ç½‘æ®µ"><a href="#æ”¶åˆ°çš„arpè¯·æ±‚ä¸­çš„sender-ipä¸æœ¬æ¥å£ä¸åœ¨åŒä¸€ç½‘æ®µ" class="headerlink" title="æ”¶åˆ°çš„arpè¯·æ±‚ä¸­çš„sender ipä¸æœ¬æ¥å£ä¸åœ¨åŒä¸€ç½‘æ®µ"></a>æ”¶åˆ°çš„arpè¯·æ±‚ä¸­çš„sender ipä¸æœ¬æ¥å£ä¸åœ¨åŒä¸€ç½‘æ®µ</h3><p>å’Œä¸Šé¢<code>æ”¶åˆ°çš„arpæŠ¥æ–‡è¯·æ±‚çš„ä¸æ˜¯æœ¬æ¥å£mac</code>çš„æµç¨‹åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å°†ç›¸åŒçš„arp requestæŠ¥æ–‡å‘ç»™dut intf1ã€‚</p>
<h3 id="å…è´¹arpæŠ¥æ–‡æµ‹è¯•"><a href="#å…è´¹arpæŠ¥æ–‡æµ‹è¯•" class="headerlink" title="å…è´¹arpæŠ¥æ–‡æµ‹è¯•"></a>å…è´¹arpæŠ¥æ–‡æµ‹è¯•</h3><p>å…è´¹arpçš„æµ‹è¯•åˆ†ä¸ºä¸¤å—ï¼Œå¦‚æœå…è´¹arpä¸­çš„ä¿¡æ¯ä¹‹å‰æ²¡æœ‰è§£æè¿‡ï¼Œé‚£ä¹ˆä¸åº”è¯¥å“åº”å…è´¹arpæŠ¥æ–‡ï¼Œåä¹‹å“åº”ã€‚</p>
<p>ä¸å“åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/garp_no_update.png"></p>
<p>å¯¹åº”çš„ARPåŒ…æ„é€ å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/garpnoupdate.png"></p>
<p>æ­¤æ—¶å³ä½¿dutæ”¶åˆ°äº†å…è´¹arpæŠ¥æ–‡ï¼Œä½†æ˜¯<code>10.10.1.7</code>çš„ä¿¡æ¯å¹¶ä¸åœ¨dutçš„arpè¡¨ä¸­ï¼Œæ‰€ä»¥ä¸åº”è¯¥æœ‰å“åº”åŠ¨ä½œã€‚</p>
<p>å“åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/garp_update.png"><br>å¯ä»¥çœ‹åˆ°å…ˆè°ƒç”¨<code>ExpectReply</code>è®©<code>10.10.1.3</code>å­˜åœ¨äºdutçš„arpè¡¨ä¸­ï¼Œä¹‹åå†è°ƒç”¨<code>GarpUpdate</code>æ›´æ–°macï¼ŒMACåœ°å€ç”±<code>00:06:07:08:09:0a</code>æ›´æ–°ä¸º<code>00:00:07:08:09:0a</code>ã€‚</p>
<p>å¯¹åº”çš„ARPåŒ…æ„é€ å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/garpupdate.png"><br>è¿™é‡Œé¢ä¿®æ”¹äº†<code>10.10.1.3</code>å¯¹åº”çš„MACåœ°å€ã€‚</p>
<h2 id="å…¶å®ƒä¸‰ä¸ªæµ‹è¯•æ–‡ä»¶è¯´æ˜"><a href="#å…¶å®ƒä¸‰ä¸ªæµ‹è¯•æ–‡ä»¶è¯´æ˜" class="headerlink" title="å…¶å®ƒä¸‰ä¸ªæµ‹è¯•æ–‡ä»¶è¯´æ˜"></a>å…¶å®ƒä¸‰ä¸ªæµ‹è¯•æ–‡ä»¶è¯´æ˜</h2><p>å¯¹äº<code>test_neighbor_mac_noptf.py</code>ï¼Œptfä½œä¸ºdutçš„é‚»å±…ï¼Œé’ˆå¯¹ipv4å’Œipv6ä¸¤ç§åœºæ™¯ï¼Œåˆ†åˆ«æµ‹è¯•åœ¨DUTçš„redisä¸­å’Œarpè¡¨ä¸­èƒ½ä¸èƒ½æ‰¾åˆ°å¦æ®çš„arp entryã€‚<br>å¯¹äº<code>test_neighbor_mac.py</code>ï¼Œptfä½œä¸ºdutçš„é‚»å±…ï¼Œä½¿ç”¨ç›¸åŒçš„ip(ipv4)ï¼Œæ˜ å°„ä¸¤ä¸ªä¸åŒçš„macåœ°å€ï¼Œåˆ†åˆ«æµ‹è¯•è¿™ä¸¤ä¸ªmacåœ¨redisä¸­å­˜ä¸å­˜åœ¨ã€‚<br>å¯¹äº<code>test_wr_arp.py</code>æµ‹è¯•çƒ­é‡å¯è¿‡ç¨‹ä¸­çš„arpåŠŸèƒ½ï¼Œé¦–å…ˆåœ¨ptfä¸Šå¼€å¯ferret serverï¼Œä¹‹åè®©dutè¿›å…¥warm-rebootï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œptfå‘é€arp requestï¼Œ25ç§’å†…æ²¡æœ‰æ”¶åˆ°arp replyæµ‹è¯•å¤±è´¥ã€‚</p>
<h2 id="æµ‹è¯•ç»“æœè¯´æ˜"><a href="#æµ‹è¯•ç»“æœè¯´æ˜" class="headerlink" title="æµ‹è¯•ç»“æœè¯´æ˜"></a>æµ‹è¯•ç»“æœè¯´æ˜</h2><p>ä»¥<code>10.204.112.27:8080</code>ä¸Šçš„<code>seastone-t0</code>ä¸ºä¾‹è¯´æ˜ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/testbed_wrarp_seastone.png"></p>
<p>å¯ä»¥çœ‹åˆ°<code>test_wr_arp.py</code>æµ‹è¯•å¤±è´¥äº†ï¼Œç»“æœä¸ç¬¦åˆé¢„æœŸã€‚wr_arpé¦–å…ˆåœ¨ptf hostä¸Šå¼€å¯ferretæœåŠ¡ï¼Œä¹‹ååœ¨dutä¸Šå¯åŠ¨warm-rebootç¨‹åºï¼Œå½“dutå¤„äºwarm-rebooté˜¶æ®µæ—¶ï¼Œå‘å…¶vlanæˆå‘˜å‘é€arpè¯·æ±‚æŠ¥æ–‡ï¼Œ25ç§’å†…ä»»ä¸€vlanæˆæ²¡æœ‰å“åº”åˆ™æµ‹è¯•å¤±è´¥ã€‚</p>
<p>è€Œåœ¨<code>seastone2-t0</code>ä¸Šé¢ï¼Œè¯¥é¡¹æµ‹è¯•å¤±è´¥ï¼Œä½†æ˜¯åŸå› ä¸ä¸€æ ·ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/testbed_wrarp_seastone2.png"><br>æ­¤å¤„æ˜¯æ²¡æœ‰è·å–åˆ°ptfå®£å‘Šçš„ipï¼Œè¿™ä¸ªç½‘æ®µåº”è¯¥ç”±zebraä¸‹å‘åˆ°kernelï¼Œsrcå­—æ®µä¸ºdutçš„loopbackã€‚</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCä¸­OSPFä½¿ç”¨ç®€è¿°</title>
    <url>/2021/04/23/SONiC%E4%B8%ADOSPF%E4%BD%BF%E7%94%A8%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>æ‰¿æ¥ä¸Šæ–‡<a href="https://rancho333.github.io/2021/04/08/SONiC%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E7%AE%80%E8%BF%B0/">SONiCè·¯ç”±åè®®ç®€è¿°</a>ï¼Œè¿™è¾¹æ–‡ç« è®°å½•SONiCä¸Šä½¿èƒ½OSPFçš„è¿‡ç¨‹ã€‚</p>
<span id="more"></span>
<h2 id="å®éªŒè¿‡ç¨‹"><a href="#å®éªŒè¿‡ç¨‹" class="headerlink" title="å®éªŒè¿‡ç¨‹"></a>å®éªŒè¿‡ç¨‹</h2><h3 id="æ‹“æ‰‘è¯´æ˜"><a href="#æ‹“æ‰‘è¯´æ˜" class="headerlink" title="æ‹“æ‰‘è¯´æ˜"></a>æ‹“æ‰‘è¯´æ˜</h3><p>æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ospf-topology.png"></p>
<p>å®éªŒé¢„æœŸï¼š</p>
<ol>
<li>ä¸‰å°è®¾å¤‡ä¸Šèƒ½å»ºç«‹ospfé‚»å±…ï¼Œå®ŒæˆLSDBäº¤æ¢ï¼Œå»ºç«‹ospfè·¯ç”±</li>
<li><code>192.168.1.2</code>èƒ½å¤Ÿ<code>ping</code>é€š<code>192.168.2.2</code></li>
</ol>
<h3 id="å¯åŠ¨OSPF"><a href="#å¯åŠ¨OSPF" class="headerlink" title="å¯åŠ¨OSPF"></a>å¯åŠ¨OSPF</h3><p>åœ¨<code>bgp</code>å®¹å™¨ä¸­å¯åŠ¨<code>ospf</code>è¿›ç¨‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;lib&#x2F;frr&#x2F;ospfd -A 127.0.0.1 -d</span><br></pre></td></tr></table></figure>
<p>å‚ç…§<code>bgpd</code>çš„å¯åŠ¨è¿‡ç¨‹ï¼Œå°†ospfæ·»åŠ åˆ°supervisorä¸­ï¼Œå¹¶æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œåœ¨<code>/etc/supervisor/conf.d/supervisord.conf</code>ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[program:ospfd]</span><br><span class="line">command&#x3D;&#x2F;usr&#x2F;lib&#x2F;frr&#x2F;ospfd -A 127.0.0.1 -f &#x2F;etc&#x2F;frr&#x2F;ospfd.conf</span><br><span class="line">priority&#x3D;5</span><br><span class="line">stopsignal&#x3D;KILL</span><br><span class="line">autostart&#x3D;false</span><br><span class="line">autorestart&#x3D;false</span><br><span class="line">startsecs&#x3D;0</span><br><span class="line">stdout_logfile&#x3D;syslog</span><br><span class="line">stderr_logfile&#x3D;syslog</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>/usr/bin/start.sh</code>ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">supervisorctl start ospfd</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºospfé…ç½®æ–‡ä»¶<code>/etc/frr/ospfd.conf</code>, æ ¹æ®å…·ä½“ä¸šåŠ¡æ·»åŠ é…ç½®å†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frr version 7.2.1-sonic</span><br><span class="line">frr defaults traditional</span><br><span class="line">hostname lambda</span><br><span class="line">router ospf</span><br><span class="line"> network 192.168.1.0&#x2F;24 area 0</span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®æ¥å£IP"><a href="#é…ç½®æ¥å£IP" class="headerlink" title="é…ç½®æ¥å£IP"></a>é…ç½®æ¥å£IP</h3><p>åœ¨SONiCå‘½ä»¤è¡Œä¸­å¯é…ç½®æ¥å£ipï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config interface ip add 192.168.2.1&#x2F;24</span><br></pre></td></tr></table></figure>
<p>zebraä¼šé€šè¿‡netlinkè·å–æ¥å£é…ç½®ï¼Œåä¹‹åœ¨vtyä¸­é…ç½®æ¥å£ipä¸èƒ½åŒæ­¥åˆ°sonicã€‚ä¹Ÿå¯å°†é…ç½®å†™åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;INTERFACE&quot;: &#123;              </span><br><span class="line">        &quot;Ethernet1|192.168.1.1&#x2F;24&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Ethernet2|192.168.2.1&#x2F;24&quot;: &#123;&#125;                                                                                                                                                                                                                                                                               </span><br><span class="line">    &#125;,      </span><br></pre></td></tr></table></figure>

<p>é…ç½®å®Œæˆä¹‹åï¼Œåœ¨vtyä¸­å¯ä»¥çœ‹åˆ°ä½¿èƒ½äº†ospfçš„æ¥å£ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ospf-interface.png"></p>
<p>æ³¨æ„å°†æ¥å£çš„mtué…ç½®æˆ1500æˆ–è€…åœ¨ospfä¸­å…³é—­mtu checkã€‚</p>
<h3 id="é…ç½®ASIC"><a href="#é…ç½®ASIC" class="headerlink" title="é…ç½®ASIC"></a>é…ç½®ASIC</h3><p>SONiCä¸­é»˜è®¤ospfæŠ¥æ–‡ä¸é€CPUï¼Œè¿™å¯èƒ½å’Œå„å®¶çš„SDKåˆå§‹åŒ–å®ç°æœ‰å…³ã€‚åœ¨broadcomä¸‹æˆ‘ä»¬éœ€è¦åšä¸€äº›é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fp qset add ipprotocol</span><br><span class="line">fp group create 20 21				    (20æ˜¯ä¼˜å…ˆçº§ï¼Œ 21æ˜¯group-id)</span><br><span class="line">fp entry create 21 3000				    ï¼ˆ3000æ˜¯entry-idï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€çš„å€¼ï¼Œæ³¨æ„ä¸èƒ½é‡å ï¼‰</span><br><span class="line">fp qual  3000 ipprotocol 89 0xffff		(æŒ‡å®šcopy-to-cpuçš„åè®®ç‰¹å¾)</span><br><span class="line">fp action add 3000 CopyToCpu 0 0		ï¼ˆå¯¹åŒ¹é…åˆ°ç‰¹å¾çš„åè®®æŒ‡å®šåŠ¨ä½œï¼‰</span><br><span class="line">fp entry install 3000					ï¼ˆä½¿èƒ½é…ç½®ï¼‰</span><br><span class="line">fp show entry 3000                        ï¼ˆéªŒè¯é…ç½®ï¼‰</span><br></pre></td></tr></table></figure>
<p>åº”å½“åœ¨ASICä¸­çœ‹åˆ°ä½¿èƒ½çš„é…ç½®ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ospf-asic.png"></p>
<p>sonicä¸­æä¾›äº†coppåŠŸèƒ½é…ç½®sdkä¸‹å‘è¿™äº›æŠ¥æ–‡ä¸ŠCPUç­‰çš„æ§åˆ¶æ“ä½œï¼Œå—å½“å‰å®éªŒç‰ˆæœ¬é™åˆ¶æš‚ä¸åšè¿™æ–¹é¢æ·±å…¥ç ”ç©¶ã€‚</p>
<h3 id="åŠŸèƒ½éªŒè¯"><a href="#åŠŸèƒ½éªŒè¯" class="headerlink" title="åŠŸèƒ½éªŒè¯"></a>åŠŸèƒ½éªŒè¯</h3><p>æŸ¥çœ‹é‚»å±…çŠ¶æ€ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ospf-neighbour.png"></p>
<p>æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ospf-database.png"></p>
<p>æŸ¥çœ‹è·¯ç”±è¡¨ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ospf-route.png"></p>
<p>pingæµ‹è¯•ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ospf-ping.png"></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å½“å‰SONiCä¸ŠospfåŠŸèƒ½ä½¿èƒ½éœ€è¦åšä¸‰æ–¹é¢çš„é…ç½®ï¼š</p>
<ol>
<li>ospfè‡ªèº«ï¼ŒåŒ…æ‹¬åŠŸèƒ½å¯ç”¨ä»¥åŠåè®®å‚æ•°é…ç½®</li>
<li>å¯ç”¨ospfåè®®çš„æ¥å£</li>
<li>é…ç½®ASICï¼Œåè®®æŠ¥æ–‡ä¸ŠCPU</li>
</ol>
]]></content>
      <tags>
        <tag>SONiC</tag>
        <tag>é€šä¿¡åè®®</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCä¸­STPä½¿ç”¨ç®€è¿°</title>
    <url>/2023/12/14/SONiC%E4%B8%ADSTP%E4%BD%BF%E7%94%A8%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>SONiCç¤¾åŒºå½“å‰ä¸æ”¯æŒSTP featureï¼Œè™½ç„¶Broadcomå·²ç»æäº¤äº† <a href="https://github.com/sonic-net/sonic-buildimage/pull/3463">PR</a>, ä½†æ˜¯ä¸€ç›´æ²¡æœ‰merge, å¹¶ä¸”é•¿æ—¶é—´æ²¡æœ‰ç»´æŠ¤ã€‚åŸºäºgithubä¸Šçš„å¼€æº<a href="https://github.com/mstpd/mstpd">MSTPD</a>é¡¹ç›®ï¼Œå°†å…¶portingåˆ°sonicä¸­ï¼Œå®Œå–„SONiCçš„L2 features. æœ¬æ–‡ç®€è¿°portingè¿‡ç¨‹ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚</p>
<span id="more"></span>

<p>éœ€è¦äº†è§£ä¸€äº›STPçš„èƒŒæ™¯çŸ¥è¯†ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢é“¾æ¥</p>
<ul>
<li><a href="https://rancho333.github.io/2022/07/07/STP802-1d%E7%AE%80%E8%BF%B0/">STP802.1dç®€è¿°</a></li>
<li><a href="https://rancho333.github.io/2022/07/07/RSTP802-1w%E7%AE%80%E8%BF%B0/">RSTP802.1wç®€è¿°</a></li>
<li><a href="https://rancho333.github.io/2022/07/07/mstp802-1s%E7%AE%80%E8%BF%B0/">mstp802.1sç®€è¿°</a></li>
</ul>
]]></content>
      <tags>
        <tag>STP</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCä¸­Vxlan-decapæµ‹è¯•ç”¨ä¾‹ç®€æ</title>
    <url>/2021/04/28/SONiC%E4%B8%ADVxlan-decap%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E7%AE%80%E6%9E%90/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>æœ¬æ–‡ç®€è¦åˆ†æSONiC testbedä¸­Vxlan decapæµ‹è¯•ç”¨ä¾‹çš„å®ç°ï¼Œä½œä¸ºå¯¹<a href="https://rancho333.github.io/2021/02/03/vxlan%E5%AD%A6%E4%B9%A0/">vxlanå­¦ä¹ </a>çš„è¡¥å……ã€‚</p>
<span id="more"></span>

<h2 id="èƒŒæ™¯ç®€è¿°"><a href="#èƒŒæ™¯ç®€è¿°" class="headerlink" title="èƒŒæ™¯ç®€è¿°"></a>èƒŒæ™¯ç®€è¿°</h2><p>VxlanæŠ€æœ¯çš„æœ¬è´¨æ˜¯é€šè¿‡overlayå®ç°ä¸€ä¸ªvmæ— æ„ŸçŸ¥çš„å¤§äºŒå±‚ç½‘ç»œï¼Œä¸€èˆ¬ç”¨äºæ•°æ®ä¸­å¿ƒï¼Œå¥½å¤„æ˜¯vmè¿ç§»æ—¶å¯ä»¥ä¿æŒIPä¸å˜ï¼ˆå†è¾…ä»¥ä¸€äº›æŠ€æœ¯æ‰‹æ®µå¯ä»¥ä¿æŒä¸šåŠ¡ä¸ä¸­æ–­ï¼‰,æ¢ç§æ–¹å¼è¯´ï¼Œvmå¯ä»¥åœ¨ä»»æ„ç‰©ç†ä¸»æœºä¸Šå®ç°å’Œç½‘å…³çš„äºŒå±‚äº’é€šã€‚</p>
<h2 id="æµ‹è¯•ç”¨ä¾‹ç®€æ"><a href="#æµ‹è¯•ç”¨ä¾‹ç®€æ" class="headerlink" title="æµ‹è¯•ç”¨ä¾‹ç®€æ"></a>æµ‹è¯•ç”¨ä¾‹ç®€æ</h2><p>åœ¨<code>sonic-mgmt/tests/vxlan</code>ä¸‹å…±æœ‰5ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test_vnet_route_leak.py</span><br><span class="line">test_vnet_vxlan.py</span><br><span class="line">test_vxlan_decap.py</span><br><span class="line">vnet_constants.py</span><br><span class="line">vnet_utils.py</span><br></pre></td></tr></table></figure>
<p>æœ¬æ¬¡åªæ˜¯ç®€è¦åˆ†æä¸‹<code>test_vxlan_decap.py</code>æµ‹è¯•å†…å®¹ã€‚</p>
<h2 id="æµ‹è¯•å†…å®¹"><a href="#æµ‹è¯•å†…å®¹" class="headerlink" title="æµ‹è¯•å†…å®¹"></a>æµ‹è¯•å†…å®¹</h2><p>æµ‹è¯•dutåœ¨æ•°æ®é¢å¯¹vxlanæŠ¥æ–‡çš„è§£å°è£…ã€‚å¯¹æ¯ä¸€vlanä¼šè¿è¡Œä¸‰ä¸ªcaseã€‚</p>
<ol>
<li>Vxlanï¼š ç»™portchannelæ¥å£å‘é€å°è£…çš„vxlanæŠ¥æ–‡ï¼Œåº”è¯¥åœ¨å¯¹åº”çš„vlanæ¥å£ä¸Šçœ‹åˆ°payloadæŠ¥æ–‡ã€‚</li>
<li>RegularLAGtoVLAN: å‘é€å¸¸è§„æŠ¥æ–‡ç»™portchannelæ¥å£ï¼Œåº”è¯¥åœ¨å¯¹åº”çš„vlanæ¥å£ä¸Šçœ‹åˆ°è¯¥æŠ¥æ–‡ã€‚</li>
<li>RegularVLANtoLAG: å‘é€å¸¸è§„æŠ¥æ–‡ç»™vlanæˆå‘˜æ¥å£ï¼Œåº”è¯¥åœ¨portchannelæ¥å£ä¸Šçœ‹åˆ°è¯¥æŠ¥æ–‡ã€‚</li>
</ol>
<p><img src="https://rancho333.github.io/pictures/vxlan_tests.png"></p>
<h2 id="æµ‹è¯•å‚æ•°"><a href="#æµ‹è¯•å‚æ•°" class="headerlink" title="æµ‹è¯•å‚æ•°"></a>æµ‹è¯•å‚æ•°</h2><p>å…±æœ‰6ä¸ªæµ‹è¯•å‚æ•°ã€‚</p>
<ol>
<li><code>config_file</code>æ˜¯è¿è¡Œtestæ‰€éœ€è¦çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚è¯¥æ–‡ä»¶ç”±ansibleæ„é€ ç”Ÿæˆã€‚è¯¥å‚æ•°ä¸å¯ç¼ºçœã€‚</li>
<li><code>vxlan_enabled</code>æ˜¯ä¸€ä¸ªå¸ƒå°”å‚æ•°ã€‚å½“è®¾ç½®ä¸ºtrueæ—¶ï¼Œvxlanæµ‹è¯•å¤±è´¥æ•´ä¸ªæµ‹è¯•å¤±è´¥ã€‚è¯¥å‚æ•°é»˜è®¤ä¸ºfalseã€‚</li>
<li><code>count</code>æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚è¡¨ç¤ºå‘åŒ…æ•°ï¼Œé»˜è®¤ä¸º1.</li>
<li><code>dut_host</code>æ˜¯dutçš„ipåœ°å€</li>
<li><code>sonic_admin_user</code>æ˜¯dutçš„ç™»å½•å</li>
<li><code>sonic_admin_password</code>æ˜¯ç™»å½•å¯†ç </li>
</ol>
<h2 id="æµ‹è¯•æ–¹æ³•"><a href="#æµ‹è¯•æ–¹æ³•" class="headerlink" title="æµ‹è¯•æ–¹æ³•"></a>æµ‹è¯•æ–¹æ³•</h2><p>testbedè®¾ç½®å¥½ä¹‹åï¼Œè¿è¡Œ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;run_tests.sh -d cel-seastone-01 -n cel_slx_t0 -c vxlan&#x2F;test_vxlan_decap.py -t t0,any</span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h2><p>æµ‹è¯•å¤±è´¥</p>
<p>logè®°å½•ä¸‹æ¥ä¾›åç»­å‚è€ƒã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">E               &quot;delta&quot;: &quot;0:01:30.984956&quot;, E               &quot;end&quot;: &quot;2021-04-28 09:12:57.714679&quot;, E               &quot;failed&quot;: true, E               &quot;invocation&quot;: &#123;E                   &quot;module_args&quot;: &#123;E                       &quot;_raw_params&quot;: &quot;ptf --test-dir ptftests vxlan-decap.Vxlan --platform-dir ptftests --qlen&#x3D;10000 --platform remote -t &#39;vxlan_enabled&#x3D;False;count&#x3D;10;config_file&#x3D;&#39;\&quot;&#39;\&quot;&#39;&#x2F;tmp&#x2F;vxlan_decap.json&#39;\&quot;&#39;\&quot;&#39;;sonic_admin_user&#x3D;u&#39;\&quot;&#39;\&quot;&#39;admin&#39;\&quot;&#39;\&quot;&#39;;sonic_admin_password&#x3D;u&#39;\&quot;&#39;\&quot;&#39;password&#39;\&quot;&#39;\&quot;&#39;;dut_hostname&#x3D;u&#39;\&quot;&#39;\&quot;&#39;10.251.0.100&#39;\&quot;&#39;\&quot;&#39;;sonic_admin_alt_password&#x3D;u&#39;\&quot;&#39;\&quot;&#39;YourPaSsWoRd&#39;\&quot;&#39;\&quot;&#39;&#39; --relax --debug info --log-file &#x2F;tmp&#x2F;vxlan-decap.Vxlan.Removed.2021-04-28-09:11:26.log&quot;, E                       &quot;_uses_shell&quot;: true, E                       &quot;argv&quot;: null, E                       &quot;chdir&quot;: &quot;&#x2F;root&quot;, E                       &quot;creates&quot;: null, E                       &quot;executable&quot;: null, E                       &quot;removes&quot;: null, E                       &quot;stdin&quot;: null, E                       &quot;stdin_add_newline&quot;: true, E                       &quot;strip_empty_ends&quot;: true, E                       &quot;warn&quot;: trueE                   &#125;E               &#125;, E               &quot;msg&quot;: &quot;non-zero return code&quot;, E               &quot;rc&quot;: 1, E               &quot;start&quot;: &quot;2021-04-28 09:11:26.729723&quot;, E               &quot;stderr&quot;: &quot;WARNING: No route found for IPv6 destination :: (no default route?)\n&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python2.7&#x2F;dist-packages&#x2F;paramiko&#x2F;transport.py:33: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in a future release.\n  from cryptography.hazmat.backends import default_backend\nvxlan-decap.Vxlan ... FAIL\n\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nFAIL: vxlan-decap.Vxlan\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \&quot;ptftests&#x2F;vxlan-decap.py\&quot;, line 397, in runTest\n    self.warmup()\n  File \&quot;ptftests&#x2F;vxlan-decap.py\&quot;, line 334, in warmup\n    raise AssertionError(\&quot;Warmup failed\&quot;)\nAssertionError: Warmup failed\n\n----------------------------------------------------------------------\nRan 1 test in 89.524s\n\nFAILED (failures&#x3D;1)&quot;, E               &quot;stderr_lines&quot;: [E                   &quot;WARNING: No route found for IPv6 destination :: (no default route?)&quot;, E                   &quot;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python2.7&#x2F;dist-packages&#x2F;paramiko&#x2F;transport.py:33: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in a future release.&quot;, E                   &quot;  from cryptography.hazmat.backends import default_backend&quot;, E                   &quot;vxlan-decap.Vxlan ... FAIL&quot;, E                   &quot;&quot;, E                   &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;, E                   &quot;FAIL: vxlan-decap.Vxlan&quot;, E                   &quot;----------------------------------------------------------------------&quot;, E                   &quot;Traceback (most recent call last):&quot;, E                   &quot;  File \&quot;ptftests&#x2F;vxlan-decap.py\&quot;, line 397, in runTest&quot;, E                   &quot;    self.warmup()&quot;, E                   &quot;  File \&quot;ptftests&#x2F;vxlan-decap.py\&quot;, line 334, in warmup&quot;, E                   &quot;    raise AssertionError(\&quot;Warmup failed\&quot;)&quot;, E                   &quot;AssertionError: Warmup failed&quot;, E                   &quot;&quot;, E                   &quot;----------------------------------------------------------------------&quot;, E                   &quot;Ran 1 test in 89.524s&quot;, E                   &quot;&quot;, E                   &quot;FAILED (failures&#x3D;1)&quot;E               ], E               &quot;stdout&quot;: &quot;&quot;, E               &quot;stdout_lines&quot;: []E           &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ‰¾åˆ°æ˜¯åœ¨<code>warmup</code>ä¸­å‡ºé”™äº†ï¼Œå…·ä½“æ€ä¹ˆä¿®æ”¹åç»­å†è·Ÿå§ï¼</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCä¸­coredumpè°ƒè¯•</title>
    <url>/2021/08/23/SONiC%E4%B8%ADcoredump%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨è¿›è¡Œ<code>sonic-testbed</code>ä¸­çš„<code>process monitor</code>ç”¨ä¾‹è°ƒè¯•çš„æ—¶å€™ï¼Œå‘ç°<code>swss</code>å®¹å™¨ä¸­çš„<code>orchagent</code>è¿›ç¨‹äº§ç”Ÿcoredumpå¯¼è‡´æµ‹è¯•å¤±è´¥ã€‚æœ¬æ–‡å°†ç®€å•ä»‹ç»coredumpä»¥åŠå¦‚ä½•ç¼–è¯‘debugç‰ˆæœ¬SONiCè¿›è¡Œcoredumpè°ƒè¯•ã€‚</p>
<span id="more"></span>

<h1 id="SONiCä¸­coredumpçš„ä¸€äº›é…ç½®"><a href="#SONiCä¸­coredumpçš„ä¸€äº›é…ç½®" class="headerlink" title="SONiCä¸­coredumpçš„ä¸€äº›é…ç½®"></a>SONiCä¸­coredumpçš„ä¸€äº›é…ç½®</h1><p>ç”±äºSONiCä¸­çš„æœåŠ¡åŸºæœ¬ä¸Šéƒ½æ˜¯è¿è¡Œåœ¨dockerä¸­ï¼Œæ‰€ä»¥éœ€è¦ä½¿èƒ½dockeräº§ç”Ÿcoredumpã€‚éœ€è¦åšä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>åœ¨hostä¸Šé…ç½®<code>/proc/sys/kernel/core_pattern</code>, é…ç½®coreæ–‡ä»¶è·¯å¾„ä»¥åŠåç§°</li>
<li>åœ¨dockerä¸­é…ç½®coreæ–‡ä»¶å¤§å°é™åˆ¶<code>ulimit -c unlimited</code></li>
</ol>
<p>ä¸‹é¢æ˜¯SONiCå¯¹coreæ–‡ä»¶è·¯å¾„åŠåç§°çš„é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@cel-brixia2-01:&#x2F;home&#x2F;admin# cat &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;core_pattern </span><br><span class="line">|&#x2F;usr&#x2F;local&#x2F;bin&#x2F;coredump-compress %e %t %p %P</span><br><span class="line">root@cel-brixia2-01:&#x2F;home&#x2F;admin# </span><br><span class="line">root@cel-brixia2-01:&#x2F;home&#x2F;admin# cat &#x2F;usr&#x2F;local&#x2F;bin&#x2F;coredump-compress</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line"># Collect all parameters in order and build a file name prefix</span><br><span class="line">PREFIX&#x3D;&quot;&quot;</span><br><span class="line">while [[ $# &gt; 1 ]]; do</span><br><span class="line">    PREFIX&#x3D;$&#123;PREFIX&#125;$1.</span><br><span class="line">    shift</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ $# &gt; 0 ]; then</span><br><span class="line">    ns&#x3D;&#96;xargs -0 -L1 -a &#x2F;proc&#x2F;$&#123;1&#125;&#x2F;environ | grep -e &quot;^NAMESPACE_ID&quot; | cut -f2 -d&#39;&#x3D;&#39;&#96;</span><br><span class="line">    if [ ! -z $&#123;ns&#125; ]; then</span><br><span class="line">        PREFIX&#x3D;$&#123;PREFIX&#125;$&#123;ns&#125;.</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">&#x2F;bin&#x2F;gzip -1 - &gt; &#x2F;var&#x2F;core&#x2F;$&#123;PREFIX&#125;core.gz</span><br></pre></td></tr></table></figure>
<p>å³å½“äº§ç”Ÿcoreæ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>/var/core/</code>è·¯å¾„ä¸‹æ‰¾åˆ°.</p>
<h1 id="SONiCä¸­coreæ–‡ä»¶è°ƒè¯•"><a href="#SONiCä¸­coreæ–‡ä»¶è°ƒè¯•" class="headerlink" title="SONiCä¸­coreæ–‡ä»¶è°ƒè¯•"></a>SONiCä¸­coreæ–‡ä»¶è°ƒè¯•</h1><p>æ™®é€šçš„SONiCç‰ˆæœ¬ä¸­æ˜¯ä¸å¸¦<code>gdb</code>å·¥å…·çš„ï¼Œ<code>elf</code>æ–‡ä»¶ä¹Ÿéƒ½æ˜¯<code>stripped</code>ã€‚åœ¨ç¼–è¯‘debugç‰ˆæœ¬çš„æ—¶å€™ï¼Œéœ€è¦åšä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>åœ¨dockerä¸­å®‰è£…gdbå·¥å…·</li>
<li>å¯¹<code>elf</code> not strippedæˆ–è€…ä¸»åŠ¨æ·»åŠ <code>symbols</code>ä¿¡æ¯</li>
</ol>
<p>SONiCçš„ç¼–è¯‘ç³»ç»Ÿæä¾›äº†å¾ˆæ–¹ä¾¿çš„æ–¹æ³•ä¾›ç”¨æˆ·ç¼–è¯‘debugç‰ˆæœ¬ï¼Œä»¥<code>swss</code>ä¸ºä¾‹åšæ­¥éª¤è¯´æ˜ã€‚</p>
<ol>
<li><p>ä¿®æ”¹<code>rules/config</code>ä¸­çš„å­—æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-# INSTALL_DEBUG_TOOLS &#x3D; y</span><br><span class="line">+INSTALL_DEBUG_TOOLS &#x3D; y</span><br><span class="line"></span><br><span class="line">-#SONIC_DEBUGGING_ON &#x3D; y</span><br><span class="line">-#SONIC_PROFILING_ON &#x3D; y</span><br><span class="line">+SONIC_DEBUGGING_ON &#x3D; y</span><br><span class="line">+SONIC_PROFILING_ON &#x3D; y</span><br></pre></td></tr></table></figure></li>
<li><p>ä½¿ç”¨<code>make list</code>æ‰¾åˆ°éœ€è¦å¯¹åº”çš„targetï¼Œå¦‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">target&#x2F;docker-orchagent-dbg.gz</span><br></pre></td></tr></table></figure>
<p>ä¹‹å<code>make target/docker-orchagent-dbg.gz</code>ç”Ÿæˆdebugç‰ˆæœ¬çš„å®¹å™¨ï¼Œç„¶åæ‹·è´åˆ°è®¾å¤‡ä¸Šã€‚</p>
</li>
<li><p>åŠ è½½é•œåƒï¼Œç”Ÿæˆdebugç‰ˆçš„å®¹å™¨</p>
<ul>
<li>ä½¿ç”¨<code>docker load -i docker-orchagent-dbg.gz</code>è½½å…¥ç¼–è¯‘å¥½çš„debugç‰ˆé•œåƒ</li>
<li>åˆ é™¤åŸæ¥çš„å®¹å™¨<code>docker rm swss</code></li>
<li>ä¿®æ”¹<code>/usr/bin/swss.sh</code> æ–‡ä»¶<code>--name=$DOCKERNAME docker-orchagent-dbg:latest</code>ï¼ŒæŒ‡å®šä½¿ç”¨debugç‰ˆé•œåƒç”Ÿæˆå®¹å™¨</li>
<li><code>service swss stop</code> &amp;&amp; <code>service swss start</code> ç”Ÿæˆæ–°çš„å®¹å™¨</li>
</ul>
</li>
<li><p>å¯¹coreæ–‡ä»¶è¿›è¡Œè°ƒè¯•<br>å°†<code>/var/core</code>ä¸‹çš„coreæ–‡ä»¶æ‹·åˆ°dockerä¸­ï¼Œå¯ä»¥å‚è§<code>/usr/bin/swss.sh</code>ä¸­<code>create docker</code>æ—¶æŒ‚è½½çš„ç›®å½•ï¼Œä¸€èˆ¬hostä¸Šçš„<code>/etc/sonic</code>ä¼šä»¥åªè¯»çš„æ–¹å¼æŒ‚è½½åˆ°dockerä¸­ã€‚</p>
</li>
</ol>
<p>ä½¿ç”¨<code>gdb /usr/bin/orchagent core.file</code>è¿›è¡Œè°ƒè¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°gdbæ˜¯ä»<code>/usr/lib/debug/.build-id/</code>ä¸‹é¢è¯»å–symbolsä¿¡æ¯çš„ã€‚SONiCé‡‡ç”¨æ¨¡å—åŒ–å¢é‡çš„æ–¹å¼è¿›è¡Œç¼–è¯‘ï¼ŒåŸæœ‰çš„<code>elf</code>æ–‡ä»¶ä¾ç„¶æ˜¯<code>stripped</code>çŠ¶æ€ï¼Œä½†æ˜¯åœ¨debugç‰ˆæœ¬ä¸­ä¼šå°†é‡Œé¢çš„symbolsä¿¡æ¯æå–å‡ºæ¥æ”¾åˆ°ä¸€ä¸ªdebåŒ…ä¸­ï¼Œå¦‚<code>swss-dbg_1.0.0_amd64.deb</code>ã€‚</p>
<ol start="5">
<li>è¿™æ˜¯é’ˆå¯¹æŸä¸€å…·ä½“çš„debugå®¹å™¨æ›¿æ¢è¯´æ˜ï¼Œå¦‚æœå¯¹æ•´ä¸ªSONiCç¼–è¯‘debugç‰ˆæœ¬,ä¿®æ”¹å®Œ<code>rules/config</code>åï¼Œç›´æ¥<code>make target/sonic-broadcom.bin</code>å³å¯ã€‚</li>
</ol>
]]></content>
      <tags>
        <tag>SONiC</tag>
        <tag>coredump</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCä¸­syncdè°ƒç”¨SAIç®€æ</title>
    <url>/2021/09/06/SONiC%E4%B8%ADsyncd%E8%B0%83%E7%94%A8SAI%E7%AE%80%E6%9E%90/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ¬æ–‡ä»¥SONiC<code>202012</code>ç‰ˆæœ¬è¿›è¡Œ<code>syncd</code>æ¨¡å—åˆå§‹åŒ–åˆ†æã€‚sycndä¸orchagentå¼ºç›¸å…³ï¼Œä¸»è¦æœ‰5ä¸ªåŠ¨ä½œï¼Œåˆ†åˆ«æ˜¯<code>create</code>ã€<code>remove</code>ã€<code>set</code>ã€<code>get</code>ä»¥åŠ<code>notify</code>ã€‚å¯¹äºå‰ä¸‰ä¸ªåŠ¨ä½œï¼Œorchagentè°ƒç”¨sairedis apiå†™å¾€ASIC_DBå³è¿”å›æˆåŠŸï¼Œ<code>get</code>åŠ¨ä½œä¼šé˜»å¡ç­‰å¾…syncdçš„ç­”å¤ï¼Œå½“syncdæ¥æ”¶åˆ°<code>notify</code>äº‹ä»¶åä¼šé€šè¿‡ASIC_DBé€šçŸ¥åˆ°orchagentã€‚æœ¬æ–‡æš‚åˆ†æsyncdçš„åˆå§‹åŒ–åŠ¨ä½œã€‚ </p>
<p>æœ¬æ–‡å¯ä»¥æ€»ç»“æˆä¸€å¥è¯ï¼šSONiCä¸Šå±‚æ ¹æ®objecttypeè·å–å¯¹åº”çš„infoç»“æ„ï¼Œä»è€Œè°ƒç”¨é‡Œé¢çš„å…·ä½“æ–¹æ³•ï¼Œå®Œæˆsaiçš„è°ƒç”¨ã€‚</p>
<span id="more"></span>

<h1 id="syncd-main-cppä¸­åˆå§‹åŒ–ASIC"><a href="#syncd-main-cppä¸­åˆå§‹åŒ–ASIC" class="headerlink" title="syncd_main.cppä¸­åˆå§‹åŒ–ASIC"></a>syncd_main.cppä¸­åˆå§‹åŒ–ASIC</h1><p><code>syncd_main.cpp</code>æ˜¯syncdè¿›ç¨‹çš„å…¥å£å‡½æ•°ï¼Œé‡Œé¢ä¸»è¦åš3ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>åˆå§‹æˆ–æ—¥å¿—æœåŠ¡</li>
<li>è·å–warmrebootçŠ¶æ€</li>
<li>å®ä¾‹åŒ–ç±»<code>VendorSai</code>ã€<code>Syncd</code>ä»¥åŠè¿è¡Œ<code>syncd-&gt;run</code>å‡½æ•°è¿›å…¥syncdä¸»å¾ªç¯æ¨¡å—</li>
</ol>
<p>åœ¨<code>Syncd_main.cpp</code>ä¸­ä¸»è¦æ˜¯ä¸‰è¡Œä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">auto vendorSai &#x3D; std::make_shared&lt;VendorSai&gt;();             &#x2F;&#x2F;å®ä¾‹åŒ–VendorSaiï¼Œä½œä¸ºå‚æ•°ä¼ ç»™syncd</span><br><span class="line">auto syncd &#x3D; std::make_shared&lt;Syncd&gt;(vendorSai, commandLineOptions, isWarmStart);   &#x2F;&#x2F;å®ä¾‹åŒ–Syncd</span><br><span class="line">syncd-&gt;run();                                               &#x2F;&#x2F; æ‰§è¡Œrunæ–¹æ³•</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>VendorSai</code>å®ä¾‹åŒ–ï¼Œå®ƒçš„æ„é€ å‡½æ•°å¹¶æ²¡æœ‰åšä»€ä¹ˆç‰¹åˆ«çš„äº‹ã€‚</p>
<p>å¯¹äº<code>Syncd</code>å®ä¾‹åŒ–</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Syncd.cpp</span><br><span class="line">&#x2F;&#x2F; æ³¨å†Œnotifyäº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼ŒonFdbEventï¼ŒonPortStateChangeï¼ŒonSwitchShutdownRequestï¼ŒonSwitchStateChangeç­‰</span><br><span class="line">m_sn.onFdbEvent &#x3D; std::bind(&amp;NotificationHandler::onFdbEvent, m_handler.get(), _1, _2);</span><br><span class="line">m_sn.onPortStateChange &#x3D; std::bind(&amp;NotificationHandler::onPortStateChange, m_handler.get(), _1, _2);</span><br><span class="line"></span><br><span class="line">vendorSai-&gt;initialize               &#x2F;&#x2F;åˆå§‹åŒ–sai apiï¼Œå¹¶å°†ä¹‹æ”¾åˆ° m_apisä¸­</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–å…³å¿ƒçš„DBã€channel, åœ¨syncd::runä¸­é€šè¿‡å…¶è·å–å„ç§äº‹ä»¶ç„¶åè¿›è¡Œå¤„ç†</span><br><span class="line">m_selectableChannel &#x3D; std::make_shared&lt;RedisSelectableChannel&gt;(</span><br><span class="line">                m_dbAsic,</span><br><span class="line">                ASIC_STATE_TABLE,</span><br><span class="line">                REDIS_TABLE_GETRESPONSE,</span><br><span class="line">                TEMP_PREFIX,</span><br><span class="line">                modifyRedis);</span><br><span class="line">m_restartQuery &#x3D; std::make_shared&lt;swss::NotificationConsumer&gt;(m_dbAsic.get(), SYNCD_NOTIFICATION_CHANNEL_RESTARTQUERY);</span><br><span class="line">m_flexCounter &#x3D; std::make_shared&lt;swss::ConsumerTable&gt;(m_dbFlexCounter.get(), FLEX_COUNTER_TABLE);</span><br><span class="line">    m_flexCounterGroup &#x3D; std::make_shared&lt;swss::ConsumerTable&gt;(m_dbFlexCounter.get(), FLEX_COUNTER_GROUP_TABLE);</span><br></pre></td></tr></table></figure>
<p>å¯¹äºæ–¹æ³•<code>initialize</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">auto status &#x3D; sai_api_initialize(flags, service_method_table);      &#x2F;&#x2F;åˆå§‹åŒ–sai api</span><br><span class="line">int failed &#x3D; sai_metadata_apis_query(sai_api_query, &amp;m_apis);       &#x2F;&#x2F;å°†apiæ”¾å…¥æ•°æ®ç»“æ„ m_apiä¸­</span><br></pre></td></tr></table></figure>

<p><code>Syncd</code>çš„ä¸»é€»è¾‘åœ¨<code>run</code>æ–¹æ³•ä¸­ï¼Œå¾ªç¯å¤„ç†å„ç§åˆ°æ¥çš„äº‹ä»¶ï¼Œé¦–å…ˆæ˜¯åˆå§‹åŒ–switchï¼Œåœ¨<code>onSyncdStart</code>ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HardReiniter hr(m_client, m_translator, m_vendorSai, m_handler); &#x2F;&#x2F; æ„é€ å‡½æ•°åªæ˜¯å®Œæˆå‚æ•°åˆå§‹åŒ–</span><br><span class="line">m_switches &#x3D; hr.hardReinit();</span><br></pre></td></tr></table></figure>
<p>ç„¶åè°ƒ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;HardReiniter.cpp</span><br><span class="line">   std::vector&lt;std::shared_ptr&lt;SingleReiniter&gt;&gt; vec;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; perform hard reinit on all switches</span><br><span class="line"></span><br><span class="line">    for (auto&amp; kvp: m_switchMap)</span><br><span class="line">    &#123;</span><br><span class="line">        auto sr &#x3D; std::make_shared&lt;SingleReiniter&gt;(</span><br><span class="line">                m_client,</span><br><span class="line">                m_translator,</span><br><span class="line">                m_vendorSai,</span><br><span class="line">                m_handler,</span><br><span class="line">                m_switchVidToRid.at(kvp.first),</span><br><span class="line">                m_switchRidToVid.at(kvp.first),</span><br><span class="line">                kvp.second);</span><br><span class="line"></span><br><span class="line">        sr-&gt;hardReinit();</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œé¢æœ‰åšå¤šASICçš„è€ƒè™‘ï¼Œæˆ‘ä»¬å½“å‰åªä¼šç”¨åˆ°å•ASIC</span><br></pre></td></tr></table></figure>
<p>ä¹‹å</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">processSwitches();</span><br><span class="line">status &#x3D; m_vendorSai-&gt;create(SAI_OBJECT_TYPE_SWITCH, &amp;m_switch_rid, 0, attr_count, attr_list);</span><br></pre></td></tr></table></figure>
<p>åœ¨VendorSai.cppä¸­</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">auto info &#x3D; sai_metadata_get_object_type_info(objectType);          &#x2F;&#x2F; æ ¹æ®SAI_OBJECT_TYPE_SWITCHè·å–type_info</span><br><span class="line">auto status &#x3D; info-&gt;create(&amp;mk, switchId, attr_count, attr_list);   &#x2F;&#x2F; æ ¹æ®type_infoä¸­çš„æ–¹æ³•ï¼ˆsaiæä¾›ï¼‰åˆå§‹åŒ–ASIC</span><br></pre></td></tr></table></figure>

<p><code>sai_metadata_get_object_type_info</code>å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ ¹æ®<code>objectType</code>è·å–ç›¸åº”çš„æ•°æ®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;saimetadatautils.c</span><br><span class="line">const sai_object_type_info_t* sai_metadata_get_object_type_info(</span><br><span class="line">        _In_ sai_object_type_t object_type)</span><br><span class="line">&#123;                                                                                                                                                                                              </span><br><span class="line">    if (sai_metadata_is_object_type_valid(object_type))</span><br><span class="line">    &#123;   </span><br><span class="line">        return sai_metadata_all_object_type_infos[object_type];</span><br><span class="line">    &#125;   </span><br><span class="line"> </span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•°ç»„<code>type_info</code>çš„å®šä¹‰åœ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;saimetadata.c</span><br><span class="line">const sai_object_type_info_t* const sai_metadata_all_object_type_infos[] &#x3D; &#123;</span><br><span class="line">    NULL,  </span><br><span class="line">    &amp;sai_metadata_object_type_info_SAI_OBJECT_TYPE_PORT,                                                                                                                                       </span><br><span class="line">    &amp;sai_metadata_object_type_info_SAI_OBJECT_TYPE_LAG,</span><br><span class="line">    &amp;sai_metadata_object_type_info_SAI_OBJECT_TYPE_VIRTUAL_ROUTER,</span><br><span class="line">    &amp;sai_metadata_object_type_info_SAI_OBJECT_TYPE_NEXT_HOP,</span><br><span class="line">    â€¦â€¦</span><br><span class="line">    &amp;sai_metadata_object_type_info_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    â€¦â€¦</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>ä»¥<code>type_switch</code>ä¸ºä¾‹ï¼Œå®ƒçš„å…·ä½“æ•°æ®ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const sai_object_type_info_t sai_metadata_object_type_info_SAI_OBJECT_TYPE_SWITCH &#x3D; &#123;</span><br><span class="line">    .objecttype           &#x3D; SAI_OBJECT_TYPE_SWITCH,                    </span><br><span class="line">    .objecttypename       &#x3D; &quot;SAI_OBJECT_TYPE_SWITCH&quot;,                  </span><br><span class="line">    .attridstart          &#x3D; SAI_SWITCH_ATTR_START,                     </span><br><span class="line">    .attridend            &#x3D; SAI_SWITCH_ATTR_END,                       </span><br><span class="line">    .enummetadata         &#x3D; &amp;sai_metadata_enum_sai_switch_attr_t,</span><br><span class="line">    .attrmetadata         &#x3D; sai_metadata_object_type_sai_switch_attr_t,</span><br><span class="line">    .attrmetadatalength   &#x3D; 195,                                       </span><br><span class="line">    .isnonobjectid        &#x3D; false,                                     </span><br><span class="line">    .isobjectid           &#x3D; !false,                                    </span><br><span class="line">    .structmembers        &#x3D; NULL,                                      </span><br><span class="line">    .structmemberscount   &#x3D; 0,                                         </span><br><span class="line">    .revgraphmembers      &#x3D; sai_metadata_SAI_OBJECT_TYPE_SWITCH_rev_graph_members,</span><br><span class="line">    .revgraphmemberscount &#x3D; 8,                                         </span><br><span class="line">    .create               &#x3D; sai_metadata_generic_create_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    .remove               &#x3D; sai_metadata_generic_remove_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    .set                  &#x3D; sai_metadata_generic_set_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    .get                  &#x3D; sai_metadata_generic_get_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    .getstats             &#x3D; sai_metadata_generic_get_stats_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    .getstatsext          &#x3D; sai_metadata_generic_get_stats_ext_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    .clearstats           &#x3D; sai_metadata_generic_clear_stats_SAI_OBJECT_TYPE_SWITCH,</span><br><span class="line">    .isexperimental       &#x3D; false,                                     </span><br><span class="line">    .statenum             &#x3D; &amp;sai_metadata_enum_sai_switch_stat_t,                                                                                                                           </span><br><span class="line">&#125;;                                                   </span><br></pre></td></tr></table></figure>
<p>ç”±äºåœ¨<code>VendorSai::create</code>ä¸­è°ƒç”¨çš„æ˜¯å…¶<code>create</code>æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸‹å…¶å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;saimetadata.c</span><br><span class="line">sai_status_t sai_metadata_generic_create_SAI_OBJECT_TYPE_SWITCH(</span><br><span class="line">    _Inout_ sai_object_meta_key_t *meta_key,</span><br><span class="line">    _In_ sai_object_id_t switch_id,</span><br><span class="line">    _In_ uint32_t attr_count,</span><br><span class="line">    _In_ const sai_attribute_t *attr_list)</span><br><span class="line">&#123;             </span><br><span class="line">    return sai_metadata_sai_switch_api-&gt;create_switch(&amp;meta_key-&gt;objectkey.key.object_id, attr_count, attr_list);</span><br><span class="line">&#125;  </span><br><span class="line">&#x2F;&#x2F;sai_metadata_sai_switch_apiçš„æ•°æ®ç±»å‹æ˜¯sai_switch_api_t</span><br><span class="line">sai_switch_api_t *sai_metadata_sai_switch_api &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç»™sai_metadata_sai_switch_apièµ‹å€¼ï¼Œè·å–çš„å®é™…å°±æ˜¯sai_switch_api_tçš„å®ç°</span><br><span class="line">status &#x3D; api_query(SAI_API_SWITCH, (void**)&amp;sai_metadata_sai_switch_api);</span><br><span class="line">&#x2F;&#x2F; sai_metadata_generic_create_SAI_OBJECT_TYPE_SWITCHæ˜¯å°†switch_apiä¸­çš„createæ–¹æ³•å•ç‹¬æ‹å‡ºæ¥ï¼Œä»¥å‰çš„SAIå†’ä¼¼éƒ½æ˜¯è·å–apisï¼Œç„¶åè°ƒç”¨switch_apiï¼Œæœ€åè°ƒç”¨create_switch</span><br><span class="line">apis-&gt;switch_api &#x3D; sai_metadata_sai_switch_api;</span><br></pre></td></tr></table></figure>

<p><code>sai_switch_api_t</code>ç»“æ„ä½“çš„å®šä¹‰åœ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;saiswitch.c</span><br><span class="line">typedef struct _sai_switch_api_t</span><br><span class="line">&#123;                                                                                                                                                                                              </span><br><span class="line">    sai_create_switch_fn                   create_switch;</span><br><span class="line">    sai_remove_switch_fn                   remove_switch;</span><br><span class="line">    sai_set_switch_attribute_fn            set_switch_attribute;</span><br><span class="line">    sai_get_switch_attribute_fn            get_switch_attribute;</span><br><span class="line">    sai_get_switch_stats_fn                get_switch_stats;</span><br><span class="line">    sai_get_switch_stats_ext_fn            get_switch_stats_ext;</span><br><span class="line">    sai_clear_switch_stats_fn              clear_switch_stats;</span><br><span class="line">    sai_switch_mdio_read_fn                switch_mdio_read;</span><br><span class="line">    sai_switch_mdio_write_fn               switch_mdio_write;</span><br><span class="line">    sai_create_switch_tunnel_fn            create_switch_tunnel;</span><br><span class="line">    sai_remove_switch_tunnel_fn            remove_switch_tunnel;</span><br><span class="line">    sai_set_switch_tunnel_attribute_fn     set_switch_tunnel_attribute;</span><br><span class="line">    sai_get_switch_tunnel_attribute_fn     get_switch_tunnel_attribute;</span><br><span class="line"> </span><br><span class="line">&#125; sai_switch_api_t;</span><br></pre></td></tr></table></figure>
<p>è¯¥ç»“æ„çš„æˆå‘˜å‡½æ•°çš„å®ç°åˆ™æ˜¯ç”±å„ASICå‚å®¶å®ç°ï¼Œä»¥<code>create_switch</code>ä¸ºä¾‹ï¼Œåœ¨broadcom saiä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;brcm_sai_switch.c</span><br><span class="line">const sai_switch_api_t switch_apis &#x3D; &#123;</span><br><span class="line">    brcm_sai_create_switch,</span><br><span class="line">    brcm_sai_remove_switch,</span><br><span class="line">    brcm_sai_set_switch_attribute,</span><br><span class="line">    brcm_sai_get_switch_attribute,</span><br><span class="line">&#125;;     </span><br><span class="line">&#x2F;&#x2F; brcm_sai_create_switchå…·ä½“çš„å®ç°åˆ™ä¸è¿‡åˆ†çº ç»“äº†ï¼ŒSDKå¹²çš„æ´»   </span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸‹æ¥ï¼Œä»<code>SAI_OBJECT_TYPE_SWITCH</code>è·å–<code>tyep_info</code>ç»“æ„ï¼Œå†åˆ°createæ–¹æ³•åœ¨<code>sai</code>å±‚çš„å®šä¹‰ï¼Œä»¥åŠæœ€åçš„å‚å•†å®ç°å°±éƒ½è¿èµ·æ¥äº†ã€‚</p>
<p>æ€»ç»“ä¸‹æ¥ï¼Œ<code>VendorSai::create</code>æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">auto info &#x3D; sai_metadata_get_object_type_info(objectType);      &#x2F;&#x2F;æ ¹æ®objecttypeè·å–infoç»“æ„ï¼ŒåŒ…å«äº†è¯¥typeçš„æ‰€æœ‰æ–¹æ³•åŠå±æ€§</span><br><span class="line">auto status &#x3D; info-&gt;create(&amp;mk, switchId, attr_count, attr_list);  &#x2F;&#x2F; è°ƒç”¨typeçš„createæ–¹æ³•å®Œæˆsaiçš„è°ƒç”¨</span><br></pre></td></tr></table></figure>

<p><code>onSyncdStart</code>ä¹‹åï¼Œåˆ›å»ºçº¿ç¨‹å¤„ç†notifiyäº‹ä»¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">m_processor-&gt;startNotificationsProcessingThread();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å°†careçš„dbæ”¾åˆ°selectç›‘æ§ä¸­ï¼Œæ¥ä¸‹æ¥çš„main loopä¸­å°±æ˜¯å¾ªç¯å¤„ç†è¿™å››ä¸ªselectäº‹ä»¶</span><br><span class="line">s-&gt;addSelectable(m_selectableChannel.get());</span><br><span class="line">s-&gt;addSelectable(m_restartQuery.get());</span><br><span class="line">s-&gt;addSelectable(m_flexCounter.get());</span><br><span class="line">s-&gt;addSelectable(m_flexCounterGroup.get());</span><br></pre></td></tr></table></figure>

<h1 id="å¯¹äºæŸä¸€å…·ä½“åŠŸèƒ½çš„ä¸‹å‘"><a href="#å¯¹äºæŸä¸€å…·ä½“åŠŸèƒ½çš„ä¸‹å‘" class="headerlink" title="å¯¹äºæŸä¸€å…·ä½“åŠŸèƒ½çš„ä¸‹å‘"></a>å¯¹äºæŸä¸€å…·ä½“åŠŸèƒ½çš„ä¸‹å‘</h1><p>æ­¤å¤„ä»¥IP Tunnelçš„åˆ›å»ºä¸ºä¾‹ã€‚åœ¨swss dockerä¸­æ‰§è¡Œ<code>swssconfig ipinip.json</code>ï¼Œåœ¨<code>orchagent</code>è¿™è¾¹å¤§è‡´æµç¨‹ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;orchdaemon.cpp ä¸­ä¼šè°ƒç”¨æ¯ä¸€åŠŸèƒ½æ¨¡å—ä¸­çš„doTaskä»»åŠ¡</span><br><span class="line">TunnelDecapOrch *tunnel_decap_orch &#x3D; new TunnelDecapOrch(m_applDb, APP_TUNNEL_DECAP_TABLE_NAME);</span><br><span class="line"> m_orchList &#x3D; &#123; â€¦â€¦ gIntfsOrch, gNeighOrch, gRouteOrch, copp_orch, tunnel_decap_orch, qos_orch, â€¦â€¦&#125;;</span><br><span class="line">for (Orch *o : m_orchList)</span><br><span class="line">             o-&gt;doTask();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;tunneldecaporch.cpp</span><br><span class="line">if (addDecapTunnel(key, tunnel_type, ip_addresses, p_src_ip, dscp_mode, ecn_mode, encap_ecn_mode, ttl_mode))</span><br><span class="line">&#123;</span><br><span class="line">    SWSS_LOG_NOTICE(&quot;Tunnel(s) added to ASIC_DB.&quot;);</span><br><span class="line">&#125;</span><br><span class="line">status &#x3D; sai_tunnel_api-&gt;create_tunnel(&amp;tunnel_id, gSwitchId, (uint32_t)tunnel_attrs.size(), tunnel_attrs.data());</span><br><span class="line">&#x2F;&#x2F; ç»™æ¯ä¸€ipåˆ›å»ºä¸€ä¸ªdecap tunnel entry</span><br><span class="line">if (!addDecapTunnelTermEntries(key, dst_ip, tunnel_id))</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å°†tunnel_termå†™å…¥åˆ°ASIC DBä¸­</span><br><span class="line">sai_status_t status &#x3D; sai_tunnel_api-&gt;create_tunnel_term_table_entry(&amp;tunnel_term_table_entry_id, gSwitchId, (uint32_t)tunnel_table_entry_attrs.size(), tunnel_table_entry_attr    s.data());  </span><br><span class="line">SWSS_LOG_NOTICE(&quot;Created tunnel entry for ip: %s&quot;, ip.c_str());</span><br></pre></td></tr></table></figure>

<p><code>syncd</code>çš„mainloopä¸­æ¥æ”¶åˆ°é€šçŸ¥ï¼Œè¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;syncd.cpp</span><br><span class="line">processEvent(*m_selectableChannel.get());</span><br><span class="line"></span><br><span class="line">processSingleEvent(kco);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; createï¼Œremoveï¼Œsetï¼Œgetéƒ½æ˜¯ä½¿ç”¨è¿™ä¸€ä¸ªAPIï¼Œå¤§æ¦‚è¿™å°±æ˜¯quardçš„æ„æ€å§</span><br><span class="line">return processQuadEvent(SAI_COMMON_API_CREATE, kco);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ›å»ºçš„æ˜¯IP tunnelçš„è§£å°è£…è§„åˆ™ï¼Œå¯¹åº”çš„sai objtypeæ˜¯<code>SAI_OBJECT_TYPE_TUNNEL_TERM_TABLE_ENTRY</code>.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;syncd.cpp</span><br><span class="line">&#x2F;&#x2F; è·å–å‚æ•°åˆ—è¡¨</span><br><span class="line">auto&amp; values &#x3D; kfvFieldsValues(kco);</span><br><span class="line">sai_attribute_t *attr_list &#x3D; list.get_attr_list();</span><br><span class="line">uint32_t attr_count &#x3D; list.get_attr_count();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è·å–typeå¯¹åº”çš„infoæ•°æ®ï¼Œisnonobjectidæ˜¯false</span><br><span class="line">auto info &#x3D; sai_metadata_get_object_type_info(metaKey.objecttype);</span><br><span class="line"></span><br><span class="line">status &#x3D; processOid(metaKey.objecttype, strObjectId, api, attr_count, attr_list);</span><br><span class="line"> </span><br><span class="line">return processOidCreate(objectType, strObjectId, attr_count, attr_list);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è°ƒç”¨vendorSaiä¸­çš„createæ–¹æ³•</span><br><span class="line">sai_status_t status &#x3D; m_vendorSai-&gt;create(objectType, &amp;objectRid, switchRid, attr_count, attr_list);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åœ¨VendorSai.cppä¸­æ˜¯createæ–¹æ³•çš„å®ç°</span><br><span class="line">&#x2F;&#x2F; æ ¹æ®objecttypeè·å–infoç»“æ„</span><br><span class="line">auto info &#x3D; sai_metadata_get_object_type_info(objectType);</span><br><span class="line">&#x2F;&#x2F; è°ƒç”¨inforä¸­çš„createæ–¹æ³•</span><br><span class="line">auto status &#x3D; info-&gt;create(&amp;mk, switchId, attr_count, attr_list);</span><br><span class="line">&#x2F;&#x2F;tunnel termçš„createæ–¹æ³•åœ¨saimetadata.cä¸­</span><br><span class="line">sai_metadata_generic_create_SAI_OBJECT_TYPE_TUNNEL_TERM_TABLE_ENTRY</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æœ€åæ˜¯å‘é€é€šçŸ¥ä¿¡æ¯ç»™swss</span><br><span class="line">sendApiResponse(api, status);</span><br></pre></td></tr></table></figure>

<h1 id="å…³äºTunnelmgrd"><a href="#å…³äºTunnelmgrd" class="headerlink" title="å…³äºTunnelmgrd"></a>å…³äºTunnelmgrd</h1><p><code>swss</code>ä¸­æœ‰ä¸€ç±»è¿›ç¨‹ä»¥<code>*mgrd</code>ç»“å°¾ï¼Œå®ƒä»¬å¹²çš„æ´»æ˜¯å°†APP_DBä¸­çš„æ•°æ®åŒæ­¥åˆ°linux kernelï¼Œsonicä¸­çš„ä¸€äº›é…ç½®æ˜¯é€šè¿‡å†™APP_DBæ¥å®Œæˆçš„ï¼Œ<code>orchagent</code>å®Œæˆ<code>ASIC</code>çš„ä¸‹å‘ï¼Œ<code>*mgrd</code>å®Œæˆkernelçš„åŒæ­¥ã€‚</p>
<p>å½“ç„¶ä¹Ÿæœ‰ä¸ä¹‹ç›¸åçš„é…ç½®æµç¨‹ï¼Œå¦‚è·¯ç”±çš„ä¸‹å‘ï¼Œ<code>zebra</code>å°†è·¯ç”±ä¿¡æ¯ä¸‹å‘åˆ°kernelï¼ŒåŒæ—¶å‘é€ä¸€ä»½ä¿¡æ¯åˆ°<code>Fpmsyncd</code>ï¼Œ<code>Fpmsyncd</code>å°†å…¶å†™åˆ°<code>APP_DB</code>,æœ€å<code>orchagent</code>å°†å…¶ä¸‹å‘åˆ°<code>ASIC</code>.</p>
<p>ä¸Šé¢ä¸¤ç§æ–¹å¼çš„æœ¬è´¨å°±æ˜¯<code>kernel</code>å’Œ<code>ASIC</code>ä¹‹é—´é…ç½®çš„åŒæ­¥ã€‚</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
        <tag>syncd</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCä¸­äº¤æ¢èŠ¯ç‰‡å¯åŠ¨æµç¨‹ç®€è¿°</title>
    <url>/2021/07/21/SONiC%E4%B8%AD%E4%BA%A4%E6%8D%A2%E8%8A%AF%E7%89%87%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ¬æ–‡åŸºäºSONiC 202012åˆ†æ”¯è¿›è¡Œäº¤æ¢èŠ¯ç‰‡å¯åŠ¨æµç¨‹çš„åˆ†æã€‚æºç éƒ¨åˆ†ä¸»è¦æ¶‰åŠ<code>sonic-swss</code>å’Œ<code>sonic-sairedis</code>ä»¥åŠ<code>ocp-sai</code>. ä¸€å¥è¯è¯´æ˜æ‰€æœ‰æµç¨‹ï¼šswssæ¨¡å—é€šçŸ¥syncdæ¨¡å—è¿›è¡ŒASICåˆå§‹åŒ–ã€‚</p>
<span id="more"></span>

<h2 id="æ¨¡å—ä¸»è¦åŠŸèƒ½è¯´æ˜"><a href="#æ¨¡å—ä¸»è¦åŠŸèƒ½è¯´æ˜" class="headerlink" title="æ¨¡å—ä¸»è¦åŠŸèƒ½è¯´æ˜"></a>æ¨¡å—ä¸»è¦åŠŸèƒ½è¯´æ˜</h2><p>docker swssä¸­çš„æ¨¡å—ä¸»è¦å¯ä»¥åˆ†ä¸ºä¸‰ç±»:</p>
<ol>
<li>æ”¶é›†ä¿¡æ¯å†™å¾€APP_DBï¼Œå¦‚portsyncd, intfsyncdï¼ˆ*syncdï¼‰</li>
<li>è®¢é˜…APP_DBå°†æ•°æ®å†™å¾€ASIC_DBï¼Œå¦‚orchagentï¼ˆæ˜¯APP_DBçš„consumerï¼ŒåŒæ—¶ä¹Ÿæ˜¯ASIC_DBçš„producerï¼‰</li>
<li>æ”¶é›†æ•°æ®å†™å¾€kernelï¼Œ IntfMgrdå’ŒVlanMgrd</li>
</ol>
<p>docker syncdä¸­ä¸»è¦æ˜¯syncdæ¨¡å—ï¼Œè¯¥æ¨¡å—è®¢é˜…ASIC_DB,ä¹‹åè°ƒç”¨sai apiæ“ä½œsdk, å®Œæˆæ•°æ®çš„ä¸‹å‘ã€‚</p>
<h1 id="ä»swsså¼€å§‹"><a href="#ä»swsså¼€å§‹" class="headerlink" title="ä»swsså¼€å§‹"></a>ä»swsså¼€å§‹</h1><p>ææ¸…æ¥šASICçš„å¯åŠ¨æµç¨‹ï¼Œå®é™…ä¸Šä¸Šå°±æ˜¯å¼„æ¸…æ¥šorchagentå’Œsyncdè¿™ä¸¤ä¸ªè¿›ç¨‹çš„åˆå§‹åŒ–å’Œé€šä¿¡çš„è¿‡ç¨‹ã€‚</p>
<p>åœ¨docker syncdçš„å¯åŠ¨è„šæœ¬ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¾èµ–å…³ç³»ã€‚<br><img src="https://rancho333.github.io/pictures/syncd_service.png"></p>
<p>docker swssä¸­orchagentè´Ÿè´£é€šçŸ¥syncdè¿›è¡ŒASICåˆå§‹åŒ–ï¼Œ å¯¹äºorchagentä¸»è¦ç†è§£ä¸‹é¢ä¸¤è¡Œä»£ç ï¼š<br><img src="https://rancho333.github.io/pictures/orchagent_init.png"></p>
<p>è¿™é‡Œç®€è¦è¯´æ˜ä¸€ä¸‹<code>OCP SAI</code>çš„å·¥ä½œæ–¹å¼ï¼Œå¯¹åº”çš„æºç åœ¨<code>src/sonic-sairedis/SAI</code>, è¿™é‡Œé¢å®šä¹‰äº†saiçš„dataä»¥åŠfunctionsï¼Œè¿˜æœ‰ä¸€äº›metadataæ“ä½œæ–¹å¼ï¼Œè€Œæ•°æ®çš„åˆå§‹åŒ–ä»¥åŠå‡½æ•°çš„å®ç°ç”±èŠ¯ç‰‡å‚å•†å®ç°ï¼Œé€šè¿‡åŠ¨æ€åº“çš„æ–¹å¼æä¾›ã€‚syncdç¼–è¯‘æ—¶ä¼šé“¾æ¥åˆ°libsaiï¼Œè¿™æ ·æˆ‘ä»¬åœ¨syncdä¸­å°±å¯ä»¥è°ƒç”¨sai apiå®Œæˆå¯¹SDKçš„æ§åˆ¶ã€‚</p>
<p>ä¸æ­¤ç±»ä¼¼çš„ï¼Œåœ¨<code>sonic-sairedis</code>ä¸­æä¾›ä¸€ä¸ªlibsairedisçš„åŠ¨æ€åº“(æºç åœ¨<code>src/sonic-sairedis/lib</code>)ï¼Œè¿™é‡Œé¢åŒæ ·å¯¹ocp saiè¿›è¡Œå®ç°ï¼Œä¸è¿‡å®ç°çš„å¯¹è±¡æ˜¯redisï¼Œè¿™æ ·åœ¨orchagentä¸­å°±å¯ä»¥è°ƒç”¨sai apiå®Œæˆå¯¹redisçš„æ“ä½œã€‚</p>
<p>å¯¹äº<code>initSaiApi</code>ï¼š<br><img src="https://rancho333.github.io/pictures/saiapi_init.png"></p>
<p>å¯¹äº<code>sai_api_query</code>, åœ¨<code>src/sonic-sairedis/SAI/inc/sai.h</code>ä¸­æ˜¯å¯¹å…¶çš„å®šä¹‰ï¼Œåœ¨<code>src/sonic-sairedis/lib/src/sai_redis_interfacequery.cpp</code>ä¸­æ˜¯å¯¹å…¶çš„å®ç°ã€‚å€Ÿç”¨<code>API</code>å®å®Œæˆå¯¹å…¶åˆå§‹åŒ–ã€‚<br><img src="https://rancho333.github.io/pictures/saiapi_query.png"></p>
<p>æ³¨æ„<code>sai_apis_t</code>ç»“æ„ä½“æ˜¯<code>src/sonic-sairedis/SAI/meta/parse.pl</code>perlè„šæœ¬è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œç”Ÿæˆçš„æ–‡ä»¶åä¸º<code>saimetadata.h</code>,ç»“æ„ä½“æˆå‘˜ä¸ºå„åŠŸèƒ½æ¨¡å—çš„ç»“æ„ä½“æŒ‡é’ˆã€‚</p>
<p>ä»¥<code>sai_switch_api</code>ä¸ºä¾‹ï¼š<br><img src="https://rancho333.github.io/pictures/sai_switch_api.png"><br>åˆ°è¿™é‡Œå°±å®Œæˆäº†å¯¹OCP SAIçš„å°è£…è°ƒç”¨ï¼Œè€Œæœ€åå¯¹redisçš„æ“ä½œï¼Œ201911ä¹‹åçš„ç‰ˆæœ¬ï¼Œå®é™…çš„redisæ“ä½œå‡½æ•°éƒ½ä½¿ç”¨å®æ¥ç”Ÿæˆã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REDIS_GENERIC_QUAD</span><br><span class="line">REDIS_CREATE</span><br></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†æ“ä½œçš„å°±æ˜¯å°†<code>create_switch</code>çš„ä¿¡æ¯å†™åˆ°<code>ASIC_DB</code>, <code>syncd</code>è¿›ç¨‹æ”¶åˆ°å‘å¸ƒçš„æ¶ˆæ¯ä¹‹åè¿›è¡ŒçœŸæ­£çš„SDKåˆå§‹åŒ–æ“ä½œã€‚<br><img src="https://rancho333.github.io/pictures/syslog.png"></p>
<h2 id="create-switchåˆ†æ"><a href="#create-switchåˆ†æ" class="headerlink" title="create_switchåˆ†æ"></a>create_switchåˆ†æ</h2><p><code>redis_create_switch</code>å‡½æ•°ç”±å®å®šä¹‰å±•å¼€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REDIS_GENERIC_QUAD(OT,ot)        sai_redis.h</span><br><span class="line">REDIS_CREATE(OT,ot)              sai_redis.h</span><br></pre></td></tr></table></figure>
<p><img src="https://rancho333.github.io/pictures/define_redis_create.png"></p>
<p><code>redis_sai</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">std::shared_ptr&lt;SaiInterface&gt; redis_sai &#x3D; std::make_shared&lt;ClientServerSai&gt;();    sai_redis_interfacequery.cpp</span><br><span class="line"></span><br><span class="line">SaiInterfaceæ˜¯çˆ¶ç±»ï¼Œ ClientServerSaiæ˜¯å…¶å­ç±»</span><br><span class="line">                    RemoteSaiInterfaceåŒæ ·æ˜¯SaiInterfaceå­ç±»</span><br><span class="line">                        RedisRemoteSaiInterfaceåˆæ˜¯RemoteSaiInterfaceçš„å­ç±»</span><br></pre></td></tr></table></figure>
<p><code>redis_sai</code>çš„æŒ‡é’ˆç±»å‹æ˜¯<code>SaiInterface</code>ï¼Œæ ¹æ®C++çš„å¤šæ€ç‰¹æ€§ï¼Œ<code>redis_sai-&gt;create</code>çš„æœ€ç»ˆå®ç°åœ¨ï¼š<br><img src="https://rancho333.github.io/pictures/redis_sai_create.png"></p>
<h1 id="syncdåˆå§‹åŒ–ASIC"><a href="#syncdåˆå§‹åŒ–ASIC" class="headerlink" title="syncdåˆå§‹åŒ–ASIC"></a>syncdåˆå§‹åŒ–ASIC</h1><p>ç›´æ¥ä»åˆå§‹åŒ–sai apiå¼€å§‹(ç”±äº201911ä¹‹åçš„ç‰ˆæœ¬syncdæ¨¡å—é‡æ„äº†ï¼Œå˜å¾—æ›´åŠ éš¾çœ‹ï¼Œä¸‹é¢çš„åˆ†æåŸºäº201911ç‰ˆæœ¬ï¼ŒåŸºæœ¬æµç¨‹éƒ½å·®ä¸å¤š)ï¼š<br><img src="https://rancho333.github.io/pictures/syncd_saiapi_init.png"></p>
<p>åœ¨mainloopé‡Œé¢è¿›å…¥<code>processEvent</code>æµç¨‹ï¼Œé‡Œé¢è¿›å…¥<code>initviewmode</code>:<br><img src="https://rancho333.github.io/pictures/initview_mode.png"></p>
<p>ä¹‹åï¼š<br><img src="https://rancho333.github.io/pictures/on_switch_create.png"></p>
<p>ç„¶åè°ƒç”¨sai apiå®Œæˆäº¤æ¢èŠ¯ç‰‡åˆå§‹åŒ–æŒ‡ä»¤çš„ä¸‹å‘ï¼š<br><img src="https://rancho333.github.io/pictures/create_switch.png"></p>
<p>æœ€åå°±æ˜¯saiæ¨¡å—ä¸­å‚å•†å¯¹åº”çš„å®ç°ï¼š<br><img src="https://rancho333.github.io/pictures/brcm_sai.png"></p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCå¯åŠ¨ç®€è¿°</title>
    <url>/2021/01/29/SONiC%E5%90%AF%E5%8A%A8%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>sonicåœ¨åˆå§‹åŒ–çš„æ—¶å€™æ˜¯æ€æ ·è¯†åˆ«platformçš„ï¼Œ<br>/host/machine.conf<br>/etc/sonic/config_db.json</p>
<span id="more"></span>
<p>/etc/rc.local</p>
<h2 id="platformç›¸å…³"><a href="#platformç›¸å…³" class="headerlink" title="platformç›¸å…³"></a>platformç›¸å…³</h2><p>åœ¨<code>device_info.py</code>ä¸­ä¼šé€šè¿‡è¯»å–<code>/host/machine.conf</code>é…ç½®æ–‡ä»¶æ¥è·å–platformçš„åç§°</p>
<h2 id="hwskuç›¸å…³"><a href="#hwskuç›¸å…³" class="headerlink" title="hwskuç›¸å…³"></a>hwskuç›¸å…³</h2><p>åœ¨<code>device_info.py</code>ä¸­ä¼šé€šè¿‡è¯»å–ConfigDBæ¥è·å–hwsku, å¦‚æœåœ¨<code>show version</code>ä¸­æ²¡æœ‰çœ‹åˆ°hwskuï¼Œé‚£ä¹ˆéœ€è¦é…ç½®config_db.jsoné…ç½®æ–‡ä»¶æ¥åŠ è½½é…ç½®ä¿¡æ¯ï¼Œé‡å¯åç”Ÿæ•ˆã€‚</p>
<h2 id="chassisç›¸å…³"><a href="#chassisç›¸å…³" class="headerlink" title="chassisç›¸å…³"></a>chassisç›¸å…³</h2><p>ä»¥pmonçš„dockerçš„psudä¸ºä¾‹ï¼Œå…ˆè·å–<code>platform_chassis</code>ï¼Œå¯¹äºchassisçš„åˆå§‹åŒ–ï¼Œå…³æ³¨platform_base.pyã€platform.pyä»¥åŠchassis.pyè¿™ä¸‰ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­chassis.pyä¸­å®Œæˆchassisçš„å®ä¾‹åŒ–ï¼Œä¸€èˆ¬åŒ…æ‹¬syseepromã€watchdogã€fanã€thermalã€psuã€sfpã€componentã€‚</p>
<p>chassis.pyæ˜¯å‚å•†çš„sonic_platformåŒ…é‡Œé¢æä¾›çš„æ–‡ä»¶ï¼Œpmonçš„dockeråˆ›å»ºçš„æ—¶å€™ä¼šæ ¹æ®platformæŒ‚è½½å¯¹åº”çš„sonic_platformåŒ…ï¼Œæ‰€ä»¥èƒ½ä¿è¯åŠ è½½æ­£ç¡®çš„æ¿å­çš„å¤–è®¾ã€‚</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCæ·»åŠ æ–°çš„device</title>
    <url>/2020/12/31/SONiC%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84device/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>SONiCé¡¹ç›®ä¸­ï¼Œæœ‰æ—¶å€™å‚å•†éœ€è¦æ·»åŠ è‡ªå·±æ–°çš„deviceä¸Šå»ã€‚</p>
<ol>
<li>éœ€è¦æ·»åŠ é‚£äº›ä¸œè¥¿ï¼Ÿ</li>
<li>æ€ä¹ˆç¼–è¯‘è¿›æ–‡ä»¶ç³»ç»Ÿï¼Ÿ<span id="more"></span></li>
<li>SONiCå¯åŠ¨æ—¶æ˜¯å¦‚ä½•é€‰æ‹©å¯¹åº”è®¾å¤‡çš„æ–‡ä»¶ï¼Ÿ</li>
</ol>
<p>ææ¸…æ¥šè¿™ä¸‰ä¸ªé—®é¢˜åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹deviceè¿›è¡Œè£å‰ªï¼ˆSONiCé»˜è®¤ä¼šå°†deviceç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶æ‹·è´è¿›æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚</p>
<h1 id="ç›®å½•ç»“æ„åŠæ·»åŠ å†…å®¹"><a href="#ç›®å½•ç»“æ„åŠæ·»åŠ å†…å®¹" class="headerlink" title="ç›®å½•ç»“æ„åŠæ·»åŠ å†…å®¹"></a>ç›®å½•ç»“æ„åŠæ·»åŠ å†…å®¹</h1><p>ä¸è®¾å¤‡ç¡¬ä»¶è€¦åˆçš„æ–‡ä»¶å¤¹æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>platform</code>ä¸<code>device</code>ï¼Œ<code>platform</code>æè¿°ASICï¼Œå‚å•†è®¾å¤‡é©±åŠ¨ä»£ç ä»¥åŠnew platform APIçš„é€‚é…ï¼›<code>device</code>æè¿°å‚å•†è®¾å¤‡ä»£ç ï¼Œå…¶ä¸­åŒ…æ‹¬ç«¯å£é…ç½®ï¼Œledé…ç½®ï¼Œsaié…ç½®ç­‰ä¿¡æ¯ï¼Œ<code>plugins</code>æ–‡ä»¶å¤¹æ˜¯ä¸€äº›å¤–è®¾å‘½ä»¤é€‚é…çš„pythonä»£ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sonic-buildimage&#x2F;</span><br><span class="line">    platform&#x2F;            # asicç›¸å…³ï¼Œé‡ç‚¹å…³æ³¨saiä»¥åŠsonic-platform.bin</span><br><span class="line">        broadcom&#x2F;        </span><br><span class="line">    device              # è®¾å¤‡ç›¸å…³ï¼Œå¯¹è®¾å¤‡ç¡¬ä»¶ç‰¹æ€§çš„æ§åˆ¶æè¿°ï¼Œå¦‚ç«¯å£ï¼Œledï¼Œconsoleï¼›ä»¥åŠå’Œç¡¬ä»¶ç›¸å…³çš„å‘½ä»¤çš„åº•å±‚é€‚é…æ¥å£ï¼Œå¦‚å¡«å…¥eepromçš„åœ°å€ï¼Œä¹‹åä½¿ç”¨SONiCçš„è§£æå™¨è¿›è¡Œè§£æã€‚å¯¹äºSONiCçš„å‘½ä»¤ä½“ç³»ï¼Œå¯ä»¥å†å†™ä¸€ç¯‡æ–‡æ¡£</span><br><span class="line">        celestica&#x2F;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>platform</code>ä¸­æœ‰ä¸ª<code>sonic-platform</code>çš„æ–‡ä»¶å¤¹ï¼Œè¿™é‡Œé¢åŒ…å«äº†eepromã€fanã€psuç­‰å¤–è®¾ç›¸å…³çš„æ–‡ä»¶ï¼Œä¸<code>device</code>é‡Œé¢çš„æ–‡ä»¶å®é™…ä¸Šæ˜¯æœ‰é‡å¤çš„ï¼Œè¿™å¯èƒ½æ˜¯SONiCçš„å†å²é—ç•™é—®é¢˜ï¼Œåœ¨å­—èŠ‚é¡¹ç›®ä¸­æœ‰è®¨è®ºè¿‡åç»­ä¼šå°†å¤–è®¾ç›¸å…³çš„å¤„ç†å…¨éƒ¨æ”¾åˆ°<code>platform</code>ä¸­å»ã€‚</p>
<p>å¯¹äºç«¯å£é€‚é…è¿™äº›å†…å®¹ä¸ç†Ÿæ‚‰ï¼Œåœ¨æ­¤åªåšç®€å•ä»‹ç»ã€‚</p>
<h1 id="ç¼–è¯‘ç›¸å…³"><a href="#ç¼–è¯‘ç›¸å…³" class="headerlink" title="ç¼–è¯‘ç›¸å…³"></a>ç¼–è¯‘ç›¸å…³</h1><h2 id="deviceçš„ç¼–è¯‘"><a href="#deviceçš„ç¼–è¯‘" class="headerlink" title="deviceçš„ç¼–è¯‘"></a>deviceçš„ç¼–è¯‘</h2><p><code>device</code>ä¸­çš„æ•°æ®ä¼šæ‰“åŒ…åˆ°<code>sonic-device-data_1.0-1_all.deb</code>, å…·ä½“æ˜¯åœ¨<code>src/sonic-device-data/Makefile</code>å®ç°æ–‡ä»¶æ‹·è´ç„¶åæ‰“åŒ…æˆdeb</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$(addprefix $(DEST)&#x2F;, $(MAIN_TARGET)): $(DEST)&#x2F;% :                                       </span><br><span class="line">    pushd .&#x2F;src                     </span><br><span class="line">                                    </span><br><span class="line">    # Remove any stale data         </span><br><span class="line">    rm -rf .&#x2F;device                 </span><br><span class="line">                                    </span><br><span class="line">    # Create a new dir and copy all ONIE-platform-string-named dirs into it              </span><br><span class="line">    mkdir .&#x2F;device                  </span><br><span class="line">    cp -r -L ..&#x2F;..&#x2F;..&#x2F;device&#x2F;*&#x2F;* .&#x2F;device&#x2F;                                               </span><br><span class="line">                                    </span><br><span class="line">    # Create hwsku for virtual switch</span><br><span class="line">    for d in &#96;find -L ..&#x2F;..&#x2F;..&#x2F;device -maxdepth 3 -mindepth 3 -type d | grep -vE &quot;(plugins|led-code)&quot;&#96;; do \</span><br><span class="line">        cp -Lr $$d device&#x2F;x86_64-kvm_x86_64-r0&#x2F; ; \                                      </span><br><span class="line">        cp .&#x2F;sai.vs_profile device&#x2F;x86_64-kvm_x86_64-r0&#x2F;$$(basename $$d)&#x2F;sai.profile; \  </span><br><span class="line">        grep -v ^# device&#x2F;x86_64-kvm_x86_64-r0&#x2F;$$(basename $$d)&#x2F;port_config.ini | awk &#39;&#123;i&#x3D;i+1;print &quot;eth&quot;i&quot;:&quot;$$2&#125;&#39; &gt; device&#x2F;x86_64-kvm_x86_64-r0&#x2F;$$(basename $$d)&#x2F;lanemap.ini</span><br><span class="line">    done;                           </span><br><span class="line">                                    </span><br><span class="line">    # Build the package                                                                                                                                       </span><br><span class="line">    dpkg-buildpackage -rfakeroot -b -us -uc</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>src/sonic-device-data/src/Makefile</code>ä¸­æœ‰configå’Œmediaçš„æµ‹è¯•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test:</span><br><span class="line">    # Execute Broadcom config file test</span><br><span class="line">    pushd ..&#x2F;tests&#x2F;</span><br><span class="line">    for f in $$(find ..&#x2F;..&#x2F;..&#x2F;device -name &quot;*.config.bcm&quot;); do</span><br><span class="line">        .&#x2F;config_checker $$f</span><br><span class="line">    done</span><br><span class="line">    for f in $$(find ..&#x2F;..&#x2F;..&#x2F;device -name media_settings.json); do                                                                                           </span><br><span class="line">        .&#x2F;media_checker $$f</span><br><span class="line">    done</span><br><span class="line">    popd</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>dpkg -X target/debs/stretch/sonic-device-data_1.0-1_all.deb</code>æˆ–è€…åœ¨<code>fsroot/usr/share/sonic/device/</code>ç›®å½•ä¸‹å¯ä»¥å‘ç°<code>device</code>ç›¸å…³çš„æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶ä¸è®¾å¤‡ç›®å½•ä¸Š<code>/usr/share/sonic/device/</code>çš„æ–‡ä»¶ç›¸å¯¹åº”ã€‚<br>åœ¨<code>sonic_debian_extension.sh</code>è„šæœ¬ä¸­ä¼šå°†å…¶é‡Šæ”¾åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­å»ã€‚<br><img src="https://rancho333.github.io/pictures/device_data.png"><br>æ³¨æ„ï¼Œåœ¨slave.mkä¸­æ“ä½œä¸€ä¸‹æ‰èƒ½çœ‹åˆ°è„šæœ¬ï¼Œå¦åˆ™å®ƒåšä¸ºä¸­é—´æ–‡ä»¶ï¼Œç¼–è¯‘å®Œæˆåä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-       $(if $($*_DOCKERS),</span><br><span class="line">-               rm sonic_debian_extension.sh,</span><br><span class="line">-       )</span><br><span class="line">+#      $(if $($*_DOCKERS),</span><br><span class="line">+#              rm sonic_debian_extension.sh,</span><br><span class="line">+#      )</span><br><span class="line"> </span><br><span class="line">        chmod a+x $@</span><br><span class="line">        $(FOOTER)</span><br></pre></td></tr></table></figure>

<p>å¯¹äºportingè€Œè¨€ï¼Œå¯ä»¥ä¿®æ”¹Makefileä¸­cmdçš„è§„åˆ™ï¼Œåªæ‹·è´éœ€è¦çš„deviceå’Œåªè¿›è¡Œä¸ä¹‹å¯¹åº”çš„testã€‚</p>
<h2 id="platformçš„ç¼–è¯‘"><a href="#platformçš„ç¼–è¯‘" class="headerlink" title="platformçš„ç¼–è¯‘"></a>platformçš„ç¼–è¯‘</h2><p><code>slave.mk</code>æ˜¯SONiCé¡¹ç›®çœŸæ­£çš„Makefileï¼Œæ‰€æœ‰çš„ç¼–è¯‘è§„åˆ™åœ¨é‡Œé¢å¯ä»¥æ‰¾åˆ°ï¼Œ<code>platform</code>çš„å…¥å£åœ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifneq ($(CONFIGURED_PLATFORM), undefined)</span><br><span class="line">include $(PLATFORM_PATH)&#x2F;rules.mk</span><br><span class="line">endif </span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åœ¨æ‰§è¡Œ<code>make configure PLATFORM=platform</code>æ—¶ä¼šæŒ‡å®šplatformï¼Œä»è€Œæ‰¾åˆ°å¯¹åº”çš„rules.mkã€‚</p>
<p><img src="https://rancho333.github.io/pictures/rules_mk.png"></p>
<p>è¿™é‡Œé¢å…³æ³¨ä¸‰ä¸ªæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sai.mk                          # æŒ‡å®šSAIç‰ˆæœ¬ä»¥åŠä¸‹è½½è·¯å¾„</span><br><span class="line">platform-modules-device.mk      # æŒ‡å®šè®¾å¤‡platformæºæ–‡ä»¶è·¯å¾„ï¼Œç¼–è¯‘æ‰“åŒ…æˆdebian</span><br><span class="line">one-image.mk                    # æŒ‡å®šSONiCç³»ç»Ÿå®‰è£…é•œåƒåç§°</span><br></pre></td></tr></table></figure>
<p>saiç”±ASICå‚å•†ç»´æŠ¤ï¼Œä½œä¸ºè®¾å¤‡å‚å•†ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å³å¯ã€‚Makefileä¸­é€šè¿‡æŒ‡å®šurlåœ¨ç¼–è¯‘æ—¶ä¸‹è½½æŒ‡å®šç‰ˆæœ¬saiï¼Œå¯¹äºæ­¤ç±»é‡è¦çš„æ¨¡å—æ–‡ä»¶ï¼Œå¯ä»¥å°†ä¹‹ç¼“å­˜åˆ°æœ¬åœ°ï¼ŒæŒ‡å®šæœ¬åœ°urlè¿›è¡Œä½¿ç”¨ã€‚</p>
<p>å¯¹äºè®¾å¤‡å‚å•†çš„platformï¼Œé€šè¿‡åœ¨<code>rules.mk</code>ä¸­å¢åˆ  <em><strong>platform-modules-device.mk</strong></em> å¯ä»¥å®ç°åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ·»åŠ æˆ–åˆ é™¤è®¾å¤‡å‚å•†platformçš„<code>device</code>æ¨¡å—</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff --git a&#x2F;platform&#x2F;broadcom&#x2F;rules.mk b&#x2F;platform&#x2F;broadcom&#x2F;rules.mk</span><br><span class="line">index 8dd7b2c8..91e3afd3 100644</span><br><span class="line">--- a&#x2F;platform&#x2F;broadcom&#x2F;rules.mk</span><br><span class="line">+++ b&#x2F;platform&#x2F;broadcom&#x2F;rules.mk</span><br><span class="line">@@ -1,7 +1,7 @@</span><br><span class="line"> include $(PLATFORM_PATH)&#x2F;sai-modules.mk</span><br><span class="line"> include $(PLATFORM_PATH)&#x2F;sai.mk</span><br><span class="line">-include $(PLATFORM_PATH)&#x2F;platform-modules-dell.mk</span><br><span class="line">-include $(PLATFORM_PATH)&#x2F;platform-modules-arista.mk</span><br><span class="line">+#include $(PLATFORM_PATH)&#x2F;platform-modules-dell.mk</span><br><span class="line">+#include $(PLATFORM_PATH)&#x2F;platform-modules-arista.mk</span><br><span class="line"> include $(PLATFORM_PATH)&#x2F;platform-modules-ingrasys.mk</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åœ¨<code>one-image.mk</code>ä¸­å¢åˆ <code>**_PLATFORM_MODULE</code>å¯ä»¥é€‰æ‹©å°†åœ¨<code>platform-modules-device.mk</code>ä¸­ç¼–è¯‘å¥½çš„å¯¹åº”æœºå‹çš„debåŒ…æ‹·è´åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff --git a&#x2F;platform&#x2F;broadcom&#x2F;one-image.mk b&#x2F;platform&#x2F;broadcom&#x2F;one-image.mk</span><br><span class="line">index 8cbf7269..edc51460 100644</span><br><span class="line">--- a&#x2F;platform&#x2F;broadcom&#x2F;one-image.mk</span><br><span class="line">+++ b&#x2F;platform&#x2F;broadcom&#x2F;one-image.mk</span><br><span class="line">@@ -54,8 +54,8 @@ $(SONIC_ONE_IMAGE)_LAZY_INSTALLS +&#x3D; $(DELL_S6000_PLATFORM_MODULE) \</span><br><span class="line">                                $(ALPHANETWORKS_SNH60B0_640F_PLATFORM_MODULE) \</span><br><span class="line">                                $(BRCM_XLR_GTS_PLATFORM_MODULE) \</span><br><span class="line">                                $(DELTA_AG9032V2A_PLATFORM_MODULE) \</span><br><span class="line">-                               $(JUNIPER_QFX5210_PLATFORM_MODULE) \</span><br><span class="line">-                               $(CEL_SILVERSTONE_PLATFORM_MODULE)</span><br><span class="line">+                               #$(JUNIPER_QFX5210_PLATFORM_MODULE) \</span><br><span class="line">+                               #$(CEL_SILVERSTONE_PLATFORM_MODULE)</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ‰“åŒ…å¥½çš„platformæ–‡ä»¶ï¼Œä¼šåœ¨<code>sonic_debian_extension.sh</code>ä¸­æ‹·è´åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­å»<br><img src="https://rancho333.github.io/pictures/platform_module.png"></p>
<p>ä¸Šé¢è¿™å¼ å›¾ç‰‡ä¸Šå°±æ˜¯è£å‰ªè¿‡ååªä¼šæ‹·è´<code>cel-b3010</code>è¿™ä¸€æ¬¾æœºå‹çš„platformã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç ”ç©¶ä¸‹æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p>åœ¨SONiCçš„å®‰è£…é•œåƒç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä¼šåœ¨<code>rc.local</code>ä¸­å°†å…¶é‡Šæ”¾åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­å».<br><img src="https://rancho333.github.io/pictures/platform_module_2.png"></p>
<p>å¯¹äº<code>platform-modules-*_amd64.deb</code>ï¼Œé‡Œé¢åŒ…å«äº†deviceçš„é©±åŠ¨ï¼Œä¼šåœ¨systemdä¸­æ·»åŠ æœåŠ¡å®Œæˆé©±åŠ¨çš„åŠ è½½ã€‚è¿™ä¸ªdebçš„ç”Ÿæˆè§„åˆ™å‚è§<code>platform/broadcom/sonic-platform-modules-cel/debian/</code>ï¼Œä¸»è¦ä¿®æ”¹å¦‚ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rules</span><br><span class="line">control</span><br></pre></td></tr></table></figure>
<p>ä»¥åŠæ·»åŠ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">platform-modules-ivystone.init</span><br><span class="line">platform-modules-ivystone.install</span><br><span class="line">platform-modules-ivystone.postinst</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ç¼–è¯‘<code>platform-modules-*_amd64.deb</code>çš„è§„åˆ™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CEL_DX010_PLATFORM_MODULE &#x3D; platform-modules-dx010_$(CEL_DX010_PLATFORM_MODULE_VERSION)_amd64.deb</span><br><span class="line">$(CEL_DX010_PLATFORM_MODULE)_SRC_PATH &#x3D; $(PLATFORM_PATH)&#x2F;sonic-platform-modules-cel</span><br><span class="line">$(CEL_DX010_PLATFORM_MODULE)_DEPENDS +&#x3D; $(LINUX_HEADERS) $(LINUX_HEADERS_COMMON)</span><br><span class="line">$(CEL_DX010_PLATFORM_MODULE)_PLATFORM &#x3D; x86_64-cel_seastone-r0</span><br><span class="line">SONIC_DPKG_DEBS +&#x3D; $(CEL_DX010_PLATFORM_MODULE)</span><br><span class="line">           </span><br><span class="line">CEL_HALIBURTON_PLATFORM_MODULE &#x3D; platform-modules-haliburton_$(CEL_HALIBURTON_PLATFORM_MODULE_VERSION)_amd64.deb</span><br><span class="line">$(CEL_HALIBURTON_PLATFORM_MODULE)_PLATFORM &#x3D; x86_64-cel_e1031-r0</span><br><span class="line">$(eval $(call add_extra_package,$(CEL_DX010_PLATFORM_MODULE),$(CEL_HALIBURTON_PLATFORM_MODULE)))</span><br></pre></td></tr></table></figure>
<p>åœ¨slave.mkä¸­ä¼šæœ‰ç¼–è¯‘SONIC_DPKG_DEBSçš„å‘½ä»¤ï¼Œåªæœ‰CEL_DX010_PLATFORM_MODULEæ˜¯æ˜¾ç¤ºçš„æ·»åŠ åˆ°SONIC_DPKG_DEBS</p>
<h1 id="SONiCå¯åŠ¨ç®€è¿°"><a href="#SONiCå¯åŠ¨ç®€è¿°" class="headerlink" title="SONiCå¯åŠ¨ç®€è¿°"></a>SONiCå¯åŠ¨ç®€è¿°</h1><p>å¯¹äºä»onieä¸‹é¢å®‰è£…SONiCï¼Œåœ¨onieä¸‹é¢ä¼šç»´æŠ¤ä¸€ä¸ª<code>machine.conf</code>æ–‡ä»¶ï¼Œè¿™é‡Œé¢æœ‰è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¹‹åSONiCä¼šæ ¹æ®è¿™é‡Œçš„ä¿¡æ¯å®Œæˆåˆå§‹åŒ–çš„æ–‡ä»¶åŠ è½½æµç¨‹ã€‚</p>
<p>å¯¹äºä»SONiCä¸‹é¢ç›´æ¥å®‰è£…SONiCï¼Œä¿®æ”¹grubï¼Œæš‚ä¸åšæ·±å…¥ç ”ç©¶ã€‚</p>
<p>å¯¹äºsystemdçš„åˆå§‹åŒ–ï¼ŒSDKçš„åˆå§‹åŒ–ï¼Œplatform/chassisçš„åˆå§‹åŒ–ï¼Œåç»­æœ‰éœ€è¦åœ¨ç»§ç»­ç ”ç©¶ã€‚</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCç¼–è¯‘ç®€è¿°åŠä¼˜åŒ–</title>
    <url>/2020/12/15/SONiC%E7%BC%96%E8%AF%91%E7%AE%80%E8%BF%B0%E5%8F%8A%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>SONiCåœ¨dockerä¸­å®Œæˆç¼–è¯‘ï¼Œdocker imageåŸºäºdebian(jessie, stretch, buster)å®Œæˆæ„å»ºã€‚201807åŠå…¶ä¹‹å‰çš„ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯jessie, 202006åŠå…¶ä¹‹åçš„ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯buster, æˆ‘ä»¬ç°é˜¶æ®µä¸»è¦ä½¿ç”¨stretchã€‚SONiCçš„ç¼–è¯‘å¤§è‡´åˆ†æˆä¸‰ä¸ªé˜¶æ®µã€‚</p>
<span id="more"></span>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. git submodulesåˆå§‹åŒ–ã€‚å¯¹åº”make init</span><br><span class="line">2. ç¼–è¯‘ç¯å¢ƒæ„å»ºã€‚å¯¹åº”çš„æ˜¯Makefile.workä¸­çš„DOCKER_BASE_BUILDä¸DOCKER_BUILDï¼Œç¼–è¯‘ç¯å¢ƒåªéœ€è¦åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è¿›è¡Œæ„å»ºã€‚</span><br><span class="line">3. ä¸»ç›®æ ‡ç¼–è¯‘ï¼ˆsonic-platform.binï¼‰ã€‚è¿™é‡Œé¢å¯ä»¥åˆ†ä¸ºkernelç¼–è¯‘ï¼Œå¤–éƒ¨åŠŸèƒ½ç¼–è¯‘ï¼ˆplatform, srcç­‰ï¼‰ï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿçš„æ„å»ºã€‚å¯¹åº”çš„æ˜¯make target&#x2F;sonic-platform.bin.</span><br></pre></td></tr></table></figure>

<h1 id="submodulesåˆå§‹åŒ–ä¼˜åŒ–å»ºè®®"><a href="#submodulesåˆå§‹åŒ–ä¼˜åŒ–å»ºè®®" class="headerlink" title="submodulesåˆå§‹åŒ–ä¼˜åŒ–å»ºè®®"></a>submodulesåˆå§‹åŒ–ä¼˜åŒ–å»ºè®®</h1><p>æ‰§è¡Œ<code>make init</code>ä¹‹å‰ï¼Œé¡¹ç›®æ–‡ä»¶å¤§å°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho git]$ du -h --max-depth&#x3D;1</span><br><span class="line">76M     .&#x2F;bytedance-sonic</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¹‹åçš„é¡¹ç›®æ–‡ä»¶å¤§å°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho git]$ du -h --max-depth&#x3D;1</span><br><span class="line">1.9G     .&#x2F;bytedance-sonic</span><br></pre></td></tr></table></figure>
<p>æ•´ä¸ªè¿‡ç¨‹è€—æ—¶çº¦22åˆ†é’Ÿï¼ˆç½‘ç»œç¯å¢ƒä¸åŒä¼šæœ‰å·®å¼‚ï¼‰ï¼Œæ€»å…±27ä¸ªå¤–éƒ¨modulesã€‚åªä¼šåœ¨ç¬¬ä¸€æ¬¡ç¼–è¯‘é¡¹ç›®æ—¶è¿›è¡Œæ„å»ºã€‚åŸºäºé¡¹ç›®ç®¡æ§ä»¥åŠå­æ¨¡å—è‡ªå¼€å‘çš„è§’åº¦ï¼Œåç»­å¯ä»¥å°†modulesè¿ç§»åˆ°å†…éƒ¨gitlabä¸Šã€‚å­—èŠ‚é¡¹ç›®ä¸­çš„sonic-platform-commonæ¨¡å—ç°åœ¨å°±æ˜¯è¿™æ ·ç®¡ç†çš„ã€‚</p>
<h1 id="ç¼–è¯‘ç¯å¢ƒæ„å»ºçš„ä¼˜åŒ–"><a href="#ç¼–è¯‘ç¯å¢ƒæ„å»ºçš„ä¼˜åŒ–" class="headerlink" title="ç¼–è¯‘ç¯å¢ƒæ„å»ºçš„ä¼˜åŒ–"></a>ç¼–è¯‘ç¯å¢ƒæ„å»ºçš„ä¼˜åŒ–</h1><p>SONiCé€šè¿‡Dockerfileå¯¹æ¯ä¸ªç”¨æˆ·éƒ½æ„å»ºä¸€ä¸ªç¼–è¯‘ç¯å¢ƒï¼Œå¯¹äºå•ç”¨æˆ·ç¯å¢ƒè¿™ç§æ–¹å¼åˆé€‚ï¼Œå¯¹äºä½¿ç”¨LinuxæœåŠ¡å™¨çš„<strong>å¤šç”¨æˆ·ç¯å¢ƒ</strong>è€Œè¨€ï¼Œè¿™ç§æ–¹å¼å¾ˆä¸åˆé€‚ï¼Œdocker imageåº”è¯¥ç»™æ‰€æœ‰ç”¨æˆ·å¤ç”¨ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ªç”¨æˆ·æ„å»ºä¸€ä¸ªå†…å®¹ç›¸åŒåªæ˜¯åå­—ä¸åŒçš„imageã€‚</p>
<h2 id="ç¼ºç‚¹è¯´æ˜"><a href="#ç¼ºç‚¹è¯´æ˜" class="headerlink" title="ç¼ºç‚¹è¯´æ˜"></a>ç¼ºç‚¹è¯´æ˜</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. æ¶ˆè€—å¤§é‡å­˜å‚¨èµ„æºã€‚å¯ä½¿ç”¨docker images | grep sonic æŸ¥çœ‹ã€‚</span><br><span class="line">2. æ¶ˆè€—å¤§é‡ç½‘ç»œèµ„æºï¼Œæ„å»ºæ—¶ä¸‹è½½é‡å¤æ•°æ®</span><br><span class="line">3. æ¶ˆè€—å¤§é‡æ—¶é—´ï¼Œé€šè¿‡æºç å®Œæˆç¼–è¯‘ç¯å¢ƒçš„æ„å»ºå¤§æ¦‚éœ€è¦ä¸€å°æ—¶ï¼Œä½¿ç”¨ä¼˜åŒ–åçš„æ–¹æ³•åªéœ€è¦ä¸€åˆ†é’Ÿä¹ƒè‡³æ›´å°‘</span><br></pre></td></tr></table></figure>

<h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>å¤ç”¨ç›¸åŒç‰ˆæœ¬çš„dockeré•œåƒè¿›è¡Œç¼–è¯‘</p>
<h2 id="å¦‚ä½•æ“ä½œ"><a href="#å¦‚ä½•æ“ä½œ" class="headerlink" title="å¦‚ä½•æ“ä½œ"></a>å¦‚ä½•æ“ä½œ</h2><h3 id="å¯¹äºå¤ç”¨dockeré•œåƒæ­å»ºç¼–è¯‘ç¯å¢ƒçš„ç”¨æˆ·"><a href="#å¯¹äºå¤ç”¨dockeré•œåƒæ­å»ºç¼–è¯‘ç¯å¢ƒçš„ç”¨æˆ·" class="headerlink" title="å¯¹äºå¤ç”¨dockeré•œåƒæ­å»ºç¼–è¯‘ç¯å¢ƒçš„ç”¨æˆ·"></a>å¯¹äºå¤ç”¨dockeré•œåƒæ­å»ºç¼–è¯‘ç¯å¢ƒçš„ç”¨æˆ·</h3><ol>
<li><p><code>docker images</code>æŸ¥çœ‹æœåŠ¡å™¨ä¸Šæ˜¯å¦æœ‰æ‰€éœ€ç‰ˆæœ¬çš„image, imageå‘½åè§„åˆ™ä¸º:sonic-version-debian_version, tagä¸ºpublicï¼Œä¾‹å¦‚:sonic-201911-stretch:publicï¼Œå¦‚æœæœ‰äº†,è·³è¿‡æ­¥éª¤2ï¼›</p>
</li>
<li><p>è·å–å¯¹åº”ç‰ˆæœ¬imageçš„tar.gzæ–‡ä»¶</p>
<ol>
<li>æˆ‘åœ¨10.204.112.46ä¸Šæ­å»ºäº†ä¸€ä¸ªæ–‡ä»¶æœåŠ¡å™¨ï¼Œ201911-stretchçš„ç¼–è¯‘é•œåƒå­˜æ”¾åœ¨ä¸Šé¢ï¼Œå¯ä»¥é€šè¿‡è¯¥é“¾æ¥<code>http://10.204.112.46:8081/sonic-201911/sonic-201911-stretch.tar.gz</code>è·å–</li>
<li><code>gzip -d sonic-version-debian_version.tar.gz</code></li>
<li><code>docker load --input sonic-version-debian_version.tar</code></li>
</ol>
</li>
<li><p>ä¿®æ”¹Makefile, æ–‡ä»¶ä½äºé¡¹ç›®æ ¹ç›®å½•ä¸‹</p>
<ol>
<li><p>ä¿®æ”¹Makefileæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff --git a&#x2F;Makefile b&#x2F;Makefile</span><br><span class="line">index 13a3f247..542f4077 100644--- a&#x2F;Makefile+++ b&#x2F;Makefile</span><br><span class="line">@@ -1,6 +1,6 @@ </span><br><span class="line"># SONiC make file </span><br><span class="line">-NOJESSIE ?&#x3D; 0</span><br><span class="line">+NOJESSIE ?&#x3D; 1</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯202006åŠå…¶ä¹‹åçš„ç‰ˆæœ¬ï¼Œå°†stretchä¹Ÿæ³¨é‡Šæ‰ã€‚æˆ‘ä»¬åªéœ€è¦ç”¨äºç¼–è¯‘çš„ç¯å¢ƒã€‚</p>
</li>
<li><p>ä¿®æ”¹Makefile.workæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diff --git a&#x2F;Makefile.work b&#x2F;Makefile.work</span><br><span class="line">index 14c433e4..e7232264 100644</span><br><span class="line">--- a&#x2F;Makefile.work</span><br><span class="line">+++ b&#x2F;Makefile.work</span><br><span class="line">@@ -78,10 +78,12 @@ SLAVE_DIR &#x3D; sonic-slave-stretch</span><br><span class="line">endif</span><br><span class="line">-   SLAVE_BASE_TAG &#x3D; $(shell CONFIGURED_ARCH&#x3D;$(CONFIGURED_ARCH) j2 $(SLAVE_DIR)&#x2F;Dockerfile.j2 &gt; $(SLAVE_DIR)&#x2F;Dockerfile &amp;&amp; sha1sum $(SLAVE_DIR)&#x2F;Dockerfile | awk &#39;&#123;print substr($$1,0,11);&#125;&#39;)</span><br><span class="line">-   SLAVE_TAG &#x3D; $(shell cat $(SLAVE_DIR)&#x2F;Dockerfile.user $(SLAVE_DIR)&#x2F;Dockerfile | sha1sum | awk &#39;&#123;print substr($$1,0,11);&#125;&#39;)</span><br><span class="line">-   SLAVE_BASE_IMAGE &#x3D; $(SLAVE_DIR)</span><br><span class="line">-   SLAVE_IMAGE &#x3D; $(SLAVE_BASE_IMAGE)-$(USER)</span><br><span class="line">+   #SLAVE_BASE_TAG &#x3D; $(shell CONFIGURED_ARCH&#x3D;$(CONFIGURED_ARCH) j2 $(SLAVE_DIR)&#x2F;Dockerfile.j2 &gt; $     (SLAVE_DIR)&#x2F;Dockerfile &amp;&amp; sha1sum $(SLAVE_DIR)&#x2F;Dockerfile | awk &#39;&#123;print substr($$1,0,11);&#125;&#39;)</span><br><span class="line">+   #SLAVE_TAG &#x3D; $(shell cat $(SLAVE_DIR)&#x2F;Dockerfile.user $(SLAVE_DIR)&#x2F;Dockerfile | sha1sum | awk &#39;&#123;print substr($$1,0,11);&#125;&#39;)</span><br><span class="line">+   SLAVE_TAG &#x3D; public</span><br><span class="line">+   #SLAVE_BASE_IMAGE &#x3D; $(SLAVE_DIR)</span><br><span class="line">+   #SLAVE_IMAGE &#x3D; $(SLAVE_BASE_IMAGE)-$(USER)</span><br><span class="line">+   SLAVE_IMAGE &#x3D; sonic-201911-stretch</span><br><span class="line"> </span><br><span class="line">OVERLAY_MODULE_CHECK :&#x3D; \</span><br><span class="line"> lsmod | grep -q &quot;^overlay &quot; &amp;&gt;&#x2F;dev&#x2F;null || \</span><br><span class="line">@@ -113,6 +115,7 @@ DOCKER_RUN :&#x3D; docker run --rm&#x3D;true --privileged \</span><br><span class="line"> -w $(DOCKER_BUILDER_WORKDIR) \</span><br><span class="line"> -e &quot;http_proxy&#x3D;$(http_proxy)&quot; \</span><br><span class="line"> -e &quot;https_proxy&#x3D;$(https_proxy)&quot; \</span><br><span class="line">+   -u root \</span><br><span class="line"> -i$(if $(TERM),t,)</span><br><span class="line"></span><br><span class="line">@@ -200,9 +202,9 @@ endif</span><br><span class="line">    @$(OVERLAY_MODULE_CHECK)</span><br><span class="line">    </span><br><span class="line">-       @docker inspect --type image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) &amp;&gt; &#x2F;dev&#x2F;null || \</span><br><span class="line">-           &#123; echo Image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) not found. Building... ; \</span><br><span class="line">-           $(DOCKER_BASE_BUILD) ; &#125;</span><br><span class="line">+       #@docker inspect --type image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) &amp;&gt; &#x2F;dev&#x2F;null || \</span><br><span class="line">+           #&#123; echo Image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) not found. Building... ; \</span><br><span class="line">+           #$(DOCKER_BASE_BUILD) ; &#125;</span><br><span class="line">        @docker inspect --type image $(SLAVE_IMAGE):$(SLAVE_TAG) &amp;&gt; &#x2F;dev&#x2F;null || \</span><br><span class="line">            &#123; echo Image $(SLAVE_IMAGE):$(SLAVE_TAG) not found. Building... ; \</span><br><span class="line">            $(DOCKER_BUILD) ; &#125;</span><br><span class="line">@@ -222,9 +224,9 @@ sonic-slave-build :</span><br><span class="line"> </span><br><span class="line">sonic-slave-bash :</span><br><span class="line">        @$(OVERLAY_MODULE_CHECK)</span><br><span class="line">-       @docker inspect --type image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) &amp;&gt; &#x2F;dev&#x2F;null || \</span><br><span class="line">-           &#123; echo Image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) not found. Building... ; \</span><br><span class="line">-           $(DOCKER_BASE_BUILD) ; &#125;</span><br><span class="line">+       #@docker inspect --type image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) &amp;&gt; &#x2F;dev&#x2F;null || \</span><br><span class="line">+           #&#123; echo Image $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG) not found. Building... ; \</span><br><span class="line">+           #$(DOCKER_BASE_BUILD) ; &#125;</span><br><span class="line">        @docker inspect --type image $(SLAVE_IMAGE):$(SLAVE_TAG) &amp;&gt; &#x2F;dev&#x2F;null || \</span><br><span class="line">            &#123; echo Image $(SLAVE_IMAGE):$(SLAVE_TAG) not found. Building... ; \</span><br><span class="line">            $(DOCKER_BUILD) ; &#125;</span><br><span class="line">@@ -232,7 +234,7 @@ sonic-slave-bash :</span><br><span class="line"> </span><br><span class="line">showtag:</span><br><span class="line">        @echo $(SLAVE_IMAGE):$(SLAVE_TAG)</span><br><span class="line">-       @echo $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG)</span><br><span class="line">+       #@echo $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å°†SLAVE_IMAGEå’ŒSLAVE_TAGä¿®æ”¹ä¸ºå¤ç”¨imageåŠå…¶tagï¼ŒæŠ›å¼ƒSLAVE_BASE_IMAGEçš„ä½¿ç”¨ã€‚</p>
</li>
<li><p>é€šè¿‡<code>make showtag</code>æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒæ˜¯å¦åŠ è½½æ­£ç¡®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+++ Making showtag +++</span><br><span class="line">BLDENV&#x3D;stretch make -f Makefile.work showtag</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;home&#x2F;rancho&#x2F;workdir&#x2F;SONIC-DEV&#x2F;sonic-buildimage&#39;</span><br><span class="line">sonic-201911-stretch:public</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;home&#x2F;rancho&#x2F;workdir&#x2F;SONIC-DEV&#x2F;sonic-buildimage&#39;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h3 id="å¯¹äºå‘å¸ƒdockerç¼–è¯‘ç¯å¢ƒä¾›å¤§å®¶ä½¿ç”¨çš„ç”¨æˆ·"><a href="#å¯¹äºå‘å¸ƒdockerç¼–è¯‘ç¯å¢ƒä¾›å¤§å®¶ä½¿ç”¨çš„ç”¨æˆ·" class="headerlink" title="å¯¹äºå‘å¸ƒdockerç¼–è¯‘ç¯å¢ƒä¾›å¤§å®¶ä½¿ç”¨çš„ç”¨æˆ·"></a>å¯¹äºå‘å¸ƒdockerç¼–è¯‘ç¯å¢ƒä¾›å¤§å®¶ä½¿ç”¨çš„ç”¨æˆ·</h3><ol>
<li><p>æŒ‰ç…§åŸæœ‰çš„æ–¹å¼å®Œæˆç¼–è¯‘ç¯å¢ƒçš„æ„å»º</p>
</li>
<li><p>å‘å¸ƒç¼–è¯‘ç¯å¢ƒ</p>
<ol>
<li>ä½¿ç”¨<code>docker tag image-id sonic-version-debian_version:tag</code>è¿›è¡Œè§„æ³•é•œåƒå‘½å</li>
<li>ä½¿ç”¨<code>docker rmi old_name:old_tag</code>åˆ é™¤ç”Ÿæˆçš„é•œåƒtag</li>
<li>ä½¿ç”¨<code>docker save -o ~/sonic-version-debian_version.tar sonic-version-debian_version:public</code>æå–é•œåƒ</li>
<li>ä½¿ç”¨<code>gzip sonic-version-debian_version.tar</code>å‹ç¼©</li>
<li>å°†sonic-version-debian_version.tar.gzæ–‡ä»¶æ”¾åˆ°æ–‡ä»¶æœåŠ¡å™¨ä¸Šä¾›å¤§å®¶ä½¿ç”¨</li>
</ol>
</li>
</ol>
<h1 id="å¯¹äºä¸»ç›®æ ‡ç¼–è¯‘"><a href="#å¯¹äºä¸»ç›®æ ‡ç¼–è¯‘" class="headerlink" title="å¯¹äºä¸»ç›®æ ‡ç¼–è¯‘"></a>å¯¹äºä¸»ç›®æ ‡ç¼–è¯‘</h1><p>è¿™é‡Œé¢æœ‰ä¸ª<code>target groups</code>çš„æ¦‚å¿µ, åœ¨slave.mké‡Œé¢å®šä¹‰äº†å¾ˆå¤šç›®æ ‡ç»„ï¼Œå¦‚SONIC_MAKE_DEBS, SONIC_MAKE_FILESï¼Œè¿™äº›ç›®æ ‡ç»„åœ¨å…·ä½“çš„åŠŸèƒ½æ¨¡å—ä¸­è¢«å¡«å……ï¼Œä¹‹åè¢«è¯¥ç»„çš„cmdæ‰€æ‰§è¡Œã€‚å‚è§README.buildsystem.mdå°†ä¼šæœ‰æ›´å¥½çš„ç†è§£ã€‚<br>å¯¹äºæ ¹æ–‡ä»¶ç³»ç»Ÿçš„æ„å»ºï¼Œæ—¶é—´å¾ˆä¹…ï¼Œä¸»è¦æ˜¯æ¯æ¬¡éƒ½ä¼šåˆ é™¤ä¹‹å‰æ„å»ºçš„rootfsç„¶åä½¿ç”¨<code>debootstrap</code>é‡æ–°æ„å»ºï¼Œåç»­å¦‚æœéœ€è¦è¿›è¡Œä¸Šå±‚åŠŸèƒ½è°ƒè¯•è¿™æ˜æ˜¾æ•ˆç‡å¾ˆä½ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡æ›¿æ¢è°ƒè¯•åŠŸèƒ½æ‰€åœ¨dockerå®Œæˆå¿«é€Ÿç‰ˆæœ¬è¿­ä»£ã€‚ä»¥è·¯ç”±åè®®frrä¸¾ä¾‹ã€‚</p>
<pre><code>1. make list | grep frr æ‰¾åˆ° target/docker-fpm-frr.gz
2. ä¿®æ”¹src/sonic-frrä¸­çš„ä»£ç 
3. make target/docker-fpm-frr.gzç”Ÿæˆæ–°çš„frré•œåƒ
4. åœ¨SONiCè®¾å¤‡ä¸Š`service bgp stop`åœæ­¢docker-fpm-frrï¼Œå¹¶åˆ é™¤è¯¥containerï¼Œåˆ é™¤docker-fpm-frr:latesté•œåƒ
5. å°†æ–°çš„é•œåƒæ‹·è´åˆ°è®¾å¤‡ä¸­`docker load -i docker-fpm-frr.gz`ï¼Œå¹¶ä¸ºä¹‹æ‰“ä¸Šlatestçš„tag
6. `service bgp start`é‡å¯frræœåŠ¡ï¼Œè¿›è¡Œä»£ç éªŒè¯
7. service bgpå¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„containerï¼Œåˆ™ä¼šæ ¹æ®docker-fpm-frr:latesté‡æ–°åˆ›å»ºä¸€ä¸ªï¼Œæ‰€ä»¥å¦‚æœéœ€è¦ç‰ˆæœ¬å›é€€ï¼Œé‡4,5,6çš„åŠ¨ä½œå³å¯
</code></pre>
]]></content>
      <categories>
        <category>SONiC</category>
      </categories>
      <tags>
        <tag>SONiC</tag>
        <tag>ç¼–è¯‘</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCè‡ªåŠ¨åŒ–ç¼–è¯‘ç®€è¿°</title>
    <url>/2021/10/08/SONiC%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BC%96%E8%AF%91%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å…³äºSONiCè‡ªåŠ¨åŒ–ç¼–è¯‘"><a href="#å…³äºSONiCè‡ªåŠ¨åŒ–ç¼–è¯‘" class="headerlink" title="å…³äºSONiCè‡ªåŠ¨åŒ–ç¼–è¯‘"></a>å…³äºSONiCè‡ªåŠ¨åŒ–ç¼–è¯‘</h1><ul>
<li><p>å½“gitlabä»“åº“æœ‰pushåŠ¨ä½œæ—¶è§¦å‘è‡ªåŠ¨ç¼–è¯‘ï¼Œä»“åº“åœ°å€ä¸ºï¼š<a href="http://cshgitlab.cn-csh.celestica.com/sonic-sdk/brixia_sonic.git">http://cshgitlab.cn-csh.celestica.com/sonic-sdk/brixia_sonic.git</a></p>
<span id="more"></span></li>
<li><p>ç¼–è¯‘ç¯å¢ƒéƒ¨ç½²åœ¨æ³°å›½æœåŠ¡å™¨ï¼Œè®¾å¤‡ipä¸ºï¼š10.196.48.47</p>
</li>
<li><p>è€ƒè™‘ç½‘ç»œé—®é¢˜ä»¥åŠSONiCç¼–è¯‘å¶å°”ä¼šæŠ½ç–¯ï¼Œç¼–è¯‘å¤±è´¥åå†æ¬¡æ‰§è¡Œï¼Œ5æ¬¡å¤±è´¥åé€€å‡ºç¼–è¯‘</p>
</li>
<li><p>é•œåƒç‰ˆæœ¬å·ä¸ºâ€œSONiC.202012-brixia-æ—¶é—´-ç‰ˆæœ¬â€ï¼Œå¦‚â€œSONiC.202012-brixia-20210930-r4â€ï¼Œå…¶ä¸­æ—¶é—´ä¸ºå½“å¤©ç¼–è¯‘æ—¶é—´ï¼Œråé¢çš„æ•°å­—ä¾æ¬¡é€’å¢ï¼Œr5,r6â€¦â€¦</p>
</li>
<li><p>ç¼–è¯‘å¥½çš„ç‰ˆæœ¬ï¼Œå‘½åè§„åˆ™ä¸ºâ€sonic-broadcom-æ—¶é—´-ç‰ˆæœ¬.binâ€ï¼Œä¼šè‡ªåŠ¨æ¨é€åˆ°æ–‡ä»¶æœåŠ¡å™¨ï¼š<a href="http://10.204.112.155:8081/sonic/brixia/">http://10.204.112.155:8081/sonic/brixia/</a></p>
</li>
<li><p>jenkinsç¯å¢ƒéƒ¨ç½²åœ¨ï¼š10.204.112.155:8080, åç»­ç¨³å®šåè€ƒè™‘è¿ç§»åˆ°testbedçš„ç¯å¢ƒï¼Œå½“å‰ä¸Šé¢åªæœ‰ä¸€ä¸ªè´¦å·(rancho/123456)ï¼Œæœ‰å…´è¶£çš„åŒå­¦è¯·è‡ªè¡Œå‚è§‚ä½¿ç”¨</p>
</li>
<li><p>é’ˆå¯¹ä¸éœ€è¦gitlab+jenkinsçš„åœºæ™¯ï¼Œæä¾›shellè„šæœ¬å®ç°è‡ªåŠ¨åŒ–ç¼–è¯‘ï¼Œåœ¨è‡ªå·±å®¶ç›®å½•ä¸‹æ‰§è¡Œ bash ~/auto_build.shå³å¯</p>
</li>
</ul>
<h1 id="è‡ªåŠ¨åŒ–ç¼–è¯‘ä¸€äº›å°é—®é¢˜"><a href="#è‡ªåŠ¨åŒ–ç¼–è¯‘ä¸€äº›å°é—®é¢˜" class="headerlink" title="è‡ªåŠ¨åŒ–ç¼–è¯‘ä¸€äº›å°é—®é¢˜"></a>è‡ªåŠ¨åŒ–ç¼–è¯‘ä¸€äº›å°é—®é¢˜</h1><ul>
<li><p>è‡ªåŠ¨åŒ–ç¼–è¯‘æ¯æ¬¡å‡ä¸ºå…¨é‡ç¼–è¯‘ï¼Œæ—¶é—´è¾ƒé•¿ï¼ŒåŠ ä¸Šä»æ³°å›½æœåŠ¡å™¨æ‹·è´imageï¼Œæ—¶é—´è¾ƒé•¿ï¼Œå¦‚æœæ˜¯ç‰¹æ€§æˆ–ç¼–è¯‘ä¸´æ—¶ç‰ˆæœ¬ï¼Œå¹¶ä¸å»ºè®®ä½¿ç”¨ï¼Œæ¨èå¢é‡ç¼–è¯‘æˆ–æ¨¡å—åŒ–ç¼–è¯‘ã€‚</p>
</li>
<li><p>è‡ªåŠ¨åŒ–ç¼–è¯‘åªä¼šç¼–è¯‘åŸºç¡€SONiCé•œåƒï¼Œdebugç‰ˆæœ¬æˆ–åŠ ç‰¹æ€§(å¦‚syncd-rpc)ä¸ä¼šåœ¨è‡ªåŠ¨åŒ–ç¼–è¯‘ä¸­(ä¸»è¦è€ƒè™‘ç¼–è¯‘æ—¶é—´ã€ä¼ è¾“æ—¶é—´ã€å­˜å‚¨ç©ºé—´ä»¥åŠä½¿ç”¨ç‡)</p>
</li>
<li><p>è‡ªåŠ¨åŒ–ç¼–è¯‘å•æ¬¡åªä¼šç¼–è¯‘ä¸€ä¸ªtargetï¼Œå¯¹äºæ— ä¾èµ–å…³ç³»targetä¸èƒ½å¹¶è¡Œå¤„ç†ï¼Œå¹¶è¡Œå¤„ç†å¤§æ¦‚ç‡ä¼šæŠ¥é”™ï¼Œéœ€è¦æ‰‹åŠ¨çº é”™</p>
</li>
<li><p>jenkinsåœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œshellå‘½ä»¤ä½¿ç”¨çš„æ˜¯SSHï¼Œè¯¥shellæ˜¯éäº¤äº’å¼éç™»å½•å¼shellï¼Œéœ€è¦æ³¨æ„shellé…ç½®æ–‡ä»¶çš„åŠ è½½ä»¥åŠç¯å¢ƒå˜é‡çš„é…ç½®</p>
</li>
<li><p>åœ¨hostä¸Šæ¸…é™¤å·²ç»ç¼–è¯‘è¿‡çš„ç¯å¢ƒéœ€è¦rootæƒé™(fsrootæ–‡ä»¶å¤¹)ï¼Œä½¿ç”¨è„šæœ¬ä¸­çš„b.outå¯ä»¥å®Œæˆè¯¥æ“ä½œ<br>  ä¿®æ”¹Makefile, åœ¨targetä¸­åŠ å…¥sonic-slave-run, ä½¿ç”¨ <code>make sonic-slave-run SONIC_RUN_CMDS=&quot;rm -rf fsroot&quot;</code>åˆ é™¤ä¸èƒ½åˆ é™¤çš„éƒ¨åˆ†</p>
</li>
</ul>
]]></content>
      <tags>
        <tag>SONiC</tag>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>SONiCè·¯ç”±åè®®ç®€è¿°</title>
    <url>/2021/04/08/SONiC%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>æœ¬æ–‡é€šè¿‡ç ”ç©¶SONiCä¸­å·²æ”¯æŒçš„è·¯ç”±åè®®BGPï¼Œäº†è§£SONiCä¸­è·¯ç”±æ¨¡å—çš„å·¥ä½œæµç¨‹ï¼Œè¿›è€Œä¸ºæ”¯æŒSONiCä¸­æš‚æœªæ”¯æŒçš„è·¯ç”±åè®®ï¼ˆospfã€ripã€pimï¼‰çš„portingæ‰“ä¸‹åŸºç¡€ã€‚ä»¥åè®®æ ˆæ”¶åŒ…ï¼Œåè®®æ ˆçŠ¶æ€æœºè¿è½¬ï¼Œåè®®æ ˆè¡¨é¡¹ç”Ÿæˆä¸‹å‘è‡³SDKä¸ºæ–¹å‘è¿›è¡Œç ”ç©¶ã€‚</p>
<span id="more"></span>
<h2 id="SONiCä¸­æ”¯æŒçš„åè®®"><a href="#SONiCä¸­æ”¯æŒçš„åè®®" class="headerlink" title="SONiCä¸­æ”¯æŒçš„åè®®"></a>SONiCä¸­æ”¯æŒçš„åè®®</h2><p>SONiCä¸­æ”¯æŒBGPã€ECMPã€LLDPã€QoSã€SNMPã€NTPã€DHCPã€VxLANã€NATã€ARPç­‰åè®®ã€‚å…¶ä¸­ï¼Œä½¿ç”¨FRRä½œä¸ºé»˜è®¤è·¯ç”±åè®®æ ˆã€‚è¿è¡Œåœ¨<code>bdp</code>å®¹å™¨ä¸­ã€‚</p>
<h2 id="åˆæ­¥äº†è§£FRR"><a href="#åˆæ­¥äº†è§£FRR" class="headerlink" title="åˆæ­¥äº†è§£FRR"></a>åˆæ­¥äº†è§£FRR</h2><p>å¯¹äºFRRçš„æ¡†æ¶ä¸åšè¿‡å¤šèµ˜è¿°ï¼Œå¯ä»¥å‚è§ã€ŠFRRå¼€æºä»£ç ç ”ç©¶ã€‹ï¼Œå…¶è„±èƒäºquaggaã€‚SONiCä¸­FRRè¿è¡Œåœ¨<code>bgp</code>å®¹å™¨ä¸­ï¼Œè¿è¡Œ<code>docker exec -it bgp bash</code>è¿›å…¥è¯¥å®¹å™¨ï¼Œä½†æ˜¯SONiCä¸­ç°åœ¨åªæ”¯æŒBGPåè®®ã€‚æ‰§è¡Œ<code>vtysh</code>è¿›å…¥FRRå‘½ä»¤è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@sonic:&#x2F;# vtysh </span><br><span class="line"></span><br><span class="line">Hello, this is FRRouting (version 7.2.1-sonic).</span><br><span class="line">Copyright 1996-2005 Kunihiro Ishiguro, et al.</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>201911</code>åˆ†æ”¯ä¸Šä½¿ç”¨çš„æ˜¯7.2.1, åœ¨<code>~/rules/frr.mk</code>ä¸­å¯ä»¥çœ‹åˆ°ã€‚SONiCçš„masteråˆ†æ”¯ä½¿ç”¨çš„FRRç‰ˆæœ¬æ˜¯7.5.1(sonicåŸºäºæ­¤è¿›è¡Œporting),ä¸FRRå®˜æ–¹æœ€æ–°çš„<a href="https://github.com/FRRouting/frr/releases">release</a>ä¿æŒä¸€è‡´ã€‚</p>
<p>åœ¨è¿›è¡ŒFRRæ¨¡å—è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å•ç‹¬æ›´æ–°FRRæ¨¡å—ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho sonic-buildimage]$ make list | grep frr</span><br><span class="line">&quot;ROUTING_STACK&quot;                   : &quot;frr&quot;</span><br><span class="line">target&#x2F;debs&#x2F;stretch&#x2F;frr_7.2.1-sonic-0_amd64.deb</span><br><span class="line">target&#x2F;debs&#x2F;stretch&#x2F;frr-pythontools_7.2.1-sonic-0_all.deb</span><br><span class="line">target&#x2F;debs&#x2F;stretch&#x2F;frr-dbgsym_7.2.1-sonic-0_amd64.deb</span><br><span class="line">target&#x2F;debs&#x2F;stretch&#x2F;frr-snmp_7.2.1-sonic-0_amd64.deb</span><br><span class="line">target&#x2F;debs&#x2F;stretch&#x2F;frr-snmp-dbgsym_7.2.1-sonic-0_amd64.deb</span><br><span class="line">target&#x2F;docker-fpm-frr.gz</span><br><span class="line">target&#x2F;docker-fpm-frr-dbg.gz</span><br></pre></td></tr></table></figure>

<h2 id="SONiCä¸­è·¯ç”±æ¨¡å—çš„äº¤äº’"><a href="#SONiCä¸­è·¯ç”±æ¨¡å—çš„äº¤äº’" class="headerlink" title="SONiCä¸­è·¯ç”±æ¨¡å—çš„äº¤äº’"></a>SONiCä¸­è·¯ç”±æ¨¡å—çš„äº¤äº’</h2><p>SONiCä¸­è·¯ç”±æ¨¡å—äº¤äº’å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://rancho333.github.io/pictures/frr-sonic.png"> </p>
<ol>
<li>åœ¨BGPå®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œ zebraé€šè¿‡TCP socketè¿æ¥åˆ°<code>fpmsyncd</code>ã€‚åœ¨ç¨³å®šçŠ¶æ€ä¸‹ï¼Œzebraã€linux kernelã€APPL_DBã€ASIC_DBã€ASICä¸­çš„è·¯ç”±è¡¨åº”è¯¥æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚<br>è¿™é‡Œåšä¸€ç‚¹è¯´æ˜ï¼ŒOSPFã€BGPç­‰è·¯ç”±è¿›ç¨‹ä¼šå°†è‡ªå·±é€‰æ‹©å‡ºçš„è·¯ç”±å‘é€ç»™zebraï¼Œzebraé€šè¿‡è®¡ç®—ç­›é€‰ä¹‹åä¼šé€šè¿‡netlinkå°†ä¹‹åŒæ­¥ç»™kernelï¼ŒåŒæ—¶zebraé€šè¿‡FPM(forwarding plane manger)å°†ä¹‹åŒæ­¥ç»™ASICã€‚zebraä¸­è¿è¡ŒFPM clientï¼Œé€šè¿‡TCP socketä¸FPM serverè¿›è¡Œé€šä¿¡ã€‚FPM clientç«¯ä»£ç å¦‚ä¸‹ï¼š<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">    <span class="comment">//zebra_fpm.c</span></span><br><span class="line">    serv.sin_family = AF_INET;</span><br><span class="line">    serv.sin_port = htons(zfpm_g-&gt;fpm_port);                    <span class="comment">//fpmé»˜è®¤ä½¿ç”¨2620ç«¯å£</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_STRUCT_SOCKADDR_IN_SIN_LEN</span></span><br><span class="line">    serv.sin_len = <span class="keyword">sizeof</span>(struct sockaddr_in);                                     </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_STRUCT_SOCKADDR_IN_SIN_LEN */</span></span></span><br><span class="line">    <span class="keyword">if</span> (!zfpm_g-&gt;fpm_server)</span><br><span class="line">        serv.sin_addr.s_addr = htonl(INADDR_LOOPBACK);          <span class="comment">//FPM serverä¸€èˆ¬éƒ¨ç½²åœ¨æœ¬æœºä¸Š</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        serv.sin_addr.s_addr = (zfpm_g-&gt;fpm_server);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>FRRå®šä¹‰äº†FPMçš„æ•°æ®æ ¼å¼ï¼Œç±»ä¼¼äºåè®®æŠ¥æ–‡ï¼Œç”¨æˆ·è‡ªå·±å®ç°FPM serverï¼Œè§£æå‡ºclientå‘é€è¿‡æ¥çš„è·¯ç”±æ•°æ®ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</p>
<ol start="2">
<li><p>Bgpdå¤„ç†æ”¶åˆ°çš„åè®®æŠ¥æ–‡ï¼Œä»¥bgp-updateæŠ¥æ–‡ä¸ºä¾‹ï¼Œå°†è®¡ç®—å¾—åˆ°çš„è·¯ç”±ä¿¡æ¯å‘é€ç»™zebra</p>
</li>
<li><p>zebraæ ¹æ®è‡ªèº«çš„è®¡ç®—ç­–ç•¥è¿‡æ»¤è¯¥è·¯ç”±ï¼Œå¦‚æœé€šè¿‡zebraåˆ™ç”Ÿæˆroute-netlinkä¿¡æ¯å°†è·¯ç”±ä¿¡æ¯å‘é€ç»™kernel</p>
</li>
<li><p>åŒæ—¶ï¼Œzebraé€šè¿‡FPMæ¥å£å°†route-netlinkä¿¡æ¯å‘é€ç»™<code>fpmsyncd</code>ï¼Œ2,3,4çš„å¤§è‡´æµç¨‹å‚è§ä¸‹å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/frr-bgpd.png"> </p>
</li>
<li><p>Fpmsyncdå¤„ç†è¯¥ä¿¡æ¯å¹¶å°†ä¹‹æ”¾å…¥<code>APPL_DB</code><br>SONiCä¸­FPM serveråœ¨<code>fpmsyncd</code>ä¸­å®ç°ï¼Œæºç åœ¨<code>sonic-swss</code>ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//fpmsyncd.cpp  è¿æ¥redis APPL_DB</span></span><br><span class="line"><span class="function">DBConnector <span class="title">db</span><span class="params">(<span class="string">&quot;APPL_DB&quot;</span>, <span class="number">0</span>)</span></span>; </span><br><span class="line"><span class="function">RedisPipeline <span class="title">pipeline</span><span class="params">(&amp;db)</span></span>;</span><br><span class="line"><span class="function">RouteSync <span class="title">sync</span><span class="params">(&amp;pipeline)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fpmlink.cpp  åˆ›å»ºsocketï¼Œåšä¸ºFPM server</span></span><br><span class="line">addr.sin_family = AF_INET;                          </span><br><span class="line">addr.sin_port = htons(port);                        <span class="comment">//portä¸º2620, åœ¨fpm/fpm.hä¸­å®šä¹‰</span></span><br><span class="line">addr.sin_addr.s_addr = htonl(INADDR_LOOPBACK);      <span class="comment">//éƒ¨ç½²åœ¨æœ¬åœ°</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šæ‰“åŒ…åˆ°<code>swss_1.0.0_amd64.deb</code>ï¼Œåœ¨<code>dockers/docker-fpm-frr/Dockerfile.j2</code>ä¼šå°†å…¶å®‰è£…åˆ°<code>docker-fpm-frr</code>é•œåƒä¸­ã€‚åœ¨BGPè¿›ç¨‹ä¸­å¯ä»¥çœ‹åˆ°è¯¥è¿›ç¨‹ã€‚åœ¨<code>/etc/supervisor/conf.d/supervisord.conf</code>ä¸­å¯ä»¥çœ‹åˆ°å„æœåŠ¡çš„å¯åŠ¨æ§åˆ¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[program:bgpd]</span><br><span class="line">command&#x3D;&#x2F;usr&#x2F;lib&#x2F;frr&#x2F;bgpd -M bmp -A 127.0.0.1</span><br><span class="line">priority&#x3D;6</span><br><span class="line"></span><br><span class="line">[program:fpmsyncd]</span><br><span class="line">command&#x3D;fpmsyncd</span><br><span class="line">priority&#x3D;8</span><br></pre></td></tr></table></figure>

<ol start="6">
<li><p><code>orchagentd</code>ä½œä¸ºAPPL_DBçš„è®¢é˜…è€…ï¼Œå®ƒä¼šæ”¶åˆ°fpmsyncdå‘å¸ƒçš„ä¿¡æ¯</p>
</li>
<li><p>orchagentdä½œä¸ºä¸€ä¸ªä¸­è½¬ç«™ï¼Œä¼šè°ƒç”¨sairedisçš„APIså°†ä¿¡æ¯å‘å¸ƒåˆ°ASIC_DB</p>
</li>
<li><p><code>syncd</code>ä½œä¸ºASIC_DBçš„è®¢é˜…è€…ï¼Œå®ƒä¼šæ”¶åˆ°orchagendå‘å¸ƒçš„ä¿¡æ¯</p>
</li>
<li><p>Syncdè°ƒç”¨SAI APIså°†è·¯ç”±ä¿¡æ¯ä¸‹å‘åˆ°SDK</p>
</li>
<li><p>æœ€ç»ˆæ–°çš„è·¯ç”±è§„åˆ™åœ¨ASICä¸­ç”Ÿæ•ˆ</p>
</li>
</ol>
<p>FRRä¸SONiCçš„å®Œæ•´äº¤äº’æµç¨‹å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/route-flow.png"></p>
<h2 id="é™æ€è·¯ç”±çš„å®ç°"><a href="#é™æ€è·¯ç”±çš„å®ç°" class="headerlink" title="é™æ€è·¯ç”±çš„å®ç°"></a>é™æ€è·¯ç”±çš„å®ç°</h2><p>åŸºäºä»¥ä¸Šçš„SONiCè·¯ç”±å®ç°æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ª<code>FPM client</code>ï¼ŒæŒ‰ç…§ZAPIçš„æ ¼å¼å°è£…netlinkè·¯ç”±æ•°æ®å‘é€ç»™<code>fpmsyncd</code>ï¼Œä¹‹ååœ¨å„ä¸ªæ•°æ®ä¸­è½¬èŠ‚ç‚¹éªŒè¯è·¯ç”±æ˜¯å¦æŒ‰è®¾å®šçš„æµç¨‹è½¬å‘æœ€ç»ˆç”Ÿæ•ˆåˆ°ASICã€‚è¿™æ ·å¯ä»¥è„±ç¦»<code>FRR</code>çš„åè®®æ ˆé€»è¾‘ï¼Œåªå€Ÿç”¨FPMæ¨¡å—ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡FRRçš„é…ç½®æ–‡ä»¶æˆ–è€…<code>vtysh</code>æ¥ä¸‹å‘é™æ€è·¯ç”±ï¼Œæœ‰ä¸€ä¸ªè¿›ç¨‹<code>staticd</code>ç”¨æ¥å¤„ç†é™æ€è·¯ç”±ã€‚<br>è·¯ç”±ä¸‹å‘çš„å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip route 192.168.2.0&#x2F;24 PortChannel0001</span><br></pre></td></tr></table></figure>
<p>éªŒè¯ä¸€ä¸‹å‘½ä»¤æ˜¯å¦ç”Ÿæ•ˆï¼š</p>
<p><img src="https://rancho333.github.io/pictures/show-ip-route.png"></p>
<p>çœ‹ä¸‹åœ¨kernelä¸­æ˜¯å¦ç”Ÿæ•ˆï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ip-route-show.png"></p>
<p>æŸ¥çœ‹æ˜¯å¦åŒæ­¥åˆ°<code>APPL_DB</code>ä¸­ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/appl-db.png"></p>
<p>æŸ¥çœ‹æ˜¯å¦åŒæ­¥åˆ°<code>ASIC_DB</code>ä¸­ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/asic-db.png"></p>
<p>æŸ¥çœ‹æ˜¯å¦ä¸‹å‘åˆ°<code>ASIC</code>ä¸­ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/asic-route.png"></p>
<p>å¯ä»¥çœ‹åˆ°è·¯ç”±ä¿¡æ¯æŒ‰ç…§<code>SONiCä¸­è·¯ç”±æ¨¡å—çš„äº¤äº’</code>ä¸­æè¿°çš„è¿›è¡Œå¤„ç†ä¸‹å‘ã€‚</p>
<h2 id="å¯¹äºå•æ’­-OSPFã€RIP-ä»¥åŠç»„æ’­-PIM-çš„æ”¯æŒ"><a href="#å¯¹äºå•æ’­-OSPFã€RIP-ä»¥åŠç»„æ’­-PIM-çš„æ”¯æŒ" class="headerlink" title="å¯¹äºå•æ’­(OSPFã€RIP)ä»¥åŠç»„æ’­(PIM)çš„æ”¯æŒ"></a>å¯¹äºå•æ’­(OSPFã€RIP)ä»¥åŠç»„æ’­(PIM)çš„æ”¯æŒ</h2><p>å¯¹äºæ”¯æŒä¸Šè¿°åè®®ï¼Œéœ€è¦å›ç­”å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>ä»å“ªé‡Œè·å–ä¿¡æ¯ï¼ˆç«¯å£çŠ¶æ€å˜åŒ–ã€æ§åˆ¶æŠ¥æ–‡ã€æ•°æ®æŠ¥æ–‡æ˜¯æ€ä¹ˆé€åˆ°åè®®æ ˆçš„ï¼‰</li>
<li>åè®®çŠ¶æ€æœºå˜åŒ– (é—®é¢˜æ€ä¹ˆå®šä½ä»¥åŠåŠŸèƒ½çš„æ”¯æŒç¨‹åº¦, è‡³äºæµ‹è¯•ï¼Œéœ€è¦ä¸“ä¸šåè®®æµ‹è¯•äººå‘˜ä»‹å…¥)</li>
<li>æ§åˆ¶é¢ä¿¡æ¯å¦‚ä½•ç”Ÿæ•ˆåˆ°è½¬å‘é¢ (åè®®æ ˆæ§åˆ¶ä¿¡æ¯åŒæ­¥åˆ°kernelä¸ASIC)</li>
</ol>
<p>SONiCé»˜è®¤åªå¯åŠ¨äº†<code>bgpd</code>å’Œ<code>staticd</code>è¿™ä¸¤ä¸ªè·¯ç”±è¿›ç¨‹ï¼Œå°è¯•æ‰‹åŠ¨å¼€å¯<code>ospf</code>ã€<code>rip</code>ã€<code>pim</code>å¹¶ä¸ºå‘ç°å¼‚å¸¸ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/frr-routes.png"></p>
<p>SONICæœ¬èº«å¹¶æœªå¯¹FRRåšä»€ä¹ˆä¿®æ”¹ï¼Œåªæ˜¯å¢åŠ äº†ä¸€ä¸ªFPM serveræ¨¡å—ï¼Œæ•´ä¸ªè·¯ç”±é€šè·¯æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œç†è®ºä¸Šæ˜¯<em>å®Œå…¨å¯ä»¥æ”¯æŒFRRä¸­çš„å…¶å®ƒè·¯ç”±åè®®</em>çš„ï¼Œå¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆå¾®è½¯ä¸é¡ºæ‰‹æŠŠè¿™äº›åšäº†ï¼Ÿ<br>éš¾é“æ˜¯å› ä¸ºæ•°æ®ä¸­å¿ƒä¸­åªè¦BGP+ECMP+VxLAN?</p>
<p>ä¸‹é¢åšä¸€ä¸ªå·¥ä½œé‡çš„è¯„ä¼°ï¼ˆåŸºäºå•ä¸ªåè®®ï¼‰</p>
<ol>
<li><p>åè®®å­¦ä¹ 2å‘¨</p>
</li>
<li><p>OSPFã€PIMåŸºäºIPï¼Œä½¿ç”¨protocolåˆ›å»ºsocketä¸keenelè¿›è¡Œé€šä¿¡ï¼ŒRIPåŸºäºUDPï¼ŒBGPåŸºäºTCPã€‚ospfåˆ›å»ºsocketå¦‚ä¸‹ï¼š</p>
</li>
</ol>
<p><img src="https://rancho333.github.io/pictures/ospf-sock.png"><br>æ§åˆ¶æŠ¥æ–‡è°ƒè¯•1å‘¨ï¼Œè¿™ç©æ„è¦æ˜¯é¡ºåˆ©åº”è¯¥å°±å‡ åˆ†é’Ÿï¼Œå¤§æ¦‚ç‡æ²¡å•¥é—®é¢˜ã€‚</p>
<ol start="3">
<li><p>çœ‹ä»£ç ï¼Œäº†è§£åè®®çŠ¶æ€æœºï¼Œäº†è§£å¸¸è§çš„æµ‹è¯•æ‹“æ‰‘ï¼Œæ­å»ºæµ‹è¯•æ‹“æ‰‘ï¼Œç”Ÿæˆè·¯ç”±ä¿¡æ¯ï¼Œ2å‘¨</p>
</li>
<li><p>æ‰“é€šè·¯ç”±ä¸‹å‘ï¼Œ1å‘¨</p>
</li>
<li><p>åè®®ç»´æŠ¤ï¼Œè§£bugï¼Œä¸å®š</p>
</li>
</ol>
<p>å…¶å®ï¼Œä»æŠ€æœ¯ä¸Šè¯´ï¼Œå¾ˆå¯èƒ½SONiCæ˜¯å·²ç»æ”¯æŒä¸Šè¿°è·¯ç”±åè®®äº†ï¼Œåªè¦å¼€å¯ç›¸åº”è¿›ç¨‹ï¼Œæ‰€ä»¥æµ‹è¯•å§ï¼è¯´ä¸å®šæœ‰æƒŠå–œï¼</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>STP802.1dç®€è¿°</title>
    <url>/2022/07/07/STP802-1d%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ¬æ–‡æ—¨åœ¨æè¿°STP(802.1d)çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œææ¸…æ¥šå…¶æ¶ˆé™¤äºŒå±‚ç¯è·¯çš„åŸç†ï¼Œä¸ºåé¢çš„RSTPå·²ç»MSTPçš„å­¦ä¹ åšé“ºå«ã€‚STPæ˜¯ä¸€ä¸ªé«˜åº¦è‡ªåŠ¨åŒ–çš„åè®®ï¼Œä¸€ä¸¤æ¡ç®€å•çš„å‘½ä»¤å°±å¯ä»¥è®©å…¶è‡ªåŠ¨è®¡ç®—ï¼Œé“¾è·¯æ•…éšœæ—¶ä¹Ÿå¯ä»¥è‡ªåŠ¨æ¢å¤ï¼Œä½†åªæœ‰çœŸæ­£æŒæ¡å…¶å®ç°åŸç†ï¼Œæ‰èƒ½åœ¨æ•…éšœæ—¶è¿›è¡Œä¿®å¤ï¼Œæ‰èƒ½åˆç†çš„ä½¿ç”¨å…¶å®‰å…¨ç‰¹æ€§å’Œä¼˜åŒ–ç‰¹æ€§ã€‚ç°æœ‰çš„STPæœ‰å¤šä¸ªç‰ˆæœ¬ï¼ŒåŒ…æ‹¬æ ‡å‡†STP(802.1d),å¿«é€ŸRSTP(802.1w), å¤šå®ä¾‹MSTP(802.1s)ã€‚æ€ç§‘ä½¿ç”¨PVSTP(per-vlan stp)æ›¿ä»£æ ‡å‡†STP.</p>
<span id="more"></span>

<h1 id="STPçš„ä½œç”¨"><a href="#STPçš„ä½œç”¨" class="headerlink" title="STPçš„ä½œç”¨"></a>STPçš„ä½œç”¨</h1><p>STPä¸ä»…ä»…æ˜¯ä¸ºäº†æ¶ˆé™¤äºŒå±‚ç¯è·¯ï¼Œå…¶æ ¹æœ¬çš„ä½œç”¨æ˜¯<code>æä¾›L2çº¿è·¯å†—ä½™çš„åŒæ—¶é¿å…ç¯è·¯</code>ã€‚äºŒå±‚ç¯è·¯ä¼šå¸¦æ¥ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å¹¿æ’­é£æš´</li>
<li>é‡å¤å¸§</li>
<li>MACåœ°å€è·³è·ƒ</li>
</ol>
<h1 id="STPå¦‚ä½•å®ç°å†—ä½™åŠé¿å…ç¯è·¯çš„"><a href="#STPå¦‚ä½•å®ç°å†—ä½™åŠé¿å…ç¯è·¯çš„" class="headerlink" title="STPå¦‚ä½•å®ç°å†—ä½™åŠé¿å…ç¯è·¯çš„"></a>STPå¦‚ä½•å®ç°å†—ä½™åŠé¿å…ç¯è·¯çš„</h1><p>å½“æœ‰ç¯çš„æ—¶å€™é€šè¿‡é˜»å¡æŸäº›ç«¯å£ç ´åç¯è·¯ï¼Œå½“çº¿è·¯æŒ‚æ‰çš„æ—¶å€™é€šè¿‡æ¢å¤ä¹‹å‰é˜»å¡çš„ç«¯å£ç»§ç»­æä¾›æœåŠ¡ã€‚è¦è¾¾åˆ°è¿™æ ·çš„æ•ˆæœï¼Œéœ€è¦é¢å¤–çš„æ£€æŸ¥ï¼ŒSTPé€šè¿‡BPDU(bridge protocol data unit)æ¥å®ç°è¿™ç§é¢å¤–çš„æ£€æŸ¥ã€‚</p>
<p>è¿™ç§æ£€æŸ¥çš„åŸºæœ¬é€»è¾‘æ˜¯ï¼Œç¡®å®šè®¾å¤‡çš„è§’è‰²ï¼Œç„¶åå†ç¡®å®šè®¾å¤‡ä¸Šç«¯å£çš„è§’è‰²ï¼Œç¡®å®šç«¯å£çš„çŠ¶æ€ï¼Œæ ¹æ®è§’è‰²ã€çŠ¶æ€è¿™ä¸¤ä¸ªå±æ€§ç¡®å®šç«¯å£å¯¹æŠ¥æ–‡çš„æ¥æ”¶ã€å‘é€ã€è½¬å‘ã€å­¦ä¹ ã€ä¸¢å¼ƒèƒ½åŠ›ã€‚</p>
<h1 id="STPä¸­çš„ä¸€äº›é‡è¦æ¦‚å¿µ"><a href="#STPä¸­çš„ä¸€äº›é‡è¦æ¦‚å¿µ" class="headerlink" title="STPä¸­çš„ä¸€äº›é‡è¦æ¦‚å¿µ"></a>STPä¸­çš„ä¸€äº›é‡è¦æ¦‚å¿µ</h1><h2 id="BID"><a href="#BID" class="headerlink" title="BID"></a>BID</h2><p>BIDç”±ä¼˜å…ˆçº§å’Œå‚ä¸STPè®¡ç®—çš„æœ€å°ç«¯å£MACåœ°å€ç»„æˆï¼Œé»˜è®¤ä¼˜å…ˆçº§æ˜¯<code>32768</code>, æ€ç§‘é»˜è®¤è¿è¡Œçš„PVSRTä¸­ä¼šå°†vlan IDåŠ åˆ°ä¼˜å…ˆçº§ä¸­ï¼Œæ‰€ä»¥å®ƒçš„é»˜è®¤ä¼˜å…ˆçº§æ˜¯<code>32768+1</code>ã€‚</p>
<h2 id="æ ¹æ¡¥"><a href="#æ ¹æ¡¥" class="headerlink" title="æ ¹æ¡¥"></a>æ ¹æ¡¥</h2><p>STPçš„ç›®çš„æ˜¯å½¢æˆä¸€é¢—ä»¥æ ¹æ¡¥ä¸ºèµ·ç‚¹çš„æ— ç¯æ ‘çŠ¶ç»“æ„ï¼Œæ ¹æ¡¥æ˜¯BIDæœ€å°çš„ç½‘æ¡¥ã€‚</p>
<h2 id="3ä¸­ç«¯å£è§’è‰²"><a href="#3ä¸­ç«¯å£è§’è‰²" class="headerlink" title="3ä¸­ç«¯å£è§’è‰²"></a>3ä¸­ç«¯å£è§’è‰²</h2><table>
<thead>
<tr>
<th align="left">ç«¯å£è§’è‰²</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">root port(RP)</td>
<td align="left">éæ ¹äº¤æ¢æœºåˆ°è·Ÿäº¤æ¢æœºcostæœ€å°çš„ç«¯å£ï¼Œä¸Šè”æ ¹æ¡¥çš„ç«¯å£</td>
</tr>
<tr>
<td align="left">designated port(DP)</td>
<td align="left">æ ¹æ¡¥å’Œéæ ¹æ¡¥ä¸Šéƒ½æœ‰ï¼Œæ ¹æ¡¥çš„æ‰€æœ‰ç«¯å£éƒ½æ˜¯DPï¼Œè¿æ¥ä¸‹æ¸¸çš„ç«¯å£</td>
</tr>
<tr>
<td align="left">Alternate port(AP)</td>
<td align="left">å‰©ä¸‹çš„ç«¯å£éƒ½æ˜¯AP,APç«¯å£ä¸€èˆ¬éƒ½å¤„äºblockingçŠ¶æ€, åªæ¥æ”¶BPDUï¼Œä¸åšä»»ä½•è½¬å‘å¤„ç†</td>
</tr>
</tbody></table>
<h2 id="5ç§ç«¯å£çŠ¶æ€"><a href="#5ç§ç«¯å£çŠ¶æ€" class="headerlink" title="5ç§ç«¯å£çŠ¶æ€"></a>5ç§ç«¯å£çŠ¶æ€</h2><table>
<thead>
<tr>
<th align="left">çŠ¶æ€</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">disabled</td>
<td align="left">è¯¥çŠ¶æ€ä¸‹çš„ç«¯å£æ²¡æœ‰æ¿€æ´»ï¼Œä¸å‚ä¸STPçš„ä»»ä½•åŠ¨ä½œï¼Œä¸è½¬å‘ç”¨æˆ·æµé‡</td>
</tr>
<tr>
<td align="left">blocking</td>
<td align="left">åªèƒ½æ¥æ”¶BPDU</td>
</tr>
<tr>
<td align="left">listening</td>
<td align="left">è¯¥çŠ¶æ€ä¸‹çš„ç«¯å£å¯ä»¥æ¥æ”¶å’Œå‘é€BPDUï¼Œä½†ä¸è½¬å‘ç”¨æˆ·æµé‡ï¼Œä¸å­¦ä¹ macåœ°å€</td>
</tr>
<tr>
<td align="left">learning</td>
<td align="left">è¯¥çŠ¶æ€ä¸‹å»ºç«‹æ— ç¯çš„è½¬å‘è¡¨ï¼Œä¸è½¬å‘ç”¨æˆ·æµé‡ï¼Œå­¦ä¹ macåœ°å€</td>
</tr>
<tr>
<td align="left">forwarding</td>
<td align="left">æ¥æ”¶å’Œå‘é€BPDUï¼Œä¹Ÿè½¬å‘ç”¨æˆ·æµé‡</td>
</tr>
</tbody></table>
<h2 id="å››ä¸ªè®¡æ—¶å™¨"><a href="#å››ä¸ªè®¡æ—¶å™¨" class="headerlink" title="å››ä¸ªè®¡æ—¶å™¨"></a>å››ä¸ªè®¡æ—¶å™¨</h2><p>STPå¾ˆå¤šå·¥ä½œçš„å®Œæˆéƒ½ä¾èµ–è®¡æ—¶å™¨ï¼Œè¿™äº›è®¡æ—¶å™¨å¯ä»¥ä¿è¯æ‹“æ‰‘è¿›å…¥æ— ç¯çŠ¶æ€æ‰è½¬å‘æ•°æ®ï¼Œé“¾è·¯æ•…éšœæ—¶å®Œæˆæ”¶æ•›ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å…¶æ”¶æ•›æ—¶é—´è¿‡é•¿çš„åŸå› ã€‚ä¸åŒå‚å®¶åœ¨æ­¤éƒ½æœ‰ä¸€äº›ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<table>
<thead>
<tr>
<th align="left">è®¡æ—¶å™¨</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">message age</td>
<td align="left">æ¯ç»è¿‡äº¤æ¢æœºrelayä¸€æ¬¡åŠ 1ç§’ï¼Œç±»ä¼¼IPæŠ¥æ–‡ä¸­çš„TTLï¼Œå¤§äºMAX_ageåä¸å¤„ç†ï¼Œé˜²æ­¢ç½‘ç»œåŠå¾„å¤ªå¤§</td>
</tr>
<tr>
<td align="left">max age</td>
<td align="left">æ¶ˆæ¯è€åŒ–æ—¶é—´ï¼Œé»˜è®¤20ç§’</td>
</tr>
<tr>
<td align="left">hello time</td>
<td align="left">å‘é€ä¸¤ä¸ªæ¶ˆæ¯ä¹‹é—´çš„é—´éš”ï¼Œé»˜è®¤2ç§’</td>
</tr>
<tr>
<td align="left">forward delag</td>
<td align="left">æ§åˆ¶listeningå’Œlearningä¹‹é—´çš„çŠ¶æ€åˆ‡æ¢å»¶æ—¶ï¼Œé»˜è®¤15ç§’</td>
</tr>
</tbody></table>
<h2 id="BPDU"><a href="#BPDU" class="headerlink" title="BPDU"></a>BPDU</h2><p>BPDUæ˜¯STPåè®®çš„æ ¸å¿ƒï¼ŒBPDUæ‰¿è½½ä¸Šè¿°çš„æŸäº›å‚æ•°ï¼Œå®Œæˆæ ¹æ¡¥çš„é€‰ä¸¾ï¼Œç«¯å£çš„é€‰ä¸¾ã€‚BPDUæŠ¥æ–‡å­—æ®µå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">protocol identical</th>
<th align="left">protocol version</th>
<th align="left">BPDU type</th>
<th align="left">flags</th>
<th align="left">root identifier</th>
<th align="left">root path cost</th>
<th align="left">bridge identifier</th>
<th align="left">port identifier</th>
<th align="left">message age</th>
<th align="left">max age</th>
<th align="left">hello time</th>
<th align="left">forward delay</th>
</tr>
</thead>
<tbody><tr>
<td align="left">IDä¸º0</td>
<td align="left">stpä¸º0ï¼Œrstpä¸º2ï¼Œmstpä¸º3</td>
<td align="left">0x00:é…ç½®BPDU,0x80:TCN BPDUï¼Œ0x02ï¼šRST BPDUæˆ–MST BPDU</td>
<td align="left">æœ€é«˜ä½ä¸º1è¡¨ç¤ºTCAï¼Œæœ€ä½ä½ä¸º1è¡¨ç¤ºTC</td>
<td align="left">æ ¹æ¡¥ID</td>
<td align="left">å‘é€æ¡¥åˆ°æ ¹æ¡¥çš„å¼€é”€</td>
<td align="left">sender BID</td>
<td align="left">sender PID</td>
<td align="left">åŒä¸Š</td>
<td align="left">åŒä¸Š</td>
<td align="left">åŒä¸Š</td>
<td align="left">åŒä¸Š</td>
</tr>
</tbody></table>
<p><code>root past cost</code>ä¸å¸¦å®½ç›¸å…³ï¼Œä¸€èˆ¬ethernet(10M)çš„costæ˜¯100, æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚<br><code>port ID</code>ç”±<code>ä¼˜å…ˆçº§.ç«¯å£å·</code>ç»„æˆï¼Œä¼˜å…ˆçº§é»˜è®¤ä¸º128, å¦‚Eth0çš„port IDä¸º<code>128.1</code><br>è¿™äº›å‚æ•°å¯ä»¥åœ¨<code>show spanning</code>å‘½ä»¤ä¸‹çœ‹åˆ°ã€‚</p>
<p>æ ¹æ¡¥çš„é€‰ä¸¾ï¼Œç«¯å£è§’è‰²çš„é€‰ä¸¾ï¼Œæœ¬è´¨å°±æ˜¯ä¸åŒè®¾å¤‡BPDUçš„å¯¹æ¯”ï¼Œä¸åŒç«¯å£æ”¶åˆ°çš„BPDUçš„é€‰ä¸¾ã€‚è¿™é‡Œä»‹ç»ä¸€ä¸ªæ¦‚å¿µ<code>superior BPDU</code>. superior BPDUæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š</p>
<ol>
<li>BIDæœ€ä¼˜</li>
<li>å¦‚æœæ¡ä»¶1ä¸€è‡´ï¼Œroot past costæœ€ä¼˜çš„ä¸ºsuperior BPDU</li>
<li>å¦‚æœæ¡ä»¶1,2ä¸€è‡´ï¼Œsender BIDæœ€ä¼˜çš„ä¸ºsuperior BPDU</li>
<li>å¦‚æœ1,2,3ä¸€è‡´ï¼Œsender PIDæœ€ä¼˜çš„ä¸ºsuperior BPDU</li>
<li>å¦‚æœ1,2,3,4ä¸€è‡´ï¼Œreceiver PIDæœ€ä¼˜çš„ä¸ºsuperior BPDU<br>STPä¸­æ¶‰åŠåˆ°å‚æ•°æ¯”è¾ƒçš„éƒ½æ˜¯æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼ŒBIDå’ŒPIDç±»ä¼¼ï¼Œéƒ½æ˜¯å…ˆæ¯”è¾ƒä¼˜å…ˆçº§ï¼Œå¦‚æœä¼˜å…ˆçº§ä¸€è‡´ï¼Œå†æ¯”è¾ƒmacåœ°å€æˆ–ç«¯å£å·ã€‚ä¸ä¹‹ç›¸å¯¹ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„åˆ™æˆä¸º<code>inferior BPDU</code>ã€‚</li>
</ol>
<p>æ­¤å¤–éœ€è¦çŸ¥é“ä¸€ä¸ªç»†èŠ‚ï¼Œç«¯å£ä¼šå­˜å‚¨æœ€è¿‘æ”¶åˆ°çš„superior BPDU(åŠ ä¸Šè¯¥ç«¯å£çš„cost)ï¼Œå¹¶å¯¹ä»–è¿›è¡Œè€åŒ–ï¼Œè€åŒ–æ—¶é—´ä¸ºmax_age-message_ageã€‚å…¸å‹åœºæ™¯æ˜¯APæ”¶ä¸åˆ°superior BPDU, 20ç§’åè€åŒ–å˜æˆDPï¼Œè¿™æ ·å¯ä»¥ä¿è¯è¶…æ—¶ä¿¡æ¯ä»æ‹“æ‰‘ä¸­ç§»é™¤ã€‚åªæœ‰RPå’ŒAPä¸Šä¼šå­˜å‚¨superior BPDU, DPåªè´Ÿè´£è½¬å‘ã€‚</p>
<h1 id="STPçš„é€‰ä¸¾æµç¨‹"><a href="#STPçš„é€‰ä¸¾æµç¨‹" class="headerlink" title="STPçš„é€‰ä¸¾æµç¨‹"></a>STPçš„é€‰ä¸¾æµç¨‹</h1><p><img src="https://rancho333.github.io/pictures/stp_election.png"></p>
<ol>
<li><p>æ ¹æ¡¥çš„é€‰ä¸¾<br>åˆšå¼€å§‹æ—¶ï¼Œæ‰€æœ‰çš„äº¤æ¢æœºè®¤ä¸ºè‡ªå·±æ˜¯æ ¹æ¡¥ï¼Œæ‰€æœ‰ç«¯å£éƒ½æ˜¯DP(listening)ï¼Œå°†<code>root id</code>å’Œ<code>bridge id</code>å­—æ®µéƒ½å¡«å……è‡ªå·±çš„BIDå‘å¤–å‘é€(ç»„æ’­)ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´æ”¶æ•›åï¼ŒBIDæœ€ä¼˜çš„è¢«é€‰æˆæ ¹æ¡¥ã€‚æœ¬è´¨å°±æ˜¯ä¸åŒäº¤æ¢æœºä¹‹é—´BPDUçš„æ¯”è¾ƒï¼Œæ ¹æ¡¥çš„BPDUä¸ºsuperior BPDU.æ ¹æ¡¥é€‰å®šä¹‹åï¼Œåªæœ‰æ ¹æ¡¥å‘å¤–å‘é€é…ç½®BPDUï¼Œå…¶å®ƒäº¤æ¢æœºåªè´Ÿè´£æ¥æ”¶å’Œè½¬å‘ï¼Œç«¯å£éƒ½æ˜¯DP(listening).<br>å¦‚å›¾æ‰€ç¤ºï¼ŒS1çš„BIDä¼˜å…ˆçº§æœ€å°ï¼Œé€‰ä¸¾æˆä¸ºæ ¹æ¡¥ã€‚</p>
</li>
<li><p>æ ¹ç«¯å£çš„é€‰ä¸¾<br>åœ¨æˆç¯çš„æ‹“æ‰‘ä¸­ï¼Œéæ ¹æ¡¥ä¼šä»å¤šä¸ªç«¯å£æ”¶åˆ°æ ¹æ¡¥å‘æ¥çš„BPDUï¼Œä»è¿™äº›BPDUä¸­é€‰å‡ºsuperior BPDUä½œä¸ºæ ¹ç«¯å£ã€‚<br>å¦‚å›¾æ‰€ç¤ºï¼Œä»¥S3ä¸ºä¾‹ï¼Œä¼šä»eth0,eth2,eth3ä¸‰ä¸ªç«¯å£æ”¶åˆ°æ ¹æ¡¥å‘æ¥çš„BPDUï¼Œeth3æ”¶åˆ°çš„æ˜¯S2ä¸­ç»§çš„BPDUï¼Œcostå€¼å¤§ï¼Œè€Œeth0å’Œeth2æ”¶åˆ°çš„BPDUçš„costä¸º0, æ‰€ä»¥åœ¨eth0å’Œeth2ä¹‹é—´é€‰ã€‚sender BIDéƒ½æ˜¯S1ï¼Œçœ‹PIDï¼ŒS3ä¸Šeth0æ”¶åˆ°çš„æ˜¯S1ä¸Šeth1å‘å‡ºï¼ŒPIDå°(ä¼˜å…ˆçº§ä¸€æ ·ï¼Œçœ‹ç«¯å£å·), æ‰€ä»¥S3ä¸Šeth0æ˜¯RPã€‚æ¢è¨€ä¹‹ï¼ŒS3çš„3ä¸ªç«¯å£æ”¶åˆ°çš„BPDUä¸­ï¼Œeth0æ”¶åˆ°çš„æ˜¯superior BPDUã€‚</p>
</li>
<li><p>æŒ‡å®šç«¯å£çš„é€‰ä¸¾<br>æ ¹æ¡¥ä¸Šçš„æ‰€æœ‰ç«¯å£éƒ½æ˜¯DPï¼Œå¯¹äºéæ ¹æ¡¥è®¾å¤‡ï¼Œé™¤RPå¤–ï¼Œå°†ç«¯å£æ”¶åˆ°çš„BPDUä¸å‘å‡ºçš„BPDUå¯¹æ¯”ï¼Œsuperior BPDUçš„ä½œä¸ºDPï¼Œinferior BPDUåˆ™ä½œä¸ºAP.<br>ä»»ä¸€é“¾è·¯ä¸­è‚¯å®šæœ‰ä¸€ä¸ªDPï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œä»¥S2ä¸ºä¾‹ï¼Œeth0æ˜¯RPï¼Œå‰©ä¸‹eth2è¿›è¡ŒDPé€‰ä¸¾ï¼Œeth2ä¸­ç»§eth0æ”¶åˆ°çš„BPDUç»™S3çš„eth3(å‘å‡ºçš„BPDU)ï¼ŒS3çš„eth3ä¸­ç»§eth0æ”¶åˆ°çš„BPDUç»™S2çš„eth2(æ”¶åˆ°çš„BPDU)ï¼Œcostä¸€è‡´ï¼Œæ¯”è¾ƒsender BIDï¼Œä¸¤è€…ä¼˜å…ˆçº§ä¸€è‡´ï¼Œä½†S2çš„MACæ›´å°ï¼Œæ‰€ä»¥S2çš„eth2æ˜¯DP, åŒç†ï¼ŒS3çš„eth3æ˜¯APã€‚æ¢è¨€ä¹‹ï¼ŒS2çš„eth2å‘å‡ºçš„BPDUç›¸è¾ƒäºæ”¶åˆ°çš„BPDUæ˜¯superior BPDUã€‚</p>
</li>
</ol>
<p>é€‰ä¸¾å®Œæˆä¹‹åï¼ŒDPå’ŒRPç»è¿‡listeningå’Œlearningçš„æ—¶å»¶åè¿›å…¥forwardingçŠ¶æ€ï¼ŒAPåˆ™å¤„äºblockingçŠ¶æ€ï¼Œç ´é™¤æ‹“æ‰‘çš„ç¯è·¯ã€‚æ ¹æ¡¥å‘¨æœŸå‘å¤–å‘é€é…ç½®BPDUï¼Œéæ ¹æ¡¥ä»RPæ¥æ”¶superior BPDUï¼ŒåŠ ä¸ŠRPçš„costï¼Œå°†<code>bridge ID</code>å­—æ®µæ”¹æˆè‡ªå·±çš„ï¼Œä»DPå‘å¤–ä¸­ç»§è¯¥BPDU(æºMACæ”¹æˆDPçš„MAC). </p>
<h1 id="STPæ”¶æ•›åœºæ™¯æè¿°"><a href="#STPæ”¶æ•›åœºæ™¯æè¿°" class="headerlink" title="STPæ”¶æ•›åœºæ™¯æè¿°"></a>STPæ”¶æ•›åœºæ™¯æè¿°</h1><p>åªæœ‰å½“RPæŒ‚ç‚¹åæ‰æœ‰æ”¶æ•›çš„æ„ä¹‰(é“¾è·¯å¿…å®šæœ‰ä¸€ç«¯æ˜¯RP)ã€‚äº¤æ¢æœºé€šè¿‡ä¸¤ç§æ–¹å¼å¯ä»¥æ„ŸçŸ¥åˆ°çº¿è·¯æ•…éšœã€‚</p>
<h2 id="ç›´æ¥æ„ŸçŸ¥"><a href="#ç›´æ¥æ„ŸçŸ¥" class="headerlink" title="ç›´æ¥æ„ŸçŸ¥"></a>ç›´æ¥æ„ŸçŸ¥</h2><p>é“¾è·¯ç‰©ç†ä¸Šæ˜¯ç›´è¿çš„ã€‚è¿™ç§åœºæ™¯ä¸‹åˆå¯ä»¥åˆ†ä¸¤ç§æƒ…å†µã€‚</p>
<h3 id="äº¤æ¢æœºä¸Šæ²¡æœ‰å­˜å‚¨BPDUçš„ç«¯å£"><a href="#äº¤æ¢æœºä¸Šæ²¡æœ‰å­˜å‚¨BPDUçš„ç«¯å£" class="headerlink" title="äº¤æ¢æœºä¸Šæ²¡æœ‰å­˜å‚¨BPDUçš„ç«¯å£"></a>äº¤æ¢æœºä¸Šæ²¡æœ‰å­˜å‚¨BPDUçš„ç«¯å£</h3><p>å½“äº¤æ¢æœºæ„ŸçŸ¥åˆ°ç«¯å£downæ‰åï¼Œä¼šç«‹é©¬æ¸…é™¤è¯¥ç«¯å£ä¸Šå­˜å‚¨çš„BPDU, å¦‚æœæ²¡æœ‰å…¶å®ƒå­˜å‚¨BPDUçš„ç«¯å£ï¼Œé‚£ä¹ˆè¯¥äº¤æ¢æœºå°±ä¼šå®£å‘Šè‡ªå·±æ˜¯æ–°çš„æ ¹æ¡¥ï¼Œå¹¶å°†è‡ªå·±çš„é…ç½®BPDUå‘å¤–å‘é€ï¼Œç”±äºçœŸå®æ ¹æ¡¥ä¾ç„¶å­˜åœ¨ï¼Œå…¶å®ƒäº¤æ¢æœºæ”¶åˆ°çš„æ˜¯inferior BPDU, ä¸ä¼šå¯¹å…¶åšä»»ä½•å¤„ç†ï¼Œç›´è‡³æ”¶åˆ°inferior BPDUçš„ç«¯å£è¶…æ—¶ã€‚</p>
<p>å¦‚STPé€‰ä¸¾æµç¨‹ä¸­çš„å›¾ç¤ºï¼Œå½“S2çš„eth0ç«¯å£downæ‰ä¹‹åï¼ŒS2è®¤ä¸ºè‡ªå·±æ˜¯æ ¹æ¡¥ï¼Œé€šè¿‡eth2ç»™S3çš„eth3å‘é€inferior BPDU(TCç½®ä½)ï¼ŒS3çš„eth3ä¸€ç›´æ”¶ä¸åˆ°superior BPDUï¼Œæœ€ç»ˆä¼šè¶…æ—¶(20ç§’)ï¼Œä¹‹åå˜æˆDP(ç»è¿‡listeningï¼Œlearningçš„30ç§’æ—¶å»¶åå˜æˆforwardingçŠ¶æ€ï¼Œé€šè¿‡RPå‘é€TCN)ï¼Œå¹¶ç«‹å³å‘S2ä¸­ç»§superior BPDUï¼ŒS2æ”¶åˆ°ä¹‹åçŸ¥é“æ ¹æ¡¥çš„å­˜åœ¨ï¼Œåœæ­¢å‘é€BPDUï¼Œå¹¶å°†eth2é€‰ä¸¾æˆRP(åŸåˆ™ä¸Šåº”è¯¥ç»å†listeningï¼Œlearningå†è½¬æˆforwardingï¼Œæ€ç§‘ä¸Šç›´æ¥å˜æˆforwardingï¼Œåº”è¯¥æ˜¯åšäº†ä¼˜åŒ–)ï¼ŒRPå˜æˆforwardingçŠ¶æ€åå‘é€TCNæŠ¥æ–‡ï¼Œæ‰€ä»¥æ”¶æ•›çš„æ€»è€—æ—¶æ¥è¿‘50ç§’(è¶…æ—¶æ²¡æœ‰ç®—message_age).</p>
<h3 id="äº¤æ¢æœºä¸Šæœ‰å­˜å‚¨BPDUçš„ç«¯å£"><a href="#äº¤æ¢æœºä¸Šæœ‰å­˜å‚¨BPDUçš„ç«¯å£" class="headerlink" title="äº¤æ¢æœºä¸Šæœ‰å­˜å‚¨BPDUçš„ç«¯å£"></a>äº¤æ¢æœºä¸Šæœ‰å­˜å‚¨BPDUçš„ç«¯å£</h3><p>åŒä¸Šï¼Œå¦‚æœäº¤æ¢æœºä¸Šæœ‰å…¶å®ƒå­˜å‚¨BPDUçš„ç«¯å£ï¼Œé‚£ä¹ˆä¼šåœ¨è¿™äº›ç«¯å£ä¸­é€‰å‡ºsuperior BPDUçš„ç«¯å£ä½œä¸ºæ–°çš„RPã€‚</p>
<p>å¦‚STPé€‰ä¸¾æµç¨‹ä¸­çš„å›¾ç¤ºï¼Œå½“S3çš„eth0ç«¯å£downæ‰ä¹‹åï¼ŒS3ä¼šåœ¨eth2å’Œeth3ä¹‹é—´é€‰ä¸¾å‡ºæ–°çš„RPï¼Œå¾ˆæ˜æ˜¾eth2ä¸Šå¸‚superior BPDUï¼Œeth2æˆä¸ºRPï¼Œç»è¿‡listeningå’Œlearningä¹‹åå˜æˆforwardingï¼Œå¹¶å‘é€TCNæŠ¥æ–‡ã€‚æ”¶æ•›æ—¶é—´æ˜¯30ç§’ã€‚</p>
<h2 id="é—´æ¥æ„ŸçŸ¥"><a href="#é—´æ¥æ„ŸçŸ¥" class="headerlink" title="é—´æ¥æ„ŸçŸ¥"></a>é—´æ¥æ„ŸçŸ¥</h2><p>é“¾è·¯ç‰©ç†ä¸Šæ˜¯éç›´è¿çš„ï¼Œæ¯”å¦‚ä¸­é—´é“¾è·¯ä¸­é—´æœ‰ä¸ªhubã€‚è¿™ç§æƒ…å†µä¸‹åªèƒ½ç­‰å¾…BPDUæŠ¥æ–‡è¶…æ—¶è§¦å‘ã€‚ä¹‹åçš„å¤„ç†æµç¨‹å’Œ<code>ç›´æ¥æ„ŸçŸ¥</code>ä¸€è‡´ï¼Œéœ€è¦åŠ ä¸Šé¢å¤–çš„20ç§’BPDUæŠ¥æ–‡è¶…æ—¶æ—¶é—´ã€‚</p>
<h1 id="STPæ‹“æ‰‘å˜åŒ–å¸¦æ¥çš„é—®é¢˜"><a href="#STPæ‹“æ‰‘å˜åŒ–å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="STPæ‹“æ‰‘å˜åŒ–å¸¦æ¥çš„é—®é¢˜"></a>STPæ‹“æ‰‘å˜åŒ–å¸¦æ¥çš„é—®é¢˜</h1><p>L2ä¾æ®Macåœ°å€è¡¨è¿›è¡Œè½¬å‘ï¼Œæ‹“æ‰‘å˜æ¢å¯èƒ½å¯¼è‡´Macåœ°å€è¡¨å¤±æ•ˆ. å½“stpæ”¶æ•›ä¹‹åï¼Œè™½ç„¶ä¼šé‡æ–°å­¦ä¹ åˆ°æ­£ç¡®çš„macåœ°å€ï¼Œä½†æ˜¯ä¼šè€—è´¹ç›¸å½“å¤šçš„æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯å½“æŸæ¡macåœ°å€ä¸å­˜åœ¨æˆ–è¶…æ—¶æ—¶é—´æ°å¥½æ˜¯æœ€å¤§å€¼(é»˜è®¤300ç§’). ä¸ºæ­¤ï¼Œå½“æ‹“æ‰‘å˜åŒ–æ—¶ï¼Œé€šè¿‡TCN BPDUé€šçŸ¥æ ¹æ¡¥ï¼Œæ ¹æ¡¥é€šè¿‡TCN ACK BPDUé€šçŸ¥æ‰€æœ‰äº¤æ¢æœºï¼Œæ”¶åˆ°æ­¤æŠ¥æ–‡çš„äº¤æ¢æœºå°†macåœ°å€è¡¨è¶…æ—¶æ”¹æˆforward_timeï¼Œå‘é€TCN BPDUçš„äº¤æ¢æœºæ”¶åˆ°ACKåä¼šåœæ­¢å‘é€TCN.</p>
<p>ç¼©çŸ­macåœ°å€çš„è€åŒ–æ—¶é—´ä¼šä½¿æ‹“æ‰‘ä¸ç¨³å®šï¼Œä¼šå­˜åœ¨æ³›æ´ªæµé‡ï¼Œå½“å¤§é‡æ‹“æ‰‘å‘ç”Ÿæ”¹å˜æ—¶ï¼Œè¿™ç§æƒ…å†µæ˜¯å¾ˆå±é™©çš„ã€‚RSTPä¸­ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ã€‚</p>
<h1 id="STPæ”¶æ•›çš„å‡ ä¸ªä¼˜åŒ–é…ç½®"><a href="#STPæ”¶æ•›çš„å‡ ä¸ªä¼˜åŒ–é…ç½®" class="headerlink" title="STPæ”¶æ•›çš„å‡ ä¸ªä¼˜åŒ–é…ç½®"></a>STPæ”¶æ•›çš„å‡ ä¸ªä¼˜åŒ–é…ç½®</h1><p>æ€ç§‘è®¾å¤‡ä¸Šæä¾›äº†å‡ ç§ä¼˜åŒ–é…ç½®æ¥å‡å°‘æ”¶æ•›æ—¶é—´, é™ä½ä¸å¿…è¦çš„macåœ°å€è¡¨åˆ·æ–°ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/stp_convergence.png"></p>
<p><code>portfast</code>åœ¨edge portä¸Šå¼€å¯ï¼Œå½“ç«¯å£çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä¼šå‘é€TCN BPDUï¼Œé¿å…åˆ·æ–°MACåœ°å€è¡¨ï¼Œç«¯å£å¯ä»¥ç›´æ¥ä»blockçŠ¶æ€å˜æˆforwardingçŠ¶æ€ï¼Œä¸éœ€è¦ç­‰å¾…30ç§’ã€‚å¼€å¯å‘½ä»¤å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Switch(config-if)#spanning-tree portfast edge	 &#x2F;&#x2F; åœ¨eth2ä¸Šå¼€å¯portfast</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šå›¾ï¼Œåœ¨eth2ä¸Šå¼€å¯portfaståï¼Œeth2ä¼šç›´æ¥å˜æˆforwardingçŠ¶æ€ï¼Œå¹¶ä¸”ä¸ä¼šå‘é€TCNæŠ¥æ–‡ã€‚</p>
<p><code>uplinkfast</code>å½“RPå¤±æ•ˆåï¼ŒAPè·³è¿‡listeningå’Œlearningçš„30ç§’ï¼Œç›´æ¥å˜æˆRPçš„forwardingçŠ¶æ€, å¼€å¯å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Switch(config)#spanning-tree uplinkfast		&#x2F;&#x2F; å…¨å±€å¼€å¯uplinkfast</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šå›¾ï¼Œshutdown S3ä¸Šçš„RP eth0, eth1ä¼šä»APç›´æ¥å˜æˆRPçš„forwardingçŠ¶æ€ã€‚<br>æ³¨æ„ï¼Œé…ç½®uplinkfaståï¼Œäº¤æ¢æœºä¼˜å…ˆçº§ä¼šè°ƒæ•´32768+4096(ä¸ä¼šé€‰æˆæ ¹æ¡¥)ï¼Œç«¯å£costä¼šå¢åŠ 3000(ä¸ä¼šé€‰æˆDP)</p>
<p><code>backbonefast</code>APç«¯å£æ”¶åˆ°inferior BPDUåignoreï¼Œç›´åˆ°max_ageè¶…æ—¶åå˜æˆDPï¼Œè€—æ—¶20ç§’ï¼Œå¼€å¯backbonefaståï¼Œä¸ç”¨ç­‰åˆ°è¶…æ—¶ï¼ŒAPç›´æ¥å˜æˆDPï¼Œå¼€å¯å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Switch(config)#spanning-tree backbonefast		&#x2F;&#x2F; éœ€è¦åœ¨æ‰€æœ‰äº¤æ¢æœºä¸Šå¼€å¯æ‰ç”Ÿæ•ˆ,åŸç†ä¸Šåº”è¯¥åªéœ€è¦åœ¨æ”¶åˆ°inferior BPDUçš„switchä¸Šå¼€å¯å°±è¡Œï¼Œæ¨¡æ‹Ÿå™¨bug?</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šå›¾ï¼ŒS2çš„eth0 downæ‰åï¼Œè®¤ä¸ºè‡ªå·±æ˜¯æ ¹æ¡¥å‘S3å‘é€inferior BPDUï¼Œæ­£å¸¸æƒ…å†µä¸‹S3å¿½ç•¥ï¼Œç›´åˆ°eth1è¶…æ—¶å˜æˆDP(20ç§’), ç„¶åS3å‘S2è½¬å‘superior BPDUï¼Œeth1å†ç»è¿‡listeningå’Œlearningçš„30ç§’æ—¶å»¶åè¿›å…¥forwardingçŠ¶æ€ï¼Œå®Œæˆæ”¶æ•›ã€‚å¼€å¯backbonefaståï¼Œeth1ä¸ç”¨ç­‰å¾…20ç§’è¶…æ—¶ï¼Œç›´æ¥å˜æˆDPï¼Œç„¶åå†ç»è¿‡30ç§’çŠ¶æ€å˜åŒ–åè¿›å…¥forwardingï¼Œæ”¶æ•›æ—¶é—´ç”±50ç§’å˜æˆ30ç§’ã€‚<br>å¾ˆå¤šæ–‡æ¡£ä¸­æœ‰directå’Œindirectçš„åŒºåˆ†ï¼Œå…¶å®æ²¡å•¥å¿…è¦ï¼Œå‘½ä»¤è¡Œä¸­ä¹Ÿæ²¡ä½“ç°ï¼Œç›´æ¥åˆ†æé”™è¯¯åœºæ™¯ï¼Œåˆ†æBPDUçš„æ¯”è¾ƒå³å¯ã€‚</p>
<h1 id="å‡ ç§å®‰å…¨æœºåˆ¶"><a href="#å‡ ç§å®‰å…¨æœºåˆ¶" class="headerlink" title="å‡ ç§å®‰å…¨æœºåˆ¶"></a>å‡ ç§å®‰å…¨æœºåˆ¶</h1><p><code>BPDU gard/filter</code>å¦‚æœç«¯å£ä½¿èƒ½BPDU gardï¼Œå½“ç«¯å£æ”¶åˆ°BPDUæ—¶å°†ç«¯å£downæ‰(error disable)ã€‚åº”è¯¥åœ¨æ‰€æœ‰çš„accessç«¯å£ä½¿èƒ½ï¼Œå³åªæœ‰äº¤æ¢æœºäº’è”çš„ç«¯å£è·‘STPã€‚å¯ä»¥é¿å…äº¤æ¢æœºattacks(æ”»å‡»è€…ä¼ªè£…æˆæ ¹äº¤æ¢æœºç›‘å¬æµé‡)å’Œincident(é STP/RSTP æ„ŸçŸ¥äº¤æ¢æœºæ’å…¥ç½‘ç»œå¯¼è‡´ç¯è·¯)ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Switch(config-if)#spanning-tree bpduguard enable		&#x2F;&#x2F; ç«¯å£ä¸‹å¼€å¯bpduguardï¼Œæ”¶åˆ°bpduå°†ç«¯å£errordisable</span><br><span class="line">Switch(config-if)#spanning-tree bpdufilter enable		&#x2F;&#x2F; ä¸shutdownç«¯å£ï¼Œåªæ˜¯ignoreæ”¶åˆ°çš„bpduï¼Œå…¶å®ƒæµé‡æ­£å¸¸è½¬å‘ï¼Œåœ¨APä¸Šå¼€å¯ï¼ŒBPDUè¶…æ—¶åä¼šå˜æˆDPï¼Œå½¢æˆç¯è·¯</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>STP</tag>
      </tags>
  </entry>
  <entry>
    <title>VRRPç®€è¿°</title>
    <url>/2022/07/07/VRRP%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>VRRP(virtual router redundancy protocol)å’Œ<code>HSRP</code>éå¸¸ç›¸ä¼¼ï¼ŒåŸç†ç›¸åŒï¼Œåªä¸è¿‡VRRPæ˜¯å…¬æœ‰çš„(RFC 3768)ï¼ŒHSRPæ˜¯æ€ç§‘ç§æœ‰çš„ã€‚<code>ã€ŠHSRPç®€è¿°ã€‹</code>ä¸­å¯¹è™šæ‹Ÿè·¯ç”±å†—ä½™åè®®åšäº†åŸºæœ¬çš„é˜è¿°å’Œå®éªŒè¯´æ˜ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æè¿°ä¸¤è€…ä¹‹é—´çš„å·®å¼‚ï¼Œç„¶ååšä¸ªå®éªŒæ¥éªŒè¯ä¸‹ã€‚</p>
<span id="more"></span>

<h1 id="VRRPä¸HSRPçš„å·®å¼‚"><a href="#VRRPä¸HSRPçš„å·®å¼‚" class="headerlink" title="VRRPä¸HSRPçš„å·®å¼‚"></a>VRRPä¸HSRPçš„å·®å¼‚</h1><table>
<thead>
<tr>
<th align="left"></th>
<th align="left">HSRP</th>
<th align="left">VRRP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">protocol</td>
<td align="left">cisco proprietary</td>
<td align="left">IETF-RFC3768</td>
</tr>
<tr>
<td align="left">number of groups</td>
<td align="left">0-255,0æ˜¯é»˜è®¤</td>
<td align="left">1-255</td>
</tr>
<tr>
<td align="left">active/standby</td>
<td align="left">ä¸€ä¸ªactive, ä¸€ä¸ªstandbyï¼Œå¤šä¸ªå€™é€‰è€…</td>
<td align="left">æœ¯è¯­å«æ³•ä¸åŒï¼Œä¸€ä¸ªmasterï¼Œå¤šä¸ªbackups</td>
</tr>
<tr>
<td align="left">Vip</td>
<td align="left">ä¸èƒ½å’Œä¸‰å±‚æ¥å£ipç›¸åŒ</td>
<td align="left">å¯ä»¥ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œä¼˜å…ˆçº§ç›´æ¥å˜æˆæœ€é«˜</td>
</tr>
<tr>
<td align="left">Vmac</td>
<td align="left">v1ï¼Œv2æœ‰å·®å¼‚ï¼Œè§hsrpç®€è¿°</td>
<td align="left">00:00:5e:00:01:xx, xxæ˜¯group id</td>
</tr>
<tr>
<td align="left">multicast address</td>
<td align="left">224.0.0.2</td>
<td align="left">224.0.0.18</td>
</tr>
<tr>
<td align="left">tracking</td>
<td align="left">interfaces or objects, è§¦å‘åé™ä½ä¼˜å…ˆçº§æˆ–é€€å‡ºç»„</td>
<td align="left">objeectsï¼Œè§¦å‘åé™ä½ä¼˜å…ˆçº§ï¼Œæ²¡æœ‰é€€å‡ºç»„</td>
</tr>
<tr>
<td align="left">timers</td>
<td align="left">hello timer 3ç§’ï¼Œhold time 10ç§’</td>
<td align="left">hello 1ç§’ï¼Œholdtime 3ç§’</td>
</tr>
<tr>
<td align="left">authentication</td>
<td align="left">æ”¯æŒ</td>
<td align="left">rfcä¸­ä¸æ”¯æŒï¼Œå‚å®¶æ”¯æŒ</td>
</tr>
<tr>
<td align="left">preempt</td>
<td align="left">é»˜è®¤ä¸å¼€å¯ï¼Œå¯é…ç½®</td>
<td align="left">é»˜è®¤å¼€å¯æŠ¢å </td>
</tr>
<tr>
<td align="left">æŠ¥æ–‡å°è£…</td>
<td align="left">UDP 1985</td>
<td align="left">åŸºäºIP</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">é»˜è®¤v1</td>
<td align="left">v2,v3ä¸¤ä¸ªç‰ˆæœ¬ï¼Œé»˜è®¤v2ï¼Œv3æ‰æ”¯æŒipv6</td>
</tr>
<tr>
<td align="left">load balancing</td>
<td align="left">æ”¯æŒä¸åŒç»„ä¹‹é—´</td>
<td align="left">æ”¯æŒä¸åŒç»„ä¹‹é—´</td>
</tr>
<tr>
<td align="left">priority</td>
<td align="left">ä¸æ”¯æŒè¾èŒï¼Œä¼˜å…ˆçº§ä¸º0å¯ä»¥æ‰‹åŠ¨é…ç½®ï¼Œæ²¡æœ‰ç‰¹æ®Šå«ä¹‰</td>
<td align="left">ä¼˜å…ˆçº§ä¸º0è¡¨ç¤ºæ”¾å¼ƒmasterä½ç½®ï¼Œä¼˜å…ˆçº§0ä¸èƒ½æ‰‹åŠ¨é…ç½®</td>
</tr>
</tbody></table>
<p>å…³äºè¾èŒï¼Œå½“masterè·¯ç”±å™¨æ¥å£shutdownæ—¶ï¼Œä¼šç«‹å³å‘é€ä¼˜å…ˆçº§ä¸º0çš„é€šå‘Šï¼Œvrrpä¸­ä¼˜å…ˆçº§ä¸º0è¡¨ç¤ºä¸å‚ä¸è™šæ‹Ÿç»„è®¡ç®—ï¼Œæ”¶åˆ°çš„backupsä¹‹é—´ä¼šç«‹å³é‡æ–°é€‰ä¸¾å‡ºæ–°çš„masterï¼Œå¦åˆ™å°±è¦ç­‰å¾…3ç§’çš„æŠ¥æ–‡è¶…æ—¶å†é€‰ä¸¾ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«æ”¶æ•›æ—¶é—´ã€‚ä¼˜å…ˆçº§ä¸º0çš„æŠ¥æ–‡å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/vrrp_packet_priority_0.png"></p>
<p>åœ¨HSRPä¸­ï¼Œtrackingä¸­è§¦å‘æ”¯æŒshutdownï¼Œå¦‚æœactiveè·¯ç”±å™¨æ¥å£shutdownï¼Œé‚£ä¹ˆstandbyåªèƒ½ç­‰å¾…10ç§’è¶…æ—¶åå˜æˆactive. VRRP trackingä¸­ä¸æ”¯æŒshutdownï¼Œå—¯ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰è·¯ç”±æ¥å£æ‰‹åŠ¨shutdownæˆ–ç‰©ç†çº¿è·¯æŒ‚æ‰æ‰ä¼šè§¦å‘ä¼˜å…ˆçº§ä¸º0çš„æŠ¥æ–‡ï¼Œè€Œä¸Šè¡Œé“¾è·¯æŒ‚æ‰trackingæ— æ³•è§¦å‘ï¼Ÿ</p>
<h1 id="å®éªŒè¯´æ˜"><a href="#å®éªŒè¯´æ˜" class="headerlink" title="å®éªŒè¯´æ˜"></a>å®éªŒè¯´æ˜</h1><p>å®éªŒæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/vrrp_basic_topology.png"></p>
<p>S2ã€S3ã€S4çš„interface vlan1åŠ å…¥è™šæ‹Ÿç»„ç»„æˆè™šæ‹Ÿè·¯ç”±å™¨ï¼Œè™šæ‹Ÿç»„å¯¹å¤–æä¾›ç½‘å…³æœåŠ¡ã€‚åŸºæœ¬é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2</span><br><span class="line">    interface Vlan1</span><br><span class="line">        ip address 192.168.1.1 255.255.255.0        &#x2F;&#x2F; svié…ç½®IPåœ°å€</span><br><span class="line">        vrrp 1 ip 192.168.1.254                     &#x2F;&#x2F; sviåŠ å…¥è™šæ‹Ÿç»„1ï¼Œè™šæ‹Ÿipä¸º192.168.1.254</span><br><span class="line">S3</span><br><span class="line">    interface Vlan1</span><br><span class="line">        ip address 192.168.1.2 255.255.255.0</span><br><span class="line">        vrrp 1 ip 192.168.1.254</span><br><span class="line">S4</span><br><span class="line">    interface Vlan1</span><br><span class="line">        ip address 192.168.1.3 255.255.255.0</span><br><span class="line">        vrrp 1 ip 192.168.1.254</span><br></pre></td></tr></table></figure>

<p><code>show vrrp brief</code>æŸ¥çœ‹vrrpçŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S4#show vrrp brief </span><br><span class="line">Interface          Grp Pri Time  Own Pre State   Master addr     Group addr</span><br><span class="line">Vl1                1   100 3609       Y  Master  192.168.1.3     192.168.1.254</span><br></pre></td></tr></table></figure>
<p>vrrpçš„é»˜è®¤ä¼˜å…ˆçº§ä¹Ÿæ˜¯100ï¼Œè¶…æœŸæ—¶é—´å•ä½æ˜¯æ¯«ç§’ï¼Œæœ‰è®¡ç®—å…¬å¼ï¼Œæ˜¯helloçš„ä¸‰å€å¤šç‚¹ï¼Œ<code>own</code>è¡¨ç¤ºæ˜¯å¦æ˜¯è™šæ‹Ÿç»„çš„æ‹¥æœ‰è€…ï¼Œå½“ç‰©ç†æ¥å£ipå’Œè™šæ‹Ÿç»„ipä¸€è‡´æ—¶æˆä¸ºowner, é€šè¿‡å°†ä¼˜å…ˆçº§ç½®ä½æœ€å¤§å€¼255å®ï¼Œå¦‚å°†S3è®¾ç½®æˆowner</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3(config-if)#ip address 192.168.1.254 255.255.255.0</span><br><span class="line">S3#show vrrp brief </span><br><span class="line">Interface          Grp Pri Time  Own Pre State   Master addr     Group addr</span><br><span class="line">Vl1                1   255 3003   Y   Y  Master  192.168.1.254   192.168.1.254</span><br></pre></td></tr></table></figure>
<p>ä¼˜å…ˆçº§ä¸º255çš„æŠ¥æ–‡ä¸ºï¼š</p>
<p><img src="https://rancho333.github.io/pictures/vrrp_packet_priority_255.png"></p>
<p>ownerä¸èƒ½è¢«é…ç½®ä¼˜å…ˆçº§ã€‚ vrrpé»˜è®¤å¼€å¯preemptï¼Œæ‰€ä»¥<code>pre</code>æ˜¯<code>Y</code>ã€‚æ³¨æ„vrrpç»„ä¸­é™¤masterå¤–ï¼Œå…¶ä½™éƒ½æ˜¯backupï¼Œå³masteræŒ‚æ‰åï¼Œä¼šä»backupä¸­é‡æ–°é€‰ä¸¾å‡ºæ–°çš„masterã€‚è€Œhsrpä¸­masteræŒ‚æ‰åï¼Œstandbyæ¥æ›¿ï¼Œä¹‹ååœ¨candidateä¸­é€‰ä¸¾å‡ºæ–°çš„standbyã€‚</p>
<p><strong>æ‰€ä»¥VRRPä¸­åªæœ‰masterå‘é€announcementï¼Œbackupç›‘å¬ã€‚hsrpä¸­activeå’Œbackupéƒ½éœ€è¦å‘é€helloæŠ¥æ–‡ã€‚</strong></p>
<p>å½“ç„¶ï¼ŒFHRPä¸­ä¸€èˆ¬æä¸¤å°è·¯ç”±å™¨åšç½‘å…³å†—ä½™å°±è¡Œäº†ã€‚</p>
<h2 id="å…¶å®ƒå®éªŒ"><a href="#å…¶å®ƒå®éªŒ" class="headerlink" title="å…¶å®ƒå®éªŒ"></a>å…¶å®ƒå®éªŒ</h2><p>trackingä¸Šè¡Œé“¾è·¯æ•…éšœï¼Œä¸åŒç»„ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œå’ŒHSRPæ²¡åŒºåˆ«ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚</p>
<h2 id="åŒæ´»ç½‘å…³"><a href="#åŒæ´»ç½‘å…³" class="headerlink" title="åŒæ´»ç½‘å…³"></a>åŒæ´»ç½‘å…³</h2><p>HSRP/VRRPåªèƒ½å®ç°å•æ´»ç½‘å…³ï¼Œåªæœ‰activeè¿›è¡Œarpåº”ç­”å’Œè½¬å‘ä¸šåŠ¡æµé‡ï¼Œstandbyåˆ™å®Œå…¨é—²ç½®ã€‚ç»“åˆMLAGåˆ™å¯å®ç°åŒæ´»ç½‘å…³:</p>
<ol>
<li>activeè´Ÿè´£arpåº”ç­”ï¼Œstandbyä¼šå°†arpä¸­ç»§ç»™active</li>
<li>æ§åˆ¶é¢è§†è§’è€Œè¨€ï¼Œä¾ç„¶æ˜¯active/standbyï¼Œæ•°æ®é¢è€Œè¨€active/activeè½¬å‘</li>
<li>æ¥å…¥äº¤æ¢æœºä¸Šmacåœ°å€è¡¨ä¸­vmacå¯¹åº”çš„ç«¯å£æ˜¯mlagèšåˆç«¯å£ï¼Œæ‰€ä»¥active/standbyéƒ½æœ‰å¯èƒ½æ”¶åˆ°æŠ¥æ–‡ï¼Œæ”¶åˆ°åæŒ‰è·¯ç”±è¡¨æ­£å¸¸è½¬å‘å³å¯ã€‚å¦‚æœä¸æ˜¯mlagåœºæ™¯ï¼Œstandbyæ”¶åˆ°ç›®çš„åœ°å€æ˜¯vmacçš„æŠ¥æ–‡ã€‚</li>
<li>evengä¸­ä¸æ”¯æŒvpcæ¨¡æ‹Ÿï¼Œvpcçš„peer-linkéœ€è¦10Gç«¯å£æ‰èƒ½è¿è¡Œï¼Œä¸ç„¶ä¼šåå„ç§é—®é¢˜ã€‚</li>
</ol>
<h2 id="ä¸ºç”švipä¸ä¼šå†²çª"><a href="#ä¸ºç”švipä¸ä¼šå†²çª" class="headerlink" title="ä¸ºç”švipä¸ä¼šå†²çª"></a>ä¸ºç”švipä¸ä¼šå†²çª</h2><p>åœ¨ä¸¤å°è®¾å¤‡ä¸Šéƒ¨ç½²äº†ç›¸åŒçš„vip+vmacï¼Œä¸ºä»€ä¹ˆä¸ä¼šå†²çªï¼Ÿ<br>IPé€šä¿¡é€šè¿‡arpæŠ¥æ–‡è·å–macï¼Œä¸»æœºè¯·æ±‚ç½‘å…³vipæ—¶ï¼Œåªæœ‰activeæ‰ä¼šåšå‡ºå›åº”ï¼Œæ‰€ä»¥é™¤äº†activeå¤–ï¼Œç½‘ç»œä¸­å¹¶ä¸ä¼šæœ‰å…¶å®ƒè®¾å¤‡æ„ŸçŸ¥åˆ°standbyã€‚<br>ä»å¦å¤–ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Ÿä¸€èˆ¬è®¾å¤‡é…ç½®ipåœ°å€åä¼šå‘å¤–å‘é€å…è´¹arpæŠ¥æ–‡ï¼Œä¸€æ˜¯é¿å…ipå†²çªï¼Œè€Œæ˜¯ä¸»åŠ¨å‘ŠçŸ¥å…¶å®ƒè®¾å¤‡è‡ªå·±arpä¿¡æ¯ã€‚äº¤æ¢æœºå˜æˆactiveåä¹Ÿä¼šä¸»åŠ¨å‘é€å…è´¹arpï¼Œstandbyæ”¶åˆ°åä¹Ÿä¸ä¼šå¤„ç†ï¼Œæ‰€ä»¥å°±ä¸å†²çªäº†ã€‚<br>ä»å®é™…é€šä¿¡æŠ¥æ–‡çš„è§’åº¦æ¥çœ‹ï¼Œstandbyæ˜¯æ”¶ä¸åˆ°vmacçš„æŠ¥æ–‡çš„ï¼Œå¦‚æœèƒ½æ”¶åˆ°ï¼Œä¹Ÿèƒ½æ­£å¸¸è½¬å‘ï¼Œè¿™å°±æ˜¯mlag+vrrpå®ç°åŒæ´»ç½‘å…³çš„åŸç†ã€‚</p>
]]></content>
      <tags>
        <tag>VRRP</tag>
      </tags>
  </entry>
  <entry>
    <title>VTPåè®®ç®€è¿°</title>
    <url>/2022/10/11/VTP%E5%8D%8F%E8%AE%AE%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ¬æ–‡ç®€è¦ä»‹ç»å†™ciscoçš„ç§æœ‰vlanä¸­ç»§åè®®VTP(vlan trunking protocol)ï¼Œç„¶åä½¿ç”¨evengç¯å¢ƒåšä¸€äº›ç®€å•å®éªŒã€‚</p>
<span id="more"></span>
<p>å½“äºŒå±‚ç¯å¢ƒä¸­æœ‰å¤šå°äº¤æ¢æœºï¼Œå¹¶ä¸”éœ€è¦é…ç½®å¤šä¸ªvlançš„æ—¶å€™ï¼Œè¿™æ˜¯ä¸€ä¸ªç¹çä¸”æ— èŠçš„é…ç½®è¡Œä¸ºã€‚VTPåè®®å¯ä»¥è®©æˆ‘ä»¬åªç”¨åœ¨ä¸€å°äº¤æ¢æœºä¸Šåˆ›å»ºvlanï¼Œå…¶å®ƒäº¤æ¢æœºåˆ™ä¼šåŒæ­¥åˆ›å»ºçš„vlanã€‚</p>
<h1 id="äº†è§£VTP"><a href="#äº†è§£VTP" class="headerlink" title="äº†è§£VTP"></a>äº†è§£VTP</h1><p>VTPè®¾å¤‡æœ‰ä¸‰ç§è§’è‰²ï¼š</p>
<ol>
<li>VTP serverï¼šå¯ä»¥ä¿®æ”¹vlané…ç½®ï¼Œç”ŸæˆVTPé€šå‘Š</li>
<li>VTP  clientï¼šä¸å¯ä»¥é€šè¿‡CLIä¿®æ”¹vlané…ç½®ï¼Œåªèƒ½é€šè¿‡åŒæ­¥VTPé€šå‘Šä¿®æ”¹vlané…ç½®</li>
<li>VTP transparentï¼šé€ä¼ VTPé€šå‘Šä½†æ˜¯ä¸åŒæ­¥ï¼Œå¯ä»¥ä¿®æ”¹æœ¬åœ°vlanï¼Œä¿®æ”¹ä¹Ÿåªåœ¨æœ¬åœ°ç”Ÿæ•ˆ</li>
</ol>
<p>VTPä¸‰ç§æ¨¡å¼çš„èƒ½åŠ›æ¦‚è¦å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">VTP server</th>
<th align="left">VTP Client</th>
<th align="left">VTP transparent</th>
</tr>
</thead>
<tbody><tr>
<td align="left">åˆ›å»º/ä¿®æ”¹/åˆ é™¤ vlans</td>
<td align="left">yes</td>
<td align="left">no</td>
<td align="left">only local</td>
</tr>
<tr>
<td align="left">åŒæ­¥</td>
<td align="left">yes</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">é€ä¼ </td>
<td align="left">yes</td>
<td align="left">yes</td>
<td align="left">yes</td>
</tr>
</tbody></table>
<p>é€šè¿‡ä¸‹é¢å‡ æ¡è¯´æ˜æ¥ç®€å•äº†è§£ä¸‹VTPï¼š</p>
<ol>
<li>VTPå¯ä»¥è‡ªåŠ¨æ·»åŠ ï¼Œä¿®æ”¹ï¼Œåˆ é™¤vlans</li>
<li>å¯¹äºæ¯ä¸€æ¬¡æ”¹åŠ¨ï¼Œ<code>revision</code>ç¼–å·ä¼šå¢åŠ </li>
<li>æœ€è¿‘ä¸€æ¬¡çš„é€šå‘Šä¼šè¢«å‘é€ç»™æ‰€æœ‰çš„VTP clients</li>
<li>VTP clientsä¼šåŒæ­¥æ¥æ”¶åˆ°çš„é€šå‘Š</li>
</ol>
<p>VTPè™½ç„¶å¯ä»¥å‡å°‘vlané…ç½®çš„å·¥ä½œé‡ï¼Œä½†æ˜¯ä¼šå­˜åœ¨ä¸€äº›é£é™©ã€‚æ ¹æœ¬åŸå› æ˜¯ï¼š<br>  VTP serveråŒæ—¶ä¹Ÿæ˜¯VTP client, è€ŒVTP clientä¼šåŒæ­¥æ¥æ”¶åˆ°çš„revisionå·æ¯”è‡ªå·±å¤§çš„é€šå‘Šã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åœ¨ç°æœ‰çš„ç½‘ç»œç¯å¢ƒä¸­æ·»åŠ ä¸€å°VTP serverï¼Œè€Œè¿™å°VTP serverä¸Šçš„revisionå·æ¯”ç°æœ‰ç¯å¢ƒä¸­è®¾å¤‡çš„éƒ½å¤§ï¼Œé‚£ä¹ˆæ–°è®¾å¤‡ä¸Šçš„vlané…ç½®ä¼šè¦†ç›–æ‰€æœ‰è®¾å¤‡ã€‚æœ¬è´¨å°±æ˜¯ç¯å¢ƒä¸­å¯èƒ½ä¼šæœ‰éé¢„æœŸè®¾å¤‡çš„revisionæœ€å¤§ï¼Œè¦†ç›–ç¯å¢ƒçš„vlané…ç½®ã€‚</p>
<p>æ­¤å¤–è¿˜éœ€è¦äº†è§£VTPçš„å¦ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šVTP pruning.<br><img src="https://rancho333.github.io/pictures/vtp_pruning.png"></p>
<p>å¦‚å›¾ï¼Œäº¤æ¢æœºä¹‹é—´é€šè¿‡trunkäº’è”ã€‚å½“å·¦ä¾§vlan10ä¸­çš„PCå‘é€ä¸€ä¸ªå¹¿æ’­æŠ¥æ–‡åï¼Œæ‰€æœ‰äº¤æ¢æœºéƒ½ä¼šæ”¶åˆ°æ³›æ´ªçš„æ¶ˆæ¯ï¼Œè€Œä¸­é—´äº¤æ¢æœºçš„ä¸‹è”å£ä¸­å¹¶æ²¡æœ‰vlan10ï¼Œä¸Šè”äº¤æ¢æœºæ³›æ´ªæµé‡å°±æ˜¯åœ¨æµªè´¹å¸¦å®½äº†ã€‚<br>åœ¨éVTPç¯å¢ƒä¸‹ï¼Œæ³›æ´ªæµé‡ä¼šå‘é€ç»™æ‰€æœ‰çš„trunkç«¯å£(trunkå…è®¸è¯¥vlané€šè¿‡)ï¼Œå› ä¸ºäº¤æ¢æœºå¹¶ä¸çŸ¥é“trunkå¯¹ç«¯æ˜¯å¦æœ‰åœ¨è¯¥vlançš„æˆå‘˜ã€‚<br>åœ¨VTPç¯å¢ƒä¸‹ï¼Œäº¤æ¢æœºçŸ¥é“trunkå¯¹ç«¯é…ç½®äº†é‚£äº›vlanï¼Œæ‰€ä»¥ä¸åœ¨è¿™äº›vlanèŒƒå›´çš„å†…æ³›æ´ªæµé‡å°±å¯ä»¥ä¸å‘é€ç»™å¯¹ç«¯ã€‚è¿™å°±æ˜¯VTP pruning.</p>
<h1 id="VTPçš„é…ç½®"><a href="#VTPçš„é…ç½®" class="headerlink" title="VTPçš„é…ç½®"></a>VTPçš„é…ç½®</h1><p>ä½¿ç”¨å¦‚ä¸‹çš„æ‹“æ‰‘æ¥è¿›è¡ŒVTPçš„é…ç½®å®éªŒï¼š<br><img src="https://rancho333.github.io/pictures/vtp_topology.png"></p>
<p>å°†äº¤æ¢æœºä¹‹é—´çš„äº’è”æ¥å£å…¨éƒ¨é…ç½®æˆtrunkã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3#show vtp status </span><br><span class="line">VTP Version capable             : 1 to 3</span><br><span class="line">VTP version running             : 1</span><br><span class="line">VTP Domain Name                 : </span><br><span class="line">VTP Pruning Mode                : Disabled</span><br><span class="line">VTP Traps Generation            : Disabled</span><br><span class="line">Device ID                       : aabb.cc80.3000</span><br><span class="line">Configuration last modified by 0.0.0.0 at 0-0-00 00:00:00</span><br><span class="line">Local updater ID is 0.0.0.0 (no valid interface found)</span><br><span class="line"></span><br><span class="line">Feature VLAN:</span><br><span class="line">--------------</span><br><span class="line">VTP Operating Mode                : Server</span><br><span class="line">Maximum VLANs supported locally   : 1005</span><br><span class="line">Number of existing VLANs          : 5</span><br><span class="line">Configuration Revision            : 0</span><br><span class="line">MD5 digest                        : 0x57 0xCD 0x40 0x65 0x63 0x59 0x47 0xBD </span><br><span class="line">                                    0x56 0x9D 0x4A 0x3E 0xA5 0x69 0x35 0xBC </span><br></pre></td></tr></table></figure>
<p>S4ã€S5çš„VTPä¿¡æ¯å’ŒS3åŸºæœ¬ä¸€è‡´ï¼Œå¯¹æ˜¾ç¤ºçš„ä¿¡æ¯åšä¸€ä¸ªç®€å•çš„è¯´æ˜ï¼š</p>
<ul>
<li><code>Configuration Revision 0</code>: æ¯ä¸€æ¬¡ä¿®æ”¹vlanè¯¥æ•°å€¼éƒ½ä¼šåŠ 1. 0æ˜¯åˆå§‹å€¼ï¼Œæ²¡æœ‰ä»»ä½•vlanæ“ä½œ</li>
<li><code>VTP Operating Mode</code> : é»˜è®¤çš„æ¨¡å¼æ˜¯serveræ¨¡å¼</li>
<li><code>VTP Pruning Mode</code> : é˜²æ­¢ä¸å¿…è¦çš„æµé‡é€šè¿‡trunké“¾è·¯</li>
<li> <code>VTP version running</code> : å½“å‰è¿è¡Œçš„vtpç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯v1. v2ä¸v1çš„å·®åˆ«ä¸å¤§ï¼Œv2ä¸Šä¸»è¦å¼•å…¥å¯¹ä»¤ç‰Œç¯vlançš„æ”¯æŒã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3(config)#vlan 10</span><br><span class="line">S3(config-vlan)#name first_vlan</span><br><span class="line"></span><br><span class="line">S3#show vlan brief </span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0&#x2F;0, Et0&#x2F;1, Et0&#x2F;2, Et0&#x2F;3</span><br><span class="line">10   first_vlan                       active    </span><br><span class="line"></span><br><span class="line">S3#show vtp status | include Revision</span><br><span class="line">Configuration Revision            : 1</span><br></pre></td></tr></table></figure>
<p>åœ¨S3ä¸Šåˆ›å»ºåä¸ºfirst_vlançš„vlan10, å¯ä»¥çœ‹åˆ°revisionå·å¢åŠ äº†1. ä½†æ˜¯åœ¨S4ã€S5ä¸Šå¹¶æ²¡æœ‰ä»»ä½•åŒæ­¥åŠ¨ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S4#show vtp status | begin existing</span><br><span class="line">Number of existing VLANs          : 5</span><br><span class="line">Configuration Revision            : 0</span><br><span class="line"></span><br><span class="line">S5#show vtp status | begin existing   </span><br><span class="line">Number of existing VLANs          : 5</span><br><span class="line">Configuration Revision            : 0</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºå¿…é¡»è¦é…ç½®VTP domainæ‰èƒ½æ­£å¸¸åŒæ­¥ã€‚</p>
<p>åœ¨S4ã€S5ä¸Šå¼€å¯VTP debugã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S4#debug sw-vlan vtp events </span><br><span class="line">vtp events debugging is on</span><br><span class="line"></span><br><span class="line">S5#debug sw-vlan vtp events </span><br><span class="line">vtp events debugging is on</span><br></pre></td></tr></table></figure>

<p>åœ¨S3ä¸Šé…ç½®vtp domain:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3(config)#vtp domain rancho                   &#x2F;&#x2F; é…ç½®vtp domain</span><br><span class="line">Changing VTP domain name from NULL to rancho</span><br><span class="line">S3(config)#</span><br><span class="line">*Oct 11 08:02:34.648: %SW_VLAN-6-VTP_DOMAIN_NAME_CHG: VTP domain name changed to rancho.</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨S4ã€S5çœ‹åˆ°vtp domainä¼šè‡ªåŠ¨åŒæ­¥è¿‡æ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S5#</span><br><span class="line">*Oct 11 08:14:23.822: VTP LOG RUNTIME: Summary packet received in NULL domain state</span><br><span class="line">*Oct 11 08:14:23.822: VTP LOG RUNTIME: Summary packet received, domain &#x3D; rancho, rev &#x3D; 1, followers &#x3D; 0, length 77, trunk Et0&#x2F;1</span><br><span class="line">*Oct 11 08:14:23.822: VTP LOG RUNTIME: Transitioning from NULL to rancho domain</span><br><span class="line">*Oct 11 08:14:23.822: VTP LOG RUNTIME: Summary packet rev 1 greater than domain rancho rev 0</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä»¶æœ‰æ„æ€çš„äº‹ï¼š</p>
<ul>
<li>S5æ”¶åˆ°æ¥è‡ªdomainä¸º<code>rancho</code>çš„VTPæŠ¥æ–‡ï¼Œå¹¶ä¸”å†³å®šå°†è‡ªå·±çš„domainä»<code>NULL</code>æ”¹æˆ<code>rancho</code>ã€‚è¿™åªä¼šå­˜åœ¨äºè®¾å¤‡æ²¡æœ‰é…ç½®domainçš„æ—¶å€™</li>
<li>S5å‘ç°VTPæŠ¥æ–‡ä¸­revision(1)æ¯”è‡ªå·±å½“å‰(0)çš„é«˜ï¼ŒåŒæ­¥æŠ¥æ–‡ä¸­çš„vlanä¿¡æ¯</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S5#no debug all                        &#x2F;&#x2F; å…³é—­debugåŠŸèƒ½</span><br><span class="line"></span><br><span class="line">S5#show vtp status | begin existing</span><br><span class="line">Number of existing VLANs          : 6</span><br><span class="line">Configuration Revision            : 1       &#x2F;&#x2F; revisionæ•°å€¼å¢å‡äº†ï¼ŒåŒæ­¥äº†S3çš„vlané…ç½®</span><br><span class="line"></span><br><span class="line">S5#show vlan brief                         &#x2F;&#x2F; ç¡®è®¤é…ç½®ä¿¡æ¯åŒæ­¥ï¼Œvlan10æœ‰äº†</span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0&#x2F;2, Et0&#x2F;3</span><br><span class="line">10   first_vlan                       active    </span><br><span class="line"></span><br><span class="line">S4#show vlan brief </span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0&#x2F;2, Et0&#x2F;3</span><br><span class="line">10   first_vlan                       active    </span><br></pre></td></tr></table></figure>

<p>åˆ†åˆ«åœ¨S4ã€S5ä¸Šå„åˆ›å»ºä¸€ä¸ªvlan</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S4(config)#vlan 40</span><br><span class="line">S4(config-vlan)#name second_vlan</span><br><span class="line"></span><br><span class="line">S5(config)#vlan 50</span><br><span class="line">S5(config-vlan)#name third_vlan</span><br></pre></td></tr></table></figure>
<p>åœ¨S3ä¸Šå¯ä»¥æ­£å¸¸åŒæ­¥åˆ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3#show vlan brief </span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0&#x2F;2, Et0&#x2F;3</span><br><span class="line">10   first_vlan                       active    </span><br><span class="line">40   second_vlan                      active    </span><br><span class="line">50   third_vlan                       active    </span><br><span class="line"></span><br><span class="line">S3#show vtp status | include Revision</span><br><span class="line">Configuration Revision            : 3            &#x2F;&#x2F; åŒæ­¥ä¸¤æ¬¡ï¼Œrevisionä»1å¢åŠ åˆ°3</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹S3çš„æ¨¡å¼ä¸ºclientï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3(config)#vtp mode client </span><br><span class="line">S3#show vtp status | include Mode</span><br><span class="line">VTP Pruning Mode                : Disabled</span><br><span class="line">VTP Operating Mode                : Client</span><br><span class="line"></span><br><span class="line">S3(config)#vlan  100</span><br><span class="line">VTP VLAN configuration not allowed when device is in CLIENT mode.</span><br><span class="line">&#x2F;&#x2F; clientæ¨¡å¼å°±ä¸èƒ½é…ç½®valnäº†</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹S3çš„æ¨¡å¼ä¸ºé€ä¼ æ¨¡å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3(config)#vtp mode transparent </span><br><span class="line">Setting device to VTP Transparent mode for VLANS.</span><br><span class="line">&#x2F;&#x2F; å¯ä»¥æœ¬åœ°ä¿®æ”¹vlanä¿¡æ¯ï¼Œä½†æ˜¯ä¸ä¼šå½±å“å…¶å®ƒçš„vtpè®¾å¤‡</span><br><span class="line"></span><br><span class="line">S4(config)#vlan 70</span><br><span class="line">S5#show spanning-tree | include Altn</span><br><span class="line">Et0&#x2F;0               Altn BLK 100       128.1    P2p    &#x2F;&#x2F; S4,5ä¹‹é—´çš„ç›´è¿é“¾è·¯è¢«blockäº†</span><br><span class="line">S5#show vlan brief </span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0&#x2F;2, Et0&#x2F;3</span><br><span class="line">10   first_vlan                       active    </span><br><span class="line">40   second_vlan                      active    </span><br><span class="line">50   third_vlan                       active    </span><br><span class="line">70   VLAN0070                         active           &#x2F;&#x2F;ä½†æ˜¯S5ä¾ç„¶èƒ½å­¦åˆ°S4çš„vlan, èµ°çš„æ˜¯S3çš„é€ä¼ </span><br><span class="line"></span><br><span class="line">S3#show vlan brief                  &#x2F;&#x2F; é€ä¼ æ¨¡å¼çš„S3å¹¶æ²¡æœ‰å­¦åˆ°vlan70</span><br><span class="line"></span><br><span class="line">VLAN Name                             Status    Ports</span><br><span class="line">---- -------------------------------- --------- -------------------------------</span><br><span class="line">1    default                          active    Et0&#x2F;2, Et0&#x2F;3</span><br><span class="line">10   first_vlan                       active    </span><br><span class="line">40   second_vlan                      active    </span><br><span class="line">50   third_vlan                       active    </span><br><span class="line">60   VLAN0060                         active    </span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€ä¸ªå°çš„çŸ¥è¯†ç‚¹å°±æ˜¯å…³äºvlançš„é…ç½®æ–‡ä»¶ã€‚åªè¦å¼€å¯vtpåŠŸèƒ½ï¼Œvlançš„é…ç½®ä¿¡æ¯æ˜¯ç‹¬ç«‹å­˜æ”¾åœ¨vlan.dataæ–‡ä»¶ä¸­çš„</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3#dir unix: | include vlan</span><br><span class="line">917755  -rw-         796  Oct 11 2022 08:34:46 +00:00  vlan.dat-00048</span><br><span class="line">&#x2F;&#x2F; ä¸åŒçš„è®¾å¤‡å­˜æ”¾çš„è·¯å¾„å¯èƒ½ä¸ä¸€æ ·</span><br></pre></td></tr></table></figure>
<p>å¹¶ä¸”vlançš„é…ç½®ä¿¡æ¯åœ¨show runä¸­æ˜¯æŸ¥çœ‹ä¸åˆ°çš„ï¼Œå½“å…³é—­vtpæ—¶ï¼Œvlançš„é…ç½®ä¿¡æ¯å°±å¯ä»¥åœ¨show runä¸­çœ‹åˆ°äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S3(config)#vtp mode off </span><br><span class="line"></span><br><span class="line">S3#show running-config | include vlan</span><br><span class="line">vlan 10</span><br><span class="line"> name first_vlan</span><br><span class="line">vlan 40</span><br><span class="line"> name second_vlan</span><br><span class="line">vlan 50</span><br><span class="line"> name third_vlan</span><br><span class="line">vlan 60 </span><br></pre></td></tr></table></figure>

<p>æœ€æœ€åå…³äºVTPv3, V3å’ŒV2å…¼å®¹ï¼Œå’Œv1å…¼å®¹ã€‚æœ‰æ¯”è¾ƒå¤§çš„å·®å¼‚ï¼Œä¸»è¦åœ¨ï¼š</p>
<ul>
<li>VTP primary Server</li>
<li>Extended vlanss</li>
<li>private vlanss</li>
<li>rspan vlanss</li>
<li>mst support</li>
<li>authentication improvements<br>è¿™é‡Œä¸åšæ·±å…¥ç ”ç©¶äº†ï¼Œäº†è§£ç‚¹VTPv2çš„çš®æ¯›å…ˆ, å‡‘åˆç”¨ä¸‹å§ã€‚</li>
</ul>
<p>ä¸ºäº†ä¸¥è°¨ç‚¹ï¼Œé™„ä¸Šä¸€ä¸ªVTPæŠ¥æ–‡æˆªå›¾å§, åˆ›å»ºvlan80æ—¶æŠ“çš„ï¼Œçœ‹æ¥vtpä¼šæºå¸¦æ‰€æœ‰çš„vlanä¿¡æ¯ã€‚<br><img src="https://rancho333.github.io/pictures/vtp_packet.png"></p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.cisco.com/c/zh_cn/support/docs/lan-switching/vtp/10558-21.html">äº†è§£ VLAN ä¸­ç»§åè®® (VTP)</a></p>
]]></content>
  </entry>
  <entry>
    <title>broadcom_sdk_cmd</title>
    <url>/2021/01/19/broadcom-sdk-cmd/</url>
    <content><![CDATA[<h1 id="BCMShellç®€ä»‹"><a href="#BCMShellç®€ä»‹" class="headerlink" title="BCMShellç®€ä»‹"></a>BCMShellç®€ä»‹</h1><p>BCMShellæ˜¯Broadcomå…¬å¸å¯¹äºASICçš„SDKå‘½ä»¤è§£é‡Šå™¨ã€‚åˆ©ç”¨è¯¥å·¥å…·å¯ä»¥å¯¹ASICæ‰€æœ‰çš„å¯„å­˜å™¨å’Œå†…å­˜è¿›è¡Œè¯»å†™æ“ä½œï¼Œè¿˜å¯ä»¥åˆ©ç”¨è„šæœ¬åœ¨ASICä¸Šæ­å»ºå„ç§å¤æ‚çš„ç½‘ç»œç¯å¢ƒã€‚</p>
<span id="more"></span>

<h1 id="BCMShellçš„å‡ ç§æ¨¡å¼"><a href="#BCMShellçš„å‡ ç§æ¨¡å¼" class="headerlink" title="BCMShellçš„å‡ ç§æ¨¡å¼"></a>BCMShellçš„å‡ ç§æ¨¡å¼</h1><h2 id="BCMshellæ¨¡å¼"><a href="#BCMshellæ¨¡å¼" class="headerlink" title="BCMshellæ¨¡å¼"></a>BCMshellæ¨¡å¼</h2><p>æ‹¿åˆ°Broadcomæºç åï¼Œæ ¹æ®OSä¸Šçš„kernelç‰ˆæœ¬é€‰æ‹©å¯¹åº”çš„å†…æ ¸å¤´æ–‡ä»¶ç¼–è¯‘SDKï¼Œä¹‹åä¼šå¾—åˆ°å‡ ä¸ªæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bcm.user  bcm.user.dbg  linux-bcm-knet.ko  linux-kernel-bde.ko  linux-user-bde.ko  netserve</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒSDKåŒ…è¿è¡Œç¯å¢ƒä¸­çš„<code>auto_load_user.sh</code>ï¼Œå®‰è£…å¯¹åº”é©±åŠ¨ï¼Œå¯åŠ¨<code>bcm.user</code>å³å¯è¿›å…¥BCMShellå‘½ä»¤è¡Œï¼Œæç¤ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BCM.0&gt; </span><br><span class="line">BCM.0&gt; exit</span><br></pre></td></tr></table></figure>
<p><code>exit</code>é€€å›åˆ°shellã€‚<br>å¦‚æœOSæ˜¯SONiCï¼Œæ‰§è¡Œ<code>bcmsh</code>ä¹Ÿå¯è¿›å…¥ï¼Œé€šè¿‡<code>bcmcmd cmd</code>å¯ä»¥åœ¨shellä¸‹åœ¨BCMShellä¸­æ‰§è¡Œå‘½ä»¤ã€‚</p>
<h2 id="å›é€€åˆ°shellæ¨¡å¼"><a href="#å›é€€åˆ°shellæ¨¡å¼" class="headerlink" title="å›é€€åˆ°shellæ¨¡å¼"></a>å›é€€åˆ°shellæ¨¡å¼</h2><p>åœ¨BCMShellæ¨¡å¼ä¸­é€šè¿‡å‘½ä»¤<code>shell</code>å¯ä»¥è¿›å…¥shellé‡Œé¢æ‰§è¡Œå‘½ä»¤ï¼Œåº”è¯¥æ˜¯å°†bcmshellæ”¾åˆ°åå°è¿è¡Œï¼Œåœ¨shellä¸­exitå³å¯å†æ¬¡å›åˆ°bcmshellã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BCM.0&gt; </span><br><span class="line">BCM.0&gt; shell</span><br><span class="line">root@sonic:&#x2F;home&#x2F;admin&#x2F;R1241-M0150-01_V0.0.2_Questone2F_SDK# exit</span><br><span class="line">exit</span><br><span class="line">BCM.0&gt; exit</span><br><span class="line">root@sonic:&#x2F;home&#x2F;admin&#x2F;R1241-M0150-01_V0.0.2_Questone2F_SDK# </span><br></pre></td></tr></table></figure>

<h2 id="cintæ¨¡å¼"><a href="#cintæ¨¡å¼" class="headerlink" title="cintæ¨¡å¼"></a>cintæ¨¡å¼</h2><p>åœ¨BCMShellæ¨¡å¼ä¸­é€šè¿‡å‘½ä»¤<code>cint</code>å¯ä»¥è¿›å…¥åˆ°C interpreteræ¨¡å¼ï¼Œå¯ä»¥åœ¨é‡Œé¢æ‰§è¡ŒCå‡½æ•°ï¼Œå¦‚gearboxçš„ä¸€äº›æ“ä½œå¯ä»¥åœ¨é‡Œé¢å®Œæˆï¼Œ<code>exit;</code>å›é€€é“bcmshellã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BCM.0&gt; </span><br><span class="line">BCM.0&gt; cint</span><br><span class="line">Entering C Interpreter. Type &#39;exit;&#39; to quit.</span><br><span class="line"></span><br><span class="line">cint&gt; exit;</span><br><span class="line">BCM.0&gt; </span><br></pre></td></tr></table></figure>

<h1 id="BCMShellçš„ä¸€äº›ç‰¹ç‚¹"><a href="#BCMShellçš„ä¸€äº›ç‰¹ç‚¹" class="headerlink" title="BCMShellçš„ä¸€äº›ç‰¹ç‚¹"></a>BCMShellçš„ä¸€äº›ç‰¹ç‚¹</h1><ol>
<li>ä¸åŒºåˆ†å¤§å°å†™</li>
<li>æ”¯æŒç¼©å†™</li>
</ol>
<p><code>?</code>å¯ä»¥æ˜¾ç¤ºæ‰€æœ‰å‘½ä»¤ã€‚ä»¥<code>PortStat</code>ä¸ºä¾‹ï¼šPortStatå’Œportstatç­‰æ•ˆï¼Œç¼©å†™è§„åˆ™æ˜¯å¤§å†™å­—æ¯æ˜¯å¯ç¼©å†™é¡¹ï¼ŒPortStatå¯ç¼©å†™ä¸ºps</p>
<h1 id="å‘½ä»¤è¯´æ˜"><a href="#å‘½ä»¤è¯´æ˜" class="headerlink" title="å‘½ä»¤è¯´æ˜"></a>å‘½ä»¤è¯´æ˜</h1><p>BCMShellå‘½ä»¤å¯ä»¥åˆ†ä¸ºäº”ç±»ï¼š</p>
<ol>
<li>å¸®åŠ©å‘½ä»¤</li>
<li>showå‘½ä»¤</li>
<li>ä½çº§å‘½ä»¤ï¼šå¯¹å¯„å­˜å™¨/RAMè¿›è¡Œè¯»å†™çš„å‘½ä»¤</li>
<li>ç«¯å£å‘½ä»¤ï¼šä¸ç«¯å£ç›¸å…³çš„å‘½ä»¤</li>
<li>èŠ¯ç‰‡MACå­¦ä¹ ï¼Œé€šä¿¡åè®®ç›¸å…³çš„å‘½ä»¤</li>
</ol>
<h2 id="å¸®åŠ©å‘½ä»¤"><a href="#å¸®åŠ©å‘½ä»¤" class="headerlink" title="å¸®åŠ©å‘½ä»¤"></a>å¸®åŠ©å‘½ä»¤</h2><p>æ€»å…±æœ‰äº”ç§å¸®åŠ©å‘½ä»¤ä½¿ç”¨æ–¹æ³•ï¼Œä½¿ç”¨ä¸€ç§å³å¯<code>cmd + ?</code>ï¼Œå¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BCM.0&gt; ps ?</span><br><span class="line">Usage (PortStat): Display info about port status in table format.</span><br><span class="line">    Link scan modes:</span><br><span class="line">        SW &#x3D; software</span><br><span class="line">        HW &#x3D; hardware</span><br><span class="line">    Learn operations (source lookup failure control):</span><br><span class="line">        F &#x3D; SLF packets are forwarded</span><br><span class="line">        C &#x3D; SLF packets are sent to the CPU</span><br><span class="line">        A &#x3D; SLF packets are learned in L2 table</span><br><span class="line">        D &#x3D; SLF packets are discarded.</span><br><span class="line">    Pause:</span><br><span class="line">        TX &#x3D; Switch will transmit pause packets</span><br><span class="line">        RX &#x3D; Switch will obey pause packets</span><br></pre></td></tr></table></figure>

<h2 id="showå‘½ä»¤"><a href="#showå‘½ä»¤" class="headerlink" title="showå‘½ä»¤"></a>showå‘½ä»¤</h2><p>å¸¸ç”¨showå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show c                  æŸ¥çœ‹ASICå„ä¸ªç«¯å£æ”¶å‘åŒ…æƒ…å†µï¼Œå¯ä»¥åŠ å­å‘½ä»¤è¿‡æ»¤</span><br><span class="line">show ip                 æŸ¥çœ‹ipæŠ¥æ–‡ç»Ÿè®¡è®¡æ•°</span><br><span class="line">show icmp               æŸ¥çœ‹icmpæŠ¥æ–‡ç»Ÿè®¡è®¡æ•°</span><br><span class="line">show arp                æŸ¥çœ‹arpæŠ¥æ–‡ç»Ÿè®¡è®¡æ•°</span><br><span class="line">show udp   </span><br><span class="line">show tcp</span><br><span class="line">show routes             æŸ¥çœ‹å­ç½‘è·¯ç”±è¡¨å’Œä¸»æœºè·¯ç”±è¡¨</span><br><span class="line"></span><br><span class="line">show unit               æŸ¥çœ‹èŠ¯ç‰‡ä¿¡æ¯</span><br><span class="line">show params             æŸ¥çœ‹å½“å‰èŠ¯ç‰‡é©±åŠ¨é…ç½®å‚æ•°</span><br><span class="line">show features           æŸ¥çœ‹å½“å‰èŠ¯ç‰‡çš„ç‰¹æ€§</span><br></pre></td></tr></table></figure>

<h2 id="ä½çº§å‘½ä»¤"><a href="#ä½çº§å‘½ä»¤" class="headerlink" title="ä½çº§å‘½ä»¤"></a>ä½çº§å‘½ä»¤</h2><p>ä½çº§å‘½ä»¤çš„ä½œç”¨ä¸»è¦æ˜¯å¯¹å¯„å­˜å™¨å’ŒRAMè¿›è¡Œè¯»å†™ã€‚</p>
<h3 id="å¯¹å¯„å­˜å™¨è¿›è¡Œè¯»å†™"><a href="#å¯¹å¯„å­˜å™¨è¿›è¡Œè¯»å†™" class="headerlink" title="å¯¹å¯„å­˜å™¨è¿›è¡Œè¯»å†™"></a>å¯¹å¯„å­˜å™¨è¿›è¡Œè¯»å†™</h3><table>
<thead>
<tr>
<th align="left">å¯„å­˜å™¨ç±»åˆ«</th>
<th align="left">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">PCIC</td>
<td align="left">PCIé…ç½®å¯„å­˜å™¨</td>
</tr>
<tr>
<td align="left">PCIM</td>
<td align="left">PCIå†…å­˜æ˜ å°„å¯„å­˜å™¨</td>
</tr>
<tr>
<td align="left">SOC</td>
<td align="left">äº¤æ¢èŠ¯ç‰‡å¯„å­˜å™¨ä¸å†…å­˜</td>
</tr>
<tr>
<td align="left">PHY</td>
<td align="left">PHYå¯„å­˜å™¨</td>
</tr>
</tbody></table>
<p>å¯„å­˜å™¨å¸¸ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getreg          è·å–å¯„å­˜å™¨çš„å€¼</span><br><span class="line">listreg         æ˜¾ç¤ºæ‰€æ”¯æŒçš„å¯„å­˜å™¨ä¿¡æ¯</span><br><span class="line">setreg          è®¾ç½®å¯„å­˜å™¨çš„å€¼</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹å†…å­˜è¡¨è¿›è¡Œè¯»å†™"><a href="#å¯¹å†…å­˜è¡¨è¿›è¡Œè¯»å†™" class="headerlink" title="å¯¹å†…å­˜è¡¨è¿›è¡Œè¯»å†™"></a>å¯¹å†…å­˜è¡¨è¿›è¡Œè¯»å†™</h3><p>å†…å­˜è¡¨è¯»æ“ä½œï¼š dump<br>å†…å­˜è¡¨å†™æ“ä½œï¼š write</p>
<h2 id="ç«¯å£å‘½ä»¤"><a href="#ç«¯å£å‘½ä»¤" class="headerlink" title="ç«¯å£å‘½ä»¤"></a>ç«¯å£å‘½ä»¤</h2><p>ç«¯å£å‘½ä»¤ä¸»è¦æ˜¯ç«¯å£è®¾ç½®<code>PORT</code>å‘½ä»¤å’Œç«¯å£æ˜¾ç¤º<code>PortStat</code>å‘½ä»¤ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š<br>è®¾ç½®xe0 loopbackï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BCM.0&gt; port xe0 lb&#x3D;phy</span><br></pre></td></tr></table></figure>

<h2 id="é«˜çº§å‘½ä»¤"><a href="#é«˜çº§å‘½ä»¤" class="headerlink" title="é«˜çº§å‘½ä»¤"></a>é«˜çº§å‘½ä»¤</h2><p>é«˜çº§å‘½ä»¤å¯ä»¥å¯¹åè®®ç­‰å¤æ‚åŠŸèƒ½è¿›è¡Œè®¾ç½®ï¼Œå¦‚ACLï¼ŒOAMç­‰ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">l2 show                                             æ˜¾ç¤ºmacåœ°å€è¡¨</span><br><span class="line">l2 add port&#x3D;ge2 macaddress&#x3D;0x000000000001 vlan&#x3D;1   åœ¨ge2ç«¯å£é™æ€æ·»åŠ macåœ°å€</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>evengä¸­éƒ¨ç½²openwrt</title>
    <url>/2025/11/19/eveng%E4%B8%AD%E9%83%A8%E7%BD%B2openwrt/</url>
    <content><![CDATA[<h2 id="å®éªŒéœ€æ±‚"><a href="#å®éªŒéœ€æ±‚" class="headerlink" title="å®éªŒéœ€æ±‚"></a>å®éªŒéœ€æ±‚</h2><p>åœ¨evengä¸­æ·»åŠ OpenWrté•œåƒ, åœ¨Openwrtä¸­ä½¿èƒ½OpenClashæœåŠ¡ï¼Œä½¿å¾—labç¯å¢ƒä¸­æ‰€æœ‰è¿æ¥åˆ°openwrtçš„èŠ‚ç‚¹èƒ½å¤Ÿè®¿é—®googleæœåŠ¡ã€‚</p>
<span id="more"></span>

<p>å®éªŒæ‹“æ‰‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/eveng_openwrt-topology.png"></p>
<p>å…¶ä¸­Netæ˜¯labçš„å‡ºå£ç½‘å…³ï¼Œæœ¬è´¨æ˜¯Vmwareä¸­çš„è™šæ‹Ÿç½‘å¡VMnet8(NATæ¨¡å¼), Router1æ˜¯Openwrtï¼Œwanå£ä¸Netè¿æ¥ã€‚Clientä½œä¸ºç»ˆç«¯è®¾å¤‡ï¼Œä¸Openwrtçš„lanå£è¿æ¥ã€‚</p>
<h2 id="Openwrtéƒ¨ç½²"><a href="#Openwrtéƒ¨ç½²" class="headerlink" title="Openwrtéƒ¨ç½²"></a>Openwrtéƒ¨ç½²</h2><p>åœ¨<a href="https://github.com/Emerosn/OpenWrt-Eve-ng">github</a>ä¸Šæ‰¾åˆ°ä¸€ä¸ªopenwrtçš„qemué•œåƒï¼Œç›´æ¥æŒ‰ç…§readmeä¸­çš„æ–¹å¼é›†æˆåˆ°evengä¸­ï¼Œæ³¨æ„éœ€è¦å…³é—­windowsä¸­hyper-våŠŸèƒ½ã€‚</p>
<p>ä¹‹åå°±å¯ä»¥é€šè¿‡ç½‘é¡µé…ç½®openwrt.<br><img src="https://rancho333.github.io/pictures/eveng_openwrt-control.png"></p>
<p>ç®€å•é…ç½®lanå£ä¸Šçš„dhcpï¼Œä½¿clientèƒ½å¤Ÿè·å–åˆ°ip.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@client:&#x2F;# ifconfig eth0</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 50:00:00:03:00:00  </span><br><span class="line">          inet addr:192.168.0.11  Bcast:192.168.0.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::5200:ff:fe03:0&#x2F;64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:1265 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1245 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:2892497 (2.7 MiB)  TX bytes:105530 (103.0 KiB)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶clientå¯ä»¥æ­£å¸¸è®¿é—®<code>www.baidu.com</code>, ä½†æ˜¯æ— æ³•è®¿é—®google.</p>
<h2 id="OpenClashéƒ¨ç½²"><a href="#OpenClashéƒ¨ç½²" class="headerlink" title="OpenClashéƒ¨ç½²"></a>OpenClashéƒ¨ç½²</h2><p>è¿™ä¸ªç‰ˆæœ¬çš„openwrtä¸­å¹¶æ²¡æœ‰ç›´æ¥é›†æˆOpenClash, æŒ‰ç…§ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚</p>
<p>å®‰è£…iptablesåŠä¾èµ–ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨nftables.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install bash iptables dnsmasq-full curl ca-bundle ipset ip-full iptables-mod-tproxy iptables-mod-extra ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base</span><br></pre></td></tr></table></figure>

<p>ä¸‹è½½openclashå®‰è£…åŒ…å¹¶å®‰è£…</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;vernesong&#x2F;OpenClash&#x2F;releases&#x2F;download&#x2F;v0.47.028&#x2F;luci-app-openclash_0.47.028_all.ipk -O openclash.ipk</span><br><span class="line">opkg install openclash.ipk</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„å»githubä¸Šä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬ï¼Œä¸ç„¶å®‰è£…å¥½è¿˜è¦æ›´æ–°ã€‚</p>
<p>ä¹‹åå°±å¯ä»¥åœ¨ç½‘é¡µä¸Šçœ‹åˆ°openclashæœåŠ¡ã€‚<br><img src="https://rancho333.github.io/pictures/eveng_openwrt-openclash.png"></p>
<p>åœ¨é…ç½®è®¢é˜…ä¸­æ·»åŠ è‡ªå·±çš„æœºåœºè®¢é˜…é“¾æ¥.<br><img src="https://rancho333.github.io/pictures/eveng_openclash-subscribe.png"></p>
<p>ä¹‹ååšå‡ å¤„è®¾ç½®ï¼š<code>Plugin Setting  â€”â€”&gt;  DNS setting</code> ä¸­å…³é—­ <code>Redirect Local DNS Setting</code><br>ç¡®ä¿<code>Traffic Control</code>ä¸­çš„<code>Wan interface name</code>åˆ—è¡¨æ˜¯ç©ºã€‚</p>
<h2 id="å¤–ç½‘æµ‹è¯•"><a href="#å¤–ç½‘æµ‹è¯•" class="headerlink" title="å¤–ç½‘æµ‹è¯•"></a>å¤–ç½‘æµ‹è¯•</h2><p>é…ç½®å®Œæˆä¹‹åï¼Œopenclashé¡µé¢ä¸­çš„Access Checkå¯ä»¥å…¨éƒ¨pass.<br><img src="https://rancho333.github.io/pictures/eveng_openclash-access.png"></p>
<p>åœ¨clientä¸Šæµ‹è¯•èƒ½å¤Ÿæ­£å¸¸è®¿é—®google.<br><img src="https://rancho333.github.io/pictures/eveng_openclash-google.png"></p>
]]></content>
      <tags>
        <tag>eveng</tag>
        <tag>openwrt</tag>
      </tags>
  </entry>
  <entry>
    <title>glbpç®€è¿°</title>
    <url>/2022/07/07/glbp%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>GLBP(gateway load balancing protocol)æ˜¯FHRPçš„ä¸€ç§å®ç°ï¼Œæ€ç§‘ç§æœ‰åè®®ã€‚HSRPå’ŒVRRPéƒ½åªèƒ½åšåˆ°å•æ´»ç½‘å…³ï¼Œè€ŒGLBPå¯ä»¥å®ç°å¤šæ´»ç½‘å…³ã€‚<br>VRRP/HSRPä¸­çš„è´Ÿè½½å‡è¡¡æ˜¯å°†ä¸åŒç½‘æ®µçš„activeæ”¾åœ¨ä¸åŒçš„è®¾å¤‡ä¸Šï¼Œå³äº’ä¸ºå¯¹æ–¹ç½‘æ®µçš„backupï¼Œè¿™æ˜¯ä¸€ç§ä¼ªè´Ÿè½½å‡è¡¡ã€‚è€ŒGLBPé€šè¿‡vipä¸å¤švmacçš„æ˜ å°„å¯ä»¥å®ç°åŒä¸€ç½‘æ®µæµé‡çš„è´Ÿè½½å‡è¡¡ã€‚</p>
<span id="more"></span>
<h2 id="å‡ ä¸ªæ¦‚å¿µ"><a href="#å‡ ä¸ªæ¦‚å¿µ" class="headerlink" title="å‡ ä¸ªæ¦‚å¿µ"></a>å‡ ä¸ªæ¦‚å¿µ</h2><p>AVG(active virtual gateway): ä¸€ä¸ªè™šæ‹Ÿç»„ä¸­åªæœ‰ä¸€ä¸ªAVGï¼Œé€‰ä¸¾äº§ç”Ÿã€‚AVGç»™è™šæ‹Ÿç»„ä¸­å…¶å®ƒäº¤æ¢æœºåˆ†é…vmacã€‚åªæœ‰AVGå“åº”ARPæŠ¥æ–‡ã€‚é€‰ä¸¾å’ŒæŠ¢å è§„åˆ™å’ŒHSRPä¸€è‡´ï¼Œé«˜ä¼˜å…ˆçº§æˆ–ipåœ°å€å¤§çš„æˆä¸ºAVGï¼Œæ¬¡ä¼˜çš„æˆä¸ºstandbyï¼Œå‰©ä¸‹çš„å¤„äºlistené˜¶æ®µï¼Œä¸åŒäºhsrpåªæœ‰activeå’Œstandbyå‘é€helloï¼Œglbpä¸­æ‰€æœ‰äº¤æ¢æœºéƒ½å‘é€helloã€‚</p>
<p>AVF(active virtual forward)ï¼šç›¸åŒçš„vipï¼Œä¸åŒçš„vmacï¼Œéƒ½ä½œä¸ºç½‘å…³è½¬å‘æµé‡ã€‚é€šè¿‡æƒå€¼è¿›è¡Œé€‰ä¸¾ï¼Œæœ€å¤šæœ‰4ä¸ªAVFï¼Œä¹Ÿå°±æ˜¯5å°è·¯ç”±å™¨ç»„æˆè™šæ‹Ÿç»„ï¼Œå…¶ä¸­ä¸€å°æ˜¯é—²ç½®çš„ï¼Œå½“ç„¶è¿™æ ·æ²¡å¿…è¦ï¼Œä¸€èˆ¬ä¸¤ä¸‰å°å°±å¤Ÿäº†ã€‚</p>
<p>AVGå°±æ˜¯æ•´ä¸ªè™šæ‹Ÿç»„çš„æ§åˆ¶é¢ï¼Œè´Ÿè´£vmacçš„åˆ†é…ï¼Œavfæ˜¯æ•°æ®é¢ï¼Œæ ¹æ®vmacè¿›è¡Œè½¬å‘ã€‚</p>
<p>GLBAPè™šæ‹Ÿç»„æ‰€æœ‰æˆå‘˜æ¯éš”3ç§’å‘é€helloæŠ¥æ–‡ç”¨ä»¥ä¿æ´»ï¼Œç›®çš„åœ°å€æ˜¯224.0.0.102ã€‚æ‰¿è½½åœ¨UDPä¹‹åï¼Œç«¯å£å·æ˜¯3222(sourceå’Œdestä¸€æ ·)ã€‚</p>
<p>load balancingçš„ä¸‰ç§æ¨¡å¼ï¼š</p>
<ul>
<li>round-robinï¼šæ ¹æ®æ”¶åˆ°arpçš„å…ˆåé¡ºåºï¼Œä¾æ¬¡å“åº”AVF1ã€AVF2ã€AVF3çš„vmacï¼Œç„¶åå†å¾ªç¯1,2,3</li>
<li>host-dependentï¼šåŸºäºarpä¸­è¯·æ±‚è€…çš„macåœ°å€åšåˆ†é…ï¼Œç›¸åŒçš„è¯·æ±‚è€…å§‹ç»ˆåˆ†é…ç›¸åŒçš„vmac</li>
<li>weightedï¼šä¸åŒçš„avfsåˆ†é…ä¸åŒçš„æƒé‡å€¼ï¼ŒåŸºäºæ­¤å“åº”arp<br>AVGå¯¹ARPå›åº”vmacçš„ç­–ç•¥å°±æ˜¯GLBPä¸Šè´Ÿè½½å‡è¡¡çš„ç­–ç•¥ã€‚</li>
</ul>
<p>*GLBPçš„ä¸€ä¸ªå…ˆå†³æ¡ä»¶ï¼šä¸€ä¸ªç‰©ç†ç«¯å£æ”¯æŒé…ç½®å¤šä¸ªmacåœ°å€(ä¸€èˆ¬äº¤æ¢èŠ¯ç‰‡éƒ½æ”¯æŒ)*ï¼Œhsrpã€vrrpã€glbpæœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªä¸‰å±‚æ¥å£å¯ä»¥é…ç½®å¤šä¸ªip/macã€‚é€šè¿‡ip/macå¯ä»¥å®šä½åˆ°å”¯ä¸€çš„ç«¯å£ï¼Œä½†æ˜¯ç«¯å£å¹¶ä¸ä¸€å®šåªèƒ½é€šè¿‡å”¯ä¸€çš„ipã€macæ‰¾åˆ°ã€‚ç±»ä¼¼äºä¸€è¾†è½¦ä¸Šæœ‰å¤šä¸ªè½¦ç‰Œã€‚</p>
<h3 id="vmacåˆ†é…"><a href="#vmacåˆ†é…" class="headerlink" title="vmacåˆ†é…"></a>vmacåˆ†é…</h3><p>æ¯ä¸ªè™šæ‹Ÿç»„æœ€å¤šæœ‰4ä¸ªvmac. AVGè´Ÿè´£è™šæ‹Ÿç»„å†…vmacåˆ†é…ã€‚ç»„æˆå‘˜å‘ç°AVGåé€šè¿‡helloæ¶ˆæ¯è¯·æ±‚vmacã€‚é€šè¿‡AVGåˆ†é…vmacçš„æˆä¸ºprimary virtual forwarder(å³é€šè¿‡è¯¥vmacä½œä¸ºç½‘å…³è¿›è¡Œæ•°æ®è½¬å‘)ã€‚é€šè¿‡helloæŠ¥æ–‡å­¦åˆ°å…¶å®ƒforwarderçš„vmacçš„ç§°ä¸ºsecondary virtual forwarder(ç»„å†…çš„ä»»ä¸€forwarderä¼šå­¦åˆ°å…¶å®ƒæ‰€æœ‰forwarderå¯¹åº”çš„vmac)ã€‚</p>
<p><code>0007.b400.XXYY</code>æ˜¯vmacçš„ç»„æˆå½¢å¼ï¼ŒXXæ˜¯group idï¼ŒYYæ˜¯ç»„å†…vmacçš„åºåˆ—å·ï¼Œ<code>show glbp brief</code>ä¸­<code>Fwd</code>å­—æ®µå¯ä»¥çœ‹åˆ°ã€‚</p>
<h3 id="glbpä¼˜å…ˆçº§"><a href="#glbpä¼˜å…ˆçº§" class="headerlink" title="glbpä¼˜å…ˆçº§"></a>glbpä¼˜å…ˆçº§</h3><p>ä¼˜å…ˆçº§æœ€é«˜çš„æˆä¸ºAVGï¼Œæ¬¡ä¹‹çš„æˆä¸ºstandbyï¼Œå…¶å®ƒçš„æ˜¯listençŠ¶æ€ã€‚å¦‚æœä¼˜å…ˆçº§ä¸€è‡´ï¼Œipè¶Šå¤§è¶Šä¼˜ã€‚<br>AVGæŠ¢å é»˜è®¤å…³é—­ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ã€‚</p>
<h3 id="glbpæƒé‡"><a href="#glbpæƒé‡" class="headerlink" title="glbpæƒé‡"></a>glbpæƒé‡</h3><p>ç”¨æƒé‡æ¥è¡¨ç¤ºavfçš„æ•°æ®è½¬å‘èƒ½åŠ›ã€‚æƒé‡å¯ä»¥å†³å®šavfæ˜¯å¦è½¬å‘æµé‡<br>å¯ä»¥è®¾ç½®ä¸€ä¸ªæƒé‡é˜ˆå€¼ï¼Œå½“åˆ°è¯¥å€¼å€¼æ—¶ä¸è½¬å‘æµé‡<br>ä¹Ÿå¯ä»¥è®¾ç½®åˆ°æŒ‡å®šå€¼è½¬å‘æµé‡çš„é˜ˆå€¼ï¼Œå¯ä»¥å’Œtrackingè¿›è¡Œè”åŠ¨ã€‚</p>
<h3 id="AVGå†—ä½™"><a href="#AVGå†—ä½™" class="headerlink" title="AVGå†—ä½™"></a>AVGå†—ä½™</h3><p>AVGæŒ‚æ‰åï¼Œstandbyæ¥æ›¿ï¼Œç„¶åä»listençŠ¶æ€çš„äº¤æ¢æœºä¸­é€‰ä¸¾å‡ºæ–°çš„standby.</p>
<h3 id="AVFå†—ä½™"><a href="#AVFå†—ä½™" class="headerlink" title="AVFå†—ä½™"></a>AVFå†—ä½™</h3><p>å½“AVFæŒ‚æ‰åï¼Œä¼šä»å…¶å®ƒçš„secondary virtual forwarderä¸­é€‰å‡ºä¸€ä¸ªç»§ç»­ä½¿ç”¨æŒ‚æ‰avfçš„vmacï¼Œè¿™æ ·ç”¨æˆ·çš„æµé‡å°±ä¸ä¼šä¸­æ–­ã€‚<br>AVFé»˜è®¤å¼€å¯æŠ¢å ã€‚</p>
<h3 id="GLBPå­˜åœ¨çš„é—®é¢˜"><a href="#GLBPå­˜åœ¨çš„é—®é¢˜" class="headerlink" title="GLBPå­˜åœ¨çš„é—®é¢˜"></a>GLBPå­˜åœ¨çš„é—®é¢˜</h3><p>GLBPåŸæœ¬æ˜¯æ€ç§‘ç§æœ‰åè®®ï¼Œç°åœ¨å¼€æºäº†ï¼Œä½†æ˜¯ç”¨çš„äººå¹¶ä¸å¤šï¼Œå› ä¸ºglbpå¤©ç”Ÿä¸stpä¸å¯¹ä»˜ï¼Œglbpä¸­éœ€è¦å„avfé“¾è·¯æ‰æœ‰LBçš„æ•ˆæœï¼Œä½†æ˜¯stpå´ææœ‰å¯èƒ½é˜»å¡å…¶ä¸­çš„ä¸€äº›é“¾è·¯ã€‚</p>
<h2 id="å®éªŒè¯´æ˜"><a href="#å®éªŒè¯´æ˜" class="headerlink" title="å®éªŒè¯´æ˜"></a>å®éªŒè¯´æ˜</h2><p>å®éªŒæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/glbp_basic_topology.png"></p>
<p>S2ã€S3ã€S4åœ¨ä¸€ä¸ªè™šæ‹Ÿç»„å†…ï¼Œé€šè¿‡interface vlan1ä¸ºvlan1æ‰€åœ¨ç½‘æ®µæä¾›ç½‘å…³æœåŠ¡ï¼Œè™šæ‹Ÿç½‘å…³ipä¸º<code>192.168.1.254</code>ï¼ŒVPC5ã€VPC6ã€VPC7éƒ½åœ¨vlan1ä¸­ã€‚</p>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2:</span><br><span class="line">interface Vlan1</span><br><span class="line"> ip address 192.168.1.2 255.255.255.0</span><br><span class="line"> glbp 1 ip 192.168.1.254</span><br><span class="line"></span><br><span class="line">S3:</span><br><span class="line">interface Vlan1</span><br><span class="line"> ip address 192.168.1.3 255.255.255.0</span><br><span class="line"> glbp 1 ip 192.168.1.254</span><br><span class="line"></span><br><span class="line">S4:</span><br><span class="line">interface Vlan1</span><br><span class="line"> ip address 192.168.1.4 255.255.255.0</span><br><span class="line"> glbp 1 ip 192.168.1.254</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>show glbp brief</code>æŸ¥çœ‹glbpçš„çŠ¶æ€ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/glbp_show_brief.png"></p>
<p>å¯¹showçš„çŠ¶æ€åšä¸€ä¸ªç®€å•è¯´æ˜ï¼š</p>
<ul>
<li><code>Grp</code>è¡¨ç¤ºæ¥å£æ‰€åœ¨çš„glbpç»„id</li>
<li><code>Fwd</code>è¡¨ç¤ºavfç¼–å·ï¼Œæ³¨æ„ç¬¬ä¸€è¡Œæ²¡æœ‰ç¼–å·ï¼Œæ˜¾ç¤ºçš„æ˜¯AVGä¿¡æ¯ï¼Œå›¾ä¸­å¯ä»¥çœ‹åˆ°AVGæ˜¯S4ï¼Œstandby avgæ˜¯S3ï¼ŒS2åˆ™å‡ºäºlistençŠ¶æ€ã€‚ç«™åœ¨avfçš„è§†è§’ä¸‹ï¼Œæ¯ä¸ªavféƒ½åˆ†é…åˆ°ä¸€ä¸ªvmacï¼Œå¯¹åº”ä¸€ä¸ªfwdç¼–å·ï¼Œé‚£ä¹ˆä»–å°±æ˜¯è¿™ä¸ªfwdç¼–å·çš„activeï¼Œå…¶å®ƒavfåœ¨è¿™ä¸ªç¼–å·ä¸­éƒ½æ˜¯listenï¼Œå½“activeæŒ‚æ‰åï¼Œä»listenä¸­é€‰å‡ºä¸€ä¸ªç»§ç»­ä¸ºè¯¥fwdç¼–å·å¯¹åº”çš„vmacæœåŠ¡ã€‚forwarderæ¢å¤åï¼Œä¼šæ”¶å›è¯¥vmacçš„ä½¿ç”¨æƒã€‚</li>
</ul>
<p>GLBPé»˜è®¤ä½¿ç”¨çš„LBæ–¹å¼æ˜¯round-robin, å³æ ¹æ®æ”¶åˆ°arpæŠ¥æ–‡çš„é¡ºåºï¼Œä¾æ¬¡å¾ªç¯åˆ†é…fwd1ã€2ã€3å¯¹åº”çš„vmacï¼Œåœ¨VPC5ã€6ã€7ä¸Šä¾æ¬¡pingç½‘å…³ï¼ŒæŸ¥çœ‹arpè¡¨é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPC5&gt; show arp</span><br><span class="line"></span><br><span class="line">00:07:b4:00:01:01  192.168.1.254 expires in 37 seconds</span><br><span class="line"></span><br><span class="line">VPC6&gt; show arp</span><br><span class="line"></span><br><span class="line">00:07:b4:00:01:02  192.168.1.254 expires in 115 seconds</span><br><span class="line"></span><br><span class="line">VPC7&gt; show arp</span><br><span class="line"></span><br><span class="line">00:07:b4:00:01:03  192.168.1.254 expires in 113 seconds</span><br></pre></td></tr></table></figure>
<p>åœ¨VPC7ä¸Šæ¸…é™¤arpä¿¡æ¯ï¼Œé‡æ–°pingç½‘å…³ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPC7&gt; clear arp</span><br><span class="line">VPC7&gt; show arp</span><br><span class="line">arp table is emptys</span><br><span class="line">VPC7&gt; ping 192.168.1.254</span><br><span class="line"></span><br><span class="line">84 bytes from 192.168.1.254 icmp_seq&#x3D;1 ttl&#x3D;255 time&#x3D;0.409 ms</span><br><span class="line">^C0</span><br><span class="line">VPC7&gt; show arp</span><br><span class="line"></span><br><span class="line">00:07:b4:00:01:01  192.168.1.254 expires in 116 seconds</span><br></pre></td></tr></table></figure>
<p>å’Œé¢„æœŸä¸€è‡´ï¼Œé‡æ–°åˆ†é…fwd1çš„vmacã€‚æ­¤å¤–ï¼ŒLBè¿˜å¯ä»¥åŸºäºä¸»æœºï¼ŒåŸºäºavfæƒé‡ã€‚è¿™é‡Œå°±ä¸ä¸€ä¸€å°è¯•äº†ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>evengè™šæ‹Ÿç½‘ç»œç¯å¢ƒç®€è¿°</title>
    <url>/2022/09/06/eveng%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ¬æ–‡ä¸»è¦åˆ†æä¸‹vmwareä¸‰ç§ç½‘ç»œæ¨¡å¼çš„å®ç°ï¼Œç„¶åè¯´æ˜evengå¦‚ä½•å€ŸåŠ©vmwareè™šæ‹Ÿç½‘å¡å®ç°å†…éƒ¨è®¾å¤‡ä¸å¤–ç½‘çš„è”é€šï¼Œæœ€ååˆ†æä¸‹eveng labä¸­è™šæ‹Ÿç½‘ç»œè®¾å¤‡ä¹‹é—´çš„è¿é€šæ€§ã€‚</p>
<span id="more"></span>

<h1 id="VMwareçš„ä¸‰ç§ç½‘ç»œæ¨¡å¼"><a href="#VMwareçš„ä¸‰ç§ç½‘ç»œæ¨¡å¼" class="headerlink" title="VMwareçš„ä¸‰ç§ç½‘ç»œæ¨¡å¼"></a>VMwareçš„ä¸‰ç§ç½‘ç»œæ¨¡å¼</h1><p>vmwareæœ‰æ¡¥æ¥ã€NATã€host-onlyä¸‰ç§ç½‘ç»œæ¨¡å¼ã€‚å…¶ä¸­NATå’Œhost-onlyä¼šé»˜è®¤åœ¨hostä¸Šå„åˆ›å»ºä¸€å¼ è™šæ‹Ÿç½‘å¡ã€‚å…¶ä¸­VMnet1æ˜¯host-onlyï¼ŒVMnet8æ˜¯NATã€‚æˆ‘ä»¬åœ¨è™šæ‹Ÿçš„é…ç½®hardwareæ—¶ï¼Œå¯ä»¥æ·»åŠ ç½‘ç»œè®¾å¤‡ã€‚<br><img src="https://rancho333.github.io/pictures/eveng_vmware_network.png"><br>å¦‚æœé€‰æ‹©NATã€host-onlyã€æ¡¥æ¥åˆ™ä½¿ç”¨é»˜è®¤ç½‘å¡ã€‚é€‰æ‹©customeæ—¶ï¼Œå¯ä»¥æŒ‡å®šæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„å…¶å®ƒç½‘å¡ã€‚æ³¨æ„ï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ªbridgeå’ŒNATçš„ç½‘ç»œï¼Œå³æˆ‘ä»¬å¯ä»¥é¢å¤–æ·»åŠ çš„è™šæ‹Ÿç½‘ç»œç±»å‹åªèƒ½æ˜¯host-onlyã€‚ä¸‹é¢å¯¹ä¸‰ç§ç½‘ç»œæ¨¡å¼åšä¸€ä¸ªç®€å•è¯´æ˜ã€‚</p>
<h2 id="æ¡¥æ¥æ¨¡å¼"><a href="#æ¡¥æ¥æ¨¡å¼" class="headerlink" title="æ¡¥æ¥æ¨¡å¼"></a>æ¡¥æ¥æ¨¡å¼</h2><p>ä¸‰ç§æ¨¡å¼ä¸‹åªæœ‰æ¡¥æ¥æ¨¡å¼æ²¡æœ‰åˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œè¿™ç§æ¨¡å¼ä¸‹è™šæ‹Ÿæœºå’Œä¸»æœºç›¸å½“äºè¿æ¥åœ¨åŒä¸€ä¸ªç½‘æ¡¥ä¸Šï¼Œç½‘æ¡¥çš„å‡ºå£æ˜¯ä¸»æœºçš„ç‰©ç†å‡ºå£ç½‘å¡ï¼Œè™šæ‹Ÿæœºçš„ipå’Œä¸»æœºçš„ipç”±ä¸Šæ¸¸DHCPåŒä¸€åˆ†é…ï¼Œä¸¤è€…åœ¨åŒä¸€ç½‘æ®µï¼Œè™šæ‹Ÿæœºå¯ä»¥è‡ªç”±çš„è®¿é—®åŒå­ç½‘çš„ä¸»æœº(å½“ç„¶åŒ…æ‹¬ä¸»æœº)ï¼Œè¿™ç§æƒ…å†µä¸‹è™šæ‹Ÿæ²¡æœ‰å’Œå¤–éƒ¨ç½‘ç»œéš”ç¦»ï¼Œä¼šæ¶ˆè€—ä¸»æœºç½‘ç»œç¯å¢ƒçš„ipã€‚å¯ä»¥åŒæ—¶æ»¡è¶³ä¸»æœºä¸è™šæ‹Ÿæœºä¹‹é—´çš„ç½‘ç»œè¿é€šï¼Œä»¥åŠè™šæ‹Ÿæœºä¸å¤–éƒ¨ç½‘ç»œä¹‹é—´çš„ç½‘ç»œè¿é€šã€‚<br><img src="https://rancho333.github.io/pictures/eveng_vmware_bridge.png"></p>
<p>ç®€è¨€ä¹‹ï¼Œæ¡¥æ¥æ¨¡å¼å°±æ˜¯è™šæ‹Ÿæœºå’Œä¸»æœºè¿æ¥åœ¨åŒä¸€ä¸ªç½‘æ¡¥ä¸Šï¼Œç½‘æ¡¥ä¸Šè¿æ˜¯å‡ºå£ï¼Œä¸‹è¿æ˜¯è™šæ‹Ÿæœºå’Œä¸»æœºã€‚æ¡¥æ¥æ¨¡å¼å’Œä¸»æœºç‰©ç†ç½‘å¡æ˜¯å¼ºç›¸å…³çš„ï¼Œåœ¨åˆ›å»ºbridgeè™šæ‹Ÿç½‘ç»œæ—¶ï¼Œé€‰æ‹©autoé€‰é¡¹ï¼Œvmwareä¼šè‡ªåŠ¨ä»ä¸»æœºå¤šç½‘å¡ä¸­é€‰æ‹©åˆé€‚çš„è¿›è¡Œæ¡¥æ¥ã€‚</p>
<h2 id="NATæ¨¡å¼"><a href="#NATæ¨¡å¼" class="headerlink" title="NATæ¨¡å¼"></a>NATæ¨¡å¼</h2><p>NATæ¨¡å¼é»˜è®¤åˆ›å»ºVMnet8è™šæ‹Ÿç½‘å¡ã€‚è™šæ‹Ÿæœºç½‘å¡ä¸vmnet8ç›¸è¿ï¼Œvmnet8åœ¨ä¸»æœºä¸Šæ˜¯ä¸€å—ç‰©ç†ç½‘å¡ï¼Œæ˜¯ç›´è¿ç½‘æ®µï¼Œæ‰€ä»¥ä¸»æœºä¸è™šæ‹Ÿæœºä¹‹é—´å¯ä»¥ç›´æ¥é€šè¿‡Vmnet8é€šä¿¡ã€‚vmnet8ä¸Šå¼€å¯dhcpæœåŠ¡ï¼Œè´Ÿè´£ç»™è™šæ‹Ÿæœºåˆ†é…ipï¼Œåœ¨vmwareè®¾ç½®ä¸­å¯ä»¥è®¾ç½®æ‰€éœ€çš„ç½‘æ®µã€‚å½“è™šæ‹Ÿæœºéœ€è¦å’Œä¸»æœºå¤–éƒ¨é€šä¿¡æ—¶ï¼Œvmnet8é€šè¿‡NATæœåŠ¡å°†è™šæ‹Ÿæœºipæ˜ å°„ä¸»æœºæŸä¸ªç‰©ç†ç½‘å¡ipï¼Œä»è€Œå®ç°å’Œå¤–ç½‘çš„è¿é€šæ€§ã€‚æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/eveng_vmware_nat.png"></p>
<p>è¿™ç§åœºæ™¯ä¸‹ï¼Œè™šæ‹Ÿæœºä¸ä¸»æœºé€šè¿‡vmnet8åŒç½‘æ®µé€šä¿¡ï¼Œå¤ç”¨ä¸»æœºipé€šè¿‡NATä¸å¤–ç½‘é€šä¿¡ã€‚åœ¨NATæ¨¡å¼çš„é…ç½®ä¸‹å¹¶æ²¡æœ‰çœ‹åˆ°NATè½¬æ¢çš„å…·ä½“é…ç½®ï¼Œå…³é”®æ˜¯æ²¡çœ‹åˆ°è½¬æ¢åçš„ip, è¿™å…¶å®ä¸ä¸»æœºçš„å®é™…å‡ºå£ç½‘å¡ç›¸å…³ï¼Œè¿™éš¾é“å’Œæ¡¥æ¥æ¨¡å¼ä¸€æ ·ï¼Œä¹Ÿæ˜¯è‡ªåŠ¨é€‰æ‹©çš„ï¼Ÿ</p>
<h2 id="host-onlyæ¨¡å¼"><a href="#host-onlyæ¨¡å¼" class="headerlink" title="host-onlyæ¨¡å¼"></a>host-onlyæ¨¡å¼</h2><p>host-onlyæ¨¡å¼é»˜è®¤åˆ›å»ºVMnet1è™šæ‹Ÿç½‘å¡ã€‚è™šæ‹Ÿæœºç½‘å¡ä¸vmnet1ç›¸è¿ã€‚è¯¥æ¨¡å¼æœ¬è´¨å°±æ˜¯NATæ¨¡å¼é˜‰å‰²æ‰NATåŠŸèƒ½ï¼Œä½¿å¾—è™šæ‹Ÿæœºåªèƒ½ä¸ä¸»æœºç½‘ç»œå¯è¾¾ï¼Œè€Œä¸èƒ½è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚è¿™æ ·å¯ä»¥æœ‰æ•ˆçš„å®ç°è™šæ‹Ÿæœºä¸å¤–éƒ¨ç½‘ç»œç¯å¢ƒçš„éš”ç¦»ã€‚</p>
<h2 id="ä¸€äº›å°ç»“æ€è€ƒ"><a href="#ä¸€äº›å°ç»“æ€è€ƒ" class="headerlink" title="ä¸€äº›å°ç»“æ€è€ƒ"></a>ä¸€äº›å°ç»“æ€è€ƒ</h2><p>çœŸå®çš„æ‹“æ‰‘æ¨¡å‹å¯èƒ½å’Œä¸Šè¿°çš„ä¸ä¸€æ ·ï¼Œä¸Šè¿°åªæ˜¯è‡ªå·±å®éªŒåŠ ç†è§£çš„ç»“æœã€‚åœ¨ä¸Šé¢ç†è§£ä¸­ï¼ŒVMnetæˆ‘å…¶å®æ˜¯ç†è§£æˆä¸‰å±‚äº¤æ¢æœºè€Œä¸æ˜¯ç½‘å¡ï¼Œå› ä¸ºå®ƒå¯ä»¥è¢«å¤šä¸ªè™šæ‹Ÿæœºè¿æ¥ï¼Œä½†æ˜¯ç½‘å¡çš„ä¸€ä¸ªç«¯å£åœ¨ç³»ç»Ÿä¸Šä¼šæ˜ å°„æˆä¸€ä¸ªç½‘ç»œè®¾å¤‡ï¼Œå¤šä¸ªæ¥å£ä¼šæ˜ å°„æˆå¤šä¸ªç½‘ç»œè®¾å¤‡ï¼Œæ‰€ä»¥åœ¨windowsçš„è§†è§’ä¸­ï¼Œvmnetå°±æ˜¯ä¸€ä¸ªå•æ¥å£çš„ç½‘å¡ã€‚<br>æœ‰äº›åšå®¢ä¸­æåˆ°ï¼švmwareä¼šåˆ›å»ºè™šæ‹Ÿäº¤æ¢æœºå’Œè™šæ‹Ÿç½‘å¡ï¼Œè™šæ‹Ÿäº¤æ¢æœºäº’è”è™šæ‹Ÿæœºç½‘å¡ï¼Œä¸»æœºè™šæ‹Ÿç½‘å¡ã€‚<br><img src="https://rancho333.github.io/pictures/eveng_vmware_blog.png"><br>è¿™ç§æ‹“æ‰‘æ˜¯æ¯”è¾ƒåˆç†çš„ï¼Œwindowsçš„è§†è§’ä¸‹æœ‰ä¸€å—ç½‘å¡VMnet8ï¼Œè€Œè™šæ‹Ÿæœºè¿æ¥çš„æ˜¯åŒåä¸ºVMnet8çš„ç½‘æ¡¥ï¼Œæ‰€ä»¥å¤šä¸ªè™šæ‹Ÿæœºå¯ä»¥è¿æ¥åˆ°VMnet8ï¼Œè¿™ä¸‰è€…ç»„æˆvmwareè™šæ‹Ÿç½‘ç»œç¯å¢ƒï¼Œè™šæ‹Ÿæœºå’Œä¸»æœºé€šè¿‡vmnet8åŒç½‘æ®µè¿›è¡Œé€šä¿¡ï¼Œvmnet8ä¸ç‰©ç†NICä¹‹é—´é€šè¿‡NATä¸å¤–ç½‘é€šä¿¡ã€‚ç»™è™šæ‹Ÿæœºè®¾ç½®ç½‘å¡çš„é…ç½®ç•Œé¢å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/eveng_vmware_adapter.png"></p>
<p>åœ¨è™šæ‹Ÿæœºçš„è§†è§’ä¸‹ï¼Œæ¯æ·»åŠ ä¸€ä¸ªnetwork adapterå°±æ˜¯åœ¨è™šæ‹Ÿæœºä¸Šåˆ›å»ºä¸€ä¸ªç‰©ç†ç½‘å¡ï¼Œnetwork connectioné€‰é¡¹åˆ™æ˜¯è™šæ‹Ÿæœºç½‘å¡è¿æ¥vmwareè™šæ‹Ÿç½‘ç»œç¯å¢ƒçš„æ¨¡å¼ï¼Œé€šè¿‡è¿æ¥åˆ°æŒ‡å®šçš„è™šæ‹Ÿç½‘æ¡¥æ¥å®ç°çš„ï¼Œè€Œä¸åŒçš„è™šæ‹Ÿç½‘æ¡¥è¿æ¥ç€ä¸åŒçš„windowsè™šæ‹Ÿç½‘å¡(bridgeæ²¡æœ‰è™šæ‹Ÿç½‘å¡)ã€‚</p>
<h1 id="evengä¸­é•œåƒçš„è¿æ¥å®ç°"><a href="#evengä¸­é•œåƒçš„è¿æ¥å®ç°" class="headerlink" title="evengä¸­é•œåƒçš„è¿æ¥å®ç°"></a>evengä¸­é•œåƒçš„è¿æ¥å®ç°</h1><p>ä¸€ä¸ªç®€å•çš„evengé•œåƒè¿æ¥å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/eveng_image_connection.png"></p>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œswitchã€vpcä»¥åŠä»–ä»¬çš„è¿æ¥çº¿ï¼Œswitchå’Œvpcç”±å„è‡ªçš„é•œåƒæä¾›è¿ç®—ä»¿çœŸé€»è¾‘ï¼Œå½“æˆ‘ä»¬éœ€è¦ä»¿çœŸæŸç§è®¾å¤‡æ—¶ï¼Œåªéœ€è¦å°†å…¶é•œåƒå¯¼å…¥evengï¼Œè€Œé•œåƒçš„è¿è¡Œåˆ™ä¾èµ–äºevengçš„ä¸‰å¤§è™šæ‹Ÿä»¿çœŸç»„ä»¶ï¼šiolã€qemuã€dynamipsã€‚é‚£ä¹ˆé•œåƒä¹‹é—´çš„è¿æ¥çº¿æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿé€šè¿‡bridgeæ¥å®ç°ã€‚åœ¨ä¸Šå›¾æ‹“æ‰‘åŸºç¡€ä¸Šæˆ‘ä»¬è¿›å…¥evengçš„CLIç•Œé¢ï¼š<br>å°†labä¸­çš„imageå¯åŠ¨åæŸ¥çœ‹bridgeçŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@eve-ng5:~# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">pnet0		8000.000c297a7dde	no		eth0</span><br><span class="line">pnet1		8000.000c297a7de8	no		eth1</span><br><span class="line">...		</span><br><span class="line">vnet0_1		8000.4e340b0134f2	no		vunl0_1_0</span><br><span class="line">							            vunl0_2_0</span><br></pre></td></tr></table></figure>
<p>vnet0_1ä»¿çœŸçš„å°±æ˜¯Så’Œvpcçš„è¿æ¥çº¿ï¼Œbridgeä¸Šæœ‰ä¸¤ä¸ªæ¥å£åˆ†åˆ«è¿æ¥åœ¨Så’Œvpcä¸Šã€‚æˆ‘ä»¬å¢åŠ æ‹“æ‰‘ç»“æ„ï¼š<br><img src="https://rancho333.github.io/pictures/eveng_image_connection_more.png"></p>
<p>å†æ¬¡æŸ¥çœ‹bridgeçŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@eve-ng5:~# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">pnet0		8000.000c297a7dde	no		eth0</span><br><span class="line">...	</span><br><span class="line">vnet0_1		8000.7a42880945b1	no		vunl0_1_0</span><br><span class="line">							            vunl0_2_0</span><br><span class="line">vnet0_2		8000.0ef8341d6178	no		vunl0_1_16</span><br><span class="line">							            vunl0_3_0</span><br><span class="line">vnet0_3		8000.6a2c8be29ff6	no		vunl0_1_32</span><br><span class="line">							            vunl0_4_0</span><br></pre></td></tr></table></figure>
<p>å›¾ä¸­æœ‰3æ¡è¿æ¥çº¿ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ä¸‰ä¸ªvnet_nameå‘½åæ¨¡å¼çš„ç½‘æ¡¥ï¼Œä¸€ä¸ªç½‘æ¡¥æ¨¡æ‹Ÿä¸€ä¸ªè¿æ¥çº¿ï¼Œæ¯ä¸ªç½‘æ¡¥ä¸Šéƒ½æœ‰vun0_1_nameå‘½åæ¨¡å¼çš„æ¥å£ï¼Œå¯è§è¿™æ˜¯Sçš„æ¥å£ï¼Œæ‰€ä»¥ä»–ä»¬è¿™ä»¶çš„çœŸå®çš„è¿æ¥æ‹“æ‰‘å¦‚å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/eveng_image_connection_bridge.png"></p>
<p>å½“åˆ é™¤ç½‘å…ƒè®¾å¤‡æˆ–å…³é—­labçš„æ—¶å€™ï¼Œæ¨¡æ‹Ÿä»–ä»¬è¿æ¥çº¿çš„ç½‘æ¡¥å¹¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œè‡ªç”±å½»åº•å…³é—­evengè™šæ‹Ÿæœºæ‰ä¼šæ¸…é™¤ï¼Œä½†è¿™å¯¹æˆ‘ä»¬çš„ä½¿ç”¨å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚</p>
<h1 id="evengè™šæ‹Ÿæœºçš„ç½‘å¡"><a href="#evengè™šæ‹Ÿæœºçš„ç½‘å¡" class="headerlink" title="evengè™šæ‹Ÿæœºçš„ç½‘å¡"></a>evengè™šæ‹Ÿæœºçš„ç½‘å¡</h1><p>evengæœ¬èº«å°±æ˜¯ä¸€å°è¿è¡Œåœ¨linuxä¸­çš„è™šæ‹Ÿæœºï¼Œåœ¨åˆ›å»ºè™šæ‹Ÿæœºçš„æ—¶å€™ä¼šæŒ‡å®šç½‘å¡ä»¥åŠè¿æ¥æ–¹å¼ã€‚åœ¨<code>ä¸€äº›å°ç»“æ€è€ƒ</code>å›¾ç¤ºä¸­æˆ‘ä»¬ç»™evengæ·»åŠ äº†ä¸¤å—ç½‘å¡ã€‚æ¯å—ç½‘å¡ä»¥åä¸ºethnumçš„æ¨¡å¼å‘½åï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@eve-ng5:~# ifconfig </span><br><span class="line">eth0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether 00:0c:29:7a:7d:de  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 390  bytes 73174 (73.1 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 552  bytes 75404 (75.4 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">eth1: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether 00:0c:29:7a:7d:e8  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 21  bytes 3432 (3.4 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 14  bytes 1136 (1.1 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>eth0å¯¹åº”çš„æ˜¯Network Adapterï¼Œeth1å¯¹åº”çš„æ˜¯Network Adapter2,å…¶ä¸­eth0ä½œä¸ºç®¡ç†ç½‘å¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šè¿‡webè®¿é—®evengçš„ipã€‚æ³¨æ„evengä¼šä¸ºæ¯å—ç½‘å¡åˆ›å»ºä¸€ä¸ªbridge, ç„¶åå°†ç½‘å¡attachåˆ°brigeä¸Šã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@eve-ng5:~# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">pnet0		8000.000c297a7dde	no		eth0</span><br><span class="line">pnet1		8000.000c297a7de8	no		eth1</span><br><span class="line">pnet2		8000.000000000000	no		</span><br><span class="line">pnet3		8000.000000000000	no		</span><br><span class="line">pnet4		8000.000000000000	no		</span><br><span class="line">pnet5		8000.000000000000	no		</span><br><span class="line">pnet6		8000.000000000000	no		</span><br><span class="line">pnet7		8000.000000000000	no		</span><br><span class="line">pnet8		8000.000000000000	no		</span><br><span class="line">pnet9		8000.000000000000	no	</span><br></pre></td></tr></table></figure>
<p>ç½‘å¡ethnumä¸ç½‘æ¡¥pnetnumä¸€ä¸€å¯¹åº”ï¼Œevengæœ€å¤§æ”¯æŒ10å—ç½‘å¡ã€‚eth0ä½œä¸ºç®¡ç†ç½‘å£ï¼Œä¸€èˆ¬é€‰æ‹©host-only, è¿™æ ·å¯ä»¥é…ç½®dhcpåœ°å€æ± ï¼Œä½¿å…¶æ¯æ¬¡å¯åŠ¨è·å¾—å›ºå®šipï¼Œå¹¶ä¸”å’Œå¤–ç½‘éš”ç¦»ã€‚å¦‚æœä½¿ç”¨bridgeæ¨¡å¼evengçš„ç®¡ç†ipåˆ™ä¼šéšä¸»æœºç½‘ç»œç¯å¢ƒå˜æ¢è€Œå‘ç”Ÿå˜åŒ–ã€‚ç®¡ç†ç½‘å£ipå°±æ˜¯ç½‘æ¡¥pnet0çš„ip:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@eve-ng5:~# ifconfig pnet0</span><br><span class="line">pnet0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.183.134  netmask 255.255.255.0  broadcast 192.168.183.255</span><br><span class="line">        inet6 fe80::20c:29ff:fe7a:7dde  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:7a:7d:de  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 1064  bytes 196089 (196.0 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 1576  bytes 217466 (217.4 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆè¦å°†ç½‘å¡attachåˆ°bridgeä¸Šå‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†è®©labä¸­çš„é•œåƒå¯ä»¥è®¿é—®åˆ°ä¸»æœºç½‘ç»œå’Œå¤–éƒ¨ç½‘ç»œã€‚bridgeåœ¨labçš„è¡¨ç°å½¢å¼æ˜¯cloudNumã€‚<br><img src="https://rancho333.github.io/pictures/eveng_network_cloud.png"></p>
<p>pnet0å¯¹åº”çš„æ˜¯cloud0, pnet1å¯¹åº”çš„æ˜¯cloud1ï¼Œä¾æ¬¡ç±»æ¨ã€‚labä¸­ç½‘å…ƒè®¿é—®å¤–éƒ¨ç½‘ç»œå¦‚å›¾ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/eveng_network_cloud0.png"></p>
<p>vpcå¯ä»¥å‘VMnet1è¯·æ±‚dhcp, è·å¾—å’Œç®¡ç†ç½‘å£åŒç½‘æ®µçš„ipï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPCS&gt; ip dhcp</span><br><span class="line">DDORA IP 192.168.183.143&#x2F;24</span><br></pre></td></tr></table></figure>
<p>å…¶å®Œæ•´çš„ç½‘ç»œè¿æ¥æ‹“æ‰‘å¦‚ä¸‹å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/eveng_network_lab_connection.png"></p>
<p>å½“vpcè¯·æ±‚dhcpæ—¶ï¼Œæˆ‘ä»¬åœ¨windowsä¸Šå¯¹VMnet1æŠ“åŒ…å¯ä»¥çœ‹åˆ°dhcpäº¤äº’æŠ¥æ–‡ã€‚</p>
<p>labä¸­çš„ç½‘å…ƒè¿æ¥åˆ°ä¸åŒçš„cloudï¼Œå°±å¯ä»¥æ ¹æ®cloudæ‰€å±ç½‘æ¡¥çš„ç½‘å¡çš„è¿æ¥æ–¹å¼(bridge, nat, host-only)è·å¾—å¯¹åº”çš„ç½‘ç»œèƒ½åŠ›ï¼Œå®ç°labä¸ä¸»æœºå’Œå¤–éƒ¨ç½‘ç»œçš„è¿é€šæ€§ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œé…ç½®evengæ—¶çš„network adapterå¯¹åº”evengä¸­çš„ethç½‘å¡ï¼Œethç½‘å¡attchåˆ°pnetç½‘æ¡¥ä¸Šï¼Œpnetç½‘æ¡¥å¯¹åº”labä¸­çš„cloudï¼Œlabä¸­çš„ç½‘å…ƒè¿æ¥åˆ°å¯¹åº”cloudå³å¯è·å¾—ç›¸åº”ç½‘ç»œèƒ½åŠ›ã€‚</p>
<h2 id="å®Œæ•´çš„evengä¸vmwareè™šæ‹Ÿç½‘ç»œè¿æ¥ç¤ºæ„å›¾"><a href="#å®Œæ•´çš„evengä¸vmwareè™šæ‹Ÿç½‘ç»œè¿æ¥ç¤ºæ„å›¾" class="headerlink" title="å®Œæ•´çš„evengä¸vmwareè™šæ‹Ÿç½‘ç»œè¿æ¥ç¤ºæ„å›¾"></a>å®Œæ•´çš„evengä¸vmwareè™šæ‹Ÿç½‘ç»œè¿æ¥ç¤ºæ„å›¾</h2><p>vmwareæ˜¯å¯ä»¥åˆ›å»ºå¤šå¼ è™šæ‹Ÿç½‘å¡çš„ï¼Œé»˜è®¤æœ‰ä¸‰ç§ç½‘ç»œç±»å‹ï¼Œbridgeæ²¡æœ‰è™šæ‹Ÿç½‘å¡ï¼ŒVMnet1å¯¹åº”host-only,VMnet8å¯¹åº”NATã€‚è™½ç„¶å…è®¸åˆ›å»ºé¢å¤–çš„VMnetï¼Œ<code>ä½†æ˜¯ç±»å‹åªèƒ½æ˜¯host-only</code>ï¼Œæ‰€ä»¥çœ‹èµ·å¥½åƒæ²¡ä»€ä¹ˆåˆ›å»ºçš„å¿…è¦ï¼Œé»˜è®¤çš„å°±å·²ç»å¤Ÿç”¨äº†ã€‚æˆ‘ä»¬éœ€è¦åšçš„ä¹Ÿå°±æ˜¯é…ç½®ä¸€ä¸‹dhcpåœ°å€æ± (ä½¿ç”¨é»˜è®¤çš„ä¹Ÿè¡Œ)ã€‚<br>å¯¹äºevengçš„è™šæ‹Ÿç½‘ç»œï¼Œç”±å¤–ç½‘ã€windowsã€vmwareã€evengã€labè¿™äº›å¯¹è±¡ç»„æˆï¼Œå®Œæ•´çš„ç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/eveng_network_topology.png"></p>
<p>ä¸‹å›¾æ˜¯åœ¨vmwareä¸‹åˆ›å»ºè™šæ‹Ÿç½‘å¡çš„ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°vmnet0è™½ç„¶æ²¡æœ‰åœ¨windowsä¸Šåˆ›å»ºç½‘å¡ï¼Œä½†æ˜¯åœ¨vmwareä¸­è¿˜æ˜¯æœ‰è®¾å¤‡çš„ï¼Œæ­¤æ—¶vmnet0å°±æ˜¯ä¸€ä¸ªç½‘æ¡¥ã€‚<br><img src="https://rancho333.github.io/pictures/eveng_vmware_vnic.png"></p>
<p>æ‰€ä»¥åœ¨vmwareä¸­åˆ›å»ºä¸€å¼ ç½‘å¡åï¼š</p>
<ol>
<li>åœ¨windowsç½‘ç»œä¸­æ·»åŠ äº†ä¸€å¼ ç½‘å¡</li>
<li>åœ¨vmwareç¯å¢ƒä¸­æ·»åŠ äº†ä¸€ä¸ªåŒåç½‘æ¡¥</li>
<li>å½“å°†è¿™å¼ ç½‘å¡é…ç½®ç»™è™šæ‹Ÿæœºæ—¶ï¼Œè™šæ‹Ÿæœºä¸­åˆ›å»ºä¸€å¼ ç½‘å¡ï¼Œç„¶åè¿æ¥åˆ°vmwareçš„ç½‘æ¡¥ï¼Œè·å¾—å¯¹åº”ç½‘ç»œèƒ½åŠ›</li>
</ol>
]]></content>
      <tags>
        <tag>eveng</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoä¸­è¸©è¿‡çš„å‘</title>
    <url>/2019/07/25/hexo%E4%B8%AD%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬éƒ½æ˜¯ç«™åœ¨å‰äººçš„è‚©è†€ä¸Šçœ‹çš„æ›´è¿œï¼Œèµ°çš„æ›´é«˜ã€‚åœ¨è¿™é‡Œè®°å½•ä¸‹é€šè¿‡Hexoæ­å»ºä¸ªäººåšå®¢ï¼Œé€šè¿‡markdownå†™åšå®¢çš„è¿‡ç¨‹ä¸­è¸©çš„ä¸€äº›å‘ï¼Œå¸Œæœ›å¯¹çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„ä½ æœ‰äº›å¸®åŠ©ï¼</p>
<span id="more"></span>

<h3 id="å…³äºä»£ç å—"><a href="#å…³äºä»£ç å—" class="headerlink" title="å…³äºä»£ç å—"></a>å…³äºä»£ç å—</h3><p>```åé¢ä¸è¦ç•™ç©ºæ ¼ï¼Œä¸ç„¶ä¸ä¼šæŠŠå®ƒå½“åšä»£ç å—çš„å®šç•Œç¬¦æ¥å¤„ç†ï¼Œä¼šæŠŠåé¢çš„å†…å®¹éƒ½å½“åšä»£ç å—æ¥å¤„ç†ã€‚</p>
<h3 id="å…³äºè¡¨æ ¼"><a href="#å…³äºè¡¨æ ¼" class="headerlink" title="å…³äºè¡¨æ ¼"></a>å…³äºè¡¨æ ¼</h3><p>åœ¨è¡¨æ ¼å¼€å¤´ç•™ä¸ªç©ºè¡Œï¼Œä¸ç„¶å¯èƒ½ä¸å¯¹è¡¨æ ¼è¿›è¡Œæ¸²æŸ“ã€‚<br>åœ¨è¡¨æ ¼ç»“æŸç•™ä¸ªç©ºè¡Œï¼Œä¸ç„¶å¯èƒ½å¯¹è¡¨æ ¼ä¹‹åçš„å†…å®¹è¿›è¡Œè¶Šç•Œæ¸²æŸ“ã€‚</p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>è¸©å‘</tag>
        <tag>hexo</tag>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>hsrpç®€è¿°</title>
    <url>/2022/07/07/hsrp%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨ä»‹ç»HSRPä¹‹å‰å…ˆç®€å•è¯´æ˜ä¸€ä¸‹FHRP(first hop redundancy protocol)ï¼Œç¬¬ä¸€è·³å†—ä½™åè®®ã€‚ç¬¬ä¸€è·³å³ç½‘å…³ï¼Œç»ˆç«¯è®¾å¤‡å•ç½‘å¡å¾€å¾€åªèƒ½é…ç½®ä¸€ä¸ªç½‘å…³ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨å•ç‚¹æ•…éšœï¼Œä¼ è¾“ç½‘ä¸­åˆ™å¯ä»¥é€šè¿‡è·¯ç”±åè®®æä¾›é“¾è·¯å†—ä½™ã€‚FHRPå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œå‡ºç°çš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯FHRPæ›´å¤šçš„æ˜¯ä¸€ç§åœºæ™¯çš„æè¿°ï¼Œå¹¶ä¸æ˜¯å…·ä½“åè®®ï¼ŒçœŸæ­£çš„å®ç°åˆ™æ˜¯ç”±HSRPã€VRRPã€GLBPã€L3 mlagæ¥å®Œæˆçš„ã€‚ç±»ä¼¼äºEthernetchannelï¼Œå…¶çœŸæ­£çš„å®ç°åˆ™æ˜¯ç”±LACPã€PAgPã€staticè¿™äº›æ–¹å¼æ¥å®Œæˆã€‚</p>
<span id="more"></span>
<p>HSRP(hot standby routing protocol)å’ŒGLBP(gateway load balancing protocol)æ˜¯ciscoçš„ç§æœ‰åè®®ï¼Œvrrp(virtual router redundancy protocol)æ˜¯å…¬æœ‰çš„ã€‚è¿™é‡Œä¸»è¦ä»‹ç»HSRPçš„åŸºæœ¬åŸç†ï¼Œç„¶ååšä¸€ä¸ªHSRP+PVSTPçš„å®éªŒæ¥è¯´æ˜ä¸åŒç½‘æ®µçš„è´Ÿè½½å‡è¡¡ã€‚</p>
<h1 id="åŸç†ä»‹ç»"><a href="#åŸç†ä»‹ç»" class="headerlink" title="åŸç†ä»‹ç»"></a>åŸç†ä»‹ç»</h1><p>ä¸€ç»„äº¤æ¢æœº(å®é™…ä¸Šæ˜¯äº¤æ¢æœºçš„ä¸‰å±‚æ¥å£)åŠ å…¥ä¸€ä¸ªgroupä¸­ï¼Œè¿™ä¸ªgroupå‘å¤–æä¾›è™šæ‹Ÿipä½œä¸ºç½‘å…³ã€‚è¿™äº›äº¤æ¢æœºé€šè¿‡äº¤æ¢hsrp helloæŠ¥æ–‡é€‰ä¸¾å‡ºactiveå’Œstandbyï¼Œå…¶å®ƒçš„äº¤æ¢æœºæ˜¯candidatesï¼Œactiveç½‘å…³è¿›è¡Œæ•°æ®è½¬å‘ï¼Œå½“activeæŒ‚æ‰ä¹‹åï¼Œstandbyæˆä¸ºæ–°çš„activeï¼Œå¹¶ä»candidateä¸­é€‰ä¸¾å‡ºæ–°çš„standbyã€‚æ³¨æ„ï¼ŒHSRPæ˜¯å•æ´»çš„ã€‚</p>
<p>åªæœ‰activeæ‰ä¼šå¯¹arpè¿›è¡Œåº”ç­”ï¼Œstandbyå¿½ç•¥ã€‚é€‰ä¸¾å‡ºactiveåï¼Œactiveä¼šç«‹å³å‘å¤–å‘é€å…è´¹ARPæŠ¥æ–‡ï¼Œåœ¨æ‹“æ‰‘æ”¶æ•›åœºæ™¯ä¸‹ï¼Œè¿™ä¼šç«‹é©¬ç¯å¢ƒä¸­çš„arpç¼“å­˜å’Œæ—§çš„macåœ°å€è¡¨ã€‚</p>
<h2 id="ç®€å•é…ç½®è¯´æ˜"><a href="#ç®€å•é…ç½®è¯´æ˜" class="headerlink" title="ç®€å•é…ç½®è¯´æ˜"></a>ç®€å•é…ç½®è¯´æ˜</h2><p>æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/hsrp_basic_topology.png"></p>
<p>S8åšæ¥å…¥äº¤æ¢æœºï¼Œç½‘å…³è®¾ç½®åœ¨æ±‡èšå±‚ï¼Œç”±S7å’ŒS9å½¢æˆçš„è™šæ‹ŸIP<code>192.168.1.254</code>æ‰¿æ‹…ã€‚é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S7</span><br><span class="line">interface Vlan1</span><br><span class="line"> ip address 192.168.1.1 255.255.255.0          &#x2F;&#x2F; é…ç½®ä¸‰å±‚æ¥å£åœ°å€ï¼ŒhsrpæŠ¥æ–‡åŸåœ°å€</span><br><span class="line"> standby 1 ip 192.168.1.254                    &#x2F;&#x2F; åŠ å…¥è™šæ‹Ÿç»„1ï¼Œè™šæ‹Ÿipä¸º192.168.1.254</span><br><span class="line"></span><br><span class="line">S9</span><br><span class="line">interface Vlan1</span><br><span class="line"> ip address 192.168.1.2 255.255.255.0</span><br><span class="line"> standby 1 ip 192.168.1.254</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>show standby brief</code>å¯ä»¥æŸ¥çœ‹hsrpçŠ¶æ€ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S7#show standby brief </span><br><span class="line">                     P indicates configured to preempt.</span><br><span class="line">                     |</span><br><span class="line">Interface   Grp  Pri P State   Active          Standby         Virtual IP</span><br><span class="line">Vl1         1    101 P Active  local           192.168.1.2     192.168.1.254</span><br></pre></td></tr></table></figure>

<p>hsrpçš„é…ç½®éå¸¸ç®€å•ï¼Œå®é™…ä¸Šå°±ä¸€æ¡å‘½ä»¤ã€‚æ³¨æ„standbyå‘½ä»¤çš„é…ç½®ä¸€å®šè¦åŠ ä¸Šgroup idï¼Œå¦‚æœä¸åŠ é»˜è®¤æ˜¯ç»™group 0åšé…ç½®ã€‚å¦‚<code>standby ip 192.168.1.56</code>ï¼Œè¡¨ç¤ºç«¯å£åŠ å…¥è™šæ‹Ÿç»„0ï¼Œè™šæ‹Ÿipæ˜¯192.168.1.56. ä¸€ä¸ªä¸‰å±‚æ¥å£å¯ä»¥åŠ å…¥å¤šä¸ªè™šæ‹Ÿç»„ã€‚</p>
<h2 id="HSRPæŠ¥æ–‡è¯´æ˜"><a href="#HSRPæŠ¥æ–‡è¯´æ˜" class="headerlink" title="HSRPæŠ¥æ–‡è¯´æ˜"></a>HSRPæŠ¥æ–‡è¯´æ˜</h2><p>HSRP helloæŠ¥æ–‡æ ¼å¼å¦‚ä¸‹</p>
<p><img src="https://rancho333.github.io/pictures/hsrp_hello_packet.png"></p>
<ul>
<li>version: 0è¡¨ç¤ºHSRP v1, 1è¡¨ç¤ºHSRP v2</li>
<li>op code: 0è¡¨ç¤ºhelloæŠ¥æ–‡ï¼Œ1è¡¨ç¤ºcoupæŠ¥æ–‡ï¼Œ3è¡¨ç¤ºadvertiseæŠ¥æ–‡</li>
<li>stateï¼šç«¯å£çŠ¶æ€ï¼Œè§ä¸‹è¡¨</li>
<li>hellotime: activeå‘¨æœŸæ€§å‘é€helloæŠ¥æ–‡ï¼Œstandbyé€šè¿‡ç›‘å¬helloæŠ¥æ–‡ç¡®å®šactiveçš„çŠ¶æ€ã€‚é»˜è®¤3ç§’</li>
<li>holdtimeï¼šactiveè¶…æ—¶æ—¶é—´ï¼Œstandbyåœ¨holdtimeæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°activeçš„helloæŠ¥æ–‡ï¼Œé‡æ–°é€‰ä¸¾activeã€‚é»˜è®¤10ç§’</li>
<li>priorityï¼šç«¯å£ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆæœ€å¤§çš„é€‰ä¸¾æˆä¸ºactiveï¼Œå¦‚æœä¼˜å…ˆçº§ä¸€è‡´ï¼ŒIPåœ°å€è¶Šå¤§è¶Šä¼˜</li>
<li>groupï¼šè™šæ‹Ÿç»„ï¼Œä¸‰å±‚æ¥å£åŠ å…¥ç›¸åŒè™šæ‹Ÿç»„ï¼Œä¹‹åé€‰ä¸¾å‡ºactive/standbyï¼Œè™šæ‹Ÿç»„å¯¹å¤–æä¾›ç½‘å…³æœåŠ¡</li>
<li>authentication: è®¤è¯æ–¹å¼ï¼Œå¯ä»¥è®¾ç½®è®¤è¯å£ä»¤ï¼Œå¦‚æœgroupç›¸åŒï¼Œè®¤è¯ä¸é€šè¿‡ï¼Œé‚£ä¹ˆä¸èƒ½å‚ä¸åˆ°è™šæ‹Ÿç»„ä¸­</li>
<li>virtual ip add: è™šæ‹Ÿç½‘å…³çš„ip. è™šæ‹Ÿç»„ä¸­çš„æˆå‘˜ç«¯å£éœ€è¦é…ç½®ç›¸åŒçš„vipã€‚</li>
</ul>
<p>ç«¯å£çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">çŠ¶æ€</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">initial</td>
<td align="left">HSRPå¯åŠ¨çš„åˆå§‹çŠ¶æ€</td>
</tr>
<tr>
<td align="left">listen</td>
<td align="left">è·¯ç”±å™¨çŸ¥é“äº†vipï¼Œå¼€å¯ä¾¦å¬å…¶å®ƒHSRPè·¯ç”±å™¨å‘é€çš„helloæŠ¥æ–‡ï¼Œcandidateså¤„äºè¯¥çŠ¶æ€</td>
</tr>
<tr>
<td align="left">speak</td>
<td align="left">å‘é€helloæŠ¥æ–‡ï¼Œå‚ä¸é€‰ä¸¾</td>
</tr>
<tr>
<td align="left">standby</td>
<td align="left">å¤‡ç”¨ç½‘å…³ï¼Œç»§ç»­å‘é€helloæŠ¥æ–‡ï¼Œ<strong>æºmacæ˜¯å‘é€æ¥å£çš„mac</strong></td>
</tr>
<tr>
<td align="left">active</td>
<td align="left">ä½œä¸ºç½‘å…³è½¬å‘æ•°æ®æµé‡ï¼Œç»§ç»­å‘é€helloæŠ¥æ–‡ï¼Œ<strong>æºmacæ˜¯è™šæ‹ŸMAC</strong></td>
</tr>
</tbody></table>
<h2 id="Vipä¸Vmac"><a href="#Vipä¸Vmac" class="headerlink" title="Vipä¸Vmac"></a>Vipä¸Vmac</h2><p>åŠ å…¥åŒä¸€ä¸ªè™šæ‹Ÿç»„çš„ä¸‰å±‚æ¥å£ä¸‹é…ç½®ç›¸åŒçš„vipï¼Œè¿™ä¸ªipä½œä¸ºç»ˆç«¯çš„ç½‘å…³ã€‚<br>vmacæ˜¯æ ¹æ®è™šæ‹Ÿç»„IDæ„é€ å‡ºæ¥çš„ä¸€ä¸ªmacåœ°å€ï¼š</p>
<ul>
<li>åœ¨v1ä¸­æ˜¯0000.0c07.acXX (XX = group number)</li>
<li>åœ¨v2ä¸­æ˜¯0000.0c9f.fxxx (XXX = group number)</li>
</ul>
<h2 id="preemptæŠ¢å "><a href="#preemptæŠ¢å " class="headerlink" title="preemptæŠ¢å "></a>preemptæŠ¢å </h2><p>HSRPé»˜è®¤ä¸å¼€å¯æŠ¢å æœºåˆ¶ï¼Œå³active/standbyè§’è‰²ç¡®å®šåï¼Œå³ä½¿æ”¹å˜ä¼˜å…ˆçº§æ¯”activeå¤§ï¼Œä¹Ÿä¸ä¼šå‘ç”ŸæŠ¢å ã€‚å¯ä»¥é€šè¿‡<code>S3(config-if)#standby 10 preempt</code>å‘½ä»¤å¼€å¯æŠ¢å åŠŸèƒ½ã€‚</p>
<p>çŠ¶æ€ç¨³å®šåï¼Œåªæœ‰ä¿®æ”¹ä¼˜å…ˆçº§æ‰ä¼šå‘ç”ŸæŠ¢å ã€‚ä¸ä¼šæ ¹æ®IPåœ°å€çš„å¤§å°åšå‡ºæ”¹å˜ã€‚</p>
<h2 id="md5è®¤è¯"><a href="#md5è®¤è¯" class="headerlink" title="md5è®¤è¯"></a>md5è®¤è¯</h2><p>HSRPæ”¯æŒè®¤è¯ï¼Œå¯ä»¥é€‰æ‹©æ˜æ–‡æˆ–md5. md5é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š<br><code>S2(config-if)#standby 10 authentication md5 key-string rancho</code><br>è¿™å¯ä»¥é¿å…æœªç»æˆæƒçš„äº¤æ¢æœºå‚ä¸HSRPè®¡ç®—ã€‚</p>
<h2 id="HSRP-Version-1-å’Œ-2"><a href="#HSRP-Version-1-å’Œ-2" class="headerlink" title="HSRP Version 1 å’Œ 2"></a>HSRP Version 1 å’Œ 2</h2><p>HSRPæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå‘ƒï¼Œè²Œä¼¼æ²¡ä»€ä¹ˆå¤ªå¤§åŒºåˆ«ï¼Œç®€å•è¿‡ä¸‹å§ï¼š<br>|| V1 | V2 |<br>| :â€” | :â€” | :â€” |<br>| group nums | 0-255 | 0-4096 |<br>| vmac | 0000.0c07.acXX (XX = group number) | 0000.0c9f.fxxx (XXX = group number)|<br>| multicast add | 224.0.0.2 | 224.0.0.102 |<br>æ³¨æ„ä¸¤ä¸ªç‰ˆæœ¬æ˜¯ä¸å…¼å®¹çš„ï¼Œéƒ½åŒæ—¶æ”¯æŒipv4å’Œipv6.</p>
<h2 id="object-tracking"><a href="#object-tracking" class="headerlink" title="object tracking"></a>object tracking</h2><p>æ²¿ç”¨<code>ç®€å•é…ç½®è¯´æ˜</code>ä¸­çš„æ‹“æ‰‘å›¾ã€‚å½“å‰ç¯å¢ƒä¸‹ï¼ŒS7æ˜¯activeï¼Œå¦‚æœeth1é“¾è·¯æ•…éšœæˆ–è€…S7æŒ‚æ‰æˆ–è€…interface vlan1æŒ‚æ‰ï¼Œé‚£ä¹ˆS9åœ¨10ç§’å†…æ²¡æœ‰æ”¶åˆ°activeçš„helloæŠ¥æ–‡åä¼šæˆä¸ºæ–°çš„activeã€‚ä½†æ˜¯å¦‚æœæ˜¯S7çš„eth2æŒ‚æ‰ï¼Œå³S7æ²¡æœ‰äº†ä¸Šè¡Œé“¾è·¯ï¼Œeth1ä¾ç„¶ä¼šå‘¨æœŸæ€§å‘é€helloï¼ŒS9å¹¶ä¸ä¼šæ„ŸçŸ¥åˆ°activeç½‘å…³ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<p>S7ä¼šå‘vpcå‘é€<code>icmp redirect</code>æŠ¥æ–‡è®©å…¶ä¿®æ”¹é»˜è®¤ç½‘å…³ï¼Œä½†æ›´å¥½çš„æ–¹å¼æ˜¯è®©S9æˆä¸ºactiveç½‘å…³ã€‚(å®éªŒæ—¶å°†S7ä¸Šeth2 shutdownï¼Œvpcä¸Šping R6çš„loopback1, å¯ä»¥pingé€šï¼Œå‘ç°S7ä¾ç„¶æ˜¯activeï¼ŒS8å‘é€çš„icmpæŠ¥æ–‡ä¾ç„¶æ˜¯é€åˆ°S7ï¼ŒS7å°†icmpçš„src macæ”¹æˆè‡ªå·±macï¼Œç›®çš„macæ”¹æˆS9çš„macï¼Œè¿›è€Œåˆ°è¾¾R6)</p>
<p>è¿™ç§åœºæ™¯ä¸‹éœ€è¦ä½¿ç”¨<code>object tracking</code>åŠŸèƒ½æ¥è¿½è¸ªS7ä¸Šeth2çš„çŠ¶æ€ï¼Œå¦‚æœä¸Šè¡Œé“¾è·¯æ•…éšœï¼Œå°±é™ä½æœ¬åœ°hsrpä¼˜å…ˆçº§ï¼Œä½¿standbyè½¬æ¢æˆactiveå·¥ä½œã€‚</p>
<p>HSRPæä¾›ç«¯å£è¿½è¸ªçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€‰å–ä¸€ä¸ªç«¯å£è¿›è¡Œè¿½è¸ªï¼Œå¦‚æœæŒ‚äº†ï¼Œå°±å¯ä»¥é™ä½è®¾å¤‡hsrpä¼˜å…ˆçº§ï¼Œä½¿å…¶å®ƒçš„standbyå˜æˆactiveã€‚é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S7(config)#track 1 interface ethernet 0&#x2F;2 line-protocol    &#x2F;&#x2F; åˆ›å»ºtrack object 1, trackå†…å®¹æ˜¯ethernet 0&#x2F;2çš„çŠ¶æ€ï¼Œå¦‚æœdownå°±è§¦å‘</span><br><span class="line">S7(config-if)#standby 1 track 1 decrement 50    &#x2F;&#x2F; åœ¨group 1ä¸Šå…³è”track object 1ï¼Œå¦‚æœè§¦å‘å°†ä¼˜å…ˆçº§é™ä½50</span><br></pre></td></tr></table></figure>

<p>å°†S7çš„eth2 shutdownä¹‹åï¼Œå‘ç°ä¼˜å…ˆçº§é™ä½ï¼Œactiveå˜äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S7#show standby brief </span><br><span class="line">                     P indicates configured to preempt.</span><br><span class="line">                     |</span><br><span class="line">Interface   Grp  Pri P State   Active          Standby         Virtual IP</span><br><span class="line">Vl1         1    50  P Speak   192.168.1.2     unknown         192.168.1.254</span><br></pre></td></tr></table></figure>

<p>å¦å¤–ä¸€ç§æ–¹å¼æ˜¯å…³è”<code>ip sla</code>. é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S7(config)#ip sla 1                 &#x2F;&#x2F; åˆ›å»ºä¸€æ¡slaï¼Œidæ˜¯1</span><br><span class="line">S7(config-ip-sla)#icmp-echo 192.168.4.1       &#x2F;&#x2F; æµ‹è¯•ä¸192.168.4.1çš„è¿é€šæ€§</span><br><span class="line">S7(config-ip-sla-echo)#frequency 5            &#x2F;&#x2F;æ¯5ç§’pingä¸€æ¬¡</span><br><span class="line">S7(config)#ip sla schedule 1 start-time now life forever     &#x2F;&#x2F; sla 1ä»ç°åœ¨å¼€å§‹è¿è¡Œå¹¶ä¸”ä¸€ç›´è¿è¡Œä¸‹å»</span><br><span class="line"></span><br><span class="line">S7(config)#track 1 ip sla 1         &#x2F;&#x2F; åˆ›å»ºtrack object 1, ä¸ip sla 1å…³è”</span><br><span class="line">S7(config-if)#standby 1 track 1 decrement 80     &#x2F;&#x2F; å°†track 1ä¸group 1å…³è”</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼ä¸‹å‘ç°S7 ping 192.168.4.1çš„å“ä¸€è·³å˜æˆS9ï¼Œå› ä¸ºä»–ä»¬ä¹‹é—´è·‘äº†ospfã€‚ä½†æ˜¯æ²¡å…³ç³»ï¼ŒåŸç†æ˜¯è¿™ä¹ˆä¸ªåŸç†ï¼ŒæŠŠospfå…³äº†å°±å¯ä»¥è§¦å‘äº†ã€‚</p>
<h3 id="track-listç‰¹æ€§"><a href="#track-listç‰¹æ€§" class="headerlink" title="track listç‰¹æ€§"></a>track listç‰¹æ€§</h3><p>å½“æœ‰å¤šä¸ªtrackå¯¹è±¡ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ä¾èµ–è¿™äº›å¯¹è±¡è·Ÿè¸ªç»“æœæ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>track list</code>ç‰¹æ€§ã€‚<br>æ²¿ç”¨<code>ç®€å•é…ç½®è¯´æ˜</code>ä¸­çš„å›¾ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">track 2 interface Ethernet0&#x2F;1 line-protocol             &#x2F;&#x2F; åˆ›å»ºtrack object 2ï¼Œè·Ÿè¸ªeth1çš„é“¾è·¯çŠ¶æ€</span><br><span class="line">!</span><br><span class="line">track 3 interface Ethernet0&#x2F;2 line-protocol             &#x2F;&#x2F; åˆ›å»ºtrack object 3ï¼Œè·Ÿè¸ªeth2çš„é“¾è·¯çŠ¶æ€</span><br><span class="line">!</span><br><span class="line">track 4 list boolean and                                &#x2F;&#x2F; åˆ›å»ºtrack list 4, listä¸­çš„å¯¹è±¡é€»è¾‘ä¸ç»“æœæ˜¯track 4çš„æœ€ç»ˆç»“æœ</span><br><span class="line"> object 2                                               &#x2F;&#x2F; ç»™track list 4æ·»åŠ listç›‘æ§å¯¹è±¡2</span><br><span class="line"> object 3                                               &#x2F;&#x2F; ç»™track list 4æ·»åŠ listç›‘æ§å¯¹è±¡3</span><br><span class="line">&#x2F;&#x2F; å½“eth2å’Œeth3éƒ½æ˜¯upçš„æ—¶å€™ï¼Œtrack 4ç»“æœæ˜¯upï¼Œå¦åˆ™down</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S7#show track brief </span><br><span class="line">Track Type        Instance                   Parameter        State Last Change</span><br><span class="line">1     ip sla      1                          state            Down  00:09:17</span><br><span class="line">2     interface   Ethernet0&#x2F;1                line-protocol    Up    00:07:55</span><br><span class="line">3     interface   Ethernet0&#x2F;2                line-protocol    Up    00:06:38</span><br><span class="line">4     list                                   boolean          Up    00:05:08</span><br></pre></td></tr></table></figure>
<p>å½“HSRPæœ‰ä¸¤ä¸ªä¸Šè¡Œé“¾è·¯æ—¶ï¼Œtrack 2ã€3åˆ†åˆ«ç›‘æ§ä¸¤ä¸ªä¸Šè¡Œé“¾è·¯ï¼Œåªç”¨åœ¨hsrpä¸­å…³è”track4å°±è¡Œï¼Œå‡å°‘å…³è”å¯¹è±¡ã€‚</p>
<h2 id="HSRPç»“åˆPVSTPåšä¸åŒç½‘æ®µæµé‡çš„è´Ÿè½½å‡è¡¡"><a href="#HSRPç»“åˆPVSTPåšä¸åŒç½‘æ®µæµé‡çš„è´Ÿè½½å‡è¡¡" class="headerlink" title="HSRPç»“åˆPVSTPåšä¸åŒç½‘æ®µæµé‡çš„è´Ÿè½½å‡è¡¡"></a>HSRPç»“åˆPVSTPåšä¸åŒç½‘æ®µæµé‡çš„è´Ÿè½½å‡è¡¡</h2><p>å®éªŒæ‹“æ‰‘å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/hsrp_pvstp.png"></p>
<p>HSRPä¸PVSTPåŒæ—¶ä½¿ç”¨æ—¶ï¼Œåšä¸åŒç½‘æ®µçš„è´Ÿè½½å‡è¡¡ï¼Œåº”æ³¨æ„è¯¥ç½‘æ®µ(vlan)HSRPçš„activeä¸PVSTPçš„æ ¹æ¡¥åº”åœ¨åŒä¸€è®¾å¤‡ä¸Šï¼Œä¸ç„¶æµé‡ä¼šé›†ä¸­åˆ°æŸä¸€å°è®¾å¤‡ä¸Šï¼Œå¯¼è‡´è¯¥è®¾å¤‡è´Ÿè½½è¿‡å¤§ï¼Œè€Œå¦ä¸€å°æ²¡æœ‰æµé‡éœ€è¦è½¬å‘ã€‚é…ç½®æ€è·¯å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ’åˆ†vlanï¼Œé…ç½®äº¤æ¢æœºäº’è”trunk<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S1</span><br><span class="line">    vlan 10,20</span><br><span class="line">    interface Ethernet0&#x2F;0</span><br><span class="line">        switchport access vlan 10</span><br><span class="line">    interface Ethernet0&#x2F;1</span><br><span class="line">         switchport trunk encapsulation dot1q</span><br><span class="line">         switchport mode trunk</span><br><span class="line">    interface Ethernet0&#x2F;2</span><br><span class="line">         switchport trunk encapsulation dot1q</span><br><span class="line">         switchport mode trunk</span><br><span class="line">    interface Ethernet0&#x2F;3</span><br><span class="line">         switchport access vlan 20</span><br><span class="line">S2, S3åšç±»ä¼¼é…ç½®</span><br></pre></td></tr></table></figure></li>
<li>è®¾ç½®vlançš„æ ¹æ¡¥ï¼ŒS2æ˜¯vlan10çš„æ ¹æ¡¥ï¼ŒS3æ˜¯vlan20çš„æ ¹æ¡¥<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2</span><br><span class="line">    spanning-tree vlan 10 priority 4096</span><br><span class="line">S3</span><br><span class="line">    spanning-tree vlan 20 priority 4096</span><br></pre></td></tr></table></figure></li>
<li>åˆ›å»ºinterface vlan; è®¾ç½®hsrpï¼ŒS2æ˜¯vlan10æ‰€åœ¨ç½‘æ®µçš„activeï¼ŒS3æ˜¯vlan20æ‰€åœ¨ç½‘æ®µ çš„active<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2</span><br><span class="line">    interface Vlan10</span><br><span class="line">        ip address 192.168.1.1 255.255.255.0</span><br><span class="line">        standby 10 ip 192.168.1.254</span><br><span class="line">        standby 10 priority 101</span><br><span class="line">        standby 10 preempt</span><br><span class="line">S3</span><br><span class="line">    interface Vlan10</span><br><span class="line">        ip address 192.168.1.3 255.255.255.0</span><br><span class="line">        standby 10 ip 192.168.1.254</span><br><span class="line">        standby 20 preempt</span><br><span class="line">&#x2F;&#x2F;S2ä½œä¸ºvlan10ç½‘æ®µçš„active</span><br><span class="line"></span><br><span class="line">S2</span><br><span class="line">    interface Vlan20</span><br><span class="line">       ip address 192.168.2.1 255.255.255.0</span><br><span class="line">       standby 20 ip 192.168.2.254</span><br><span class="line">       standby 10 preempt</span><br><span class="line">S3</span><br><span class="line">    interface Vlan20</span><br><span class="line">       ip address 192.168.2.3 255.255.255.0</span><br><span class="line">       standby 20 ip 192.168.2.254</span><br><span class="line">       standby 20 priority 101</span><br><span class="line">       standby 20 preempt</span><br><span class="line">&#x2F;&#x2F; S3ä½œä¸ºvlan20ç½‘æ®µçš„active</span><br></pre></td></tr></table></figure>
å®Œæˆåçš„æµé‡è·¯å¾„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img src="https://rancho333.github.io/pictures/hsrp_pvstp_1.png"></p>
<p>åœ¨å¤šå®ä¾‹ä¸­æˆ‘ä»¬å°†ä¸åŒvlançš„æ ¹æ¡¥æ”¾ç½®åœ¨ä¸åŒçš„è®¾å¤‡ä¸Šï¼Œè¿™æ ·å¯ä»¥è®©ä¸åŒå®ä¾‹çš„æµé‡è·¯å¾„ä¸ä¸€è‡´ï¼Œä»è€Œæœ€å¤§é™åº¦çš„åˆ©ç”¨å¸¦å®½ï¼Œå‡å°‘æµé‡æ‹¥å¡ï¼Œé¿å…å¸¦å®½æµªè´¹ï¼ŒåŒæ—¶ä¹Ÿé¿å…å•ä¸€è®¾å¤‡è´Ÿè½½è¿‡é«˜ã€‚</p>
<p>ç½‘å…³ä¸€èˆ¬è®¾ç½®åœ¨æ±‡èšå±‚ï¼Œæˆ‘ä»¬å‡è±¡ä¸‹ï¼Œå¦‚æœvlançš„æ ¹æ¡¥æ˜¯S2ï¼Œè€Œactiveæ˜¯S3ï¼Œé‚£ä¹ˆvpc4çš„æµé‡éœ€è¦ç»è¿‡S1åˆ°S2å†è½¬åˆ°S3(S3çš„eth2æ˜¯blockçš„)ï¼Œæ— ç–‘å¤šäº†ä¸€æ¬¡è½¬å‘ï¼Œè¿™æ˜¯ä¸å¿…è¦çš„ï¼Œæˆ‘ä»¬åº”å½“é¿å…ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>igmp-snoopingå­¦ä¹ </title>
    <url>/2019/09/10/igmp-snooping%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>æ©ï¼Œ18å¹´åšäº†åŠå¹´çš„ç»„æ’­ï¼Œç®—å…¥é—¨å§ï¼æœ€è¿‘æœ‰ä¸ªigmp snoopingï¼ˆä¸‹é¢ç®€ç§°igspï¼‰çš„bugï¼Œæ˜¯ä¸ªæœºç¼˜æ¥è§¦ä¸€ä¸‹igspï¼</p>
<span id="more"></span>


<h2 id="ä½¿ç”¨éœ€æ±‚ç®€è¿°"><a href="#ä½¿ç”¨éœ€æ±‚ç®€è¿°" class="headerlink" title="ä½¿ç”¨éœ€æ±‚ç®€è¿°"></a>ä½¿ç”¨éœ€æ±‚ç®€è¿°</h2><p>å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç»„æ’­æŠ¥æ–‡è¦ä¸å¯é¿å…çš„ç»è¿‡ä¸€äº›äºŒå±‚äº¤æ¢è®¾å¤‡ï¼Œå°¤å…¶æ˜¯åœ¨å±€åŸŸç½‘ç¯å¢ƒé‡Œã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/environment.png"></p>
<p>ä¸Šå›¾ä¸­switchä¼šå°†ç»„æ’­æŠ¥æ–‡å½“åšå¹¿æ’­åœ¨vlanå†…è¿›è¡Œfloodï¼Œè¿™æ˜¯å› ä¸ºç»„æ’­æŠ¥æ–‡çš„ç›®çš„åœ°å€ä¸ºç»„æ’­åœ°å€ï¼Œåœ¨äºŒå±‚è®¾å¤‡ä¸Šå­¦ä¹ ä¸åˆ°è¿™ä¸€ç±»çš„MACè¡¨é¡¹ï¼Œè¿™æ ·ä¸ä½†æµªè´¹ç½‘ç»œå¸¦å®½ï¼Œè€Œä¸”å½±å“ç½‘ç»œä¿¡æ¯å®‰å…¨ã€‚é…ç½®igspåï¼ŒäºŒå±‚ç»„æ’­è®¾å¤‡å¯ä»¥ä¾¦å¬å’Œåˆ†æç»„æ’­ç”¨æˆ·å’Œä¸Šæ¸¸è·¯ç”±å™¨ä¹‹é—´çš„IGMPæŠ¥æ–‡ï¼Œæ ¹æ®è¿™äº›ä¿¡æ¯å»ºç«‹äºŒå±‚ç»„æ’­è½¬å‘è¡¨é¡¹ï¼Œæ§åˆ¶ç»„æ’­æ•°æ®æŠ¥æ–‡çš„è½¬å‘ã€‚</p>
<h2 id="IGSPåŸºæœ¬åŸç†"><a href="#IGSPåŸºæœ¬åŸç†" class="headerlink" title="IGSPåŸºæœ¬åŸç†"></a>IGSPåŸºæœ¬åŸç†</h2><p>IGSPæ˜¯äºŒå±‚ç»„æ’­çš„åŸºæœ¬åŠŸèƒ½ï¼Œå¯ä»¥å®ç°ç»„æ’­æ•°æ®åœ¨é“¾è·¯å±‚çš„è½¬å‘å’Œæ§åˆ¶ã€‚å½“ä¸»æœºå’Œä¸Šæ¸¸ä¸‰å±‚è®¾å¤‡ä¹‹é—´ä¼ é€’IGMPåè®®æŠ¥æ–‡é€šè¿‡äºŒå±‚ç»„æ’­è®¾å¤‡æ—¶ï¼ŒIGSPåˆ†ææŠ¥æ–‡æºå¸¦çš„ä¿¡æ¯ï¼Œæ ¹æ®è¿™äº›ä¿¡æ¯å»ºç«‹å’Œç»´æŠ¤ç»„æ’­è½¬å‘è¡¨ï¼Œä»è€ŒæŒ‡å¯¼ç»„æ’­æ•°æ®åœ¨æ•°æ®é“¾è·¯å±‚æŒ‰éœ€è½¬å‘ã€‚<br><img src="https://rancho333.github.io/pictures/mc_data.png"></p>
<h2 id="IGSPç›¸å…³æ¦‚å¿µ"><a href="#IGSPç›¸å…³æ¦‚å¿µ" class="headerlink" title="IGSPç›¸å…³æ¦‚å¿µ"></a>IGSPç›¸å…³æ¦‚å¿µ</h2><p><img src="https://rancho333.github.io/pictures/concept.png"><br>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸‰å±‚è®¾å¤‡routerä»ç»„æ’­æºæ¥æ”¶æ•°æ®å¹¶å‘ä¸‹æ¸¸è½¬å‘ï¼Œåœ¨äºŒå±‚ç»„æ’­æ¶‰ç¬”Switch Aå’ŒSwitch Bä¸Šåˆ†åˆ«è¿è¡ŒIGSPï¼ŒHost A,B,Cä¸ºç»„æ’­æˆå‘˜ã€‚ä¸‹é¢è¯´ä¸‹IGSPä¸­çš„å‡ ä¸ªé‡è¦æ¦‚å¿µã€‚</p>
<ul>
<li><p>è·¯ç”±å™¨ç«¯å£ï¼ˆRouter Portï¼‰<br>å¦‚Switch Aå’ŒSwitch Bä¸Šè“è‰²åœ†åœˆè¡¨ç¤ºçš„æ¥å£ã€‚<br>è·¯ç”±å™¨ç«¯å£æŒ‡äºŒå±‚ç»„æ’­è®¾å¤‡ä¸Š <em><strong>æœå‘</strong></em> ç»„æ’­è·¯ç”±å™¨çš„æ¥å£ã€‚äºŒå±‚ç»„æ’­è®¾å¤‡ä»è¯¥æ¥å£æ¥å—IGMPå’ŒPIMåè®®æŠ¥æ–‡ä»¥åŠç»„æ’­æ•°æ®æŠ¥æ–‡ã€‚<br>ç”±åè®®ç”Ÿæˆçš„è·¯ç”±å™¨ç«¯å£å«åšåŠ¨æ€è·¯ç”±å™¨ç«¯å£ï¼Œæ‰‹åŠ¨é…ç½®çš„è·¯ç”±å™¨ç«¯å£å«åšé™æ€è·¯ç”±å™¨ç«¯å£ã€‚<br>æ”¶åˆ°æºåœ°å€ä¸ä¸º0.0.0.0çš„IGMPæ™®éç»„æŸ¥è¯¢æŠ¥æ–‡æˆ–PIM HelloæŠ¥æ–‡çš„æ¥å£éƒ½è¢«è§†ä¸ºåŠ¨æ€è·¯ç”±å™¨ç«¯å£ï¼ˆå‘ƒï¼ŒENOSä¸­IGSPè²Œä¼¼æ²¡æœ‰å¤„ç†PIMæŠ¥æ–‡çš„åœ°æ–¹ï¼‰ã€‚</p>
</li>
<li><p>æˆå‘˜ç«¯å£ï¼ˆMember portï¼‰<br>å¦‚Switch Aï¼ŒBä¸Šé»„è‰²æ–¹æ¡†è¡¨ç¤ºçš„æ¥å£ã€‚åˆè¢«ç§°ä¸ºç»„æ’­æˆå‘˜ç«¯å£ï¼Œè¡¨ç¤ºäºŒå±‚ç»„æ’­è®¾å¤‡ä¸Šæœå‘ç»„æ’­æˆå‘˜ä¸€ä¾§çš„ç«¯å£ï¼ŒäºŒå±‚ç»„æ’­è®¾å¤‡å¾€æ­¤æ¥å£å‘é€ç»„æ’­æ•°æ®æŠ¥æ–‡ã€‚<br>ç”±åè®®ç”Ÿæˆçš„æˆå‘˜ç«¯å£å«åšåŠ¨æ€æˆå‘˜ç«¯å£ï¼Œæ‰‹åŠ¨é…ç½®çš„æˆå‘˜ç«¯å£å«åšé™æ€æˆå‘˜ç«¯å£ã€‚<br>æ”¶åˆ°IGMP reportæŠ¥æ–‡çš„æ¥å£ï¼ŒäºŒå±‚ç»„æ’­è®¾å¤‡ä¼šå°†å…¶æ ‡è¯†ä¸ºåŠ¨æ€æˆå‘˜ç«¯å£ã€‚</p>
</li>
</ul>
<p>è·¯ç”±å™¨ç«¯å£ï¼Œæˆå‘˜ç«¯å£ï¼Œç»„æ’­åœ°å€å’Œvlanç¼–å·æ˜¯äºŒå±‚ç»„æ’­è½¬å‘è¡¨é¡¹çš„åŸºæœ¬ä¿¡æ¯ã€‚</p>
<p>å¦‚æœä½¿ç”¨äº†ç»„æ’­vlanåŠŸèƒ½ï¼Œå…¥vlanä¸ºç»„æ’­vlanï¼Œå‡ºvlanä¸ºä¸»æœºæ‰€åœ¨çš„ç”¨æˆ·vlanã€‚å¦åˆ™å…¥vlanå’Œå‡ºvlanå‡ä¸ºä¸»æœºæ‰€åœ¨çš„vlanã€‚<br>å“ˆï¼Œåé¢åœ¨ENOSä¸­æ·»åŠ ç»„æ’­vlanåŠŸèƒ½ï¼Œè¿™é‡Œå…ˆäº†è§£ä¸€ä¸‹äº†ï¼</p>
<h2 id="IGSPå·¥ä½œæœºåˆ¶"><a href="#IGSPå·¥ä½œæœºåˆ¶" class="headerlink" title="IGSPå·¥ä½œæœºåˆ¶"></a>IGSPå·¥ä½œæœºåˆ¶</h2><p>è¿™é‡Œè¯´æ˜IGSPå¯¹ä¸åŒåè®®æŠ¥æ–‡çš„å¤„ç†ã€‚</p>
<ul>
<li><p>IGMPæ™®éç»„æŸ¥è¯¢æŠ¥æ–‡<br>IGMP querierå®šæœŸå‘æœ¬åœ°ç½‘æ®µå†…çš„æ‰€æœ‰ä¸»æœºä¸è·¯ç”±å™¨ï¼ˆç›®çš„åœ°å€ä¸º224.0.0.1ï¼‰å‘é€IGMPæ™®éç»„æŸ¥è¯¢æŠ¥æ–‡ï¼Œä»¥æŸ¥è¯¢è¯¥ç½‘æ®µæœ‰å“ªäº›ç»„æ’­ç»„æˆå‘˜ã€‚å¤„ç†æ–¹å¼ï¼š</p>
<ul>
<li>å‘VLANå†…é™¤æ¥æ”¶æ¥å£æ„å¤–çš„å…¶å®ƒæ‰€æœ‰æ¥å£è½¬å‘ï¼Œå¹¶å¯¹æ¥æ”¶æ¥å£åšå¦‚ä¸‹å¤„ç†ï¼š<ul>
<li>å¦‚æœè·¯ç”±å™¨ç«¯å£åˆ—è¡¨ä¸­å°šæœªåŒ…å«è¯¥æ¥å£ï¼Œåˆ™å°†å…¶æ·»åŠ è¿›å»ï¼Œå¹¶å¯åŠ¨è€åŒ–å®šæ—¶å™¨</li>
<li>å¦‚æœè·¯ç”±å™¨ç«¯å£åˆ—è¡¨ä¸­å·²åŒ…å«è¯¥åŠ¨æ€è·¯ç”±å™¨ç«¯å£ï¼Œåˆ™é‡ç½®è€åŒ–å®šæ—¶å™¨</li>
</ul>
</li>
</ul>
</li>
<li><p>IGMPæˆå‘˜æŠ¥å‘ŠæŠ¥æ–‡<br>ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>æˆå‘˜æ”¶åˆ°IGMPæ™®éç»„æŸ¥è¯¢æŠ¥æ–‡åï¼Œå›åº”IGMPæŠ¥å‘ŠæŠ¥æ–‡</li>
<li>æˆå‘˜ä¸»åŠ¨å‘IGMPæŸ¥è¯¢å™¨å‘é€IGMPæŠ¥å‘ŠæŠ¥æ–‡ä»¥å£°æ˜åŠ å…¥è¯¥ç»„æ’­ç»„<br>å¤„ç†æ–¹å¼ï¼š<br>å‘vlanå†…æ‰€æœ‰çš„è·¯ç”±å™¨ç«¯å£è½¬å‘ã€‚ï¼ˆæ³¨æ„ï¼Œå…¶å®ƒä¸»æœºä¸ä¼šæ”¶åˆ°IGMPæˆå‘˜æŠ¥å‘ŠæŠ¥æ–‡ï¼Œéœ€è¦åœ¨äºŒå±‚ç»„æ’­è®¾å¤‡ä¸Šä½¿èƒ½report suppresæŠ‘åˆ¶reportå’ŒleaveæŠ¥æ–‡ã€‚ï¼‰ä»æŠ¥æ–‡ä¸­è§£æå‡ºä¸»æœºè¦åŠ å…¥çš„ç»„æ’­ç»„åœ°å€ï¼Œå¹¶å¯¹æ¥æ”¶æ¥å£åšå¦‚ä¸‹å¤„ç†ï¼š<ul>
<li>å¦‚æœä¸å­˜åœ¨è¯¥ç»„å¯¹åº”çš„è½¬å‘è¡¨é¡¹ï¼Œåˆ™åˆ›å»ºè½¬å‘è¡¨ï¼Œå°†è¯¥æ¥å£ä½œä¸ºæˆå‘˜ç«¯å£æ·»åŠ åˆ°å‡ºæ¥å£åˆ—è¡¨ä¸­ï¼Œå¹¶å¯åŠ¨è€åŒ–å®šæ—¶å™¨ã€‚</li>
<li>å¦‚æœå·²å­˜åœ¨è¯¥ç»„å¯¹åº”çš„è½¬å‘è¡¨ï¼Œä¸”å‡ºæ¥å£åˆ—è¡¨ä¸­å·²åŒ…å«è¯¥åŠ¨æ€æˆå‘˜ç«¯å£ï¼Œåˆ™é‡ç½®å…¶è€åŒ–å®šæ—¶å™¨ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>IGMPæˆå‘˜ç¦»å¼€æŠ¥æ–‡<br>ä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>è¿è¡ŒIGMPv2æˆ–IGMPv3çš„æˆå‘˜å‘é€IGMP leaveæŠ¥æ–‡ï¼Œé€šçŸ¥IGMPæŸ¥è¯¢å™¨è‡ªå·±ç¦»å¼€æŸä¸ªç»„æ’­ç»„</li>
<li>IGMPæŸ¥è¯¢å™¨å‘è¯¥ç»„æ’­ç»„å‘é€ç‰¹å®šç»„æŸ¥è¯¢æŠ¥æ–‡<br>å¤„ç†æ–¹å¼ï¼š<br>åˆ¤æ–­ç¦»å¼€çš„ç»„æ˜¯å¦å­˜åœ¨å¯¹åº”çš„è½¬å‘è¡¨è±¡ï¼Œä»¥åŠè½¬å‘è¡¨è±¡å‡ºæ¥å£åˆ—è¡¨æ˜¯å¦åŒ…å«æŠ¥æ–‡çš„æ¥æ”¶æ¥å£ï¼š</li>
<li>å¦‚æœä¸å­˜åœ¨è¯¥ç»„å¯¹åº”çš„è½¬å‘è¡¨è±¡ï¼Œæˆ–è€…è¯¥ç»„å¯¹åº”è½¬å‘è¡¨é¡¹çš„å‡ºæ¥å£åˆ—è¡¨ä¸­ä¸åŒ…å«æ¥æ”¶æ¥å£ï¼ŒäºŒå±‚ç»„æ’­è®¾å¤‡ä¸è½¬å‘è¯¥æŠ¥æ–‡ï¼Œç›´æ¥ä¸¢å¼ƒã€‚</li>
<li>å¦‚æœå­˜åœ¨å¯¹åº”çš„è½¬å‘è¡¨é¡¹å¹¶ä¸”è¡¨é¡¹åŒ…å«è¯¥æ¥å£ï¼Œå‘vlanå†…çš„æ‰€æœ‰è·¯ç”±å™¨ç«¯å£è½¬å‘ã€‚</li>
</ul>
</li>
</ul>
<p>å¯¹äºIGMPç¦»å¼€æŠ¥æ–‡çš„æ¥æ”¶æ¥å£ï¼ŒäºŒå±‚ç»„æ’­è®¾å¤‡åœ¨å…¶è€åŒ–æ—¶é—´å†…ï¼š<br>    * å¦‚æœä»è¯¥æ¥å£æ”¶åˆ°äº†ä¸»æœºå“åº”IGMPç‰¹å®šç»„æŸ¥è¯¢æŠ¥æ–‡çš„æŠ¥å‘ŠæŠ¥æ–‡ï¼Œè¡¨ç¤ºæ¥å£ä¸‹è¿˜æœ‰è¯¥ç»„æˆå‘˜ï¼Œé‡ç½®è€åŒ–æ—¶é—´ã€‚<br>    * å¦‚æœæ²¡æœ‰æ”¶åˆ°ï¼Œåˆ™åœ¨è€åŒ–è¶…æ—¶åï¼Œå°†æ¥å£ä»è¯¥ç»„çš„è½¬å‘è¡¨é¡¹å‡ºæ¥å£åˆ—è¡¨ä¸­åˆ é™¤ã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://support.huawei.com/enterprise/zh/doc/EDOC1000141440/cabd652a">åä¸ºIGSPé…ç½®</a><br><a href="https://blog.51cto.com/lifulin/2073218">ç»„æ’­IGMP Snoopingç†è®ºçŸ¥è¯†è¯¦è§£</a></p>
]]></content>
      <tags>
        <tag>é€šä¿¡åè®®</tag>
        <tag>igmp snooping</tag>
      </tags>
  </entry>
  <entry>
    <title>ip_sla</title>
    <url>/2022/07/14/ip-sla/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>IP sla(service level agreement)æœåŠ¡ç­‰çº§åè®®ï¼Œå¯ä»¥å®æ—¶çš„æ”¶é›†ipç½‘ç»œçš„å„ç§ä¿¡æ¯ï¼ŒåŒ…æ‹¬latencyã€jitterã€packet lossï¼Œè¿é€šæ€§ç­‰ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»slaåœ¨connectivityä¸Šçš„åº”ç”¨ã€‚åœ¨è¿é€šæ€§æ£€æŸ¥ä¸Šï¼Œå¯ä»¥è¯´æ˜¯BFDçš„å‡çº§ç‰ˆï¼ŒBFDåªèƒ½æ£€æµ‹åŒä¸€ç½‘æ®µå†…çš„é“¾è·¯è”é€šè¡Œï¼Œslaåˆ™å¯ä»¥è·¨ç½‘æ®µã€‚IP-SLAæ˜¯æ€ç§‘ç§æœ‰åè®®ï¼Œåä¸ºNQAä¸ä¹‹å¯¹æ ‡ã€‚</p>
<span id="more"></span>

<h1 id="slaå®éªŒ"><a href="#slaå®éªŒ" class="headerlink" title="slaå®éªŒ"></a>slaå®éªŒ</h1><p>IP slaå¯ä»¥ç”¨æ¥å’Œtrackè”åŠ¨ç›‘æ§æŸä¸ªipæ˜¯å¦å¯è¾¾ã€‚å®éªŒæ‹“æ‰‘å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/sla_topology.png"><br>æ‹“æ‰‘è¯´æ˜å¦‚ä¸‹ï¼š<br>S1ä½œä¸ºæ¥å…¥å±‚äº¤æ¢æœºï¼Œvpcåœ¨vlan10ä¸­ï¼ŒS2ï¼ŒS3ä½œä¸ºæ±‡èšå±‚äº¤æ¢æœºï¼Œè·‘vrrpæé«˜ç½‘å…³å¯é æ€§ï¼Œå…¶ä¸­S2åœ¨vlan10ä¸­æ—¢æ˜¯stpçš„æ ¹æ¡¥ä¹Ÿæ˜¯vrrpçš„masterï¼Œè¿™æ ·å¯ä»¥æé«˜é“¾è·¯çš„åˆ©ç”¨ç‡ã€‚åŒç†ï¼Œå¦‚æœå¢åŠ vlan20,å¯å°†æ ¹æ¡¥å’Œvrrpçš„è§’è‰²ç»™S3. R4ä¸Šè·‘NATåšåœ°å€è½¬æ¢ã€‚S2ä¸Šé€šè¿‡slaç›‘æ§R4ä¸Šloopback0çš„å¯è¾¾æ€§ï¼ŒR7, R4, S2,S3,S5ä¹‹é—´è·‘ospfï¼Œæœ€ç»ˆå®ç°vpcä¸R7çš„äº’é€šã€‚å½“S2çš„ä¸Šè¡Œé“¾è·¯ä¸å¯è¾¾æ—¶ï¼ŒS3æˆä¸ºvrrpçš„masteræ¥ç®¡vpcçš„æµé‡ã€‚</p>
<h2 id="é…ç½®è¯´æ˜"><a href="#é…ç½®è¯´æ˜" class="headerlink" title="é…ç½®è¯´æ˜"></a>é…ç½®è¯´æ˜</h2><p>æœ¬å®éªŒçš„é…ç½®åˆ†ä¸ºå‡ å—è¿›è¡Œï¼Œåˆ†åˆ«æ˜¯åŸºç¡€é…ç½®(vlan,stp,ip,routing)ï¼Œvrrpé…ç½®ï¼ŒNATé…ç½®ï¼Œslaé…ç½®(sla,track,vrrp)ã€‚</p>
<p>åŸºç¡€é…ç½®(vlan,stp,ip,routing)å¦‚ä¸‹ï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">vpc</a></li><li class="tab"><a href="#tab-2">S1</a></li><li class="tab"><a href="#tab-3">S2</a></li><li class="tab"><a href="#tab-4">S3</a></li><li class="tab"><a href="#tab-5">R4</a></li><li class="tab"><a href="#tab-6">R5</a></li><li class="tab"><a href="#tab-7">R7</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip 192.168.1.10&#x2F;24 192.168.1.1</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> switchport access vlan 10</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;2</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-3"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> no switchport</span><br><span class="line"> ip address 24.1.1.2 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;2</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Vlan10</span><br><span class="line"> ip address 192.168.1.2 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">router ospf 110</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-4"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback3</span><br><span class="line"> ip address 3.3.3.3 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">ï¼</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> no switchport</span><br><span class="line"> ip address 35.1.1.3 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;2</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Vlan10</span><br><span class="line"> ip address 192.168.1.3 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">router ospf 110</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-5"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback0</span><br><span class="line"> ip address 4.4.4.4 255.255.255.255</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 24.1.1.4 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line"> duplex auto</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 47.1.1.4 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line"> duplex auto</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-6"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback0</span><br><span class="line"> ip address 5.5.5.5 255.255.255.255</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 35.1.1.5 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line"> duplex auto</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 57.1.1.5 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line"> duplex auto</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-7"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback0</span><br><span class="line"> ip address 7.7.7.7 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 47.1.1.7 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line"> duplex auto</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 57.1.1.7 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line"> duplex auto</span><br></pre></td></tr></table></figure></div></div></div>

<p>åŸºç¡€é…ç½®å¾ˆç®€å•ï¼Œå°±æ˜¯vlanï¼Œipï¼Œospfçš„åŸºæœ¬é…ç½®ã€‚æ¥ä¸‹æ¥åœ¨S2ã€S3ä¸Šé¢é…ç½®vrrpã€‚</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">S2</a></li><li class="tab"><a href="#tab-2">S3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Vlan10</span><br><span class="line"> vrrp 1 ip 192.168.1.1          &#x2F;&#x2F; åˆ›å»ºvrrpï¼Œè™šæ‹Ÿç½‘å…³ipä¸º192ã€‚168.1.1</span><br><span class="line"> vrrp 1 priority 150            &#x2F;&#x2F; å¢åŠ s2çš„vrrpä¼˜å…ˆçº§ï¼Œä½¿å…¶æˆä¸ºmaster</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Vlan10</span><br><span class="line"> vrrp 1 ip 192.168.1.1          &#x2F;&#x2F; S3ä¸Šé¢é…ç½®vrrpï¼Œä½¿å…¶æˆä¸ºbackup</span><br></pre></td></tr></table></figure></div></div></div>
<p>æŸ¥çœ‹vrrpçš„åŸºæœ¬ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2#show vrrp brief </span><br><span class="line">Interface          Grp Pri Time  Own Pre State   Master addr     Group addr</span><br><span class="line">Vl10               1   150 3414       Y  Master  192.168.1.2     192.168.1.1    </span><br><span class="line"></span><br><span class="line">åœ¨vpcä¸Šæµ‹è¯•ç½‘å…³æ˜¯å¦å¯è¾¾ï¼š</span><br><span class="line">VPCS&gt; ping 192.168.1.1 -c 1</span><br><span class="line">84 bytes from 192.168.1.1 icmp_seq&#x3D;1 ttl&#x3D;255 time&#x3D;0.435 ms</span><br></pre></td></tr></table></figure>

<p>NATé…ç½®å¦‚ä¸‹ï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„naté…ç½®ï¼Œå¤ç”¨å‡ºç«¯å£ipã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip access-list standard NAT</span><br><span class="line"> permit 192.168.1.0 0.0.0.255          &#x2F;&#x2F; åˆ›å»ºaclï¼ŒåŒ¹é…192.168.1.0ç½‘æ®µçš„ip</span><br><span class="line"></span><br><span class="line">ip nat inside source list NAT interface Ethernet0&#x2F;1 overload &#x2F;&#x2F;åˆ›å»ºnatï¼Œè½¬æ¢sourceï¼ŒåŒ¹é…NATçš„aclï¼Œå¤ç”¨eth0&#x2F;0çš„IPåœ°å€</span><br><span class="line"></span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip nat inside              &#x2F;&#x2F; ç¡®å®šsourceï¼Œdest</span><br><span class="line"></span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip nat outside              &#x2F;&#x2F; ç¡®å®šsourceï¼Œdest</span><br></pre></td></tr></table></figure>
<p>R5ä¸Šçš„NATé…ç½®å’ŒR4ä¸€æ¨¡ä¸€æ ·ï¼Œå®Œæˆä¹‹åvpcå°±å¯ä»¥pingé€š<code>7.7.7.7</code>äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPCS&gt; ping 7.7.7.7 -c 1</span><br><span class="line">84 bytes from 7.7.7.7 icmp_seq&#x3D;1 ttl&#x3D;253 time&#x3D;1.043 ms</span><br><span class="line"></span><br><span class="line">åœ¨R4ä¸ŠæŸ¥çœ‹NATè½¬æ¢ï¼š</span><br><span class="line">R4#show ip nat translations </span><br><span class="line">Pro Inside global      Inside local       Outside local      Outside global</span><br><span class="line">icmp 47.1.1.4:36346    192.168.1.10:36346 7.7.7.7:36346      7.7.7.7:36346</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ä¸€åˆ‡éƒ½è¿˜é¡ºåˆ©ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å°†R4å…³æœºåï¼Œä¼šå‘ç°vpc pingä¸é€š7.7.7.7ï¼Œè¿™æ˜¯å› ä¸ºS2ï¼ŒS3æ— æ³•æ„ŸçŸ¥ä¸Šæ¸¸é“¾è·¯çš„æ•…éšœï¼Œæ‰€ä»¥ä¾ç„¶è®¤ä¸ºS2æ˜¯vrrp masterï¼Œospfçš„æ”¶æ•›æ—¶é—´æ¯”è¾ƒä¹…ï¼Œæ‰€ä»¥S2ä¸Šåˆ°7.7.7.7çš„ä¸‹ä¸€è·³ä¾ç„¶æ˜¯eth0/1ï¼Œè‡ªç„¶ä¸é€šã€‚æˆ‘ä»¬åˆ›å»ºslaæ¥æ„ŸçŸ¥ä¸Šæ¸¸é“¾è·¯æ•…éšœï¼Œåˆ†åˆ«åœ¨S2ã€S3ä¸Šé…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; åˆ›å»ºsla</span><br><span class="line">ip sla 1                                        &#x2F;&#x2F; åˆ›å»ºsla 1</span><br><span class="line"> icmp-echo 4.4.4.4 source-ip 2.2.2.2            &#x2F;&#x2F; slaçš„ç›‘æ§äº‹é¡¹æ˜¯ï¼šæº2.2.2.2ä¸dest4.4.4.4çš„è”é€šæ€§</span><br><span class="line"> frequency 5                                    &#x2F;&#x2F; è¯„ç‡æ˜¯5ç§’ä¸€æ¬¡</span><br><span class="line">ip sla schedule 1 life forever start-time now   &#x2F;&#x2F; sla 1çš„æ—¶é—´è¡¨ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œç”Ÿå‘½å‘¨æœŸä¸ºæ°¸è¿œ</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; slaä¸trackçš„è”åŠ¨</span><br><span class="line">track 1 ip sla 1                                &#x2F;&#x2F; trackç›‘æ§slaçš„ç»“æœ</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; trackä¸vrrpçš„è”åŠ¨</span><br><span class="line">interface Vlan10</span><br><span class="line"> vrrp 1 track 1 decrement 60                    &#x2F;&#x2F; å¦‚æœtrackå¤±è´¥ï¼Œvrrpä¼˜å…ˆçº§é™ä½60</span><br></pre></td></tr></table></figure>
<p>S3ä¸Šé•œåƒS2çš„slaé…ç½®ï¼ŒæŸ¥çœ‹slaçš„çŠ¶æ€ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2#show ip sla summary | begin ID       </span><br><span class="line">ID           Type        Destination       Stats       Return      Last</span><br><span class="line">                                           (ms)        Code        Run </span><br><span class="line">-----------------------------------------------------------------------</span><br><span class="line">*1           icmp-echo   4.4.4.4           RTT&#x3D;1       OK          1 second ago</span><br><span class="line"></span><br><span class="line">S2#show track 1 </span><br><span class="line">Track 1</span><br><span class="line">  IP SLA 1 state</span><br><span class="line">  State is Up</span><br><span class="line">    7 changes, last change 00:08:26</span><br><span class="line">  Latest operation return code: OK</span><br><span class="line">  Latest RTT (millisecs) 1</span><br><span class="line">  Tracked by:</span><br><span class="line">    VRRP Vlan10 1</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°†R4å…³æœºï¼ŒæŸ¥çœ‹slaçš„çŠ¶æ€ä¿¡æ¯ä»¥åŠvrrpçš„çŠ¶æ€ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2#show ip sla summary | begin ID  </span><br><span class="line">ID           Type        Destination       Stats       Return      Last</span><br><span class="line">                                           (ms)        Code        Run </span><br><span class="line">-----------------------------------------------------------------------</span><br><span class="line">*1           icmp-echo   4.4.4.4           -           Timeout     12 seconds ag</span><br><span class="line"></span><br><span class="line">S2#show vrrp brief </span><br><span class="line">Interface          Grp Pri Time  Own Pre State   Master addr     Group addr</span><br><span class="line">Vl10               1   90  3414       Y  Backup  192.168.1.3     192.168.1.1    </span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°S2çš„ä¼˜å…ˆçº§ç°åœ¨æ˜¯90ï¼ŒS3æ˜¯masteräº†ã€‚track interfaceå¯ä»¥å®ç°ç±»ä¼¼çš„æ•ˆæœï¼Œä½†å½“R4çš„eth1 downæ‰ä¹‹åï¼ŒS2å’ŒR4ä¹‹é—´ç«¯å£éƒ½æ˜¯upï¼Œæ— æ³•æ£€æµ‹å‡ºæ•…éšœï¼Œslaç›´æ¥æ£€æµ‹ipçš„è”é€šæ€§é€‚ç”¨æ€§æ›´å¹¿ï¼Œæˆ‘ä»¬è®¾ç½®å¯ä»¥åœ¨s2ä¸Šç›´æ¥æ£€æµ‹åˆ°7.7.7.7çš„è¿é€šæ€§ã€‚</p>
<p>å°†R4å¼€æœºåï¼ŒS2é‡æ–°æˆä¸ºvrrp master, æ•…éšœæ¢å¤ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>ipv6å•ç‚¹åŒå‘é‡åˆ†å¸ƒ</title>
    <url>/2022/07/22/ipv6%E5%8D%95%E7%82%B9%E5%8F%8C%E5%90%91%E9%87%8D%E5%88%86%E5%B8%83/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>ç®€å•ä»‹ç»ä¸‹ipv6å•ç‚¹åŒå‘é‡åˆ†å¸ƒçš„é…ç½®ç»†èŠ‚ï¼Œcisco IOSä¸­æŸäº›ç»†èŠ‚ä¸ipv4å®ç°æœ‰ä¸€äº›å·®å¼‚ã€‚</p>
<span id="more"></span>

<h1 id="å®éªŒé…ç½®"><a href="#å®éªŒé…ç½®" class="headerlink" title="å®éªŒé…ç½®"></a>å®éªŒé…ç½®</h1><p>å®éªŒæ‹“æ‰‘å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/ipv6_redistribute_topology.png"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼ŒR1-R2ä¹‹é—´è·‘ospfv3ï¼ŒR2-R3ä¹‹é—´è·‘eigrpã€‚åœ¨R2ä¸Šåšå•ç‚¹åŒå‘é‡åˆ†å¸ƒï¼Œæ˜¯R1-R3ä¸Šçš„lp0æ¥å£èƒ½ç›¸äº’pingé€šã€‚</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">R1</a></li><li class="tab"><a href="#tab-2">R2</a></li><li class="tab"><a href="#tab-3">R3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipv6 unicast-routing                    &#x2F;&#x2F; å…¨å±€å¼€å¯ipv6è·¯ç”±åŠŸèƒ½</span><br><span class="line">ï¼</span><br><span class="line">interface Loopback0</span><br><span class="line"> no ip address</span><br><span class="line"> ipv6 address 1111::1111&#x2F;128                &#x2F;&#x2F; é…ç½®lp0 ipv6åœ°å€</span><br><span class="line"> ospfv3 110 ipv6 area 0                     &#x2F;&#x2F; å°†æ¥å£åŠ å…¥ospfv3è®¡ç®—</span><br><span class="line">ï¼</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> no ip address</span><br><span class="line"> duplex auto</span><br><span class="line"> ipv6 address 2001::1&#x2F;64</span><br><span class="line"> ospfv3 110 ipv6 area 0</span><br><span class="line">ï¼</span><br><span class="line">router ospfv3 110                   &#x2F;&#x2F; åˆ›å»ºospfv3è¿›ç¨‹</span><br><span class="line"> !</span><br><span class="line"> address-family ipv6 unicast        &#x2F;&#x2F; æŒ‡åä½¿ç”¨ipv6åœ°å€æ—</span><br><span class="line">  router-id 1.1.1.1                 &#x2F;&#x2F; è®¾ç½®router idï¼Œ ç›¸è¾ƒäºospfv2è€Œè¨€ï¼Œæ²¡æœ‰è¿™ä¸¤é¡¹é…ç½®</span><br><span class="line"> exit-address-family</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipv6 unicast-routing</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> no ip address</span><br><span class="line"> duplex auto</span><br><span class="line"> ipv6 address 2001::2&#x2F;64</span><br><span class="line"> ospfv3 110 ipv6 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> no ip address</span><br><span class="line"> duplex auto</span><br><span class="line"> ipv6 address 2002::2&#x2F;64</span><br><span class="line">!</span><br><span class="line">router eigrp rancho                         &#x2F;&#x2F; å‘½åæ¨¡å¼eigrpï¼Œæ”¯æŒipv4&amp;ipv6ä¸¤ç§åœ°å€æ—</span><br><span class="line"> !</span><br><span class="line"> address-family ipv6 unicast autonomous-system 1        &#x2F;&#x2F; æŒ‡å®šipv6åœ°å€æ—ï¼Œé»˜è®¤ä¼šå°†æ‰€æœ‰ipv6æ¥å£åŠ å…¥eigrpè®¡ç®—</span><br><span class="line">  !</span><br><span class="line">  topology base                                         &#x2F;&#x2F; eigrp ipv6é‡å®šå‘éœ€è¦åˆ°æ‹“æ‰‘åº“ä¸­è¿›è¡Œ                     </span><br><span class="line">   redistribute ospf 110 metric 10000 10 255 1 1500 include-connected       &#x2F;&#x2F; å°†ospf 110ä¸­çš„è·¯ç”±é‡å®šå‘åˆ°eigrpä¸­ï¼Œé»˜è®¤ä¸åŒ…å«ç›´æ¥è·¯ç”±ï¼Œéœ€è¦æ·»åŠ include-connectedå­å‘½ä»¤</span><br><span class="line">  exit-af-topology</span><br><span class="line">  eigrp router-id 2.2.2.2                               &#x2F;&#x2F; æŒ‡å®šrouter id</span><br><span class="line"> exit-address-family</span><br><span class="line">!</span><br><span class="line">router ospfv3 110</span><br><span class="line"> !</span><br><span class="line"> address-family ipv6 unicast                &#x2F;&#x2F; æŒ‡å®šipv6åœ°å€æ—</span><br><span class="line">  redistribute eigrp 1 include-connected       &#x2F;&#x2F; åŒæ ·é»˜è®¤ä¸åŒ…å«ç›´æ¥è·¯ç”±ï¼Œéœ€è¦æ·»åŠ å­å‘½ä»¤</span><br><span class="line">  router-id 2.2.2.2</span><br><span class="line"> exit-address-family</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-3"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipv6 unicast-routing</span><br><span class="line">!</span><br><span class="line">interface Loopback0</span><br><span class="line"> no ip address</span><br><span class="line"> ipv6 address 3333::3333&#x2F;128</span><br><span class="line">!</span><br><span class="line">interface Loopback1</span><br><span class="line"> no ip address</span><br><span class="line"> ipv6 address 4444::4444&#x2F;128</span><br><span class="line"> !</span><br><span class="line"> interface Ethernet0&#x2F;0</span><br><span class="line"> no ip address</span><br><span class="line"> duplex auto</span><br><span class="line"> ipv6 address 2002::3&#x2F;64</span><br><span class="line">!</span><br><span class="line">router eigrp rancho</span><br><span class="line"> !</span><br><span class="line"> address-family ipv6 unicast autonomous-system 1</span><br><span class="line">  !</span><br><span class="line">  af-interface default                      &#x2F;&#x2F; eigrpé»˜è®¤å°†æ‰€æœ‰ipv6æ¥å£åŠ å…¥eigrpè®¡ç®—</span><br><span class="line">   shutdown                                 &#x2F;&#x2F; å°†æ‰€æœ‰æ¥å£ç§»é™¤eigrp</span><br><span class="line">  exit-af-interface</span><br><span class="line">  !</span><br><span class="line">  af-interface Loopback0</span><br><span class="line">   no shutdown                              &#x2F;&#x2F; æŒ‡å®šçš„ç«¯å£åŠ å…¥eigrp</span><br><span class="line">  exit-af-interface</span><br><span class="line">  !</span><br><span class="line">  af-interface Ethernet0&#x2F;0</span><br><span class="line">   no shutdown                               &#x2F;&#x2F; æŒ‡å®šçš„ç«¯å£åŠ å…¥eigrp, è¿™æ ·lp1å°±æ²¡æœ‰åŠ å…¥eigrpï¼ŒR1ä¸Šå°±æ²¡æœ‰å¯¹åº”çš„è·¯ç”±</span><br><span class="line">  exit-af-interface</span><br><span class="line">  !</span><br><span class="line">  topology base</span><br><span class="line">  exit-af-topology</span><br><span class="line">  eigrp router-id 3.3.3.3</span><br><span class="line"> exit-address-family</span><br></pre></td></tr></table></figure></div></div></div>

<p>æŸ¥çœ‹R1ä¸Šçš„ipv6è·¯ç”±è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ipv6 route | begin 3333  </span><br><span class="line">OE2 3333::3333&#x2F;128 [110&#x2F;20]</span><br><span class="line">     via FE80::A8BB:CCFF:FE00:2000, Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>
<p>åœ¨R1ä¸Šping R3çš„lp0:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#ping 3333::3333 source 1111::1111</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 3333::3333, timeout is 2 seconds:</span><br><span class="line">Packet sent with a source address of 1111::1111</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5&#x2F;5), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;1&#x2F;1 ms</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸¤ç‚¹æ¯”è¾ƒå…³é”®ï¼š</p>
<ul>
<li>ipv6åŠ¨æ€è·¯ç”±åè®®é‡åˆ†å¸ƒæ—¶ï¼Œciscoä½“ç³»ä¸­æ²¡æœ‰æŠŠç›´è¿è·¯ç”±åŒ…æ‹¬è¿›å»ï¼Œéœ€è¦ç”¨å­å‘½ä»¤æŒ‡å</li>
<li>eigrpé»˜è®¤å°†æ‰€æœ‰ipv6æ¥å£åŠ å…¥eigrpè®¡ç®—ï¼Œå¦‚æœåªæƒ³æŠŠæŒ‡å®šç«¯å£åŠ è¿›å»ï¼Œéœ€è¦åšé¢å¤–çš„æ“ä½œ</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>kernelç¼–è¯‘ç®€è¿°</title>
    <url>/2020/03/11/kernel%E7%BC%96%E8%AF%91%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨ENOSç³»ç»Ÿç§»æ¤çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹äºLinux kernelï¼Œæ¶‰åŠåˆ°kernelçš„é…ç½®ï¼Œç¼–è¯‘ï¼Œä»¥åŠäºŒè¿›åˆ¶é•œåƒuImageçš„ç”Ÿæˆã€‚è¿™ç¯‡æ–‡ç« åˆ†ä¸ºä¸¤å—ï¼š</p>
<span id="more"></span>
<ol>
<li>å†…æ ¸é…ç½®ç³»ç»Ÿæµ…æ</li>
<li>vmlinux,uImage,Imageçš„å…³ç³»æˆ–åŒºåˆ«</li>
</ol>
<h1 id="å†…æ ¸é…ç½®ç³»ç»Ÿæµ…æ"><a href="#å†…æ ¸é…ç½®ç³»ç»Ÿæµ…æ" class="headerlink" title="å†…æ ¸é…ç½®ç³»ç»Ÿæµ…æ"></a>å†…æ ¸é…ç½®ç³»ç»Ÿæµ…æ</h1><p>Linuxé‡‡ç”¨æ¨¡å—åŒ–çš„å†…æ ¸é…ç½®ç³»ç»Ÿï¼Œä¿è¯äº†å†…æ ¸çš„å¯æ‰©å±•æ€§ã€‚Linuxå†…æ ¸çš„é…ç½®ç³»ç»Ÿç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>Makefileï¼šåˆ†éƒ¨åœ¨Linuxå†…æ ¸æºç ä¸­çš„Makefileï¼Œå®šä¹‰Linuxå†…æ ¸çš„ç¼–è¯‘è§„åˆ™</li>
<li>é…ç½®æ–‡ä»¶ï¼ˆ.config, Kconfigç­‰ï¼‰</li>
<li>é…ç½®å·¥å…·<ol>
<li>é…ç½®å‘½ä»¤è§£é‡Šå™¨ï¼Œå¯¹é…ç½®è„šæœ¬ä¸­ä½¿ç”¨çš„é…ç½®å‘½ä»¤è¿›è¡Œè§£é‡Š</li>
<li>é…ç½®ç”¨æˆ·ç•Œé¢ï¼Œåˆ†ä¸ºåŸºäºå­—ç¬¦ï¼ˆmake configï¼‰,åŸºäºNcurseså›¾å½¢ç•Œé¢ï¼ˆmake menuconfigï¼‰ï¼ŒåŸºäºXwindowså›¾å½¢ç•Œé¢ï¼ˆmake xconfigï¼‰</li>
</ol>
</li>
</ol>
<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><p>Makefileçš„ä½œç”¨æ˜¯æ ¹æ®é…ç½®çš„æƒ…å†µï¼Œæ„é€ å‡ºéœ€è¦ç¼–è¯‘çš„æºæ–‡ä»¶åˆ—è¡¨ï¼Œç„¶ååˆ†åˆ«ç¼–è¯‘ï¼Œå¹¶æŠŠç›®æ ‡ä»£ç é“¾æ¥åˆ°ä¸€èµ·ï¼Œæœ€ç»ˆå½¢æˆLinuxå†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ã€‚kernelä¸­Makefileç›¸å…³çš„æ–‡ä»¶æœ‰ï¼š</p>
<ol>
<li>é¡¶å±‚Makefileï¼Œæ˜¯æ•´ä¸ªå†…æ ¸é…ç½®ã€ç¼–è¯‘çš„æ€»ä½“æ§åˆ¶æ–‡ä»¶ï¼Œäº§ç”Ÿvmlinuxæ–‡ä»¶å’Œå†…æ ¸æ¨¡å—ï¼ˆmoduleï¼‰</li>
<li>.configï¼šå†…æ ¸é…ç½®æ–‡ä»¶ï¼Œæ˜¯æ‰§è¡Œå®Œå†…æ ¸é…ç½®çš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®škernelæ ¹ç›®å½•ä¸‹æ²¡æœ‰.configï¼Œå¯ä»¥åœ¨makeæ—¶æŒ‡å®šç‰¹å®šçš„é…ç½®æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œä¹‹åä¹Ÿä¼šåœ¨æ ¹ç›®å½•ä¸‹äº§ç”Ÿ.config</li>
<li>arch/*/Makefileï¼šä¸åŒCPUä½“ç³»çš„Makefileï¼Œç³»ç»Ÿç§»æ¤éœ€è¦å¤šå…³æ³¨ä¸€äº›è¿™éƒ¨åˆ†</li>
<li>å„å­ç›®å½•ä¸‹çš„Makefileï¼Œå¦‚driversä¸‹çš„ï¼Œè´Ÿè´£æ‰€åœ¨å­ç›®å½•ä¸‹æºä»£ç çš„ç®¡ç†</li>
<li>Rules.makeï¼šè§„åˆ™æ–‡ä»¶ï¼Œè¢«æ‰€æœ‰çš„Makefileä½¿ç”¨</li>
</ol>
<p>ç”¨æˆ·é€šè¿‡make configåï¼Œè¿™é‡Œå®é™…å°±æ˜¯æ”¶é›†å„ç›®å½•ä¸‹çš„Kconfig/deconfigæ–‡ä»¶ç”Ÿæˆé…ç½®ç•Œé¢ï¼Œä¾›ç”¨æˆ·è¿›è¡ŒåŠŸèƒ½é€‰æ‹©ï¼Œæœ€åäº§ç”Ÿ<code>.config</code>ï¼Œå¦‚æœ.configæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™æ˜¯ç›´æ¥é€šè¿‡.configç”Ÿæˆé…ç½®ç•Œé¢ã€‚é¡¶å±‚Makefileè¯»å…¥.configä¸­çš„é…ç½®é€‰æ‹©è¿›è¡Œå…·ä½“æ¨¡å—çš„ç¼–è¯‘ã€‚é¡¶å±‚Makefielä¸­ä¼šåŒ…å«å…·ä½“archçš„Makefile<br><img src="https://rancho333.github.io/pictures/arch.png"><br>Rules.makeå…¶å®å°±æ˜¯ä¸åŒæ¨¡å—ä¹‹é—´ä¼šå…±ç”¨åˆ°çš„Makefileè§„åˆ™ã€‚</p>
<p>åœ¨ENOSä¸­ï¼Œç³»ç»Ÿæ¶æ„äººå‘˜å°†ç”Ÿæˆå¥½çš„ARCHçš„configæ–‡ä»¶å­˜æ”¾ARCHçš„ç›®å½•ä¸‹ï¼Œä¸Šå±‚å¼€å‘äººå‘˜ç¼–è¯‘æ—¶ç›´æ¥ä½¿ç”¨æŒ‡å®šçš„configæ–‡ä»¶ç¼–è¯‘å³å¯ã€‚<br><img src="https://rancho333.github.io/pictures/config.png"><br>ä¹‹ååœ¨æŒ‡å®šçš„<code>O</code>ç›®å½•ä¸‹ä¼šç”Ÿæˆç¼–è¯‘è¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥é¿å…æ±¡æŸ“æºç ï¼ˆmake cleanä¸èƒ½æ¸…é™¤ä¹ˆï¼‰ï¼Œæˆ–è€…æ˜¯æ›´ä¾¿äºç®¡ç†å’Œæ¨¡å—åŒ–è€ƒè™‘ã€‚<br>å¦‚æœéœ€è¦è¿›è¡Œkernelçš„äºŒæ¬¡é…ç½®ï¼Œéœ€è¦åˆ°<code>O</code>ç›®å½•ä¸‹å»æ‰§è¡Œmake menuconfigï¼Œä¹‹åå°†é‡æ–°ç”Ÿæˆçš„<code>.config</code>æ‹·å›<code>ARCH</code>ç›®å½•è¦†ç›–ä¹‹å‰çš„é…ç½®æ–‡ä»¶ã€‚è¿™æ˜¯åŸºäºARCHç¼ºçœé…ç½®çš„ä¸€ç§åº”ç”¨ï¼Œåœ¨å‘å†…æ ¸ä»£ç å¢åŠ äº†æ–°çš„åŠŸèƒ½åï¼Œå¦‚æœæ–°åŠŸèƒ½å¯¹äºè¿™ä¸ªARCHæ˜¯å¿…éœ€çš„ï¼Œå°±éœ€è¦ä¿®æ”¹æ­¤ARCHçš„ç¼ºçœé…ç½®ï¼Œä¿®æ”¹æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¤‡ä»½.configæ–‡ä»¶</li>
<li>cp arch/arm/deconfig .config</li>
<li>ä¿®æ”¹.config</li>
<li>cp .config arch/arm/deconfig</li>
<li>æ¢å¤.config</li>
</ol>
<h3 id="é…ç½®å˜é‡CONFIG"><a href="#é…ç½®å˜é‡CONFIG" class="headerlink" title="é…ç½®å˜é‡CONFIG_*"></a>é…ç½®å˜é‡CONFIG_*</h3><p>.configæ–‡ä»¶ä¸­ç”¨é…ç½®å˜é‡ç­‰å¼æ¥è¯´æ˜ç”¨æˆ·çš„é…ç½®ç»“æœï¼Œç­‰å¼å·¦è¾¹æ˜¯æ¨¡å—/åŠŸèƒ½,å³ä¾§æ˜¯æ§åˆ¶é€‰é¡¹ï¼Œæœ‰ä¸‰ç§ï¼š</p>
<ol>
<li><code>y</code>è¡¨ç¤ºåæœ¬ç¼–è¯‘é€‰é¡¹å¯¹ç”¨çš„å†…æ ¸ä»£ç è¢«é™æ€ç¼–è¯‘è¿›Linuxå†…æ ¸</li>
<li><code>m</code> è¡¨ç¤ºæœ¬ç¼–è¯‘é€‰é¡¹å¯¹åº”çš„å†…æ ¸ä»£ç è¢«ç¼–è¯‘æˆæ¨¡å—</li>
<li><code>n</code>è¡¨ç¤ºä¸é€‰æ‹©æ­¤ç¼–è¯‘é€‰é¡¹<br>å¦‚æœæ ¹æœ¬æ²¡æœ‰é€‰æ‹©æŸæ¨¡å—ï¼Œè¯¥æ¨¡å—æ˜¯è¢«æ³¨é‡Šæ‰çš„</li>
</ol>
<h1 id="vmlinux-uImage-Imageçš„å…³ç³»æˆ–åŒºåˆ«"><a href="#vmlinux-uImage-Imageçš„å…³ç³»æˆ–åŒºåˆ«" class="headerlink" title="vmlinux,uImage,Imageçš„å…³ç³»æˆ–åŒºåˆ«"></a>vmlinux,uImage,Imageçš„å…³ç³»æˆ–åŒºåˆ«</h1><p>Linuxå†…æ ¸æœ‰å¤šç§æ ¼å¼çš„é•œåƒï¼ŒåŒ…æ‹¬vmlinuxã€Imageã€zImageã€bzImageã€uImageã€xipImageã€bootpImageç­‰ã€‚<br>vmlinuxæ˜¯ç¼–è¯‘å‡ºæ¥çš„æœ€åŸå§‹çš„å†…æ ¸æ–‡ä»¶ï¼Œæœªç»å‹ç¼©ï¼Œvmä»£è¡¨virtual memory Linuxæ”¯æŒè™šæ‹Ÿå†…å­˜ï¼›<br>Imageæ˜¯ç»è¿‡objcopyå¤„ç†çš„åªåŒ…å«äºŒè¿›åˆ¶æ•°æ®çš„å†…æ ¸ä»£ç ï¼Œæœªç»å‹ç¼©ï¼Œä¸æ˜¯elfæ ¼å¼ï¼›objcopyçš„å®è´¨æ˜¯å°†æ‰€æœ‰çš„ç¬¦å·å’Œ é‡å®šä½ä¿¡æ¯éƒ½æŠ›å¼ƒï¼Œåªå‰©ä¸‹äºŒè¿›åˆ¶æ•°æ®ã€‚<br>zImageæ˜¯vmlinuxåŠ ä¸Šè§£å‹ä»£ç ç»gzipå‹ç¼©è€Œæˆï¼Œæ˜¯ARM linuxå¸¸ç”¨çš„ä¸€ç§å‹ç¼©é•œåƒæ–‡ä»¶ã€‚è¿™ç§æ ¼å¼çš„Linuxé•œåƒå¤šå­˜æ”¾åœ¨NANDä¸Šã€‚bzImageä¸ä¹‹ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯é‡‡ç”¨äº†å‹ç¼©ç‡æ›´é«˜çš„ç®—æ³•ã€‚<br>uImageæ˜¯ubootä¸“ç”¨çš„é•œåƒæ–‡ä»¶ï¼Œå®ƒæ˜¯åœ¨zImageä¹‹å‰åŠ ä¸Šä¸€ä¸ªé•¿åº¦ä¸º0x40çš„tagï¼Œé‡Œé¢åŒ…å«äº†é•œåƒæ–‡ä»¶çš„ç±»å‹ã€åŠ è½½ä½ç½®ã€ç”Ÿæˆæ—¶é—´ã€å¤§å°ç­‰ä¿¡æ¯ã€‚é€šè¿‡mkimageå‘½ä»¤å¯ä»¥åˆ¶ä½œuImageã€‚<br>xipImageå¤šæ”¾åœ¨NorFlashä¸Šç›´æ¥è¿è¡Œã€‚<br>è¿™é‡Œåªæ˜¯ä¸€äº›ç®€å•çš„æè¿°ï¼Œæœ‰å¾…åœ¨ä»Šåçš„é¡¹ç›®ä¸­å»åŠ æ·±ç†è§£å„ç§æ ¼å¼çš„ä½¿ç”¨ï¼Œå­˜åœ¨è‚¯å®šæ˜¯æœ‰å…¶å¯¹åº”çš„ä½¿ç”¨åœºæ™¯çš„ï¼<br><img src="https://rancho333.github.io/pictures/vmlinux.png"></p>
<h1 id="å¯¹äºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç‚¹ç†è§£"><a href="#å¯¹äºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç‚¹ç†è§£" class="headerlink" title="å¯¹äºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç‚¹ç†è§£"></a>å¯¹äºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç‚¹ç†è§£</h1><p>åŠ åœ¨è¿™é‡Œå¯èƒ½ä¸æ˜¯å¾ˆç¬¦åˆè¿™ç¯‡æ–‡ç« çš„ä¸»é¢˜ï¼<br>Linuxä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ã€‚Linuxç³»ç»Ÿä¸­ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼šæŒ‚è½½ç‚¹å’Œæ–‡ä»¶ç³»ç»Ÿã€‚rootfsä¹‹æ‰€ä»¥å­˜åœ¨ï¼Œæ˜¯å› ä¸ºéœ€è¦åœ¨VFSæœºåˆ¶ä¸‹ç»™ç³»ç»Ÿæä¾›æœ€åŸå§‹çš„æŒ‚è½½ç‚¹ã€‚<br>rootfså…¶å®å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿé¡¶å±‚çš„<code>/</code>ï¼Œä½¿ç”¨pwdå‘½ä»¤åçœ‹åˆ°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå®ƒæœ‰ä¸‰ä¸ªç‰¹ç‚¹ï¼š</p>
<ol>
<li>å®ƒæ˜¯ç³»ç»Ÿè‡ªå·±åˆ›å»ºå¹¶åŠ è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯Linuxå†…æ ¸è‡ªå·±åˆ›å»ºçš„ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å¤–éƒ¨æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå°†å¤–éƒ¨æ ¹æ–‡ä»¶ç³»ç»Ÿè§£å‹æˆ–è€…è¯´æŒ‚è½½åˆ°<code>/</code>åå°±æ˜¯ç”¨æˆ·èƒ½çœ‹åˆ°çš„Linuxæ–‡ä»¶ç³»ç»Ÿï¼Œé‡Œé¢æœ‰å¾ˆå¤šçš„æ–‡ä»¶å¤¹ï¼Œå¦‚â€™etcâ€™ã€â€™binâ€™ç­‰ã€‚<em>ä¸èƒ½è¢«unmountæˆ–è€…åˆ é™¤</em>ï¼Œé€šè¿‡<code>cat /proc/mounts</code>ä¹Ÿå¯ä»¥çœ‹å‡ºã€‚ä¸‹è¿°çš„rootfsç‰¹æŒ‡<code>/</code></li>
<li>è¯¥æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹å°±æ˜¯å®ƒè‡ªå·±çš„æ ¹ç›®å½•é¡¹å¯¹è±¡</li>
<li>è¯¥æ–‡ä»¶ç³»ç»Ÿä»…ä»…å­˜åœ¨äºå†…å­˜ä¸­<br>VFSæ˜¯Linuxæ–‡ä»¶ç³»ç»Ÿå®ç°éµå¾ªçš„ä¸€ç§æœºåˆ¶ï¼Œrootfsæ˜¯ä¸€ç§æ˜¯ä¸€ç§å…·ä½“å®ç°çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒLinuxä¸‹æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„å®ç°éƒ½å¿…é¡»ç¬¦åˆVFSæœºåˆ¶ï¼ˆç¬¦åˆVFSçš„æ¥å£ï¼‰ï¼Œè¿™æ˜¯äºŒè€…çš„çœŸæ­£å…³ç³»ã€‚</li>
</ol>
<p>Linuxç³»ç»Ÿç§»æ¤è¿‡ç¨‹æœ‰ä¸€é¡¹æ˜¯åˆ¶ä½œæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™é‡Œæ‰€è°“çš„æ ¹æ–‡ä»¶ç³»ç»Ÿå®é™…ä¸Šæ˜¯å¤–éƒ¨æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æ¥é‡Šæ”¾åˆ°rootfsé‡Œé¢ã€‚æœ‰å‡ ä¸ªæ¦‚å¿µ<code>ramfs initramfs</code>ï¼Œramfsæ˜¯linuxä¸­çš„ä¸€ä¸ªå†…å­˜æ–‡ä»¶ç³»ç»Ÿ,initramfsæ˜¯ä¸€ç§å‹ç¼©ï¼ˆå¯ä»¥æ˜¯lzmaï¼Œzipç­‰ï¼Œçœ‹kernelçš„æ”¯æŒæƒ…å†µï¼‰çš„cpioæ ¼å¼çš„å½’æ¡£æ–‡ä»¶ï¼Œinitrdï¼ˆinitramdiskï¼‰ä¹Ÿæ˜¯ä¸€ä¸­ramfsé•œåƒæ–‡ä»¶ï¼Œå®ƒæ˜¯ç”¨æ¥åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åˆå§‹åŒ–ç³»ç»Ÿçš„ï¼Œå®ƒå¯ä»¥è¢«å¸è½½ã€‚åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®ƒå¿…é¡»æ˜¯å’Œkernelåˆ†ç¦»çš„ä¸€ç§å½¢å¼å­˜åœ¨</li>
<li>ä»–åªæ˜¯ä¸€ä¸ªzipå‹ç¼©çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸æ˜¯cpioæ–‡ä»¶</li>
<li>initrdä¸­çš„/initrdç¨‹åºåªæ˜¯åšä¸€äº›setupæ“ä½œå¹¶æœ€åè¿”å›åˆ°kernelä¸­æ‰§è¡Œï¼Œè€Œinitramfsä¸­çš„/initæ‰§è¡Œå®Œåä¸è¿”å›åˆ°kernel</li>
</ol>
<p>å¯¹äºinitramfsï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿç§»æ¤æ—¶éœ€è¦åˆ¶ä½œçš„æ–‡ä»¶ç³»ç»Ÿã€‚å®ƒå­˜åœ¨äºä¸¤å¤„ï¼Œä¸€ç§æ˜¯å†…æ ¸ç¼–è¯‘åè‡ªåŠ¨ç”Ÿæˆçš„å†…éƒ¨initramfs(åœ¨/usrç›®å½•ä¸‹)ï¼Œå¦ä¸€ç§æ˜¯ç”¨æˆ·è‡ªå·±åˆ¶ä½œçš„ï¼Œé€šè¿‡cmdlineå°†åœ°å€ä¼ é€’ç»™kernelçš„å¤–éƒ¨initramfs<br>å¯¹äºå†…éƒ¨initramfsï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿé‡Œé¢å®é™…ä¸Šå•¥ä¹Ÿæ²¡æœ‰ï¼š<br><img src="https://rancho333.github.io/pictures/initramfs_kernel.png"><br>rootfsæŒ‚è½½ä¹‹åï¼Œé¦–å…ˆä¼šå…ˆé‡Šæ”¾è¿™ä¸ªå†…éƒ¨çš„initramfsåˆ°rootfsï¼ˆå¾ˆæ˜¾ç„¶å•¥ä¹Ÿå¹²ä¸äº†ï¼<em>æ²¡ææ¸…æ¥šä¸ºä»€ä¹ˆä¼šå­˜åœ¨ï¼Œä½†è‚¯å®šæœ‰åŸå› ï¼</em>ï¼‰,ç„¶åkernelä¼šå°è¯•åœ¨rootfsä¸­å¯»æ‰¾/initï¼Œä¸€æ—¦æ‰¾åˆ°å°±æ‰§è¡Œinitï¼Œkernelä¹Ÿå°±å®Œæˆäº†å¯åŠ¨å·¥ä½œï¼Œä¹‹åinitå°±ä¼šæ¥ç®¡æ¥ä¸‹æ¥çš„å·¥ä½œã€‚å¦‚æœkernelæ‰¾ä¸åˆ°ï¼Œå°±ä¼šå»æ‰¾å¤–éƒ¨initramfsç„¶åé‡Šæ”¾ï¼ˆubootä¸‹é€šè¿‡initrdå‚æ•°æŒ‡å®šä½ç½®ï¼‰æˆ–è€…æŒ‰ç…§æ ‡å‡†åšæ³•è§£æå‚æ•°<code>root=</code>ï¼ˆè¿™é‡Œé¢æ˜¯è§£å‹å¥½åˆ°æŸä¸ªä»‹è´¨åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œè¯•å›¾æ‰¾åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¹¶æŒ‚è½½åˆ°rootfsï¼Œä¹‹åå°±initã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å®é™…ä½¿ç”¨çš„è‚¯å®šæ˜¯å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿäº†ï¼Œå¯¹äºå¤–éƒ¨çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹æ³•å°†å®ƒæŒ‚è½½åˆ°rootfsã€‚</p>
<ol>
<li>åˆ¶ä½œä¸€ä¸ªç‹¬ç«‹çš„cpio.lzmaåŒ…ï¼Œç„¶åå‘Šè¯‰bootloaderå®ƒçš„åœ°å€ï¼Œé€šè¿‡cmdlineå°†å‚æ•°ä¼ é€’ç»™kernel</li>
<li>åˆ¶ä½œä¸€ä¸ªç‹¬ç«‹çš„åŒ…ï¼Œé€šè¿‡mkimge(åªé’ˆå¯¹äºuboot)å°†kernel+initramfs+dtbæ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨ubootä¸‹å¯åŠ¨ï¼ˆå®éªŒè¿‡å¯è¡Œï¼‰</li>
<li>ç”¨å¤–éƒ¨çš„initramfsæ›¿æ¢kernelè‡ªåŠ¨ç”Ÿæˆçš„initramfsï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š<ol>
<li>å…ˆç¼–è¯‘kernelï¼Œè®©å®ƒç”Ÿæˆå†…éƒ¨intramfsï¼Œç„¶ååˆ¶ä½œå¤–éƒ¨initramfsï¼Œæ‹·è´æ›¿æ¢æ‰ï¼Œæœ€åé‡æ–°ç¼–è¯‘å†…æ ¸ã€‚å¤–éƒ¨initramfså°±ä¼šå’Œkernelç¼–æˆä¸€ä¸ªæ–‡ä»¶ã€‚ENOSé‡Œé¢ä½¿ç”¨çš„æ˜¯è¿™ç§æ–¹æ³•ã€‚</li>
<li>ä½¿ç”¨å†…æ ¸ç¼–è¯‘é€‰é¡¹CONFIG_INITRAMFS_SOURCEæŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œå³kernelä¼šæ ¹æ®ç»™å®šçš„æ–‡ä»¶ç”Ÿæˆå†…éƒ¨initramfsï¼Œè¿™é‡Œé¢åˆæœ‰é›†ä¸­ä¸åŒçš„ç»™å®šæ–¹å¼ï¼Œè¿™é‡Œä¸è¡¨ã€‚<br><img src="https://rancho333.github.io/pictures/kernel_initramfs.png"><br>å¤–éƒ¨initramfsæ›¿æ¢å†…éƒ¨initramfsä¹‹åï¼Œkernelä¼šåœ¨ç¬¬ä¸€æ—¶é—´æ‰¾åˆ°/init,æ‰€ä»¥<code>root=ï¼Œinitrd=</code>è¿™äº›å‚æ•°éƒ½ä¸ä¼šèµ·ä½œç”¨äº†ã€‚</li>
</ol>
</li>
</ol>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://www.ibm.com/developerworks/cn/linux/kernel/l-kerconf/">Linuxå†…æ ¸é…ç½®ç³»ç»Ÿæµ…æ</a><br><a href="https://blog.csdn.net/ultraman_hs/article/details/52838989">zImageå’ŒuImageçš„åŒºåˆ«è”ç³»</a><br><a href="https://blog.csdn.net/rikeyone/article/details/52048972">ramfs,rootfs,initramfs,initrd</a><br><a href="https://blog.csdn.net/sunjing_/article/details/53081306">initramfsçš„ä½¿ç”¨æ–¹æ³•</a></p>
]]></content>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>labè€ƒè¯•åŸºæœ¬ä»‹ç»åŠè€ƒé¢˜åˆ†æ</title>
    <url>/2025/06/19/lab%E8%80%83%E8%AF%95%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%E5%8F%8A%E8%80%83%E9%A2%98%E5%88%86%E6%9E%901.2/</url>
    <content><![CDATA[<h1 id="labåŸºæœ¬ä»‹ç»"><a href="#labåŸºæœ¬ä»‹ç»" class="headerlink" title="labåŸºæœ¬ä»‹ç»"></a>labåŸºæœ¬ä»‹ç»</h1><p>EI CCIE labè€ƒè¯•æ€»å…±åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯designï¼Œå…¨éƒ¨æ˜¯ç¬”è¯•ï¼Œå…±è®¡39é¢˜(ç¬¬ä¸€é¢˜ä»‹ç»ï¼Œæœ€åä¸€é¢˜say goodby)ï¼Œ3å°æ—¶å†…å®Œæˆï¼›ç¬¬äºŒéƒ¨åˆ†æ˜¯DOO(deployï¼Œoperateï¼Œoptimize)ï¼Œå…±è®¡5å°æ—¶ã€‚designåšå®Œå¯ä»¥æå‰äº¤å·ï¼Œ3å°æ—¶ä¸­å‰©ä¸‹çš„æ—¶é—´åˆ™ç›´æ¥ä½œåºŸï¼Œä¸ä¼šåŠ ç»™DOOä½¿ç”¨ã€‚DOOå°±æ˜¯labå®æ“äº†ï¼Œä¸»è¦åˆ†ä¸ºä¸‰å—ï¼Œä¸€æ˜¯ä¼ ç»Ÿç½‘ç»œï¼ŒäºŒæ˜¯SDNç½‘ç»œï¼Œä¸‰æ˜¯è‡ªåŠ¨åŒ–ã€‚ä¼ ç»Ÿç½‘ç»œå…±è®¡16ä¸ªå°é¢˜ï¼ŒSDNç½‘ç»œå…±è®¡6ä¸ªå°é¢˜ï¼Œè‡ªåŠ¨åŒ–å…±è®¡ä¸‰ä¸ªå°é¢˜ï¼Œæ¯ä¸ªéƒ¨åˆ†ä¸­éƒ½æœ‰ä¸€ä¸ªé€‰æ‹©é¢˜ã€‚</p>
<span id="more"></span>

<p>è¿™ä¸ªç³»åˆ—çš„blogä¸»è¦ç”¨æ¥å¯¹å½“å‰ç‰ˆæœ¬labçš„ç½‘ç»œåšä¸€ä¸ªåŸºæœ¬åˆ†æï¼Œæ³¨æ„åœ¨2023å¹´9æœˆä¹‹ålabä¼šæ”¹ç‰ˆã€‚</p>
<h1 id="lab-æ‹“æ‰‘å…¨æ™¯"><a href="#lab-æ‹“æ‰‘å…¨æ™¯" class="headerlink" title="lab æ‹“æ‰‘å…¨æ™¯"></a>lab æ‹“æ‰‘å…¨æ™¯</h1><p>æ•´ä¸ªlabçš„æ‰€æœ‰è®¾å¤‡åŠè¿æ¥å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://rancho333.github.io/pictures/lab1.1_topology.drawio.png"></p>
<p>è¿™ä¸ªå›¾å®é™…ä¸Šè¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼Œæ€»å…±ç”±10ä¸ªsitesç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>HQ(head quarter)ï¼šä¸»è¦è·‘ospf, eigrp v6ï¼Œbgpç­‰ï¼Œè™½ç„¶r12å’ŒISPäº’è”ï¼Œä½†æ˜¯é»˜è®¤ä»DCè®¿é—®äº’è”ç½‘</li>
<li>DC(data center)ï¼šæ•´ä¸ªç½‘ç»œçš„ä¸­å¿ƒï¼Œè·‘ospf, dmvpnï¼Œeigrpç­‰ï¼ŒDHCP server, DMVPN hub, viptelaï¼ŒDNAcéƒ½éƒ¨ç½²åœ¨é‡Œé¢</li>
<li>IaaS(Infrastructure as a service) ä¸»è¦ç”¨æ¥åšè‡ªåŠ¨åŒ–ï¼Œä»¥åŠpingé€šR30çš„ipv6 loopback</li>
<li>ISP(Internet service provider) æä¾›8.8.8.8ï¼Œå¹¶ä¸”ä¼šé€šè¿‡BGPä¸‹å‘é»˜è®¤è·¯ç”±</li>
<li>SP1(service provider 1) ä¸»è¦è·‘mpls,bgpï¼Œèµ·åˆ°è¿æ¥å„ä¸ªsitesçš„ä½œç”¨</li>
<li>SP2 åŒSP1ï¼Œä¸Šé¢åªè·‘BGP</li>
<li>Branch1 åˆ†æ”¯1ï¼Œè·‘SDNï¼Œviptelaçš„overlayæ˜¯DNAcçš„underlayï¼Œviptelaåœ¨vedgeä¹‹é—´æ„å»ºå¥½vpné€šé“ï¼ŒDNAcåŸºäºæ­¤å¯¹ç‰©ç†äº¤æ¢æœºè¿›è¡Œçº³ç®¡ï¼Œæ³¨æ„SW400æ˜¯border/edgeä¸¤ç§è§’è‰²ä¸€ä½“</li>
<li>Branch2 åˆ†æ”¯2ï¼Œè·‘SDNï¼Œå¤§éƒ¨åˆ†åŒbranch1, sw501å’Œsw502æ˜¯borderè§’è‰²ï¼Œsw510æ˜¯edge</li>
<li>Branch3 åˆ†æ”¯3ï¼Œè·‘DMVPNï¼Œä½œä¸ºspoken</li>
<li>Branch4 åˆ†æ”¯4ï¼Œè·‘DMVPNï¼Œä½œä¸ºspoken</li>
</ul>
<p>æœ€ç»ˆçš„ç›®çš„å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨L2ï¼ŒL3ï¼ŒSDNç­‰ç½‘ç»œæŠ€æœ¯ä½¿æ‰€æœ‰ä¸»æœºéƒ½è·å–åˆ°ipåœ°å€ï¼Œå¹¶èƒ½è®¿é—®ISPä¸­çš„8.8.8.8(google DNSæœåŠ¡å™¨)ï¼Œå½“ç„¶ï¼ŒHQ,DC,IaaSï¼Œbranch1,branch2,branch3,branch4ä¹‹é—´ä¹Ÿæ˜¯äº’è”äº’é€šçš„ï¼Œå³è¿™äº›sitesä¸­çš„ä¸»æœºéƒ½å¯ä»¥pingé€šçš„ï¼Œguest vpné™¤å¤–ã€‚</p>
<h2 id="ä¼ ç»Ÿ1-2"><a href="#ä¼ ç»Ÿ1-2" class="headerlink" title="ä¼ ç»Ÿ1.2"></a>ä¼ ç»Ÿ1.2</h2><p>1.1æ˜¯introductionï¼Œç›´æ¥passäº†ã€‚ä¸‹é¢æ˜¯1.2çš„é¢˜ç›®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">layer 2 technologies in HQ</span><br><span class="line"></span><br><span class="line">Complete and correct the etherchannel configuration between switches sw101,sw102,sw110 according to these requirementsï¼š</span><br><span class="line">1. At the end of the taskï¼Œall ethernetchannels between switches sw101, sw102 must be up and operational including all their physical member links</span><br><span class="line">2. Do not create new port-channel interfaces; reuse that already exist on the switches</span><br><span class="line">3. When resolving existing issuesï¼Œdo not change the preconfigured negotiation protocolï¼ˆif anyï¼‰</span><br><span class="line">4. On ethernetchannel that use a negotiation protocolï¼Œtune its mode of operation for the shortest link bunding time possible</span><br><span class="line"></span><br><span class="line">Configure VTP version 3 on these switches as follows:</span><br><span class="line">1. VTP domain must be set to CCIE</span><br><span class="line">2. VTP password must be cc1E@fab</span><br><span class="line">3. When displayed, the VTP password must be shown as 32-character hexadecimal string</span><br><span class="line">4. sw101 must be configured as VTP server for the MST feature</span><br><span class="line">5. sw102 &amp; sw110 must be configured as VTP client for the MST feature</span><br><span class="line"></span><br><span class="line">These switches must run MST and maintain 3 instances including the default instance 0 as followsï¼š</span><br><span class="line">1. Associate vlans 1001-2000 in instance 1</span><br><span class="line">2. Associate vlans 2001-4094 in instance 2</span><br><span class="line">3. sw101 must be root for the default instance 0 and instance 1</span><br><span class="line">4. sw102 must be root for instance 2</span><br></pre></td></tr></table></figure>

<p>1.2çš„æ‹“æ‰‘ç¤ºæ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/lab_1.2.png"></p>
<p>ç»“æ„å¾ˆç®€å•ï¼Œæ¶‰åŠåˆ°ä¸‰å°è®¾å¤‡ï¼šsw101,sw102,sw110ï¼Œä¸‰å°äº¤æ¢æœºä¹‹é—´é€šè¿‡portchannelè¿æ¥ï¼Œå…¶ä¸­sw101å’Œsw110ä¹‹é—´èµ°staicï¼Œå…¶å®ƒä¸¤æ¡èµ°LACPã€‚é…ç½®æ€è·¯å¦‚ä¸‹</p>
<ul>
<li>ä¿®å¤portchannelé…ç½®ï¼Œæ‰“é€šäºŒå±‚è¿æ¥</li>
<li>é…ç½®VTPï¼Œå…¶ä¸­sw101ä½œä¸ºVTP server, å¦å¤–ä¸¤å°ä½œä¸ºvtp client</li>
<li>é…ç½®mstï¼Œå…¶ä¸­sw101ä½œä¸ºinstance 0-1çš„æ ¹ï¼Œsw102ä½œä¸ºinstance 2çš„æ ¹</li>
</ul>
<p>ä¸‹é¢æ˜¯å®é™…é…ç½®ï¼š</p>
<ol>
<li>ä¿®å¤portchannelé…ç½®<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sw101ï¼š</span><br><span class="line">int range gi 1&#x2F;2-3</span><br><span class="line">    channel-group 1 mode on</span><br><span class="line">sw102:</span><br><span class="line">int range gi 1&#x2F;2-3</span><br><span class="line">    channel-group 2 mode active</span><br><span class="line">sw110:</span><br><span class="line">int range gi 1&#x2F;2-3</span><br><span class="line">    channel-group 2 mode active</span><br><span class="line">int port-channel 1</span><br><span class="line">    shutdown</span><br><span class="line">    no shutdown             &#x2F;&#x2F; po1æ˜¯é™æ€lagï¼Œå¯¹ç«¯ä¿®æ”¹é…ç½®åï¼Œæœ¬åœ°down&#x2F;upä½¿å…¶è·å–æœ€æ–°çŠ¶æ€</span><br></pre></td></tr></table></figure>
é…ç½®å®Œæˆä¹‹åï¼Œæ£€æŸ¥pcç«¯å£çŠ¶æ€, pcå…¨éƒ¨éƒ½æ˜¯<code>SU</code>çŠ¶æ€ï¼Œç‰©ç†æˆå‘˜ç«¯å£å…¨éƒ¨éƒ½æ˜¯<code>P</code>çŠ¶æ€ï¼Œå­—æ¯å«ä¹‰åœ¨showä¸­æœ‰è¯´æ˜ã€‚</li>
</ol>
<p>sw101 pcç«¯å£çŠ¶æ€</p>
<p>sw102 pcç«¯å£çŠ¶æ€</p>
<p>ä¸‰è§’æ‹“æ‰‘æ£€æŸ¥ä¸¤å°è®¾å¤‡å³å¯ç¡®è®¤æ‰€æœ‰pcç«¯å£çŠ¶æ€</p>
<ol start="2">
<li>é…ç½®VTP<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sw101:</span><br><span class="line">vtp domain CCIE</span><br><span class="line">vtp version 3</span><br><span class="line">vtp password cc1E@fab hidden</span><br><span class="line">vtp mode server MST</span><br><span class="line">vtp primary mst force           &#x2F;&#x2F; ç‰¹æƒæ¨¡å¼ä¸‹å¼ºåˆ¶æŒ‡å®šmst primary server, éœ€è¦è¾“å¯†ç </span><br><span class="line"></span><br><span class="line">sw102&#x2F;sw110:</span><br><span class="line">vtp domain CCIE</span><br><span class="line">vtp version 3</span><br><span class="line">vtp password cc1E@fab hidden</span><br><span class="line">vtp mode client MST                 &#x2F;&#x2F; æ³¨æ„sw102å’Œsw110çš„vtpå·¥ä½œåœ¨clientæ¨¡å¼ </span><br></pre></td></tr></table></figure>
é…ç½®å®Œæˆä¹‹åæ£€æŸ¥vtpçŠ¶æ€ï¼š</li>
</ol>
<p>sw101çš„vtpçŠ¶æ€å¦‚ä¸‹ï¼š</p>
<p>å¯†ç æ˜¯hiddenæ‰€ä»¥çœ‹ä¸åˆ°æ˜æ–‡ï¼š</p>
<p>sw102çš„vtpçŠ¶æ€å¦‚ä¸‹ï¼š</p>
<ol start="3">
<li>é…ç½®mst<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sw101ï¼š </span><br><span class="line">spanning-tree mode mst              æŒ‡å®šspanning treeæ¨¡å¼ä¸ºmst</span><br><span class="line">spanning-tree mst configuration</span><br><span class="line">    name CCIE</span><br><span class="line">    revision 1</span><br><span class="line">    instance 1 vlan 1001-2000</span><br><span class="line">    instance 2 vlan 2001-4094       &#x2F;&#x2F; mstçš„å…·ä½“é…ç½®åªéœ€è¦åœ¨sw101ä¸Šé…ç½®ï¼Œä¹‹åä¼šé€šè¿‡vtpåŒæ­¥ç»™sw102å’Œsw110</span><br><span class="line">spanning-tree mst 0-1 root primary      &#x2F;&#x2F; æŒ‡å®šsw101æ˜¯instance 0-1çš„æ ¹</span><br><span class="line"></span><br><span class="line">sw102ï¼š</span><br><span class="line">spanning-tree mode mst              </span><br><span class="line">spanning-tree mst 2 root primary        &#x2F;&#x2F; æŒ‡å®šsw102æ˜¯instance 2çš„æ ¹</span><br><span class="line"></span><br><span class="line">sw103:</span><br><span class="line">spaaning-tree mode mst</span><br></pre></td></tr></table></figure>
é…ç½®å®Œæˆä¹‹åæ£€æŸ¥mstçŠ¶æ€ï¼Œsw101ä½œä¸ºinstance 0-1æ ¹æ¡¥ï¼Œsw102ä½œä¸ºinstance 2çš„æ ¹æ¡¥<br>sw101 sptçŠ¶æ€</li>
</ol>
<p>sw102 sptçŠ¶æ€</p>
<p>tips: sw102å’Œsw110çš„VTPé…ç½®ç›¸åŒï¼Œspté…ç½®åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯sw102å¤šä¸€ä¸ªinstance 2çš„æ ¹æ¡¥é…ç½®ã€‚å¤åˆ¶ç²˜è´´é…ç½®å³å¯ã€‚</p>
<p>åé¢çš„blogä¼šæŒ‰é¡ºåºé€é¢˜è¿›è¡Œåˆ†æã€‚</p>
]]></content>
      <tags>
        <tag>CCIE</tag>
      </tags>
  </entry>
  <entry>
    <title>mplså­¦ä¹ </title>
    <url>/2021/02/09/mpls%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="MPLSç®€ä»‹"><a href="#MPLSç®€ä»‹" class="headerlink" title="MPLSç®€ä»‹"></a>MPLSç®€ä»‹</h1><p>MPLS(multiprotocol label switchingï¼Œå¤šåè®®æ ‡ç­¾äº¤æ¢)èµ·æºäºIPv4ï¼Œæœ€åˆæ˜¯ä¸ºäº†æé«˜è½¬å‘é€Ÿåº¦è€Œæå‡ºçš„ï¼ˆæ—©æœŸè·¯ç”±æ˜¯åªèƒ½ç”±è½¯ä»¶å¤„ç†çš„ï¼‰ï¼Œå…¶æ ¸å¿ƒæŠ€æœ¯å¯æ‰©å±•åˆ°å¤šç§ç½‘ç»œåè®®ï¼ŒåŒ…æ‹¬IPv6ï¼ŒIPX(internet packet exchangeï¼Œç½‘é™…æŠ¥æ–‡äº¤æ¢)å’ŒCLNP(connectionless network protocol,æ— è¿æ¥ç½‘ç»œåè®®)ç­‰ã€‚MPLSä¸­çš„<em>M</em>æŒ‡çš„å°±æ˜¯æ”¯æŒå¤šç§ç½‘ç»œåè®®ã€‚</p>
<span id="more"></span>
<h1 id="æ¦‚å¿µè¯´æ˜"><a href="#æ¦‚å¿µè¯´æ˜" class="headerlink" title="æ¦‚å¿µè¯´æ˜"></a>æ¦‚å¿µè¯´æ˜</h1><h2 id="è½¬å‘ç­‰ä»·ç±»"><a href="#è½¬å‘ç­‰ä»·ç±»" class="headerlink" title="è½¬å‘ç­‰ä»·ç±»"></a>è½¬å‘ç­‰ä»·ç±»</h2><p>MPLSä½œä¸ºä¸€ç§åˆ†ç±»è½¬å‘æŠ€æœ¯ï¼Œå°†å…·æœ‰ç›¸åŒè½¬å‘å¤„ç†æ–¹å¼çš„åˆ†ç»„å½’ä½ä¸€ç±»ï¼Œç§°ä¸ºFEC(forwarding equivalence classï¼Œè½¬å‘ç­‰ä»·ç±»)ã€‚ç›¸åŒFECçš„åˆ†ç»„åœ¨MPLSä¸­å°†è·å¾—å®Œå…¨ç›¸åŒçš„å¤„ç†ã€‚<br>FECçš„åˆ’åˆ†æ–¹å¼éå¸¸çµæ´»ï¼Œå¯ä»¥æ˜¯æºåœ°å€ã€ç›®çš„åœ°å€ã€æºç«¯å£ã€ç›®çš„ç«¯å£ã€åè®®ç±»å‹æˆ–VPNç­‰ä¸ºåˆ’åˆ†ä¾æ®çš„ä»»æ„ç»„åˆã€‚ä¾‹å¦‚ï¼Œåœ¨ä¼ ç»Ÿçš„é‡‡ç”¨æœ€é•¿åŒ¹é…ç®—æ³•çš„IPè½¬å‘ä¸­ï¼Œåˆ°åŒä¸€ä¸ªç›®çš„åœ°å€çš„æ‰€æœ‰æŠ¥æ–‡å°±æ˜¯ä¸€ä¸ªFECã€‚</p>
<h2 id="æ ‡ç­¾"><a href="#æ ‡ç­¾" class="headerlink" title="æ ‡ç­¾"></a>æ ‡ç­¾</h2><p>æ ‡ç­¾æ˜¯ä¸€ä¸ªé•¿åº¦å›ºå®šï¼Œä»…å…·æœ‰æœ¬åœ°æ„ä¹‰çš„çŸ­æ ‡è¯†ç¬¦ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªåˆ†ç»„æ‰€å±çš„FECã€‚ä¸€ä¸ªæ ‡ç­¾åªèƒ½ä»£è¡¨ä¸€ä¸ªFECã€‚æ ‡ç­¾é•¿åº¦ä¸º4ä¸ªå­—èŠ‚ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/mpls_packet.png"></p>
<p>å­—æ®µè§£é‡Šå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">å­—æ®µ</th>
<th align="left">è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Label</td>
<td align="left">æ ‡ç­¾å­—æ®µï¼Œé•¿åº¦ä¸º20bitsï¼Œç”¨æ¥æ ‡è¯†ä¸€ä¸ªFEC</td>
</tr>
<tr>
<td align="left">Exp</td>
<td align="left">3bits, ä¿ç•™ï¼Œ åè®®ä¸­æ²¡æœ‰æ˜ç¡®è§„å®šï¼Œ é€šå¸¸ç”¨ä½œCoS</td>
</tr>
<tr>
<td align="left">S</td>
<td align="left">1bit, MPLSæ”¯æŒå¤šé‡æ ‡ç­¾ï¼Œå€¼ä¸º1æ—¶è¡¨ç¤ºä¸ºæœ€åº•å±‚æ ‡ç­¾</td>
</tr>
<tr>
<td align="left">TTL</td>
<td align="left">8bits, å’ŒIPåˆ†ç»„ä¸­çš„TTLæ„ä¹‰ç›¸åŒï¼Œç”¨æ¥é˜²æ­¢ç¯è·¯</td>
</tr>
</tbody></table>
<p>å¦‚æœé“¾è·¯å±‚åè®®å…·æœ‰æ ‡ç­¾åŸŸï¼Œå¦‚ATMçš„VPI/VCI,åˆ™æ ‡ç­¾å°è£…åœ¨è¿™äº›åŸŸä¸­ï¼›å¦åˆ™ï¼Œæ ‡ç­¾å°è£…åœ¨é“¾è·¯å±‚å¤´å’Œç½‘ç»œå±‚æ•°æ®ä¹‹é—´çš„ä¸€ä¸ªå«å±‚ã€‚è¿™æ ·ï¼Œä»»æ„é“¾è·¯å±‚éƒ½èƒ½å¤Ÿæ”¯æŒæ ‡ç­¾ã€‚ä¸‹å›¾æ˜¯æ ‡ç­¾åœ¨åˆ†ç»„ä¸­çš„å°è£…ä½ç½®ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/mpls_packet_location.png"></p>
<h2 id="æ ‡ç­¾äº¤æ¢è·¯ç”±å™¨"><a href="#æ ‡ç­¾äº¤æ¢è·¯ç”±å™¨" class="headerlink" title="æ ‡ç­¾äº¤æ¢è·¯ç”±å™¨"></a>æ ‡ç­¾äº¤æ¢è·¯ç”±å™¨</h2><p>LSR(label switching router,æ ‡ç­¾äº¤æ¢è·¯ç”±å™¨)æ˜¯MPLSç½‘ç»œä¸­çš„åŸºæœ¬å•å…ƒï¼Œæ‰€æœ‰LSRéƒ½æ”¯æŒMPLSæŠ€æœ¯ã€‚</p>
<h2 id="æ ‡ç­¾äº¤æ¢è·¯å¾„"><a href="#æ ‡ç­¾äº¤æ¢è·¯å¾„" class="headerlink" title="æ ‡ç­¾äº¤æ¢è·¯å¾„"></a>æ ‡ç­¾äº¤æ¢è·¯å¾„</h2><p>ä¸€ä¸ªè½¬å‘ç­‰ä»·ç±»åœ¨MPLSç½‘ç»œä¸­ç»è¿‡çš„è·¯å¾„ç§°ä¸ºLSP(label switched pathï¼Œæ ‡ç­¾äº¤æ¢è·¯å¾„)ã€‚åœ¨ä¸€æ¡LSPä¸Šï¼Œæ²¿æ•°æ®ä¼ é€çš„æ–¹å‘ï¼Œç›¸é‚»çš„LSRåˆ†åˆ«ç§°ä¸ºä¸Šæ¸¸LSRå’Œä¸‹æ¸¸LSRã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒR2æ˜¯R1çš„ä¸‹æ¸¸LSRï¼Œç›¸åº”çš„R1æ˜¯R2çš„ä¸Šæœ‰LSRã€‚</p>
<p><img src="https://rancho333.github.io/pictures/mpls_lsr.png"><br>LSPåœ¨åŠŸèƒ½ä¸Šä¸ATMå’Œå¸§ä¸­ç»§(frame relay)çš„è™šç”µè·¯ç›¸åŒï¼Œæ˜¯ä»MPLSç½‘ç»œçš„å…¥å£åˆ°å‡ºå£çš„ä¸€ä¸ªå•å‘è·¯å¾„ï¼ŒLSPä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ç”±LSRç»„æˆã€‚</p>
<h2 id="æ ‡ç­¾åˆ†å‘åè®®"><a href="#æ ‡ç­¾åˆ†å‘åè®®" class="headerlink" title="æ ‡ç­¾åˆ†å‘åè®®"></a>æ ‡ç­¾åˆ†å‘åè®®</h2><p>LDP(label distribution protocolï¼Œæ ‡ç­¾åˆ†å‘åè®®)æ˜¯MPLSçš„æ§åˆ¶åè®®ï¼Œå®ƒç›¸å½“äºä¼ ç»Ÿç½‘ç»œä¸­çš„ä¿¡ä»¤åè®®ï¼Œè´Ÿè´£FECçš„åˆ†ç±»ã€æ ‡ç­¾çš„åˆ†é…ä»¥åŠLSPçš„å»ºç«‹å’Œç»´æŠ¤ç­‰ä¸€ç³»åˆ—æ“ä½œã€‚MPLSå¯ä»¥ä½¿ç”¨å¤šç§æ ‡ç­¾å‘å¸ƒåè®®ï¼ŒåŒ…æ‹¬ä¸“ä¸ºæ ‡ç­¾å‘å¸ƒè€Œåˆ¶å®šçš„åè®®ï¼Œä¾‹å¦‚ï¼šLDPã€CR-LDP(constraint-based routing using LDP,åŸºäºçº¦æŸè·¯ç”±çš„LDP)ï¼›ä¹ŸåŒ…æ‹¬ç°æœ‰åè®®æ‰©å±•åæ”¯æŒæ ‡ç­¾å‘å¸ƒçš„ï¼Œä¾‹å¦‚ï¼šBGPã€RSVP(resource reservation protocolï¼Œèµ„æºé¢„ç•™åè®®)ã€‚åŒæ—¶ï¼Œè¿˜å¯ä»¥æ‰‹å·¥é…ç½®é™æ€LSPã€‚<br>LDPæœ‰ä¸¤ä¸ªé‡è¦çš„ä½œç”¨ï¼š</p>
<ol>
<li>ç»™æœ¬åœ°è·¯ç”±ä¿¡æ¯åˆ†é…æ ‡ç­¾ï¼Œè¿›è¡Œç»‘å®šç”ŸæˆLIBè¡¨</li>
<li>ä¼ é€’LSRä¹‹é—´çš„ç»‘å®šä¿¡æ¯ï¼Œç”ŸæˆLFIBè¡¨</li>
</ol>
<h2 id="LSPéš§é“æŠ€æœ¯"><a href="#LSPéš§é“æŠ€æœ¯" class="headerlink" title="LSPéš§é“æŠ€æœ¯"></a>LSPéš§é“æŠ€æœ¯</h2><p>MPLSæ”¯æŒLSPéš§é“æŠ€æœ¯ã€‚ä¸€æ¡LSPçš„ä¸Šæ¸¸LSRå’Œä¸‹æ¸¸LSRï¼Œå°½ç®¡ä»–ä»¬ä¹‹é—´çš„è·¯å¾„å¯èƒ½å¹¶ä¸åœ¨è·¯ç”±åè®®æ‰€æä¾›çš„è·¯å¾„ä¸Šï¼Œä½†MPLSå…è®¸åœ¨ä»–ä»¬ä¹‹é—´å»ºç«‹ä¸€æ¡æ–°çš„LSPï¼Œè¿™æ ·ï¼Œä¸Šæ¸¸LSRå’Œä¸‹æ¸¸LSRåˆ†åˆ«å°±æ˜¯è¿™æ¡LSPçš„èµ·ç‚¹å’Œç»ˆç‚¹ã€‚è¿™æ—¶ï¼Œä¸Šæ¸¸LSRå’Œä¸‹æ¸¸LSRé—´å°±æ˜¯LSPéš§é“ï¼Œå®ƒé¿å…äº†é‡‡ç”¨ä¼ ç»Ÿçš„ç½‘ç»œå±‚å°è£…éš§é“ã€‚å¦‚ä¸Šå›¾ä¸­LSP <code>R2-&gt;R21-&gt;R22-&gt;R3</code>å°±æ˜¯R2ã€R3é—´çš„ä¸€æ¡éš§é“ã€‚å¦‚æœéš§é“ç»ç”±çš„è·¯ç”±ä¸é€è·³ä»è·¯ç”±åè®®ä¸­å–å¾—çš„è·¯ç”±ä¸€è‡´ï¼Œè¿™ç§éš§é“å°±ç§°ä¸ºé€è·³è·¯ç”±éš§é“(Hop by Hop routed tunnel)ï¼Œå¦åˆ™ç§°ä¸ºæ˜¾ç¤ºè·¯ç”±éš§é“(explicitly routed tunnel)ã€‚</p>
<h2 id="å¤šå±‚æ ‡ç­¾æ ˆ"><a href="#å¤šå±‚æ ‡ç­¾æ ˆ" class="headerlink" title="å¤šå±‚æ ‡ç­¾æ ˆ"></a>å¤šå±‚æ ‡ç­¾æ ˆ</h2><p>å¦‚æœåˆ†ç»„åœ¨è¶…è¿‡ä¸€å±‚çš„LSPéš§é“ä¸­ä¼ é€ï¼Œå°±ä¼šæœ‰å¤šå±‚æ ‡ç­¾ï¼Œå½¢æˆæ ‡ç­¾æ ˆ(label stack)ã€‚åœ¨æ¯ä¸€éš§é“çš„å…¥å£å’Œå‡ºå£ï¼Œè¿›è¡Œæ ‡ç­¾çš„å…¥æ ˆ(push)å’Œå‡ºæ ˆ(pop)æ“ä½œã€‚æ ‡ç­¾æŒ‰ç…§<code>åè¿›å…ˆå‡º</code>(last-in-first-out)æ–¹å¼ç»„ç»‡æ ‡ç­¾ï¼ŒMPLSä»æ ˆé¡¶å¼€å§‹å¤„ç†æ ‡ç­¾ã€‚<br>MPLSå¯¹æ ‡ç­¾æ ˆçš„æ·±åº¦æ²¡æœ‰é™åˆ¶ï¼Œè‹¥ä¸€ä¸ªåˆ†ç»„çš„æ ‡ç­¾æ·±åº¦ä¸ºmï¼Œåˆ™ä½äºæ ˆåº•çš„æ ‡ç­¾ä¸º1çº§æ ‡ç­¾ï¼Œä½äºæ ˆé¡¶çš„æ ‡ç­¾ä¸ºmçº§æ ‡ç­¾ã€‚æœªå‹å…¥æ ‡ç­¾çš„åˆ†ç»„å¯çœ‹ä½œæ ‡ç­¾æ ˆä¸ºç©º(å³æ ‡ç­¾æ ˆæ·±åº¦ä¸º0)çš„åˆ†ç»„ã€‚</p>
<h1 id="MPLSä½“ç³»ç»“æ„"><a href="#MPLSä½“ç³»ç»“æ„" class="headerlink" title="MPLSä½“ç³»ç»“æ„"></a>MPLSä½“ç³»ç»“æ„</h1><h2 id="MPLSç½‘ç»œç»“æ„"><a href="#MPLSç½‘ç»œç»“æ„" class="headerlink" title="MPLSç½‘ç»œç»“æ„"></a>MPLSç½‘ç»œç»“æ„</h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMPLSç½‘ç»œçš„åŸºæœ¬æ„æˆå•å…ƒæ˜¯LSRï¼Œç”±LSRæ„æˆçš„ç½‘ç»œç§°ä¸ºMPLSåŸŸã€‚ä½äºMPLSåŸŸè¾¹ç¼˜ã€è¿æ¥å…¶å®ƒç”¨æˆ·ç½‘ç»œçš„LSRç§°ä¸ºLER(label edge router, è¾¹ç¼˜LSR)ï¼ŒåŒºåŸŸå†…éƒ¨çš„LSRç§°ä¸ºæ ¸å¿ƒLSRã€‚æ ¸å¿ƒLSRå¯ä»¥æ˜¯æ”¯æŒMPLSçš„è·¯ç”±å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”±ATMäº¤æ¢æœºç­‰å‡çº§è€Œæˆçš„ATM-LSRã€‚åŸŸå†…éƒ¨çš„LSRä¹‹é—´ä½¿ç”¨MPLSé€šä¿¡ï¼ŒMPLSåŸŸçš„è¾¹ç¼˜ç”±LERä¸ä¼ ç»ŸIPæŠ€æœ¯è¿›è¡Œé€‚é…ã€‚<br>åˆ†ç»„åœ¨å…¥å£LERè¢«å‹å…¥æ ‡ç­¾åï¼Œæ²¿ç€ç”±ä¸€ç³»åˆ—LSRæ„æˆçš„LSPä¼ é€ï¼Œå…¶ä¸­ï¼Œå…¥å£LERè¢«ç§°ä¸ºingressï¼Œå‡ºå£LERè¢«ç§°ä¸ºegressï¼Œä¸­é—´çš„èŠ‚ç‚¹åˆ™ç§°ä¸ºtransitã€‚</p>
<p><img src="https://rancho333.github.io/pictures/mpls_network.png"><br>ç»“åˆä¸Šå›¾ç®€è¦ä»‹ç»MPLSåŸºæœ¬å·¥ä½œè¿‡ç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆï¼ŒLDPå’Œä¼ ç»Ÿè·¯ç”±åè®®(å¦‚OSPFã€ISISç­‰)ä¸€èµ·ï¼Œåœ¨å„ä¸ªLSRä¸­ä¸ºæœ‰ä¸šåŠ¡éœ€æ±‚çš„FECå»ºç«‹è·¯ç”±è¡¨å’ŒLIB(label information baseï¼Œæ ‡ç­¾ä¿¡æ¯è¡¨)</li>
<li>å…¥å£LERæ¥æ”¶åˆ†ç»„ï¼Œå®Œæˆç¬¬ä¸‰å±‚åŠŸèƒ½ï¼Œåˆ¤å®šåˆ†ç»„æ‰€å±çš„FECï¼Œå¹¶ç»™åˆ†ç»„åŠ ä¸Šæ ‡ç­¾ï¼Œå½¢æˆMPLSæ ‡ç­¾åˆ†ç»„</li>
<li>æ¥ä¸‹æ¥ï¼Œåœ¨LSRæ„æˆçš„ç½‘ç»œä¸­ï¼ŒLSRæ ¹æ®åˆ†ç»„ä¸Šçš„æ ‡ç­¾ä»¥åŠLFIB(label forwarding information baseï¼Œæ ‡ç­¾è½¬å‘è¡¨)è¿›è¡Œè½¬å‘ï¼Œä¸å¯¹æ ‡ç­¾åˆ†ç»„è¿›è¡Œä»»ä½•ç¬¬ä¸‰å±‚å¤„ç†</li>
<li>æœ€åï¼Œåœ¨MPLSå‡ºå£LERå»æ‰åˆ†ç»„ä¸­çš„æ ‡ç­¾ï¼Œç»§ç»­è¿›è¡Œåé¢çš„IPè½¬å‘</li>
</ol>
<p>MPLSå¹¶ä¸æ˜¯ä¸€ç§ä¸šåŠ¡æˆ–è€…åº”ç”¨ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ç§éš§é“æŠ€æœ¯ï¼Œä¹Ÿæ˜¯ä¸€ç§å°†æ ‡ç­¾äº¤æ¢è½¬å‘å’Œç½‘ç»œå±‚è·¯ç”±æŠ€æœ¯é›†äºä¸€èº«çš„è·¯ç”±ä¸äº¤æ¢æŠ€æœ¯å¹³å°ï¼Œè¿™ä¸ªå¹³å°ä¸ä»…æ”¯æŒå¤šç§é«˜å±‚åè®®ä¸ä¸šåŠ¡ï¼Œè€Œä¸”ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ä¿è¯ä¿¡æ¯ä¼ è¾“çš„å®‰å…¨æ€§ã€‚</p>
<h2 id="MPLSèŠ‚ç‚¹ç»“æ„"><a href="#MPLSèŠ‚ç‚¹ç»“æ„" class="headerlink" title="MPLSèŠ‚ç‚¹ç»“æ„"></a>MPLSèŠ‚ç‚¹ç»“æ„</h2><p><img src="https://rancho333.github.io/pictures/mpls_node.png"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒMPLSèŠ‚ç‚¹ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>æ§åˆ¶å¹³é¢(control plane)ï¼šè´Ÿè´£æ ‡ç­¾çš„åˆ†é…ã€è·¯ç”±çš„é€‰æ‹©ã€æ ‡ç­¾è½¬å‘è¡¨çš„å»ºç«‹ã€æ ‡ç­¾äº¤æ¢è·¯å¾„çš„å»ºç«‹ã€æ‹†é™¤ç­‰å·¥ä½œ</li>
<li>è½¬å‘å¹³é¢(forwarding plane)ï¼šä¾æ®æ ‡ç­¾è½¬å‘è¡¨å¯¹æ”¶åˆ°çš„åˆ†ç»„è¿›è¡Œè½¬å‘</li>
</ul>
<p>å¯¹äºæ™®é€šçš„LSRï¼Œåœ¨è½¬å‘å¹³é¢åªéœ€è¦è¿›è¡Œæ ‡ç­¾åˆ†ç»„çš„è½¬å‘ï¼Œéœ€è¦ä½¿ç”¨åˆ°LFIBã€‚å¯¹äºLERï¼Œåœ¨è½¬å‘å¹³é¢ä¸ä»…éœ€è¦è¿›è¡Œæ ‡ç­¾åˆ†ç»„çš„è½¬å‘ï¼Œä¹Ÿéœ€è¦è¿›è¡ŒIPåˆ†ç»„çš„è½¬å‘ï¼Œæ‰€ä»¥æ—¢ä¼šä½¿ç”¨åˆ°LFIBï¼Œä¹Ÿä¼šä½¿ç”¨åˆ°FIBè¡¨ã€‚</p>
<h2 id="MPLSä¸è·¯ç”±åè®®"><a href="#MPLSä¸è·¯ç”±åè®®" class="headerlink" title="MPLSä¸è·¯ç”±åè®®"></a>MPLSä¸è·¯ç”±åè®®</h2><p>LDPé€šè¿‡é€è·³æ–¹å¼å»ºç«‹LSPæ—¶ï¼Œåˆ©ç”¨æ²¿é€”å„LSRè·¯ç”±è½¬å‘è¡¨ä¸­çš„ä¿¡æ¯æ¥ç¡®å®šä¸‹ä¸€è·³ï¼Œè€Œè·¯ç”±è½¬å‘è¡¨ä¸­çš„ä¿¡æ¯ä¸€èˆ¬æ˜¯é€šè¿‡IGPã€BGPç­‰è·¯ç”±åè®®æ”¶é›†çš„ã€‚LDPå¹¶ä¸ç›´æ¥å’Œå„ç§è·¯ç”±åè®®å…³è”ï¼Œåªæ˜¯é—´æ¥ä½¿ç”¨è·¯ç”±ä¿¡æ¯ã€‚å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡å¯¹BGPã€RSVPç­‰å·²æœ‰åè®®è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥æ”¯æŒæ ‡ç­¾çš„åˆ†å‘ã€‚<br>åœ¨MPLSçš„åº”ç”¨ä¸­ï¼Œä¹Ÿå¯èƒ½éœ€è¦å¯¹æŸäº›è·¯ç”±åè®®è¿›è¡Œæ‰©å±•ã€‚ä¾‹å¦‚ï¼ŒåŸºäºMPLSçš„VPNåº”ç”¨éœ€è¦å¯¹BGPè¿›è¡Œæ‰©å±•ï¼Œä½¿BGPèƒ½å¤Ÿä¼ æ’­VPNçš„è·¯ç”±ä¿¡æ¯ï¼›åŸºäºMPLSçš„TE(traffic engineering,æµé‡å·¥ç¨‹)éœ€è¦å¯¹OSPFæˆ–IS-ISåè®®è¿›è¡Œæ‰©å±•ï¼Œä»¥ä¾¿æºå¸¦é“¾è·¯çŠ¶æ€ä¿¡æ¯ã€‚</p>
<h2 id="MPLSçš„åº”ç”¨"><a href="#MPLSçš„åº”ç”¨" class="headerlink" title="MPLSçš„åº”ç”¨"></a>MPLSçš„åº”ç”¨</h2><p>æœ€åˆï¼ŒMPLSæŠ€æœ¯ç»“åˆäº†äºŒå±‚äº¤æ¢ä¸ä¸‰å±‚è·¯ç”±æŠ€æœ¯ï¼Œæé«˜äº†è·¯ç”±æŸ¥æ‰¾é€Ÿåº¦ã€‚ä½†éšç€ASICçš„å‘å±•ï¼Œè·¯ç”±æŸ¥æ‰¾é€Ÿåº¦å·²ç»ä¸æˆä¸ºé˜»ç¢ç½‘ç»œå‘å±•çš„ç“¶é¢ˆã€‚è¿™ä½¿å¾—MPLSåœ¨æé«˜è½¬å‘é€Ÿåº¦æ–¹é¢ä¸å…·å¤‡æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚<br>ä½†ç”±äºMPLSç»“åˆäº†IPç½‘ç»œå¼ºå¤§çš„ä¸‰å±‚è·¯ç”±åŠŸèƒ½å’Œä¼ ç»ŸäºŒå±‚ç½‘ç»œé«˜æ•ˆçš„è½¬å‘æœºåˆ¶ï¼Œåœ¨è½¬å‘å¹³é¢é‡‡ç”¨é¢å‘è¿æ¥çš„æ–¹å¼ï¼Œä¸ç°æœ‰äºŒå±‚ç½‘ç»œè½¬å‘æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œè¿™äº›ç‰¹ç‚¹ä½¿å¾—MPLSèƒ½å¤Ÿå¾ˆå®¹æ˜“çš„å®ç°IPä¸ATMã€å¸§ä¸­ç»§ç­‰äºŒå±‚ç½‘ç»œçš„æ— ç¼èåˆï¼Œå¹¶ä¸ºQoSã€TEã€VPNç­‰åº”ç”¨æä¾›æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="åŸºäºMPLSçš„VPN"><a href="#åŸºäºMPLSçš„VPN" class="headerlink" title="åŸºäºMPLSçš„VPN"></a>åŸºäºMPLSçš„VPN</h3><p>ä¼ ç»Ÿçš„VPNä¸€èˆ¬æ˜¯é€šè¿‡GREã€L2TPã€PPTPç­‰éš§é“åè®®æ¥å®ç°ç§æœ‰ç½‘ç»œé—´æ•°æ®æµåœ¨å…¬ç½‘ä¸Šçš„ä¼ é€ï¼ŒLSPæœ¬èº«å°±æ˜¯å…¬ç½‘ä¸Šçš„éš§é“ï¼Œå› æ­¤ï¼Œç”¨MPLSæ¥å®ç°VPNæœ‰å¤©ç„¶çš„ä¼˜åŠ¿ã€‚åŸºäºMPLSçš„VPNå°±æ˜¯é€šè¿‡LSPå°†ç§æœ‰ç½‘ç»œçš„ä¸åŒåˆ†æ”¯è¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªåŒä¸€çš„ç½‘ç»œã€‚åŸºäºMPLSçš„VPNè¿˜æ”¯æŒå¯¹ä¸åŒçš„VPNé—´çš„äº’é€šæ§åˆ¶ã€‚<br><img src="https://rancho333.github.io/pictures/mpls_vpn.png"></p>
<p>ä¸Šå›¾æ˜¯åŸºäºMPLSçš„VPNçš„åŸºæœ¬ç»“æ„</p>
<ul>
<li>CEå¯ä»¥æ˜¯è·¯ç”±å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯äº¤æ¢æœºæˆ–ä¸»æœº</li>
<li>PEä½äºéª¨å¹²ç½‘ç»œ<br>PEè´Ÿè´£å¯¹VPNç”¨æˆ·è¿›è¡Œç®¡ç†ï¼Œå»ºç«‹å„PEé—´çš„LSPè¿æ¥ï¼ŒåŒä¸€VPNç”¨æˆ·å„åˆ†æ”¯é—´è·¯ç”±åˆ†æ´¾ï¼ŒPEé—´çš„è·¯ç”±åˆ†æ´¾é€šå¸¸æ˜¯ç”¨LDPæˆ–æ‰©å±•çš„BGPåè®®å®ç°ã€‚<br>åŸºäºMPLSçš„VPNæ”¯æŒä¸åŒåˆ†æ”¯é—´çš„IPåœ°å€å¤ç”¨ï¼Œå¹¶æ”¯æŒä¸åŒVPNé—´äº’é€šã€‚ä¸ä¼ ç»Ÿçš„è·¯ç”±ç›¸æ¯”ï¼ŒVPNè·¯ç”±ä¸­éœ€è¦å¢åŠ åˆ†æ”¯å’ŒVPNçš„æ ‡è¯†ä¿¡æ¯ï¼Œè¿™å°±éœ€è¦å¯¹BGPåè®®è¿›è¡Œæ‰©å±•ï¼Œä»¥æºå¸¦VPNè·¯ç”±ä¿¡æ¯ã€‚</li>
</ul>
]]></content>
      <tags>
        <tag>é€šä¿¡åè®®</tag>
      </tags>
  </entry>
  <entry>
    <title>mstp802.1sç®€è¿°</title>
    <url>/2022/07/07/mstp802-1s%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>STPå’ŒRSTPæ— æ³•å®ç°è´Ÿè½½å‡è¡¡ï¼Œciscoçš„PVSTå’ŒPVRSTPè™½ç„¶èƒ½å¤Ÿå®ç°ï¼Œä½†æ˜¯æ¯ä¸ªvlanå¯¹åº”ä¸€ä¸ªå®ä¾‹ï¼Œåœ¨vlanè¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œè¿™å¯¹CPUä»¥åŠå†…å­˜èµ„æºä¼šæœ‰æå¤§çš„æµªè´¹ã€‚æ‰€ä»¥MSTPæ¨ªç©ºå‡ºä¸–ï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯ï¼šå°†ä¸€ç»„vlanæ˜ å°„åˆ°ä¸€ä¸ªå®ä¾‹ä¸­ï¼Œæ¯ä¸ªå®ä¾‹è¿è¡Œä¸€ä¸ªstpæ ‘ã€‚MSTPçš„å®ç°æ ‡å‡†æ˜¯802.1s.</p>
<span id="more"></span>

<h1 id="MSTä¸­çš„å‡ ä¸ªæ¦‚å¿µ"><a href="#MSTä¸­çš„å‡ ä¸ªæ¦‚å¿µ" class="headerlink" title="MSTä¸­çš„å‡ ä¸ªæ¦‚å¿µ"></a>MSTä¸­çš„å‡ ä¸ªæ¦‚å¿µ</h1><h2 id="åŸŸ-region"><a href="#åŸŸ-region" class="headerlink" title="åŸŸ(region)"></a>åŸŸ(region)</h2><p>å…·æœ‰<code>ç›¸åŒå±æ€§</code>çš„äº¤æ¢æœºåœ¨åŒä¸€ä¸ªåŸŸä¸­ï¼š</p>
<ul>
<li>MSTåŸŸå</li>
<li>MSTç‰ˆæœ¬å·</li>
<li>MSTä¸­vlanä¸å®ä¾‹çš„æ˜ å°„å…³ç³»</li>
</ul>
<p>MSTåŸŸåæ˜¯ç»™è¯¥åŸŸé…ç½®çš„åå­—ï¼Œå¯ä»¥éšä¾¿èµ·ã€‚ç‰ˆæœ¬å·ä¹Ÿå¯ä»¥éšä¾¿èµ·(ç±»ä¼¼VTPä¸­çš„ç‰ˆæœ¬å·ï¼Œåªæœ‰ä¸€æ ·æ‰ä¼šåŒæ­¥)ã€‚æ˜ å°„åˆ°åŒä¸€ä¸ªå®ä¾‹ä¸­çš„vlanå±äºåŒä¸€ä¸ªstpæ ‘ï¼Œæœ‰ç›¸åŒçš„æ ¹æ¡¥ï¼Œè½¬å‘è·¯å¾„ï¼Œé˜»å¡è·¯å¾„ç­‰ã€‚ç±»ä¼¼äºç«¯å£ä¸vlançš„æ˜ å°„ï¼Œæ‰€æœ‰çš„vlanæœ€å¼€å§‹å±äºé»˜è®¤å®ä¾‹(ciscoä¸­æ˜¯instance 0).</p>
<h2 id="IST"><a href="#IST" class="headerlink" title="IST"></a>IST</h2><p>ISTæ˜¯internal spanning treeçš„ç¼©å†™ï¼Œè¡¨ç¤ºé»˜è®¤å®ä¾‹ã€‚MSTåªä¼šé€šè¿‡ISTå‘å…¶å®ƒåŸŸé€šå‘ŠBPDU.</p>
<h2 id="CIST"><a href="#CIST" class="headerlink" title="CIST"></a>CIST</h2><p>CISTæ˜¯common and internal spanning treeï¼Œå…¬å…±å’Œå†…éƒ¨ç”Ÿæˆæ ‘ï¼Œæ˜¯æ•´ä¸ªå¤§äºŒå±‚ç½‘ç»œæ‰€æœ‰äº¤æ¢æœºç»„æˆçš„å•ç”Ÿæˆæ ‘(æ‰€æœ‰åŸŸå…±åŒç»„æˆ)ï¼Œå°†æ¯ä¸ªåŸŸçœ‹åšä¸€å°è®¾å¤‡ï¼ŒCST(common spanning tree)å°±æ˜¯ç”±è¿™äº›è®¾å¤‡ç»„æˆçš„æ ‘</p>
<h2 id="MSTI"><a href="#MSTI" class="headerlink" title="MSTI"></a>MSTI</h2><p>MSTIæ˜¯multi spanning tree instanceçš„ç¼©å†™ï¼Œå¤šå®ä¾‹ç”Ÿæˆæ ‘çš„å®ä¾‹</p>
<h2 id="é€‰ä¸¾è§„åˆ™"><a href="#é€‰ä¸¾è§„åˆ™" class="headerlink" title="é€‰ä¸¾è§„åˆ™"></a>é€‰ä¸¾è§„åˆ™</h2><p>MSTPä¸­çš„é€‰ä¸¾è§„åˆ™å’ŒSTPå®Œå…¨ä¸€è‡´ï¼Œå¿«é€Ÿæ”¶æ•›æœºåˆ¶åˆ™å’ŒRSTPå®Œå…¨ä¸€è‡´ã€‚</p>
<h2 id="MSTçš„BPDU"><a href="#MSTçš„BPDU" class="headerlink" title="MSTçš„BPDU"></a>MSTçš„BPDU</h2><p>åŒºåˆ«äºpvstpä¸­æ¯ä¸ªvlanéƒ½ä¼šå‘é€ä¸€ä¸ªBPDUï¼ŒMSTPä¸­å¹¶ä¸æ˜¯æ¯ä¸ªå®ä¾‹å‘é€ä¸€ä¸ªBPDUï¼Œè€Œæ˜¯ä¸€å°äº¤æ¢æœºåªä¼šå‘é€ä¸€ä¸ªBPDUï¼Œè¿™ä¸€ä¸ªBPDUä¸­åŒ…å«äº†æ‰€æœ‰çš„å®ä¾‹ã€‚å…·ä½“åˆ°å­—æ®µè€Œè¨€ï¼š</p>
<ul>
<li>protocol versionå­—æ®µæ˜¯0x03</li>
<li>BPDU typeå­—æ®µå’Œrstpä¸€æ ·æ˜¯0x02</li>
<li>flagså­—æ®µå’Œrstpä¿æŒä¸€è‡´</li>
<li>BIDå­—æ®µä¸­çš„æ‰©å±•IDåˆ™ä¸º0<br>å…¶å®ƒå­—æ®µç®€ä»‹å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/mstp_bpdu.png"></li>
</ul>
<p>MSTPé…ç½®æ¯”è¾ƒå¤æ‚ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šåŸŸä½¿ç”¨å°¤å…¶å¤æ‚ï¼Œæœ¬æ–‡åªé€šè¿‡å•åŸŸå¯¹MSTPæœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ã€‚</p>
<h1 id="å®éªŒè¯´æ˜"><a href="#å®éªŒè¯´æ˜" class="headerlink" title="å®éªŒè¯´æ˜"></a>å®éªŒè¯´æ˜</h1><p>ç»å…¸çš„ä¸‰è§’ç¯å½¢æ‹“æ‰‘ï¼Œ åˆ›å»ºä¸€ä¸ªMSTPåŸŸï¼ŒåŸŸå†…åˆ›å»ºä¸¤ä¸ªå®ä¾‹instance 1ã€2, vlan 10-15æ˜ å°„åˆ°å®ä¾‹1ï¼Œ vlan 16-20æ˜ å°„åˆ°å®ä¾‹2ã€‚å®ä¾‹0çš„æ ¹æ¡¥æ˜¯S1ï¼Œå®ä¾‹1çš„æ ¹æ¡¥æ˜¯S2ï¼Œå®ä¾‹2çš„æ ¹æ¡¥æ˜¯S3. æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/mstp_topology.png"></p>
<p>å®éªŒæ­¥éª¤å¦‚ä¸‹ï¼š<br>åˆ›å»ºVlan 10-20</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S1(config)#vlan 10-20</span><br><span class="line">&#x2F;&#x2F; S2å’ŒS3åšç›¸åŒé…ç½®</span><br></pre></td></tr></table></figure>

<p>äº¤æ¢æœºä¹‹é—´é…ç½®trunkè¿æ¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S1(config)#interface range ethernet 0&#x2F;0-1</span><br><span class="line">S1(config-if-range)#switchport trunk encapsulation dot1q</span><br><span class="line">S1(config-if-range)#switchport mode trunk</span><br><span class="line">&#x2F;&#x2F; S2å’ŒS3åšç›¸åŒé…ç½®</span><br></pre></td></tr></table></figure>

<p>é…ç½®stpç‰ˆæœ¬ä¸ºMSTPï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S1(config)#spanning-tree mode mst</span><br><span class="line">&#x2F;&#x2F; S2å’ŒS3åšç›¸åŒé…ç½®</span><br></pre></td></tr></table></figure>

<p>é…ç½®MSTPåŸŸï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S1(config)#spanning-tree mst configuration      &#x2F;&#x2F; è¿›å…¥mståŸŸé…ç½®è§†å›¾</span><br><span class="line">S1(config-mst)#name rancho                      &#x2F;&#x2F; è®¾ç½®åŸŸå</span><br><span class="line">S1(config-mst)#instance 1 vlan 10-15            &#x2F;&#x2F; è®¾ç½®å®ä¾‹1ä¸vlançš„æ˜ å°„</span><br><span class="line">S1(config-mst)#instance 2 vlan 16-20            &#x2F;&#x2F; è®¾ç½®å®ä¾‹2ä¸vlançš„æ˜ å°„</span><br><span class="line">S1(config-mst)#revision 1                       &#x2F;&#x2F; è®¾ç½®ç‰ˆæœ¬å·</span><br><span class="line">&#x2F;&#x2F; S2ä¸S3åšç›¸åŒé…ç½®ï¼Œæ³¨æ„ï¼šåŸŸåã€vlanä¸å®ä¾‹çš„æ˜ å°„ï¼Œç‰ˆæœ¬å·è¿™ä¸‰è€…å¿…é¡»ä¸€è‡´</span><br></pre></td></tr></table></figure>

<p>ç»™å®ä¾‹é…ç½®ä¸åŒçš„æ ¹æ¡¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S2(config)#spanning-tree mst 1 priority 4096    &#x2F;&#x2F; è®¾ç½®S2ä¸ºå®ä¾‹1ä¸­æœ€ä¼˜BID</span><br><span class="line">S3(config)#spanning-tree mst 2 priority 4096    &#x2F;&#x2F; è®¾ç½®S3ä¸ºå®ä¾‹2ä¸­æœ€ä¼˜BID</span><br><span class="line">&#x2F;&#x2F; S1çš„macåœ°å€æœ€å°ï¼Œå®ä¾‹0ä¸­ä¸‰å°äº¤æ¢æœºä¼˜å…ˆçº§éƒ½æ˜¯32768ï¼Œæ‰€ä»¥å®ä¾‹0ä¸­S1æ˜¯æ ¹æ¡¥</span><br></pre></td></tr></table></figure>

<p>å®éªŒç»“æœå¯¹æ¯”æ£€æŸ¥ï¼š<br>ç¡®è®¤é…ç½®ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">S1#show spanning-tree mst configuration </span><br><span class="line">Name      [rancho]</span><br><span class="line">Revision  1     Instances configured 3</span><br><span class="line"></span><br><span class="line">Instance  Vlans mapped</span><br><span class="line">--------  ---------------------------------------------------------------------</span><br><span class="line">0         1-9,21-4094</span><br><span class="line">1         10-15</span><br><span class="line">2         16-20</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">&#x2F;&#x2F; S2ä¸S3ä¸­åšç›¸åŒæ£€æŸ¥</span><br></pre></td></tr></table></figure>

<p>ç¡®è®¤å®ä¾‹0ä¸­æ ¹æ¡¥åŠç«¯å£çŠ¶æ€ï¼š<br><img src="https://rancho333.github.io/pictures/mstp_instance_0.png"></p>
<p>å¯ä»¥çœ‹åˆ°å®ä¾‹0ä¸­ï¼ŒS1æ˜¯æ ¹æ¡¥ï¼ŒS3çš„eth0å¤„äºblockingçŠ¶æ€ã€‚</p>
<p>ç¡®è®¤å®ä¾‹1ä¸­æ ¹æ¡¥åŠç«¯å£çŠ¶æ€ï¼š<br><img src="https://rancho333.github.io/pictures/mstp_instance_1.png"></p>
<p>å¯ä»¥çœ‹åˆ°å®ä¾‹1ä¸­ï¼ŒS2æ˜¯æ ¹æ¡¥ï¼ŒS3çš„eth1å¤„äºblockingçŠ¶æ€ã€‚</p>
<p>ç¡®è®¤å®ä¾‹2ä¸­æ ¹æ¡¥åŠç«¯å£çŠ¶æ€ï¼š<br><img src="https://rancho333.github.io/pictures/mstp_instance_2.png"></p>
<p>å¯ä»¥çœ‹åˆ°å®ä¾‹2ä¸­ï¼ŒS3æ˜¯æ ¹æ¡¥ï¼ŒS2çš„eth0å¤„äºblockingçŠ¶æ€ã€‚</p>
<p>ä¸‰ä¸ªå®ä¾‹ä¸­å¯¹åº”çš„è½¬å‘è·¯å¾„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/mstp_instance_forward_path.png"></p>
<p>å¯ä»¥çœ‹åˆ°ä¸åŒå®ä¾‹çš„æµé‡ä¹‹é—´è´Ÿè½½å‡è¡¡ã€‚</p>
<h1 id="å…¼å®¹æ€§è¯´æ˜"><a href="#å…¼å®¹æ€§è¯´æ˜" class="headerlink" title="å…¼å®¹æ€§è¯´æ˜"></a>å…¼å®¹æ€§è¯´æ˜</h1><p>MSTPå‘ä¸‹å…¼å®¹RSTPå’ŒSTPï¼Œä¸å»ºè®®è¿™ä¹ˆä½¿ç”¨ã€‚</p>
]]></content>
      <tags>
        <tag>STP</tag>
      </tags>
  </entry>
  <entry>
    <title>offset_list_and_pbr</title>
    <url>/2022/07/14/offset-list-and-pbr/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>è·¯ç”±æ§åˆ¶çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚route-mapï¼Œdistribute-listã€‚ä»Šå¤©ä¸»è¦äº†è§£ä¸‹offset-list(åç§»åˆ—è¡¨)å’Œpbr(policy based routing, ç­–ç•¥è·¯ç”±).</p>
<span id="more"></span>

<h1 id="offset-listç®€è¿°"><a href="#offset-listç®€è¿°" class="headerlink" title="offset-listç®€è¿°"></a>offset-listç®€è¿°</h1><p>offset-listéå¸¸ç®€å•ï¼Œç†è®ºç‰¹ç‚¹å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‹é¢å‡ æ¡ï¼š</p>
<ul>
<li>åªèƒ½åœ¨è·ç¦»çŸ¢é‡è·¯ç”±åè®®ä¸Šä½¿ç”¨(ripï¼Œeigrp)ï¼Œospfä¸­ç›´æ¥ä½¿ç”¨costæ§åˆ¶</li>
<li>æ”¯æ”¯æŒACLä¸æ”¯æŒprefix-list</li>
<li>åªå¯ä»¥å¢å¤§metricä¸å¯ä»¥å‡å°metric(eigrpä¸­æ˜¯metricï¼Œripä¸­æ˜¯hop-count)</li>
<li>åœ¨è°ƒç”¨æ–¹å‘ä¸Šï¼Œå¯ä»¥åœ¨in/outä¸Šè°ƒç”¨ï¼Œä½œç”¨å¯¹è±¡ä¸åŒï¼Œæ•ˆæœè‡ªç„¶æœ‰æ‰€å·®å¼‚</li>
</ul>
<h2 id="offset-listå®éªŒ"><a href="#offset-listå®éªŒ" class="headerlink" title="offset-listå®éªŒ"></a>offset-listå®éªŒ</h2><p>æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/offset_list_topology.png"></p>
<p>åœ¨R2ã€R4ä¸Šçš„lp0ä¸Šè®¾ç½®ç›¸åŒçš„ipåœ°å€4.4.4.4(ä»…å®éªŒæ•ˆæœ)ï¼Œä¸‰å°è·¯ç”±å™¨å‡è¿è¡Œeigrp, åˆ™R1ä¸Šå¯¹4.4.4.4æœ‰ä¸¤ä¸ªä¸‹ä¸€è·³ã€‚åŸºæœ¬é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">R1</a></li><li class="tab"><a href="#tab-2">R2</a></li><li class="tab"><a href="#tab-3">R3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 13.1.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">router eigrp 90</span><br><span class="line"> network 12.1.1.0 0.0.0.255</span><br><span class="line"> network 13.1.1.0 0.0.0.255</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Loopback0</span><br><span class="line"> ip address 4.4.4.4 255.255.255.255</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.2 255.255.255.0</span><br><span class="line">!</span><br><span class="line">router eigrp 90</span><br><span class="line"> network 4.4.4.4 0.0.0.0</span><br><span class="line"> network 12.1.1.0 0.0.0.255</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-3"><p>interface Loopback0<br> ip address 4.4.4.4 255.255.255.255<br>!<br>interface Ethernet0/0<br> ip address 13.1.1.3 255.255.255.0<br>!<br>router eigrp 90<br> network 4.4.4.4 0.0.0.0<br> network 13.1.1.0 0.0.0.255</p></div></div></div>

<p>æŸ¥çœ‹R1ä¸Šçš„è·¯ç”±è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip route eigrp | begin 4.4.4.4</span><br><span class="line">D        4.4.4.4 [90&#x2F;409600] via 13.1.1.3, 00:00:10, Ethernet0&#x2F;1</span><br><span class="line">                 [90&#x2F;409600] via 12.1.1.2, 00:00:10, Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°<code>4.4.4.4</code>çš„ä¸¤ä¸ªä¸‹ä¸€è·³æœ‰ç›¸åŒçš„metricå€¼ï¼Œæ‰€ä»¥ç°åœ¨æ˜¯ecmpã€‚æˆ‘ä»¬åœ¨R1çš„eth0 inæ–¹å‘ä¸Šåšä¸€ä¸ªoffset-listæ¥ä¿®æ”¹R2é€šå‘Šè¿‡æ¥çš„è·¯ç”±metricã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1(config)#ip access-list standard 12           &#x2F;&#x2F; åˆ›å»ºæ ‡å‡†aclï¼Œç¼–å·12</span><br><span class="line">R1(config-std-nacl)#permit 4.4.4.4              &#x2F;&#x2F; åŒ¹é…4.4.4.4çš„è·¯ç”±</span><br><span class="line">R1(config)#router eigrp 90</span><br><span class="line">R1(config-router)#offset-list 12 in 1 ethernet 0&#x2F;0          &#x2F;&#x2F; åœ¨eth0&#x2F;0çš„inæ–¹å‘ä¸Šè°ƒç”¨acl 12, åŒ¹é…ä¸Šåå°†metricå¢åŠ 1</span><br></pre></td></tr></table></figure>

<p>åˆ†åˆ«æŸ¥çœ‹R1ä¸Šeigrpçš„æ‹“æ‰‘ä¿¡æ¯å’Œè·¯ç”±ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip eigrp topology | begin 4.4.4.4</span><br><span class="line">P 4.4.4.4&#x2F;32, 1 successors, FD is 409600</span><br><span class="line">        via 13.1.1.3 (409600&#x2F;128256), Ethernet0&#x2F;1</span><br><span class="line">        via 12.1.1.2 (409601&#x2F;128256), Ethernet0&#x2F;0           &#x2F;&#x2F; å‘ç°R2ä¼ æ¥çš„4.4.4.4è·¯ç”±çš„metricåŠ 1</span><br><span class="line"></span><br><span class="line">R1#show ip route eigrp | begin 4.4.4.4</span><br><span class="line">D        4.4.4.4 [90&#x2F;409600] via 13.1.1.3, 00:05:44, Ethernet0&#x2F;1        &#x2F;&#x2F; 4.4.4.4åªæœ‰R3ä¸€ä¸ªä¸‹ä¸€è·³</span><br></pre></td></tr></table></figure>
<p>åŒæ ·çš„åŸç†ï¼Œåœ¨R2,R3çš„ethä¸Šé…ç½®outæ–¹å‘çš„offset-listå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ§åˆ¶æ•ˆæœã€‚</p>
<h1 id="pbrç®€è¿°"><a href="#pbrç®€è¿°" class="headerlink" title="pbrç®€è¿°"></a>pbrç®€è¿°</h1><p>pbræ˜¯route-mapçš„ä¸€ç§åº”ç”¨ï¼Œpbræ˜¯å¯ä»¥æŒ‰ç…§ç®¡ç†å‘˜æ€æƒ³å»å®ç°çš„è·¯ç”±, æˆ‘æƒ³è®©ä½ å¾€å“ªèµ°ï¼Œä½ å°±å¾€å“ªèµ°ã€‚pbrçš„ä¼˜å…ˆçº§é«˜äºè·¯ç”±è¡¨ï¼Œå†…å®¹ä¸ä¼šå‡ºç°åœ¨è·¯ç”±è¡¨ä¸­ã€‚</p>
<h2 id="pbrå®éªŒ"><a href="#pbrå®éªŒ" class="headerlink" title="pbrå®éªŒ"></a>pbrå®éªŒ</h2><p>æ²¿ç”¨ä¸Šé¢offset-listçš„æ‹“æ‰‘å›¾ï¼Œåœ¨R2ä¸Šåˆ›å»ºlp1:5.5.5.5ï¼Œåœ¨R1ä¸Šåˆ›å»ºpbrä½¿å¾—R1åˆ°5.5.5.5è·¯ç”±å¯è¾¾ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1(config)#ip access-list extended 100              &#x2F;&#x2F; åˆ›å»ºæ‰©å±•acl 100</span><br><span class="line">R1(config-ext-nacl)#permit ip any 5.5.5.5 255.255.255.255       &#x2F;&#x2F; åŒ¹é…5.5.5.5çš„è·¯ç”±</span><br><span class="line">R1(config)#route-map pbr permit 10                      &#x2F;&#x2F; åˆ›å»ºroute-map</span><br><span class="line">R1(config-route-map)#match ip address 100               &#x2F;&#x2F; åŒ¹é…acl 100</span><br><span class="line">R1(config-route-map)#set ip next-hop 12.1.1.2           &#x2F;&#x2F; è®¾ç½®ä¸‹ä¸€è·³ip</span><br><span class="line">R1(config)#ip local policy route-map pbr                &#x2F;&#x2F; å¼€å¯æœ¬åœ°route-mapè½¬å‘ï¼Œå¯¹æœ¬è®¾å¤‡å§‹å‘çš„æµé‡å¼€å¯pbr</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; R1(config-if)#ip policy route-map pbr           å¦‚æœæ˜¯æœ¬åœ°è½¬å‘çš„æµé‡ï¼Œéœ€è¦åœ¨æ”¶åˆ°æµé‡çš„æ¥å£ä¸‹å¼€å¯pbr</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶æŸ¥çœ‹æœ¬åœ°è·¯ç”±è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip route | include 5.5.5.5</span><br><span class="line">R1#</span><br><span class="line">R1#ping 5.5.5.5</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 5.5.5.5, timeout is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5&#x2F;5), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;1&#x2F;1 ms</span><br><span class="line">R1#</span><br></pre></td></tr></table></figure>
<p>å‘ç°è·¯ç”±è¡¨ä¸­æ˜¯æ²¡æœ‰5.5.5.5çš„è·¯ç”±ï¼Œä½†æ˜¯å¯ä»¥pingé€šã€‚å¯é€šè¿‡ä¸‹é¢æ–¹å¼æŸ¥çœ‹æœ¬åœ°pbrç­–ç•¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip local policy </span><br><span class="line">Local policy routing is enabled, using route map pbr</span><br><span class="line">route-map pbr, permit, sequence 10</span><br><span class="line">  Match clauses:</span><br><span class="line">    ip address (access-lists): 100 </span><br><span class="line">  Set clauses:</span><br><span class="line">    ip next-hop 12.1.1.2</span><br><span class="line">  Policy routing matches: 20 packets, 2000 bytes</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†éªŒè¯pbrçš„ä¼˜å…ˆçº§é«˜äºè·¯ç”±è¡¨ï¼Œæˆ‘ä»¬åœ¨R3ä¸ŠåŒæ ·åˆ›å»ºlp1:5.5.5.5, å¹¶å®£å‘Šè¿›eigrpï¼Œæ­¤æ—¶R1çš„è·¯ç”±è¡¨ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip route | include 5.5.5.5</span><br><span class="line">D        5.5.5.5 [90&#x2F;409600] via 13.1.1.3, 00:00:21, Ethernet0&#x2F;1</span><br><span class="line"></span><br><span class="line">R1#trace 5.5.5.5</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Tracing the route to 5.5.5.5</span><br><span class="line">VRF info: (vrf in name&#x2F;id, vrf out name&#x2F;id)</span><br><span class="line">  1 12.1.1.2 0 msec 1 msec * </span><br><span class="line">R1#</span><br></pre></td></tr></table></figure>
<p>å‘ç°R1ä¸Šåˆ°5.5.5.5çš„ä¸‹ä¸€è·³æ˜¯æŒ‰ç…§pbrèµ°çš„ï¼Œå¹¶ä¸æ˜¯æŒ‰ç…§è·¯ç”±è¡¨åšçš„ã€‚</p>
]]></content>
      <tags>
        <tag>routing</tag>
      </tags>
  </entry>
  <entry>
    <title>onieç¼–è¯‘ç®€è¿°</title>
    <url>/2024/01/10/onie%E7%BC%96%E8%AF%91%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>ç®€å•è®°å½•ä¸‹åŸºäº<a href="https://github.com/CumulusNetworks/DUE/tree/master">DUE</a>ç¯å¢ƒç¼–è¯‘onieé•œåƒçš„è¿‡ç¨‹ã€‚</p>
<span id="more"></span>

<h1 id="ç¼–è¯‘æ­¥éª¤"><a href="#ç¼–è¯‘æ­¥éª¤" class="headerlink" title="ç¼–è¯‘æ­¥éª¤"></a>ç¼–è¯‘æ­¥éª¤</h1><ol>
<li>ä¸‹è½½DUEä»£ç ï¼Œæ„å»ºç¼–è¯‘ç¯å¢ƒ<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;CumulusNetworks&#x2F;DUE.git    &#x2F;&#x2F; ä¸‹è½½DUEä»£ç   </span><br></pre></td></tr></table></figure></li>
</ol>
<p>æ‰§è¡Œ<code>./due -c --help</code> ä¼šæ˜¾ç¤ºå½“å‰å¯ä»¥è‡ªåŠ¨æ„å»ºçš„ç¼–è¯‘ç¯å¢ƒ.<br><img src="https://rancho333.github.io/pictures/due_create_help.png"></p>
<p>æ ¹æ®è‡ªå·±onieçš„æºç é€‰æ‹©å¯¹åº”çš„dockerè¿›è¡Œæ„å»ºï¼Œè¿™é‡Œé€‰æ‹©debian10</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;due  --create  --platform  linux&#x2F;amd64    --name  onie-build-debian-10     --prompt  ONIE-10       --tag  onie-10                  --use-template  onie              --from  debian:10</span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…å®Œæˆæ„å»ºä¹‹åä½¿ç”¨<code>docker images | grep onie</code>æ£€æŸ¥ä¸€ä¸‹ã€‚</p>
<ol start="2">
<li><p>ä¸‹è½½onieæºç </p>
</li>
<li><p>è¿›å…¥ç¼–è¯‘ç¯å¢ƒè¿›è¡Œç¼–è¯‘</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;due -r --home-dir &#x2F;projects&#x2F;erzhu&#x2F;build&#x2F;rancho&#x2F;              &#x2F;&#x2F; åœ¨DUEæ ¹ç›®å½•ä¸‹æ‰§è¡Œ, ä½¿ç”¨ --home-dir ä¿®æ”¹mountè·¯å¾„ï¼Œé»˜è®¤æ˜¯&#x2F;home&#x2F;ranchoï¼Œä¿è¯onieæºç mountè¿›å»å°±è¡Œ</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥onieçš„<code>build-config</code>ç›®å½•ï¼Œæ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">make -j8 MACHINEROOT&#x3D;..&#x2F;machine&#x2F;celestica&#x2F; MACHINE&#x3D;cel_ds2000 all            &#x2F;&#x2F; æ ¹æ®venderå’Œhwskuå¡«å³å¯</span><br></pre></td></tr></table></figure>
<p>å½“å‰ä»£ç ä½¿èƒ½äº†secure boot, ç¼–è¯‘è¿‡ç¨‹ä¸­éœ€è¦è¾“å…¥å¯†ç (123456).</p>
</li>
</ol>
<p>ç¼–è¯‘å®Œæˆä¹‹åï¼Œç”Ÿæˆçš„isoé•œåƒåœ¨<code>build/images</code>, ä½¿ç”¨ddåˆ¶ä½œå¯åŠ¨ç›˜å³å¯ã€‚</p>
]]></content>
      <tags>
        <tag>onie</tag>
      </tags>
  </entry>
  <entry>
    <title>shell_tips_tricks</title>
    <url>/2021/02/20/shell-tips-tricks/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>è¿™ç¯‡æ–‡ç« ç”¨æ¥è®°å½•shellçš„ä¸€äº›ä½¿ç”¨æŠ€å·§ï¼Œä½¿ç”¨åœºæ™¯</p>
<span id="more"></span>

<h1 id="Tips-amp-Tricks"><a href="#Tips-amp-Tricks" class="headerlink" title="Tips &amp; Tricks"></a>Tips &amp; Tricks</h1><h2 id="è·å–shellè„šæœ¬æ‰€åœ¨çš„ç›®å½•"><a href="#è·å–shellè„šæœ¬æ‰€åœ¨çš„ç›®å½•" class="headerlink" title="è·å–shellè„šæœ¬æ‰€åœ¨çš„ç›®å½•"></a>è·å–shellè„šæœ¬æ‰€åœ¨çš„ç›®å½•</h2><p><code>dirname &quot;$(realpath &quot;$(BASH_SOURC[0])&quot;)&quot;</code><br>$0æˆ–è€…$(BASH_SOURC[0])è¡¨ç¤ºå½“å‰è„šæœ¬ï¼Œ<code>realpath</code>è·å–è„šæœ¬çš„ç»å¯¹è·¯å¾„ï¼Œ<code>dirname</code>å°†æ–‡ä»¶åçš„æœ€åä¸€ä¸ªç»„ä»¶å»æ‰ã€‚</p>
<h2 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº [[]]"></a>å…³äº [[]]</h2><p>[[]]ä¸­æ²¡æœ‰æ–‡ä»¶æ‰©å±•å’Œ<code>å•è¯åˆ†ç¦»</code>ï¼Œä½†æ˜¯ä¼šå‘ç”Ÿå‚æ•°æ‰©å±•å’Œå‘½ä»¤æ›¿æ¢ã€‚<br>å¦‚æœå­—ç¬¦ä¸²ä¸­æœ‰ç©ºæ ¼ï¼Œé‚£ä¹ˆåªèƒ½ç”¨[[]]æƒŠé†’åˆ¤æ–­ã€‚å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">str&#x3D;â€œabc defâ€</span><br><span class="line">[[ -z $str ]]           &#x2F;&#x2F; åˆ¤æ–­stræ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä½¿ç”¨[ -z str ] åˆ™ä¼šæŠ¥æ•°ç»„é”™è¯¯ï¼Œå› ä¸º&#96;[]&#96;ä¼šå°†stråˆ†å‰²æˆabcã€defä¸¤ä¸ªå­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>shellå˜é‡</title>
    <url>/2021/02/22/shell%E5%8F%98%E9%87%8F/</url>
    <content><![CDATA[<ul>
<li><a href="#shell%E5%8F%98%E9%87%8F">shellå˜é‡</a></li>
<li><a href="#%E5%8F%98%E9%87%8F%E7%9B%B8%E5%85%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4">å˜é‡ç›¸å…³çš„ä¸€äº›å‘½ä»¤</a></li>
<li><a href="#%E7%89%B9%E6%AE%8A%E5%8F%98%E9%87%8F">ç‰¹æ®Šå˜é‡</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">å¸¸è§ç¯å¢ƒå˜é‡</a></li>
</ul>
<h1 id="shellå˜é‡"><a href="#shellå˜é‡" class="headerlink" title="shellå˜é‡"></a>shellå˜é‡</h1><p>æ ‡å‡†çš„UNIXå˜é‡åˆ†ä¸ºä¸¤ç±»ï¼Œç¯å¢ƒå˜é‡å’Œshellå˜é‡ã€‚å¹¿ä¹‰ä¸Šè€Œè¨€ï¼Œ<code>shellå˜é‡</code>åªåº”ç”¨äºå½“å‰çš„shellå®ä¾‹ï¼Œæ˜¯ç”¨æ¥è®¾ç½®çŸ­æœŸå·¥ä½œæƒ…å†µçš„; <code>ç¯å¢ƒå˜é‡</code>æœ‰æ›´é•¿è¿œçš„æ„ä¹‰ï¼Œè¿™äº›å˜é‡åœ¨ç™»å½•æ—¶è®¾ç½®ï¼Œåœ¨æ•´ä¸ªä¼šè¯æœŸéƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ä¸€èˆ¬çº¦å®šï¼Œç¯å¢ƒå˜é‡ä½¿ç”¨å¤§å†™å˜é‡è¡¨ç¤ºï¼Œshellå˜é‡ä½¿ç”¨å°å†™è¡¨ç¤ºã€‚</p>
<span id="more"></span>

<p>é€šè¿‡<code>printenv</code>å‘½ä»¤åˆ—å‡ºæ‰€æœ‰çš„ç¯å¢ƒå˜é‡ï¼Œ<code>set</code>å‘½ä»¤åˆ—å‡ºæ‰€æœ‰çš„shellå˜é‡ã€‚ç¯å¢ƒå˜é‡ä¸­å­˜å‚¨çš„æ›´å¤šæ˜¯æ°¸ä¹…æ€§çš„å˜é‡,ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HOME&#x3D;&#x2F;home&#x2F;rancho</span><br></pre></td></tr></table></figure>
<p>è¿™äº›å˜é‡å¾ˆå°‘æ”¹å˜ï¼Œè€Œshellå˜é‡å­˜å‚¨æœ¬åœ°çš„ã€ä¸´æ—¶æ€§çš„ã€shellç‰¹æœ‰çš„å˜é‡,å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PWD&#x3D;&#x2F;tmp            #åˆ‡æ¢åˆ°ä¸åŒçš„æ–‡ä»¶å¤¹ä¸‹æŸ¥çœ‹è¯¥å˜é‡ï¼Œè¯¥å˜é‡çš„å€¼å°±æ˜¯pwdå‘½ä»¤çš„æ‰“å°</span><br></pre></td></tr></table></figure>

<p>shellå˜é‡æ˜¯shellä¸“æœ‰çš„å˜é‡ï¼Œä¸ä¼šè¢«å­è¿›ç¨‹ç»§æ‰¿ï¼Œç¯å¢ƒå˜é‡æ‰ä¼šè¢«ç»§æ‰¿ã€‚</p>
<h1 id="å˜é‡ç›¸å…³çš„ä¸€äº›å‘½ä»¤"><a href="#å˜é‡ç›¸å…³çš„ä¸€äº›å‘½ä»¤" class="headerlink" title="å˜é‡ç›¸å…³çš„ä¸€äº›å‘½ä»¤"></a>å˜é‡ç›¸å…³çš„ä¸€äº›å‘½ä»¤</h1><p>å¯¹äºå‡ ä¸ªå…³äºå˜é‡çš„å‘½ä»¤çš„è¯´æ˜ï¼š</p>
<ul>
<li>set             è®¾ç½®å’Œæ˜¾ç¤ºshellå˜é‡ï¼ˆåŒ…æ‹¬ç¯å¢ƒå˜é‡ï¼Œshellå˜é‡ï¼Œå‡½æ•°å®šä¹‰, ç­‰æ•ˆäºdeclare</li>
<li>env,printenv    æ˜¾ç¤ºç¯å¢ƒå˜é‡</li>
<li>export          å°†shellå˜é‡å¯¼å‡ºä¸ºç¯å¢ƒå˜é‡, æ˜¾ç¤ºå¯¼å‡ºæˆç¯å¢ƒå˜é‡çš„shellå˜é‡ï¼Œå¹¶æ˜¾ç¤ºå˜é‡å±æ€§ï¼Œç­‰æ•ˆäºdeclare -x</li>
</ul>
<p>å¯¹äºå˜é‡ï¼Œå…¶æ ¸å¿ƒçš„ç‚¹</p>
<ul>
<li>å˜é‡å¯¹åº”çš„å€¼</li>
<li>å˜é‡çš„ä½œç”¨åŸŸ</li>
</ul>
<p>å…¶ä¸­ï¼Œshellå˜é‡çš„å€¼åªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨<code>declare -i</code>å¼ºåˆ¶å£°æ˜ä¸ºæ•°å€¼ã€<br>å…³äºå˜é‡ä½œç”¨åŸŸï¼š<br>shellå˜é‡ä¸ç¯å¢ƒå˜é‡çš„ä½œç”¨åŸŸå·®å¼‚ä¸»è¦ä½“ç°åœ¨å­shellç»§æ‰¿ä¸Šé¢ï¼›<code>source</code>æˆ–<code>.</code>ä¸ç›´æ¥æ‰§è¡Œè„šæœ¬çš„ä½œç”¨åŸŸå·®å¼‚ä¸»è¦ä½“ç°åœ¨å¯¹å½“å‰shellç¯å¢ƒçš„è®¾ç½®ä¸Šé¢<br>shellå‘½ä»¤è¡Œæˆ–shellè„šæœ¬ä¸­å®šä¹‰çš„å˜é‡å‡ä¸ºå…¨å±€çš„ï¼Œå“ªæ€•æ˜¯åœ¨shellå‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ä¹Ÿæ˜¯å…¨å±€çš„shellå˜é‡ï¼Œè¿™ä¸å…¶å®ƒç¼–ç¨‹è¯­è¨€ä¸åŒï¼Œåœ¨shellå‡½æ•°ä¸­ä½¿ç”¨å†…å»ºå‘½ä»¤<code>local</code>å£°æ˜çš„å˜é‡ä½œç”¨åŸŸåªåœ¨å‡½æ•°ä¸­ï¼Œ<code>local</code>å‘½ä»¤ä¹Ÿåªèƒ½åœ¨å‡½æ•°ä¸­ä½¿ç”¨<br>åŒæ—¶ï¼Œè¿™ä¸€ç‚¹ä¹Ÿæ˜¯å¾ˆåˆç†çš„ï¼Œå¯¹äºæ™®é€šç¨‹åºï¼Œå¦‚<code>ls</code>ï¼Œç¨‹åºæ‰§è¡Œå®Œå†…å­˜å°±é‡Šæ”¾äº†ï¼Œæ‰€ä»¥é‡Œé¢çš„å˜é‡éƒ½æ²¡äº†ï¼›è€Œ<code>bash</code>æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç¨‹åºï¼Œå®ƒå¹¶æ²¡æœ‰ç»“æŸï¼Œæ‰€ä»¥é‡Œé¢çš„å˜é‡è¿˜åœ¨ï¼Œå¦‚æœä½ <code>exit</code>é€€å‡ºäº†ï¼Œå˜é‡ä¹Ÿå°±æ²¡äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho ~]$ type -t local</span><br><span class="line">builtin</span><br><span class="line">[rancho ~]$ local a&#x3D;10</span><br><span class="line">-bash: local: can only be used in a function</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå˜é‡çš„ä½œç”¨åŸŸåªæƒ³åœ¨è„šæœ¬å†…ç”Ÿæ•ˆï¼Œä½¿ç”¨å®Œä¹‹åç”¨<code>unset</code>å°†ä¹‹é‡Šæ”¾</p>
<p>æ­¤å¤–ï¼Œä½¿ç”¨<code>var=value cmd</code>æ–¹å¼å®šä¹‰çš„å˜é‡ä½œç”¨åŸŸåªåœ¨cmdçš„æ‰§è¡Œç¯å¢ƒä¸­ã€‚</p>
<h1 id="ç‰¹æ®Šå˜é‡"><a href="#ç‰¹æ®Šå˜é‡" class="headerlink" title="ç‰¹æ®Šå˜é‡"></a>ç‰¹æ®Šå˜é‡</h1><p>shellä¸Šæœ‰ä¸€äº›ç‰¹æ®Šå˜é‡ï¼Œè¿™äº›å˜é‡ç”±shellè‡ªèº«åŠ¨æ€ç»´æŠ¤ï¼Œä¸å…è®¸ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ã€‚</p>
<p>è¿™äº›ç‰¹æ®Šå˜é‡æ²¡æœ‰å˜é‡åï¼Œè€Œæ˜¯ä½¿ç”¨å˜é‡å¼•ç”¨å»ä½¿ç”¨è¿™äº›å˜é‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$1,$2,$Nï¼š          è„šæœ¬çš„ä½ç½®å‚æ•°</span><br><span class="line">$0:                 shellæˆ–shellè„šæœ¬çš„åç§°ï¼Œæ³¨æ„BASH_SOURCEå˜é‡</span><br><span class="line">$*:                 æ‰©å±•ä¸ºä½ç½®å‚æ•°ï¼Œâ€œ$*â€ç­‰ä»·äºâ€œ$1 $2 $3 ... $Nâ€</span><br><span class="line">$@:                 æ‰©å±•ä¸ºä½ç½®å‚æ•°ï¼Œâ€œ$@â€ç­‰ä»·äºâ€œ$1â€ &quot;$2&quot; &quot;$3&quot; ... &quot;$N&quot;</span><br><span class="line">$#:                 ä½ç½®å‚æ•°çš„ä¸ªæ•°</span><br><span class="line">$$:                 å½“å‰shellè¿›ç¨‹çš„PIDï¼Œåœ¨æŸäº›shell(å¦‚å°æ‹¬å·å¼€å¯çš„å­shell)ä¸‹ä¼šè¢«ç»§æ‰¿ã€‚æ³¨æ„BASHPIDå˜é‡</span><br><span class="line">$?:                 æœ€è¿‘ä¸€ä¸ªå‰å°å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç </span><br><span class="line">$!:                 æœ€è¿‘ä¸€ä¸ªåå°å‘½ä»¤çš„é€€å‡ºä»£ç </span><br><span class="line">$-:                 å½“å‰shellç¯å¢ƒçš„ä¸€äº›ç‰¹æ®Šè®¾ç½®ï¼Œå¦‚æ˜¯å¦æ˜¯äº¤äº’å¼ï¼Œä¸€èˆ¬æ˜¯himBH, æ¯”å¦‚å¯ä»¥è®¾ç½®set -x,å˜æˆhimxBHï¼Œå–æ¶ˆset +x</span><br></pre></td></tr></table></figure>

<h1 id="å¸¸è§ç¯å¢ƒå˜é‡"><a href="#å¸¸è§ç¯å¢ƒå˜é‡" class="headerlink" title="å¸¸è§ç¯å¢ƒå˜é‡"></a>å¸¸è§ç¯å¢ƒå˜é‡</h1><p><code>$TERM</code>å˜é‡è¡¨ç¤ºç»ˆç«¯ç±»å‹ï¼Œå€¼ä¼šæ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š</p>
<ul>
<li>xterm             ä¸€èˆ¬æ˜¯è¿™ä¸ªå€¼</li>
<li>vt220             æ˜¯xtermçš„å­é›†ï¼Œä¸æ”¯æŒé¢œè‰²ï¼Œå¯ä»¥topå‘½ä»¤åè¾“å…¥zæµ‹è¯•</li>
<li>xterm-color       å¦‚æœåœ¨è€ç³»ç»Ÿï¼Œå¹¶ä¸”å±å¹•é¢œè‰²ä¸å¯¹æ—¶ç”¨è¿™ä¸ªç±»å‹</li>
<li>putty,konsole     ä½¿ç”¨ç»ˆç«¯æ¨¡æ‹Ÿå™¨</li>
<li>screen            if running inside GNU screenï¼ˆor tmuxï¼‰</li>
<li>linux             é€šè¿‡linuxä¸²å£ç™»å½• ctrl+alt+f1</li>
</ul>
]]></content>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>shellæ ¸å¿ƒæœºåˆ¶ä¹‹å­shellä¸shellç¯å¢ƒ</title>
    <url>/2021/02/22/shell%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6%E4%B9%8B%E5%AD%90shell%E4%B8%8Eshell%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<h1 id="æ·±å…¥äº†è§£shellå¿…å¤‡çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹"><a href="#æ·±å…¥äº†è§£shellå¿…å¤‡çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹" class="headerlink" title="æ·±å…¥äº†è§£shellå¿…å¤‡çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹"></a>æ·±å…¥äº†è§£shellå¿…å¤‡çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹</h1><p>å­shellä¸shellç¯å¢ƒæ˜¯æ·±å…¥äº†è§£shellæ‰€å¿…å¤‡çš„ä¸¤ä¸ªçŸ¥è¯†ç‚¹ã€‚shellçš„å®ç°æ–¹å¼æœ‰å¤šç§ï¼Œå¦‚bashï¼Œshï¼Œzshç­‰ï¼Œè¿™äº›è½¯ä»¶æœ¬è´¨å°±æ˜¯ä¸€ä¸ªshellè§£é‡Šå™¨ï¼Œæœ€å¸¸ç”¨çš„æ˜¯bashï¼Œå› ä¸ºå…¶åœ¨å‡ ä¹æ‰€æœ‰çš„Linuxå‘è¡Œç‰ˆä¸­éƒ½é¢„å®‰è£…äº†ã€‚<br>å­shellæ˜¯shellå‘½ä»¤çš„è¿è¡Œæœºåˆ¶ï¼Œè€Œshellç¯å¢ƒæ˜¯shellå‘½ä»¤çš„è¿è¡Œç¯å¢ƒï¼Œå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ç¯å¢ƒå˜é‡äº†ã€‚</p>
<span id="more"></span>
<h1 id="å‘½ä»¤ç±»å‹ä¸å­shell"><a href="#å‘½ä»¤ç±»å‹ä¸å­shell" class="headerlink" title="å‘½ä»¤ç±»å‹ä¸å­shell"></a>å‘½ä»¤ç±»å‹ä¸å­shell</h1><p>å¹¶ä¸æ˜¯åœ¨shellé‡Œæ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåœ¨å­shellé‡Œæ‰§è¡Œï¼Œæˆ‘ä»¬éœ€è¦å…ˆè®¤è¯†ä¸€ä¸‹shellå‘½ä»¤åˆ†ç±»ã€‚</p>
<p><code>type</code>å‘½ä»¤å¯ä»¥å¯ä»¥æ˜¾ç¤ºå‡ºå‘½ä»¤çš„ç±»å‹ï¼Œå¯¹äºä¸åŒçš„ç±»å‹shellè§£é‡Šå™¨æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚å‘½ä»¤ç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>alias(shell alias)</li>
<li>function(shell functions)ï¼Œshellå‡½æ•°</li>
<li>builtin(shell builtin)ï¼Œshellå†…å»ºå‘½ä»¤</li>
<li>file(disk file)ï¼Œç£ç›˜æ–‡ä»¶ï¼Œéœ€è¦æœ‰å¯æ‰§è¡Œæƒé™ï¼Œæˆ‘ä»¬å®‰è£…çš„ç¬¬ä¸‰æ–¹è½¯ä»¶ä¸€èˆ¬å°±æ˜¯è¿™ç§ç±»å‹ï¼Œåœ¨PATHä¸‹æ‰¾åˆ°ï¼Œè¿™ä¸ªæ˜¯å¤–éƒ¨å‘½ä»¤ï¼Œå¦‚sshã€ls</li>
<li>keyword(shell reserved word)ï¼Œshellä¿ç•™å…³é”®å­—ï¼Œå¦‚forã€doneã€whileç­‰ï¼Œåœ¨shellè„šæœ¬ä¸­å¾ˆå¸¸ç”¨</li>
</ul>
<p><code>type</code>çš„å¸¸ç”¨å‚æ•°å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-t      æ‰“å°å‘½ä»¤ç±»å‹ï¼Œä¸Šè¿°5ç§ç±»å‹ä¹‹ä¸€</span><br><span class="line">-a      æ‰“å°æ‰€æœ‰åŒ…å«è¯¥å‘½ä»¤çš„æ–‡ä»¶ä½ç½®</span><br></pre></td></tr></table></figure>

<p>shellå¯¹äºä¸åŒçš„å‘½ä»¤ç±»å‹ï¼Œå¤„ç†æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li>file(å¤–éƒ¨å‘½ä»¤)çš„æ‰§è¡Œï¼šå…ˆfork shellå­è¿›ç¨‹ï¼Œåœ¨ååœ¨å­shellè¿›ç¨‹ä¸­execè°ƒç”¨å¤–éƒ¨å‘½ä»¤</li>
<li>functionã€builtinã€keyword: è¿™äº›å‘½ä»¤ä¾èµ–äºshellè¿›ç¨‹ï¼Œæ²¡æœ‰shellè¿›ç¨‹ï¼Œä»–ä»¬éƒ½æ²¡æœ‰æ„ä¹‰ã€‚ä»–ä»¬éƒ½æ˜¯ç›´æ¥åœ¨å½“å‰shellè¿›ç¨‹å†…æ‰§è¡Œçš„ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„å­shellè¿›ç¨‹æ¥æ‰§è¡Œ</li>
<li>alias:åœ¨å‘½ä»¤è§£æé˜¶æ®µæ›¿æ¢æˆå¯¹åº”çš„å†…å®¹ï¼Œç„¶åé‡æ–°æ‰§è¡Œå‘½ä»¤è§£æ</li>
</ul>
<p>å½“aliasã€keywordã€functionã€builtionã€fileå†²çªæ—¶ï¼Œä¼šæŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œæ‰§è¡Œï¼Œä¼˜å…ˆçº§ä»å·¦è‡³å³ä¾æ¬¡é€’å‡ã€‚</p>
<p>å¯¹äºä½¿ç”¨å­shellæ–¹å¼æ‰§è¡Œcmd</p>
<ol>
<li>å½“å‰shellè¿›ç¨‹forkåˆ›å»ºä¸€ä¸ªå­shellè¿›ç¨‹ï¼Œå­shellç»§æ‰¿çˆ¶shellå¤§é‡å±æ€§ï¼Œå¦‚å˜é‡</li>
<li>å­shellè¿›ç¨‹é€šè¿‡execè°ƒç”¨æ‰§è¡Œcmd, å¹¶ç”¨cmdä»£ç æ›¿æ¢åˆšæ‰åˆ›å»ºçš„å­shellè¿›ç¨‹(å­shellè¿›ç¨‹ç»§æ‰¿è‡ªçˆ¶shellè¿›ç¨‹çš„å±æ€§ä¼šè¢«è¦†ç›–)ï¼Œäºæ˜¯å­shellè¿›ç¨‹å°±å˜æˆcmdè¿›ç¨‹ï¼Œæ‰€ä»¥çˆ¶shellçš„å­è¿›ç¨‹å˜æˆäº†cmdè¿›ç¨‹</li>
<li>çˆ¶shellè¿›ç¨‹waitå­cmdè¿›ç¨‹é€€å‡º</li>
</ol>
<p>ä¼ªä»£ç æè¿°å¦‚ä¸‹, ä»¥æ‰§è¡Œ<code>ls -lah</code>å‘½ä»¤ä¸ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pid &#x3D; fork();</span><br><span class="line">if(pid &#x3D;&#x3D; 0 ) &#123;</span><br><span class="line">    &#x2F;&#x2F;å­è¿›ç¨‹ä¸­ï¼Œè°ƒç”¨exec</span><br><span class="line">    exec(&quot;ls -lah&quot;)</span><br><span class="line">&#125; else if (pid &gt; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;çˆ¶è¿›ç¨‹ä¸­ï¼Œwaitpidç­‰å¾…å­è¿›ç¨‹é€€å‡º</span><br><span class="line">    waitpid(pid);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>$BASHPID</code>å¯ä»¥æŸ¥çœ‹å½“å‰bashè¿›ç¨‹çš„pidï¼Œä»è€Œåˆ¤æ–­åœ¨é‚£ä¸ªshell(çˆ¶è¿˜æ˜¯å­).</p>
<h1 id="shellå‘½ä»¤çš„è¿è¡Œç¯å¢ƒ"><a href="#shellå‘½ä»¤çš„è¿è¡Œç¯å¢ƒ" class="headerlink" title="shellå‘½ä»¤çš„è¿è¡Œç¯å¢ƒ"></a>shellå‘½ä»¤çš„è¿è¡Œç¯å¢ƒ</h1><p>æ¯ä¸ªshellè¿›ç¨‹æœ‰ä¸€ä¸ªè‡ªå·±çš„è¿è¡Œç¯å¢ƒï¼Œä¸åŒçš„shellè¿›ç¨‹æœ‰ä¸åŒçš„shellç¯å¢ƒã€‚shellè§£æå‘½ä»¤è¡Œã€è°ƒç”¨å‘½ä»¤è¡Œçš„è¿‡ç¨‹éƒ½åœ¨è¿™ä¸ªç¯å¢ƒä¸­å®Œæˆã€‚</p>
<p>shellè¿è¡Œç¯å¢ƒç”±é…ç½®æ–‡ä»¶æ¥å®Œæˆåˆå§‹åŒ–ï¼Œbashä¼šè¯»å–çš„é…ç½®æ–‡ä»¶æœ‰ï¼š</p>
<ul>
<li>/etc/profile</li>
<li>/etc/profile.d/*.sh</li>
<li>~/.bash_profile</li>
<li>~/.bashrc</li>
<li>/etc/bashrc</li>
</ul>
<p>shellåˆ†ä¸ºlogin shellã€non-login shellä¸interactive shellã€non-interactive shellï¼Œä¸åŒçš„shellåŠ è½½çš„é…ç½®æ–‡ä»¶æ˜¯ä¸åŒçš„ã€‚</p>
<p>ç¯å¢ƒä¸»è¦ä½“ç°åœ¨å¯¹ç¯å¢ƒçš„è®¾ç½®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºç¯å¢ƒçš„è®¾ç½®æœ‰ï¼š</p>
<ul>
<li><code>cd /tmp</code>è¡¨ç¤ºè®¾ç½®å½“å‰shellç¯å¢ƒçš„å·¥ä½œç›®å½•</li>
<li>shoptæˆ–setå‘½ä»¤è¿›è¡Œshellçš„åŠŸèƒ½è®¾ç½®ï¼Œå¯åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°ç›¸å…³è®¾ç½®</li>
<li>ç¯å¢ƒå˜é‡è®¾ç½®<ul>
<li>ä¸»è¦ç”¨äºshellè¿›ç¨‹å’Œå…¶å­è¿›ç¨‹ä¹‹é—´çš„æ•°æ®ä¼ é€’</li>
<li>å­è¿›ç¨‹ï¼ˆä¸ä»…ä»…æ˜¯å­shellè¿›ç¨‹ï¼‰å¯ä»¥ç»§æ‰¿çˆ¶shellç¯å¢ƒä¸­çš„ç¯å¢ƒå˜é‡</li>
<li>ç¯å¢ƒå˜é‡é€šå¸¸ä»¥å¤§å†™å­—æ¯å®šä¹‰ï¼Œéä¸€å®š</li>
<li>ä½¿ç”¨bashå†…ç½®å‘½ä»¤<code>export</code>å¯ä»¥å®šä¹‰ç¯å¢ƒå˜é‡</li>
<li>å‘½ä»¤å‰å®šä¹‰å˜é‡<code>var=value cmd</code>ï¼Œè¡¨ç¤ºå®šä¹‰ä¸€ä¸ªä¸“å±ç¯å¢ƒå˜é‡ï¼Œè¯¥ç¯å¢ƒå˜é‡åªèƒ½åœ¨cmdè¿›ç¨‹ç¯å¢ƒä¸­å¯ä»¥è®¿é—®ï¼Œcmdè¿›ç¨‹é€€å‡ºåï¼Œvarç¯å¢ƒå˜é‡ä¹Ÿæ¶ˆå¤±</li>
</ul>
</li>
<li><code>export var=value</code>è¡¨ç¤ºåœ¨å½“å‰shellç¯å¢ƒä¸‹å®šä¹‰ä¸€ä¸ªç¯å¢ƒå˜é‡varï¼Œä»¥ä¾¿è®©å­è¿›ç¨‹ç»§æ‰¿è¿™ä¸ªå˜é‡</li>
</ul>
<p>æ¯å½“æåˆ°shellå†…ç½®å‘½ä»¤ï¼Œå°±è¦æƒ³åˆ°è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨æœ‰å¯èƒ½æ˜¯åœ¨å½“å‰shellç¯å¢ƒä¸‹è¿›è¡ŒæŸé¡¹è®¾ç½®<br>shellå†…ç½®å‘½ä»¤ä¸ä¼šåˆ›å»ºæ–°è¿›ç¨‹ï¼Œè€Œæ˜¯ç›´æ¥åœ¨å½“å‰shellç¯å¢ƒå†…éƒ¨æ‰§è¡Œ<br>å†…ç½®å‘½ä»¤<code>source</code>æˆ–<code>.</code>æ‰§è¡Œè„šæœ¬æ—¶ï¼Œè¡¨ç¤ºåœ¨å½“å‰shellç¯å¢ƒä¸‹æ‰§è¡Œè„šæœ¬å†…å®¹ï¼Œå³è„šæœ¬ä¸­æ‰€æœ‰è®¾ç½®æ“ä½œéƒ½ä¼šç›´æ¥ä½œç”¨äºå½“å‰shellç¯å¢ƒ<br>çˆ¶shellç¯å¢ƒå¯èƒ½å½±å“å­shellç¯å¢ƒï¼Œä½†å­shellç¯å¢ƒä¸€å®šä¸å½±å“çˆ¶shellç¯å¢ƒï¼Œæ¯”å¦‚å­shellè„šæœ¬ä¸­çš„ç¯å¢ƒå˜é‡ä¸ä¼šç²˜æ»åˆ°çˆ¶shellç¯å¢ƒä¸­</p>
<h2 id="shellç¯å¢ƒ-å±æ€§è®¾ç½®"><a href="#shellç¯å¢ƒ-å±æ€§è®¾ç½®" class="headerlink" title="shellç¯å¢ƒ/å±æ€§è®¾ç½®"></a>shellç¯å¢ƒ/å±æ€§è®¾ç½®</h2><p><code>bash</code>ä¹Ÿæ˜¯ä¸€ä¸ªç¨‹åºï¼Œä¸€ä¸ªå‘½ä»¤ï¼Œå®ƒå¯ä»¥é€šè¿‡è®¾ç½®é€‰é¡¹æ¥ä¿®æ”¹å…¶æŸäº›å±æ€§ï¼Œè¿™äº›å±æ€§å¯ä»¥æé«˜bashçš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<ul>
<li>-u        é‡åˆ°æœªå®šä¹‰çš„å˜é‡æŠ›å‡ºé”™è¯¯ï¼Œbashé»˜è®¤å¿½ç•¥å®ƒï¼Œå½“ä½œç©ºæ¥å¤„ç†</li>
<li>-x        æ˜¾ç¤ºbashæ‰§è¡Œçš„æ‰§è¡Œå‘½ä»¤ï¼Œåœ¨å‰é¢ç”¨<code>+</code>æ¥åŒºåˆ†å‘½ä»¤å’Œå‘½ä»¤çš„è¾“å‡ºï¼›å¦‚æœé‡åˆ°-uçš„é”™è¯¯ï¼Œä¸ä¼šæ‰“å°è¯¥å‘½ä»¤(æµ‹è¯•æ‰€å¾—)</li>
<li>-e        è„šæœ¬å‘ç”Ÿé”™è¯¯ï¼Œç»ˆæ­¢æ‰§è¡Œ</li>
</ul>
<p>è¿™é‡Œæ³¨æ„ä¸€ä¸ªç‰¹æ®Šåœºæ™¯å³ç®¡é“å‘½ä»¤ï¼Œbashä¼šæŠŠç®¡é“å‘½ä»¤æœ€åä¸€ä¸ªå­å‘½ä»¤çš„è¿”å›å€¼ä½œä¸ºæ•´ä¸ªå‘½ä»¤çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æœ€åä¸€ä¸ªå‘½ä»¤ä¸å¤±è´¥ï¼Œç®¡é“å‘½ä»¤æ€»æ˜¯ä¼šæ‰§è¡ŒæˆåŠŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -eux</span><br><span class="line">demo | echo adsad</span><br><span class="line">echo afe</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤„<code>demo</code>æœªå®šä¹‰ï¼Œæ‰§è¡Œå¤±è´¥ï¼Œä½†æ˜¯<code>echo adsad</code>ä¼šæ‰§è¡ŒæˆåŠŸï¼Œæ‰€ä»¥ç®¡é“å‘½ä»¤<code>demo | echo adsad</code>çš„è¿”å›å€¼æ˜¯<code>0</code>,è„šæœ¬æ¥ä¸‹æ¥çš„å‘½ä»¤<code>echo afe</code>ä¼šç»§ç»­æ‰§è¡Œï¼Œ<code>set -e</code>åœ¨è¿™é‡Œå°±å¤±æ•ˆäº†ã€‚ä½¿ç”¨<code>set -o pipefaile</code>å¯ä»¥è§£å†³è¿™ç§æƒ…å†µï¼Œåªè¦ä¸€ä¸ªå­å‘½ä»¤å¤±è´¥ï¼Œæ•´ä¸ªç®¡é“å‘½ä»¤å°±å¤±è´¥ï¼Œè„šæœ¬å°±ä¼šç»ˆæ­¢æ‰§è¡Œã€‚æ³¨æ„é…åˆ<code>set -e</code>ä¸€èµ·ä½¿ç”¨æ‰ä¼šç”Ÿæ•ˆï¼Œå³<code>set -o pipeline</code>æ˜¯<code>set -e</code>çš„ä¸€ä¸ªè¡¥ä¸ã€‚</p>
<p>å…»æˆå¥½ä¹ æƒ¯ï¼Œåœ¨æ‰€æœ‰bashè„šæœ¬å¼€å¤´åŠ ä¸Š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set -euxo pipefail</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæœ‰æ„è®©é€€å‡ºçŠ¶æ€ä¸ä¸º0çš„ç¨‹åºä½¿ç”¨<code>cmd || true</code></p>
<p>æ­¤å¤–ï¼Œshellå¯ä»¥å…³é—­æ¨¡å¼æ‰©å±•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set -o noglob</span><br><span class="line">æˆ–è€…</span><br><span class="line">set -f</span><br></pre></td></tr></table></figure>

<h1 id="å…³äºå¼•å·"><a href="#å…³äºå¼•å·" class="headerlink" title="å…³äºå¼•å·"></a>å…³äºå¼•å·</h1><p>å­shellå’Œshellç¯å¢ƒæ˜¯shellæœºåˆ¶æ–¹é¢çš„æ ¸å¿ƒï¼Œå…¶å®å¼•å·åœ¨shellä¸­çš„é‡è¦æ€§ä¸ä¹‹å¯æ¯”è‚©ã€‚<br>åœ¨è®¸å¤šç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¼•å·è¢«ç”¨æ¥è¡¨æ˜ï¼šåŒ…å«åœ¨é‡Œé¢çš„æ–‡æœ¬ä¼šè¢«è§£ææˆå­—ç¬¦ä¸²ã€‚ä½†æ˜¯åœ¨shellä¸­ï¼Œåªæœ‰ä¸€ç§æ•°æ®ç±»å‹å°±æ˜¯å­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œå­—ç¬¦ä¸²ç›¸å…³çš„å¼•å·å’Œè½¬ä¹‰ï¼Œå¯¹bashæ¥è¯´å°±éå¸¸é‡è¦ã€‚</p>
<p>å¼•å·çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>é˜²æ­¢ä¿ç•™å­—ç¬¦è¢«æ›¿æ¢ï¼Œå¦‚<code>echo &#39;$&#39;</code></li>
<li>é˜²æ­¢åŸŸåˆ†å‰²å’Œé€šé…ç¬¦ï¼Œå¦‚åŒ…å«ç©ºæ ¼çš„æ–‡ä»¶å</li>
<li>å‚æ•°æ‰©å±•ï¼Œå¦‚<code>&quot;$@&quot;</code></li>
</ul>
<p>æœ‰ä¸‰ç§æ ‡å‡†çš„å¼•å·(å¦‚æœç®—ä¸Šè½¬ä¹‰æ˜¯4ç§)ï¼Œå’Œ2ç§éæ ‡å‡†çš„bashæ‰©å±•ç”¨æ³•ã€‚</p>
<ul>
<li>å•å¼•å·(single quotes)ï¼šç§»é™¤åœ¨å•å¼•å·ä¹‹é—´æ‰€æœ‰å­—ç¬¦çš„ç‰¹æ®Šå«ä¹‰, é¿å…è¢«bashè‡ªåŠ¨æ‰©å±•ã€‚å•å¼•å·ä¹‹é—´çš„æ‰€æœ‰ä¸œä¸œéƒ½ä¼šå˜æˆå­—ç¬¦ä¸²(literal string)ï¼Œå”¯ä¸€ä¸èƒ½å®‰å…¨çš„è¢«å•å¼•å·ä¿®é¥°çš„å­—ç¬¦å°±æ˜¯å•å¼•å·æœ¬èº«ï¼Œå³ä½¿ä½¿ç”¨äº†è½¬ä¹‰ç¬¦ä¹Ÿä¸è¡Œ</li>
<li>åŒå¼•å·(double quotes)ï¼šåŒå¼•å·ä¸­ä¸ä¼šè¿›è¡Œæ–‡ä»¶åæ‰©å±•ï¼Œä½†æ˜¯ä¸‰ä¸ªå­—ç¬¦é™¤å¤–<code>$</code> <code>åå¼•å·</code> <code>\</code>ï¼Œå¦‚æœå¼€å¯äº†<code>!</code>å¼•ç”¨å†å²å‘½ä»¤ï¼Œåˆ™<code>!</code>ä¹Ÿé™¤å¤–ã€‚å¤§éƒ¨åˆ†ç‰¹æ®Šå­—ç¬¦åœ¨åŒå¼•å·ä¸­ä¼šå¤±å»ç‰¹æ®Šå«ä¹‰ï¼Œå˜æˆæ™®é€šå­—ç¬¦ï¼Œå¦‚<code>*</code></li>
<li>åå¼•å·(<code>backticks</code>)ï¼šè¿™æ˜¯å‘½ä»¤æ›¿æ¢è¯­æ³•çš„é—äº§ï¼Œç°åœ¨ä½¿ç”¨<code>$(...)</code>æ›¿ä»£ï¼Œä½†å› ä¸ºå†å²é—®é¢˜ï¼Œç°åœ¨ä¾ç„¶è¢«å…è®¸ä½¿ç”¨</li>
<li>è½¬ä¹‰ç¬¦()ï¼šå°†<code>\</code>æ”¾åœ¨å…ƒå­—ç¬¦($ã€&amp;ã€*ã€)å‰é¢å»æ‰å…¶ç‰¹æ®Šå«ä¹‰ï¼Œå¦‚ <code>echo \$ï¼Ÿ</code>, åœ¨åŒå¼•å·å’Œæ²¡æœ‰å¼•å·ä¸­æœ‰æ•ˆï¼Œåœ¨å•å¼•å·ä¸­æ— æ•ˆ.åæ–œæ é™¤äº†ç”¨äºè½¬ä¹‰ï¼Œè¿˜å¯ä»¥è¡¨ç¤ºä¸€äº›ä¸å¯æ‰“å°çš„å­—ç¬¦<ul>
<li>\a    å“é“ƒ</li>
<li>\b    é€€æ ¼</li>
<li>\n    æ¢è¡Œ</li>
<li>\r    å›è½¦</li>
<li>\t    åˆ¶è¡¨ç¬¦<br>æ‰€ä»¥åœ¨å‘½ä»¤ç»“å°¾ç»“å°¾åŠ ä¸Š<code>\</code>ï¼Œå…¶å®å°±æ˜¯åœ¨æ¢è¡Œç¬¦å‰åŠ ä¸Šè½¬ä¹‰ï¼Œä½¿å¾—æ¢è¡Œç¬¦å˜æˆä¸€ä¸ªæ™®é€šå­—ç¬¦ï¼Œbashä¼šå°†å…¶å½“ä½œç©ºæ ¼å¤„ç†ï¼Œä»è€Œå¯ä»¥å°†ä¸€è¡Œå‘½ä»¤å†™æˆå¤šè¡Œã€‚</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œä¸¾ä¸€ä¸ª<code>find</code>ä½¿ç”¨çš„å°ä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho test]$ ls</span><br><span class="line">a.c  c  deb  kernel  linux  make  python  shell</span><br><span class="line"></span><br><span class="line">[rancho test]$ find .&#x2F; -name &quot;*.c&quot;</span><br><span class="line">.&#x2F;shell&#x2F;a.c</span><br><span class="line">.&#x2F;shell&#x2F;b.c</span><br><span class="line">.&#x2F;a.c</span><br><span class="line">.&#x2F;deb&#x2F;zhw-1.0.0&#x2F;a.c</span><br><span class="line">.&#x2F;python&#x2F;a.c</span><br><span class="line">.&#x2F;linux&#x2F;a.c</span><br><span class="line">.&#x2F;c&#x2F;syntax.c</span><br><span class="line"></span><br><span class="line">[rancho test]$ find .&#x2F; -name *.c</span><br><span class="line">.&#x2F;shell&#x2F;a.c</span><br><span class="line">.&#x2F;a.c</span><br><span class="line">.&#x2F;deb&#x2F;zhw-1.0.0&#x2F;a.c</span><br><span class="line">.&#x2F;python&#x2F;a.c</span><br><span class="line">.&#x2F;linux&#x2F;a.c</span><br><span class="line">[rancho test]$ </span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€æ¬¡ä½¿ç”¨findï¼Œä¼ ç»™å®ƒçš„å‚æ•°æ˜¯<code>*.c</code>ï¼Œfindä¼šåœ¨å½“å‰ç›®å½•ä¸‹é¢å»æ‰¾æ‰€æœ‰ä»¥<code>.c</code>ç»“å°¾çš„æ–‡ä»¶<br>ç¬¬äºŒæ¬¡ä½¿ç”¨find, ä¼ ç»™å®ƒçš„å‚æ•°æ˜¯<code>a.c</code>ï¼Œæ³¨æ„å½“å‰ç›®å½•ä¸‹é¢æœ‰<code>a.c</code>ï¼Œæ‰€ä»¥<code>*.c</code>ä¼šè¢«shellæ¨¡å¼æ‰©å±•ä¸º<code>a.c</code>ï¼›å¦‚æœå½“å‰ç›®å½•ä¸‹æ²¡æœ‰<code>.c</code>æ–‡ä»¶ï¼Œåˆ™æ‰©å±•å¤±è´¥ï¼ŒåŸæ ·è¾“å‡º<code>*.c</code>ï¼Œè¿™æ—¶å€™å’Œç”¨åŒå¼•å·ä¿®é¥°æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚<br>shellæ¨¡å¼æ‰©å±•å®Œä¹‹åæ‰ä¼šè°ƒç”¨å‘½ä»¤ï¼Œæ‰€ä»¥ä¸€å®šè¦ä¸»è¦å“ªäº›è¯å…ƒæ˜¯ç»™shellåšæ¨¡å¼æ‰©å±•çš„ï¼Œå“ªäº›æ˜¯ç›´æ¥ä¼ é€’ç»™å‘½ä»¤çš„ï¼Œæˆ‘ä»¬é€šè¿‡å¼•å·è¿›è¡Œæ ‡è¯†å‘ŠçŸ¥bashã€‚</p>
<h1 id="shellæ ¸å¿ƒçŸ¥è¯†ç‚¹"><a href="#shellæ ¸å¿ƒçŸ¥è¯†ç‚¹" class="headerlink" title="shellæ ¸å¿ƒçŸ¥è¯†ç‚¹"></a>shellæ ¸å¿ƒçŸ¥è¯†ç‚¹</h1><p>æœ€å¼€å§‹æ˜¯æƒ³è®°å½•ä¸‹<code>å­shell</code>ä¸<code>shellç¯å¢ƒ</code>è¿™ä¸¤ä¸ªçŸ¥è¯†ç‚¹çš„ï¼Œåæ¥è¶Šæ¥è¶Šå¤šçš„å‘ç°è‡ªå·±ä¸çŸ¥é“æŸäº›çŸ¥è¯†ç‚¹æˆ–è€…çŸ¥è¯†ç‚¹è®¤è¯†æ¨¡ç³Šï¼Œshellç¬”è®°ä¹Ÿæœ‰å¥½å‡ ä¸ªæ–‡ä»¶äº†ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ä¸‹shellä¸­æ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ç‚¹ã€‚</p>
<ul>
<li>å­shell</li>
<li>shellå‘½ä»¤æ‰§è¡Œç¯å¢ƒ</li>
<li>æ¨¡å¼æ‰©å±•(é€šé…ç¬¦æ‰©å±•ã€å˜é‡æ‰©å±•ã€å­å‘½ä»¤æ‰©å±•ã€ç®—æœ¯æ‰©å±•)ï¼Œexpansionï¼Œglobbing and word splitting</li>
<li>å¼•ç”¨(å¼•å·å’Œè½¬ä¹‰)</li>
<li>shellå˜é‡(å˜é‡å¼•ç”¨ï¼Œå˜é‡æ›¿æ¢)</li>
<li>é€€å‡ºå’Œé€€å‡ºçŠ¶æ€</li>
<li>å„ç§test(æ–‡ä»¶æµ‹è¯•ã€å­—ç¬¦ä¸²æµ‹è¯•ã€æ•°å€¼æµ‹è¯•)</li>
<li>å¾ªç¯å’Œåˆ†æ”¯</li>
<li>shellcheck   è¿™ä¸ªå¹¶ä¸æ˜¯shellçš„çŸ¥è¯†ç‚¹ï¼Œè€Œæ˜¯ä¸€ä¸ªshellè„šæœ¬çš„æ£€æŸ¥å·¥å…·ï¼Œpythonï¼ŒCéƒ½æœ‰è¿™ç§æ£€æŸ¥å·¥å…·ï¼Œå¯ä»¥å¾ˆå¥½çš„å¸®æˆ‘ä»¬æ£€æŸ¥ä¸€äº›é€šç”¨çš„æ˜“é”™çš„è¯­æ³•é—®é¢˜ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨</li>
</ul>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://wangdoc.com/bash/">Bashè„šæœ¬æ•™ç¨‹</a><br><a href="https://google.github.io/styleguide/shellguide.html">Google shellè„šæœ¬ä»£ç è§„æ³•</a><br><a href="https://coolshell.cn/articles/19219.html">æ‰“é€ é«˜æ•ˆå·¥ä½œç¯å¢ƒ-shellç¯‡</a></p>
]]></content>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>shellè„šæœ¬æ‰§è¡Œçš„å‡ ç§æ–¹å¼</title>
    <url>/2021/02/20/shell%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h1 id="shellè„šæœ¬æ‰§è¡Œçš„å‡ ç§æ–¹å¼"><a href="#shellè„šæœ¬æ‰§è¡Œçš„å‡ ç§æ–¹å¼" class="headerlink" title="shellè„šæœ¬æ‰§è¡Œçš„å‡ ç§æ–¹å¼"></a>shellè„šæœ¬æ‰§è¡Œçš„å‡ ç§æ–¹å¼</h1><p>shellè„šæœ¬æœ‰ä¸‰ç§æ‰§è¡Œæ–¹å¼</p>
<span id="more"></span>
<h2 id="filename-æˆ–-filename"><a href="#filename-æˆ–-filename" class="headerlink" title="./filename æˆ– filename"></a>./filename æˆ– filename</h2><p>è¿™ç§æ–¹å¼æ˜¯æˆ‘ä»¬åœ¨CLIä¸­æœ€å¸¸ä½¿ç”¨çš„æ–¹å¼ï¼Œè¦æ±‚è„šæœ¬å…·æœ‰<em>å¯æ‰§è¡Œ</em>æƒé™ã€‚ç±»ä¼¼äºæ‰§è¡ŒäºŒè¿›åˆ¶ç¨‹åºï¼Œéœ€è¦è®©shellæ‰¾åˆ°æ–‡ä»¶çš„å…·ä½“ä½ç½®ã€‚è¿™ç§æ‰§è¡Œæ–¹å¼æ˜¯é‡æ–°å¯åŠ¨ä¸€ä¸ªå­shellï¼Œåœ¨å­shellä¸­æ‰§è¡Œæ­¤è„šæœ¬ã€‚å­shellç»§æ‰¿çˆ¶shellçš„ç¯å¢ƒå˜é‡ï¼Œä½†å­shellæ–°å»ºçš„ã€æ”¹å˜çš„å˜é‡ä¸ä¼šå¸¦å›çˆ¶shellï¼Œé™¤éä½¿ç”¨exportã€‚</p>
<h2 id="source-filename-æˆ–-filename"><a href="#source-filename-æˆ–-filename" class="headerlink" title="source filename æˆ– . filename"></a>source filename æˆ– . filename</h2><p>è¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨åœ¨è„šæœ¬ä¸­å®šä¹‰shellç¯å¢ƒå˜é‡ï¼Œæ¯”å¦‚ä¿®æ”¹<code>.bashrc</code>åä½¿ç”¨sourceæ‰§è¡Œä¸€ä¸‹ï¼Œå°†æ”¹åŠ¨ç”Ÿæ•ˆåˆ°å½“å‰shellä¸­ã€‚<br>è¿™ä¸ªå‘½ä»¤å…¶å®åªæ˜¯ç®€å•çš„è¯»å–è„šæœ¬é‡Œé¢çš„è¯­å¥ä¾æ¬¡åœ¨å½“å‰shellé‡Œé¢æ‰§è¡Œï¼Œæ²¡æœ‰æ–°å»ºå­shellã€‚è„šæœ¬é‡Œé¢æ‰€æœ‰æ–°å»ºã€æ”¹å˜å˜é‡çš„è¯­å¥éƒ½ä¼šä¿å­˜åœ¨å½“å‰shellé‡Œé¢ã€‚</p>
<h2 id="bash-filename-æˆ–-sh-filenameï¼Œä¸¤è€…ç­‰æ•ˆ"><a href="#bash-filename-æˆ–-sh-filenameï¼Œä¸¤è€…ç­‰æ•ˆ" class="headerlink" title="bash filename æˆ– sh filenameï¼Œä¸¤è€…ç­‰æ•ˆ"></a>bash filename æˆ– sh filenameï¼Œä¸¤è€…ç­‰æ•ˆ</h2><p>è¿™ç§æ–¹å¼ä¸./filenameæ‰§è¡Œæ–¹å¼çš„å”¯ä¸€åŒºåˆ«æ˜¯ï¼Œfilenameä¸éœ€è¦å¯æ‰§è¡Œæƒé™ã€‚</p>
<h1 id="å…³äº-0å’ŒBASH-SOURCE"><a href="#å…³äº-0å’ŒBASH-SOURCE" class="headerlink" title="å…³äº$0å’ŒBASH_SOURCE"></a>å…³äº$0å’ŒBASH_SOURCE</h1><p><code>$0</code>ä¿å­˜äº†è¢«æ‰§è¡Œè„šæœ¬çš„ç¨‹åºåç§°, åœ¨è„šæœ¬ä¸­<code>basename $0</code>å¯ä»¥è·å–è„šæœ¬çš„æ–‡ä»¶åã€‚ç”¨sourceæ–¹å¼æ‰§è¡Œçš„è„šæœ¬ä¸é€‚ç”¨ï¼Œ$0ä¸º<code>-bash</code>ã€‚<br>ä½†æ˜¯ï¼Œé™¤äº†$0ä¹‹å¤–ï¼Œbashè¿˜æä¾›äº†ä¸€ä¸ªæ•°ç»„å˜é‡<code>BASH_SOURCE</code>,ç¨‹åºåä»¥å…¥æ ˆçš„æ–¹å¼å­˜å‚¨åœ¨BASH_SOURCEä¸­ï¼Œå³æœ€åä¸€ä¸ªæ‰§è¡Œçš„è„šæœ¬æ˜¯BASH_SOURCE[0]æˆ–BASH_SOURCEï¼Œç­‰ä»·äº$0ã€‚<br>åœ¨åµŒå¥—è„šæœ¬çš„è°ƒç”¨ä¸­ï¼Œä½¿ç”¨<code>BASH_SOURCE[0]</code>è·å–å½“å‰è„šæœ¬çš„è·¯å¾„ï¼Œä½¿ç”¨<code>BASH_SOURCE[-1]</code>æˆ–<code>$0</code>è·å–é¡¶å±‚è„šæœ¬çš„è·¯å¾„</p>
]]></content>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>shellè¯­æ³•ç®€æ</title>
    <url>/2021/02/20/shell%E8%AF%AD%E6%B3%95%E7%AE%80%E6%9E%90/</url>
    <content><![CDATA[<h1 id="é—®é¢˜è¯´æ˜"><a href="#é—®é¢˜è¯´æ˜" class="headerlink" title="é—®é¢˜è¯´æ˜"></a>é—®é¢˜è¯´æ˜</h1><p>åœ¨shellä¸‹é‡åˆ°ä¸€ä¸ªèµ‹å€¼çš„é—®é¢˜</p>
<span id="more"></span>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho ~]$ a&#x3D;10</span><br><span class="line">[rancho ~]$ demo$a&#x3D;$(echo 123)</span><br><span class="line">demo10&#x3D;123: command not found</span><br></pre></td></tr></table></figure>

<h1 id="shellä¸‹çš„å‘½ä»¤æ ¼å¼"><a href="#shellä¸‹çš„å‘½ä»¤æ ¼å¼" class="headerlink" title="shellä¸‹çš„å‘½ä»¤æ ¼å¼"></a>shellä¸‹çš„å‘½ä»¤æ ¼å¼</h1><p>shellä¸‹æˆ‘ä»¬å¸¸ç”¨çš„å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var&#x3D;value           #å˜é‡èµ‹å€¼ï¼Œä¾‹å¦‚a&#x3D;1</span><br><span class="line">cmd [args]          #å‘½ä»¤æ‰§è¡Œï¼Œä¾‹å¦‚ls -l</span><br><span class="line">&gt;redirection        #é‡å®šå‘,ä¾‹å¦‚:&gt;a.c </span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šï¼Œbashä¸­çš„ä¸€ä¸ªç®€å•å‘½ä»¤çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var&#x3D;value ... cmd args &gt;redirection ...</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªå®Œæ•´çš„ç®€å•å‘½ä»¤ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šå˜é‡èµ‹å€¼éƒ¨åˆ†ã€å‘½ä»¤å’Œå‚æ•°éƒ¨åˆ†ã€é‡å®šå‘éƒ¨åˆ†ï¼Œåªæ˜¯å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šçœç•¥ä¸€äº›éƒ¨åˆ†çš„å†…å®¹ã€‚<br>å…¶ä¸­ï¼š</p>
<ul>
<li>å˜é‡èµ‹å€¼å’Œé‡å®šå‘å¯ä»¥æœ‰å¤šä¸ª</li>
<li>å˜é‡èµ‹å€¼å¿…é¡»åœ¨cmdå‰é¢ï¼Œå¹¶ä¸”å˜é‡åå¿…é¡»ç¬¦åˆbashè¦æ±‚çš„å‘½ä»¤è§„åˆ™<ul>
<li>å®šä¹‰å˜é‡æ—¶ï¼Œæ™®é€šå˜é‡åæ˜¯å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿çš„ç»„åˆï¼Œä¸”ä¸èƒ½ä»¥æ•°å­—å¼€å¤´</li>
<li>è°ƒç”¨å˜é‡æ—¶ï¼Œåœ¨å˜é‡åå‰åŠ <code>$</code>ï¼Œshellæœ‰ä¸€éƒ¨åˆ†ç‰¹æ®Šå˜é‡å¦‚<code>$0 $1 $$</code></li>
</ul>
</li>
</ul>
<p>å¯¹äºå˜é‡èµ‹å€¼ï¼š</p>
<ul>
<li>å¦‚æœæœ‰å˜é‡èµ‹å€¼è€Œæ²¡æœ‰å‘½ä»¤æ‰§è¡Œéƒ¨åˆ†ï¼Œåˆ™å˜é‡èµ‹å€¼åœ¨å½“å‰shellä¸‹ç”Ÿæ•ˆ</li>
<li>å¦‚æœæœ‰å˜é‡èµ‹å€¼ä¹Ÿæœ‰å‘½ä»¤æ‰§è¡Œéƒ¨åˆ†ï¼Œåˆ™å˜é‡èµ‹å€¼åªä½œç”¨äºæ”¹å‘½ä»¤ï¼Œå¯¹å½“å‰shellæ— å½±å“</li>
<li>å¦‚æœå˜é‡åä¸ç¬¦åˆbashçš„å‘½ä»¤è§„èŒƒï¼Œåˆ™ä¸è®¤ä¸ºæ˜¯å˜é‡èµ‹å€¼è¯­å¥ï¼Œè€Œæ˜¯å½“ä½œcmdéƒ¨åˆ†</li>
</ul>
<h1 id="é—®é¢˜è¯´æ˜-1"><a href="#é—®é¢˜è¯´æ˜-1" class="headerlink" title="é—®é¢˜è¯´æ˜"></a>é—®é¢˜è¯´æ˜</h1><p><code>demo$a</code>ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å˜é‡åï¼Œæ‰€ä»¥ä¼šå½“ä½œcmdæ¥æ‰§è¡Œï¼Œä½†æ˜¯åœ¨æ‰§è¡Œä¹‹å‰ä¼šä»å·¦åˆ°å³æ‰§è¡Œshellå‘½ä»¤è§£æè§„åˆ™ï¼Œå¾—åˆ°<code>demo10=123</code>ï¼Œä¹‹åå°†å…¶ä½œä¸ºå‘½ä»¤è¿›è¡Œæ‰§è¡Œï¼Œæ‰¾ä¸åˆ°æ”¹å‘½ä»¤ä»è€ŒæŠ¥é”™ã€‚ç±»ä¼¼çš„ï¼Œè¾“å…¥<code>123das=10</code>ä¹Ÿä¼šæŠ¥è¿™ç§é”™è¯¯ã€‚</p>
]]></content>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>shellé‡å®šå‘</title>
    <url>/2021/02/23/shell%E9%87%8D%E5%AE%9A%E5%90%91/</url>
    <content><![CDATA[<h1 id="shellé‡å®šå‘"><a href="#shellé‡å®šå‘" class="headerlink" title="shellé‡å®šå‘"></a>shellé‡å®šå‘</h1><p>shellé‡å®šå‘å³é‡æ–°ç¡®å®šæ•°æ®çš„æµå‘ï¼Œæ˜¯é€šè¿‡æ”¹å˜æ–‡ä»¶æè¿°ç¬¦ç›®æ ‡æ¥å®ç°çš„ï¼Œå¦‚æµå‘<code>1</code>çš„æ•°æ®è®©å…¶æµå‘<code>/tmp/a.c</code>ã€‚</p>
<span id="more"></span>
<p>shellä¸­ï¼ŒåŸºç¡€é‡å®šå‘æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p>
<ul>
<li><p><code>[n]&gt;file</code>ï¼šè¦†ç›–å¼è¾“å‡ºé‡å®šå‘ï¼Œè¾“å‡ºåˆ°fd=nçš„æ•°æ®æ”¹å˜æµå‘è¾“å‡ºåˆ°fileæ–‡ä»¶ä¸­ï¼Œfileä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œfileå­˜åœ¨åˆ™å…ˆæ¸…ç©ºå†å†™å…¥æ•°æ®</p>
<ul>
<li>nå¯çœç•¥ï¼Œé»˜è®¤å€¼ä¸º<code>1</code>ï¼Œå³æ ‡å‡†è¾“å‡ºè¦†ç›–é‡å®šå‘åˆ°fileä¸­</li>
<li><code>&gt;&gt;</code>è¡¨ç¤ºè¿½åŠ å¼è¾“å‡ºé‡å®šå‘</li>
</ul>
</li>
<li><p><code>[n]&lt;file</code>:è¾“å…¥é‡å®šå‘ï¼Œä»¥è¯»å–æ¨¡å¼æ‰“å¼€æ–‡ä»¶å¹¶åˆ†é…fd=n,fileä¸å­˜åœ¨åˆ™æŠ¥é”™</p>
<ul>
<li>nå¯çœç•¥ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œå³ç›´æ¥å†²fileä¸­è¯»æ•°æ®</li>
<li>é€šå¸¸ç¨‹åºåªæ˜¯ä»0ä¸­éƒ½æ•°æ®ï¼Œæ‰€ä»¥å½“nä¸ç­‰äº0æ—¶ï¼Œéœ€è¦å¤šåšä¸€æ­¥<code>3&lt;file &lt;&amp;3</code></li>
</ul>
</li>
</ul>
<p><code>cat</code>å‘½ä»¤ä¸­ç»å¸¸ä½¿ç”¨åˆ°é‡å®šå‘ï¼Œè¦æ˜ç™½<code>cat file</code>å’Œ<code>cat &lt;file</code>çš„åŒºåˆ«ã€‚catå‘½ä»¤ä¼šè¯»å–æŒ‡å®šçš„æ–‡ä»¶ç„¶åè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°å­—ç¬¦ï¼Œç„¶åè¾“å‡ºå­—ç¬¦ã€‚<code>cat file</code>æ˜¯ç›´æ¥è¯»å–fileè¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œ<code>cat &lt;file</code>æ˜¯fileæ–‡ä»¶è¢«è¯»å–åå†…å®¹é‡å®šå‘åˆ°æ ‡å‡†è¾“å…¥ï¼Œç„¶åcatä»æ ‡å‡†è¾“å…¥è¯»å–åˆ°é‡Œé¢çš„æ•°æ®ï¼Œè™½ç„¶ç»“æœéƒ½ä¸€æ ·ï¼Œä½†æ˜¯é‡Œé¢çš„å†…å®¹ä¸ä¸€æ ·ã€‚ä¸€ä¸ªå¾ˆç»å…¸çš„åœ¨shellè„šæœ¬ä¸­åˆ›å»ºé…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF&gt;a.c           #è¿™ä¸€è¡Œçš„EOFè¡¨ç¤ºdocçš„èµ·å§‹ç¬¦</span><br><span class="line">zhw</span><br><span class="line">wan</span><br><span class="line">EOF                     #è¿™ä¸€è¡Œçš„docè¡¨ç¤ºdocçš„ç»ˆæ­¢ç¬¦ï¼Œå‰åå¿…é¡»ä¸€è‡´</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œè¾“å…¥é‡å®šå‘æ˜¯<code>&lt;</code>ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰<code>&lt;&lt;</code>ä¸<code>&lt;&lt;&lt;</code>ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¹Ÿå°±ç”¨åˆ°<code>&lt;&lt;</code>.<br><code>&lt;&lt;</code>ç¬¦å·è¡¨ç¤ºhere docã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒåé¢è·Ÿçš„æ˜¯ä¸€ç¯‡æ–‡æ¡£ï¼Œå°±åƒä¸€ä¸ªæ–‡ä»¶ä¸€æ ·ï¼Œåªä¸è¿‡è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹æ˜¯ä¸´æ—¶å®šä¹‰åœ¨<code>&lt;&lt;</code>ç¬¦å·åé¢çš„ã€‚here docå¸¸ç”¨è¯­æŒ‡å®šå¤šè¡Œæ•°æ®è¾“å…¥ã€‚<br>æ—¢ç„¶æ˜¯æ–‡æ¡£ï¼Œå°±æœ‰æ–‡æ¡£çš„èµ·å§‹ç¬¦å’Œç»ˆæ­¢ç¬¦ï¼Œè¿™ä¸­é—´çš„å†…å®¹å…¨éƒ¨æ˜¯æ–‡æ¡£çš„å†…å®¹ï¼Œæ–‡æ¡£å†…å®¹ä¼šè¢«ä½œä¸ºæ ‡å‡†è¾“å…¥çš„æ•°æ®è¯»å–ã€‚èµ·å§‹ç¬¦å’Œç»ˆæ­¢ç¬¦å¯ä»¥éšæ„å®šä¹‰ï¼Œä½†æ˜¯å‰åå¿…é¡»ä¸€è‡´ï¼Œä¸€èˆ¬ç”¨<code>EOF</code>æ¥è¡¨ç¤ºã€‚</p>
<p><code>&lt;&lt;&lt;</code>è¡¨ç¤ºhere string,å³åé¢è·Ÿçš„æ˜¯å­—ç¬¦ä¸²ï¼Œæ³¨æ„</p>
<ul>
<li>åŒå¼•å·åŒ…å›´çš„å­—ç¬¦ä¸²shellä¼šå¯¹å…¶è¿›è¡Œè§£é‡Š</li>
<li>å•å¼•å·åŒ…å›´çš„å­—ç¬¦ä¸²shellä¸ä¼šå¯¹å…¶è¿›è¡Œè§£é‡Š</li>
</ul>
<p>åœ¨è„šæœ¬ä¸­åˆ›å»ºé…ç½®æ–‡ä»¶è¿˜å¯ä»¥ä½¿ç”¨<code>tee</code>å‘½ä»¤,teeä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ•°æ®ï¼Œç„¶åå†™åˆ°æ ‡å‡†è¾“å‡ºå’Œ0æˆ–å¤šä¸ªæ–‡ä»¶ä¸­å»ã€‚æ¢è¨€ä¹‹ï¼Œteeå¯ä»¥å®ç°æ•°æ®å¤šé‡å®šå‘ã€‚å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tee a.c &lt;&lt;EOF</span><br><span class="line">zhw</span><br><span class="line">wan</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>snake trafficåŸç†ç®€è¿°</title>
    <url>/2022/09/10/snake-traffic%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>å‰é¢å†™äº†ä¸€ç¯‡<a href="https://rancho333.github.io/2022/09/02/%E4%BD%BF%E7%94%A8ixia%E5%AF%B9sonic%E8%BF%9B%E8%A1%8CL2-3%E6%89%93%E6%B5%81%E6%B5%8B%E8%AF%95/">ä½¿ç”¨ixiaå¯¹sonicè¿›è¡ŒL2,3æ‰“æµæµ‹è¯•</a>, è¿™ç§åœºæ™¯ä¸‹ä»ªè¡¨çš„ä¸€ä¸ªç«¯å£å‘åŒ…ï¼Œdutçš„ä¸€ä¸ªç«¯å£ä¸ä¹‹ç›¸è¿æ”¶åŒ…ï¼Œé€šè¿‡åœ¨vlanå†…è½¬å‘åˆ°DUTå¦ä¸€ä¸ªç«¯å£ï¼Œè¯¥ç«¯å£ä¸ä»ªè¡¨çš„æ”¶åŒ…ç«¯å£ç›¸è¿ã€‚ä»ªè¡¨çš„ä¸€ä¸ªç«¯å£å‘åŒ…ï¼Œä¸€ä¸ªæ”¶åŒ…éªŒè¯ï¼Œä»è€ŒéªŒè¯äºŒå±‚è½¬å‘(é…ç½®ipï¼Œè·¯ç”±å³å¯éªŒè¯ä¸‰å±‚)ã€‚<br>è¿™ç§åœºæ™¯åªèƒ½éªŒè¯ä¸¤ä¸ªç«¯å£ä¹‹é—´çš„æ•°æ®è½¬å‘ï¼Œå¦‚æœè¦ä¸€æ¬¡éªŒè¯æ‰€æœ‰ç«¯å£çš„æ•°æ®è½¬å‘ï¼Œé‚£ä¹ˆéœ€è¦ç”¨åˆ°snake trafficï¼Œå°†æ‰€æœ‰ç«¯å£ä¸²èµ·æ¥ï¼Œæ•°æ®ä¾æ¬¡æµç»æ‰€æœ‰ç«¯å£</p>
<span id="more"></span>

<h1 id="snake-traffica"><a href="#snake-traffica" class="headerlink" title="snake traffica"></a>snake traffica</h1><p>å…ˆè¯´æ˜åŸºæœ¬è½¬å‘åŸç†ï¼Œç„¶åæ ¹æ®ä¸åŒçš„æµ‹è¯•æ–¹æ¡ˆåšè¿›ä¸€æ­¥çš„è¯´æ˜ã€‚</p>
<h2 id="å…¥-è½¬-å‡ºç†è®ºåŸºç¡€"><a href="#å…¥-è½¬-å‡ºç†è®ºåŸºç¡€" class="headerlink" title="å…¥-è½¬-å‡ºç†è®ºåŸºç¡€"></a>å…¥-è½¬-å‡ºç†è®ºåŸºç¡€</h2><p>äºŒå±‚snake trafficä¾èµ–vlanå¯¹æ•°æ®æµè¿›è¡Œæ–¹å‘æ§åˆ¶ï¼Œæ‰“æµè¿‡ç¨‹ä¸­æœ‰ä¸‰ä¸ªæ•°æ®æµçš„åŸºç¡€æ“ä½œç‚¹ã€‚</p>
<ul>
<li>å…¥ã€‚æ‰€æœ‰ç«¯å£éƒ½è®¾ç½®æˆuntag, æ‰€ä»¥Rxæ˜¯untagæŠ¥æ–‡ï¼Œæ ¹æ®ç«¯å£çš„pvidæ‰“ä¸Šå¯¹åº”çš„vlan tag</li>
<li>è½¬ã€‚æ ¹æ®æ‰“ä¸Šçš„vlan tag, å°†æŠ¥æ–‡è½¬å‘åˆ°åŒvlançš„å…¶å®ƒç«¯å£ï¼Œè®©å…¶è½¬å‘å‡ºå»ã€‚<code>å®é™…å°±æ˜¯å°†æŠ¥æ–‡ä»è¯¥ç«¯å£çš„Txå‘å‡ºå»</code></li>
<li>å‡ºã€‚å‡ºç«¯å£æ”¶åˆ°tagæŠ¥æ–‡ï¼Œå‰¥ç¦»tagï¼Œä»Txå‘å‡ºå‡ºå»ã€‚<br><img src="https://rancho333.github.io/pictures/snake_traffic_basic.png"></li>
</ul>
<h2 id="å…¨loopback-snake-traffic"><a href="#å…¨loopback-snake-traffic" class="headerlink" title="å…¨loopback snake traffic"></a>å…¨loopback snake traffic</h2><p>è¿™ç§åœºæ™¯ä¸‹ï¼Œäº¤æ¢æœºå‰é¢æ¿å£å…¨éƒ¨é€šè¿‡loopbackç¯å›ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥phy/macç¯å›ã€‚æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/snake_traffic_loopback.png"></p>
<p>å·¦ä¾§çš„æ‹“æ‰‘å›¾æ˜¯é…ç½®åŸç†ï¼Œå³ä¾§çš„æ‹“æ‰‘æ˜¯æ•°æ®æµçš„èµ°å‘ã€‚broadcomeèŠ¯ç‰‡sdké…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vlan clear              &#x2F;&#x2F; æ¸…é™¤æ‰€æœ‰vlan</span><br><span class="line">vlan remove 1 pbm&#x3D;ce       &#x2F;&#x2F; å°†æ‰€æœ‰ç«¯å£ä»é»˜è®¤vlanä¸­ç§»é™¤</span><br><span class="line">&#x2F;&#x2F;pbmæ˜¯port bitmapï¼Œubmæ˜¯untag bitmap</span><br><span class="line">vlan create 100 pbm&#x3D;ce1,ce2 ubm&#x3D;ce1,ce2; pvlan set ce1 100          &#x2F;&#x2F; åˆ›å»ºvlan100ï¼Œvlan100çš„ç«¯å£æˆå‘˜æ˜¯ce1å’Œce2ï¼Œä¸å¸¦tagï¼›è®¾ç½®ce1çš„native vlanä¸º100</span><br><span class="line">vlan create 101 pbm&#x3D;ce2,ce3 ubm&#x3D;ce2,ce3; pvlan set ce2 101</span><br><span class="line">vlan create 102 pbm&#x3D;ce3,ce4 ubm&#x3D;ce3,ce4; pvlan set ce3 102</span><br><span class="line">vlan create 103 pbm&#x3D;ce4,ce1 ubm&#x3D;ce4,ce1; pvlan set ce4 103</span><br><span class="line">ps ce            &#x2F;&#x2F; ç¡®è®¤æ‰€æœ‰ç«¯å£up</span><br><span class="line">clear c                  &#x2F;&#x2F; æ¸…é™¤ç«¯å£ç»Ÿè®¡æ•°æ®</span><br><span class="line">tx 800 pbm&#x3D;ce0 vlan&#x3D;100        &#x2F;&#x2F; ç”Ÿæˆæ•°æ®æµ</span><br><span class="line">port ce0 en&#x3D;off            &#x2F;&#x2F; ç»“æŸæ‰“æµ</span><br><span class="line">port ce0 en&#x3D;on            &#x2F;&#x2F; æ¢å¤ç«¯å£</span><br><span class="line">show c CDMIB_RPOK.ce      &#x2F;&#x2F; æŸ¥çœ‹è®¡æ•°</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªç«¯å£å±äºä¸¤ä¸ªvlanï¼Œ<code>é€šè¿‡native vlanæ¥æ§åˆ¶æ•°æ®æµå‘å¾€é‚£ä¸ªvlanï¼Œå¦ä¸€ä¸ªvlanåˆ™ç”¨æ¥æ¥æ”¶æ•°æ®, è¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªå›ºå®šæ–¹å‘çš„æ•°æ®æµ</code>ã€‚</p>
<p>ä»¥ä¸‹å›¾æ¥è¯¦ç»†è¯´æ˜æ•°æ®æµçš„èµ°å‘ï¼š<br><img src="https://rancho333.github.io/pictures/snake_traffic_loopback_internal.png"></p>
<ol>
<li>åˆå§‹çŠ¶æ€ä¸‹ã€‚cpué€šè¿‡txå‘½ä»¤ç”ŸæˆæŠ¥æ–‡å‘é€åˆ°ce1ï¼Œce1ä»txå°†æŠ¥æ–‡è½¬å‘å‡ºå»ã€‚å®é™…ä¸ŠASICé€šè¿‡cpu0æ¥å£(asicä¸Šä¸€ä¸ªä¸å¯è§çš„ç«¯å£)ä¸CPUè¿æ¥ï¼Œcpuå°†æŠ¥æ–‡å‘é€åˆ°cpu0ï¼Œcpu0å°†æŠ¥æ–‡è½¬å‘ç»™ce1. æ‰€ä»¥çœ‹èµ·æ¥å°±æ˜¯ï¼šcpuç”ŸæˆæŠ¥æ–‡ï¼Œce1ä»txå°†æŠ¥æ–‡è½¬å‘å‡ºå»</li>
<li>ce1çš„ç«¯å£æ˜¯loopbackï¼Œtxçš„æŠ¥æ–‡ä¼šè½¬åˆ°rxï¼Œrxæ”¶åˆ°æŠ¥æ–‡æ‰“ä¸Š100çš„vlan tagï¼Œè½¬ç»™vlan 100çš„æˆå‘˜ç«¯å£ce2</li>
<li>ce2å°†æŠ¥æ–‡untagä¹‹åä»txå‘é€å‡ºå»ï¼Œå› ä¸ºæ˜¯loopbackï¼Œæ‰€ä»¥åˆä¼šä»rxå›æ¥ï¼Œrxæ”¶åˆ°æŠ¥æ–‡æ‰“ä¸Š101çš„vlan tag, è½¬ç»™vlan 101çš„æˆå‘˜ç«¯å£</li>
<li>åŒç†ce3å°†æŠ¥æ–‡è½¬ç»™ce4ï¼Œce4å°†æŠ¥æ–‡è½¬å›ç»™ce1</li>
<li>ce1å°†ce4è½¬æ¥çš„æŠ¥æ–‡ä»Txè½¬å‘å‡ºå»ï¼Œé‡å¤æ­¥éª¤1çš„æµç¨‹ã€‚è¿™æ ·å°±å½¢æˆäº†loopçš„æ•°æ®æµï¼Œå¾ˆå¿«å°±ä¼šè¾¾åˆ°çº¿é€Ÿã€‚</li>
</ol>
<p>ä¸€ç‚¹è¯´æ˜ï¼šè¿™ç§åœºæ™¯ä¸‹ï¼Œå› ä¸ºæœ‰loopbackçš„å­˜åœ¨ï¼Œæ‰€ä»¥ç«¯å£çš„txï¼Œrxéƒ½ä¼šå‚ä¸åˆ°æµé‡çš„è½¬å‘ã€‚è¿™å°±å¯ä»¥ç†è§£ä¸ºåŒå‘æ‰“æµã€‚</p>
<h2 id="ç«¯å£é€šè¿‡DAC-cableäº’è”"><a href="#ç«¯å£é€šè¿‡DAC-cableäº’è”" class="headerlink" title="ç«¯å£é€šè¿‡DAC cableäº’è”"></a>ç«¯å£é€šè¿‡DAC cableäº’è”</h2><p>è¿™ç§åœºæ™¯ä¸‹ï¼Œäº¤æ¢æœºç›¸é‚»çš„ä¸¤ä¸ªç«¯å£ç”¨cableå…ˆäº’è”èµ·æ¥ï¼Œç›¸é‚»çš„ä¸¤ä¸ªæ²¡æœ‰ç”¨cableå…ˆäº’è”çš„ç«¯å£åˆ™é…ç½®åœ¨ç›¸åŒvlanä¸­è¿›è¡Œæ•°æ®è½¬å‘ã€‚å¯ä»¥è¿™ä¹ˆç†è§£ï¼ŒåŒä¸€ä¸ªvlanå†…çš„ä¸¤ä¸ªç«¯å£ç»„æˆä¸€ä¸ªäº¤æ¢æœºï¼Œç„¶åç”¨cableçº¿å°†è¿™äº›äº¤æ¢æœºä¾æ¬¡è¿æ¥ï¼Œç»„æˆä¸€ä¸ªç¯ã€‚æ‹“æ‰‘å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/snake_traffic_dac.png"></p>
<p>ç«¯å£2,3ç»„æˆä¸€å°äº¤æ¢æœºï¼Œç«¯å£3,4ç»„æˆä¸€ä¸ªäº¤æ¢æœºï¼Œäº’è”æˆç¯ã€‚åŒæ ·çš„é“ç†ï¼Œå¦‚æœè¿›è¡Œä¸‰å±‚æ‰“æµï¼Œå¹¶å°†æ‰€æœ‰çš„ç«¯å£ä¸²åœ¨ä¸€èµ·ï¼Œå¯ä»¥ç”¨vrfï¼Œæ¯ä¸¤ä¸ªç«¯å£åœ¨ä¸€ä¸ªvrfä¸­ç»„æˆä¸€ä¸ªrouterï¼Œvrfä¹‹é—´é€šè¿‡cableäº’è”ï¼Œé€šè¿‡é…ç½®ipå’Œè·¯ç”±å°±å¯å®ç°snake trafficã€‚</p>
<p>dac cableè¿æ¥çš„snake trafficé…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; åªè´´å‡ºvlané…ç½®ï¼Œå…¶å®ƒå‚è€ƒä¸Šé¢</span><br><span class="line">vlan create 100 pbm&#x3D;ce2,ce3 ubm&#x3D;ce2,ce3; pvlan set ce2,ce3 100</span><br><span class="line">vlan create 101 pbm&#x3D;ce4,ce1 ubm&#x3D;ce4,ce1; pvlan set ce4,ce1 101</span><br></pre></td></tr></table></figure>

<p>è¿™ç§åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªç«¯å£åªå±äºä¸€ä¸ªvlan(ç±»ä¼¼äºä¸Šå±‚çš„accessç«¯å£)ï¼Œç«¯å£æ‰€å±çš„vlanå°±æ˜¯native vlan, ä¸æ˜¯å¾ˆç¡®å®špvlanè¿˜éœ€ä¸éœ€è¦é…ç½®ã€‚æ­¤æ—¶ä¸éœ€è¦native vlanæ¥æ§åˆ¶æ•°æ®æµçš„æ–¹å‘ï¼Œæ‰€ä»¥ä¸¤ä¸ªç«¯å£pvlanéƒ½ä¸€æ ·ã€‚</p>
<p>ä»¥ä¸‹å›¾æ¥è¯¦ç»†è¯´æ˜æ•°æ®æµçš„èµ°å‘ï¼š<br><img src="https://rancho333.github.io/pictures/snake_traffic_dac_internal.png"></p>
<ol>
<li>åˆå§‹çŠ¶æ€ä¸‹ã€‚cpuç”ŸæˆæŠ¥æ–‡è®©ce1ä»txå‘é€å‡ºå»ã€‚æŠ¥æ–‡é€šè¿‡cableå…ˆå‘é€åˆ°ce2</li>
<li>ce2 rxåˆ°æŠ¥æ–‡åï¼Œæ‰“ä¸Švlan tag 100ï¼Œå‘é€ç»™vlan 100æˆå‘˜ç«¯å£ce3</li>
<li>ce3æ”¶åˆ°æŠ¥æ–‡ä¹‹åå°†tagå‰¥ç¦»ä»txå‘å‡ºï¼Œ é€šè¿‡cableçº¿åˆ°è¾¾ce4</li>
<li>ce4é€šè¿‡vlanå°†æŠ¥æ–‡è½¬ç»™ce1ï¼Œce1ä»txå‘å‡ºï¼Œé‡å¤æ­¥éª¤1çš„æµç¨‹ï¼Œå½¢æˆloopæ•°æ®æµï¼Œå¾ˆå¿«å°±ä¼šè¾¾åˆ°çº¿é€Ÿ</li>
</ol>
<h2 id="dacå’Œloopbackæ··åˆæµ‹è¯•"><a href="#dacå’Œloopbackæ··åˆæµ‹è¯•" class="headerlink" title="dacå’Œloopbackæ··åˆæµ‹è¯•"></a>dacå’Œloopbackæ··åˆæµ‹è¯•</h2><p>å®éªŒæ‹“æ‰‘å¦‚å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/snake_traffic_dac_loopback.png"></p>
<p>å…¶ä¸­ï¼Œ12,34æ˜¯dacæ–¹å¼ï¼Œ5,6,7,8æ˜¯loopbackæ–¹å¼ã€‚<br>éœ€è¦æ³¨æ„ä¸‹ä¸¤ç§æ–¹å¼ä¹‹é—´çš„æµé‡è¡”æ¥é—®é¢˜æ¥å£ã€‚<br>å¯¹äºdacå‘loopbackè¿‡åº¦çš„èŠ‚ç‚¹ï¼Œå³4,5: å°†4,5é…ç½®åœ¨åŒä¸€ä¸ªvlanä¸­ï¼Œå¹¶å°†4çš„native vlanè®¾ç½®æˆè¯¥å€¼ï¼Œè¿™æ ·dacæ–¹å‘çš„æµé‡å°±å¯ä»¥ä»4è½¬å‘åˆ°5ï¼Œç„¶åè¿›å…¥loopbackæ–¹å‘ã€‚</p>
<p>å¯¹äºloopbackå‘dacè¿‡åº¦çš„èŠ‚ç‚¹ï¼Œå°†8ï¼Œ1é…ç½®åœ¨åŒä¸€ä¸ªvlanä¸­ï¼Œä¸¤è€…çš„native vlanéƒ½è®¾ç½®æˆè¯¥vlanï¼Œè¿™æ ·8 rxçš„æµé‡å°±ä¼šè½¬ç»™1ï¼Œè¿›å…¥dacæ–¹å‘ã€‚</p>
<p>å¦‚æœä¸ä½¿ç”¨CPUå‘åŒ…ï¼Œè€Œæ˜¯å°†ä¸€ä¸ªç«¯å£ä¸æµ‹è¯•è¿æ¥ï¼Œæ‹“æ‰‘å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/snake_traffic_ixia.png"></p>
<p>é…ç½®ä¸éœ€è¦åšä»»ä½•æ”¹å˜ã€‚ç†è§£æŠ¥æ–‡çš„è½¬å‘æµç¨‹ï¼Œæ‹“æ‰‘æ€ä¹ˆå˜éƒ½å¯ä»¥æå®šã€‚<br>ixiaå‘å‡ºçš„æŠ¥æ–‡å¯¹8æ¥è¯´æ˜¯rxï¼Œ8çš„native vlanæ˜¯8,1å…±åŒæ‰€å±çš„vlanï¼Œæ‰€ä»¥æµé‡è½¬å‘åˆ°1ã€‚<br>7è½¬å‘ç»™8çš„æµé‡ï¼Œ8ä»txå‘å‡ºåˆ°ixiaï¼Œæ‰€ä»¥ixiaä»ä¸€ä¸ªç«¯å£å‘å‡ºçš„æŠ¥æ–‡ï¼Œåˆä»è¯¥ç«¯å£æ”¶å›æ¥ï¼ŒæŸ¥çœ‹ixiaç«¯å£çš„ä¸¢åŒ…çŠ¶æ€å³å¯äº†è§£dutçš„ä¸¢åŒ…çŠ¶æ€ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>sonic-testbedçš„ç†è§£</title>
    <url>/2021/03/02/sonic-testbed%E7%9A%84%E7%90%86%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>è¿™ç¯‡æ–‡ç« ç”¨æ¥è®°å½•å¯¹sonic testbedçš„ä¸€äº›ç†è§£ä»¥åŠä¸€äº›è¾ƒæ ¸å¿ƒçš„çŸ¥è¯†ç‚¹ã€‚</p>
<span id="more"></span>

<p>sonic-mgmtä»£ç è¿è¡Œåœ¨docker-sonic-mgmtç¯å¢ƒä¸­ä¸­ï¼Œé•œåƒåœ¨sonic-buildimageä¸­ç¼–è¯‘ç”Ÿæˆï¼Œdocker-ptfä¹Ÿæ˜¯åœ¨é‡Œé¢ç”Ÿæˆçš„ã€‚docker-sonic-mgmtç¯å¢ƒé›†æˆäº†ansible-playbookã€pytestã€spytestç­‰æ‰€éœ€çš„ä¾èµ–ã€‚</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>vpnæŠ€æœ¯ç®€è¿°</title>
    <url>/2022/07/28/vpn%E6%8A%80%E6%9C%AF%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æ— è®ºæ˜¯è®¿é—®å¤–ç½‘èµ„æº(googleï¼Œyoutubeç­‰)ï¼Œè¿˜æ˜¯å±…å®¶åŠå…¬è®¿é—®å…¬å¸å†…ç½‘ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä½¿ç”¨åˆ°vpnè¿™ä¸ªä¸œä¸œã€‚VPN(virtual private network)æ˜¯æŒ‡åœ¨å…¬ç”¨ç½‘ç»œä¸Šå»ºç«‹ä¸€ä¸ªç§æœ‰çš„ã€ä¸“ç”¨çš„è™šæ‹Ÿé€šä¿¡ç½‘ç»œã€‚æœ¬è´¨å°±æ˜¯å»ºç«‹éš§é“ä¼ é€’åŸæœ‰çš„ä¸šåŠ¡æµé‡ï¼Œåœ¨éš§é“ä¸¤ç«¯è¿›è¡Œä¸šåŠ¡æµé‡çš„å°è£…ä¸è§£å°è£…ï¼Œéš§é“ä¸¤ç«¯åˆ™æ˜¯éœ€è¦äº’é€šçš„ä¸¤ä¸ªå­ç½‘ã€‚</p>
<span id="more"></span>

<h1 id="vpnæŠ€æœ¯çš„ä¸€äº›åˆ†ç±»"><a href="#vpnæŠ€æœ¯çš„ä¸€äº›åˆ†ç±»" class="headerlink" title="vpnæŠ€æœ¯çš„ä¸€äº›åˆ†ç±»"></a>vpnæŠ€æœ¯çš„ä¸€äº›åˆ†ç±»</h1><p>æœ‰å‡ ç§è§’åº¦çš„åˆ†ç±»æ–¹å¼ï¼Œå…¶ä¸€æ˜¯æ ¹æ®å»ºè®¾å•ä½(è¿è¥å•†è¿˜æ˜¯ä¼ä¸šè‡ªèº«)æ¥åˆ†ç±»ï¼š</p>
<ul>
<li>ç§Ÿç”¨è¿è¥å•†VPNä¸“çº¿æ­å»ºä¼ä¸šVPNç½‘ç»œï¼šä¸»è¦æ˜¯MPLS VPN, ç›¸è¾ƒäºä¼ ç»Ÿçš„ä¸“çº¿(E1ã€SDHä¸“çº¿)æ›´ä¾¿å®œ</li>
<li>ç”¨æˆ·ä¼ä¸šè‡ªå»ºVPNç½‘ç»œï¼šåŸºäºinternetå»ºç«‹ä¼ä¸švpnç½‘ç»œï¼Œå…·ä½“æŠ€æœ¯åŒ…æ‹¬GREã€L2TPã€IPSecã€SSLVPNç­‰ã€‚</li>
</ul>
<p>æ ¹æ®ç»„ç½‘æ–¹å¼çš„ä¸åŒï¼š<br>æœ¬è´¨å°±æ˜¯éš§é“ç«¯ç‚¹ä½ç½®çš„ä¸åŒã€‚è®°ä½ä¸¤ä¸ªç‚¹ï¼šåŠ å¯†ç‚¹/éš§é“ç‚¹ å’Œ é€šä¿¡ç‚¹</p>
<ul>
<li>è¿œç¨‹è®¿é—®VPnï¼ˆaccess VPNï¼‰ï¼šé€‚åˆå±…å®¶åŠå…¬åœºæ™¯ï¼Œä¸€èˆ¬åœ¨PCä¸Šå®‰è£…å®¢æˆ·ç«¯å³å¯ï¼Œéš§é“ç«¯ç‚¹ä½äºPCä¸Šï¼Œä¹Ÿå«åšremote access VPNã€‚åŠ å¯†ç‚¹/éš§é“ç‚¹å’Œé€šä¿¡ç‚¹éƒ½åœ¨PCæˆ–æ‰‹æœºç­‰è®¾å¤‡ä¸Šã€‚</li>
<li>å±€åŸŸç½‘åˆ°å±€åŸŸç½‘çš„vpn(ä¹Ÿç§°ç½‘å…³åˆ°ç½‘å…³çš„vpn)ï¼šé€‚ç”¨äºå¼‚åœ°æœºæ„çš„äº’è”ï¼Œéš§é“ç«¯ç‚¹ä½äºç½‘ç»œè®¾å¤‡ä¸Šï¼Œä¹Ÿå«åšsite-to-site VPNï¼Œè¿™é‡Œæœ‰ä¸¤ç§åˆ†ç±»ã€‚åŠ å¯†ç‚¹/éš§é“ç‚¹å’Œé€šä¿¡ç‚¹åœ¨ç½‘å…³ã€é˜²ç«å¢™ç­‰ä¸“é—¨ç½‘ç»œè®¾å¤‡ä¸Šã€‚<ul>
<li>ä¸€ç§å«intranet-based site-to-site, å³ä¸¤ç«¯çš„å±€åŸŸç½‘éƒ½å±äºä¸€å®¶å…¬å¸ï¼ŒæŠŠå‡ ä¸ªç§ç½‘è¿æ¥åœ¨ä¸€èµ·</li>
<li>ä¸€ç§å«extranet-based site-to-site, å³ä¸¤ç«¯çš„å±€åŸŸç½‘ä¸å±äºä¸€å®¶å…¬å¸ï¼Œåªåˆ†äº«ä¸€äº›å›ºå®šçš„èµ„æºï¼Œè€Œå…¶å®ƒèµ„æºä¿æŒç§æœ‰</li>
</ul>
</li>
</ul>
<p>æŒ‰ç…§vpnæŠ€æœ¯å®ç°çš„ç½‘ç»œå±‚æ¬¡è¿›è¡Œåˆ†ç±»ï¼š</p>
<ul>
<li>åŸºäºæ•°æ®é“¾è·¯å±‚çš„VPNï¼šL2TPã€L2Fã€PPTPã€‚å…¶ä¸­L2Få’ŒPPTPå·²ç»åŸºæœ¬ä¸Šè¢«L2TPæ›¿ä»£äº†</li>
<li>åŸºäºç½‘ç»œå±‚çš„VPNï¼šIPSecã€GRE</li>
<li>åŸºäºåº”ç”¨å±‚çš„VPNï¼šSSL VPN</li>
</ul>
<p>åŸºäºinternetçš„VPNæŠ€æœ¯æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹å°±æ˜¯å¿…é¡»è§£å†³ç½‘ç»œå®‰å…¨çš„é—®é¢˜ã€‚</p>
<h1 id="VPNå…³é”®æŠ€æœ¯ç‚¹"><a href="#VPNå…³é”®æŠ€æœ¯ç‚¹" class="headerlink" title="VPNå…³é”®æŠ€æœ¯ç‚¹"></a>VPNå…³é”®æŠ€æœ¯ç‚¹</h1><h2 id="éš§é“æŠ€æœ¯"><a href="#éš§é“æŠ€æœ¯" class="headerlink" title="éš§é“æŠ€æœ¯"></a>éš§é“æŠ€æœ¯</h2><p>éš§é“æŠ€æœ¯æ˜¯VPNçš„åŸºæœ¬æŠ€æœ¯ï¼Œç±»ä¼¼äºç‚¹åˆ°ç‚¹çš„è¿æ¥æŠ€æœ¯ã€‚å®ƒçš„åŸºæœ¬è¿‡ç¨‹å°±æ˜¯åœ¨æ•°æ®è¿›å…¥æºVPNç½‘å…³åï¼Œå°†æ•°æ®å°è£…åé€šè¿‡internetä¼ è¾“åˆ°ç›®çš„vpnç½‘å…³åå†å¯¹æ•°æ®è¿›è¡Œè§£å°è£…ã€‚å¯åˆç•¥è®¤ä¸ºvpnç½‘å…³ä¹‹é—´æ˜¯ç›´è¿çš„ï¼Œæ˜¯ä¸€æ¡éš§é“ï¼Œå°è£…çš„æŠ¥æ–‡ä¸å…³å¿ƒå…·ä½“ä¼ è¾“è·¯å¾„ã€‚å°è£…åçš„æŠ¥æ–‡src ipæ˜¯æºvpnç½‘å…³ï¼Œdest ipæ˜¯ç›®çš„vpnç½‘å…³ã€‚</p>
<h2 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h2><p>ç§»åŠ¨åŠå…¬ç­‰åœºæ™¯ä¸‹ï¼Œéœ€è¦å¯¹ç”¨æˆ·çš„èº«ä»½è¿›è¡ŒéªŒè¯ã€‚</p>
<ul>
<li>GREä¸æ”¯æŒè®¤è¯</li>
<li>L2TPä¾èµ–äºPPPæä¾›çš„è®¤è¯æŠ€æœ¯ã€‚</li>
<li>IPSecï¼šé€šè¿‡IKEv2æ‹¨å·æ—¶ï¼Œæ”¯æŒè¿›è¡ŒEAPè®¤è¯ã€‚æ¥å…¥ç”¨æˆ·çš„ç”¨æˆ·åå’Œå¯†ç å¯ä»¥æœ¬åœ°è®¤è¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡RADIUSæœåŠ¡å™¨è®¤è¯ã€‚è®¤è¯é€šè¿‡åå†ç»™ç”¨æˆ·åˆ†é…å†…éƒ¨çš„IPåœ°å€ï¼Œé€šè¿‡æ­¤IPåœ°å€å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒå’Œç®¡ç†ã€‚å¦å¤–IPSecè¿˜æ”¯æŒæ•°æ®æºè®¤è¯</li>
<li>SSL VPN: æ”¯æŒæœ¬åœ°è®¤è¯ï¼Œè¯ä¹¦è®¤è¯å’ŒæœåŠ¡å™¨è®¤è¯ã€‚ä¸»è¦æ˜¯å¯¹æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œç¡®è®¤webç½‘é¡µçš„åˆæ³•æ€§ã€‚</li>
</ul>
<h2 id="åŠ å¯†æŠ€æœ¯"><a href="#åŠ å¯†æŠ€æœ¯" class="headerlink" title="åŠ å¯†æŠ€æœ¯"></a>åŠ å¯†æŠ€æœ¯</h2><p>internetä¸Šä¼ è¾“çš„æŠ¥æ–‡å¦‚æœä¸åšåŠ å¯†å¤„ç†ï¼Œéƒ½æ˜¯å¤„äºè£¸å¥”çŠ¶æ€ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šè¿‡wiresharkæŠ“åŒ…å°±å¯ä»¥ç›´æ¥è¯»å–åˆ°æŠ¥æ–‡å†…å®¹ã€‚åŠ å¯†å¯¹è±¡æœ‰æ•°æ®æŠ¥æ–‡å’Œåè®®æŠ¥æ–‡ä¹‹åˆ†ï¼Œèƒ½å¤Ÿå®ç°åè®®æŠ¥æ–‡å’Œæ•°æ®æŠ¥æ–‡éƒ½åŠ å¯†çš„åè®®å®‰å…¨ç³»æ•°æ›´é«˜ã€‚</p>
<ul>
<li>GREå’ŒL2TPæœ¬èº«ä¸æä¾›åŠ å¯†æŠ€æœ¯ï¼Œæ‰€ä»¥é€šå¸¸ç»“åˆIPSecåè®®ä¸€èµ·ä½¿ç”¨ï¼Œè€ŒIPSecåªæ”¯æŒå•æ’­å°è£…ï¼Œå¾ˆå¥½äº’è¡¥</li>
<li>IPSecï¼šæ”¯æŒæ•°æ®æŠ¥æ–‡å’Œåè®®æŠ¥æ–‡åŠ å¯†ã€‚IPSecä¸€èˆ¬é‡‡ç”¨å¯¹ç§°å¯†é’¥ç®—æ³•åŠ å¯†æ•°æ®ã€‚</li>
<li>SSL VPN: æ”¯æŒæ•°æ®æŠ¥æ–‡å’Œåè®®æŠ¥æ–‡åŠ å¯†ã€‚SSL VPNé‡‡ç”¨éå¯¹ç§°å¯†é’¥ç®—æ³•åŠ å¯†æ•°æ®(å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†)ã€‚</li>
</ul>
<h2 id="æ•°æ®éªŒè¯æŠ€æœ¯"><a href="#æ•°æ®éªŒè¯æŠ€æœ¯" class="headerlink" title="æ•°æ®éªŒè¯æŠ€æœ¯"></a>æ•°æ®éªŒè¯æŠ€æœ¯</h2><p>æ•°æ®éªŒè¯å°±æ˜¯å¯¹æ”¶åˆ°çš„æŠ¥æ–‡è¿›è¡ŒéªŒè´§ã€‚æ¯”å¦‚å¸¸ç”¨MD5éªŒè¯æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚åœ¨æ”¶å‘ä¸¤ç«¯éƒ½å¯¹æŠ¥æ–‡è¿›è¡ŒéªŒè¯ï¼Œåªæœ‰æ‘˜è¦ä¸€è‡´çš„æŠ¥æ–‡æ‰è¢«è®¤å¯ã€‚</p>
<ul>
<li>GREï¼šæœ¬èº«åªæä¾›ç®€å•çš„æ ¡éªŒå’ŒéªŒè¯åŠå…³é”®å­—éªŒè¯ã€‚</li>
<li>L2TPï¼šä¸æä¾›æ•°æ®éªŒè¯æŠ€æœ¯</li>
<li>IPSec: æ”¯æŒå¯¹æ•°æ®è¿›è¡Œå®Œæ•´æ€§éªŒè¯å’Œæ•°æ®æºéªŒè¯ã€‚åœ¨IPSecä¸­éªŒè¯å’ŒåŠ å¯†é€šå¸¸ä¸€èµ·ä½¿ç”¨ï¼Œå¯¹åŠ å¯†åçš„æŠ¥æ–‡HMAC(keyed-hash message authentication code)ç”Ÿæˆæ‘˜è¦</li>
<li>SSL VPNï¼šæ”¯æŒå¯¹æ•°æ®è¿›è¡Œå®Œæ•´æ€§éªŒè¯å’Œæ•°æ®æºéªŒè¯ã€‚SSL VPNé‡‡ç”¨å…¬é’¥ä½“è´¨ï¼Œåˆ©ç”¨Hashç®—æ³•ç”Ÿæˆæ‘˜è¦ï¼Œå†ç”¨ç§é’¥åŠ å¯†æ‘˜è¦ç”Ÿæˆæ•°å­—ç­¾åï¼Œåˆ©ç”¨å…¬é’¥è¿›è¡Œè§£å¯†ã€‚åˆ©ç”¨å…¬é’¥å’Œç§é’¥çš„ä¸€ä¸€å…³ç³»å¯ä»¥å¯¹æ•°æ®æºè¿›è¡Œè®¤è¯ã€‚</li>
</ul>
<p>æ€»ç»“ä¸€ä¸‹è¿™å‡ ç§vpnæŠ€æœ¯çš„åº”ç”¨åœºæ™¯ï¼š</p>
<p>| GRE | L2TP | IPSec | SSL VPN |<br>| :â€” | :â€” | :â€” | :â€” | :â€” |<br>| ä½œç”¨èŒƒå›´ | IPå±‚åŠä»¥ä¸Šæ•°æ® | IPå±‚åŠä»¥ä¸Šæ•°æ® | IPå±‚åŠä»¥ä¸Šæ•°æ® | åº”ç”¨å±‚ç‰¹å®šæ•°æ® |<br>| é€‚ç”¨åœºæ™¯ | internet VPN | access vpn | internet vpn; accese | access vpn |<br>| èº«ä»½è®¤è¯ | ä¸æ”¯æŒ | æ”¯æŒï¼ŒåŸºäºPPPçš„chapã€papã€eapè®¤è¯| æ”¯æŒï¼Œé‡‡ç”¨IPæˆ–ID+å£ä»¤æˆ–è¯ä¹¦è¿›è¡Œæ•°æ®æºè®¤è¯ï¼›IKEv2æ‹¨å·æ–¹å¼é‡‡ç”¨EAPè®¤è¯è¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯ | æ”¯æŒï¼Œç”¨æˆ·å+å£ä»¤+è¯ä¹¦å¯¹æœåŠ¡å™¨è¿›è¡Œè®¤è¯ï¼Œä¹Ÿå¯è¿›è¡ŒåŒå‘è®¤è¯ |<br>| åŠ å¯†æŠ€æœ¯ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | æ”¯æŒ | æ”¯æŒ |<br>| æ•°æ®éªŒè¯ | æ”¯æŒï¼Œæ ¡éªŒå’ŒéªŒè¯ã€å…³é”®å­—éªŒè¯ | ä¸æ”¯æŒ | æ”¯æŒ | æ”¯æŒ |<br>| å¦‚ä½•ä½¿ç”¨ | GRE over IPSec | L2TP over IPSec | å•ç‹¬ä½¿ç”¨ | SSL VPN |</p>
]]></content>
      <tags>
        <tag>vpn</tag>
      </tags>
  </entry>
  <entry>
    <title>vrf lite route leaking</title>
    <url>/2022/10/13/vrf-lite-route-leaking/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>ä¹‹å‰åœ¨<a href="https://rancho333.github.io/2021/10/20/vrf%E7%AE%80%E8%BF%B0%E5%8F%8A%E4%BB%BF%E7%9C%9F%E5%AE%9E%E9%AA%8C/">vrfç®€è¿°åŠä»¿çœŸå®éªŒ</a>å¯¹vrfæœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œä½†æ˜¯vrf lite route leakingå®éªŒå¤±è´¥äº†ã€‚ç°åœ¨è¡¥åšå›æ¥ã€‚</p>
<p>vrfä¹‹é—´çš„è·¯ç”±æ³„æ¼æœ‰é™æ€é…ç½®å’ŒMP-BGPä¸¤ç§æ–¹å¼ï¼Œæœ¬æ–‡åªåšé™æ€é…ç½®çš„å®éªŒã€‚</p>
<span id="more"></span>

<h1 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h1><p>ä¹‹å‰çš„å®éªŒæ—¶æ˜¯ç”±äºé…ç½®å‡ºçš„é—®é¢˜ï¼Œå‚è€ƒciscoçš„<a href="https://www.cisco.com/c/en/us/support/docs/multiprotocol-label-switching-mpls/multiprotocol-label-switching-vpns-mpls-vpns/47807-routeleaking.html#diffvrfs">Route Leaking in MPLS/VPN Networks</a>, ä¸¤ä¸ªvrfä¹‹é—´ä¸èƒ½ç›´æ¥æ³„éœ²è·¯ç”±ï¼Œå¿…é¡»ä»globalä¸­è½¬ä¸€ä¸‹æ‰è¡Œã€‚</p>
<p>å®éªŒæ‹“æ‰‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/vrf_leaking_topology.png"></p>
<p>vpc2å±äºvrf 2, vpc3å±äºvrf 3, vpc4å±äºglobal. é€šè¿‡é…ç½®ä½¿ä¸‰è€…ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ã€‚<br>å¯¹äºvrf -&gt; globalï¼Œåœ¨vrfä¸­å†™åˆ°è¾¾globalä¸­prefixè·¯ç”±ï¼Œåœ¨globalä¸­å†™åˆ°è¾¾vrfä¸­prefixçš„è·¯ç”±ã€‚<br>å¯¹äºvrf -&gt; vrfï¼Œåœ¨vrfä¸­å†™åˆ°è¾¾å¦ä¸€ä¸ªvrfä¸­prefixçš„è·¯ç”±(ä¸‹ä¸€è·³åœ¨globalä¸­)ï¼Œåœ¨globalä¸­å†™åˆ°è¾¾è¯¥prefixçš„è·¯ç”±ï¼Œå¯¹äºå¦ä¸€ä¸ªvrfï¼Œåšç›¸åŒçš„æ“ä½œã€‚</p>
<p>ä¸‹é¢å¼€å§‹é…ç½®ã€‚åŸºæœ¬çš„ipç½‘æ®µé…ç½®è§„åˆ™æŒ‰è®¾å¤‡åç§°æ¥ï¼Œè¿™é‡Œä¸è´´å‡ºæ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1(config)#ip vrf 2             &#x2F;&#x2F; åˆ›å»ºvrf2</span><br><span class="line">R1(config)#ip vrf 3             &#x2F;&#x2F; åˆ›å»ºvrf3</span><br><span class="line"></span><br><span class="line">R1(config-if)#interface ethernet 0&#x2F;0</span><br><span class="line">R1(config-if)#ip vrf forwarding 2                   &#x2F;&#x2F; å°†eth0åŠ å…¥vrf 2</span><br><span class="line">R1(config-if)#ip address 12.1.1.1 255.255.255.0</span><br><span class="line"></span><br><span class="line">R1(config-if)#interface ethernet 0&#x2F;1</span><br><span class="line">R1(config-if)#ip vrf forwarding 3                   &#x2F;&#x2F; å°†eth1åŠ å…¥vrf 3</span><br><span class="line">R1(config-if)#ip address 13.1.1.1 255.255.255.0</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ä¸‹åŸºæœ¬çš„è”é€šæ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vpc4&gt; ping 14.1.1.1 -c 1                &#x2F;&#x2F; å¯ä»¥pingé€šè‡ªå·±çš„ç½‘å…³</span><br><span class="line"></span><br><span class="line">84 bytes from 14.1.1.1 icmp_seq&#x3D;1 ttl&#x3D;255 time&#x3D;0.335 ms</span><br><span class="line"></span><br><span class="line">vpc4&gt; ping 12.1.1.2 -c 1                &#x2F;&#x2F; ä¸èƒ½å’Œvrf 2é€šä¿¡</span><br><span class="line"></span><br><span class="line">*14.1.1.1 icmp_seq&#x3D;1 ttl&#x3D;255 time&#x3D;0.497 ms (ICMP type:3, code:1, Destination host unreachable)</span><br><span class="line"></span><br><span class="line">vpc4&gt; ping 13.1.1.3 -c 1                &#x2F;&#x2F; ä¸èƒ½å’Œvrf 3é€šä¿¡</span><br><span class="line"></span><br><span class="line">*14.1.1.1 icmp_seq&#x3D;1 ttl&#x3D;255 time&#x3D;0.492 ms (ICMP type:3, code:1, Destination host unreachable)</span><br></pre></td></tr></table></figure>
<p>ç¬¦åˆé¢„æœŸã€‚</p>
<p>å¯¹äºvrf 2ä¸globalä¹‹é—´çš„é€šä¿¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1(config)#ip route vrf 2 14.1.1.0 255.255.255.0 14.1.1.4 global            &#x2F;&#x2F; åœ¨vrf 2ä¸­æ·»åŠ globalä¸­prefixçš„è·¯ç”±ï¼Œglobalå…³é”®è¯è¡¨æ˜ï¼šå¦‚æœåœ¨vrf 2ä¸­æ”¶åˆ°prefixæ˜¯14.1.1.0&#x2F;24çš„æŠ¥æ–‡æ—¶ï¼Œåˆ°globalè·¯ç”±è¡¨ä¸­æ‰¾è·¯ç”±å‡ºå»ï¼Œç”±äº14.1.1.0&#x2F;24æ˜¯globalä¸­çš„ç›´è¿ç½‘æ®µï¼Œæ‰€ä»¥æŠ¥æ–‡å¯ä»¥è½¬å‘</span><br><span class="line">R1(config)#ip route 12.1.1.0 255.255.255.0 ethernet 0&#x2F;0             &#x2F;&#x2F; globalä¸­æ·»åŠ åˆ°vrf 2ä¸­prefixçš„è·¯ç”±ï¼Œæ³¨æ„ä¸‹ä¸€è·³éœ€è¦æŒ‡å®šæ˜¯ç‰©ç†æ¥å£ï¼Œå¦‚æœæŒ‡å®šipçš„è¯ï¼Œä¸èƒ½æ­£å¸¸è·¯ç”±</span><br><span class="line"></span><br><span class="line">vpc4&gt; ping 12.1.1.2 -c 1                &#x2F;&#x2F; vrf 2ä¸globalä¹‹é—´ä¸‰å±‚å¯è¾¾</span><br><span class="line"></span><br><span class="line">84 bytes from 12.1.1.2 icmp_seq&#x3D;1 ttl&#x3D;63 time&#x3D;1.219 ms</span><br></pre></td></tr></table></figure>

<p>vrf 3ä¸globalä¹‹é—´çš„é€šä¿¡ç±»ä¼¼é…ç½®ã€‚<br>å¯¹äºvrf 2ä¸vrf 3ä¹‹é—´çš„é€šä¿¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1(config)#ip route vrf 2 13.1.1.0 255.255.255.0 13.1.1.3 global            &#x2F;&#x2F; åœ¨vrf 2ä¸­æ·»åŠ vrf 3ä¸­prefixçš„è·¯ç”±ï¼Œä¸‹ä¸€è·³å»globalä¸­æ‰¾</span><br><span class="line">R1(config)#ip route 13.1.1.0 255.255.255.0 ethernet 0&#x2F;1                     &#x2F;&#x2F; globalä¸­æ²¡æœ‰åˆ°vrf 3çš„è·¯ç”±ï¼Œæ‰€ä»¥éœ€è¦åœ¨globalä¸­æ·»åŠ åˆ°vrf 3ä¸­prefixçš„è·¯ç”±</span><br><span class="line"></span><br><span class="line">R1(config)#ip route vrf 3 12.1.1.0 255.255.255.0 12.1.1.2 global            &#x2F;&#x2F; åŒç†åœ¨vrf 3ä¸­æ·»åŠ åˆ°vrf 2ä¸­prefixçš„è·¯ç”±</span><br><span class="line">R1(config)#ip route 12.1.1.0 255.255.255.0 ethernet 0&#x2F;0        </span><br><span class="line"></span><br><span class="line">vpc2&gt; ping 13.1.1.3 -c 1                    &#x2F;&#x2F; vrf 2ä¸vrf 3ä¹‹é—´ä¸‰å±‚å¯è¾¾</span><br><span class="line"></span><br><span class="line">84 bytes from 13.1.1.3 icmp_seq&#x3D;1 ttl&#x3D;63 time&#x3D;3.980 ms</span><br></pre></td></tr></table></figure>

<p>ç”±äºglobalä¸­å·²ç»æœ‰äº†åˆ°vrf 2å’Œvrf 3çš„è·¯ç”±ï¼Œæ‰€ä»¥å¯¹äºvrf 3è®¿é—®globalï¼Œåªéœ€è¦æ·»åŠ ä¸€æ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1(config)#ip route vrf 3 14.1.1.0 255.255.255.0 14.1.1.4 global</span><br><span class="line"></span><br><span class="line">vpc4&gt; ping 13.1.1.3 -c 1                &#x2F;&#x2F; vrf 3ä¸globalä¹‹é—´ä¸‰å±‚å¯è¾¾</span><br><span class="line"></span><br><span class="line">84 bytes from 13.1.1.3 icmp_seq&#x3D;1 ttl&#x3D;63 time&#x3D;2.165 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¢çš„ä¸€ä¸ªåŸºæœ¬æ€è·¯æ˜¯ï¼šå¦‚æœä¸€ä¸ªvrfæƒ³è¦è®¿é—®å…¶å®ƒvrfçš„ç½‘æ®µ(æ— è®ºæ˜¯ä¸æ˜¯default vrf)</p>
<ol>
<li>ä¸‹ä¸€è·³éƒ½è¦æŒ‡å®šåˆ°globalä¸­å»æ‰¾ï¼Œglobalä¸­å¦‚æœæ²¡æœ‰å¯¹åº”çš„è·¯ç”±ï¼Œå°±è¦åœ¨globalä¸­è¡¥ä¸Š</li>
<li>åŒæ—¶globalä¸­ä¸€å®šè¦æœ‰è¿”å›è¯¥vrfçš„è·¯ç”±</li>
<li>ç½‘ç»œæ˜¯åŒå‘çš„ï¼Œæ¥å›éƒ½éœ€è¦æœ‰è·¯ç”±ã€‚</li>
</ol>
<p>åˆ†æä¸‹ä¸€ä¸‹è·¯ç”±è¡¨ï¼Œè¿™æ˜¯æœ€æœ¬è´¨çš„ä¸œè¥¿äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¯¹äºvrf 2çš„è·¯ç”±è¡¨:</span><br><span class="line">R1#show ip route vrf 2 static         </span><br><span class="line">      13.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">S        13.1.1.0 [1&#x2F;0] via 13.1.1.3                    &#x2F;&#x2F; å»å¾€vrf 3çš„è·¯ç”±ï¼Œåˆ°globalä¸­æ‰¾ä¸‹ä¸€è·³13.1.1.3  (è·¯ç”±è¡¨ä¸­å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆåœ°æ–¹ä½“ç°å‡ºåˆ°globalå»æ‰¾)</span><br><span class="line">      14.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">S        14.1.1.0 [1&#x2F;0] via 14.1.1.4                    &#x2F;&#x2F; å»å¾€globalçš„è·¯ç”±</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¯¹äºglobalè·¯ç”±è¡¨</span><br><span class="line">R1#show ip route static </span><br><span class="line">      12.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">S        12.1.1.0 is directly connected, Ethernet0&#x2F;0</span><br><span class="line">      13.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">S        13.1.1.0 is directly connected, Ethernet0&#x2F;1    &#x2F;&#x2F; æŒ‡æ˜13.1.1.0ç½‘æ®µçš„å‡ºå£</span><br><span class="line"></span><br><span class="line">R1#show ip route vrf 3 static </span><br><span class="line">      12.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">S        12.1.1.0 [1&#x2F;0] via 12.1.1.2                    &#x2F;&#x2F; 12.1.1.0çš„å›ç¨‹è·¯ç”±</span><br><span class="line">      14.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">S        14.1.1.0 [1&#x2F;0] via 14.1.1.4                    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸€å¼ å›¾æ¥æ”¶å°¾å§ï¼š<br><img src="https://rancho333.github.io/pictures/vrf_leaking_route.png"></p>
<p>æœ€åå†è¡¥å……ä¸€ç‚¹ï¼Œvrf lite leakingæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§å°±æ˜¯ä¸Šé¢ä½¿ç”¨çš„é€šè¿‡é…ç½®é™æ€è·¯ç”±å®ç°ï¼Œå¦å¤–ä¸€ç§æ–¹å¼å°±æ˜¯ä½¿ç”¨MP-BGã€‚å¯¹äºMP-BGPçš„æ–¹å¼ï¼š</p>
<ol>
<li>åœ¨vrfä¸­è¡¨æ˜éœ€è¦importçš„RT</li>
<li>åœ¨MP-BGPå¯¹åº”çš„vrfä¸­redistributeç›¸å…³çš„è·¯ç”±<br>æœ¬è´¨å°±æ˜¯å°†ä¸åŒvrfä¸­çš„è·¯ç”±å¯¼å…¥åˆ°MP-BGPä¸­å»ï¼Œç„¶åå†importè‡ªå·±æ„Ÿå…´è¶£çš„å…¶å®ƒvrfä¸­çš„è·¯ç”±ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ä¸åŒvrfä¹‹é—´çš„è·¯ç”±leaking.</li>
</ol>
]]></content>
      <tags>
        <tag>vrf</tag>
      </tags>
  </entry>
  <entry>
    <title>vrfç®€è¿°åŠä»¿çœŸå®éªŒ</title>
    <url>/2021/10/20/vrf%E7%AE%80%E8%BF%B0%E5%8F%8A%E4%BB%BF%E7%9C%9F%E5%AE%9E%E9%AA%8C/</url>
    <content><![CDATA[<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFvrf">ä»€ä¹ˆæ˜¯VRF</a><ul>
<li><a href="#vrf%E7%9A%84%E4%BD%9C%E7%94%A8">vrfçš„ä½œç”¨</a></li>
</ul>
</li>
<li><a href="#vrf%E4%BB%BF%E7%9C%9F%E5%AE%9E%E9%AA%8C">VRFä»¿çœŸå®éªŒ</a><ul>
<li><a href="#vrf%E8%A7%A3%E5%86%B3%E5%9C%B0%E5%9D%80%E9%87%8D%E5%8F%A0--ip%E9%9A%94%E7%A6%BB">VRFè§£å†³åœ°å€é‡å  &amp;&amp; IPéš”ç¦»</a></li>
<li><a href="#vrf%E8%B7%AF%E7%94%B1%E9%9A%94%E7%A6%BB%E4%BB%A5%E5%8F%8A%E8%B7%AF%E7%94%B1%E6%B3%84%E9%9C%B2">VRFè·¯ç”±éš”ç¦»ä»¥åŠè·¯ç”±æ³„éœ²</a><ul>
<li><a href="#vrf%E8%B7%AF%E7%94%B1%E6%B3%84%E9%9C%B2%E5%AE%9E%E9%AA%8C%E5%A4%B1%E8%B4%A5">vrfè·¯ç”±æ³„éœ²å®éªŒå¤±è´¥</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<span id="more"></span>

<h1 id="ä»€ä¹ˆæ˜¯VRF"><a href="#ä»€ä¹ˆæ˜¯VRF" class="headerlink" title="ä»€ä¹ˆæ˜¯VRF"></a>ä»€ä¹ˆæ˜¯VRF</h1><p>VRF(virtual routing and forwarding)æ˜¯ä¸€ç§å…è®¸åœ¨å•å°è·¯ç”±å™¨ä¸Šæœ‰å¤šä¸ªè·¯ç”±è¡¨çš„æŠ€æœ¯ã€‚VRFsçš„å…¸å‹ä½¿ç”¨æ˜¯ä¸MPLS VPNsç»“åˆã€‚æ²¡æœ‰ä½¿ç”¨MPLSçš„VRFsç§°ä¸ºVRF lite.</p>
<p>åœ¨Linuxä¸Šï¼ŒVRFè®¾å¤‡é€šè¿‡ä¸ipè§„åˆ™ç»“åˆåœ¨Linuxç½‘ç»œæ ˆä¸­æä¾›åˆ›å»ºè™šæ‹Ÿè·¯ç”±å’Œè½¬å‘çš„èƒ½åŠ›ã€‚ä¸€ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯å¤šç§Ÿæˆ·å„è‡ªéœ€è¦ç‹¬ç«‹çš„è·¯ç”±è¡¨ï¼Œå°‘æ•°åœºæ™¯ä¸‹éœ€è¦ä¸åŒçš„é»˜è®¤è·¯ç”±ã€‚</p>
<p>ç¨‹åºé€šè¿‡socketä¸ä¸åŒçš„VRFè®¾å¤‡ç»‘å®šæ„ŸçŸ¥VRFã€‚æ•°æ®åŒ…é€šè¿‡socketä½¿ç”¨ä¸VRFè®¾å¤‡ç›¸å…³çš„è·¯ç”±è¡¨ã€‚VRFè®¾å¤‡å®ç°çš„ä¸€ä¸ªé‡è¦ç‰¹å¾å°±æ˜¯å®ƒåªå½±å“L3è€Œå¯¹L2å·¥å…·ï¼ˆæ¯”å¦‚LLDPï¼‰æ²¡æœ‰å½±å“(å®ƒä»¬æ˜¯å…¨å±€çš„è€Œä¸å¿…è¿è¡Œåœ¨æ¯ä¸€ä¸ªVRFåŸŸä¸­).è¿™ç§è®¾è®¡å…è®¸ä½¿ç”¨æ›´é«˜ä¼˜å…ˆçº§çš„ip rules(policy based routing, PBR)ä¼˜å…ˆäºVRFè®¾å¤‡è§„åˆ™ï¼Œæ ¹æ®éœ€è¦å¼•å¯¼ç‰¹å®šæµé‡ã€‚æ­¤å¤–ï¼ŒVRFè®¾å¤‡å…è®¸VRFsåµŒå¥—åœ¨namespaceä¸­ã€‚namespaceæä¾›ç‰©ç†å±‚çš„æ¥å£éš”ç¦»ï¼Œvlanæä¾›L2çš„éš”ç¦»ï¼Œvrfæä¾›L3çš„éš”ç¦»ã€‚VRFè®¾å¤‡æ˜¯ä½¿ç”¨å…³è”çš„è·¯ç”±è¡¨åˆ›å»ºçš„ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼ŒVRFåœ¨é€»è¾‘ä¸Šå°†ä¸€ä¸ªè·¯ç”±å™¨æ¨¡æ‹Ÿæˆå¤šå°è·¯ç”±å™¨ï¼Œæ˜¯ä¸€ç§ç½‘ç»œè™šæ‹ŸåŒ–æŠ€æœ¯,VRFæ˜¯è·¯ç”±å™¨çš„è™šæ‹ŸåŒ–ï¼ŒVLANæ˜¯äº¤æ¢æœºçš„è™šæ‹ŸåŒ–ï¼Œtrunkæ˜¯å¯¹ç½‘ç»œè¿æ¥çš„è™šæ‹ŸåŒ–ã€‚VDOM(virtual domain)æ˜¯é˜²ç«å¢™çš„è™šæ‹ŸåŒ–, VMæ˜¯æœåŠ¡å™¨çš„è™šæ‹ŸåŒ–ã€‚</p>
<p>æ³¨æ„ï¼šä¸€ä¸ªL3æ¥å£åŒä¸€æ—¶é—´åªèƒ½å±äºä¸€ä¸ªVRFåŸŸ</p>
<h2 id="vrfçš„ä½œç”¨"><a href="#vrfçš„ä½œç”¨" class="headerlink" title="vrfçš„ä½œç”¨"></a>vrfçš„ä½œç”¨</h2><p>ä¸¤ç‚¹ï¼š<br>    1. æµé‡éš”ç¦»ï¼šéš”ç¦»ä¸åŒçš„vpnç”¨æˆ·,è§£å†³åœ°å€é‡å é—®é¢˜<br>    2. ç½‘ç»œè™šæ‹ŸåŒ–</p>
<h1 id="VRFä»¿çœŸå®éªŒ"><a href="#VRFä»¿çœŸå®éªŒ" class="headerlink" title="VRFä»¿çœŸå®éªŒ"></a>VRFä»¿çœŸå®éªŒ</h1><p>é’ˆå¯¹vrfçš„è·¯ç”±éš”ç¦»å’Œè§£å†³åœ°å€é‡å è¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œåœ¨GNS3ä¸Šé¢åšä¸¤ä¸ªç®€å•çš„ä»¿çœŸå®éªŒã€‚</p>
<h2 id="VRFè§£å†³åœ°å€é‡å -amp-amp-IPéš”ç¦»"><a href="#VRFè§£å†³åœ°å€é‡å -amp-amp-IPéš”ç¦»" class="headerlink" title="VRFè§£å†³åœ°å€é‡å  &amp;&amp; IPéš”ç¦»"></a>VRFè§£å†³åœ°å€é‡å  &amp;&amp; IPéš”ç¦»</h2><p>å®éªŒæ‹“æ‰‘å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/vrf_overlap_topo.png"><br>å…¶ä¸­ï¼ŒR1ã€R2ã€R4ã€R5æ¨¡æ‹Ÿä¸»æœºï¼ŒR3ä¸Šé¢åˆ›å»ºä¸¤ä¸ª<code>vrf</code>åŸŸ, R1ã€R2å±äº<code>vrf-2</code>, R4ã€R5å±äº<code>vrf-1</code>ã€‚å®éªŒé¢„æœŸæ˜¯R1å¯ä»¥pingé€šR2ï¼ŒR4å¯ä»¥pingé€šR5ã€‚<br>5å°è®¾å¤‡çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1&#x2F;R3:</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> no shutdown</span><br><span class="line"> ip address 192.168.1.2 255.255.255.0</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 192.168.1.1                # æ¨¡æ‹Ÿä¸»æœºï¼Œé…ç½®ç½‘å…³</span><br><span class="line"></span><br><span class="line">R2&#x2F;R4:</span><br><span class="line">interface Ethernet0&#x2F;3</span><br><span class="line"> no shutdown</span><br><span class="line"> ip address 202.100.10.2 255.255.255.0</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 202.100.10.1</span><br><span class="line"></span><br><span class="line">R3:</span><br><span class="line">ip vrf vrf-1                                        # åˆ›å»ºvrf-1</span><br><span class="line">!   </span><br><span class="line">ip vrf vrf-2                                        # åˆ›å»ºvrf-2</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip vrf forwarding vrf-1                            # æ¥å£åŠ å…¥vrf-1</span><br><span class="line"> ip address 192.168.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> no shutdown</span><br><span class="line"> ip vrf forwarding vrf-2                            # æ¥å£åŠ å…¥vrf-2</span><br><span class="line"> ip address 192.168.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;2</span><br><span class="line"> no shutdown</span><br><span class="line"> ip vrf forwarding vrf-1                            # æ¥å£åŠ å…¥vrf-1</span><br><span class="line"> ip address 202.100.10.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;3</span><br><span class="line"> no shutdown</span><br><span class="line"> ip vrf forwarding vrf-2                            # æ¥å£åŠ å…¥vrf-2</span><br><span class="line"> ip address 202.100.10.1 255.255.255.0</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹R3çš„è·¯ç”±è¡¨ï¼š<br><img src="https://rancho333.github.io/pictures/vrf_overlap_route.png"><br>è·¯ç”±è¡¨ç»“æœä¸é¢„æœŸç›¸ç¬¦ï¼Œé»˜è®¤è·¯ç”±è¡¨ä¸­æ²¡æœ‰å†…å®¹ï¼Œvrf-1å’Œvrf-2ä¸­åˆ†åˆ«æ˜¯å„è‡ªæ¥å£çš„ç›´è¿è·¯ç”±ã€‚</p>
<p>åŒæ—¶åœ¨R2å’ŒR5ä¸ŠæŠ“åŒ…ï¼Œåœ¨R1å’ŒR3ä¸Šping 202.100.10.2ï¼Œå‘ç°åªæœ‰åœ¨ç›¸åŒçš„vrfåŸŸä¸­æ‰èƒ½æ”¶åˆ°icmp(å³R1å¯ä»¥pingé€šR2ï¼ŒR4å¯ä»¥pingé€šR5)ï¼Œå®éªŒç»“æœç¬¦åˆé¢„æœŸã€‚</p>
<h2 id="VRFè·¯ç”±éš”ç¦»ä»¥åŠè·¯ç”±æ³„éœ²"><a href="#VRFè·¯ç”±éš”ç¦»ä»¥åŠè·¯ç”±æ³„éœ²" class="headerlink" title="VRFè·¯ç”±éš”ç¦»ä»¥åŠè·¯ç”±æ³„éœ²"></a>VRFè·¯ç”±éš”ç¦»ä»¥åŠè·¯ç”±æ³„éœ²</h2><p>VRFå¯ä»¥éš”ç¦»ä¸åŒVPNç”¨æˆ·ä¹‹é—´çš„è·¯ç”±ï¼Œå³å¯ä»¥å®ç°L3å±‚çº§çš„éš”ç¦»ï¼ŒåŒæ—¶é€šè¿‡vrf-leakå¯ä»¥å®ç°ä¸åŒvrfä¹‹é—´çš„äº’é€šã€‚è·¯ç”±éš”ç¦»ä¸æ³„éœ²ä½¿ç”¨ç›¸åŒçš„æ‹“æ‰‘ï¼š<br><img src="https://rancho333.github.io/pictures/vrf_separation_topo.png"><br>é…ç½®å‚ç…§<code>VRFè§£å†³åœ°å€é‡å </code>çš„å®éªŒï¼Œæ ¹æ®æ‹“æ‰‘ä¿®æ”¹å¯¹åº”ç«¯å£ï¼Œä»¥åŠæ¨¡æ‹Ÿä¸»æœºçš„4å°è·¯ç”±å™¨ä¸Šä¿®æ”¹é»˜è®¤ç½‘å…³å³å¯ã€‚</p>
<p>æŸ¥çœ‹R3ä¸Šçš„è·¯ç”±è¡¨ï¼Œé»˜è®¤è·¯ç”±è¡¨ä¾ç„¶ä¸ºç©ºï¼Œè¿™é‡Œå°±ä¸çœ‹äº†ï¼š<br><img src="https://rancho333.github.io/pictures/vrf_separation_route.png"><br>VRFåˆ†åˆ«åŒ…å«å„è‡ªç½‘æ®µçš„è·¯ç”±ã€‚</p>
<p>åœ¨R2ä¸Šåˆ†åˆ«ping R1å’ŒR4ï¼Œç»“æœå¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/r2_ping_separation.png"><br>R2å¯ä»¥pingé€šåŒä¸€è·¯ç”±åŸŸä¸­çš„R1ï¼Œä¸èƒ½pingé€šå…¶å®ƒè·¯ç”±åŸŸä¸­çš„R4ï¼Œå®éªŒç»“æœç¬¦åˆé¢„æœŸã€‚</p>
<h3 id="vrfè·¯ç”±æ³„éœ²å®éªŒå¤±è´¥-åé¢æœ‰æœºä¼šå†æå§-å¤§æ¦‚ç‡æ˜¯é…ç½®é”™äº†"><a href="#vrfè·¯ç”±æ³„éœ²å®éªŒå¤±è´¥-åé¢æœ‰æœºä¼šå†æå§-å¤§æ¦‚ç‡æ˜¯é…ç½®é”™äº†" class="headerlink" title="vrfè·¯ç”±æ³„éœ²å®éªŒå¤±è´¥, åé¢æœ‰æœºä¼šå†æå§(å¤§æ¦‚ç‡æ˜¯é…ç½®é”™äº†)"></a>vrfè·¯ç”±æ³„éœ²å®éªŒå¤±è´¥, åé¢æœ‰æœºä¼šå†æå§(å¤§æ¦‚ç‡æ˜¯é…ç½®é”™äº†)</h3><p>vrfçš„è·¯ç”±æ³„éœ²æœ‰ä¸‰ç§æ–¹å‘ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>é»˜è®¤vrfâ€”â€”&gt;vrf</li>
<li>vrfâ€”â€”&gt;vrf</li>
<li>vrfâ€”â€”&gt;é»˜è®¤vrf<br>é»˜è®¤vrfå³ä¸ºå…¨å±€è·¯ç”±è¡¨ã€‚</li>
</ul>
<p>vrf-leakå¯ä»¥é€šè¿‡staticå’Œdynamicä¸¤ç§æ–¹å¼å®ç°ï¼Œåœ¨æ­¤è¿›è¡Œstaticå®éªŒã€‚ä¿®æ”¹é…ç½®è¿›è¡Œvrf-leakå®éªŒï¼Œåœ¨R3ä¸Šæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;&#96;&#96;</span><br><span class="line"></span><br><span class="line">## RD &amp; RT</span><br><span class="line">RD(route distinguish)è·¯ç”±åŒºåˆ†æ ‡è¯†ï¼Œå› ä¸ºä¸åŒçš„vrfä¸­å¯èƒ½æœ‰ç›¸åŒåœ°å€ï¼Œé€ æˆåœ°å€overlapping, åœ¨ipv4åœ°å€ä¹‹å‰åŠ ä¸Š64ä½çš„RDï¼Œå½¢æˆå…¨å±€å”¯ä¸€çš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€å½¢æˆä¸€ä¸ªæ–°çš„åœ°å€æ—address family vpnv4ï¼Œåœ¨MP-BGPä¸­æœ‰ä½“ç°ã€‚æ¯ä¸ªvrfæœ‰å…¨å±€å”¯ä¸€çš„RDã€‚RDçš„æœ¬è´¨æ˜¯é¿å…ipåœ°å€å†²çªã€‚</span><br><span class="line"></span><br><span class="line">RT(route target)è·¯ç”±ç›®æ ‡ï¼Œæ¯ä¸ªvrfä¼šæœ‰import rtå’Œexport rtå±æ€§ï¼Œä»vrfä¸­exportçš„è·¯ç”±ä¼šæ‰“ä¸Šexport rtçš„æ ‡è®°ï¼Œé€šè¿‡MP-BGPçš„æ‰©å±•å›¢ä½“å±æ€§æ‰¿è½½ï¼Œå¯¹ç«¯æ¥æ”¶åˆ°åï¼Œå°†æœ¬åœ°vrfçš„import rtä¸MP-BGPä¸­çš„rtåšå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒåˆ™å¼•å…¥ã€‚æ¯ä¸ªvrfå¯ä»¥å®šä¹‰å¤šä¸ªimport rtå’Œexport rt. RTæœ¬è´¨æ˜¯æ ‡è®°è·¯ç”±ï¼Œç”¨ä»¥è·¨è®¾å¤‡vrfä¸­ä¼ é€’æŒ‡å®šè·¯ç”±ã€‚</span><br><span class="line"></span><br><span class="line"># F-Vrf</span><br><span class="line">F-Vrfæ˜¯front door VRFçš„ç®€ç§°ã€‚</span><br><span class="line"></span><br><span class="line">åœ¨ä½¿ç”¨GREéš§é“çš„åœºæ™¯ä¸‹ï¼Œéš§é“çš„ç‰©ç†æ¥å£æ˜¯underlayï¼Œè¢«å°è£…çš„æµé‡ï¼ˆç§ç½‘ï¼‰æ˜¯overlayï¼Œéš§é“tunnelè™šæ¥å£åœ¨ä¸¤è€…ç›´æ¥èµ·æ¡¥æ¢ä½œç”¨ï¼Œå°†ç§ç½‘æµé‡è·¯ç”±åˆ°tunnelæ¥å£åå³å¯è¿›è¡Œgreå°è£…ã€‚ä¸ºäº†ä¼ é€’éš§é“ä¸¤ç«¯ç§ç½‘çš„è·¯ç”±ï¼Œéœ€è¦å°†ç§ç½‘æ¥å£åŠtunnelæ¥å£åŠ å…¥åŠ¨æ€è·¯ç”±è®¡ç®—(æ¯”å¦‚eigrp)ï¼ŒåŒæ—¶underlayä¹‹é—´ä¹Ÿä¼šè¿è¡ŒIGP(æ¯”å¦‚ospf)ä¿è¯IPè¿é€šæ€§ã€‚å¦‚æœtunnelåœ°å€ä¸éš§é“ç‰©ç†æ¥å£åœ°å€ç½‘æ®µå†²çªï¼Œå¦‚tunnelæ˜¯10.9.8.0&#x2F;24ï¼Œç‰©ç†æ¥å£æ˜¯10.204.12.0&#x2F;24ï¼Œä½†æ˜¯åœ¨è·¯ç”±åè®®ä¸­é€šå‘Šçš„æ˜¯10.0.0.0&#x2F;8, é‚£ä¹ˆè®¾å¤‡ä¼šåŒæ—¶ä»eigrpå’Œospfå­¦åˆ°è¯¥ç½‘æ®µè·¯ç”±ï¼Œä¸”æ˜¯ä¸åŒå‡ºå£ï¼Œtunnelæ¥å£ä¼šdownæ‰ã€‚</span><br><span class="line"></span><br><span class="line">å°†éš§é“ç‰©ç†æ¥å£ä»globalè·¯ç”±è¡¨ä¸­ç§»é™¤å°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜äº†ï¼Œéš§é“ç‰©ç†æ¥å£å°±æ˜¯front doorï¼Œä»front doorè¿›æ¥å°±æ˜¯æˆ‘ä»¬çš„ç§ç½‘ï¼Œæ‰€ä»¥å°†éš§é“ç‰©ç†æ¥å£åŠ å…¥çš„vrfå«åšfvrfã€‚ç®€è¨€ä¹‹ï¼Œ*fvrfç”¨äºå°†è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œçš„è·¯ç”±è¡¨ä¸å…¨å±€è·¯ç”±è¡¨åˆ†å¼€*ã€‚</span><br><span class="line">åœ¨å®é™…é…ç½®ä¸Šï¼Œå°†ç‰©ç†æ¥å£åŠ å…¥æŒ‡å®švrfï¼Œç‰©ç†æ¥å£æ‰€å±çš„IGPä¹Ÿè¦åœ¨è¯¥vrfä¸­ï¼Œåœ¨tunnelæ¥å£ä¸Šé€šè¿‡&#96;tunnel vrf vrf-name&#96;æŒ‡å®šéš§é“ç‰©ç†æ¥å£æ‰€å±çš„vrfã€‚</span><br><span class="line"></span><br><span class="line"># SONiC test case of VRF</span><br><span class="line"></span><br><span class="line">åŸºæœ¬é—®é¢˜æè¿°ï¼štest caseåœºæ™¯ä¸‹ï¼Œå•ä¸ªVRFä¸­å­˜åœ¨12.8K(6.4Kçš„IPv4å’Œ6.4Kçš„IPv6)è·¯ç”±æ¡ç›®ï¼Œåˆ é™¤VRFæ—¶ï¼Œä¸€å®šæ—¶é—´å†…éœ€è¦åˆ é™¤å¤§é‡è·¯ç”±ã€‚é‡Œé¢æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</span><br><span class="line">  1. zebraçš„fpm clientä¸èƒ½å°†æ‰€æœ‰æ•°æ®åŒæ­¥ç»™fpm server</span><br><span class="line">  2. åˆ é™¤VRFä¸­é»˜è®¤è·¯ç”±æ—¶å‡ºé”™</span><br><span class="line"></span><br><span class="line">## åˆ›å»ºVRFæ—¶éœ€è¦å…³æ³¨çš„å‡ ä¸ªå¯¹è±¡</span><br><span class="line">![](https:&#x2F;&#x2F;rancho333.github.io&#x2F;pictures&#x2F;vrf_about_objects.png)</span><br><span class="line"></span><br><span class="line">æ³¨æ„ï¼š</span><br><span class="line">  1. ä¸€ä¸ªVRFä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªL3 æ¥å£ï¼Œåˆ›å»ºæ¥å£ä¼šå¢åŠ è¯¥VRFçš„reference count</span><br><span class="line">  2. ä¸€ä¸ªL3 æ¥å£ä¸ŠåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªIPï¼Œåˆ›å»ºIPä¼šå¢åŠ è¯¥æ¥å£çš„reference count</span><br><span class="line">  3. ä¸€ä¸ªIPå¯¹åº”ä¸€ä¸ªé‚»å±…ï¼Œå¢åŠ neighbourä¼šå¢åŠ è¯¥IPçš„reference count</span><br><span class="line">  4. æœ‰äº†neighbourä¹‹åï¼Œè·¯ç”±åè®®ä¼šåˆ›å»ºè·¯ç”±æ¡ç›®(route entry)ï¼Œå¢åŠ route entryä¼šå¢åŠ å¯¹VRFçš„reference count</span><br><span class="line">  5. route entryä¸­çš„ä¸€ä¸ªé‡è¦å‚æ•°æ˜¯next hop(å¯èƒ½ä¼šæœ‰å¤šä¸ªnext hop)ï¼Œå¢åŠ next hopä¼šå¢åŠ å¯¹route entryçš„reference count</span><br><span class="line"></span><br><span class="line">å½“ä¸€ä¸ªå¯¹è±¡çš„reference countä¸ä¸º0æ—¶ï¼Œæ˜¯ä¸èƒ½å°†å…¶åˆ é™¤çš„ï¼Œå¿…é¡»å½»åº•çš„è§£å†³å…¶ä¾èµ–å…³ç³»ã€‚</span><br><span class="line"></span><br><span class="line">## SONiCæ•°æ®åŒæ­¥æœºåˆ¶çš„ç¼ºé™·ï¼Œä»¥åˆ é™¤VRFä¸ºä¾‹</span><br><span class="line">![](https:&#x2F;&#x2F;rancho333.github.io&#x2F;pictures&#x2F;vrf_del_vrf.png)</span><br><span class="line">vrfmgrdä¼šé™·å…¥loopç­‰å¾…vrforchåˆ é™¤æ•°æ®åº“ä¸­stateobjectvrfæ¡ç›®ï¼Œå¦‚æœvrforchæ‰§è¡Œå¤±è´¥ï¼Œvrfmgrdä¼šé™·å…¥æ­»å¾ªç¯ã€‚</span><br><span class="line"></span><br><span class="line">## zebraåˆ°fpmsyncd(bgp)åŒæ­¥è·¯ç”±çš„è¿‡ç¨‹ä»¥åŠä¹‹å‰ç‰ˆæœ¬çš„ç¼ºé™·(ä»¥åˆ é™¤ipä¸ºä¾‹)</span><br><span class="line">![](https:&#x2F;&#x2F;rancho333.github.io&#x2F;pictures&#x2F;vrf_del_ip.png)</span><br><span class="line"></span><br><span class="line">åŸºæœ¬æµç¨‹ï¼š</span><br><span class="line">1. SONiCé€šè¿‡Linux shellåˆ é™¤L3çš„IP</span><br><span class="line">2. zebraé€šè¿‡netlinkåŒæ­¥ä¿¡æ¯å¹¶é€šçŸ¥ç»™ä¸ªè·¯ç”±è¿›ç¨‹</span><br><span class="line">3. è·¯ç”±è¿›ç¨‹å†³ç­–è·¯ç”±ä¿¡æ¯é€šçŸ¥ç»™zebra</span><br><span class="line">4. zebraå†³ç­–è·¯ç”±ä¿¡æ¯ï¼Œé€šè¿‡netlinkåŒæ­¥ç»™kernelï¼Œé€šè¿‡fpmåŒæ­¥ç»™sonicç«¯çš„fpmsyncd</span><br><span class="line">5. zebraç«¯fpm clientå†™æœºåˆ¶æœ‰ç¼ºé™·(write bufferè¾ƒå°ï¼Œæœ‰å†™æ¬¡æ•°çš„é™åˆ¶)ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±</span><br><span class="line">6. ä¿®æ”¹æ–¹å¼ï¼Œåœ¨æ­¥éª¤1ä¸­åˆ é™¤IPåæ·»åŠ æ—¶å»¶ï¼Œå‡å°‘zebraå•ä½æ—¶é—´å†…å¤„ç†çš„è·¯ç”±ä¿¡æ¯ï¼Œç»™frræ·»åŠ å¦‚ä¸‹patchï¼Œè§£å†³fpm clientå†™ç¼ºé™·</span><br></pre></td></tr></table></figure>
<p> zebra/zebra_fpm.c |    4 ++â€“<br> 1 file changed, 2 insertions(+), 2 deletions(-)</p>
<p>diff â€“git a/zebra/zebra_fpm.c b/zebra/zebra_fpm.c<br>index 7b0611bf9..4efa8c896 100644<br>â€” a/zebra/zebra_fpm.c<br>+++ b/zebra/zebra_fpm.c<br>@@ -62,7 +62,7 @@ DEFINE_MTYPE_STATIC(ZEBRA, FPM_MAC_INFO, â€œFPM_MAC_INFOâ€);</p>
<ul>
<li>The maximum number of times the FPM socket write callback can call</li>
<li>â€˜writeâ€™ before it yields.</li>
<li>/</li>
</ul>
<p>-#define ZFPM_MAX_WRITES_PER_RUN 10<br>+#define ZFPM_MAX_WRITES_PER_RUN 100</p>
<p> /*</p>
<ul>
<li>Interval over which we collect statistics.<br>@@ -929,7 +929,7 @@ enum {<br>FPM_GOTO_NEXT_Q = 1<br>};</li>
</ul>
<p>-#define FPM_QUEUE_PROCESS_LIMIT 10000<br>+#define FPM_QUEUE_PROCESS_LIMIT 50000</p>
<p>```<br>æ³¨æ„SONiCä¸­frrçš„ç¼–è¯‘æœºåˆ¶ï¼Œsonic-frrç›®å½•ä¸‹çš„Makefileä¼šcheckoutåˆ°æŒ‡å®šåˆ†æ”¯ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹çš„ä»£ç å†…å®¹ä¼šè¢«è¦†ç›–ã€‚</p>
<h2 id="å…³äºåˆ é™¤VRFä¸­é»˜è®¤è·¯ç”±å‡ºé”™"><a href="#å…³äºåˆ é™¤VRFä¸­é»˜è®¤è·¯ç”±å‡ºé”™" class="headerlink" title="å…³äºåˆ é™¤VRFä¸­é»˜è®¤è·¯ç”±å‡ºé”™"></a>å…³äºåˆ é™¤VRFä¸­é»˜è®¤è·¯ç”±å‡ºé”™</h2><p>alpmæ¨¡å¼ä¸‹ï¼Œbroadcom TH4èŠ¯ç‰‡åœ¨åˆ›å»ºVRFæ—¶ä¼šåˆ›å»ºä¸€æ¡é»˜è®¤è·¯ç”±(åªå­˜åœ¨äºASICä¸­ï¼Œä¸Šå±‚åè®®ä¸å¯è§)<br>å½“VRFåªå­˜åœ¨é»˜è®¤è·¯ç”±æ—¶ï¼Œåˆ é™¤VRFä¼šè‡ªåŠ¨åˆ é™¤é»˜è®¤è·¯ç”±ï¼Œå¦‚æœæ­¤æ—¶æ˜¾ç¤ºåˆ é™¤é»˜è®¤è·¯ç”±ï¼Œå¯ä»¥æˆåŠŸï¼›<br>å½“VRFä¸­å­˜åœ¨é»˜è®¤è·¯ç”±ä»¥åŠå…¶å®ƒè·¯ç”±æ—¶ï¼Œä¸èƒ½æ˜¾ç¤ºåˆ é™¤é»˜è·¯ç”±</p>
<p>åŸæœ‰ï¼ŒSONiCä¸Šå±‚é€»è¾‘SWSSä¸­ï¼Œå½“åˆ é™¤default VRFä¸­çš„é»˜è®¤è·¯ç”±æ—¶ï¼Œå°†å…¶è®¾ç½®ä¸ºblackholeè·¯ç”±ï¼Œå½“åˆ é™¤VRFä¸­çš„é»˜è®¤è·¯ç”±æ—¶ï¼Œä¸‹å‘åˆ é™¤æŒ‡ä»¤ï¼Œç”±äºVRFä¸­è¿˜æœ‰å…¶å®ƒè·¯ç”±ä¿¡æ¯ï¼ŒSDKæŠ¥é”™</p>
<p>ä¿®æ”¹ä¸ºï¼šå½“SONiCä¸‹å‘åˆ é™¤VRFä¸­é»˜è®¤è·¯ç”±æŒ‡ä»¤æ—¶ï¼Œåœ¨SAIä¸­å°†å…¶å®é™…è¡Œä¸ºä¿®æ”¹ä¸ºï¼šå°†è¯¥é»˜è®¤è·¯ç”±é…ç½®æˆé»‘æ´è·¯ç”±<br>      å¦‚æœä¿®æ”¹SONiCä¸­çš„åˆ é™¤æŒ‡ä»¤ä¸ºé…ç½®æˆé»‘æ´è·¯ç”±ï¼Œé‚£ä¹ˆåœ¨è¯¥VRFä¸­ï¼Œä¾ç„¶å­˜åœ¨ä¸€ä¸ªroute entryï¼Œé‚£ä¹ˆè¯¥VRFå°±å­˜åœ¨reference countï¼Œé‚£ä¹ˆè¯¥VRFå°±æ— æ³•åˆ é™¤</p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://datatracker.ietf.org/doc/html/rfc2685">rfc2685</a></p>
<p><a href="https://datatracker.ietf.org/doc/html/rfc4364">rfc4364</a></p>
<p><a href="https://github.com/Azure/SONiC/blob/master/doc/vrf/sonic-vrf-hld.md">SONiC VRF support design spec draft</a></p>
<p><a href="https://www.cisco.com/c/en/us/td/docs/net_mgmt/prime/network/3-8/reference/guide/vrf.html">VPN and VRF of cisco</a></p>
<p><a href="https://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst4500/12-2/15-02SG/configuration/guide/config/vrf.html#85589">Config vrf of cisco</a></p>
<p><a href="https://www.kernel.org/doc/html/latest/networking/vrf.html">Vrf of linux kernel</a></p>
<p><a href="https://networkingwithfish.com/tunnels-and-the-use-of-front-door-vrfs/">Tunnels and the Use of Front Door VRFs</a></p>
]]></content>
      <tags>
        <tag>vrf</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€äº›shellåŸºç¡€çŸ¥è¯†</title>
    <url>/2020/03/06/%E4%B8%80%E4%BA%9Bshell%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ€å¼€å§‹æ¥è§¦åˆ°çš„å‘½ä»¤è¡Œæ˜¯windowsçš„cmdï¼Œä¸€æ¬¡ç”¨å®ƒæ¥æŸ¥ipæ„Ÿè§‰å¾ˆç¥å¥‡ã€‚åæ¥æ¥è§¦åˆ°Linuxï¼Œvimï¼Œä»èµ·åˆçš„æŠµè§¦ä¸é€‚åº”ï¼Œåˆ°åæ¥çš„å¾—å¿ƒåº”æ‰‹ã€‚ä½¿ç”¨å‘½ä»¤è¡Œï¼Œç¦»è®¡ç®—æœºæ›´è¿‘ã€‚è¿™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹shellä¸‹é¢çš„ä¸€äº›ç»†èŠ‚ã€‚åˆ†ä¸º</p>
<span id="more"></span>
<ol>
<li>æ ‡å‡†è¾“å…¥å’Œå‘½ä»¤å‚æ•°çš„åŒºåˆ«</li>
<li>åœ¨åå°è¿è¡Œçš„å‘½ä»¤é€€å‡ºç»ˆç«¯ä¹Ÿå°±å…¨éƒ¨é€€å‡ºäº†</li>
<li>å•å¼•å·å’ŒåŒå¼•å·è¡¨ç¤ºå­—ç¬¦ä¸²çš„åŒºåˆ«</li>
<li>æœ‰çš„å‘½ä»¤å’Œ<code>sudo</code>ä¸€èµ·ç”¨å°±<code>command not found</code></li>
</ol>
<h1 id="æ ‡å‡†è¾“å…¥å’Œå‚æ•°çš„åŒºåˆ«"><a href="#æ ‡å‡†è¾“å…¥å’Œå‚æ•°çš„åŒºåˆ«" class="headerlink" title="æ ‡å‡†è¾“å…¥å’Œå‚æ•°çš„åŒºåˆ«"></a>æ ‡å‡†è¾“å…¥å’Œå‚æ•°çš„åŒºåˆ«</h1><p>æœ€åˆé‡åˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™æ˜¯åœ¨shellä¸‹é¢ä½¿ç”¨<code>ç®¡é“</code>æ“ä½œï¼Œä¾‹å¦‚ï¼š<code>find ./ -name &quot;*.c&quot; | xargs grep -rn zhw</code>,è¿™æ¡å‘½ä»¤çš„å«ä¹‰æ˜¯ï¼šåœ¨å½“å‰è·¯å¾„ä¸‹çš„æ‰€æœ‰<code>.c</code>æ–‡ä»¶ä¸­æŸ¥æ‰¾<code>zhw</code>å…³é”®å­—ï¼Œæ³¨æ„è¿™é‡Œåœ¨ç®¡é“çš„å³ä¾§åŠ äº†å…³é”®å­—<code>xargs</code>ï¼Œè¡¨ç¤ºå°†<code>find</code>æ‰¾åˆ°çš„ç»“æœä½œä¸º<em>å‚æ•°</em>ä¼ é€’ç»™<code>grep</code>ï¼Œå¦åˆ™grepåˆ™æ˜¯ç›´æ¥æŸ¥æ‰¾æ ‡å‡†è¾“å…¥ä¸­çš„å†…å®¹ï¼ŒåŠ ä¸Šxargså‚æ•°ååˆ™æ˜¯æŸ¥æ‰¾æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚</p>
<p>æ ‡å‡†è¾“å…¥å°±æ˜¯ç¼–ç¨‹è¯­è¨€ä¸­è¯¸å¦‚<code>scanf</code>æˆ–è€…<code>readline</code>è·å–åˆ°çš„ä¿¡æ¯ï¼›è€Œå‚æ•°æ˜¯æŒ‡ç¨‹åºçš„<code>main</code>å‡½æ•°ä¼ å…¥çš„<code>args</code>å­—ç¬¦ä¸²æ•°ç»„ã€‚ç®¡é“ç¬¦å’Œé‡å®šå‘ç¬¦éƒ½æ˜¯å°†æ•°æ®ä½œä¸ºç¨‹åºçš„æ ‡å‡†è¾“å…¥ï¼Œä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼š<br><img src="https://rancho333.github.io/pictures/grep.png"></p>
<ol>
<li>grepè¦æœç´¢çš„æ–‡ä»¶ä½œä¸ºå‚æ•°æ˜¯å¯é€‰çš„ï¼Œ<code>-r</code>å¯ä»¥åœ¨å½“å‰è·¯å¾„ä¸‹é€’å½’æŸ¥æ‰¾</li>
<li>findä¸åŠ xargså’Œç›´æ¥grepæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œè¯´æ˜æ²¡æœ‰æŒ‡å®šæŸ¥æ‰¾æ–‡ä»¶ï¼Œè€Œä½¿ç”¨xargsåˆ™æŒ‡å®šäº†æŸ¥æ‰¾æ–‡ä»¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™grep</li>
</ol>
<p>è¿™é‡Œå¤šè¯´ä¸€ç‚¹ï¼š<br><img src="https://rancho333.github.io/pictures/find.png"><br>é€šå¸¸ä½¿ç”¨findå‘½ä»¤æŸ¥æ‰¾ç‰¹å®šçš„æ–‡ä»¶ï¼Œç„¶åå†è¿™äº›æ–‡ä»¶ä¸­ç”¨grepå»åŒ¹é…å…³é”®å­—ï¼Œä½†æ˜¯å¦‚æœfindçš„ç»“æœæ˜¯ç©ºï¼Œé‚£ä¹ˆé€šè¿‡xargsæ–¹å¼å°±ç›¸å½“äºæ²¡æœ‰ç»™grepæŒ‡æ˜ç‰¹å®šæŸ¥æ‰¾æ–‡ä»¶ï¼ˆå®ƒå°±ä¼šåœ¨å½“å‰ç›®å½•é€’å½’ï¼‰,è€Œé€šè¿‡<code>-exec</code>åˆ™è¡¨ç¤ºå¯¹åŒ¹é…çš„æ–‡ä»¶æ‰§è¡Œè¯¥å‚æ•°æ‰€ç»™å‡ºçš„shellå‘½ä»¤ï¼Œæ­¤æ—¶grepå®é™…å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œè¿™æ‰ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸç»“æœã€‚</p>
<p>ä¸Šé¢ä¸¤ä¸ªå°ä¾‹å­ï¼Œç†è§£é—®é¢˜çš„æœ¬è´¨æ˜¯å¤šä¹ˆçš„é‡è¦ï¼ŒåŸºç¡€æ‰“ç‰¢å›ºï¼ŒèŠ±å“¨çš„ä¸œè¥¿å°±éšä¾¿ç©äº†ï¼<br>é™¤äº†<code>xargs</code>å¯ä»¥è¯»å–æ•°æ®ä½œä¸ºå‘½ä»¤å‚æ•°å¤–ï¼Œé€šè¿‡<code>$(cmd)</code>å½¢å¼ä¹Ÿèƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä¾‹å¦‚ï¼š<br><img src="https://rancho333.github.io/pictures/grep.png"></p>
<p><code>$(cmd)</code>è¯»å–<code>cmd</code>å‘½ä»¤è¾“å‡ºçš„æ•°æ®ä½œä¸ºå‚æ•°ã€‚</p>
<p>æœ€åè¯´ä¸€ä¸‹å¦‚ä½•åŒºåˆ†å‘½ä»¤èƒ½å¤Ÿæ¥å—æ ‡å‡†è¾“å…¥è¿˜æ˜¯å‚æ•°ï¼šå¦‚æœå‘½ä»¤èƒ½å¤Ÿè®©ç»ˆç«¯é˜»å¡ï¼Œè¯´æ˜è¯¥å‘½ä»¤èƒ½æ¥å—æ ‡å‡†è¾“å…¥ï¼Œåä¹‹å°±æ˜¯ä¸æ¥å—ã€‚<code>rm</code>å‘½ä»¤æ˜¯ä¸æ¥å—æ ‡å‡†è¾“å…¥çš„ã€‚<br><img src="https://rancho333.github.io/pictures/block.png"></p>
<h1 id="åå°è¿è¡Œç¨‹åº"><a href="#åå°è¿è¡Œç¨‹åº" class="headerlink" title="åå°è¿è¡Œç¨‹åº"></a>åå°è¿è¡Œç¨‹åº</h1><p>å¦‚æœä¸€äº›æœåŠ¡éœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œæ¯”å¦‚mainå‡½æ•°é‡Œé¢æœ‰ä¸ª<code>while(1)</code>çš„æ­»å¾ªç¯ï¼Œç¨‹åºè¿è¡Œåå‘½ä»¤è¡Œä¼šé˜»å¡ã€‚åœ¨å‘½ä»¤ååŠ ä¸Š<code>&amp;</code>åç¨‹åºå°±å¯ä»¥åœ¨åå°è¿è¡Œè€Œä¸ä¼šé˜»å¡å‘½ä»¤è¡Œã€‚åº•å±‚çš„åŸç†æˆ–è€…è¯´è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<p>æ¯ä¸€ä¸ªå‘½ä»¤è¡Œç»ˆç«¯éƒ½æ˜¯ä¸€ä¸ªshellè¿›ç¨‹ï¼Œæ¯å½“æœ‰å‘½ä»¤éœ€è¦æ‰§è¡Œæ˜¯shellä¼šforkä¸€ä¸ªå­è¿›ç¨‹å»æ‰§è¡Œå‘½ä»¤ï¼Œè€Œshellè¿›ç¨‹ä¼šé˜»å¡ï¼Œç­‰å¾…å­shellè¿›ç¨‹é€€å‡ºæ‰é‡æ–°å“åº”ã€‚å†™ä¸€ä¸ªå¾ˆç®€å•çš„demo</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void main()                                                                                           </span><br><span class="line">&#123;</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŠ ä¸Š<code>&amp;</code>åï¼Œåªæ˜¯è®©shellè¿›ç¨‹ä¸å†é˜»å¡ï¼Œå¯ä»¥ç»§ç»­å“åº”ä½ çš„æ–°å‘½ä»¤ï¼Œä½†æ˜¯å½“ä½ å…³æ‰è¿™ä¸ªshellå‘½ä»¤è¡Œä¸­ç»ˆç«¯åï¼Œä¾é™„äºå®ƒçš„æ‰€æœ‰å­è¿›ç¨‹éƒ½ä¼šé€€å‡ºã€‚å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/ps.png"><br>ä½†æ˜¯å¦‚æœ<code>(cmd &amp;)</code>è¿™æ ·æ¥è¿è¡Œå‘½ä»¤ï¼Œåˆ™æ˜¯å°†<code>cmd</code>æŒ‚åˆ°ä¸€ä¸ª<code>systemd</code>ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ä¸‹ï¼Œè¿™æ ·å³ä½¿å½“ç»ˆç«¯é€€å‡ºåï¼Œå¯¹äºåˆšæ‰çš„å‘½ä»¤ä¹Ÿæ²¡æœ‰å½±å“ã€‚å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/nohup.png"><br>ä¸è¿‡<code>nohup cmd &amp;</code>çš„åšæ³•ä¼¼ä¹å¸¸è§ä¸€äº›ï¼ŒåŸç†ç±»ä¼¼ã€‚æ­¤å¤–è¿˜å¯ä»¥è¯•è¯•<code>tmux</code>è¿™ä¸ªå°å·¥å…·ï¼Œå¦‚æœåˆ©ç”¨æ™šä¸Šçš„æ—¶å€™åœ¨æœåŠ¡å™¨ç¼–è¯‘å¤§å‹é¡¹ç›®ï¼Œè¿™ç©æ„æŒºå¥½ç”¨çš„ï¼Œä¸ç”¨æ‹…å¿ƒæ–­ç½‘ï¼ˆç»ˆç«¯è¢«killï¼‰ã€‚</p>
<h1 id="å•å¼•å·å’ŒåŒå¼•å·çš„åŒºåˆ«"><a href="#å•å¼•å·å’ŒåŒå¼•å·çš„åŒºåˆ«" class="headerlink" title="å•å¼•å·å’ŒåŒå¼•å·çš„åŒºåˆ«"></a>å•å¼•å·å’ŒåŒå¼•å·çš„åŒºåˆ«</h1><p>ä½¿ç”¨<code>set -x</code>å‘½ä»¤ï¼Œå¯ä»¥å¼€å¯shellçš„å‘½ä»¤å›æ˜¾ã€‚</p>
<p>å¯¹äºå•å¼•å·ï¼šæ‰€è§å³æ‰€å¾—ï¼Œä¼šå°†å•å¼•å·å†…çš„å†…å®¹åŸæ ·è¾“å‡º</p>
<p>å¯¹äºåŒå¼•å·ï¼šæŠŠåŒå¼•å·å†…çš„å†…å®¹è¾“å‡ºå‡ºæ¥ï¼›å¦‚æœå†…å®¹ä¸­æœ‰å‘½ä»¤ã€å˜é‡ç­‰ï¼Œä¼šå…ˆæŠŠå˜é‡ã€å‘½ä»¤è§£æå‡ºç»“æœï¼Œç„¶ååœ¨è¾“å‡ºæœ€ç»ˆå†…å®¹æ¥ã€‚</p>
<p>ä¸åŠ å¼•å·ï¼šä¸ä¼šå°†å«æœ‰ç©ºæ ¼çš„å­—ç¬¦ä¸²è§†ä¸ºä¸€ä¸ªæ•´ä½“è¾“å‡º, å¦‚æœå†…å®¹ä¸­æœ‰å‘½ä»¤ã€å˜é‡ç­‰ï¼Œä¼šå…ˆæŠŠå˜é‡ã€å‘½ä»¤è§£æå‡ºç»“æœï¼Œç„¶ååœ¨è¾“å‡ºæœ€ç»ˆå†…å®¹æ¥ï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸­å¸¦æœ‰ç©ºæ ¼ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œåˆ™ä¸èƒ½å®Œæ•´çš„è¾“å‡ºï¼Œéœ€è¦æ”¹åŠ åŒå¼•å·ï¼Œä¸€èˆ¬è¿ç»­çš„å­—ç¬¦ä¸²ï¼Œæ•°å­—ï¼Œè·¯å¾„ç­‰å¯ä»¥ç”¨ã€‚æ‰€ä»¥åœ¨å†™shellè„šæœ¬çš„æ—¶å€™ä¸€å®šæ³¨æ„ä½¿ç”¨å°æ‹¬å·å’ŒåŒå¼•å·å“ˆï¼</p>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/ds.png"></p>
<h1 id="sudo-æ‰¾ä¸åˆ°å‘½ä»¤"><a href="#sudo-æ‰¾ä¸åˆ°å‘½ä»¤" class="headerlink" title="sudo æ‰¾ä¸åˆ°å‘½ä»¤"></a>sudo æ‰¾ä¸åˆ°å‘½ä»¤</h1><p>æœ‰æ—¶å€™æ™®é€šç”¨æˆ·å¯ä»¥å°çš„å‘½ä»¤ï¼ŒåŠ ä¸Š<code>sudo</code>ä¹‹åå´æŠ¥é”™<code>command not found</code>ï¼ŒåŸå› åœ¨äºè¿™ä¸ªå‘½ä»¤ä»…å­˜åœ¨ä¸è¯¥ç”¨æˆ·çš„ç¯å¢ƒå˜é‡PATHä¸­ã€‚è§£å†³æ–¹æ³•æ˜¯ï¼š</p>
<ol>
<li>ä½¿ç”¨ç»å¯¹è·¯å¾„è°ƒç”¨å‘½ä»¤</li>
<li>å°†å‘½ä»¤æ·»åŠ åˆ°éœ€è¦ä½¿ç”¨çš„ç”¨æˆ·çš„ç¯å¢ƒå˜é‡ä¸­<br>åŒæ ·çš„é“ç†ï¼Œrootç”¨æˆ·æˆ–å…¶ä»–ç”¨æˆ·çš„å‘½ä»¤å¦å¤–ä¸€äº›ç”¨æˆ·ä¹Ÿå¯èƒ½æ‰¾ä¸åˆ°ã€‚</li>
</ol>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://mp.weixin.qq.com/s/Nj58VYQc955bFukrt4Jm2Q">å…³äºLinux shellä½ å¿…é¡»çŸ¥é“çš„</a></p>
]]></content>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸­æ–­å­¦ä¹ </title>
    <url>/2020/03/10/%E4%B8%AD%E6%96%AD%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨ENOSç³»ç»Ÿç§»æ¤çš„è¿‡ç¨‹ä¸­éœ€è¦è°ƒè¯•CPUå’Œäº¤æ¢èŠ¯ç‰‡çš„ä¸­æ–­ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹å¯¹ä¸­æ–­çš„å­¦ä¹ ï¼</p>
<span id="more"></span>
<h1 id="ä¸­æ–­ç®€ä»‹"><a href="#ä¸­æ–­ç®€ä»‹" class="headerlink" title="ä¸­æ–­ç®€ä»‹"></a>ä¸­æ–­ç®€ä»‹</h1><p>Linuxå†…æ ¸éœ€è¦å¯¹è¿æ¥åˆ°è®¡ç®—æœºä¸Šçš„æ‰€æœ‰ç¡¬ä»¶è®¾å¤‡è¿›è¡Œç®¡ç†ï¼Œä»–ä»¬ä¹‹é—´éœ€è¦äº’ç›¸é€šä¿¡ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä»¥å®ç°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. è½®è¯¢ï¼ˆpollingï¼‰å†…æ ¸å®šæœŸå¯¹è®¾å¤‡çš„çŠ¶æ€è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶ååšå‡ºç›¸åº”çš„å¤„ç†</span><br><span class="line">2. ä¸­æ–­ï¼ˆinterruptï¼‰è®©ç¡¬ä»¶åœ¨éœ€è¦çš„æ—¶å€™å‘å†…æ ¸å‘å‡ºä¿¡å·ï¼ˆå˜å†…æ ¸ä¸»åŠ¨ä¸ºç¡¬ä»¶ä¸»åŠ¨ï¼‰</span><br></pre></td></tr></table></figure>
<p>è½®è¯¢æ˜¯å‘¨æœŸæ€§çš„é‡å¤æ‰§è¡Œï¼Œå¤§é‡è€—ç”¨CPUçš„æ—¶é—´ï¼Œæ•ˆç‡æ¯”è¾ƒä½ï¼Œå¯¹äºå®æ—¶æ€§æ¯”è¾ƒé«˜çš„æ“ä½œï¼Œè‚¯å®šæ˜¯ä¸é€‚ç”¨çš„ã€‚</p>
<p>ä»ç‰©ç†å­¦çš„è§’åº¦çœ‹ï¼Œä¸­æ–­æ˜¯ä¸€ç§ç”µä¿¡å·ï¼Œç”±ç¡¬ä»¶è®¾å¤‡äº§ç”Ÿï¼Œå¹¶ç›´æ¥é€å…¥ä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¦‚8259Aï¼‰çš„è¾“å…¥å¼•è„šä¸Šï¼Œç„¶åå†ç”±ä¸­æ–­æ§åˆ¶å™¨å‘CPUå‘é€ç›¸åº”çš„ä¿¡å·ã€‚å¤„ç†å™¨æ£€æµ‹åˆ°è¯¥ä¿¡å·ï¼Œä¾¿ä¸­æ–­å½“å‰æ­£åœ¨å¤„ç†çš„å·¥ä½œï¼Œè½¬è€Œå»å¤„ç†ä¸­æ–­ã€‚å¯¹äºè½¯ä»¶å¼€å‘äººå‘˜ï¼Œä¸€èˆ¬éœ€è¦ç”¨åˆ°çš„å°±æ˜¯ä¸­æ–­å·å’Œä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p>
<p>æä¸€ä¸‹ï¼ŒPCIEå¯ä»¥é€šè¿‡MSI(message signaled interrupts)æ–¹å¼å®ç°ä¸­æ–­ï¼š<br><img src="https://rancho333.github.io/pictures/msi.png"><br>CPué‡Œé¢æœ‰ä¸€æ®µç‰¹æ®Šçš„å¯„å­˜å™¨ç©ºé—´ï¼Œå¾€è¿™ä¸ªå¯„å­˜å™¨é‡Œé¢å†™æ•°æ®ï¼Œå°±ä¼šè§¦å‘CPUä¸­æ–­ã€‚pciè®¾å¤‡ç»è¿‡é…ç½®ä»¥åï¼Œä¸€æ—¦éœ€è¦ä¸ŠæŠ¥ä¸­æ–­å°±ä¼šå¾€cpuè¿™ç§å¯„å­˜å™¨é‡Œé¢å†™ä¸€ä¸ªå€¼ï¼Œè§¦å‘cpuä¸­æ–­ã€‚</p>
<p>ä¸­æ–­çš„å¤„ç†æµç¨‹ï¼š</p>
<ol>
<li>ä¿å­˜ç°åœº</li>
<li>æ‰§è¡Œä¸­æ–­</li>
<li>æ¢å¤è¢«ä¸­æ–­è¿›ç¨‹çš„ç°åœºï¼Œç»§ç»­æ‰§è¡Œ</li>
</ol>
<h2 id="ä¸­æ–­åˆ†ç±»"><a href="#ä¸­æ–­åˆ†ç±»" class="headerlink" title="ä¸­æ–­åˆ†ç±»"></a>ä¸­æ–­åˆ†ç±»</h2><p>ä¸­æ–­å¯åˆ†ä¸ºåŒæ­¥ï¼ˆsynchronousï¼‰ä¸­æ–­å’Œå¼‚æ­¥ï¼ˆasynchronousï¼‰ä¸­æ–­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. åŒæ­¥ä¸­æ–­æ˜¯å½“æŒ‡ä»¤æ‰§è¡Œæ—¶ç”±CPUæ§åˆ¶å•å…ƒäº§ç”Ÿï¼Œä¹‹æ‰€ä»¥ç§°ä¸ºåŒæ­¥ï¼Œæ˜¯å› ä¸ºåªæœ‰åœ¨ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•åCPUæ‰ä¼šå‘å‡ºä¸­æ–­ï¼Œè€Œä¸æ˜¯åœ¨ä»£ç æŒ‡ä»¤æ‰§è¡ŒæœŸé—´ï¼Œæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨</span><br><span class="line">2. å¼‚æ­¥ä¸­æ–­æ˜¯æŒ‡ç”±å…¶ä»–ç¡¬ä»¶è®¾å¤‡ä¾ç…§CPUæ—¶é’Ÿä¿¡å·éšæœºäº§ç”Ÿï¼Œå³æ„å‘³ç€ä¸­æ–­èƒ½å¤Ÿåœ¨æŒ‡ä»¤ä¹‹é—´äº§ç”Ÿï¼Œä¾‹å¦‚é”®ç›˜ä¸­æ–­</span><br></pre></td></tr></table></figure>
<p>åŒæ­¥ä¸­æ–­ç§°ä¸ºå¼‚å¸¸ï¼ˆexceptionï¼‰ï¼Œå¼‚å¸¸å¯åˆ†ä¸ºæ•…éšœï¼ˆfaultï¼‰ã€é™·é˜±ï¼ˆtrapï¼‰ã€ç»ˆæ­¢ï¼ˆabortï¼‰ä¸‰ç±»ã€‚<br>å¼‚æ­¥ä¸­æ–­è¢«ç§°ä¸ºä¸­æ–­ï¼ˆinterruptï¼‰,ä¸­æ–­å¯åˆ†ä¸ºå¯å±è”½ä¸­æ–­ï¼ˆMaskable interruptï¼Œå¤–éƒ¨è®¾å¤‡äº§ç”Ÿçš„ï¼‰å’Œéå±è”½ä¸­æ–­ï¼ˆNomaskable interruptï¼Œè®¡ç®—æœºå†…éƒ¨ç¡¬ä»¶äº§ç”Ÿçš„ï¼‰<br>å¼‚å¸¸æ˜¯CPUå‘å‡ºçš„ä¸­æ–­ä¿¡å·ï¼Œä¸ä¸­æ–­æ§åˆ¶å™¨æ— å…³ï¼Œä¸èƒ½è¢«å±è”½ã€‚</p>
<p>å¹¿ä¹‰ä¸Šè®²ä¸­æ–­å¯åˆ†ä¸ºå››ç±»ï¼šä¸­æ–­ã€æ•…éšœã€é™·é˜±ã€ç»ˆæ­¢ã€‚å®ƒä»¬ä¹‹é—´çš„å¼‚åŒç‚¹å‚ç…§ä¸‹è¡¨ã€‚</p>
<table>
<thead>
<tr>
<th align="left">ç±»åˆ«</th>
<th align="left">åŸå› </th>
<th align="left">å¼‚æ­¥/åŒæ­¥</th>
<th align="left">è¿”å›è¡Œä¸º</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ä¸­æ–­</td>
<td align="left">æ¥è‡ªI/Oè®¾å¤‡çš„ä¿¡å·</td>
<td align="left">å¼‚æ­¥</td>
<td align="left">æ€»æ˜¯è¿”å›åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤</td>
</tr>
<tr>
<td align="left">é™·é˜±</td>
<td align="left">æœ‰æ„çš„å¼‚å¸¸</td>
<td align="left">åŒæ­¥</td>
<td align="left">æ€»æ˜¯è¿”å›åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤</td>
</tr>
<tr>
<td align="left">æ•…éšœ</td>
<td align="left">æ½œåœ¨å¯æ¢å¤çš„é”™è¯¯</td>
<td align="left">åŒæ­¥</td>
<td align="left">è¿”å›åˆ°å½“å‰æŒ‡ä»¤</td>
</tr>
<tr>
<td align="left">ç»ˆæ­¢</td>
<td align="left">ä¸å¯æ¢å¤çš„é”™è¯¯</td>
<td align="left">åŒæ­¥</td>
<td align="left">ä¸ä¼šè¿”å›</td>
</tr>
</tbody></table>
<h2 id="ä¸­æ–­æ§åˆ¶å™¨"><a href="#ä¸­æ–­æ§åˆ¶å™¨" class="headerlink" title="ä¸­æ–­æ§åˆ¶å™¨"></a>ä¸­æ–­æ§åˆ¶å™¨</h2><p>å¸¸è§çš„ä¸­æ–­æ§åˆ¶å™¨æœ‰ä¸¤ç§ï¼Œä¸¤ç‰‡8259Aå¤–éƒ¨èŠ¯ç‰‡â€™çº§è”â€™å’Œå¤šçº§I/O APICç³»ç»Ÿï¼Œè§ä¸‹å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/interrupt_ctl.png"><br>è‡³äºç¡¬ä»¶å®ç°ç»†èŠ‚è¿™é‡Œä¸åšè¿‡å¤šæè¿°ã€‚è¾¨åˆ«ä¸€ä¸ªç³»ç»Ÿæ˜¯å¦æ­£åœ¨ä½¿ç”¨I/O APICï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š<br><img src="https://rancho333.github.io/pictures/interrupts.png"><br>å¯ä»¥çœ‹åˆ°ç¬¬6åˆ—ä¸Šæ˜¾ç¤ºçš„æ˜¯IO-APIC,å¦‚æœä¸Šé¢æ˜¾ç¤ºçš„æ˜¯XY-APICï¼Œè¯´æ˜ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨8259AèŠ¯ç‰‡ã€‚<br>å¯¹ä¸Šé¢æ–‡ä»¶çš„è¾“å‡ºï¼Œè§£é‡Šå¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¬¬ä¸€åˆ—è¡¨ç¤ºIRQä¸­æ–­å·</li>
<li>ç¬¬äºŒã€ä¸‰ã€å››ã€äº”åˆ—è¡¨ç¤ºç›¸åº”çš„CPuæ ¸å¿ƒè¢«ä¸­æ–­çš„æ¬¡æ•°</li>
<li>ç¬¬å…­åˆ—è¡¨ç¤ºä½¿ç”¨æ§åˆ¶å™¨</li>
<li>ç¬¬ä¸ƒåˆ—è¡¨ç¤ºç¡¬ä»¶ä¸­æ–­å·å’Œä¸­æ–­è§¦å‘æ–¹å¼ï¼ˆç”µå¹³æˆ–è¾¹æ²¿ï¼‰</li>
<li>ç¬¬å…«åˆ—è¡¨ç¤ºä¸­æ–­åç§°</li>
<li>æœ‰ä¸€äº›IRQå·ä¼šè¡¨ç¤ºä¸ºNMIï¼ŒLOCä¹‹ç±»çš„ï¼Œè¿™æ˜¯ç³»ç»Ÿä¿ç•™çš„ï¼Œç”¨æˆ·æ— æ³•è®¿é—®å’Œé…ç½®</li>
</ol>
<p>æ­¤å¤–ï¼Œ<code>/proc/interrupts</code>æ–‡ä»¶ä¸­åˆ—å‡ºçš„æ˜¯å½“å‰ç³»ç»Ÿä½¿ç”¨çš„ä¸­æ–­æƒ…å†µï¼Œå¦‚æœæŸä¸ªä¸­æ–­å¤„ç†æ²¡æœ‰å®‰è£…ï¼ˆåŒ…æ‹¬å®‰è£…åå¸è½½çš„ï¼‰ï¼Œæ˜¯ä¸ä¼šæ˜¾ç¤ºçš„ã€‚ä½†æ˜¯<code>/proc/stat</code>ä¼šè®°å½•æœºå™¨ä»å¯åŠ¨å¼€å§‹å„ä¸ªä¸­æ–­åºå·å‘ç”Ÿä¸­æ–­çš„æ¬¡æ•°ã€‚</p>
<h2 id="ä¸­æ–­å‘é‡"><a href="#ä¸­æ–­å‘é‡" class="headerlink" title="ä¸­æ–­å‘é‡"></a>ä¸­æ–­å‘é‡</h2><p>x86ä¸­æ”¯æŒ256ç§ä¸­æ–­ï¼Œå°†è¿™äº›ä¸­æ–­æºæŒ‰ç…§0åˆ°255çš„é¡ºåºå¯¹æ²¡ä¸­ä¸­æ–­è¿›è¡Œç¼–å·ï¼Œè¿™ä¸ªæ ‡å·å«åšä¸­æ–­å‘é‡ï¼Œé€šå¸¸ç”¨8ä½æ— ç¬¦å·æ•´æ•°æ¥å­˜å‚¨è¿™ä¸ªå‘é‡ã€‚ä¸­æ–­å·ä¸ä¸­æ–­å‘é‡ä¸€ä¸€æ˜ å°„ã€‚<br>ä¸­æ–­å·å’Œä¸­æ–­å‘é‡æ¦‚å¿µä¸åŒã€‚å½“I/Oè®¾å¤‡æŠŠä¸­æ–­ä¿¡å·å‘é€ä¸ªä¸­æ–­æ§åˆ¶å™¨æ—¶ï¼Œä¸ä¹‹å…³è”çš„æ˜¯ä¸€ä¸ªä¸­æ–­å·ï¼›è€Œå½“ä¸­æ–­æ§åˆ¶å™¨å°†è¯¥ä¸­æ–­ä¿¡å·ä¼ é€’ç»™CPUæ—¶ï¼Œä¸ä¹‹å…³è”çš„æ˜¯ä¸€ä¸ªä¸­æ–­å‘é‡ã€‚ä¸­æ–­å·æ˜¯ä»¥ä¸­æ–­æ§åˆ¶å™¨çš„è§’åº¦è€Œè¨€çš„ï¼›ä¸­æ–­å‘é‡åˆ™æ˜¯ä»¥CPUçš„è§’åº¦è€Œè¨€çš„ã€‚<br>é€šå¸¸ï¼ŒIntelå°†ç¼–å·ä¸º0ï½31çš„å‘é‡åˆ†é…ç»™å¼‚å¸¸å’Œéå±è”½ä¸­æ–­ã€‚</p>
<h2 id="ä¸­æ–­æœåŠ¡ä¾‹ç¨‹"><a href="#ä¸­æ–­æœåŠ¡ä¾‹ç¨‹" class="headerlink" title="ä¸­æ–­æœåŠ¡ä¾‹ç¨‹"></a>ä¸­æ–­æœåŠ¡ä¾‹ç¨‹</h2><p>åœ¨å“åº”ä¸€ä¸ªå…·ä½“çš„ä¸­æ–­æ—¶ï¼Œå†…æ ¸ä¼šæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¢«ç§°ä¸ºä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆinterrupt service routine, ISRï¼‰ã€‚æ¯ä¸€ä¸ªè®¾å¤‡çš„é©±åŠ¨ç¨‹åºä¸­éƒ½ä¼šå®šä¹‰ç›¸å…³çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ã€‚</p>
<p>ç°ä»Šçš„ä¸­æ–­å¤„ç†æµç¨‹éƒ½ä¼šåˆ†ä¸ºä¸¤éƒ¨åˆ†:ä¸ŠåŠéƒ¨åˆ†ï¼ˆtop halfï¼‰å’Œä¸‹åŠéƒ¨åˆ†ï¼ˆbottom halfï¼‰ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä¸­æ–­å¯ä»¥éšæ—¶æ‰“æ–­CPUå¯¹å…¶å®ƒç¨‹åºçš„æ‰§è¡Œï¼Œå¦‚æœè¢«æ‰“æ–­çš„ä»£ç å¯¹ç³»ç»Ÿå¾ˆé‡è¦ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¸­æ–­å¤„ç†ç¨‹åºçš„æ‰§è¡Œæ—¶é—´åº”è¯¥è¶ŠçŸ­è¶Šå¥½</li>
<li>ä¸­æ–­å¤„ç†ç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼Œä¼šå±è”½åŒæ¡ä¸­æ–­çº¿ä¸Šçš„ä¸­æ–­è¯·æ±‚ï¼›å¦‚æœè®¾ç½®äº†IRQF_DISABLEï¼Œé‚£ä¹ˆè¯¥ä¸­æ–­æœåŠ¡ç¨‹åºæ‰§è¡Œæ—¶æ˜¯ä¼šå±è”½å…¶ä»–æ‰€æœ‰å…¶å®ƒçš„ä¸­æ–­è¯·æ±‚ã€‚é‚£ä¹ˆæ­¤æ—¶åº”è¯¥è®©ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œçš„è¶Šå¿«è¶Šå¥½ã€‚</li>
</ol>
<p>è¿™æ ·åˆ’åˆ†æ˜¯æœ‰ä¸€å®šåŸå› çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»æœ‰ä¸€ä¸ªå¿«é€Ÿã€å¼‚æ­¥è€Œä¸”ç®€å•çš„å¤„ç†ç¨‹åºä¸“é—¨æ¥è´Ÿè´£å¯¹ç¡¬ä»¶çš„ä¸­æ–­è¯·æ±‚ä½œå‡ºå¿«é€Ÿå“åº”ï¼Œä¸æ­¤åŒæ—¶ä¹Ÿè¦å®Œæˆé‚£äº›å¯¹æ—¶é—´è¦æ±‚å¾ˆä¸¥æ ¼çš„æ“ä½œã€‚è€Œé‚£äº›å¯¹æ—¶é—´è¦æ±‚ç›¸å¯¹å®½æ¾ï¼Œå…¶å®ƒçš„å‰©ä½™å·¥ä½œåˆ™ä¼šåœ¨ç¨åçš„ä»»æ„æ—¶é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸‹åŠéƒ¨åˆ†æ‰§è¡Œã€‚</p>
<p>ä¸ŠåŠéƒ¨åˆ†åªèƒ½é€šè¿‡ä¸­æ–­å¤„ç†ç¨‹åºå®ç°ï¼Œä¸‹åŠéƒ¨åˆ†å¯ä»¥é€šè¿‡å¤šç§æœºåˆ¶æ¥å®Œæˆï¼šå°ä»»åŠ¡ï¼ˆtaskletï¼‰ï¼Œå·¥ä½œé˜Ÿåˆ—ï¼Œè½¯ä¸­æ–­ï¼Œä¸ç®¡æ˜¯å“ªç§æœºåˆ¶ï¼Œä»–ä»¬å‡ä¸ºä¸‹åŠéƒ¨åˆ†æä¾›äº†ä¸€ç§æ‰§è¡Œæœºåˆ¶ï¼Œæ¯”ä¸ŠåŠéƒ¨åˆ†çµæ´»å¤šäº†ï¼Œè‡³äºä½•æ—¶æ‰§è¡Œï¼Œåˆ™ç”±å†…æ ¸è´Ÿè´£ã€‚</p>
<h1 id="ç¬¬ä¸€ä¸ªä¸­æ–­æµ‹è¯•ç¨‹åº"><a href="#ç¬¬ä¸€ä¸ªä¸­æ–­æµ‹è¯•ç¨‹åº" class="headerlink" title="ç¬¬ä¸€ä¸ªä¸­æ–­æµ‹è¯•ç¨‹åº"></a>ç¬¬ä¸€ä¸ªä¸­æ–­æµ‹è¯•ç¨‹åº</h1><p>äº†è§£äº†ä¸‹ä¸­æ–­çš„åŸºæœ¬æ¦‚å¿µï¼Œä¸‹é¢å°±å†™ä¸€ä¸ªå°demoæ¥å®é™…æµ‹è¯•ä¸€ä¸‹å§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;linux&#x2F;init.h&gt;                 </span><br><span class="line">#include &lt;linux&#x2F;kernel.h&gt;          </span><br><span class="line">#include &lt;linux&#x2F;module.h&gt;               </span><br><span class="line">#include &lt;linux&#x2F;moduleparam.h&gt;          </span><br><span class="line">#include &lt;linux&#x2F;interrupt.h&gt;       </span><br><span class="line">#include &lt;linux&#x2F;stat.h&gt;                 </span><br><span class="line">#include &lt;linux&#x2F;slab.h&gt;                                                                                                                                                                                           </span><br><span class="line">                                   </span><br><span class="line">static int irq &#x3D; 1;                 &#x2F;&#x2F;ä¿å­˜ä¸­æ–­å·irq</span><br><span class="line">static char *devname &#x3D; NULL;        &#x2F;&#x2F;ä¿å­˜ä¸­æ–­åç§°*devname</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åˆ©ç”¨å®module_paramæ¥æ¥å—å‚æ•°</span><br><span class="line">module_param(irq, int, 00644);      &#x2F;&#x2F;S_IRUGO&#x3D;00644</span><br><span class="line">module_param(devname, charp, 00644);</span><br><span class="line">                                   </span><br><span class="line">&#x2F;&#x2F;å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œåœ¨request_irqå‡½æ•°ä¸­çš„void *dev_idç»å¸¸è®¾ç½®ä¸ºç»“æ„ä½“æˆ–NULL</span><br><span class="line">struct dev_info&#123;                   </span><br><span class="line">    int irq_id;                    </span><br><span class="line">    char *dev_name;                </span><br><span class="line">&#125;;                                 </span><br><span class="line">                                   </span><br><span class="line">struct dev_info *mydev_info &#x3D; NULL;</span><br><span class="line">                                   </span><br><span class="line">&#x2F;&#x2F;å£°æ˜ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆä¸ŠåŠéƒ¨åˆ†ï¼‰  </span><br><span class="line">static irqreturn_t myirq_handler(int irq, void *dev);</span><br><span class="line">                                   </span><br><span class="line">static int __init myirq_init(void)</span><br><span class="line">&#123;                                  </span><br><span class="line">    printk(&quot;zhw test:Module is working ...\n&quot;);</span><br><span class="line">    &#x2F;&#x2F;åˆ†é…struct dev_infoç»“æ„ä½“å†…å­˜</span><br><span class="line">    mydev_info &#x3D; kmalloc(sizeof(struct dev_info), GFP_KERNEL);</span><br><span class="line">    if(!mydev_info)                </span><br><span class="line">    &#123;                              </span><br><span class="line">        printk(&quot;kmalloc failed!\n&quot;);</span><br><span class="line">        return -1;                 </span><br><span class="line">    &#125;                              </span><br><span class="line">    memset(mydev_info, 0, sizeof(struct dev_info));</span><br><span class="line">    mydev_info-&gt;irq_id &#x3D; irq;   </span><br><span class="line">    &#x2F;&#x2F;åˆ†é…ç»“æ„ä½“struct dev_info-&gt;char *dev_nameå†…å­˜</span><br><span class="line">    mydev_info-&gt;dev_name &#x3D; kmalloc(10, GFP_KERNEL);</span><br><span class="line">    if(!mydev_info-&gt;dev_name)   </span><br><span class="line">    &#123;                              </span><br><span class="line">        printk(&quot;kmalloc 1 failed!\n&quot;);</span><br><span class="line">        return -1;                 </span><br><span class="line">    &#125;                              </span><br><span class="line">    mydev_info-&gt;dev_name &#x3D; devname;</span><br><span class="line"></span><br><span class="line">    if(request_irq(irq, &amp;myirq_handler, IRQF_SHARED, devname, mydev_info))</span><br><span class="line">    &#123;</span><br><span class="line">        printk(&quot;%s request IRQ:%d failed\n&quot;, devname, irq);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(&quot;%s request IRQ:%d success..\n&quot;, devname ,irq);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static void __exit myirq_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(&quot;unloading my module ..\n&quot;);</span><br><span class="line">    free_irq(irq, mydev_info);</span><br><span class="line">    printk(&quot;freeing IRQ %d\n&quot;, irq);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static irqreturn_t myirq_handler(int irq, void *dev)</span><br><span class="line">&#123;</span><br><span class="line">    struct dev_info mydev;</span><br><span class="line">    static int count &#x3D; 1;</span><br><span class="line">    mydev &#x3D; *(struct dev_info *)dev;</span><br><span class="line"> </span><br><span class="line">    printk(&quot;key:%d\n&quot;, count);</span><br><span class="line">    printk(&quot;devname:%s. devid:%d\n is working..\n&quot;, mydev.dev_name, mydev.irq_id);</span><br><span class="line">    printk(&quot;ISR is leaving\n&quot;);</span><br><span class="line">    count++;</span><br><span class="line">    return IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(myirq_init);</span><br><span class="line">module_exit(myirq_exit);</span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºä¸­æ–­ç¨‹åºä¸€èˆ¬åŒ…å«åœ¨æŸä¸ªè®¾å¤‡çš„é©±åŠ¨ç¨‹åºä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªç¨‹åºæœ¬è´¨å°±æ˜¯ä¸€ä¸ªå†…æ ¸æ¨¡å—ã€‚è¿™é‡Œé¢ä¸»è¦å°±æ˜¯é©±åŠ¨çš„åˆå§‹åŒ–ï¼Œé€€å‡ºï¼Œä»¥åŠä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰ã€‚è¿™é‡Œå…±äº«é”®ç›˜çš„ä¸­æ–­å·ï¼Œx86ä¸‹é”®ç›˜çš„ä¸­æ–­å·æ˜¯1.<br>Makefileå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">obj-m:&#x3D;first_interrupt.o                                                                                                                                                                                          </span><br><span class="line">KDIR:&#x3D;&#x2F;lib&#x2F;modules&#x2F;$(shell uname -r)&#x2F;build</span><br><span class="line">PWD:&#x3D;$(shell pwd)</span><br><span class="line"> </span><br><span class="line">default:</span><br><span class="line">    $(MAKE) -C $(KDIR) M&#x3D;$(PWD) modules</span><br><span class="line"> </span><br><span class="line">clean:</span><br><span class="line">    rm -rf .*.cmd *.o *.mod.c *.ko .tmp_versions</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ol>
<li>cat /proc/interruptsæŸ¥çœ‹ä¸­æ–­å·ï¼Œæ³¨æ„å¦‚æœæ˜¯ä½¿ç”¨sshæˆ–telentåˆ°linuxä¸Šçš„æ˜¯ä¸ä¼šå“åº”é”®ç›˜ä¸­æ–­çš„ï¼Œéœ€è¦ä½¿ç”¨è™šæ‹Ÿæœºæ¥å®éªŒ</li>
<li>åŠ è½½é©±åŠ¨<code>sudo insmod ./first_interrupt.ko irq=1 devname=zhwirq</code></li>
<li>æŸ¥çœ‹é©±åŠ¨<code>lsmod | grep first</code>,æŸ¥çœ‹ä¸­æ–­<code>cat /proc/interrupts | grep zhw</code></li>
<li>dmesgæŸ¥çœ‹å†…æ ¸æ—¥å¿—æ–‡ä»¶ï¼Œdmesg | tail -20<br><img src="https://rancho333.github.io/pictures/dmesg.png"></li>
<li>å¸è½½é©±åŠ¨<code>sudo rmmod first_interrupt</code></li>
</ol>
<p>åŠ è½½é©±åŠ¨åï¼Œå…ˆè¿›è¡Œé©±åŠ¨åˆå§‹åŒ–ï¼Œä¹‹åæ¯å½“æœ‰é”®ç›˜ä¸­æ–­è§¦å‘åï¼Œéƒ½ä¼šè¿›å…¥ISRï¼Œå¸è½½é©±åŠ¨åä¸ä¼šå†è§¦å‘ã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://www.linuxidc.com/Linux/2014-03/98012.htm">Linuxä¸‹çš„ä¸­æ–­ï¼ˆinterruptï¼‰ ç®€ä»‹</a><br><a href="http://edsionte.com/techblog/archives/1495">ä¸­æ–­å…¥é—¨</a><br><a href="https://blog.csdn.net/wordwarwordwar/article/details/81182910">PCI&amp;PCIE MSIä¸­æ–­</a><br><a href="http://control.blog.chinaunix.net/uid-22666248-id-3052413.html">ç¬¬ä¸€ä¸ªä¸­æ–­é©±åŠ¨ç¨‹åº</a><br><a href="https://blog.csdn.net/yzytr/article/details/77659302">å¦‚ä½•ç¼–è¯‘å†…æ ¸ko</a></p>
]]></content>
      <tags>
        <tag>ä¸­æ–­</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ixiaå¯¹sonicè¿›è¡ŒL2,3æ‰“æµæµ‹è¯•</title>
    <url>/2022/09/02/%E4%BD%BF%E7%94%A8ixia%E5%AF%B9sonic%E8%BF%9B%E8%A1%8CL2-3%E6%89%93%E6%B5%81%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<h1 id="ç¯å¢ƒè¯´æ˜"><a href="#ç¯å¢ƒè¯´æ˜" class="headerlink" title="ç¯å¢ƒè¯´æ˜"></a>ç¯å¢ƒè¯´æ˜</h1><p>å®éªŒæ‹“æ‰‘å¦‚å›¾ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/ixia_sonic_topology.png"></p>
<span id="more"></span>

<p>çº¿è¿æ¥å¥½åï¼Œixiaä¸Šåšäº›é…ç½®ä½¿ç«¯å£upã€‚sonicä¸Šlink trainingå’Œauto negotiationé»˜è®¤å…³é—­ï¼ŒFECå¼€å¯ã€‚åœ¨ixiaä¸Šå¯¹åº”æ¥å£åšè®¾ç½®ä¸ä¹‹åŒ¹é…ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/ixia_port_up.png"></p>
<p>ç¡®è®¤ç«¯å£up:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@localhost:&#x2F;home&#x2F;admin# show interfaces status Ethernet49</span><br><span class="line">  Interface        Lanes    Speed    MTU    FEC    Alias    Vlan    Oper    Admin             Type    Asym PFC</span><br><span class="line">-----------  -----------  -------  -----  -----  -------  ------  ------  -------  ---------------  ----------</span><br><span class="line"> Ethernet49  41,42,43,44     100G   9216     rs    etp49  routed      up       up  QSFP28 or later         N&#x2F;A</span><br><span class="line">root@localhost:&#x2F;home&#x2F;admin# show interfaces status Ethernet50</span><br><span class="line">  Interface        Lanes    Speed    MTU    FEC    Alias    Vlan    Oper    Admin             Type    Asym PFC</span><br><span class="line">-----------  -----------  -------  -----  -----  -------  ------  ------  -------  ---------------  ----------</span><br><span class="line"> Ethernet50  45,46,47,48     100G   9216     rs    etp50  routed      up       up  QSFP28 or later         N&#x2F;A&#x3D;</span><br></pre></td></tr></table></figure>

<h1 id="äºŒå±‚æ‰“æµ"><a href="#äºŒå±‚æ‰“æµ" class="headerlink" title="äºŒå±‚æ‰“æµ"></a>äºŒå±‚æ‰“æµ</h1><p>ixia eth7ç«¯å£å‘å‡ºäºŒå±‚æŠ¥æ–‡ï¼Œsonicä¸¤ä¸ªç«¯å£åœ¨åŒä¸€vlanï¼Œixia eth8ç«¯å£æ¥æ”¶æŠ¥æ–‡è¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼Œæ£€æŸ¥æ˜¯å¦ä¸¢åŒ…ã€‚åŒç†eth8å‘åŒ…ï¼Œeth7æ”¶åŒ…ã€‚è¿™æ ·å°±å®ç°åŒå‘äºŒå±‚çº¿é€Ÿæ‰“æµæµ‹è¯•ã€‚è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>sonicé…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config vlan add 78</span><br><span class="line">config vlan member add -u 78 Ethernet49</span><br><span class="line">config vlan member add -u 78 Ethernet50</span><br><span class="line"></span><br><span class="line">ç¡®è®¤vlané…ç½®ï¼š</span><br><span class="line">root@localhost:&#x2F;home&#x2F;admin# show vlan brief </span><br><span class="line">+-----------+--------------+------------+----------------+-------------+-----------------------+</span><br><span class="line">|   VLAN ID | IP Address   | Ports      | Port Tagging   | Proxy ARP   | DHCP Helper Address   |</span><br><span class="line">+&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;+</span><br><span class="line">|        78 |              | Ethernet49 | untagged       | disabled    |                       |</span><br><span class="line">|           |              | Ethernet50 | untagged       |             |                       |</span><br></pre></td></tr></table></figure>

<p>ixiaè¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š<br>å¦‚å›¾åˆ†åˆ«å°†eth7, eth8åˆ›å»ºæˆL2æ¥å£ï¼š<br><img src="https://rancho333.github.io/pictures/ixia_l2_port.png"></p>
<p>ä¹‹ååˆ›å»ºäºŒå±‚æµï¼š<br><img src="https://rancho333.github.io/pictures/ixia_l2_traffic.png"></p>
<p>å›¾ç¤ºæ˜¯eth7å‘é€ï¼Œeth8æ¥æ”¶æ£€æŸ¥ï¼ŒåŒç†åˆ›å»ºåå‘æµï¼Œå®ç°åŒå‘æ‰“æµæµ‹è¯•ã€‚æ³¨æ„æœ€å¥½ä¿®æ”¹äºŒå±‚æŠ¥æ–‡çš„æºç›®macåœ°å€ã€‚</p>
<p>æœ€åæ‰“æµæµ‹è¯•ï¼š<br><img src="https://rancho333.github.io/pictures/ixia_l2_traffic_loss.png"></p>
<h1 id="ä¸‰å±‚æ‰“æµ"><a href="#ä¸‰å±‚æ‰“æµ" class="headerlink" title="ä¸‰å±‚æ‰“æµ"></a>ä¸‰å±‚æ‰“æµ</h1><p>ixia eth7,8è®¾ç½®ä¸ºä¸‰å±‚æ¥å£ï¼Œç½‘å…³æŒ‡å‘sonicï¼Œåˆ›å»ºä¸¤æ¡æµåˆ†åˆ«ï¼šsrcä¸ºeth7ï¼Œdstä¸ºeth8ï¼› srcä¸ºeth8,dstä¸ºeth7.è¿™æ ·å°±å®ç°åŒå‘ä¸‰å±‚çº¿é€Ÿæ‰“æµæµ‹è¯•ã€‚è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>sonicé…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config interface ip add Ethernet49 10.1.1.2&#x2F;24 </span><br><span class="line">config interface ip add Ethernet50 10.1.2.2&#x2F;24</span><br><span class="line"></span><br><span class="line">ç¡®è®¤é…ç½®ï¼š</span><br><span class="line">root@localhost:&#x2F;home&#x2F;admin# show ip interfaces </span><br><span class="line">Interface    Master    IPv4 address&#x2F;mask    Admin&#x2F;Oper    BGP Neighbor    Neighbor IP</span><br><span class="line">-----------  --------  -------------------  ------------  --------------  -------------</span><br><span class="line">Ethernet49             10.1.1.2&#x2F;24          up&#x2F;up         N&#x2F;A             N&#x2F;A</span><br><span class="line">Ethernet50             10.1.2.2&#x2F;24          up&#x2F;up         N&#x2F;A             N&#x2F;A</span><br></pre></td></tr></table></figure>

<p>ixiaè¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š<br>å¦‚å›¾æ‰€ç¤ºåˆ†åˆ«å°†eth7,eth8åˆ›å»ºæˆL3æ¥å£ï¼š<br><img src="https://rancho333.github.io/pictures/ixia_l3_port.png"></p>
<p>ç„¶åä¾æ¬¡ä¸ºä¸¤ä¸ªæ¥å£é…ç½®ipåœ°å€å’Œgateway:<br><img src="https://rancho333.github.io/pictures/ixia_l3_port_ip.png"></p>
<p>å°†æ‹“æ‰‘ä½¿èƒ½ä¹‹åï¼Œæµ‹è¯•ç½‘ç»œçš„è¿é€šæ€§ï¼š<br><img src="https://rancho333.github.io/pictures/ixia_l3_port_ping.png"></p>
<p>ä¹‹ååˆ›å»ºL3æµï¼Œå›¾ä¸Šæ‰€ç¤ºæ˜¯eth7åˆ°eth8çš„æµï¼ŒåŒç†åˆ›å»ºeth8åˆ°eth7çš„æµï¼š<br><img src="https://rancho333.github.io/pictures/ixia_l3_traffic.png"></p>
<p>æ³¨æ„å’ŒL2çš„æ•°æ®æµä¸åŒï¼ŒL3ä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹æŠ¥æ–‡çš„src macï¼Œdst macç­‰å­—æ®µï¼Œä¼šè‡ªåŠ¨é…ç½®ã€‚</p>
<p>æœ€åæ‰“æµæµ‹è¯•ï¼ŒæŸ¥çœ‹ä¸¢åŒ…æƒ…å†µï¼š<br><img src="https://rancho333.github.io/pictures/ixia_l3_traffic_loss.png"></p>
]]></content>
  </entry>
  <entry>
    <title>å…³äºUbuntuçš„è½¯ä»¶æºsource.listå­¦ä¹ </title>
    <url>/2019/07/25/%E5%85%B3%E4%BA%8EUbuntu%E7%9A%84%E8%BD%AF%E4%BB%B6%E6%BA%90source-list%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯è¯´æ˜"><a href="#èƒŒæ™¯è¯´æ˜" class="headerlink" title="èƒŒæ™¯è¯´æ˜"></a>èƒŒæ™¯è¯´æ˜</h2><p>æœ€è¿‘å‚ä¸åˆ°å…¬å¸çš„ç™½ç›’äº¤æ¢æœºé¡¹ç›®ä¸­ï¼Œéœ€è¦ç¼–è¯‘ONLå’Œsonicï¼Œå…¶ä¸­è½¯ä»¶æºçš„è®¾ç½®è®©æˆ‘éå¸¸å¤´ç–¼ï¼Œç¼–è¯‘ä¾èµ–æœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚å†³å®šæ·±å…¥å­¦ä¹ ä¸€ä¸‹Linuxè½¯ä»¶æº.ä¸»æœºç¯å¢ƒä¸ºubuntu16.04.  </p>
<span id="more"></span>

<h2 id="è½¯ä»¶åº“å­˜å‚¨æ–‡ä»¶-list"><a href="#è½¯ä»¶åº“å­˜å‚¨æ–‡ä»¶-list" class="headerlink" title="è½¯ä»¶åº“å­˜å‚¨æ–‡ä»¶*.list"></a>è½¯ä»¶åº“å­˜å‚¨æ–‡ä»¶*.list</h2><p>ubuntuä½¿ç”¨aptæ¥ç®¡ç†è½¯ä»¶åŒ…ï¼Œaptå°†è½¯ä»¶åº“å­˜å‚¨åœ¨å¦‚ä¸‹æ–‡ä»¶ä¸­:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;etc&#x2F;apt&#x2F;sources.list</span><br><span class="line">&#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;ç›®å½•ä¸­å¸¦.liståç¼€çš„æ–‡ä»¶</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡man sources.lisæ¥æŸ¥çœ‹aptçš„å®Œæ•´å­˜å‚¨æœºåˆ¶ã€‚  </p>
<h2 id="sources-listæ ¼å¼å’Œå†™æ³•"><a href="#sources-listæ ¼å¼å’Œå†™æ³•" class="headerlink" title="sources.listæ ¼å¼å’Œå†™æ³•"></a>sources.listæ ¼å¼å’Œå†™æ³•</h2><ol>
<li>ä»¥<code>#</code>å¼€å¤´çš„è¡Œæ˜¯æ³¨é‡Šè¡Œ  </li>
<li>ä»¥debæˆ–deb-srcå¼€å¤´çš„æ˜¯<code>apt respository</code>ï¼Œå…·ä½“æ ¼å¼ä¸ºï¼š  </li>
<li>debï¼šäºŒè¿›åˆ¶åŒ…ä»“åº“  </li>
<li>deb-srcï¼šäºŒè¿›åˆ¶åŒ…çš„æºç åº“,ä¸è‡ªå·±çœ‹ç¨‹åºæˆ–è€…ç¼–è¯‘ï¼Œdeb-srcå¯ä»¥ä¸è¦ã€‚  </li>
<li>URI: åº“æ‰€åœ¨çš„åœ°å€ï¼Œå¯ä»¥æ˜¯ç½‘ç»œåœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°çš„é•œåƒåœ°å€  </li>
<li>codenameï¼šubuntuç‰ˆæœ¬çš„ä»£å·ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤<code>lsb_release -a</code>æ¥æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„ä»£å·  </li>
<li>componentsï¼šè½¯ä»¶çš„æ€§è´¨(freeæˆ–non-freeç­‰)  </li>
</ol>
<h3 id="ubuntuç³»ç»Ÿä»£å·"><a href="#ubuntuç³»ç»Ÿä»£å·" class="headerlink" title="ubuntuç³»ç»Ÿä»£å·"></a>ubuntuç³»ç»Ÿä»£å·</h3><p>codenameæ˜¯ubuntuä¸åŒç‰ˆæœ¬çš„ä»£å·</p>
<table>
<thead>
<tr>
<th align="center">ç‰ˆæœ¬å·</th>
<th align="center">ä»£å·(codename)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.04</td>
<td align="center">lucid</td>
</tr>
<tr>
<td align="center">12.04</td>
<td align="center">precise</td>
</tr>
<tr>
<td align="center">14.04</td>
<td align="center">trusty</td>
</tr>
<tr>
<td align="center">14.10</td>
<td align="center">utopic</td>
</tr>
<tr>
<td align="center">16.04</td>
<td align="center">xenial</td>
</tr>
<tr>
<td align="center">18.04</td>
<td align="center">bionic</td>
</tr>
</tbody></table>
<h3 id="debè¯´æ˜"><a href="#debè¯´æ˜" class="headerlink" title="debè¯´æ˜"></a>debè¯´æ˜</h3><p>debåé¢çš„å†…å®¹æœ‰ä¸‰å¤§éƒ¨åˆ†ï¼šdeb URI section1 section2<br>ä»¥<code>deb http://us.archive.ubuntu.com/ubuntu/ xenial main restricted</code>ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚<br>URIæ˜¯åº“æ‰€åœ¨çš„åœ°å€ï¼Œæ”¯æŒhttpï¼Œfptä»¥åŠæœ¬åœ°è·¯å¾„,è®¿é—®<code>http://us.archive.ubuntu.com/ubuntu/</code>å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š<br><img src="https://rancho333.github.io/pictures/ubuntu.png"><br><code>dists</code>å’Œ<code>pool</code>è¿™ä¸¤ä¸ªç›®å½•æ¯”è¾ƒé‡è¦ã€‚<code>dists</code>ç›®å½•åŒ…å«äº†å½“å‰åº“çš„æ‰€æœ‰è½¯ä»¶åŒ…çš„ç´¢å¼•ã€‚è¿™äº›ç´¢å¼•é€šè¿‡codenameåˆ†å¸ƒåœ¨ä¸åŒçš„æ–‡ä»¶å¤¹ä¸­ã€‚ä¾‹å¦‚<code>xenial</code>æ‰€åœ¨çš„ç›®å½•ã€‚<br><img src="https://rancho333.github.io/pictures/xenial.png"><br>ä¸Šå›¾ä¸­çš„æ–‡ä»¶å¤¹åå…¶å®å°±æ˜¯å¯¹åº”äº†section1ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦å¡«å†™ä¸åŒçš„section1.<br>è¿™é‡Œé¢çš„æ–‡ä»¶éƒ½æ˜¯ç”¨ä»¥ä¸‹æ ¼å¼å‘½åçš„ï¼š  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">codename</span><br><span class="line">codename-backports    #unsupported updates</span><br><span class="line">codename-proposed	  #pre-released updates</span><br><span class="line">codename-security	  #important security updates</span><br><span class="line">codename-updates	  #recommanded updates</span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€å…¶ä¸­ä¸€ä¸ªä»»ä¸€æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚<code>xenial-updates</code>:<br><img src="https://rancho333.github.io/pictures/xenial.png"><br>é‡Œé¢æœ‰<code>main,multiverse,restricted,universe</code>æ–‡ä»¶å¤¹ï¼Œè¿™äº›æ–‡ä»¶å¤¹å¯¹åº”debåé¢çš„section2,é‡Œé¢åŒ…å«äº†ä¸åŒè½¯ä»¶åŒ…çš„ç´¢å¼•ã€‚å®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼š  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mainï¼šå®Œå…¨çš„è‡ªç”±è½¯ä»¶</span><br><span class="line">restricted: ä¸å®Œå…¨çš„è‡ªç”±è½¯ä»¶</span><br><span class="line">universe: ubuntuå®˜æ–¹ä¸æä¾›æ”¯æŒä¸è¡¥ä¸ï¼Œå…¨é ç¤¾åŒºæ”¯æŒ</span><br><span class="line">multiverse: éè‡ªç”±è½¯ä»¶ï¼Œå®Œå…¨ä¸æä¾›æ”¯æŒå’Œè¡¥ä¸</span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€mainç›®å½•ä¸‹çš„binary-i386å­ç›®å½•ä¸‹çš„Packages.gzæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š<br><img src="https://rancho333.github.io/pictures/packages.png"><br>è¯´æ˜ï¼šPackages.gzè¿™ä¸ªæ–‡ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªâ€œç´¢å¼•â€æ–‡ä»¶,é‡Œé¢è®°å½•äº†å„ç§åŒ…çš„åŒ…å(Package)ã€è¿è¡Œå¹³å°(Architecture)ã€ç‰ˆæœ¬å·ï¼ˆVersionï¼‰ã€ä¾èµ–å…³ç³»(Depends)ã€debåŒ…åœ°å€(Filename)ç­‰ã€‚FilenameæŒ‡å‘çš„æ˜¯æºæœåŠ¡å™¨poolç›®å½•ä¸‹çš„æŸä¸ªdebã€‚çŒœæµ‹ï¼š<code>apt-get install</code>æŸä¸ªè½¯ä»¶æ˜¯ï¼Œå…¶å®å°±æ˜¯åŸºäºè¿™äº›Packages.gzæ¥è®¡ç®—ä¾èµ–å…³ç³»ï¼Œç„¶åæ ¹æ®å…¶ä¸­çš„filenameåœ°å€æ¥ä¸‹è½½æ‰€éœ€çš„debï¼Œæœ€åæ‰§è¡Œ<code>dpkg -i pacckage.deb</code>æ¥å®Œæˆè½¯ä»¶åŒ…çš„å®‰è£…ã€‚  </p>
<h2 id="æ›¿æ¢æº"><a href="#æ›¿æ¢æº" class="headerlink" title="æ›¿æ¢æº"></a>æ›¿æ¢æº</h2><p>å…ˆå°†é»˜è®¤çš„sources.listè¿›è¡Œå¤‡ä»½ï¼Œç„¶åä»¿ç…§ä¸‹è¡¨ä¿®æ”¹æºï¼š  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"># é¢„å‘å¸ƒè½¯ä»¶æºï¼Œä¸å»ºè®®å¯ç”¨</span><br><span class="line"># deb https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic-proposed main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; bionic-proposed main restricted universe multiverse</span><br></pre></td></tr></table></figure>

<h2 id="å›½å†…é•œåƒç½‘ç«™"><a href="#å›½å†…é•œåƒç½‘ç«™" class="headerlink" title="å›½å†…é•œåƒç½‘ç«™"></a>å›½å†…é•œåƒç½‘ç«™</h2><p>è¿™é‡Œæ¨èä¸¤ä¸ªå›½å†…é•œåƒç½‘ç«™ï¼Œä¸€ä¸ªæ˜¯<a href="http://mirrors.tuna.tsinghua.edu.cn/">æ¸…åæº</a>ï¼Œä¸€ä¸ªæ˜¯<a href="https://mirrors.aliyun.com/">é˜¿é‡Œæº</a><br>æ‰¾åˆ°å¯¹åº”çš„æºåï¼Œæ¸…åæºå¯ä»¥ç‚¹å‡»æºåç§°åçš„é—®å·è·å–æºè·¯å¾„ï¼Œé˜¿é‡Œæºå¯ä»¥ç‚¹å‡»æºåç§°æ‰€åœ¨è¡Œçš„å¸®åŠ©è·å–æºè·¯å¾„ã€‚<br>æ³¨æ„äº‹é¡¹ï¼š<br>    æ¸…åæºä¸­æºè·¯å¾„é»˜è®¤ä½¿ç”¨https,éœ€è¦å®‰è£…apt-transport-httpsè½¯ä»¶åŒ…ï¼Œå¦åˆ™ä¿®æ”¹ä¸ºhttpè¿›è¡Œä½¿ç”¨</p>
<h2 id="unmet-dependencies"><a href="#unmet-dependencies" class="headerlink" title="unmet dependencies"></a>unmet dependencies</h2><p>åœ¨æ‰§è¡Œå‘½ä»¤<code>apt-get -y build-dep linux</code>æ—¶å‡ºç°<code>unmet dependencies</code>é”™è¯¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p>è§£å†³æ–¹æ³•ï¼š<br>    åœ¨é•œåƒæœåŠ¡å™¨ä¸Šå¯ä»¥æŸ¥è¯¢åˆ°2.99ç‰ˆæœ¬å­˜åœ¨ï¼Œå°†<code>apt-get</code>å‘½ä»¤æ¢æˆ<code>aptitude</code>å‘½ä»¤ï¼Œä½¿ç”¨<code>apt-get install -y apt-utils aptitude</code>å®‰è£…<code>aptitude</code></p>
<h2 id="Hash-Sum-Mismatch"><a href="#Hash-Sum-Mismatch" class="headerlink" title="Hash Sum Mismatch"></a>Hash Sum Mismatch</h2><p>åœ¨ä½¿ç”¨é˜¿é‡Œæºç¼–è¯‘sonicæºç çš„æ—¶å€™(debian:stretch)ï¼Œå‡ºç°<code>Hash Sum Mismatch</code>çš„æŠ¥é”™ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>


<p>æœ‰äº›ç½‘ç»œæœåŠ¡å•†ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›å°åŒºç½‘ç»œçš„æœåŠ¡å•†ï¼Œä¸ºäº†å‡å°‘æµé‡è´¹ç”¨å’Œæé«˜å¯¹å¸¸è§ç½‘ç»œèµ„æºçš„è®¿é—®é€Ÿåº¦ï¼Œå¾ˆå¤šéƒ½æäº†è¿™ä¹ˆä¸ªä¸œè¥¿å‡ºæ¥<br>ä½†æ˜¯ä»–ä»¬çš„ç¼“å­˜ç­–ç•¥æœ‰é—®é¢˜ï¼Œåªæ¯”å¯¹æ–‡ä»¶è·¯å¾„ï¼Œä¸è€ƒè™‘åŸŸå/IPåœ°å€ï¼Œä¹Ÿæ²¡æ€ä¹ˆè€ƒè™‘è¿‡æ–‡ä»¶å†…å®¹æ›´æ–°åçš„åŒæ­¥ï¼Œå³ç¼“å­˜æœåŠ¡å™¨ä¸Šçš„å†…å®¹å’Œå®é™…æ–‡ä»¶çš„å†…å®¹å¯èƒ½ä¸ä¸€è‡´ã€‚<br>å³å¯¹äº<a href="http://example.com/a/b/c.dat%E8%BF%99%E4%B9%88%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%A2%AB%E6%94%B6%E5%85%A5%E7%BC%93%E5%AD%98%EF%BC%8C%E9%82%A3%E4%B9%88%E4%BD%A0%E8%AE%BF%E9%97%AE%E5%85%B6%E4%BB%96%E4%BB%BB%E6%84%8F%E5%9F%9F%E5%90%8D%E4%B8%8B%E7%9A%84/a/b/c.dat%E6%96%87%E4%BB%B6%E9%83%BD%E4%BC%9A%E5%8E%BB%E8%AF%BB%E5%8F%96%E8%A2%AB%E7%BC%93%E5%AD%98%E7%9A%84%E6%96%87%E4%BB%B6%E3%80%82%E5%A6%82%E6%9E%9Chttp://example.com/a/b/c.dat%E6%9C%89%E4%BA%86%E6%94%B9%E5%8F%98%EF%BC%8C%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E5%AF%B9%E5%BA%94%E6%96%87%E4%BB%B6%E4%B8%8D%E4%B8%80%E5%AE%9A%E8%83%BD%E8%B7%9F%E7%9D%80%E6%9B%B4%E6%96%B0%E3%80%82">http://example.com/a/b/c.datè¿™ä¹ˆä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœè¢«æ”¶å…¥ç¼“å­˜ï¼Œé‚£ä¹ˆä½ è®¿é—®å…¶ä»–ä»»æ„åŸŸåä¸‹çš„/a/b/c.datæ–‡ä»¶éƒ½ä¼šå»è¯»å–è¢«ç¼“å­˜çš„æ–‡ä»¶ã€‚å¦‚æœhttp://example.com/a/b/c.datæœ‰äº†æ”¹å˜ï¼Œç¼“å­˜æœåŠ¡å™¨ä¸Šçš„å¯¹åº”æ–‡ä»¶ä¸ä¸€å®šèƒ½è·Ÿç€æ›´æ–°ã€‚</a><br>è€Œubuntuå¤§éƒ¨åˆ†æºçš„æ–‡ä»¶è·¯å¾„æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¦‚æœ163æºä¸­çš„ <a href="http://mirrors.163.com/ubuntu/dists/tru">http://mirrors.163.com/ubuntu/dists/tru</a> â€¦ ources.bz2 è¢«æ”¶å…¥ç¼“å­˜ï¼Œé‚£ä¹ˆä½ è®¿é—®å®˜æ–¹æº <a href="http://archive.ubuntu.com/ubuntu/dists/">http://archive.ubuntu.com/ubuntu/dists/</a> â€¦ ources.bz2 æ—¶ï¼Œç”±äºè·¯å¾„éƒ½æ˜¯/ubuntu/dists/trusty/main/source/Sources.bz2ï¼Œè¿˜æ˜¯è·å–çš„æ˜¯ç¼“å­˜æœåŠ¡å™¨ä¸Šçš„ç¼“å­˜æ–‡ä»¶ã€‚è¿™ä¸ªå¯ç”¨wgetéªŒè¯ã€‚å¦‚æœç¼“å­˜æœåŠ¡å™¨ä¸Šæ–‡ä»¶è¿‡æ—¶äº†ï¼Œå°±ä¼šå‡ºç°Hash Sum Mismatchã€‚<br>è§£å†³æ–¹æ³•ï¼š<br>    1.æ›´æ¢æºï¼Œæ¢æˆæ¸…åæºå°±æ²¡é—®é¢˜äº†<br>    2.ä½¿ç”¨httpsåè®®</p>
<h2 id="å…³äºpypiå›½å†…æº"><a href="#å…³äºpypiå›½å†…æº" class="headerlink" title="å…³äºpypiå›½å†…æº"></a>å…³äºpypiå›½å†…æº</h2><p>å“ˆï¼Œé¡ºä¾¿åœ¨è¿™é‡Œæä¸€ä¸‹pipçš„å›½å†…æºå•¦ï¼Œå°±ä¸å•ç‹¬å†™ç¯‡æ–‡ç« äº†ã€‚<br>pythonä½¿ç”¨pipä½œä¸ºåŒ…ç®¡ç†å·¥å…·ï¼Œç±»ä¼¼äºdebian/ubuntuçš„apt-get/aptitudeå’Œredhatçš„yumã€‚å›½å†…é•œåƒç½‘ç«™å¯ä»¥åœ¨ä¸Šé¢æ‰¾åˆ°ã€‚æ›¿æ¢æ–¹æ³•å¦‚ä¸‹ï¼š<br>ä¸´æ—¶ä½¿ç”¨ï¼š<br>    <code>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple some-package</code><br>è®¾ä¸ºé»˜è®¤ï¼š<br>å‡çº§ pip åˆ°æœ€æ–°çš„ç‰ˆæœ¬ (&gt;=10.0.0) åè¿›è¡Œé…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install pip -U</span><br><span class="line">pip config set global.index-url https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;simple</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ‚¨åˆ° pip é»˜è®¤æºçš„ç½‘ç»œè¿æ¥è¾ƒå·®ï¼Œä¸´æ—¶ä½¿ç”¨æœ¬é•œåƒç«™æ¥å‡çº§ pipï¼š<br><code>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pip -U</code></p>
<p>å¦‚æœä¸å‡çº§pip,é‚£ä¹ˆå¯ä»¥ä¿®æ”¹pipçš„é…ç½®æ–‡ä»¶ï¼š<br>ä¿®æ”¹ ~/.pip/pip.conf (æ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹åŠæ–‡ä»¶)<br>å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url &#x3D; https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;simple</span><br><span class="line">[install]</span><br><span class="line">trusted-host &#x3D; https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn</span><br></pre></td></tr></table></figure>

<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong><br><a href="https://forum.ubuntu.org.cn/viewtopic.php?t=465499">ubuntuè®ºå›</a></p>
]]></content>
      <categories>
        <category>Linuxç›¸å…³</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è½¯ä»¶æº</tag>
      </tags>
  </entry>
  <entry>
    <title>å…³äºåŠ¨æ€åº“ä»¥åŠconstructorå±æ€§çš„ä½¿ç”¨</title>
    <url>/2020/02/26/%E5%85%B3%E4%BA%8E%E5%8A%A8%E6%80%81%E5%BA%93%E4%BB%A5%E5%8F%8Aconstructor%E5%B1%9E%E6%80%A7%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨åšlinuxç³»ç»Ÿç§»æ¤çš„è¿‡ç¨‹ä¸­é€æ­¥åŠ æ·±äº†å¯¹åŠ¨æ€ç¼–è¯‘å’Œé™æ€ç¼–è¯‘çš„ç†è§£ï¼Œä»Šå¤©è¿™é‡Œè®°å½•ä¸€ä¸‹å¦‚ä½•å°†è‡ªå·±çš„ä»£ç ç¼–è¯‘æˆåŠ¨æ€åº“ä¾›å…¶ä»–ç¨‹åºä½¿ç”¨ã€‚é¡ºé“è®°å½•ä¸€ä¸‹é‡åˆ°çš„ä¸€ä¸ªå¥½ç©çš„ä¸œè¥¿ï¼šCè¯­è¨€ä¸­çš„constructorå±æ€§ï¼Œæ˜¯<code>__attribute__</code>çš„attr_listä¸­çš„ä¸€å‘˜ã€‚</p>
<span id="more"></span>

<h2 id="å°†è‡ªå·±çš„æ¨¡å—ç¼–è¯‘ç”Ÿæˆso"><a href="#å°†è‡ªå·±çš„æ¨¡å—ç¼–è¯‘ç”Ÿæˆso" class="headerlink" title="å°†è‡ªå·±çš„æ¨¡å—ç¼–è¯‘ç”Ÿæˆso"></a>å°†è‡ªå·±çš„æ¨¡å—ç¼–è¯‘ç”Ÿæˆso</h2><p>ç¤ºä¾‹æ¨¡å—åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œcons.cå’Œcons.h,cons.cçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &quot;cons.h&quot;</span><br><span class="line"></span><br><span class="line">void before_main()</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;%s\n&quot;, __FUNCTION__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void after_main()</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;after main!\n&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cons.hçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">void before_main() __attribute__((constructor)); </span><br><span class="line">void after_main();</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å‘½ä»¤<code>gcc cons.c -fPIC -shared -o  libcons.so</code>ç¼–è¯‘ç”ŸæˆåŠ¨æ€åº“æ–‡ä»¶ã€‚</p>
<h2 id="ä½¿ç”¨åŠ¨æ€è¿›è¡Œç¼–è¯‘"><a href="#ä½¿ç”¨åŠ¨æ€è¿›è¡Œç¼–è¯‘" class="headerlink" title="ä½¿ç”¨åŠ¨æ€è¿›è¡Œç¼–è¯‘"></a>ä½¿ç”¨åŠ¨æ€è¿›è¡Œç¼–è¯‘</h2><p>åŠ¨æ€åº“ä¸€èˆ¬æ˜¯å°è£…äº†ä¸€äº›å¸¸ç”¨çš„æ¨¡å—æˆ–åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨éœ€è¦è°ƒç”¨åŠ¨æ€åº“çš„ä»£ç ä¸­å…ˆåŠ å…¥éœ€è¦è°ƒç”¨å‡½æ•°æ‰€åœ¨çš„å¤´æ–‡ä»¶ï¼ˆè¿™äº›å¤´æ–‡ä»¶æ˜¯ä¸åŠ¨æ€åº“ä¸€èµ·å‘å¸ƒçš„ï¼‰ï¼Œç„¶ååœ¨ç¼–è¯‘çš„æ—¶å€™é“¾æ¥è¯¥åº“å°±å¯ä»¥äº†ã€‚è°ƒç”¨åº“çš„ç¤ºä¾‹ä»£ç demo.c:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &quot;cons.h&quot;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;%s\n&quot;, __FUNCTION__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å‘½ä»¤<code>gcc demo.c -o demo -L./ -lcons</code>è¿›è¡Œç¼–è¯‘ï¼Œå…¶ä¸­<code>-L</code>æŒ‡æ˜äº†æŸ¥æ‰¾åŠ¨æ€åº“çš„è·¯å¾„ï¼Œ<code>-lcons</code>æŒ‡æ˜åŠ¨æ€åº“çš„åå­—ï¼Œå®ƒçš„ç»„æˆæ˜¯<code>-l</code>åŠ ä¸ŠåŠ¨æ€åº“çœŸå®åå­—çš„<code>lib</code>ä¸<code>.so</code>ä¹‹é—´çš„å­—ç¬¦ä¸²ï¼Œå¦‚<code>libcons.so</code>å°±æ˜¯<code>-l+cons</code>ã€‚<br>ä½¿ç”¨<code>ldd demo</code>æŸ¥çœ‹ç¨‹åºæ‰€ä¾èµ–åŠ¨æ€åº“çš„å…·ä½“æƒ…å†µï¼ˆæ˜¯å¦å­˜åœ¨ï¼ŒæŸ¥æ‰¾è·¯å¾„ç­‰ï¼‰ï¼š<br><img src="https://rancho333.github.io/pictures/ldd.png"></p>
<p>å‘ç°demoä¸libcons.soä¹‹é—´å¹¶æœªäº§ç”Ÿä¾èµ–å…³ç³»ï¼Œè¿™é‡ŒçŒœæµ‹æ˜¯demo.cä¸­å¹¶æ²¡æœ‰æ˜¾ç¤ºçš„ä½¿ç”¨åˆ°libcons.soä¸­çš„èµ„æºï¼Œæ‰€ä»¥å³ä½¿åŠ ä¸Š<code>-lcons</code>ç¼–è¯‘é€‰é¡¹ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå¯¹ä¹‹è¿›è¡Œä¼˜åŒ–ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹demo.cä¸­çš„ä»£ç ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &quot;cons.h&quot;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;%s\n&quot;, __FUNCTION__);</span><br><span class="line">        after_main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒåŠ ä¸Šå¯¹å‡½æ•°<code>after_main</code>çš„è°ƒç”¨ï¼Œå†ä½¿ç”¨lddæŸ¥çœ‹ï¼š<br><img src="https://rancho333.github.io/pictures/ldd_2.png"></p>
<p>å‘ç°lddä¸­è™½ç„¶å·²ç»æœ‰äº†libcons.soçš„ä¿¡æ¯ï¼Œä½†æ˜¯æ˜¯<code>not found</code>ï¼Œæ‰§è¡Œ<code>demo</code>å½“ç„¶ä¹Ÿä¼šæŠ¥è¿™ä¸ªåº“æ‰¾ä¸åˆ°ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„åº“æ‰€åœ¨çš„è·¯å¾„å¹¶æ²¡æœ‰åŠ åˆ°<em>æŸ¥æ‰¾åº“æ‰€åœ¨è·¯å¾„</em>çš„ç¯å¢ƒä¸­ï¼Œç±»ä¼¼äºshellçš„å‘½ä»¤æŸ¥æ‰¾è§„åˆ™<em>PATH</em>ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œå¯ä»¥å°†è·¯å¾„æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­æˆ–è€…å°†åº“æ‹·è´åˆ°å·²çŸ¥çš„æŸ¥æ‰¾è·¯å¾„ä¸­ã€‚ç”¨æˆ·æ·»åŠ çš„ä¸€èˆ¬æ‹·åˆ°<code>/usr/lib</code>ä¸‹ï¼Œè¿™é‡Œå†å›åˆ°ä¸Šé¢ç¼–è¯‘demo.cçš„åœ°æ–¹ï¼Œå¦‚æœäº‹å…ˆå°†åº“æ‹·åˆ°ç³»ç»Ÿè·¯å¾„ä¸­ï¼Œé‚£ä¹ˆä¹…ä¸ç”¨åŠ <code>-L</code>æŒ‡å®šè·¯å¾„äº†ã€‚å¦‚æœæ˜¯åšåµŒå…¥å¼å¼€å‘ï¼Œè®°å¾—ä¸€å®šè¦æŠŠåº“æ‹·åˆ°å¼€å‘æ¿ä¸Šå“¦ã€‚åŠ¨æ€åº“åœ¨ç¨‹åºç¼–è¯‘å’Œæ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šç”¨çš„ã€‚</p>
<p>å†æ¬¡lddçœ‹ä¸‹å¹¶æ‰§è¡Œï¼š<br><img src="https://rancho333.github.io/pictures/ldd_3.png"></p>
<p>å¯ä»¥æ­£å¸¸æ‰§è¡Œæ‰“å°å‡ºå‡½æ•°åå­—äº†ï¼Œä½†æ˜¯æœ‰ç‚¹å¥‡æ€ªçš„æ˜¯æ²¡æœ‰è°ƒç”¨befor_mainå‡½æ•°ä¸ºä»€ä¹ˆä¹Ÿä¼šæ‰“å°å‡ºæ¥å‘¢ã€‚</p>
<h2 id="constructorå…³é”®å­—"><a href="#constructorå…³é”®å­—" class="headerlink" title="constructorå…³é”®å­—"></a>constructorå…³é”®å­—</h2><p>å›åˆ°ä¸Šé¢å»çœ‹çœ‹before_mainå‡½æ•°çš„å£°æ˜ï¼Œå‘ç°æœ‰ä¸ª<code>__attribute__((constructor))</code>ã€‚</p>
<h3 id="attribute-ä»‹ç»"><a href="#attribute-ä»‹ç»" class="headerlink" title="__attribute__ä»‹ç»"></a>__attribute__ä»‹ç»</h3><p>__attribute__å¯ä»¥è®¾ç½®å‡½æ•°å±æ€§(Function Attribute)ã€å˜é‡å±æ€§(Variable Attribute)å’Œç±»å‹å±æ€§(Type Attribute)ã€‚__attribute__å‰åéƒ½æœ‰ä¸¤ä¸ªä¸‹åˆ’çº¿ï¼Œå¹¶ä¸”åé¢ä¼šç´§è·Ÿä¸€å¯¹åŸæ‹¬å¼§ï¼Œæ‹¬å¼§é‡Œé¢æ˜¯ç›¸åº”çš„__attribute__å‚æ•°<br><em><strong>attribute__è¯­æ³•æ ¼å¼ä¸ºï¼š__attribute</strong> ( ( attribute-list ) )</em></p>
<p>è‹¥å‡½æ•°è¢«è®¾å®šä¸ºconstructorå±æ€§ï¼Œåˆ™è¯¥å‡½æ•°ä¼šåœ¨mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œä¹‹å‰è¢«è‡ªåŠ¨çš„æ‰§è¡Œã€‚ç±»ä¼¼çš„ï¼Œè‹¥å‡½æ•°è¢«è®¾å®šä¸ºdestructorå±æ€§ï¼Œåˆ™è¯¥å‡½æ•°ä¼šåœ¨mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œä¹‹åæˆ–è€…exitï¼ˆï¼‰è¢«è°ƒç”¨åè¢«è‡ªåŠ¨çš„æ‰§è¡Œã€‚</p>
<p>æ‰€ä»¥è®°å¾—äº†before_mainåœ¨mainå‡½æ•°ä¹‹å‰æ‰§è¡Œçš„å“¦ï¼Œä»¥å‰ä¸€ç›´åªè®°å¾—mainå‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£ã€‚è¿™æ¬¡ç§»æ¤è°ƒè¯•å‘ç°åœ¨mainå‡½æ•°ä¹‹å‰å°±coredumpäº†ï¼ŒæŸ¥äº†å¥½åŠå¤©æ‰å®šä½å‡ºæ¥ã€‚</p>
<p>å¥½ç©çš„ä¸œè¥¿å¾ˆå¤šï¼Œé‡åˆ°å¥‡æ€ªçš„ä¸œè¥¿å¾ˆå¤šæ—¶å€™å¿ƒé‡Œä¼šæ‰“é¼“ï¼Œä½†è¶Šæ¥è¶Šåšå®šï¼šä»£ç é‡Œæ²¡æœ‰ç„å­¦ï¼</p>
]]></content>
      <tags>
        <tag>åŠ¨æ€åº“so</tag>
        <tag>attributeå±æ€§</tag>
      </tags>
  </entry>
  <entry>
    <title>å…³äºç»ˆç«¯å›æ˜¾çš„é—®é¢˜</title>
    <url>/2021/01/05/%E5%85%B3%E4%BA%8E%E7%BB%88%E7%AB%AF%E5%9B%9E%E6%98%BE%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨åµŒå…¥å¼è®¾å¤‡è°ƒè¯•ä¸­ï¼Œç»å¸¸ä¼šä½¿ç”¨consoleå£å¯¹è®¾å¤‡è¿›è¡Œç®¡ç†ã€‚ä½¿ç”¨vimè¿›è¡Œæ–‡ä»¶ç¼–è¾‘æ—¶ï¼Œä¼šå‘ç°å±å¹•å›æ˜¾æœ‰é—®é¢˜ï¼Œä¾‹å¦‚ï¼Œè¡Œæ˜¾ç¤ºä¸ä¼šé€æ­¥é€’å¢åˆ°å±å¹•åº•ç«¯ï¼Œåˆ—æ˜¾ç¤ºæ—¶æ¢è¡Œé”™ä¹±ã€‚è¿™æ˜¯ttyè®¾ç½®çš„<code>rows</code>ä¸<code>cols</code>ä¸å®é™…çš„å±å¹•å°ºå¯¸ä¸é€‚é…ã€‚</p>
<span id="more"></span>
<h1 id="å¯¹äºconsoleè¿æ¥"><a href="#å¯¹äºconsoleè¿æ¥" class="headerlink" title="å¯¹äºconsoleè¿æ¥"></a>å¯¹äºconsoleè¿æ¥</h1><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>stty -a</code>æŸ¥çœ‹sttyçš„æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­ç¬¬ä¸€è¡ŒåŒ…æ‹¬æ³¢ç‰¹ç‡ï¼Œç»ˆç«¯çš„å¤§å°ï¼ˆä»¥å­—ç¬¦ä¸ºåŸºå‡†ï¼‰ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code>stty size</code>æŸ¥çœ‹ç»ˆç«¯çš„å¤§å°ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/stty.png"></p>
<p>å¯¹äºå¸¸è§çš„è¿œç¨‹ç™»å½•è½¯ä»¶ï¼Œå¦‚<code>xshell</code>å’Œ<code>secure CRT</code>ä¼šåœ¨è½¯ä»¶åº•ç«¯æ˜¾ç¤ºå‡ºå½“å‰ç»ˆç«¯çš„å¤§å°ï¼Œæˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªæ•°å€¼è¿›è¡Œè®¾å®šå³å¯ã€‚ä¹‹å<code>reset</code>ç»ˆç«¯è®¾ç½®ã€‚å¦‚æœæ˜¾ç¤ºä¾ç„¶ä¸æ­£å¸¸ï¼Œæœ€å¤§åŒ–çª—å£ç„¶åå†æ¢å¤å³å¯ã€‚</p>
<h1 id="å¯¹äºsshæˆ–telentè¿æ¥"><a href="#å¯¹äºsshæˆ–telentè¿æ¥" class="headerlink" title="å¯¹äºsshæˆ–telentè¿æ¥"></a>å¯¹äºsshæˆ–telentè¿æ¥</h1><p>ä¸ºä»€ä¹ˆä½¿ç”¨sshæˆ–è€…telnetè¿æ¥æ—¶ä¸ä¼šå‡ºç°è¿™ç§ç»ˆç«¯æ˜¾ç¤ºçš„é—®é¢˜å‘¢ï¼Œå› ä¸ºsshå½“çª—å£å¤§å°å‘ç”Ÿå˜åŒ–åï¼Œä¼šè‡ªåŠ¨çš„è°ƒæ•´sttyçš„æ•°å€¼ã€‚å¯ä»¥å°è¯•è°ƒæ•´çª—å£å¤§å°ï¼Œç„¶å<code>stty size</code>æŸ¥çœ‹ç»ˆç«¯å¤§å°ä¸è½¯ä»¶æ˜¾ç¤ºçš„çª—å£å¤§å°è¿›è¡Œæ¯”è¾ƒã€‚</p>
<h1 id="å†™åœ¨åé¢"><a href="#å†™åœ¨åé¢" class="headerlink" title="å†™åœ¨åé¢"></a>å†™åœ¨åé¢</h1><p>Linuxçš„TTYå­ç³»ç»Ÿå…¶å®æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„ç‚¹ã€‚å…¶ä¸­åŒ…æ‹¬çš„çŸ¥è¯†ç‚¹æœ‰<code>è¡Œç¼–è¾‘</code>ã€<code>è¿›ç¨‹ç»„</code>ã€<code>ä¼šè¯ç»„</code>ã€<code>ä¿¡å·æ§åˆ¶</code>ã€<code>æµæ§åˆ¶ä¸I/Oé˜»å¡</code>ã€<code>TTYé…ç½®</code>ç­‰ã€‚</p>
]]></content>
      <tags>
        <tag>stty</tag>
      </tags>
  </entry>
  <entry>
    <title>åŠ å¼˜è·‘å›¢</title>
    <url>/2020/12/21/%E5%8A%A0%E5%BC%98%E8%B7%91%E5%9B%A2/</url>
    <content><![CDATA[<p>ä¸ºä»€ä¹ˆè¦è·‘æ­¥ï¼Ÿ<br>æˆ‘æœ€å¼€å§‹è·‘æ­¥æ˜¯ä¸ºäº†å‡è‚¥ï¼Œç°åœ¨æˆ‘æ›´å¤šçš„è®¤ä¸ºè§„å¾‹æ€§çš„è·‘æ­¥æ˜¯ä¸€ç§å¥åº·çš„ç”Ÿæ´»æ–¹å¼ï¼Œæ˜¯ä¸€ç§ææ˜“è·å–çš„è¿åŠ¨ã€‚å¯¹è·‘æ­¥ï¼Œæˆ‘è°ˆä¸ä¸Šçƒ­çˆ±ï¼Œä½†æˆ‘å·²ç»ä¹ æƒ¯äº†ç”Ÿæ´»æœ‰å®ƒçš„ä¸€å¸­ä¹‹åœ°ã€‚æˆ‘çŸ¥é“è·‘æ­¥ä¹‹å‰çš„ç”Ÿæ´»çŠ¶æ€ï¼Œä¹ŸçŸ¥é“ç°åœ¨çš„ç”Ÿæ´»çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ç¦»ä¸å¼€è·‘æ­¥ã€‚</p>
<span id="more"></span>

<p>æåŠè·‘æ­¥ï¼Œå¯ä»¥è½»æ˜“æ‰¾åˆ°å„ç§å„æ ·çš„å¥½å¤„ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚ä½†æ˜¯éšä¾¿è·‘ä¸ªå‡ å…¬é‡Œï¼Œä¸€å‘¨åªè·‘ä¸€ä¸¤æ¬¡å…¶å®å¾ˆéš¾çœ‹åˆ°ä½ æƒ³è¦çš„æ•ˆæœã€‚å¦‚æœåŠ å¤§è·‘é‡ï¼Œè·‘æ­¥æœ‰æ—¶å€™å¯èƒ½ä¼šæŸä¼¤ä½ çš„è†ç›–ï¼Œè¿˜ä¼šè®©ä½ å¾—ä¸Šä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„ç—…ï¼Œä»€ä¹ˆè¶³åº•ç­‹è†œç‚ï¼Œè·Ÿè…±ç‚ï¼Œé«‚èƒ«æŸæ‘©æ“¦ç»¼åˆç—‡ï¼Œè·‘å®Œä¸€ä¸ªåŠé©¬ï¼Œä½ å¯èƒ½ä¸‹æ¥¼æ¢¯éƒ½å›°éš¾ã€‚</p>
<p>è·‘æ­¥æ˜¯ç—›è‹¦çš„ï¼Œé•¿è·‘æ›´æ˜¯æ„å¿—åŠ›çš„å¯¹æŠ—èµ›ã€‚åªæœ‰åœ¨ç†¬è¿‡æœ€åˆçš„è‹¦ç—›ï¼Œå¯ä»¥è¾¹è·‘è¾¹èŠå¤©ï¼Œå¯ä»¥åªç”¨é¼»å­å‘¼å¸çš„æ—¶å€™ï¼Œä½ æ‰ä¸ä¼šæ„Ÿè§‰é‚£ä¹ˆç…ç†¬ï¼Œè¿™ä¹‹å‰æ˜¯å¯ä»¥ç§°ä½œè·‘æ­¥ç—›è‹¦æœŸã€‚å¦‚æœæƒ³ç€æé«˜é…é€Ÿï¼Œå¢åŠ è·ç¦»ï¼Œå†çªç ´ç“¶é¢ˆï¼Œé‚£ä¾¿å¾—å†ç—›è‹¦ä¸€ç•ªã€‚è·‘æ­¥ä¹Ÿä¸èƒ½æ‹¯æ•‘æˆ‘ä»¬ï¼Œè·‘æ­¥æ˜¯èŠ±é’±çš„è¿åŠ¨ï¼Œä¸“ä¸šè·‘é‹å¾ˆè´µï¼Œæ‰€ä»¥å¥½å¥½å·¥ä½œæ‰èƒ½å¥½å¥½è·‘æ­¥ã€‚</p>
<p>è·‘æ­¥æ˜¯ç—›è‹¦çš„ï¼Œåªæœ‰è®¤è¯†åˆ°è·‘æ­¥çš„ç—›è‹¦ä¹‹åï¼Œç„¶åä¾ç„¶çƒ­çˆ±å¹¶ä¸”åšå®šçš„é€‰æ‹©ï¼Œæ‰èƒ½æŒä¹…çš„è¿›è¡Œã€‚è·‘æ­¥çš„å¿«ä¹ï¼Œåªæœ‰åœ¨è·å¾—æ­£å‘åé¦ˆä¹‹åï¼Œç†¬è¿‡è·‘æ­¥ç—›è‹¦æœŸä¹‹åï¼Œæ‰èƒ½çœŸæ­£ä½“ä¼šåˆ°ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸ºä»€ä¹ˆè¦è·‘æ­¥ï¼Ÿè¯·å¯»æ‰¾ä½ å†…å¿ƒçš„ä¿¡å¿µï¼Œè®©å®ƒæ”¯æ’‘ä½ ç†¬è¿‡å¼€å§‹è·‘æ­¥æ—¶çš„ç—›è‹¦ã€‚</p>
<p>ä»€ä¹ˆå«è·‘æ­¥ï¼Ÿ<br>è·‘æ­¥ï¼Œè·‘é©¬æ‹‰æ¾å¹¶ä¸ä¼šè®©æˆ‘ä»¬é«˜äººä¸€ç­‰ï¼Œä¹Ÿä¸æ˜¯åªæœ‰è·‘åå…¬é‡Œä»¥ä¸Šæ‰å«è·‘æ­¥ã€‚æ¯ä¸ªäººè·‘æ­¥çš„éœ€æ±‚ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚æœ‰ä¸¥è‚ƒè·‘è€…ï¼Œå°†è·‘æ­¥å½“ä½œå…´è¶£æ¥åŸ¹å…»ï¼ŒåŠ¨è¾„å…¨é©¬ç™¾å…¬é‡Œè¶…é©¬è¶Šé‡è·‘ï¼Œè¿½æ±‚æˆç»©è¿½æ±‚PBï¼›ä¹Ÿæœ‰ä¼‘é—²è·‘è€…ï¼Œä¸‰äº”å¥½å‹æˆ–æºå¦»å¸¦å­ï¼Œä¸‰ä¸¤å…¬é‡Œï¼Œå¾®é£å¾®æ±—ï¼Œä¹Ÿæ˜¯å¼€å¿ƒç•…å¿«ã€‚<br>ä¸ç”¨ç¥è¯è·‘æ­¥ï¼Œå­¦éŸ³ä¹ï¼Œå­¦èˆè¹ˆï¼Œå­¦è‹±è¯­éƒ½å¯ä»¥è®©æˆ‘ä»¬å˜å¾—æ›´å¥½ã€‚æ— è®ºæ˜¯ä¸¥è‚ƒçš„è·‘è€…è¿˜æ˜¯ä¼‘é—²çš„è·‘è€…ï¼Œè·‘èµ·æ¥ï¼Œéƒ½æ˜¯è·‘æ­¥ã€‚è·‘æ­¥æ˜¯ä¸€é¡¹åŒ…å®¹æ€§å¾ˆå¤§çš„æ´»åŠ¨ã€‚ä¸ç”¨ç®¡é…é€Ÿï¼Œä¸ç”¨ç®¡è·ç¦»ï¼Œè·‘èµ·æ¥å°±å¥½ã€‚</p>
<p>äº†è§£äº†ä¸€ä¸‹ï¼ŒåŠ å¼˜è·‘å›¢ä¸­æœ‰è·‘è¿‡ä¸Šé©¬çš„è€é©¬, æœ‰æ—©èµ·æ™¨è·‘çš„å¤§ä½¬ï¼Œæœ‰å¸Œæœ›è¿›é˜¶çš„è·‘è€…ï¼Œæœ‰åˆšæ¥è§¦è·‘æ­¥çš„èœé¸Ÿã€‚å¤§å®¶ç›¸èšä¸€èµ·ï¼Œä¸€èµ·è·‘ï¼Œæƒ³æ¥æ˜¯ä»¶å¾ˆæ¬¢å¿«çš„äº‹æƒ…ã€‚åŠ å¼˜è·‘å›¢åˆšæˆç«‹ï¼Œéœ€è¦å¤§å®¶ä¸€èµ·å»å°†è·‘å›¢è¿è¡Œèµ·æ¥ã€‚ä¸‹é¢å¯¹è·‘å›¢çš„è¿è¡Œä»¥åŠæ¥ä¸‹æ¥çš„å®‰æ’åšä¸€äº›ç®€è¦è¯´æ˜ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……ä¼˜åŒ–ã€‚</p>
<ol>
<li><p>æœ¬å‘¨4ï¼ˆ12æœˆ24å·ï¼‰è¿›è¡ŒåŠ å¼˜è·‘å›¢ç¬¬ä¸€æ¬¡åˆ†äº«ä¼šï¼Œå…·ä½“æ—¶é—´åœ°ç‚¹ä¼šé€šçŸ¥ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>å¤§å®¶ç›¸äº’è®¤è¯†ä¸€ä¸‹ï¼Œç¡®å®šè·‘å›¢äººå‘˜ï¼Œè´­ä¹°è·‘å›¢é˜Ÿæœï¼Œè¿˜æœ‰å¤§å®¶èµ¶ç´§æ‹‰äººå¤´</li>
<li>åˆ†äº«è·‘æ­¥åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºè·‘æ­¥å§¿åŠ¿ï¼Œé¢„é˜²ä¼¤å®³ï¼Œè·‘æ­¥åœºåœ°ï¼Œè·‘æ­¥æ—¶é—´ä¸é¥®é£Ÿ</li>
<li>è·‘æ­¥è£…å¤‡ä»‹ç»ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºè·‘é‹ï¼ˆè¢œå­ï¼‰ï¼Œè·‘è¡£ï¼Œæ‰‹è¡¨<br>å¤‡æ³¨ï¼šåˆ†äº«äººå¾…å®š</li>
</ol>
</li>
<li><p>æ´»åŠ¨ç»„ç»‡å½¢å¼</p>
<ol>
<li>æ¯æœˆç»„ç»‡ä¸€æ¬¡çº¿ä¸‹æ´»åŠ¨ï¼Œæ—¶é—´å¯ä»¥æ˜¯å‘¨æœ«æˆ–è€…æœ‰æ„ä¹‰çš„èŠ‚å‡æ—¥æˆ–å…¶å®ƒï¼Œåœ°ç‚¹å¾…ç¡®å®šã€‚ä¸èƒ½å‚åŠ çš„å¯ä»¥é€šè¿‡çº¿ä¸Šæ–¹å¼å‚ä¸</li>
<li>çº¿ä¸‹æ´»åŠ¨ä¼šè§†ç»è´¹æƒ…å†µå®‰æ’è¡¥ç»™ï¼Œä¾›å¤§å®¶è¡¥å……ä½“åŠ›</li>
<li>ä¸å®šæœŸå®‰æ’æ¯”èµ›æ´»åŠ¨ï¼Œè§†ç»è´¹æƒ…å†µå®‰æ’å¥–å“</li>
</ol>
</li>
<li><p>æš‚å®šå…ƒæ—¦è¿›è¡ŒåŠ å¼˜è·‘å›¢ç¬¬ä¸€æ¬¡çº¿ä¸‹æ´»åŠ¨</p>
</li>
</ol>
<p>ä¸ºäº†è·‘å›¢çš„è‰¯å¥½è¿è¡Œï¼Œè¯·å¤§å®¶ä»¥ä»»ä½•å½¢å¼è”ç³»æˆ‘æä¾›å»ºè®®ã€‚å…³äºçŸ¥è¯†åˆ†äº«ï¼Œè¯·å¤§ä½¬ä¸»åŠ¨è®¤é¢†ï¼<br>æœŸå¾…å¤§å®¶è¶Šè·‘è¶Šå¥åº·ï¼›æœŸå¾…å¤§å®¶è·‘ä¸€ä¸ªå†¬å¤©ï¼Œå¸…ä¸€ä¸ªå¤å¤©ï¼›æœŸå¾…æœ‰ä¸€å¤©åœ¨é©¬æ‹‰æ¾çš„èµ›é“ä¸Šçœ‹åˆ°åŠ å¼˜è·‘å›¢çš„æ——å¸œï¼</p>
]]></content>
      <tags>
        <tag>è·‘æ­¥</tag>
      </tags>
  </entry>
  <entry>
    <title>åŠè‡ªåŠ¨åŒ–æ‰¹é‡ä¿å­˜ç½‘é¡µ</title>
    <url>/2022/08/24/%E5%8D%8A%E8%87%AA%E5%8A%A8%E5%8C%96%E6%89%B9%E9%87%8F%E4%BF%9D%E5%AD%98%E7%BD%91%E9%A1%B5/</url>
    <content><![CDATA[<p>ä½¿ç”¨ä¸¤ä¸ªå·¥å…·</p>
<ol>
<li><p>web scraper æ‰¹é‡è·å–æ–‡ç« çš„é“¾æ¥ï¼Œå¯¼å‡ºä¸ºcsvæ–‡ä»¶</p>
</li>
<li><p>SingleFile æ‰¹é‡ä¸‹è½½é“¾æ¥ç½‘é¡µ  </p>
</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>åŒç‚¹åŒå‘é‡åˆ†å¸ƒ</title>
    <url>/2022/07/12/%E5%8F%8C%E7%82%B9%E5%8F%8C%E5%90%91%E9%87%8D%E5%88%86%E5%B8%83/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>ä¸åŒçš„è·¯ç”±ç½‘ç»œä¹‹é—´äº’è”çš„æ—¶å€™ï¼Œéœ€è¦ç›¸äº’å¯¼å…¥å¯¹æ–¹çš„è·¯ç”±å®Œæˆè·¯ç”±é‡åˆ†å¸ƒã€‚è¿›è¡ŒåŒå‘é‡åˆ†å¸ƒçš„è·¯ç”±å™¨å°±æ˜¾å¾—æ ¼å¤–é‡è¦ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœéšæ‚£ï¼Œå¯é€šè¿‡åŒç‚¹åŒå‘é‡åˆ†å¸ƒæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<span id="more"></span>

<h1 id="æ‹“æ‰‘æè¿°"><a href="#æ‹“æ‰‘æè¿°" class="headerlink" title="æ‹“æ‰‘æè¿°"></a>æ‹“æ‰‘æè¿°</h1><p>åŒç‚¹åŒå‘é‡åˆ†å¸ƒæ‹“æ‰‘å¦‚ä¸‹:</p>
<p><img src="https://rancho333.github.io/pictures/double_point_double_redistribute.png"></p>
<p>å·¦è¾¹çš„åŒºåŸŸè¿è¡Œripï¼Œå³è¾¹çš„åŒºåŸŸè¿è¡Œospfï¼Œåœ¨R2ã€R4ä¸ŠåšåŒå‘é‡åˆ†å¸ƒï¼Œæœ€ç»ˆæ•ˆæœï¼šåœ¨R1ä¸Šåˆ°3.3.3.3æœ‰ä¸¤ä¸ªä¸‹ä¸€è·³ï¼Œåœ¨R3ä¸Šåˆ°1.1.1.1ä¸Šæœ‰ä¸¤ä¸ªä¸‹ä¸€è·³ã€‚</p>
<h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><h2 id="æ¥å£ipåŠåŠ¨æ€è·¯ç”±åè®®é…ç½®"><a href="#æ¥å£ipåŠåŠ¨æ€è·¯ç”±åè®®é…ç½®" class="headerlink" title="æ¥å£ipåŠåŠ¨æ€è·¯ç”±åè®®é…ç½®"></a>æ¥å£ipåŠåŠ¨æ€è·¯ç”±åè®®é…ç½®</h2><div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">R1</a></li><li class="tab"><a href="#tab-2">R2</a></li><li class="tab"><a href="#tab-3">R4</a></li><li class="tab"><a href="#tab-4">R3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1ï¼š</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 14.1.1.1 255.255.255.0</span><br><span class="line"></span><br><span class="line"> router rip</span><br><span class="line"> version 2                          &#x2F;&#x2F; ä½¿ç”¨rip version2ç‰ˆæœ¬ï¼Œversion1åªèƒ½ä½¿ç”¨æœ‰ç±»åˆ«çš„ip</span><br><span class="line"> network 1.0.0.0</span><br><span class="line"> network 12.0.0.0</span><br><span class="line"> network 14.0.0.0</span><br><span class="line"> no auto-summary                    &#x2F;&#x2F; ripé»˜è®¤å¼€å¯è·¯ç”±æ±‡èšï¼Œå°†å…¶å…³é—­</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R2:</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.2 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 23.1.1.2 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0                             &#x2F;&#x2F; eth0&#x2F;1å‚åŠ ospf110çš„è®¡ç®—</span><br><span class="line">ï¼</span><br><span class="line">router ospf 110</span><br><span class="line">!</span><br><span class="line">router rip</span><br><span class="line"> version 2</span><br><span class="line"> network 12.0.0.0</span><br><span class="line"> no auto-summary</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-3"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R4ï¼š</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 4.4.4.4 255.255.255.255</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 14.1.1.4 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 34.1.1.3 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">router ospf 110</span><br><span class="line">!</span><br><span class="line">router rip</span><br><span class="line"> version 2</span><br><span class="line"> network 14.0.0.0</span><br><span class="line"> no auto-summary                                 &#x2F;&#x2F; é…ç½®å’ŒR2åŸºæœ¬ä¸€è‡´</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-4"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R3ï¼š</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.255</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 23.1.1.3 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 34.1.1.3 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0                         &#x2F;&#x2F; R3çš„æ¥å£å…¨éƒ¨åŠ å…¥ospf110çš„è®¡ç®—</span><br><span class="line">!</span><br><span class="line">router ospf 110</span><br></pre></td></tr></table></figure></div></div></div>

<p>é…ç½®å®Œæˆä¹‹åäº§çœ‹ä¸€äº›çŠ¶æ€ï¼Œçœ‹ç»“æœæ˜¯ä¸æ˜¯ç¬¦åˆé¢„æœŸã€‚åœ¨R2ï¼ŒR4ä¸Šåº”è¯¥é€šè¿‡ripå­¦åˆ°1.1.1.1çš„è·¯ç”±ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R2#show ip route | include 1.1.1.1</span><br><span class="line">R        1.1.1.1 [120&#x2F;1] via 12.1.1.1, 00:00:20, Ethernet0&#x2F;0</span><br><span class="line"></span><br><span class="line">R4#show ip route | include 1.1.1.1</span><br><span class="line">R        1.1.1.1 [120&#x2F;1] via 14.1.1.1, 00:00:16, Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>
<p>åœ¨R2ï¼ŒR4ä¸Šé¢åº”è¯¥é€šè¿‡ospfå­¦åˆ°3.3.3.3çš„è·¯ç”±ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R2#show ip route | include 3.3.3.3</span><br><span class="line">O        3.3.3.3 [110&#x2F;11] via 23.1.1.3, 00:08:19, Ethernet0&#x2F;1</span><br><span class="line"></span><br><span class="line">R4#show ip route | include 3.3.3.3</span><br><span class="line">O        3.3.3.3 [110&#x2F;11] via 34.1.1.3, 00:06:15, Ethernet0&#x2F;1</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶æ²¡æœ‰åšé‡åˆ†å¸ƒï¼Œæ‰€ä»¥R1ä¸Šæ²¡æœ‰åˆ°3.3.3.3çš„è·¯ç”±ï¼Œ R3ä¸Šä¹Ÿæ²¡æœ‰åˆ°1.1.1.1çš„è·¯ç”±ã€‚</p>
<h2 id="é‡åˆ†å¸ƒé…ç½®"><a href="#é‡åˆ†å¸ƒé…ç½®" class="headerlink" title="é‡åˆ†å¸ƒé…ç½®"></a>é‡åˆ†å¸ƒé…ç½®</h2><p>ç°åœ¨R2ä¸ŠåšåŒå‘é‡åˆ†å¸ƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R2(config)#router ospf 110</span><br><span class="line">R2(config-router)#redistribute rip subnets              &#x2F;&#x2F; åœ¨ospfä¸­å¼•å…¥ripçš„è·¯ç”±ï¼Œæ³¨æ„æŒ‡å®šsubnetsé€‰é¡¹</span><br><span class="line"></span><br><span class="line">R2(config)#router rip</span><br><span class="line">R2(config-router)#redistribute ospf 110 metric 3        &#x2F;&#x2F; åœ¨ripä¸­å¼•å…¥ospfçš„è·¯ç”±ï¼Œæ³¨æ„æŒ‡å®šmetricå€¼ï¼Œå¦åˆ™æ˜¯æ— ç©·å¤§</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶å°±å®Œæˆäº†æ‹“æ‰‘ä¸­çš„å•ç‚¹åŒå‘é‡åˆ†å¸ƒã€‚åˆ†åˆ«æ£€æŸ¥R1å’ŒR3ä¸Šçš„è·¯ç”±è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip route | begin 1.1.1.1</span><br><span class="line">C        1.1.1.1 is directly connected, Loopback0</span><br><span class="line">      2.0.0.0&#x2F;32 is subnetted, 1 subnets</span><br><span class="line">R        2.2.2.2 [120&#x2F;3] via 12.1.1.2, 00:00:03, Ethernet0&#x2F;0</span><br><span class="line">      3.0.0.0&#x2F;32 is subnetted, 1 subnets</span><br><span class="line">R        3.3.3.3 [120&#x2F;3] via 12.1.1.2, 00:00:03, Ethernet0&#x2F;0</span><br><span class="line">      4.0.0.0&#x2F;32 is subnetted, 1 subnets</span><br><span class="line">R        4.4.4.4 [120&#x2F;3] via 12.1.1.2, 00:00:03, Ethernet0&#x2F;0</span><br><span class="line">      12.0.0.0&#x2F;8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        12.1.1.0&#x2F;24 is directly connected, Ethernet0&#x2F;0</span><br><span class="line">L        12.1.1.1&#x2F;32 is directly connected, Ethernet0&#x2F;0</span><br><span class="line">      14.0.0.0&#x2F;8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        14.1.1.0&#x2F;24 is directly connected, Ethernet0&#x2F;1</span><br><span class="line">L        14.1.1.1&#x2F;32 is directly connected, Ethernet0&#x2F;1</span><br><span class="line">      23.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">R        23.1.1.0 [120&#x2F;3] via 12.1.1.2, 00:00:03, Ethernet0&#x2F;0</span><br><span class="line">      34.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">R        34.1.1.0 [120&#x2F;3] via 12.1.1.2, 00:00:03, Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°R1é€šè¿‡ripå­¦åˆ°äº†3.3.3.3çš„è·¯ç”±ï¼Œå¹¶ä¸”å³è¾¹ospfåŒºåŸŸå†…çš„è·¯ç”±å…¨éƒ¨æ˜¯é€šè¿‡eth0åˆ°R2ï¼Œç¬¦åˆé¢„æœŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R3#show ip route | begin 1.1.1.1</span><br><span class="line">O E2     1.1.1.1 [110&#x2F;20] via 23.1.1.2, 00:08:22, Ethernet0&#x2F;0</span><br><span class="line">      2.0.0.0&#x2F;32 is subnetted, 1 subnets</span><br><span class="line">O        2.2.2.2 [110&#x2F;11] via 23.1.1.2, 00:19:29, Ethernet0&#x2F;0</span><br><span class="line">      3.0.0.0&#x2F;32 is subnetted, 1 subnets</span><br><span class="line">C        3.3.3.3 is directly connected, Loopback0</span><br><span class="line">      4.0.0.0&#x2F;32 is subnetted, 1 subnets</span><br><span class="line">O        4.4.4.4 [110&#x2F;11] via 34.1.1.4, 00:16:58, Ethernet0&#x2F;1</span><br><span class="line">      12.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">O E2     12.1.1.0 [110&#x2F;20] via 23.1.1.2, 00:08:22, Ethernet0&#x2F;0</span><br><span class="line">      14.0.0.0&#x2F;24 is subnetted, 1 subnets</span><br><span class="line">O E2     14.1.1.0 [110&#x2F;20] via 23.1.1.2, 00:08:22, Ethernet0&#x2F;0</span><br><span class="line">      23.0.0.0&#x2F;8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        23.1.1.0&#x2F;24 is directly connected, Ethernet0&#x2F;0</span><br><span class="line">L        23.1.1.3&#x2F;32 is directly connected, Ethernet0&#x2F;0</span><br><span class="line">      34.0.0.0&#x2F;8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        34.1.1.0&#x2F;24 is directly connected, Ethernet0&#x2F;1</span><br><span class="line">L        34.1.1.3&#x2F;32 is directly connected, Ethernet0&#x2F;1</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°R3é€šè¿‡ospfå­¦åˆ°äº†1.1.1.1çš„è·¯ç”±ï¼Œå¹¶ä¸”å·¦è¾¹ripåŒºåŸŸå†…çš„è·¯ç”±å…¨éƒ¨æ˜¯é€šè¿‡eth0åˆ°R2ï¼Œç¬¦åˆé¢„æœŸã€‚pingæµ‹è¯•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R3#ping 1.1.1.1 source 3.3.3.3</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 1.1.1.1, timeout is 2 seconds:</span><br><span class="line">Packet sent with a source address of 3.3.3.3 </span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5&#x2F;5), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;1&#x2F;1 ms</span><br><span class="line">R3#                                                                 &#x2F;&#x2F; 1.1.1.1å’Œ3.3.3.3ä¹‹é—´æ˜¯é€šçš„ï¼Œç¬¦åˆé¢„æœŸ</span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥ä¸€ä¸‹R4çš„è·¯ç”±è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R4#show ip route | include 34.1.1.3</span><br><span class="line">O E2     1.1.1.1 [110&#x2F;20] via 34.1.1.3, 00:18:13, Ethernet0&#x2F;1           &#x2F;&#x2F;   ***</span><br><span class="line">O        2.2.2.2 [110&#x2F;21] via 34.1.1.3, 00:26:51, Ethernet0&#x2F;1</span><br><span class="line">O        3.3.3.3 [110&#x2F;11] via 34.1.1.3, 00:26:51, Ethernet0&#x2F;1</span><br><span class="line">O E2     12.1.1.0 [110&#x2F;20] via 34.1.1.3, 00:18:13, Ethernet0&#x2F;1          &#x2F;&#x2F; ***</span><br><span class="line">O        23.1.1.0 [110&#x2F;20] via 34.1.1.3, 00:26:51, Ethernet0&#x2F;1</span><br></pre></td></tr></table></figure>
<p>å‘ç°åŸæœ¬åœ¨é€šè¿‡ripå­¦ä¹ åˆ°çš„ä¸¤æ¡è·¯ç”±<code>1.1.1.1</code>å’Œ<code>12.1.1.0</code>ç°åœ¨æ˜¯é€šè¿‡ospfå­¦åˆ°çš„ï¼Œå¹¶ä¸”æ˜¯E2çš„æ ‡è®°ã€‚åŸå› å¦‚å›¾ç¤ºï¼š</p>
<p><img src="https://rancho333.github.io/pictures/inferior_path.png"></p>
<p>ä»¥1.1.1.1è·¯ç”±ä¸ºä¾‹ï¼ŒR4ä¼šåœ¨ä¸¤ä¸ªæ–¹å‘å­¦åˆ°è¯¥è·¯ç”±ã€‚çº¢çº¿éƒ¨åˆ†æ˜¯é€šè¿‡ripå­¦ä¹ åˆ°çš„ï¼Œadå€¼æ˜¯120. è“çº¿éƒ¨åˆ†æ˜¯ripé‡å®šå‘åˆ°ospfåŒºåŸŸå­¦åˆ°ï¼Œadå€¼æ˜¯110.<br>å¯¹äºç›¸åŒçš„prefixï¼Œé€šè¿‡ä¸åŒè·¯ç”±åè®®å­¦åˆ°ï¼Œé€‰adå€¼å°çš„ï¼Œæ‰€ä»¥R4åˆ°1.1.1.1çš„ä¸‹ä¸€è·³æ˜¯R3ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™æ˜¯ä¸€æ¡æ¬¡ä¼˜è·¯å¾„ã€‚åŒç†12.1.1.0ç½‘æ®µè·¯ç”±ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p>
<p>R4é€šè¿‡æ”¶åˆ°type5çš„LSAå­¦åˆ°å……ripä¸­é‡å®šå‘çš„è·¯ç”±ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸‹å¤–éƒ¨è·¯ç”±çš„adå€¼å°±å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R4(config-router)#distance ospf external 121            &#x2F;&#x2F; æ”¹æˆæ¯”rip adå¤§å³å¯</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡æŸ¥çœ‹R4çš„è·¯ç”±</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R4#show ip route | include 14.1.1.1</span><br><span class="line">R        1.1.1.1 [120&#x2F;1] via 14.1.1.1, 00:00:18, Ethernet0&#x2F;0</span><br><span class="line">R        12.1.1.0 [120&#x2F;1] via 14.1.1.1, 00:00:18, Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>
<p>å‘ç°æ¬¡ä¼˜è·¯å¾„çš„é—®é¢˜å·²ç»æ²¡æœ‰äº†ã€‚</p>
<h3 id="åŒç‚¹åŒå‘é‡åˆ†å¸ƒ"><a href="#åŒç‚¹åŒå‘é‡åˆ†å¸ƒ" class="headerlink" title="åŒç‚¹åŒå‘é‡åˆ†å¸ƒ"></a>åŒç‚¹åŒå‘é‡åˆ†å¸ƒ</h3><p>æœ¬æ¬¡å®éªŒè¦ç‚¹æ˜¯åŒç‚¹åŒå‘é‡åˆ†å¸ƒï¼Œä¹‹å‰åªæ˜¯åœ¨R2å•ç‚¹ä¸Šè¿›è¡Œé‡åˆ†å¸ƒï¼Œç°åœ¨åœ¨R4ä¸Šä¹Ÿæ‰§è¡Œé‡åˆ†å¸ƒæ“ä½œ, é…ç½®ä¸R2ä¸Šä¸€è‡´ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç°åœ¨R2ä¹Ÿä¼šé‡åˆ°ä¹‹å‰R4çš„æ¬¡ä¼˜è·¯å¾„çš„é—®é¢˜ï¼Œå› ä¸ºç°åœ¨R2ä¹Ÿä¼šä»ripå’Œospfä¸¤ä¸ªåŸŸæ”¶åˆ°1.1.1.1çš„è·¯ç”±ï¼Œæ‰€ä»¥åŒæ ·éœ€è¦åœ¨ospfä¸­ä¿®æ”¹å¤–éƒ¨è·¯ç”±adå€¼ã€‚åˆ†åˆ«æŸ¥çœ‹R1å’ŒR3ä¸Šçš„è·¯ç”±ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip route | begin 3.3.3.3</span><br><span class="line">R        3.3.3.3 [120&#x2F;3] via 14.1.1.4, 00:00:22, Ethernet0&#x2F;1</span><br><span class="line">                 [120&#x2F;3] via 12.1.1.2, 00:00:26, Ethernet0&#x2F;0</span><br><span class="line">&#x2F;&#x2F; R1åˆ†åˆ«å­¦åˆ°ä»R2ã€R4é‡åˆ†å¸ƒè¿‡æ¥çš„3.3.3.3çš„è·¯ç”±ï¼Œå½¢æˆecmp</span><br><span class="line"></span><br><span class="line">R3#show ip route | begin 1.1.1.1</span><br><span class="line">O E2     1.1.1.1 [110&#x2F;20] via 34.1.1.4, 00:06:13, Ethernet0&#x2F;1</span><br><span class="line">                 [110&#x2F;20] via 23.1.1.2, 00:04:31, Ethernet0&#x2F;0</span><br><span class="line">&#x2F;&#x2F; R3ä¸Šåˆ†åˆ«å­¦åˆ°ä»R2ã€R4é‡åˆ†å¸ƒè¿‡æ¥çš„1.1.1.1çš„è·¯ç”±ï¼Œå½¢æˆecmp</span><br></pre></td></tr></table></figure>
<p>å®Œå…¨ç¬¦åˆé¢„æœŸã€‚</p>
<h2 id="è·¯ç”±æ ‡è®°è§£å†³è·¯ç”±å›é¦ˆçš„é—®é¢˜"><a href="#è·¯ç”±æ ‡è®°è§£å†³è·¯ç”±å›é¦ˆçš„é—®é¢˜" class="headerlink" title="è·¯ç”±æ ‡è®°è§£å†³è·¯ç”±å›é¦ˆçš„é—®é¢˜"></a>è·¯ç”±æ ‡è®°è§£å†³è·¯ç”±å›é¦ˆçš„é—®é¢˜</h2><p>ä»¥æœ¬å®éªŒä¸ºä¾‹ï¼ŒR2ä¸Šåœ¨ospfä¸­å¼•å…¥çš„ripè·¯ç”±ï¼ŒæŸäº›æƒ…å†µä¸‹ï¼ŒR4ä¸Šä¼šå°†è¿™éƒ¨åˆ†è·¯ç”±ä»é‡åˆ†å¸ƒåˆ°ripã€‚ripä¸­æ²¡æœ‰é‚»å±…çš„æ¦‚å¿µï¼Œå°†R1çš„eth1 shutdownä¹‹åï¼Œåœ¨R4ä¸Šï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R4#clear ip route *                &#x2F;&#x2F; åˆ·æ–°R4ä¸Šçš„è·¯ç”±è¡¨</span><br><span class="line"></span><br><span class="line">R4#show ip route | include 1.1.1.1</span><br><span class="line">O E2     1.1.1.1 [121&#x2F;20] via 34.1.1.3, 00:04:34, Ethernet0&#x2F;1     &#x2F;&#x2F; æ­¤æ—¶1.1.1.1çš„è·¯ç”±æ˜¯ä»ospfå­¦åˆ°çš„(R2ä¸Šripé‡åˆ†å¸ƒåˆ°ospfä¸­)</span><br></pre></td></tr></table></figure>
<p>åœ¨R2çš„eth1ä¸ŠæŠ“åŒ…å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/routing_backward.png"></p>
<p>å¯ä»¥å‘ç°R4å°†æœ¬å±äºripè·¯ç”±åŸŸä¸­<code>1.1.1.1</code>å’Œ<code>12.1.1.0</code>è¿™ä¸¤æ¡è·¯ç”±é‡æ–°å‘å›åˆ°äº†ripï¼Œè¿™ä¼š<em>å¼•èµ·è·¯ç”±ç¯è·¯çš„é£é™©</em>ã€‚</p>
<p>é€šè¿‡è·¯ç”±æ ‡è®°å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æœ¬è´¨æ˜¯æœ¬è·¯ç”±åŸŸä»åˆ«çš„è·¯ç”±åŸŸä¸­å­¦åˆ°çš„è·¯ç”±ä¸ä¼šå†é‡æ–°åˆ†å‘å›å»(è‡ªå·±å‘å‡ºçš„è‡ªå·±ä¸å†æ¥æ”¶)ã€‚å®é™…æ“ä½œæ˜¯ï¼š</p>
<ol>
<li>å½“ä»åˆ«çš„è·¯ç”±åŸŸå¼•å…¥è·¯ç”±çš„æ—¶å€™ï¼Œç»™è¿™äº›è·¯ç”±æ‰“ä¸Šæ ‡è®°</li>
<li>å°†æœ¬è·¯ç”±åŸŸä¸­çš„è·¯ç”±é‡åˆ†å¸ƒå‡ºå»çš„æ—¶å€™ï¼Œä¸åˆ†å¸ƒè¿™äº›æœ‰æ ‡è®°çš„è·¯ç”±</li>
</ol>
<p>æ¥ç€ä¸Šé¢çš„å®éªŒï¼ŒR2ä¸Šospfä¸­å¼•å…¥çš„ripè·¯ç”±æ‰“ä¸Šæ ‡è®°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R2(config)#router ospf 110</span><br><span class="line">R2(config-router)#redistribute rip subnets tag 120</span><br></pre></td></tr></table></figure>
<p>åœ¨R4ä¸ŠæŸ¥çœ‹ospfä¸­å¸¦æœ‰tagçš„è·¯ç”±ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R4#show ip ospf database | include 120</span><br><span class="line">1.1.1.1         2.2.2.2         704         0x80000003 0x00F128 120</span><br><span class="line">12.1.1.0        2.2.2.2         704         0x80000003 0x006CA3 120</span><br></pre></td></tr></table></figure>
<p>R4ä¸Šåœ¨ripä¸­å¼•å…¥ospfè·¯ç”±æ—¶è¿‡æ»¤è¿™äº›å¸¦æœ‰tagçš„è·¯ç”±ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">route-map otr deny 5                      &#x2F;&#x2F; å¸¸è§route-map ospf two ripï¼Œdeny</span><br><span class="line"> match tag 120                            &#x2F;&#x2F; tagä¸º120çš„è·¯ç”±å…¨éƒ¨deny</span><br><span class="line">!</span><br><span class="line">route-map otr permit 10                   &#x2F;&#x2F;å…è®¸ä¸å¸¦tag 120çš„è·¯ç”±é€šè¿‡</span><br><span class="line"></span><br><span class="line">router rip</span><br><span class="line"> redistribute ospf 110 metric 3 route-map otr               &#x2F;&#x2F; åœ¨ripä¸­å¼•å…¥ospfçš„è·¯ç”±æ—¶ä½¿èƒ½è¯¥route-map</span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…æ‹“æ‰‘æ”¶æ•›åå†æ¬¡æŠ“åŒ…æŸ¥çœ‹ï¼š<br><img src="https://rancho333.github.io/pictures/routing_backward_fix.png"></p>
<p>ç”±äºæ˜¯åŒç‚¹åŒå‘é‡åˆ†å¸ƒï¼Œæ‰€ä»¥éœ€è¦åœ¨4ä¸ªredistributeçš„ç‚¹ä¸Šåˆ†åˆ«æ‰“tagå’Œä½¿èƒ½å¯¹åº”çš„route-mapï¼Œè¿™é‡Œä¸åšé‡å¤æ“ä½œã€‚</p>
<h1 id="ç®€å•æ€»ç»“"><a href="#ç®€å•æ€»ç»“" class="headerlink" title="ç®€å•æ€»ç»“"></a>ç®€å•æ€»ç»“</h1><p>æœ¬å®éªŒçš„å…³é”®æ˜¯ADå€¼çš„ç†è§£ã€‚åŒç‚¹åŒå‘é‡åˆ†å¸ƒä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<ol>
<li>æ¬¡ä¼˜è·¯å¾„ã€‚é«˜ADå‘ä½ADé‡åˆ†å¸ƒæ—¶äº§ç”Ÿæ¬¡ä¼˜è·¯å¾„ã€‚R2é‡åˆ†å¸ƒåï¼ŒR4åˆ°1.1.1.1æ˜¯æ¬¡ä¼˜è·¯å¾„ã€‚</li>
<li>é‡åˆ†å¸ƒå¤±è´¥ã€‚é‡åˆ†å¸ƒçš„æœ¬è´¨ï¼šåœ¨é‡åˆ†å¸ƒè·¯ç”±è¡¨ä¸­ä¸€å®šè¦æœ‰å¯¹åº”è·¯ç”±åè®®çš„è·¯ç”±ã€‚R2é‡åˆ†å¸ƒåï¼ŒR4çš„è·¯ç”±è¡¨ä¸­æ²¡æœ‰rip 1.1.1.1çš„è·¯ç”±ï¼Œr4è‡ªç„¶æ— æ³•å°†1.1.1.1ä»ripé‡åˆ†å¸ƒåˆ°ospfï¼Œæ­¤æ—¶R3ä¸Šåˆ°1.1.1.1çš„ä¸‹ä¸€è·³åªæœ‰R2.</li>
<li>è·¯ç”±å›é¦ˆ(è·¯ç”±å€’çŒ)ï¼šå½“ä¸€ä¸ªåè®®çš„è·¯ç”±é‡åˆ†å¸ƒè¿›å¦ä¸€ä¸ªåè®®åï¼Œå¦‚æœä¸åšä»»ä½•æ§åˆ¶ï¼Œåœ¨åŒç‚¹åŒå‘çš„åœºæ™¯ä¸­ï¼Œæºè‡ªäºè¯¥åè®®çš„è·¯ç”±å¾ˆå¯èƒ½è¢«é‡æ–°åˆ†å¸ƒå›å»ï¼Œå°±ä¼šæœ‰ç¯è·¯é£é™©ã€‚</li>
</ol>
<p>æœ¬è´¨å°±æ˜¯è·¯ç”±é‡åˆ†å¸ƒä¹‹åï¼Œè¾¹ç•Œè·¯ç”±å™¨å¯èƒ½ä»ä¸åŒçš„è·¯ç”±åŸŸä¸­æ”¶åˆ°ç›¸åŒprefixçš„è·¯ç”±ï¼Œadå€¼å°çš„ä¸‹å‘åˆ°è·¯ç”±è¡¨ï¼Œæ­¤æ—¶å¯èƒ½é€ æˆæ¬¡ä¼˜è·¯å¾„ç­‰é—®é¢˜ã€‚</p>
]]></content>
      <tags>
        <tag>è·¯ç”±</tag>
        <tag>AD</tag>
      </tags>
  </entry>
  <entry>
    <title>å¯¹SONiCé¡¹ç›®çš„è®¤è¯†</title>
    <url>/2021/02/25/%E5%AF%B9SONiC%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%A4%E8%AF%86/</url>
    <content><![CDATA[<h1 id="SONiCç®€ä»‹"><a href="#SONiCç®€ä»‹" class="headerlink" title="SONiCç®€ä»‹"></a>SONiCç®€ä»‹</h1><p>ä¸åšè¿‡å¤šèµ˜è¿°ï¼ŒSONiCæœ¬è´¨å°±æ˜¯ä¸€ä¸ªLinuxäº¤æ¢æœºç½‘ç»œæ“ä½œç³»ç»Ÿï¼Œå®ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ã€‚</p>
<span id="more"></span>
<p>ç¬¬ä¸€ï¼Œå®ƒæ˜¯åŸºäºSAIçš„ï¼Œåœ¨æ²¡æœ‰SAIä¹‹å‰æ‰€æœ‰çš„èŠ¯ç‰‡éƒ½è¦é€šè¿‡è‡ªå·±çš„SDKä¸ä¸Šå±‚è½¯ä»¶è¿›è¡Œé€šä¿¡ï¼Œç›¸å½“äºç”¨è‡ªå·±çš„â€œæ–¹è¨€â€ä¸ä¸Šå±‚æ“ä½œç³»ç»Ÿé€šä¿¡ï¼ŒSAIæŠŠè¿™ä¸ªâ€œæ–¹è¨€â€æ ‡å‡†åŒ–ï¼Œå¤§å®¶çš„èŠ¯ç‰‡ç”¨åŒæ ·çš„è¯­è¨€åŒä¸Šå±‚çš„æ§åˆ¶è½¯ä»¶äº¤æµï¼Œå› ä¸ºæœ‰äº†SAIï¼Œæ‰€ä»¥æ‰èƒ½å»ºç«‹ä¸€ä¸ªæ“ä½œç³»ç»Ÿã€‚æœ‰äº†SAIä¹‹åï¼Œé€‚é…ASICçš„å·¥ä½œç”±èŠ¯ç‰‡å‚å•†å®Œæˆï¼Œç™½ç›’äº¤æ¢æœºå‚å•†æ¨å‡ºä¸€æ¬¾æ–°äº§å“æ‰€èŠ±è´¹çš„æ—¶é—´å¤§å¤§ç¼©çŸ­ã€‚</p>
<p>ç¬¬äºŒï¼ŒåŸºäºDockerï¼ŒSonicæœ‰ä¸°å¯Œçš„æ‰©å±•æ€§ã€‚ä¾æ‰˜äºLinux,Dockerç”Ÿæ€ï¼ŒSonicå­•è‚²äº†ä¸°å¯Œçš„ç®¡ç†è½¯ä»¶å’Œè§£å†³æ–¹æ¡ˆã€‚è€Œå…¶è‡ªèº«ä¹ŸäºRedis, Quagga, LLDPç­‰å¼€æºæŠ€æœ¯ç¢°æ’å‡ºæ›´å¤šç«èŠ±ã€‚</p>
<p>2016å¹´ï¼ŒSONiCçš„ç†å¿µå°±æ˜¯å°†ä¼ ç»Ÿäº¤æ¢æœºOSæ‹†åˆ†æˆå¤šä¸ªå®¹å™¨åŒ–ç»„ä»¶çš„è§£å†³æ–¹æ¡ˆï¼Œè¿›è€Œä¹Ÿå®šä¹‰äº†æ§åˆ¶é¢çš„å®¹å™¨åŒ–æ¶æ„ï¼Œå›Šæ‹¬äº†ç»„ä»¶å’Œç¼–ç¨‹æ¥å£ã€‚</p>
<p>2017å¹´å¾®è½¯å¯¹SONiCçš„æ€§èƒ½è¿›è¡Œäº†å¤§å¹…å‡çº§ï¼Œå…¨é¢æ”¯æŒIDVï¼Œå¹¶ä¸”èåˆäº†æ›´å¤šçš„å®¹å™¨ç‰¹æ€§ã€‚</p>
<p>2018å¹´å¾®è½¯åˆåœ¨ç®¡ç†æ€§ä¸Šä¸‹äº†å¤§åŠ›æ°”ï¼ˆå¦‚ConfigDBï¼‰</p>
<h1 id="å¯¹SONiCé¡¹ç›®çš„å­¦ä¹ "><a href="#å¯¹SONiCé¡¹ç›®çš„å­¦ä¹ " class="headerlink" title="å¯¹SONiCé¡¹ç›®çš„å­¦ä¹ "></a>å¯¹SONiCé¡¹ç›®çš„å­¦ä¹ </h1><p>ç›¸æ¯”äºä¼ ç»ŸLinuxäº¤æ¢æœºæ“ä½œç³»ç»Ÿå‡ åMçš„é•œåƒå¤§å°ï¼ŒSONiCé•œåƒåŠ¨è¾„å‡ ç™¾Mç”šè‡³è¶…1Gï¼Œè¿™ä¹Ÿè¯´æ˜äº†é‡Œé¢åŒ…å«çš„å†…å®¹æå…¶åºæ‚ã€‚å¦‚æœæœ‰æ¯”è¾ƒæ·±åšçš„LinuxåŠŸåº•ï¼Œä¸Šæ‰‹ä¼šå¾ˆå¿«ã€‚å› ä¸ºé‡Œé¢å¤§å¤šæ˜¯Linuxæœ¬è´¨æ€§ã€ä¸å˜æ€§å’Œå¯å¤ç”¨æ€§çš„ä¸œè¥¿ã€‚ä»¥è‡ªå·±å¯¹SONiCé¡¹ç›®çš„è®¤çŸ¥ï¼Œå°†å…¶åˆ’åˆ†ä¸º5ä¸ªå¤§å—æ¯”è¾ƒåˆé€‚ã€‚åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>SONiCçš„ç¼–è¯‘</li>
<li>SONiCçš„å®‰è£…</li>
<li>SONiCçš„bring up</li>
<li>SONiCçš„ä¸Šå±‚åº”ç”¨</li>
<li>TestBedè‡ªåŠ¨åŒ–æµ‹è¯•</li>
</ul>
<h2 id="SONiCçš„ç¼–è¯‘"><a href="#SONiCçš„ç¼–è¯‘" class="headerlink" title="SONiCçš„ç¼–è¯‘"></a>SONiCçš„ç¼–è¯‘</h2><p>è¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯ä¸€ä¸ªåºå¤§çš„æºç ç¼–è¯‘å‡ºLinuxå®‰è£…é•œåƒçš„è¿‡ç¨‹ï¼Œç±»æ¯”äºLFSã€‚è¿™é‡Œå¯ä»¥å€Ÿç”¨åµŒå…¥å¼æ“ä½œç³»ç»Ÿç§»æ¤çš„4ä¸ªæ­¥éª¤ç”¨æ¥è¾…åŠ©è¯´æ˜ã€‚</p>
<ol>
<li>äº¤å‰ç¼–è¯‘ç¯å¢ƒçš„åˆ¶ä½œã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒSONiCçš„å®¿ä¸»æœºä¸ç›®æ ‡æœºéƒ½æ˜¯x86ï¼Œæ‰€ä»¥æ²¡æœ‰äº¤å‰ç¼–è¯‘è¿™ç§è¯´æ³•ï¼Œä½†æ˜¯sonicæ˜¯æ”¯æŒARMå’ŒARM64çš„ï¼Œåªæ˜¯ç°é˜¶æ®µæˆ‘æ²¡ç©è¿‡ã€‚å€¼å¾—å…³æ³¨çš„æ˜¯ï¼ŒSONiCåœ¨ç¼–è¯‘ä¹‹å‰ä¼šåˆ¶ä½œä¸€ä¸ªdockerç”¨æ¥æ‰“åŒ…ç¼–è¯‘ç¯å¢ƒï¼Œä¹‹åæ‰€æœ‰çš„ç¼–è¯‘åœ¨é‡Œé¢å®Œæˆã€‚</li>
<li>kernelçš„é…ç½®ã€ç¼–è¯‘ã€ç§»æ¤ã€‚SONiCåœ¨kernelç¼–è¯‘æ—¶ä¼šæŒ‡å®šconfigï¼Œå‚è§kernelçš„Makefileï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰éœ€ä¿®æ”¹ã€‚</li>
<li>æ ¹æ–‡ä»¶ç³»ç»Ÿçš„åˆ¶ä½œã€‚SONiCä½¿ç”¨debootstrapå®Œæˆæ–‡ä»¶ç³»ç»Ÿçš„åŸºç¡€æ¶æ„ï¼Œä¹‹åä¼šå°†ç¼–è¯‘å¥½çš„debåŒ…ï¼ŒwhlåŒ…ç­‰targeté‡Šæ”¾æˆ–æ‹·è´åˆ°rootfsä¸­å»ï¼Œæœ€ç»ˆç”Ÿæˆçš„sonic-platform.binæ˜¯ä¸€ä¸ªfs.zipã€fs.squashfaã€docker.tar.gzä»¥åŠåˆå§‹åŒ–è„šæœ¬çš„æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
<li>bootloaderçš„ç§»æ¤ã€‚è£¸æœºè£…biosæ²¡æœ‰ç©è¿‡ï¼ŒSONiCç›’å­éœ€è¦åœ¨biosä¹‹ä¸Šå®‰è£…ä¸€ä¸ªONIEï¼ŒONIEæœ¬è´¨æ˜¯ä¸€ä¸ªå°çš„Linuxï¼Œæä¾›SONiCå®‰è£…ç¯å¢ƒ</li>
</ol>
<p>å¯¹äºè¿™ä¸€éƒ¨åˆ†ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¯”è¾ƒå…¨é¢çš„æ¦‚è§ˆï¼Œå½“æœ‰portingæˆ–ä»»ä½•éœ€è¦ä¿®æ”¹æºç çš„éœ€æ±‚æ—¶ï¼Œå°†ä¼šæœ‰ä¸€å®šæ–¹å‘æ€§ã€‚SONiCçš„ç¼–è¯‘æ¡†æ¶ä¸»è¦ç”±shellè„šæœ¬ï¼ŒMakefileï¼ŒDockefileä»¥åŠj2æ¨¡æ¿æ–‡ä»¶æ„æˆï¼Œéœ€è¦æœ‰ä¸€å®šçš„Makefileã€shellè„šæœ¬åŸºç¡€ã€‚</p>
<h2 id="SONiCçš„å®‰è£…"><a href="#SONiCçš„å®‰è£…" class="headerlink" title="SONiCçš„å®‰è£…"></a>SONiCçš„å®‰è£…</h2><p>SONiCçš„å®‰è£…æ˜¯æŸç§ç¨‹åº¦ä¸Šæ˜¯ç”Ÿæˆé•œåƒçš„ä¸€ä¸ªé€†å‘è¿‡ç¨‹ã€‚sonic-asic.binæ˜¯ä¸€ä¸ªshellè„šæœ¬ï¼Œå¯ä»¥åœ¨shellä¸‹ç›´æ¥æ‰§è¡Œä¸€ä¸‹çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚SONiCå®‰è£…çš„æœ¬è´¨å…¶å®å°±æ˜¯bash ./sonic-asic.binçš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<p>SONiCå¯ä»¥åœ¨ONIEå’ŒSONiCç¯å¢ƒä¸‹å®Œæˆå®‰è£…ï¼Œè¿™é‡Œé¢ä¼šè°ƒç”¨ä¸¤ä¸ªè„šæœ¬sharch_body.shå’Œinstall.shã€‚SONiCçš„å®‰è£…æ—¶ä¼šæœ‰ä¸€äº›æ‰“å°ï¼Œå‚ç…§æ‰“å°ä¸shellè„šæœ¬å¯ä»¥å‘ç°é‡Œé¢åšäº†ä»€ä¹ˆ,å…³æ³¨ä¸€ä¸‹<code>/boot</code>ç›®å½•ã€‚åœ¨æ­¤å¤„ç®€å•è¯´æ˜ä¸€ä¸‹ï¼š</p>
<ul>
<li>åœ¨sharch_body.shä¸­<ul>
<li>å¯¹imageæ–‡ä»¶è¿›è¡Œhashæ ¡éªŒ</li>
<li>ä¸ºinstall.shå‡†å¤‡è¿è¡Œç¯å¢ƒå¹¶æ‰§è¡Œinstall.sh</li>
</ul>
</li>
<li>åœ¨install.shä¸­<ul>
<li>ç¡®å®šå®‰è£…ç¯å¢ƒï¼ˆONIEã€SONiCã€buildï¼‰</li>
<li>è°ƒç”¨machine.confï¼Œå‡†å¤‡platformç›¸å…³ç¯å¢ƒå˜é‡ï¼Œé…ç½®consoleï¼Œé»˜è®¤æ˜¯ttyS0å’Œ9600ã€‚å‚æ•°è®¾ç½®ä¸åŒ¹é…å°†å¯¼è‡´SONiC bring upå¤±è´¥ã€‚æ–°å®‰è£…çš„onieï¼Œéœ€è¦åœ¨onieä¸‹ä¿®æ”¹eepromä»¥åŠmachine.conf(è¿™ä¸ªå¯ä»¥åœ¨onieç¼–è¯‘çš„æ—¶å€™æŒ‡å®š)ã€‚éœ€è¦å…³æ³¨ä¿®æ”¹ä¸‰ä¸ªå­—æ®µï¼šonie_switch_asicã€onie_machineã€onie_platformã€‚</li>
<li>å®‰æ’å®‰è£…osçš„åˆ†åŒºï¼ˆuefi+gptï¼‰</li>
<li>è§£å‹fs.zip(boot+platform+docker+fs.squashfs)è‡³åˆ†åŒºï¼Œonieå’ŒSONiCå®‰è£…ä¼šæœ‰ä¸€äº›ç»†å¾®å·®åˆ«ã€‚è¿™é‡Œå°†åˆ›å»ºbootå’Œplatformæ–‡ä»¶å¤¹ï¼ˆåœ¨sonicçš„/host/image*ä¸‹é¢ï¼Œä¸æ˜¯æ ¹ç›®å½•ï¼‰ï¼Œå°†é©±åŠ¨æ”¾åˆ°å¯¹åº”æ–‡ä»¶å¤¹ä¸‹ï¼Œåœ¨rc.localä¸­ä¼šé‡Šæ”¾å‡ºæ¥ã€‚</li>
<li>é…ç½®grubï¼Œå®‰è£…å®Œæˆ </li>
<li>é‡å¯ä¹‹åä¼šæŒ‰ç…§å®‰è£…æ—¶è®¾ç½®çš„grudå¯åŠ¨æ–°çš„æ“ä½œç³»ç»Ÿ</li>
</ul>
</li>
</ul>
<h2 id="SONiCçš„bring-up"><a href="#SONiCçš„bring-up" class="headerlink" title="SONiCçš„bring up"></a>SONiCçš„bring up</h2><p>SONiCåŸºäºSAIå¯ä»¥ï¼š ä¸€ä¸ªé•œåƒé€‚é…ç›¸åŒASICå‚å®¶çš„ä¸åŒè®¾å¤‡å‹å·ï¼Œæ¯ä¸€ä¸ªæ¬¾è®¾å¤‡éƒ½æœ‰è‡ªå·±çš„å·®å¼‚æ€§é…ç½®æ–‡ä»¶ï¼Œå¦‚ç«¯å£ï¼Œledï¼Œæ³¢ç‰¹ç‡ç­‰ã€‚SONiCæ˜¯å¦‚ä½•æ­£ç¡®åŠ è½½å¯¹åº”è®¾å¤‡å‹å·çš„é…ç½®æ–‡ä»¶çš„ï¼Ÿè¿™é‡Œç•™ä¸ªé—®é¢˜å¯ä»¥è‡ªå·±æŸ¥æŸ¥ã€‚</p>
<p>SONiCæ˜¯Linux, æ‰€ä»¥éµå¾ªLinuxçš„å¯åŠ¨è¿‡ç¨‹ã€‚</p>
<ol>
<li><p>bootloader + onieé˜¶æ®µ<br>æˆ‘ä»¬å¯ä»¥åœ¨onieä¸‹å®‰è£…sonicï¼Œgrubå°†cmdlineå‚æ•°ä¼ é€’ç»™kernelï¼Œkernelå¯åŠ¨ï¼ŒåŠ è½½é©±åŠ¨</p>
</li>
<li><p>kernelå¯åŠ¨ä¹‹åsystemdåˆå§‹åŒ–é˜¶æ®µè¿™é‡Œé¢å¯ä»¥ç»†åˆ†</p>
<ul>
<li>systemdç›¸å…³ï¼Œä½¿ç”¨<code>systemctl list-dependencies graphical.target</code>æŸ¥çœ‹å½“å‰åŠ è½½çš„æœåŠ¡ </li>
<li>rc.localï¼Œè¿™é‡Œé¢æœ‰ä¸€äº›å¯åŠ¨åæ‰§è¡Œçš„åŠ¨ä½œï¼Œè‡ªå·±ç…ç…å§</li>
</ul>
</li>
</ol>
<p>éœ€è¦å…³æ³¨ä¸€ä¸‹SONiCçš„æ–‡ä»¶ç³»ç»Ÿ</p>
<ul>
<li>fdisk -l     æŸ¥çœ‹æœ‰å“ªäº›åˆ†åŒº,ä»¥åŠåˆ†åŒºå¤§å°ã€‚é‚£ä¹ˆå¦‚ä½•è°ƒæ•´åˆ†åŒºå¤§å°ï¼Ÿæ”¹é‚£ä¸ªé…ç½®æ–‡ä»¶ï¼Ÿ</li>
<li>df æŸ¥çœ‹ä¸‹é‚£äº›æ–‡ä»¶å¤¹æŒ‚è½½åœ¨ç‰©ç†ç¡¬ç›˜åˆ†åŒºä¸Š</li>
<li>cat /proc/cmdline    æŸ¥çœ‹å†…æ ¸å¯åŠ¨å‚æ•°</li>
<li>blkid            æŸ¥çœ‹åˆ†åŒºå¯¹åº”çš„PARTUUID</li>
</ul>
<h2 id="SONiCçš„ä¸Šå±‚åº”ç”¨"><a href="#SONiCçš„ä¸Šå±‚åº”ç”¨" class="headerlink" title="SONiCçš„ä¸Šå±‚åº”ç”¨"></a>SONiCçš„ä¸Šå±‚åº”ç”¨</h2><p>SONiCçš„æœåŠ¡è·‘åœ¨dockerä¸­ï¼Œå¦‚PMONã€syncdã€frrç­‰ã€‚å…³äºè¿™äº›æœåŠ¡æ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿå¯ä»¥å‚è§ã€ŠSONICä¸­dockerè¿è¡ŒæœåŠ¡çš„å•åˆ†æã€‹ï¼Œæºç ä¸­æ³¨æ„ä¸‹<code>docker_image_ctl.j2</code>æ–‡ä»¶ï¼Œè¿™æ˜¯dockerçš„å¯åŠ¨ç®¡ç†æ¨¡æ¿ã€‚</p>
<p>SONiCæ ¸å¿ƒçš„åŠŸèƒ½å°±æ˜¯äº¤æ¢è·¯ç”±ï¼Œæ‰€ä»¥äº¤æ¢è·¯ç”±åè®®åœ¨é‡Œé¢æ˜¯å¾ˆé‡è¦çš„ï¼Œä¸ä¼ ç»Ÿäº¤æ¢æœºç›¸æ¯”ï¼ŒSONiCä¸­çš„æœåŠ¡è¿è¡Œåœ¨dockerä¸­ï¼Œä½¿ç”¨redisé›†ä¸­å¼è¿›è¡Œæ•°æ®ç®¡ç†ï¼Œå…¶å®ƒå¹¶æ²¡æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ã€‚</p>
<p>åç»­è€ƒè™‘ä»¥vxlanä¸ºåˆ‡å…¥ç‚¹ï¼Œæ·±å…¥äº†è§£å­¦ä¹ SONiCçš„ç³»ç»Ÿæ¶æ„ï¼Œå¯¹äºvxlanï¼Œå‚è§<a href="https://rancho333.github.io/2021/02/03/vxlan%E5%AD%A6%E4%B9%A0/">vxlanå­¦ä¹ </a>ã€‚</p>
<p>å¦‚ä½•é…ç½®ç®¡ç†SONiCå‘¢ï¼Ÿä¼ ç»Ÿçš„äº¤æ¢æœºä¼šåšä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼ŒæŒ‡å®šç”¨æˆ·ç™»å½•åæ‰§è¡Œè¯¥ç¨‹åºï¼Œå¯ä»¥ç§°ä¹‹ä¸ºCLIï¼Œåœ¨é‡Œé¢å¯ä»¥è¿›å…¥shellï¼Œä¹Ÿå¯ä»¥ä»shellé€€å›CLIã€‚ç¤¾åŒºç‰ˆSONiCç™»å½•ä¹‹åè¿è¡Œbashï¼Œç”¨pythonåšäº†ä¸€å¥—ç®€å•çš„å‘½ä»¤è¡Œï¼Œå¯ä»¥è¿›è¡Œé…ç½®ç®¡ç†ï¼Œè¿™ç©æ„è§£æé€Ÿåº¦ææ…¢ï¼Œä½¿ç”¨ä½“éªŒæå·®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä¿®æ”¹<code>config_db.json</code>ç„¶åé‡æ–°åŠ è½½æˆ–è€…ç›´æ¥ä½¿ç”¨<code>redis</code>å‘½ä»¤è¡Œè¿›è¡Œé…ç½®ã€‚å½“ç„¶SONiCæ”¯æŒSDNï¼Œå¯ä»¥é€šè¿‡openflowæ–¹å¼é›†ä¸­å¼ç®¡ç†é…ç½®ã€‚é˜¿é‡Œåœ¨SONiCä¸Šé¢åšäº†ä¸€å¥—ä¼ ç»ŸCLIï¼Œç§°ä¹‹ä¸º<code>lambda-cli</code>ï¼Œæ¯”ç¤¾åŒºç‰ˆSONiCçš„å‘½ä»¤è¡Œå¥½ç”¨å¤šäº†ã€‚</p>
<h2 id="TestBedè‡ªåŠ¨åŒ–æµ‹è¯•"><a href="#TestBedè‡ªåŠ¨åŒ–æµ‹è¯•" class="headerlink" title="TestBedè‡ªåŠ¨åŒ–æµ‹è¯•"></a>TestBedè‡ªåŠ¨åŒ–æµ‹è¯•</h2><p>TBD</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>å¼€æœºå¯åŠ¨WSLå¹¶SSHç™»é™†</title>
    <url>/2023/12/14/%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8WSL%E5%B9%B6SSH%E7%99%BB%E9%99%86/</url>
    <content><![CDATA[<h1 id="èƒŒæ™¯è¯´æ˜"><a href="#èƒŒæ™¯è¯´æ˜" class="headerlink" title="èƒŒæ™¯è¯´æ˜"></a>èƒŒæ™¯è¯´æ˜</h1><p>windowsçš„WSLåŠŸèƒ½è®©ubuntuä½œä¸ºwindowsçš„å­ç³»ç»Ÿï¼Œè¿™ç§åŒç³»ç»Ÿå¯¹linuxå¼€å‘éå¸¸å‹å¥½ã€‚ä¸€èˆ¬ä½¿ç”¨è¿œç¨‹å·¥å…·å¦‚Xshellç™»é™†Linuxï¼Œå¯¹windowså’ŒWSLåšä¸€äº›é…ç½®ï¼Œå®ç°å¼€å¯windowsä¹‹åï¼š</p>
<ul>
<li>è‡ªåŠ¨å¯åŠ¨WSL</li>
<li>WSLä¸­å¼€å¯sshdæœåŠ¡</li>
</ul>
<span id="more"></span>

<h1 id="å®ç°æ–¹æ³•"><a href="#å®ç°æ–¹æ³•" class="headerlink" title="å®ç°æ–¹æ³•"></a>å®ç°æ–¹æ³•</h1><ol>
<li>åˆ›å»ºå¼€æœºå¯åŠ¨è„šæœ¬ï¼Œåç§°ä¸º<code>linux-start-ssh.vbs</code>, é‡Œé¢çš„å†…å®¹ä¸ºï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Set ws &#x3D; WScript.CreateObject(&quot;WScript.Shell&quot;)        &#39; åˆ›å»ºwindows shellå¯¹è±¡</span><br><span class="line">ws.run &quot;wsl -d ubuntu -u root &#x2F;etc&#x2F;init.wsl&quot;          &#39; åœ¨shellä¸­å¯åŠ¨wslï¼Œwslå¯åŠ¨åŠ è½½ init.wslè„šæœ¬</span><br></pre></td></tr></table></figure></li>
</ol>
<p><code>init.wsl</code>è„šæœ¬çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#! &#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;ssh start           # åœ¨wslä¸­å¯åŠ¨sshdæœåŠ¡ï¼Œè¿™æ ·wslå¯åŠ¨æ—¶å°±ä¼šè‡ªåŠ¨å¼€æœºsshd</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>å°†<code>linux-start-ssh.vbs</code>è„šæœ¬åŠ å…¥åˆ°å¼€æœºå¯åŠ¨é¡¹ä¸­ï¼Œç›´æ¥å°†è¯¥æ–‡ä»¶æ‹·è´åˆ°<code>C:\Users\Rancho\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code>è·¯å¾„ä¸‹å³å¯</p>
</li>
<li><p>åœ¨task managerä¸­ç¡®è®¤enableæœåŠ¡ï¼Œè®¾ç½®å¥½åçŠ¶æ€å¦‚ä¸‹å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/wsl_init_script.png"></p>
</li>
</ol>
<p>windowså¯åŠ¨åè‡ªåŠ¨è¿è¡Œ<code>linux-start-ssh.vbs</code>, wslå¯åŠ¨åè‡ªåŠ¨è¿è¡Œ<code>init.wsl</code>.</p>
<ol start="4">
<li>ä½¿ç”¨<code>ssh rancho@localhost</code>å³å¯åœ¨windowsä¸Šsshç™»é™†wsl</li>
</ol>
]]></content>
      <tags>
        <tag>WSL</tag>
      </tags>
  </entry>
  <entry>
    <title>æ ‘è“æ´¾åšä¸²å£æœåŠ¡å™¨</title>
    <url>/2021/02/02/%E6%A0%91%E8%8E%93%E6%B4%BE%E5%81%9A%E4%B8%B2%E5%8F%A3%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>äº¤æ¢æœºè®¾å¤‡æ”¾åœ¨å®éªŒå®¤ä¸­ï¼Œéƒ¨åˆ†ä½ç½®åªæœ‰ç½‘å£è€Œæ²¡æœ‰ä¸²å£æœåŠ¡å™¨ï¼Œç”¨PCåšä¸²å£æœåŠ¡å™¨å¤ªæµªè´¹ï¼Œä¸‹é¢ä»‹ç»ç”¨æ ‘è“æ´¾åšä¸²å£æœåŠ¡å™¨ã€‚</p>
<span id="more"></span>
<h1 id="æ‹“æ‰‘è¯´æ˜"><a href="#æ‹“æ‰‘è¯´æ˜" class="headerlink" title="æ‹“æ‰‘è¯´æ˜"></a>æ‹“æ‰‘è¯´æ˜</h1><p>é€šè¿‡SShè¿œç¨‹åˆ°æ ‘è“æ´¾ä¸Šï¼Œæ ‘è“æ´¾é€šè¿‡USBè½¬ä¸²å£ä¸äº¤æ¢æœºä¸²å£ç›¸è¿ã€‚Linuxä¸Šé€šè¿‡minicomè¿æ¥ä¸²å£ã€‚</p>
<h1 id="Linuxç¯å¢ƒå‡†å¤‡"><a href="#Linuxç¯å¢ƒå‡†å¤‡" class="headerlink" title="Linuxç¯å¢ƒå‡†å¤‡"></a>Linuxç¯å¢ƒå‡†å¤‡</h1><h2 id="minicomå®‰è£…"><a href="#minicomå®‰è£…" class="headerlink" title="minicomå®‰è£…"></a>minicomå®‰è£…</h2><p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…minicomã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt install  lrzsz</span><br><span class="line">apt install minicom</span><br></pre></td></tr></table></figure>

<h2 id="ä¸²å£å‚æ•°è®¾ç½®"><a href="#ä¸²å£å‚æ•°è®¾ç½®" class="headerlink" title="ä¸²å£å‚æ•°è®¾ç½®"></a>ä¸²å£å‚æ•°è®¾ç½®</h2><p><code>minicom -s</code>è¿›è¡Œå‚æ•°è®¾ç½®ã€‚<br><img src="https://rancho333.github.io/pictures/minicom_s.png"></p>
<p>æŒ‰å¦‚ä¸‹å‚æ•°è¿›è¡Œè®¾ç½®.<br><img src="https://rancho333.github.io/pictures/serial_port.png"><br>å¯ä»¥åœ¨æ’æ‹”usbè½¬ä¸²å£çº¿åœ¨<code>/dev</code>æŸ¥çœ‹ä¸²å£è®¾å¤‡ã€‚æ³¢ç‰¹ç‡ä»¥è®¾å¤‡æ³¢ç‰¹ç‡ä¸ºå‡†ã€‚</p>
<p>è®¾ç½®å®Œæˆåè®°å¾—ä¿å­˜è®¾ç½®ã€‚</p>
<h2 id="è®¾å¤‡ç™»å½•"><a href="#è®¾å¤‡ç™»å½•" class="headerlink" title="è®¾å¤‡ç™»å½•"></a>è®¾å¤‡ç™»å½•</h2><p>åœ¨shellä¸‹è¾“å…¥<code>minicom</code>å³å¯ç™»å½•è®¾å¤‡ã€‚<br>minicomçš„æ§åˆ¶å‘½ä»¤ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl-A x        é€€å‡ºminicom</span><br><span class="line">Ctrl-A z        æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©ä¿¡æ¯</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>è·¯ç”±æ ‡è®°</title>
    <url>/2022/07/12/%E8%B7%AF%E7%94%B1%E6%A0%87%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>è·¯ç”±æ ‡è®°å…¶å®å°±æ˜¯è·¯ç”±çš„ä¸€ä¸ªå±æ€§ã€‚æœ‰äº†tagå±æ€§ï¼Œå¯ä»¥å¯¹å…·æœ‰ç›¸åŒtagå±æ€§çš„ä¸€ç»„è·¯ç”±è¿›è¡Œæ“ä½œ(è¿‡æ»¤ã€ä¿®æ”¹è·¯ç”±ç±»å‹ï¼Œä¿®æ”¹metricå€¼ç­‰)ã€‚BGPä¸­æœ‰ä¸ªéå¸¸ç±»ä¼¼çš„å±æ€§ï¼šcommunityå±æ€§ã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹å†…éƒ¨è·¯ç”±ä¸æ‰“æ ‡è®°ï¼Œå¤–éƒ¨è·¯ç”±æ‰“æ ‡è®°ã€‚</p>
<span id="more"></span>

<h2 id="ospfæ‰“æ ‡è®°"><a href="#ospfæ‰“æ ‡è®°" class="headerlink" title="ospfæ‰“æ ‡è®°"></a>ospfæ‰“æ ‡è®°</h2><p>ospfå°†å¤–éƒ¨è·¯ç”±é‡åˆ†å¸ƒè¿›ospfæ—¶æ”¯æŒç›´æ¥æ‰“æ ‡æœºï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨è·¯ç”±ç­–ç•¥route-mapï¼‰ã€‚æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/routing_tag.png"><br>R1,R2çš„eth0ä¸Šè¿è¡Œospfï¼ŒR2ä¸Šåˆ›å»ºlp0æ¥å£ï¼Œå°†lp0é‡åˆ†å¸ƒåˆ°ospfä¸­ï¼Œå¹¶æ‰“ä¸Šæ ‡è®°ï¼Œä½¿R1å­¦åˆ°ã€‚é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.1 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">ï¼</span><br><span class="line">router ospf 110</span><br><span class="line"></span><br><span class="line">R2</span><br><span class="line">!</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.12 255.255.255.0</span><br><span class="line"> ip ospf 110 area 0</span><br><span class="line">!</span><br><span class="line">router ospf 110</span><br><span class="line"> redistribute connected subnets tag 12                  &#x2F;&#x2F; é‡åˆ†å¸ƒç›´è¿è·¯ç”±è¿›ospfï¼Œå¹¶æ‰“ä¸Štagï¼š12</span><br></pre></td></tr></table></figure>
<p>åœ¨R1ä¸ŠæŸ¥çœ‹2.2.2.2çš„ospf databaseä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip ospf database                  </span><br><span class="line">		Type-5 AS External Link States</span><br><span class="line"></span><br><span class="line">Link ID         ADV Router      Age         Seq#       Checksum Tag</span><br><span class="line">2.2.2.2         12.1.1.12       609         0x80000002 0x009ED2 12</span><br></pre></td></tr></table></figure>
<p>å‘ç°å·²ç»æ‰“ä¸Štagï¼š12çš„æ ‡è®°ã€‚ä¹‹åå°±å¯ä»¥åˆ›å»ºroute-mapï¼Œmatchè¿™ä¸ªtagï¼Œä¹‹åå°±å¯ä»¥setå„ç§æ“ä½œã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡<code>route-map</code>æ¥æ‰“tag.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R2(config)#route-map tag permit 10           &#x2F;&#x2F; åˆ›å»ºä¸€ä¸ªroute-mapï¼Œåå­—å«tag</span><br><span class="line">R2(config-route-map)#set tag 20              &#x2F;&#x2F; åŠ¨ä½œæ—¶è®¾ç½®tag20</span><br><span class="line">R2(config-router)#redistribute connected route-map tag          &#x2F;&#x2F; é‡åˆ†å¸ƒæ—¶ä½¿èƒ½è¯¥route-map</span><br></pre></td></tr></table></figure>
<p>åœ¨R1ä¸ŠæŸ¥çœ‹ospfçš„databaseä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip ospf database </span><br><span class="line">		Type-5 AS External Link States</span><br><span class="line"></span><br><span class="line">Link ID         ADV Router      Age         Seq#       Checksum Tag</span><br><span class="line">2.2.2.2         12.1.1.12       4           0x80000001 0x003139 20</span><br></pre></td></tr></table></figure>
<p>ospfå’Œeigrpéƒ½æ”¯æŒtagï¼Œä¸¤è€…åœ¨é‡åˆ†å¸ƒæ—¶ä¼šæºå¸¦tagåˆ°å¯¹æ–¹çš„è·¯ç”±åŸŸã€‚</p>
<h2 id="eigrpæ‰“æ ‡è®°"><a href="#eigrpæ‰“æ ‡è®°" class="headerlink" title="eigrpæ‰“æ ‡è®°"></a>eigrpæ‰“æ ‡è®°</h2><p>eigrpä¸­ä¸èƒ½ç›´æ¥æ‰“tagï¼Œåªèƒ½é€šè¿‡route-mapæ–¹å¼æ‰“æ ‡è®°ã€‚å‘½ä»¤å’Œospfä¸€æ ·ã€‚eigrpä¸ŠæŸ¥çœ‹æ ‡è®°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip eigrp topology </span><br><span class="line">P 2.2.2.2&#x2F;32, 1 successors, FD is 409600, tag is 20         &#x2F;&#x2F; tagæ˜¯ä¸Šé¢route-mapå®šä¹‰çš„</span><br><span class="line">        via 12.1.1.12 (409600&#x2F;128256), Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>

<p>eigrpåœ¨å‘½åæ¨¡å¼ä¸‹å¯ä»¥ç»™å†…éƒ¨è·¯ç”±æ‰“æ ‡è®°ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R2(config-router)#eigrp upgrade-cli rancho              &#x2F;&#x2F; å¯ä»¥ç›´æ¥ä»ç»å…¸æ¨¡å¼å‡çº§åˆ°å‘½åæ¨¡å¼ï¼Œå¥½å¤„æ˜¯é‚»å±…çŠ¶æ€ä¸ä¼šå‘ç”Ÿå˜åŒ–</span><br><span class="line">R2(config-router)#address-family ipv4 autonomous-system 90</span><br><span class="line">R2(config-router-af)#eigrp default-route-tag 45</span><br><span class="line"></span><br><span class="line">R2(config-router-af)#eigrp default-route-tag 10.10.10.10        &#x2F;&#x2F; å¦‚æœæ˜¯ä½¿ç”¨ç‚¹åˆ†åè¿›åˆ¶æ‰“tagï¼Œé‚£ä¹ˆå¯¹ç«¯æ˜¾ç¤ºçš„æ˜¯åè¿›åˆ¶æ•°å­—</span><br><span class="line">R1(config)#route-tag notation dotted-decimal                    &#x2F;&#x2F; éœ€è¦ä¿®æ”¹route tagçš„æ˜¾ç¤ºæ–¹å¼</span><br></pre></td></tr></table></figure>

<h2 id="tagç»“åˆdistribute-listè¿‡æ»¤è·¯ç”±"><a href="#tagç»“åˆdistribute-listè¿‡æ»¤è·¯ç”±" class="headerlink" title="tagç»“åˆdistribute-listè¿‡æ»¤è·¯ç”±"></a>tagç»“åˆdistribute-listè¿‡æ»¤è·¯ç”±</h2><p>åœ¨R1ä¸Šåˆ›å»ºroute-mapï¼ŒåŒ¹é…R2ä¸Šæ‰“çš„tagï¼Œåˆ†å‘åˆ—è¡¨ä¸­è°ƒç”¨è¯¥route-map</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1(config)#route-map deny-tag deny 10           &#x2F;&#x2F; åˆ›å»ºroute-map</span><br><span class="line">R1(config-route-map)#match tag 20               &#x2F;&#x2F; åŒ¹é…tag 20</span><br><span class="line">R1(config)#router eigrp 90</span><br><span class="line">R1(config-router)#distribute-list route-map deny-tag in     &#x2F;&#x2F;ä½¿èƒ½åˆ†å‘åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">R1(config)#route-map deny-tag permit 20         &#x2F;&#x2F; åˆ›å»ºdeny-tagçš„permitè¯­å¥ï¼Œå¦åˆ™åˆ†å‘åˆ—è¡¨ä¼šéšå¼è¿‡æ»¤æ‰€æœ‰è·¯ç”±</span><br><span class="line"></span><br><span class="line">R2(config)#interface loopback 1</span><br><span class="line">R2(config-if)#ip address 3.3.3.3 255.255.255.255</span><br><span class="line">R2(config)#router eigrp 90</span><br><span class="line">R2(config-router)#network 3.3.3.3</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹R1ä¸Šè·¯ç”±è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show ip route          </span><br><span class="line">      3.0.0.0&#x2F;32 is subnetted, 1 subnets</span><br><span class="line">D        3.3.3.3 [90&#x2F;409600] via 12.1.1.12, 00:00:06, Ethernet0&#x2F;0</span><br><span class="line">      12.0.0.0&#x2F;8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        12.1.1.0&#x2F;24 is directly connected, Ethernet0&#x2F;0</span><br><span class="line">L        12.1.1.1&#x2F;32 is directly connected, Ethernet0&#x2F;0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>2.2.2.2</code>çš„è·¯ç”±å·²ç»è¢«è¿‡æ»¤äº†ï¼Œæ²¡æœ‰è·¯ç”±tagçš„3.3.3.3å¯ä»¥æ­£å¸¸çœ‹åˆ°ã€‚</p>
<h2 id="ripæ‰“tag"><a href="#ripæ‰“tag" class="headerlink" title="ripæ‰“tag"></a>ripæ‰“tag</h2><p>ripåªèƒ½åœ¨version2ä¸Šæ‰“æ ‡è®°ï¼Œæ–¹æ³•å’Œeigrpç›¸åŒã€‚</p>
]]></content>
      <tags>
        <tag>routing</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¡ç®—æœºå­˜å‚¨ä½“ç³»</title>
    <url>/2020/03/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%98%E5%82%A8%E4%BD%93%E7%B3%BB/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨æ²¡æœ‰æ¥è§¦è¿‡åµŒå…¥å¼ä¹‹å‰ï¼Œå¯¹äºè®¡ç®—æœºå­˜å‚¨çš„è®¤çŸ¥ä»…é™äºçŸ¥é“ç¡¬ç›˜å’Œå†…å­˜ï¼Œç„¶åç¡¬ç›˜æ‰ç”µå¯ä»¥ä¿å­˜æ•°æ®ï¼Œå†…å­˜æ‰ç”µä¸¢å¤±æ•°æ®ã€‚åæ¥é€æ¸å¬åˆ°æ›´å¤šçš„ä¸“ä¸šåè¯ï¼Œä»€ä¹ˆROMï¼ŒRAMï¼ŒSRAMï¼ŒDRAMï¼ŒFLASH,ï¼ŒNandFlashï¼ŒNorFlashç­‰ç­‰äº†ã€‚ä»¥å‰å°†è‡ªå·±çš„å®šä½æ€»æ˜¯å±€é™åœ¨åè®®å·¥ç¨‹å¸ˆï¼Œå¯¹äºå’Œç¡¬ä»¶å’Œé©±åŠ¨ç›¸å…³çš„ä¸œè¥¿æœ‰äº›æŠµè§¦ï¼Œéšç€å·¥ä½œçš„æ·±å…¥ï¼Œä¹Ÿæ—¶å¸¸ä¼šç”¨åˆ°ä¸€äº›I2C,gpioä¹‹ç±»çš„ä¸œä¸œã€‚æœ¬ç€æ²‰ä¸‹æ¥ï¼Œå½’é›¶ï¼Œå†å‡ºå‘çš„å¿ƒæ€ï¼Œè¿™ç¯‡æ–‡ç« ç”¨æ¥æ¢³ç†ä¸€ä¸‹è‡ªå·±å¯¹äºè®¡ç®—æœºå­˜å‚¨ä½“ç³»çš„è®¤çŸ¥ã€‚</p>
<span id="more"></span>

<h1 id="æ€»ä½“æ¶æ„"><a href="#æ€»ä½“æ¶æ„" class="headerlink" title="æ€»ä½“æ¶æ„"></a>æ€»ä½“æ¶æ„</h1><p>ä¸‹é¢è¿™å¼ å›¾å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰äº†<br><img src="https://rancho333.github.io/pictures/storage.png"><br>ç”Ÿæ´»ä¸­çš„å¤§éƒ¨åˆ†ç‰©å“ï¼ŒåŸºæœ¬éƒ½æ»¡è¶³â€œå¥½çš„ä¸ä¸€å®šæ˜¯æœ€è´µçš„ï¼Œä½†æ˜¯æœ€è´µçš„ä¸€å®šæ˜¯å¥½çš„â€ï¼Œåœ¨è®¡ç®—æœºå­˜å‚¨ä½“ç³»ä¸­ï¼ŒåŸºæœ¬æ»¡è¶³äº†ä¸Šé¢è¿™å¥è¯ã€‚å¡”å°–ä¸Šçš„é‚£ä¸€å°æ’®æ˜¯æœ€è´µçš„ï¼Œæœ€å¿«çš„ï¼Œå­˜å‚¨ç©ºé—´æœ€å°çš„ã€‚åœ¨å®é™…ç”Ÿäº§ä¸­éœ€è¦åšåˆ°ä»·æ ¼ä¸æ€§èƒ½ï¼ˆæˆ–è€…è¯´å®é™…éœ€æ±‚ï¼‰çš„å¹³è¡¡ã€‚ä¸‹é¢ä»ä¸Šåˆ°ä¸‹æ¢³ç†ä¸€ä¸‹å§ã€‚</p>
<h2 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h2><p>æ©ï¼Œä¹‹å‰è½¯è€ƒã€Šç½‘ç»œå·¥ç¨‹å¸ˆã€‹çš„æ—¶å€™æ¥è§¦è¿‡ä¸€ç‚¹ç‚¹.å“¦ï¼Œæ–‡ç« æœ‰ç‚¹è·‘é¢˜äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æƒ³è®°å½•ä¸€ä¸‹ã€‚CPUæ‰§è¡ŒæŒ‡ä»¤åˆ†ä¸ºï¼šå–æŒ‡ä»¤ï¼Œåˆ†ææŒ‡ä»¤ï¼Œæ‰§è¡ŒæŒ‡ä»¤ä¸‰éƒ¨æ›²ï¼Œè¿™é‡Œé¢ä¼šç”¨åˆ°ä¸€ç³»åˆ—çš„å¯„å­˜å™¨ï¼Œæœ‰åˆ†åˆ«å±äºæ§åˆ¶å™¨å’Œè¿ç®—å™¨ï¼Œåˆ—ä¸¾å‡ ä¸ªå¸¸è§çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ§åˆ¶å™¨</span><br><span class="line">    ç¨‹åºè®¡æ•°å™¨PCï¼šå­˜æ”¾ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</span><br><span class="line">    æŒ‡ä»¤å¯„å­˜å™¨IR:å­˜æ”¾æ­£åœ¨è¿è¡Œçš„æŒ‡ä»¤</span><br></pre></td></tr></table></figure>
<p>æŒ‡ä»¤åŒ…æ‹¬æ“ä½œç å’Œåœ°å€ç ï¼ˆæ“ä½œæ•°æ‰€åœ¨çš„åœ°å€ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿ç®—å™¨ï¼š</span><br><span class="line">    ç´¯åŠ å¯„å­˜å™¨AC</span><br><span class="line">    æ•°æ®ç¼“å†²å¯„å­˜å™¨</span><br><span class="line">    çŠ¶æ€æ¡ä»¶å¯„å­˜å™¨</span><br></pre></td></tr></table></figure>
<p>å…·ä½“è§ä¸‹å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/register.png"><br>å¯„å­˜å™¨æ˜¯CPUçš„å†…éƒ¨ç»„æˆå•å…ƒï¼Œæ˜¯CPUè¿ç®—æ˜¯å–æŒ‡ä»¤å’Œæ•°æ®æœ€å¿«çš„åœ°æ–¹ã€‚å½“ç„¶ä¸ä»…ä»…æ˜¯CPUäº†ï¼Œæ¯”å¦‚äº¤æ¢èŠ¯ç‰‡åŠå¾ˆå¤šå…¶å®ƒçš„ASICéƒ½æ˜¯ç”¨å¯„å­˜å™¨æ¥å®ç°æŸäº›åŠŸèƒ½çš„ï¼Œä½ ä¼šå‘ç°èŠ¯ç‰‡SDKæä¾›çš„APIæœ€åº•å±‚å°±æ˜¯è¯»å†™æŸäº›å¯„å­˜å™¨æ¥å®ç°å…·ä½“åŠŸèƒ½ã€‚</p>
<h2 id="cacheä¸ä¸»å­˜"><a href="#cacheä¸ä¸»å­˜" class="headerlink" title="cacheä¸ä¸»å­˜"></a>cacheä¸ä¸»å­˜</h2><p>cacheä¸ä¸»å­˜éƒ½æ˜¯RAMï¼ˆRandom-Access Memory, éšæœºè®¿é—®å­˜å‚¨å™¨ï¼‰ï¼Œcacheä½¿ç”¨çš„æ˜¯é™æ€SRAMï¼Œä¸»å­˜ä½¿ç”¨çš„æ˜¯DRAMã€‚è¿™ä¸¤ç§å™¨ä»¶æ‰ç”µæ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚</p>
<p>SRAMåªè¦å­˜å‚¨å™¨ä¿æŒé€šç”µï¼Œé‡Œé¢å­˜å‚¨çš„æ•°æ®å°±å¯ä»¥ä¿æŒä¸å˜ã€‚<br>DRAMéœ€è¦å‘¨æœŸæ€§çš„å……ç”µåˆ·æ–°ï¼Œä¸»å­˜ä¹Ÿå°±æ˜¯æˆ‘ä»¬PCä¸­çš„å†…å­˜æ¡äº†ã€‚</p>
<h2 id="ROMä¸flash"><a href="#ROMä¸flash" class="headerlink" title="ROMä¸flash"></a>ROMä¸flash</h2><p>ä»¥å‰ä¸€ç›´çº³é—·ä¸ºå•¥åªè¯»å­˜å‚¨è¿˜èƒ½æ”¹é‡Œé¢çš„æ•°æ®ã€‚<br>ROMä¸€èˆ¬ç”¨æ¥å­˜æ”¾bootloader(ä¸€èˆ¬å«åšå›ºä»¶ï¼Œfirmware)ï¼Œè¿™é‡Œé¢çš„å†…å®¹åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æ˜¯æ— æ³•æ›´æ”¹çš„ï¼Œæ‰ç”µæ•°æ®ä¾ç„¶å­˜åœ¨ã€‚<br>æ—©æœŸROMåœ¨å·¥å‚é‡Œç”¨ç‰¹æ®Šæ–¹æ³•çƒ§å½•è¿›å»ï¼Œä¸€æ—¦çƒ§å½•è¿›å»ï¼Œç”¨æˆ·åªèƒ½éªŒè¯å†™å…¥çš„èµ„æ–™æ˜¯å¦æ­£ç¡®ï¼Œä¸èƒ½å†åšä»»ä½•ä¿®æ”¹ã€‚<br>åæ¥äººä»¬å‘æ˜äº†PROMï¼ˆProgrammable ROMï¼Œ å¯ç¼–ç¨‹ROMï¼‰ï¼Œå·¥å‚åˆ¶ä½œçš„PROMå†…éƒ¨æ²¡æœ‰æ•°æ®ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸“ç”¨çš„ç¼–ç¨‹æœŸé—´çƒ§å†™èµ„æ–™è¿›å»ï¼Œä½†åªèƒ½å†™ä¸€æ¬¡ï¼Œä¸€æ—¦å†™å…¥ä¹Ÿæ— æ³•ä¿®æ”¹ã€‚<br>å†åæ¥å‘æ˜äº†EPROMï¼ˆErasable Programmable ROM, å¯æ“¦å†™å¯ç¼–ç¨‹ROMï¼‰ï¼ŒèŠ¯ç‰‡å¯ä»¥é‡å¤æ“¦é™¤å’Œå†™å…¥ï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨ç´«å¤–çº¿ç…§å°„èŠ¯ç‰‡ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚<br>å†åæ¥å‘æ˜äº†EEPROMï¼ˆElectrically Erasable Programmable ROMï¼Œç”µå¯æ“¦é™¤å¯ç¼–ç¨‹ROMï¼‰,ç”¨ä¸“é—¨çš„çƒ§å½•å™¨å’Œçƒ§å½•è½¯ä»¶å°±å¯ä»¥ç›´æ¥çƒ§å½•äº†ï¼Œå¾ˆæ–¹ä¾¿ã€‚ç°åœ¨ç”¨çš„ROMå¤§éƒ¨åˆ†æ˜¯è¿™ç§ã€‚</p>
<p>è‡³äºflashï¼Œå’±ä»¬å¸¸è§çš„uç›˜ï¼Œå›ºæ€ç¡¬ç›˜ç¯éƒ½æ˜¯åŸºäºflashä¸­çš„NandFlashã€‚flashåˆ†ä¸ºNorFlashå’ŒNandFlashä¸¤ç§ç±»å‹ã€‚<br>Norçš„è¯»å–é€Ÿåº¦æ¯”Nandå¿«ä¸€äº›ï¼ŒNandçš„å†™å…¥é€Ÿåº¦æ¯”Norå¿«å¾ˆå¤šï¼ŒNandçš„æˆæœ¬ä½ï¼Œå“ˆï¼Œè¿™æ˜¯å¾ˆé‡è¦çš„ã€‚<br>Nandçš„è¯»å†™æ“ä½œæ˜¯ä»¥å—ä¸ºå•ä½çš„ï¼ŒNoræ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½ã€‚<br>NorFlashä¸€èˆ¬ç”¨æ¥æ›¿ä»£ROMç”¨æ¥å­˜æ”¾BootLoaderï¼Œå®¹é‡è¾ƒå°ï¼Œæ”¯æŒèŠ¯ç‰‡å†…æ‰§è¡Œï¼ˆXIP, eXecute In Placeï¼‰ï¼ŒNandå°±æ˜¯ç”¨æ¥åšå¤§å®¹é‡æ•°æ®å­˜å‚¨çš„å•¦ï¼</p>
<p>é¡ºå¸¦æä¸€ä¸‹eMMCï¼Œè¿™ç©æ„æ²¡è§è¿‡ã€‚eMMCç›¸å½“äºNandFlash+ä¸»æ§IC ï¼Œå¯¹å¤–çš„æ¥å£åè®®ä¸SDã€TFå¡ä¸€æ ·ï¼Œä¸»è¦æ˜¯é’ˆå¯¹æ‰‹æœºæˆ–å¹³æ¿ç”µè„‘ç­‰äº§å“çš„å†…åµŒå¼å­˜å‚¨å™¨æ ‡å‡†è§„æ ¼ã€‚eMMCçš„ä¸€ä¸ªæ˜æ˜¾ä¼˜åŠ¿æ˜¯åœ¨å°è£…ä¸­é›†æˆäº†ä¸€ä¸ªæ§åˆ¶å™¨ã€‚eMMCç”±ä¸€ä¸ªåµŒå…¥å¼å­˜å‚¨è§£å†³æ–¹æ¡ˆç»„æˆï¼Œå¸¦æœ‰MMCï¼ˆå¤šåª’ä½“å¡ï¼‰æ¥å£ã€å¿«é—ªå­˜å‚¨å™¨è®¾å¤‡ï¼ˆNand Flashï¼‰åŠä¸»æ§åˆ¶å™¨ï¼Œæ‰€æœ‰éƒ½åœ¨ä¸€ä¸ªå°å‹çš„BGA å°è£…ã€‚</p>
<h1 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h1><p>å…¶å®å°±æ˜¯RAMçš„åˆ†ç±»ï¼ŒROMçš„åˆ†ç±»ï¼Œä»¥åŠFlashçš„åˆ†ç±»æœ‰ç‚¹è¿·ï¼ææ¸…æ¥šç‰¹æ€§ï¼Œå¯¹åº”ä¸Šç”¨é€”ï¼</p>
<p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://blog.csdn.net/iva_brother/article/details/80463578">è®¡ç®—æœºå­˜å‚¨å™¨ç»“æ„ä½“ç³»è¯¦è§£</a><br><a href="https://baijiahao.baidu.com/s?id=1610041455262486965&wfr=spider&for=pc">NorFlashã€NandFlashã€eMMCé—ªå­˜çš„æ¯”è¾ƒä¸åŒºåˆ«</a><br><a href="https://blog.csdn.net/qq_38880380/article/details/78884522">NAND flashå’ŒNOR flashçš„åŒºåˆ«è¯¦è§£</a></p>
]]></content>
      <tags>
        <tag>å­˜å‚¨</tag>
        <tag>flash</tag>
      </tags>
  </entry>
  <entry>
    <title>é€šè¿‡Hexoä¸Github.ioæ­å»ºä¸ªäººåšå®¢</title>
    <url>/2019/07/14/%E9%80%9A%E8%BF%87Hexo%E4%B8%8EGithub-io%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä¿¡å¥‰å¥½è®°æ€§ä¸å¦‚è®°ä¸‹æ¥ï¼Œä¸Šå­¦æ—¶åœ¨ç¬”è®°æœ¬ä¸Šè®°ç¬”è®°ï¼Œåæ¥åœ¨csdnä¸Šå†™ç‚¹ä¸œè¥¿(æœ‰å¹¿å‘Šï¼Œä¸èˆ’æœ)ï¼Œåæ¥ç¬”è®°éƒ½è®°åœ¨æœ‰é“äº‘ç¬”è®°ä¸Šã€‚æœ€åå‘ç°åˆ©ç”¨github.ioå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ­å»ºä¸ªäººåšå®¢ã€‚ä¸‹é¢è®°å½•çš„æ˜¯Blogæ­å»ºçš„è¿‡ç¨‹(å®Œæˆblogçš„ä¸Šä¼ )ä»¥åŠæºç çš„å¤‡ä»½ï¼Œåé¢çš„æ–‡ç« è®°å½•ä¸€äº›ä¼˜åŒ–ä¸ä½¿ç”¨æŠ€å·§ã€‚</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Githubè´¦å·</span><br><span class="line">LinuxæœåŠ¡å™¨</span><br><span class="line">  git</span><br><span class="line">  node.js(6.9ç‰ˆæœ¬ä»¥ä¸Š)</span><br></pre></td></tr></table></figure>
<p>Githubè´¦å·çš„æ³¨å†Œåœ¨è¿™é‡Œä¸åšèµ˜è¿°ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåä¸ºyourname.github.ioçš„ä»“åº“ï¼ˆä»“åº“åæ ¼å¼ä¸€å®šè¦ç¬¦åˆï¼‰ã€‚æˆ‘ç”¨çš„Linuxæ˜¯ubuntu16.04 serverç‰ˆ(å®¶ç”¨)ä¸ubuntu18.04(awsäº‘æœåŠ¡å™¨,ä¸€å¹´å…è´¹ï¼Œå¯ä»¥ç”¨æ¥ç§‘å­¦ä¸Šç½‘)ã€‚hexoä¾èµ–äºgitä¸node.js<br>å®‰è£…git  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install git-core</span><br></pre></td></tr></table></figure>

<p>å®‰è£…node.js,å…·ä½“çš„node.jsä¸hexoçš„å¯¹åº”ç‰ˆæœ¬å‚è§hexoå®˜ç½‘ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯hexo3.9ï¼Œå¯¹åº”çš„node.jsç‰ˆæœ¬åº”è¯¥ä¸é«˜äº12,å¦åˆ™ä¼šæœ‰ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -sL https:&#x2F;&#x2F;deb.nodesource.com&#x2F;setup_15.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br></pre></td></tr></table></figure>

<p>ä¾èµ–ç¨‹åºå®‰è£…å®Œæˆä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨npmå®‰è£…Hexo.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<p>ä¹‹åè¿›è¡ŒHexoçš„åˆå§‹åŒ–</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo init &lt;folder&gt;</span><br><span class="line">cd &lt;folder&gt;</span><br></pre></td></tr></table></figure>
<p>å®Œæˆä¹‹åï¼ŒæŒ‡å®šæ–‡ä»¶å¤¹çš„ç›®å½•å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/hexo_tree.png"><br>è¿™é‡Œé¢ä¸åŒ…å«pbulicæ–‡ä»¶å¤¹ï¼Œä¼šåœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡<code>hexo g</code>å‘½ä»¤åç”Ÿæˆï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œ<code>hexo d</code>å‘½ä»¤åä¼šç”Ÿæˆ<code>.deploy_git</code>æ–‡ä»¶å¤¹ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹ä¸­çš„å†…å®¹æ˜¯ç›¸åŒçš„ï¼Œæ˜¯æœ€ç»ˆéƒ¨ç½²åˆ°github.ioä¸­çš„æ–‡ä»¶ã€‚<br>ç„¶åæ‰§è¡Œ<code>npm install</code>äº§ç”Ÿnode_modulesæ–‡ä»¶å¤¹ï¼Œè‡³æ­¤ï¼ŒæœåŠ¡ç«¯çš„åŸºæœ¬åˆå§‹åŒ–å®Œæˆã€‚<br>ä¿®æ”¹<code>_config.yml</code>é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git </span><br><span class="line">  repository: git@github.com:yourname&#x2F;yourname.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>
<p>éƒ¨ç½²åˆ°github.ioå³å®Œæˆï¼Œæ‰§è¡Œ<code>hexo g -d</code>ã€‚è¿™æ—¶å€™è®¿é—®ï¼š<code>https://yourname.github.io/</code>å³å¯è®¿é—®Blogã€‚  </p>
<h2 id="Hexoå¸¸ç”¨å‘½ä»¤"><a href="#Hexoå¸¸ç”¨å‘½ä»¤" class="headerlink" title="Hexoå¸¸ç”¨å‘½ä»¤"></a>Hexoå¸¸ç”¨å‘½ä»¤</h2><table>
<thead>
<tr>
<th align="center">command</th>
<th align="center">description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">hexo init [folder]</td>
<td align="center">æ–°å»ºä¸€ä¸ªç½‘ç«™</td>
</tr>
<tr>
<td align="center">hexo new <code>&lt;title&gt;</code></td>
<td align="center">æ–°å»ºæ–‡ç« ï¼Œå¦‚æ ‡é¢˜åŒ…å«ç©ºæ ¼ç”¨å¼•å·æ‹¬èµ·æ¥</td>
</tr>
<tr>
<td align="center">hexo generate</td>
<td align="center">ç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œç®€å†™hexo g</td>
</tr>
<tr>
<td align="center">hexo deploy</td>
<td align="center">éƒ¨ç½²ç½‘ç«™ï¼Œç®€å†™hexo d</td>
</tr>
<tr>
<td align="center">hexo clean</td>
<td align="center">æ¸…é™¤ç¼“å­˜æ–‡ä»¶</td>
</tr>
<tr>
<td align="center">hexo version</td>
<td align="center">æŸ¥çœ‹Hexoç‰ˆæœ¬</td>
</tr>
<tr>
<td align="center">hexo â€“config custom.yml</td>
<td align="center">è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œæ‰§è¡Œåä¸å†ä½¿ç”¨_config.yml</td>
</tr>
</tbody></table>
<p>æ³¨æ„ï¼Œæ¯ä¸ªä¸»é¢˜ä¸‹é¢ä¹Ÿæœ‰ä¸€ä¸ª_config.ymlæ–‡ä»¶(ä½œç”¨åŸŸæ˜¯è¯¥ä¸»é¢˜)ï¼Œä¸»ç›®å½•ä¸‹çš„æ˜¯å…¨å±€é…ç½®(ä½œç”¨åŸŸæ˜¯æ•´ä¸ªç½‘ç«™)ã€‚  </p>
<h2 id="æºç å¤‡ä»½"><a href="#æºç å¤‡ä»½" class="headerlink" title="æºç å¤‡ä»½"></a>æºç å¤‡ä»½</h2><p>hexo dåªæ˜¯å°†ç”Ÿæˆçš„é™æ€ç½‘é¡µéƒ¨ç½²åˆ°github.ioä¸Šï¼Œè¿™æ ·å­˜æ”¾æºç çš„æœåŠ¡å™¨åˆ°æœŸæˆ–è€…å¤šå°PCå¼€å‘æ—¶ä¾¿ä¼šäº§ç”Ÿä¸ä¾¿ï¼Œä¸‹é¢è¯´æ˜å°†æºç éƒ¨ç½²åˆ°github.ioä¸Šã€‚<br>åˆ›å»ºREADME.mdæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;# shiningdan.github.io&quot; &gt;&gt; README.md</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–gitä»“åº“(åœ¨hexo init folderçš„folderç›®å½•ä¸‹æ‰§è¡Œ)ï¼Œhexo dæ“ä½œçš„ä»“åº“æ˜¯.deployer_git.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git init </span><br><span class="line">git add README.md </span><br><span class="line">git commit -m &quot;first commit&quot;</span><br></pre></td></tr></table></figure>
<p>å’Œgithub.ioå»ºç«‹æ˜ å°„<br><code>git remote add origin https://github.com/yourname/yourname.github.io.git </code><br>masteråˆ†æ”¯ä½œä¸ºdeployçš„åˆ†æ”¯ï¼Œåˆ›å»ºhexoåˆ†æ”¯ç”¨æ¥å¤‡ä»½æºç   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git branch hexo  </span><br><span class="line">git push origin hexo  </span><br><span class="line">git checkout hexo  </span><br></pre></td></tr></table></figure>
<p>å°†github.ioä¸­çš„é»˜è®¤åˆ†æ”¯ä¿®æ”¹ä¸ºhexo(è¿™æ ·ä¸‹è½½æ—¶å°±æ˜¯ä¸‹æºç )ï¼Œå› ä¸ºuser pageçš„å‘å¸ƒç‰ˆå¿…é¡»ä½äºmasteråˆ†æ”¯ä¸‹<br>åç»­å¼€å‘åœ¨hexoåˆ†æ”¯ä¸‹æ‰§è¡Œï¼Œæ‰§è¡Œ<code>hexo g -d</code>ç”Ÿæˆç½‘ç«™å¹¶éƒ¨ç½²åˆ°githubçš„masteråˆ†æ”¯ä¸Šï¼Œæ‰§è¡Œ<code>git addã€git commitã€git push origin hexo</code>æäº¤æºç   </p>
<h3 id="é‡æ–°éƒ¨ç½²"><a href="#é‡æ–°éƒ¨ç½²" class="headerlink" title="é‡æ–°éƒ¨ç½²"></a>é‡æ–°éƒ¨ç½²</h3><ol>
<li>ä¸‹è½½æºç <code>git clone https://github.com/yourname/yourname.github.io.git</code></li>
<li>å®‰è£…ä¾èµ–<code>npm install -g hexo-cliã€npm installã€npm install hexo-deployer-git</code>,æ³¨æ„ä¸éœ€è¦æ‰§è¡Œ<code>hexo init</code>  </li>
</ol>
<h2 id="é‡æ–°éƒ¨ç½²çš„é—®é¢˜"><a href="#é‡æ–°éƒ¨ç½²çš„é—®é¢˜" class="headerlink" title="é‡æ–°éƒ¨ç½²çš„é—®é¢˜"></a>é‡æ–°éƒ¨ç½²çš„é—®é¢˜</h2><p>è™½ç„¶ä¹‹å‰å°†hexoçš„æºç ä¹Ÿå¤‡ä»½åˆ°äº†è¿œç¨‹ä»“åº“ï¼Œä½†æ˜¯ä¸€æ—¦ä¸»æœºç¯å¢ƒå‘ç”Ÿæ”¹å˜ï¼Œå¾—é‡æ–°å®‰è£…å¯¹åº”çš„ä¾èµ–ï¼Œè¿™ä¹Ÿå¸¦æ¥ä¸€å®šçš„ä¸ç¨³å®šéšæ‚£ï¼Œç°åœ¨å°†å¼€å‘ç¯å¢ƒæ‰“åŒ…åˆ°dockerï¼Œå‘å¸ƒåˆ°<a href="https://hub.docker.com/repository/docker/rancho123/ubuntu">docker hub</a>ä¸­, åç»­ä¸ªäººçš„å·¥ä½œç¯å¢ƒä¼šæŒç»­é›†æˆè¿›å»ã€‚ä¸€äº›Linuxé€šç”¨é…ç½®ï¼ˆvim, bashï¼‰åˆ™å­˜æ”¾åˆ°<a href="https://github.com/Rancho333/vim_cfg">github</a>ä¸Šã€‚</p>
<p>ä¹‹å‰ä¸»é¢˜æ–‡ä»¶<code>next</code>æ˜¯ç”¨ä¸€ä¸ªå•ç‹¬repositoryæ¥è¿›è¡Œç®¡ç†ï¼Œè‡ªå·±çš„ä¿®æ”¹å¯ä»¥æäº¤ï¼Œä½†æ˜¯åˆ†æˆä¸¤ä¸ªä»“åº“ä¸æ–¹ä¾¿ã€‚æ‰€ä»¥ç°åœ¨å°†nextä¸»é¢˜æºç ä¹Ÿé›†æˆåˆ°hexoä¸­ã€‚æ‰€ä»¥ç°åœ¨å¦‚æœé‡æ–°éƒ¨ç½²blogç¯å¢ƒï¼Œéœ€è¦åš3ä»¶äº‹ï¼š</p>
<ol>
<li><code>https://github.com/Rancho333/Rancho333.github.io.git</code>ä¸‹è½½æºç (åŒ…å«hexo+theme)</li>
<li>å®‰è£…hexoä¾èµ–(è§é‡æ–°éƒ¨ç½²) ä»¥åŠ ä¸‹é¢æ’ä»¶ï¼Œå¦‚æœgenerateæŠ¥é”™ç¼ºå¤±æ’ä»¶ï¼Œå®‰è£…å³å¯<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho blog]$ npm list --depth 0</span><br><span class="line">hexo-site@0.0.0 &#x2F;home&#x2F;rancho&#x2F;workdir&#x2F;blog</span><br><span class="line">â”œâ”€â”€ eslint@7.23.0</span><br><span class="line">â”œâ”€â”€ hexo@5.4.0</span><br><span class="line">â”œâ”€â”€ hexo-deployer-git@3.0.0</span><br><span class="line">â”œâ”€â”€ hexo-generator-archive@1.0.0</span><br><span class="line">â”œâ”€â”€ hexo-generator-baidu-sitemap@0.1.9</span><br><span class="line">â”œâ”€â”€ hexo-generator-category@1.0.0</span><br><span class="line">â”œâ”€â”€ hexo-generator-feed@3.0.0</span><br><span class="line">â”œâ”€â”€ hexo-generator-index@2.0.0</span><br><span class="line">â”œâ”€â”€ hexo-generator-searchdb@1.3.3</span><br><span class="line">â”œâ”€â”€ hexo-generator-sitemap@2.1.0</span><br><span class="line">â”œâ”€â”€ hexo-generator-tag@1.0.0</span><br><span class="line">â”œâ”€â”€ hexo-helper-live2d@3.1.1</span><br><span class="line">â”œâ”€â”€ hexo-renderer-ejs@1.0.0</span><br><span class="line">â”œâ”€â”€ hexo-renderer-marked@4.0.0</span><br><span class="line">â”œâ”€â”€ hexo-renderer-stylus@2.0.1</span><br><span class="line">â”œâ”€â”€ hexo-renderer-swig@1.1.0</span><br><span class="line">â”œâ”€â”€ hexo-server@2.0.0</span><br><span class="line">â”œâ”€â”€ hexo-theme-landscape@0.0.3</span><br><span class="line">â”œâ”€â”€ hexo-wordcount@6.0.1</span><br><span class="line">â”œâ”€â”€ live2d-widget-model-shizuku@1.0.5</span><br><span class="line">â””â”€â”€ lodash@4.17.21</span><br></pre></td></tr></table></figure></li>
<li>æ£€æŸ¥ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­blogéƒ¨ç½²çš„ä½ç½®ï¼Œæ³¨æ„å°†pageå‘å¸ƒçš„åˆ†æ”¯å¿…é¡»æ˜¯master(ä»£ç é»˜è®¤åˆ†æ”¯æ˜¯hexo).</li>
</ol>
<h2 id="è‡ªåŠ¨ä¸Šä¼ æºç "><a href="#è‡ªåŠ¨ä¸Šä¼ æºç " class="headerlink" title="è‡ªåŠ¨ä¸Šä¼ æºç "></a>è‡ªåŠ¨ä¸Šä¼ æºç </h2><p>ä¹‹å‰çš„å·¥ä½œæµç¨‹æ˜¯</p>
<ol>
<li>hexo g -d    ç”Ÿæˆé™æ€ç½‘é¡µå¹¶ä¸Šä¼ </li>
<li>git add , commit, push     ä¸Šä¼ æºç <br>å¾ˆå¤šæ—¶å€™æ‰§è¡Œå®Œ1ä¹‹åå› ä¸ºè¿™æ ·é‚£æ ·çš„åŸå› æ²¡æœ‰æ‰§è¡Œ2ï¼Œå¯¼è‡´æºç æ²¡æœ‰æäº¤ã€‚ä¹‹å‰å…¬å¸æœåŠ¡å™¨æŒ‚æ‰ï¼Œå¹¶ä¸”ä¹‹å‰çš„æºç æ²¡æœ‰ä¸Šä¼ ï¼Œè¿™æ ·ä»githubæ‹‰å–çš„æºç å’Œç½‘é¡µå°±ä¸åŒæ­¥ï¼Œæºç è½åäºç½‘é¡µ</li>
</ol>
<p>ç°åœ¨ä½¿ç”¨è„šæœ¬<code>hexo_g_d.sh &quot;commit commnet&quot;</code>, é‡Œé¢ä¼šè‡ªåŠ¨ä¸Šä¼ ç½‘é¡µå’Œæºç (éœ€è¦åœ¨æœ¬åœ°è®¾ç½®githubè´¦å·å¯†ç ï¼Œä¸ç„¶ä¼šè¦æ‰‹åŠ¨è¾“å…¥)ï¼Œå‚æ•°<code>commit commnet</code>æ˜¯<code>git commit -m</code>çš„å‚æ•°</p>
<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong><br><a href="https://hexo.io/zh-cn/docs/">HEXOå®˜æ–¹æ–‡æ¡£</a></p>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>ARPåè®®ç®€è¿°åŠåº”ç”¨</title>
    <url>/2020/12/25/ARP%E5%8D%8F%E8%AE%AE%E7%AE%80%E8%BF%B0%E5%8F%8A%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>è¿™ç¯‡æ–‡ç« åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ARPåè®®ç®€ä»‹ä»¥åŠARPåè®®çš„å®é™…åº”ç”¨ã€‚</p>
<span id="more"></span>
<h1 id="ARPåè®®ç®€ä»‹"><a href="#ARPåè®®ç®€ä»‹" class="headerlink" title="ARPåè®®ç®€ä»‹"></a>ARPåè®®ç®€ä»‹</h1><h2 id="ARPçš„ä½œç”¨"><a href="#ARPçš„ä½œç”¨" class="headerlink" title="ARPçš„ä½œç”¨"></a>ARPçš„ä½œç”¨</h2><p>ARP(Address Resolution Protocolï¼Œåœ°å€è§£æåè®®)æ˜¯å°†IPåœ°å€è§£æä¸ºä»¥å¤ªç½‘MACåœ°å€çš„åè®®ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œå°†MACåœ°å€è§£æä¸ºIPåœ°å€çš„åè®®ç§°ä¸ºRARPã€‚</p>
<p>åœ¨å±€åŸŸç½‘ä¸­ï¼Œå½“ç»ˆç«¯è®¾å¤‡éœ€è¦å°†æ•°æ®å‘é€ç»™å¦ä¸€ä¸ªç»ˆç«¯è®¾å¤‡æ—¶ï¼Œå®ƒå¿…é¡»çŸ¥é“å¯¹æ–¹ç½‘ç»œçš„IPåœ°å€ã€‚ä½†æ˜¯ä»…ä»…æœ‰IPåœ°å€æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºIPæ•°æ®å¿…é¡»å°è£…æˆå¸§æ‰èƒ½é€šè¿‡ç‰©ç†ç½‘ç»œå‘é€ï¼Œå› æ­¤å‘é€ç«¯è¿˜å¿…é¡»æœ‰æ¥æ”¶ç«¯çš„MACåœ°å€ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªä»IPåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ã€‚ARPå°±æ˜¯å®ç°è¿™ä¸ªåŠŸèƒ½çš„åè®®ã€‚</p>
<h2 id="ARPæŠ¥æ–‡çš„ç»“æ„"><a href="#ARPæŠ¥æ–‡çš„ç»“æ„" class="headerlink" title="ARPæŠ¥æ–‡çš„ç»“æ„"></a>ARPæŠ¥æ–‡çš„ç»“æ„</h2><p><img src="https://rancho333.github.io/pictures/arp_protocol.png"> </p>
<p>å¯¹äºå„ä¸ªå­—æ®µçš„è§£é‡Šå¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th align="left">å­—æ®µ</th>
<th align="left">é•¿åº¦ï¼ˆbitï¼‰</th>
<th align="left">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Ethernet Address of destination</td>
<td align="left">48</td>
<td align="left">ç›®çš„ä»¥å¤ªç½‘åœ°å€ã€‚å‘é€ARPè¯·æ±‚æ—¶ï¼Œä¸ºå¹¿æ’­MACåœ°å€ï¼Œ0xFF.FF.FF.FF.FF.FF</td>
</tr>
<tr>
<td align="left">Ethernet Address of sneder</td>
<td align="left">48</td>
<td align="left">æºä»¥å¤ªç½‘åœ°å€</td>
</tr>
<tr>
<td align="left">Frame Type</td>
<td align="left">16</td>
<td align="left">è¡¨ç¤ºæŠ¥æ–‡ç±»å‹ã€‚å¯¹äºARPè¯·æ±‚æˆ–åº”ç­”ï¼Œè¯¥å­—æ®µä¸º0x0806</td>
</tr>
<tr>
<td align="left">Hardware Type</td>
<td align="left">16</td>
<td align="left">è¡¨ç¤ºç¡¬ä»¶åœ°å€çš„ç±»å‹ã€‚å¯¹äºä»¥å¤ªç½‘ï¼Œè¯¥å­—æ®µä¸º1</td>
</tr>
<tr>
<td align="left">Protocol Type</td>
<td align="left">16</td>
<td align="left">è¡¨ç¤ºå‘é€æ–¹è¦æ˜ å°„çš„åè®®åœ°å€ç±»å‹ã€‚å¯¹äºIPåœ°å€ï¼Œè¯¥å€¼ä¸º0x0800</td>
</tr>
<tr>
<td align="left">Hardware Length</td>
<td align="left">8</td>
<td align="left">è¡¨ç¤ºç¡¬ä»¶åœ°å€çš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚å¯¹äºARPè¯·æ±‚æˆ–åº”ç­”æ¥è¯´ï¼Œè¯¥å€¼ä¸º6</td>
</tr>
<tr>
<td align="left">Protocol Length</td>
<td align="left">8</td>
<td align="left">è¡¨ç¤ºåè®®åœ°å€çš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚å¯¹äºARPè¯·æ±‚æˆ–åº”ç­”æ¥è¯´ï¼Œè¯¥å€¼ä¸º4</td>
</tr>
<tr>
<td align="left">OP</td>
<td align="left">16</td>
<td align="left">è¡¨ç¤ºæ“ä½œç±»å‹ã€‚1 è¡¨ç¤ºARPè¯·æ±‚ï¼Œ2 è¡¨ç¤ºARPåº”ç­”ï¼Œ3è¡¨ç¤ºRARPè¯·æ±‚ï¼Œ4è¡¨ç¤ºRARPåº”ç­”</td>
</tr>
<tr>
<td align="left">Ethernet Address of sneder</td>
<td align="left">48</td>
<td align="left">å‘é€æ–¹ä»¥å¤ªç½‘åœ°å€ã€‚è¿™ä¸ªå­—æ®µå’ŒARPæŠ¥æ–‡é¦–éƒ¨çš„æºä»¥å¤ªç½‘åœ°å€å­—æ®µæ˜¯é‡å¤ä¿¡æ¯</td>
</tr>
<tr>
<td align="left">IP Address of sender</td>
<td align="left">32</td>
<td align="left">å‘é€æ–¹IPåœ°å€</td>
</tr>
<tr>
<td align="left">Ethernet Address of destination</td>
<td align="left">48</td>
<td align="left">æ¥æ”¶æ–¹ä»¥å¤ªç½‘åœ°å€ï¼Œå‘é€ARPè¯·æ±‚æ—¶ï¼Œè¯¥å¤„å¡«å……å…¨0</td>
</tr>
<tr>
<td align="left">IP Address of destination</td>
<td align="left">32</td>
<td align="left">æ¥æ”¶æ–¹IPåœ°å€</td>
</tr>
</tbody></table>
<p>åœ¨Linuxä¸Šå¯ä»¥é€šè¿‡tcpdumpå·¥å…·æŠ“å–ARPåŒ…</p>
<p><img src="https://rancho333.github.io/pictures/arp_data_raw.png"><br>ä½¿ç”¨wiresharkå·¥å…·å¯ä»¥æ›´ä¸ºæ–¹ä¾¿çš„æŸ¥çœ‹æŠ¥æ–‡ä¸­çš„å„ä¸ªå­—æ®µï¼š</p>
<p><img src="https://rancho333.github.io/pictures/arp_data.png"> </p>
<h2 id="ARPåœ°å€è§£æè¿‡ç¨‹"><a href="#ARPåœ°å€è§£æè¿‡ç¨‹" class="headerlink" title="ARPåœ°å€è§£æè¿‡ç¨‹"></a>ARPåœ°å€è§£æè¿‡ç¨‹</h2><p>å‡è®¾ä¸»æœºAå’ŒBåœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œä¸»æœºAè¦å‘ä¸»æœºBå‘é€ä¿¡æ¯ï¼Œè§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸»æœºAæŸ¥çœ‹è‡ªå·±çš„ARPè¡¨ï¼Œæ‰¾åˆ°åˆ™ç›´æ¥ä½¿ç”¨</li>
<li>å¦‚æœAåœ¨ARPè¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°Bï¼Œåˆ™<ul>
<li>ç¼“å­˜IPæ•°æ®æŠ¥æ–‡</li>
<li>å‘é€ARPè¯·æ±‚æŠ¥æ–‡ï¼Œè¯·æ±‚Bçš„MACåœ°å€</li>
</ul>
</li>
<li>ä¸»æœºBæ¯”è¾ƒè‡ªå·±çš„IPåœ°å€ä¸ARPè¯·æ±‚æŠ¥æ–‡ä¸­çš„IPåœ°å€ï¼Œä¸¤è€…ç›¸åŒåˆ™ï¼š<ul>
<li>å°†Açš„IPä¸MACåœ°å€ç¼“å­˜åˆ°è‡ªå·±çš„ARPè¡¨ä¸­</li>
<li>å•æ’­å‘é€ARPåº”ç­”æŠ¥æ–‡ç»™ä¸»æœºAï¼Œå…¶ä¸­åŒ…å«è‡ªå·±çš„MACåœ°å€</li>
</ul>
</li>
<li>ä¸»æœºAæ”¶åˆ°ARPå“åº”åï¼Œç¼“å­˜Bçš„MACåˆ°ARPè¡¨ä¸­ï¼Œä¹‹åå‘é€IPæ•°æ®æŠ¥æ–‡</li>
</ul>
<p>å½“ä¸»æœºAå’ŒBä¸åœ¨åŒä¸€ç½‘æ®µæ—¶ï¼Œä¸»æœºAä¼šå‘ç½‘å…³å‘é€ARPè¯·æ±‚ã€‚å¦‚æœç½‘å…³æœ‰ä¸»æœºBçš„ARPè¡¨é¡¹ï¼Œåˆ™ç›´æ¥åº”ç­”Aï¼›å¦åˆ™ç½‘å…³å¹¿æ’­ARPè¯·æ±‚ï¼Œç›®æ ‡IPåœ°å€ä¸ºä¸»æœºBçš„IPåœ°å€ï¼Œç½‘å…³æ”¶åˆ°å“åº”æŠ¥æ–‡ä¹‹åå†åº”ç­”Bã€‚</p>
<h2 id="ARPè¡¨"><a href="#ARPè¡¨" class="headerlink" title="ARPè¡¨"></a>ARPè¡¨</h2><p>ARPè¡¨åˆ†ä¸ºåŠ¨æ€ARPè¡¨å’Œé™æ€ARPè¡¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br><span class="line">10.204.113.138           ether   00:00:00:00:00:01   C                     ens160</span><br><span class="line">10.204.113.151                   (incomplete)                              ens160</span><br><span class="line">172.17.0.7               ether   02:42:ac:11:00:07   C                     docker0</span><br><span class="line">10.204.112.11            ether   00:e0:ec:47:33:1a   C                     ens160</span><br><span class="line">openbmc-develop.asia.ad  ether   00:e0:4c:06:00:95   C                     ens160</span><br><span class="line">10.204.112.44            ether   6c:b3:11:32:7f:12   C                     ens160</span><br><span class="line">172.17.0.2               ether   02:42:ac:11:00:02   C                     docker0</span><br><span class="line">sonic.asia.ad.celestica  ether   aa:ad:40:03:ba:19   C                     ens160</span><br></pre></td></tr></table></figure>

<h3 id="åŠ¨æ€ARPè¡¨"><a href="#åŠ¨æ€ARPè¡¨" class="headerlink" title="åŠ¨æ€ARPè¡¨"></a>åŠ¨æ€ARPè¡¨</h3><p>åŠ¨æ€ARPè¡¨ç”±ARPåè®®é€šè¿‡ARPæŠ¥æ–‡è‡ªåŠ¨ç”Ÿæˆä¸ç»´æŠ¤ï¼Œå¯ä»¥è¢«è€åŒ–ï¼Œå¯ä»¥è¢«æ–°çš„ARPæŠ¥æ–‡æ›´æ–°ï¼Œå¯ä»¥è¢«é™æ€ARPè¡¨é¡¹è¦†ç›–ã€‚å½“åˆ°è¾¾è€åŒ–æ—¶é—´ã€æ¥å£downæ—¶ä¼šåˆ é™¤ç›¸åº”çš„åŠ¨æ€ARPè¡¨é¡¹ã€‚</p>
<h3 id="é™æ€ARPè¡¨é¡¹"><a href="#é™æ€ARPè¡¨é¡¹" class="headerlink" title="é™æ€ARPè¡¨é¡¹"></a>é™æ€ARPè¡¨é¡¹</h3><p>é™æ€ARPè¡¨é¡¹é€šè¿‡æ‰‹å·¥é…ç½®å’Œç»´æŠ¤ï¼Œä¸ä¼šè¢«è€åŒ–ï¼Œä¸ä¼šè¢«åŠ¨æ€ARPè¡¨é¡¹è¦†ç›–ã€‚</p>
<p>é…ç½®é™æ€ARPè¡¨é¡¹å¯ä»¥å¢åŠ é€šä¿¡çš„å®‰å…¨æ€§ã€‚é™æ€ARPè¡¨é¡¹å¯ä»¥é™åˆ¶å’ŒæŒ‡å®šIPåœ°å€çš„è®¾å¤‡é€šä¿¡æ—¶ä½¿ç”¨æŒ‡å®šçš„MACåœ°å€ï¼Œæ­¤æ—¶æ”»å‡»æŠ¥æ–‡æ— æ³•ä¿®æ”¹æ­¤è¡¨é¡¹çš„IPåœ°å€å’ŒMACåœ°å€çš„æ˜ å°„å…³ç³»ï¼Œ<br>ä»è€Œä¿æŠ¤äº†æœ¬è®¾å¤‡å’ŒæŒ‡å®šè®¾å¤‡é—´çš„æ­£å¸¸é€šä¿¡ã€‚</p>
<p>é™æ€ARPè¡¨é¡¹åˆ†ä¸ºçŸ­é™æ€ARPè¡¨é¡¹å’Œé•¿é™æ€ARPè¡¨é¡¹ã€‚</p>
<ul>
<li>é•¿é™æ€ARPè¡¨é¡¹å¿…é¡»é…ç½®IPåœ°å€ã€MACåœ°å€ã€æ‰€åœ¨VLANå’Œå‡ºæ¥å£ã€‚é•¿é™æ€ARPè¡¨é¡¹å¯ç›´æ¥ç”¨äºæŠ¥æ–‡è½¬å‘ã€‚</li>
<li>çŸ­é™æ€ARPè¡¨é¡¹åªéœ€è¦é…ç½®IPåœ°å€å’ŒMACåœ°å€ã€‚<ul>
<li>å¦‚æœå‡ºæ¥å£æ˜¯ä¸‰å±‚å£ï¼Œç›´æ¥ç”¨äºæŠ¥æ–‡è½¬å‘</li>
<li>å¦‚æœå‡ºæ¥å£æ˜¯VLANè™šæ¥å£ï¼ŒçŸ­é™æ€ARPè¡¨é¡¹ä¸èƒ½ç›´æ¥ç”¨äºæŠ¥æ–‡è½¬å‘ï¼Œå½“è¦å‘é€IPæ•°æ®åŒ…æ—¶ï¼Œå…ˆå‘é€ARPè¯·æ±‚æŠ¥æ–‡ï¼Œå¦‚æœæ”¶åˆ°çš„responseä¸­çš„<br>æºIPå’ŒæºMACä¸æ‰€é…ç½®çš„ç›¸åŒï¼Œåˆ™å°†æ”¶åˆ°responseçš„æ¥å£åŠ å…¥è¯¥é™æ€ARPä¸­ï¼Œä¹‹åç”¨äºIPæ•°æ®åŒ…è½¬å‘ã€‚</li>
</ul>
</li>
</ul>
<p>å½“å¸Œæœ›è®¾å¤‡å’ŒæŒ‡å®šç”¨æˆ·åªèƒ½ä½¿ç”¨æŸä¸ªå›ºå®šçš„IPåœ°å€å’ŒMACåœ°å€é€šä¿¡æ—¶ï¼Œå¯ä»¥é…ç½®çŸ­é™æ€ARPè¡¨é¡¹ï¼Œå½“è¿›ä¸€æ­¥å¸Œæœ›è¿™ä¸ªç”¨æˆ·åªåœ¨æŸä¸ªVLANå†…çš„æŸä¸ªç‰¹å®šæ¥å£ä¸Šè¿æ¥æ—¶å°±å¯ä»¥é…ç½®é•¿é™æ€ARPè¡¨é¡¹</p>
<h2 id="å…è´¹ARP"><a href="#å…è´¹ARP" class="headerlink" title="å…è´¹ARP"></a>å…è´¹ARP</h2><p>å…è´¹ARPæ˜¯ä¸€ç§ç‰¹æ®Šçš„ARPæŠ¥æ–‡ï¼Œè¯¥æŠ¥æ–‡ä¸­æºå¸¦çš„å‘é€ç«¯ä¸ç›®çš„ç«¯IPéƒ½æ˜¯æœ¬æœºIPï¼Œå‘é€ç«¯MACæ˜¯æœ¬æœºMACï¼Œæ¥æ”¶ç«¯MACæ˜¯å…¨fã€‚å…¶æœ¬è´¨æ˜¯keep aliveä¿æ´»/å¿ƒè·³æŠ¥æ–‡çš„åº”ç”¨ã€‚<br>å…è´¹ARPæŠ¥æ–‡æœ‰ä»¥ä¸‹åŠŸèƒ½:</p>
<ul>
<li>IPåœ°å€å†²çªæ£€æµ‹ã€‚å¦‚æœæœ‰å†²çªï¼Œå†²çªè®¾å¤‡ä¼šç»™æœ¬æœºå‘é€ä¸€ä¸ªARPåº”ç­”ï¼Œå‘ŠçŸ¥IPåœ°å€å†²çª</li>
<li>è®¾å¤‡æ”¹å˜MACåœ°å€ï¼Œå‘é€å…è´¹ARPæ›´æ–°å…¶å®ƒè®¾å¤‡ä¸­çš„ARPè¡¨é¡¹</li>
</ul>
<p>å®šæ—¶å‘é€å…è´¹ARPçš„åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>é˜²æ­¢ä»¿å†’ç½‘å…³çš„ARPæ”»å‡»ï¼ˆARPæ¬ºéª—ï¼‰<ul>
<li>å¦‚æœæ”»å‡»è€…ä»¿å†’ç½‘å…³å‘é€å…è´¹ARPæŠ¥æ–‡ï¼Œå¯ä»¥å°†åŸæœ¬å‘é€åˆ°ç½‘å…³çš„æµé‡é‡å®šå‘åˆ°ä¸€ä¸ªé”™è¯¯çš„MACåœ°å€ï¼Œå¯¼è‡´ç”¨æˆ·æ— æ³•æ­£å¸¸è®¿é—®ç½‘ç»œã€‚ç½‘å…³æ¥å£ä¸Šä½¿èƒ½å…è´¹ARPåŠŸèƒ½åï¼Œä¸»æœºå¯ä»¥å­¦ä¹ åˆ°æ­£ç¡®çš„ç½‘å…³ã€‚</li>
</ul>
</li>
<li>é˜²æ­¢ARPè¡¨é¡¹è€åŒ–</li>
<li>é˜²æ­¢VRRPè™šæ‹ŸIPåœ°å€å†²çª</li>
<li>åŠæ—¶æ›´æ–°æ¨¡ç³Šç»ˆç»“VLANå†…è®¾å¤‡çš„MACåœ°å€è¡¨</li>
</ul>
<h1 id="ARPåè®®åº”ç”¨"><a href="#ARPåè®®åº”ç”¨" class="headerlink" title="ARPåè®®åº”ç”¨"></a>ARPåè®®åº”ç”¨</h1><p>ARPåè®®çš„çŠ¶æ€æœºæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åº”ç”¨èµ·æ¥æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œä¸€äº›åŸºç¡€ç½‘ç»œé—®é¢˜ä¹Ÿæ˜¯å€¼å¾—æ€è€ƒçš„ã€‚</p>
<h2 id="äºŒå±‚é€šä¿¡ä¸ä¸‰å±‚é€šä¿¡ä¸­ARPçš„åº”ç”¨"><a href="#äºŒå±‚é€šä¿¡ä¸ä¸‰å±‚é€šä¿¡ä¸­ARPçš„åº”ç”¨" class="headerlink" title="äºŒå±‚é€šä¿¡ä¸ä¸‰å±‚é€šä¿¡ä¸­ARPçš„åº”ç”¨"></a>äºŒå±‚é€šä¿¡ä¸ä¸‰å±‚é€šä¿¡ä¸­ARPçš„åº”ç”¨</h2><p>äºŒä¸‰å±‚è®¾å¤‡äº’é€šä¸­arpæ˜¯æ€æ ·å·¥ä½œçš„ï¼Ÿ</p>
<p><img src="https://rancho333.github.io/pictures/ping_arp.png"><br>å¦‚å›¾æ‰€ç¤ºï¼Œä¸¤ä¸ªvlané€šè¿‡interface vlanè·¯ç”±æ¥å£å®ç°äº’é€šã€‚ä¸‹æ–‡è¯´æ˜ä¸­ï¼Œäº¤æ¢æœºå’Œç»ˆç«¯è®¾å¤‡å‡ä¸ºåˆå§‹çŠ¶æ€ï¼Œä¸å«æœ‰arpè¡¨é¡¹ã€‚</p>
<h3 id="Aå’ŒBä¹‹é—´çš„äº’é€š-äºŒå±‚"><a href="#Aå’ŒBä¹‹é—´çš„äº’é€š-äºŒå±‚" class="headerlink" title="Aå’ŒBä¹‹é—´çš„äº’é€š(äºŒå±‚)"></a>Aå’ŒBä¹‹é—´çš„äº’é€š(äºŒå±‚)</h3><p>ä»¥Aå‘Bå‘èµ·pingè¯·æ±‚ä¸ºä¾‹ã€‚</p>
<ol>
<li>Aæ£€æŸ¥æŠ¥æ–‡çš„ç›®çš„IPåœ°å€å‘ç°å’Œè‡ªå·±åœ¨åŒä¸€ä¸ªç½‘æ®µï¼›</li>
<li>Aâ€”-&gt;B ARPè¯·æ±‚æŠ¥æ–‡ï¼Œè¯¥æŠ¥æ–‡åœ¨VLAN1å†…å¹¿æ’­<ol>
<li>æŠ¥æ–‡çš„dst macæ˜¯å¹¿æ’­macï¼Œsrc macæ˜¯A mac</li>
<li>æŠ¥æ–‡çš„sender MACæ˜¯A mac, sender ipæ˜¯A ip; target macæ˜¯å…¨0ï¼Œtarget ipæ˜¯B ip</li>
</ol>
</li>
<li>Bâ€”-&gt;A  ARPå›åº”æŠ¥æ–‡<ol>
<li>æŠ¥æ–‡çš„dst macæ˜¯A mac, src macæ˜¯B mac</li>
<li>æŠ¥æ–‡çš„sender MACæ˜¯B mac(Aè¯·æ±‚çš„mac), sender ipæ˜¯B ip; target macæ˜¯A macï¼Œtaaget ipæ˜¯A ip</li>
</ol>
</li>
<li>Aâ€”-&gt;B  icmp request</li>
<li>Bâ€”-&gt;A  icmp reply</li>
</ol>
<h3 id="Aå’ŒCä¹‹é—´çš„äº’é€š-ä¸‰å±‚"><a href="#Aå’ŒCä¹‹é—´çš„äº’é€š-ä¸‰å±‚" class="headerlink" title="Aå’ŒCä¹‹é—´çš„äº’é€š(ä¸‰å±‚)"></a>Aå’ŒCä¹‹é—´çš„äº’é€š(ä¸‰å±‚)</h3><p>ä»¥Aå‘Cå‘èµ·pingè¯·æ±‚ä¸ºä¾‹ã€‚</p>
<ol>
<li>Aæ£€æŸ¥æŠ¥æ–‡çš„ç›®çš„IPåœ°å€ï¼Œå‘ç°å’Œè‡ªå·±ä¸åœ¨åŒä¸€ä¸ªç½‘æ®µ</li>
<li>Aâ€”-&gt;switch(int vlan 1) ARPè¯·æ±‚æŠ¥æ–‡ï¼Œè¯¥æŠ¥æ–‡åœ¨vlan1å†…å¹¿æ’­<ol>
<li>æŠ¥æ–‡çš„dst macæ˜¯å¹¿æ’­macï¼Œsrc macæ˜¯A mac</li>
<li>æŠ¥æ–‡çš„sender MACæ˜¯A mac, sender ipæ˜¯A ip; target macæ˜¯å…¨0ï¼Œtarget ipæ˜¯int vlan 1 ip</li>
</ol>
</li>
<li>ç½‘å…³â€”-&gt; A ARPå›åº”æŠ¥æ–‡<ol>
<li>æŠ¥æ–‡çš„dst macæ˜¯A mac, src macæ˜¯int vlan 1 mac</li>
<li>æŠ¥æ–‡çš„sender MACæ˜¯int vlan 1 mac(Aè¯·æ±‚çš„mac), sender ipæ˜¯int vlan 1 ip; target macæ˜¯A macï¼Œtaaget ipæ˜¯A ip</li>
</ol>
</li>
<li>Aâ€”-&gt;C icmp request<ol>
<li>æŠ¥æ–‡dst macæ˜¯int vlan 1çš„macï¼Œsrc macæ˜¯Açš„mac; dst ipæ˜¯C ipï¼Œsrc ipæ˜¯A ip</li>
</ol>
</li>
<li>switchæ”¶åˆ°æŠ¥æ–‡ååˆ¤æ–­å‡ºæ˜¯ä¸‰å±‚æŠ¥æ–‡ï¼Œæ£€æŸ¥æŠ¥æ–‡çš„ç›®çš„IPåœ°å€ï¼Œå‘ç°æ˜¯åœ¨è‡ªå·±çš„ç›´è¿ç½‘æ®µ</li>
<li>switch(int vlan 2)â€”-&gt;C ARPè¯·æ±‚æŠ¥æ–‡ï¼Œè¯¥æŠ¥æ–‡åœ¨vlan2å†…å¹¿æ’­</li>
<li>Câ€”-&gt;switch(int vlan 2) ARPå›åº”æŠ¥æ–‡</li>
<li>switch(int vlan 2)â€”-&gt;C icmp request<ol>
<li>æŠ¥æ–‡çš„dst macæ˜¯Cçš„mac, src macæ˜¯int vlan 2çš„mac; dst ipæ˜¯C ip, src ipæ˜¯A ip</li>
</ol>
</li>
<li>Câ€”-&gt;A icmp reply, è¿™ä»¥åçš„å¤„ç†åŒå‰é¢icmp requestçš„è¿‡ç¨‹åŸºæœ¬ç›¸åŒã€‚</li>
</ol>
<p>å¯¹æŠ¥æ–‡è·¯ç”±ï¼Œä¼šå¯¹æŠ¥æ–‡çš„MACå¤´è¿›è¡Œé‡æ–°å°è£…ï¼Œè€ŒIPå±‚ä»¥ä¸Šçš„å­—æ®µåŸºæœ¬ä¸å˜ã€‚é€šè¿‡è¯´æ˜æŠ¥æ–‡dst/src MACçš„å˜åŒ–ï¼Œæ³¨æ„ARPåœ¨äºŒä¸‰å±‚é€šä¿¡ä¸­èµ·çš„ä½œç”¨ã€‚åç»­è®¾å¤‡ä¸­ARPè¡¨æœ‰äº†ç›¸åº”çš„æ¡ç›®ä¹‹åï¼Œåˆ™ä¸ä¼šç»™å¯¹æ–¹å‘é€ARPè¯·æ±‚æŠ¥æ–‡ã€‚</p>
<h2 id="ARPä»£ç†"><a href="#ARPä»£ç†" class="headerlink" title="ARPä»£ç†"></a>ARPä»£ç†</h2><p>å¦‚æœARPè¯·æ±‚æ˜¯ä»ä¸€ä¸ªç½‘ç»œçš„ä¸»æœºå‘å¾€åŒä¸€ç½‘æ®µå´ä¸åœ¨åŒä¸€ç‰©ç†ç½‘ç»œä¸Šçš„å¦ä¸€å°ä¸»æœºï¼Œé‚£ä¹ˆè¿æ¥å®ƒä»¬çš„å…·æœ‰ä»£ç†ARPåŠŸèƒ½çš„è®¾å¤‡å°±å¯ä»¥å›ç­”è¯¥è¯·æ±‚ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä½œä»£ç†ARPï¼ˆProxy ARPï¼‰<br>ä»£ç†ARPåŠŸèƒ½å±è”½åˆ†ç¦»çš„ç‰©ç†ç½‘ç»œè¿™ä¸€äº‹å®ï¼Œä½¿ç”¨æˆ·ä½¿ç”¨èµ·æ¥ï¼Œå¥½åƒåœ¨åŒä¸€ç‰©ç†ç½‘ç»œä¸Šã€‚<br>ä»£ç†ARPåˆ†ä¸ºæ™®é€šä»£ç†ARPå’Œæœ¬åœ°ä»£ç†ARPï¼ŒäºŒè€…çš„åº”ç”¨åœºæ™¯æœ‰æ‰€åŒºåˆ«ã€‚</p>
<ul>
<li>æ™®é€šä»£ç†ARPçš„åº”ç”¨åœºæ™¯ï¼šæƒ³è¦äº’é€šçš„ä¸»æœºåˆ†åˆ«è¿æ¥åˆ°è®¾å¤‡çš„ä¸åŒçš„ä¸‰å±‚æ¥å£ä¸Šï¼Œä¸”è¿™äº›ä¸»æœºä¸åœ¨åŒä¸€ä¸ªå¹¿æ’­åŸŸä¸­</li>
<li>æœ¬åœ°ä»£ç†ARPçš„åº”ç”¨ç¯å¢ƒä¸ºï¼šæƒ³è¦äº’é€šçš„ä¸»æœºè¿æ¥åˆ°è®¾å¤‡çš„åŒä¸€ä¸ªä¸‰å±‚æ¥å£åœ¨ï¼Œä¸”è¿™äº›ä¸»æœºä¸åœ¨åŒä¸€ä¸ªå¹¿æ’­åŸŸä¸­</li>
</ul>
<h3 id="æ™®é€šä»£ç†ARP"><a href="#æ™®é€šä»£ç†ARP" class="headerlink" title="æ™®é€šä»£ç†ARP"></a>æ™®é€šä»£ç†ARP</h3><p>å¤„äºåŒä¸€ç½‘æ®µå†…çš„ä¸»æœºï¼Œå½“è¿æ¥åˆ°è®¾å¤‡çš„ä¸åŒä¸‰å±‚æ¥å£æ—¶ï¼Œå¯ä»¥åˆ©ç”¨è®¾å¤‡çš„ä»£ç†ARPåŠŸèƒ½ï¼Œé€šè¿‡ä¸‰å±‚è½¬å‘å®ç°äº’é€šã€‚<br>æ‹“æ‰‘å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è®¾å¤‡Routeré€šè¿‡ä¸¤ä¸ªä¸‰å±‚æ¥å£Eth1/1å’ŒEth1/2è¿æ¥ä¸¤ä¸ªç½‘ç»œï¼Œä¸¤ä¸ªä¸‰å±‚æ¥å£çš„IPåœ°å€ä¸åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œä½†æ˜¯ä¸¤ä¸ªç½‘ç»œå†…çš„ä¸»æœºHost Aå’ŒHost Bçš„åœ°å€é€šè¿‡æ©ç çš„æ§åˆ¶ï¼Œæ—¢ä¸ç›¸è¿è®¾å¤‡çš„æ¥å£åœ°å€åœ¨åŒä¸€ç½‘æ®µï¼ŒåŒæ—¶äºŒè€…ä¹Ÿå¤„äºåŒä¸€ä¸ªç½‘æ®µã€‚<br><img src="https://rancho333.github.io/pictures/general_arp_agent.png"><br>è¿™ç§ç»„ç½‘åœºæ™¯ä¸‹ï¼Œå½“Host Aéœ€è¦ä¸Host Bé€šä¿¡æ—¶ï¼Œç”±äºdst ipä¸src ipåœ¨åŒä¸€ç½‘æ®µï¼Œå› æ­¤Host Aä¼šç›´æ¥å¯¹Host Bè¿›è¡ŒARPè¯·æ±‚ã€‚ä½†æ˜¯ï¼Œä¸¤å°ä¸»æœºä¸åœ¨åŒä¸€ä¸ªå¹¿æ’­åŸŸä¸­ï¼ŒHost Bæ— æ³•æ”¶åˆ°Host Açš„ARPè¯·æ±‚æŠ¥æ–‡ï¼Œå½“ç„¶ä¹Ÿå°±æ— æ³•åº”ç­”ã€‚<br>é€šè¿‡åœ¨Routerä¸Šå¯ç”¨ä»£ç†ARPåŠŸèƒ½ï¼Œå¯ä»¥è§£å†³æ­¤é—®é¢˜ã€‚å¯ç”¨ä»£ç†ARPå,Routerå¯ä»¥åº”ç­”Host Açš„ARPè¯·æ±‚ã€‚åŒæ—¶ï¼ŒRouterç›¸å½“äºHost Bçš„ä»£ç†ï¼ŒæŠŠä»å…¶å®ƒä¸»æœºå‘é€è¿‡æ¥çš„æŠ¥æ–‡è½¬å‘ç»™å®ƒã€‚<br>ä»£ç†ARPçš„ä¼˜ç‚¹æ˜¯ï¼Œå®ƒå¯ä»¥åªè¢«åº”ç”¨åœ¨ä¸€ä¸ªè®¾å¤‡ä¸Šï¼ˆæ­¤æ—¶è®¾å¤‡çš„ä½œç”¨ç›¸å½“äºç½‘å…³ï¼‰ï¼Œä¸ä¼šå½±å“åˆ°ç½‘ç»œä¸­å…¶å®ƒè®¾å¤‡çš„è·¯ç”±è¡¨ã€‚ä»£ç†ARPåŠŸèƒ½å¯ä»¥åœ¨IPä¸»æœºæ²¡æœ‰é…ç½®ç¼ºçœç½‘å…³æˆ–è€…IPä¸»æœºæ²¡æœ‰ä»»ä½•è·¯ç”±èƒ½åŠ›çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p>
<h3 id="æœ¬åœ°ä»£ç†ARP"><a href="#æœ¬åœ°ä»£ç†ARP" class="headerlink" title="æœ¬åœ°ä»£ç†ARP"></a>æœ¬åœ°ä»£ç†ARP</h3><p>æ‹“æ‰‘å¦‚å›¾æ‰€ç¤ºã€‚Host Aä¸Host Bå±äºåŒä¸€ä¸ªVLAN 2,ä½†ä»–ä»¬åˆ†åˆ«è¿æ¥åˆ°è¢«äºŒå±‚éš”ç¦»çš„ç«¯å£Eth1/3å’ŒEth1/1ä¸Šï¼Œé€šè¿‡åœ¨Routerä¸Šå¯ç”¨æœ¬åœ°ä»£ç†ARPåŠŸèƒ½ï¼Œå¯ä»¥å®ç°Host Aå’ŒHost Bçš„ä¸‰å±‚äº’é€šã€‚<br><img src="https://rancho333.github.io/pictures/local_arp_agent.png"></p>
<p>æœ¬åœ°ä»£ç†ARPå¯ä»¥åœ¨ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¸‹å®ç°ä¸»æœºä¹‹é—´çš„ä¸‰å±‚äº’é€šï¼š</p>
<ul>
<li>æƒ³è¦äº’é€šçš„ä¸»æœºåˆ†åˆ«è¿æ¥åˆ°åŒä¸€ä¸ªVLANä¸­çš„ä¸åŒçš„äºŒå±‚éš”ç¦»ç«¯å£ä¸‹</li>
<li>ä½¿èƒ½Super VLANåŠŸèƒ½åï¼Œæƒ³è¦äº’é€šçš„ä¸»æœºå±äºä¸åŒçš„Sub VLAN</li>
<li>ä½¿èƒ½Lsolate-user-vlanåŠŸèƒ½åï¼Œæƒ³è¦äº’é€šçš„ä¸»æœºå±äºä¸åŒçš„Secondary VLAN</li>
</ul>
<h2 id="ARP-Snooping"><a href="#ARP-Snooping" class="headerlink" title="ARP Snooping"></a>ARP Snooping</h2><p>ARP snoopingåŠŸèƒ½æ˜¯ä¸€ä¸ªç”¨äºäºŒå±‚äº¤æ¢ç½‘ç»œç¯å¢ƒçš„ç‰¹æ€§ï¼Œé€šè¿‡ä¾¦å¬ARPæŠ¥æ–‡å»ºç«‹ARP Snoopingè¡¨é¡¹ï¼Œä»è€Œæä¾›ç»™ARPå¿«é€Ÿåº”ç­”å’ŒMFFæ‰‹åŠ¨æ–¹å¼ç­‰ä½¿ç”¨ã€‚<br>è®¾å¤‡ä¸Šçš„ä¸€ä¸ªVLANä½¿èƒ½ARP Snoopingåï¼Œè¯¥VLANå†…æ‰€æœ‰ç«¯å£æ¥æ”¶çš„ARPæŠ¥æ–‡ä¼šè¢«é‡å®šå‘åˆ°CPuã€‚CPUå¯¹é‡å®šå‘ä¸Šé€çš„ARPæŠ¥æ–‡è¿›è¡Œåˆ†æï¼Œè·å–ARPæŠ¥æ–‡çš„src ip, src mac, src vlanå’Œå…¥ç«¯å£ä¿¡æ¯ï¼Œå»ºç«‹è®°å½•ç”¨æˆ·ä¿¡æ¯çš„ARP Snoopingè¡¨é¡¹ã€‚</p>
<h2 id="ARPå¿«é€Ÿåº”ç­”"><a href="#ARPå¿«é€Ÿåº”ç­”" class="headerlink" title="ARPå¿«é€Ÿåº”ç­”"></a>ARPå¿«é€Ÿåº”ç­”</h2><p>åœ¨æ— çº¿äº§å“ç»„ç½‘ä¸­ï¼ŒACä¸APä¼šå»ºç«‹éš§é“è¿æ¥ï¼ŒClienté€šè¿‡APè¿æ¥åˆ°ACï¼Œé€šè¿‡ACï¼Œclientå¯ä»¥ä¸ç½‘å…³å»ºç«‹è¿æ¥ã€‚å½“Clientå‘èµ·ARPå¹¿æ’­è¯·æ±‚æ—¶ï¼Œéœ€è¦é€šè¿‡ACå‘æ‰€æœ‰çš„APå¤åˆ¶ARPè¯·æ±‚ï¼Œè¿™æ ·ä¼šå¯¼è‡´ARPå¹¿æ’­å ç”¨éš§é“çš„å¤§é‡èµ„æºï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ä¸ºäº†å‡å°‘ARPå¹¿æ’­å ç”¨çš„éš§é“èµ„æºï¼Œå¯ä»¥åœ¨ACä¸Šå¯ç”¨ARPå¿«é€Ÿåº”ç­”åŠŸèƒ½ï¼Œå‡å°‘ARPå¹¿æ’­æŠ¥æ–‡çš„å½±å“ã€‚</p>
<p>ARPå¿«é€Ÿåº”ç­”åŠŸèƒ½å°±æ˜¯æ ¹æ®ACè®¾å¤‡æ”¶é›†çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆDHCP Snoopingè¡¨é¡¹æˆ–è€…ARP Snoopingè¡¨é¡¹ï¼‰ï¼Œåœ¨æŒ‡å®šçš„VLANå†…ï¼Œå°½å¯èƒ½çš„å¯¹ARPè¯·æ±‚è¿›è¡Œåº”ç­”ï¼Œä»è€Œå‡å°‘ARPå¹¿æ’­æŠ¥æ–‡ã€‚</p>
<h3 id="ARPå¿«é€Ÿåº”ç­”å·¥ä½œæœºåˆ¶"><a href="#ARPå¿«é€Ÿåº”ç­”å·¥ä½œæœºåˆ¶" class="headerlink" title="ARPå¿«é€Ÿåº”ç­”å·¥ä½œæœºåˆ¶"></a>ARPå¿«é€Ÿåº”ç­”å·¥ä½œæœºåˆ¶</h3><p>ARPå¿«é€Ÿåº”ç­”çš„å·¥ä½œæœºåˆ¶å¦‚ä¸‹ï¼š</p>
<ol>
<li>è®¾å¤‡æ¥æ”¶åˆ°ARPè¯·æ±‚æŠ¥æ–‡æ—¶ï¼Œå¦‚æœè¯·æ±‚æŠ¥æ–‡çš„ç›®çš„IPåœ°å€æ˜¯è®¾å¤‡çš„VLANè™šæ¥å£çš„IPåœ°å€ï¼Œåˆ™ç”±ARPç‰¹æ€§è¿›è¡Œå¤„ç†</li>
<li>å¦‚æœä¸æ˜¯ï¼Œåˆ™æ ¹æ®æŠ¥æ–‡ä¸­çš„ç›®çš„IPåœ°å€æŸ¥æ‰¾DHCP Snoopingè¡¨é¡¹<ol>
<li>å¦‚æœæŸ¥æ‰¾æˆåŠŸï¼Œä½†æ˜¯æŸ¥æ‰¾åˆ°çš„è¡¨é¡¹çš„æ¥å£å’Œæ”¶åˆ°è¯·æ±‚æŠ¥æ–‡çš„æ¥å£ä¸€è‡´ï¼Œå¹¶ä¸”æ¥å£æ˜¯ä»¥å¤ªç½‘æ¥å£ï¼Œåˆ™ä¸è¿›è¡Œåº”ç­”ï¼Œå¦åˆ™ç«‹å³è¿›è¡Œåº”ç­”</li>
<li>å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾ARP Snoopingè¡¨é¡¹ã€‚å¦‚æœæŸ¥æ‰¾æˆåŠŸï¼Œä½†æ˜¯æŸ¥æ‰¾åˆ°çš„è¡¨é¡¹çš„æ¥å£å’Œæ”¶åˆ°è¯·æ±‚æŠ¥æ–‡çš„æ¥å£ä¸€è‡´ï¼Œå¹¶ä¸”æ¥å£æ˜¯ä»¥å¤ªç½‘æ¥å£ï¼Œåˆ™ä¸è¿›è¡Œåº”ç­”ï¼Œå¦åˆ™ç«‹å³è¿›è¡Œåº”ç­”ã€‚</li>
<li>å¦‚æœä¸¤ä¸ªè¡¨é¡¹å‡æŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™ç›´æ¥è½¬å‘è¯·æ±‚æŠ¥æ–‡æˆ–å°†æŠ¥æ–‡äº¤äºå…¶å®ƒç‰¹æ€§å¤„ç†ã€‚</li>
</ol>
</li>
</ol>
<h2 id="ARPé˜²å¾¡æ”»å‡»"><a href="#ARPé˜²å¾¡æ”»å‡»" class="headerlink" title="ARPé˜²å¾¡æ”»å‡»"></a>ARPé˜²å¾¡æ”»å‡»</h2><p>ARPåè®®æœ‰ç®€å•ã€æ˜“ç”¨çš„ä¼˜ç‚¹ï¼Œä½†æ˜¯ä¹Ÿå› ä¸ºæ²¡æœ‰ä»»ä½•å®‰å…¨æœºåˆ¶è€Œå®¹æ˜“è¢«æ”»å‡»å‘èµ·è€…åˆ©ç”¨ã€‚</p>
<ul>
<li>æ”»å‡»è€…å¯ä»¥ä»¿å†’ç”¨æˆ·ã€ä»¿å†’ç½‘å…³å‘é€ä¼ªé€ çš„ARPæŠ¥æ–‡ï¼Œä½¿ç½‘å…³æˆ–ä¸»æœºçš„ARPè¡¨é¡¹ä¸æ­£ç¡®ï¼Œä»è€Œå¯¹ç½‘ç»œè¿›è¡Œæ”»å‡»</li>
<li>æ”»å‡»è€…é€šè¿‡å‘è®¾å¤‡å‘é€å¤§é‡ç›®æ ‡IPåœ°å€ä¸èƒ½è§£æçš„IPæŠ¥æ–‡ï¼Œä½¿å¾—è®¾å¤‡è¯•å›¾åå¤åœ°å¯¹ç›®æ ‡IPåœ°å€è¿›è¡Œè§£æï¼Œå¯¼è‡´CPUè´Ÿè·è¿‡é‡åŠç½‘ç»œæµé‡è¿‡å¤§</li>
<li>æ”»å‡»è€…å‘è®¾å¤‡å‘é€å¤§é‡çš„ARPæŠ¥æ–‡ï¼Œå¯¹è®¾å¤‡çš„CPUå½¢æˆå†²å‡»ã€‚<br>ç›®å‰ARPæ”»å‡»å’ŒARPç—…æ¯’å·²ç»æˆä¸ºå±€åŸŸç½‘å®‰å…¨çš„ä¸€å¤§å¨èƒã€‚ä¸‹é¢ç®€å•è¯´æ˜ä¸€ä¸‹ARPæ”»é˜²åŸç†ã€‚</li>
</ul>
<h3 id="ARPé˜²æ­¢IPæŠ¥æ–‡æ”»å‡»åŠŸèƒ½ç®€ä»‹"><a href="#ARPé˜²æ­¢IPæŠ¥æ–‡æ”»å‡»åŠŸèƒ½ç®€ä»‹" class="headerlink" title="ARPé˜²æ­¢IPæŠ¥æ–‡æ”»å‡»åŠŸèƒ½ç®€ä»‹"></a>ARPé˜²æ­¢IPæŠ¥æ–‡æ”»å‡»åŠŸèƒ½ç®€ä»‹</h3><p>å¦‚æœç½‘ç»œä¸­æœ‰ä¸»æœºé€šè¿‡å‘è®¾å¤‡å‘é€å¤§é‡ç›®æ ‡IPåœ°å€ä¸èƒ½è§£æçš„IPæŠ¥æ–‡æ¥æ”»å‡»è®¾å¤‡ï¼Œåˆ™ä¼šé€ æˆä¸‹é¢çš„å±å®³ï¼š</p>
<ul>
<li>è®¾å¤‡å‘ç›®çš„ç½‘æ®µå‘é€å¤§é‡çš„ARPè¯·æ±‚æŠ¥æ–‡ï¼ŒåŠ é‡ç›®çš„ç½‘æ®µçš„è´Ÿè½½</li>
<li>è®¾å¤‡ä¼šè¯•å›¾åå¤åœ°å¯¹ç›®æ ‡IPåœ°å€è¿›è¡Œè§£æï¼Œå¢åŠ äº†CPUçš„è´Ÿæ‹…</li>
</ul>
<p>ä¸ºäº†é¿å…è¿™ç§IPæŠ¥æ–‡æ”»å‡»æ‰€å¸¦æ¥çš„å±å®³ï¼Œè®¾å¤‡æä¾›äº†ä¸‹åˆ—ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>å¦‚æœå‘é€æ”»å‡»æŠ¥æ–‡çš„æºæ˜¯å›ºå®šçš„ï¼Œå¯ä»¥é‡‡ç”¨ARPæºæŠ‘åˆ¶åŠŸèƒ½ã€‚å¼€å¯è¯¥åŠŸèƒ½åï¼Œå¦‚æœç½‘ç»œä¸­æŸä¸»æœºå‘è®¾å¤‡æŸç«¯å£è¿ç»­å‘é€ç›®æ ‡IPåœ°å€ä¸èƒ½è§£æçš„IPæŠ¥æ–‡ï¼Œå½“æ¯5ç§’å†…æ­¤ä¸»æœºå‘å‡ºIPæŠ¥æ–‡å‡ºå‘ARPè¯·æ±‚æŠ¥æ–‡çš„æµé‡è¶…è¿‡è®¾ç½®çš„é˜ˆå€¼ï¼Œé‚£ä¹ˆå¯¹äºç”±æ­¤ä¸»æœºå‘å‡ºçš„IPæŠ¥æ–‡ï¼Œè®¾å¤‡ä¸å…è®¸å…¶è§¦å‘ARPè¯·æ±‚ï¼Œç›´è‡³5ç§’åå†å¤„ç†ï¼Œä»è€Œé¿å…äº†æ¶æ„æ”»å‡»æ‰€é€ æˆçš„å±å®³ã€‚</li>
<li>å¦‚æœå‘é€æ”»å‡»æŠ¥æ–‡çš„æºä¸å›ºå®šï¼Œè®¾å¤‡ç«‹å³äº§ç”Ÿä¸€ä¸ªé»‘æ´è·¯ç”±ï¼Œä½¿å¾—è®¾å¤‡åœ¨ä¸€æ®µæ—¶é—´å†…å°†å»å¾€è¯¥åœ°å€çš„æŠ¥æ–‡ç›´æ¥ä¸¢å¼ƒã€‚ç­‰å¾…é»‘æ´è·¯ç”±è€åŒ–æ—¶é—´è¿‡åï¼Œå¦‚æœ‰æŠ¥æ–‡è§¦å‘åˆ™å†æ¬¡å‘èµ·è§£æï¼Œå¦‚æœè§£ææˆåŠŸåˆ™è¿›è¡Œè½¬å‘ï¼Œå¦åˆ™ä»ç„¶äº§ç”Ÿä¸€ä¸ªé»‘æ´è·¯ç”±å°†å»å¾€æ”¹åœ°å€çš„æŠ¥æ–‡ä¸¢å¼ƒã€‚è¿™ç§æ–¹å¼èƒ½å¤Ÿæœ‰æ•ˆçš„é˜²æ­¢IPæŠ¥æ–‡çš„æ”»å‡»ï¼Œå‡è½»CPUçš„è´Ÿæ‹…ã€‚</li>
</ul>
<h3 id="ARPæŠ¥æ–‡é™é€ŸåŠŸèƒ½"><a href="#ARPæŠ¥æ–‡é™é€ŸåŠŸèƒ½" class="headerlink" title="ARPæŠ¥æ–‡é™é€ŸåŠŸèƒ½"></a>ARPæŠ¥æ–‡é™é€ŸåŠŸèƒ½</h3><p>ARPæŠ¥æ–‡é™é€ŸåŠŸèƒ½æ˜¯æŒ‡å¯¹ä¸Šé€CPUçš„ARPæŠ¥æ–‡è¿›è¡Œé™é€Ÿï¼Œå¯ä»¥é˜²æ­¢å¤§é‡ARPæŠ¥æ–‡å¯¹CPUè¿›è¡Œå†²å‡»ã€‚ä¾‹å¦‚ï¼Œåœ¨é…ç½®äº†ARP DetectionåŠŸèƒ½åï¼Œè®¾å¤‡ä¼šå°†æ”¶åˆ°çš„ARPæŠ¥æ–‡é‡å®šå‘åˆ°CPUè¿›è¡Œæ£€æŸ¥ï¼Œè¿™æ ·ä¼šå¼•å…¥æ–°çš„é—®é¢˜ï¼šå¦‚æœæ”»å‡»è€…æ¶æ„æ„é€ å¤§é‡ARPæŠ¥æ–‡å‘å¾€è®¾å¤‡ï¼Œä¼šå¯¼è‡´è®¾å¤‡çš„CPUè´Ÿæ‹…è¿‡é‡ï¼Œä»è€Œé€ æˆå…¶å®ƒåŠŸèƒ½æ— æ³•æ­£å¸¸è¿è¡Œç”šè‡³è®¾å¤‡ç˜«ç—ªï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å¯ç”¨ARPæŠ¥æ–‡é™é€ŸåŠŸèƒ½æ¥æ§åˆ¶ä¸Šé€CPUçš„ARPæŠ¥æ–‡çš„é€Ÿç‡ã€‚</p>
<p>æ¨èç”¨æˆ·åœ¨é…ç½®äº†ARP Detectionã€ARP Snoopingã€ARPå¿«é€Ÿåº”ç­”ã€MFFï¼Œæˆ–è€…å‘ç°æœ‰ARPæ³›æ´ªæ”»å‡»çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ARPæŠ¥æ–‡é™é€ŸåŠŸèƒ½ã€‚</p>
<h3 id="æºMACåœ°å€å›ºå®šçš„ARPæ”»å‡»æ£€æµ‹åŠŸèƒ½"><a href="#æºMACåœ°å€å›ºå®šçš„ARPæ”»å‡»æ£€æµ‹åŠŸèƒ½" class="headerlink" title="æºMACåœ°å€å›ºå®šçš„ARPæ”»å‡»æ£€æµ‹åŠŸèƒ½"></a>æºMACåœ°å€å›ºå®šçš„ARPæ”»å‡»æ£€æµ‹åŠŸèƒ½</h3><p>æœ¬ç‰¹æ€§æ ¹æ®ARPæŠ¥æ–‡çš„æºMACåœ°å€è¿›è¡Œç»Ÿè®¡ï¼Œåœ¨5ç§’å†…ï¼Œå¦‚æœæ”¶åˆ°åŒä¸€æºMACåœ°å€çš„ARPæŠ¥æ–‡è¶…è¿‡ä¸€å®šçš„é˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºå­˜åœ¨æ”»å‡»ï¼Œç³»ç»Ÿä¼šå°†æ­¤MACåœ°å€æ·»åŠ åˆ°æ”»å‡»æ£€æµ‹è¡¨é¡¹ä¸­ã€‚åœ¨è¯¥æ”»å‡»æ£€æµ‹è¡¨é¡¹è€åŒ–ä¹‹å‰ï¼Œå¦‚æœè®¾ç½®çš„æ£€æŸ¥æ¨¡å¼ä¸ºè¿‡æ»¤æ¨¡å¼ï¼Œåˆ™ä¼šæ‰“å°å‘Šè­¦ä¿¡æ¯å¹¶å°†è¯¥æºMACåœ°å€å‘é€çš„ARPæŠ¥æ–‡è¿‡æ»¤æ‰ã€‚å¦‚æœè®¾ç½®ä¸ºç›‘æ§æ¨¡å¼ï¼Œåˆ™åªæ‰“å°å‘Šè­¦ä¿¡æ¯ï¼Œä¸ä¼šå°†æºMACåœ°å€å‘é€çš„ARPæŠ¥æ–‡è¿‡æ»¤æ‰ã€‚<br>å¯¹äºç½‘å…³æˆ–ä¸€äº›é‡è¦çš„æœåŠ¡å™¨ï¼Œå¯èƒ½ä¼šå‘é€å¤§é‡çš„ARPæŠ¥æ–‡ï¼Œä¸ºäº†ä½¿è¿™äº›ARPæŠ¥æ–‡ä¸è¢«è¿‡æ»¤æ‰ï¼Œå¯ä»¥å°†è¿™ç±»è®¾å¤‡çš„MACåœ°å€é…ç½®æˆä¿æŠ¤MACï¼Œè¿™æ ·ï¼Œå³ä½¿è¯¥MACå­˜åœ¨æ”»å‡»ä¹Ÿä¸ä¼šè¢«æ£€æµ‹è¿‡æ»¤ã€‚åªå¯¹ä¸Šé€CPUçš„ARPæŠ¥æ–‡è¿›è¡Œç»Ÿè®¡ã€‚</p>
<h3 id="ARPæŠ¥æ–‡æºMACä¸€è‡´æ€§æ£€æŸ¥åŠŸèƒ½ç®€ä»‹"><a href="#ARPæŠ¥æ–‡æºMACä¸€è‡´æ€§æ£€æŸ¥åŠŸèƒ½ç®€ä»‹" class="headerlink" title="ARPæŠ¥æ–‡æºMACä¸€è‡´æ€§æ£€æŸ¥åŠŸèƒ½ç®€ä»‹"></a>ARPæŠ¥æ–‡æºMACä¸€è‡´æ€§æ£€æŸ¥åŠŸèƒ½ç®€ä»‹</h3><p>ARPæŠ¥æ–‡æºMACä¸€è‡´æ€§æ£€æŸ¥åŠŸèƒ½ä¸»è¦åº”ç”¨äºç½‘å…³è®¾å¤‡ä¸Šï¼Œé˜²å¾¡ä»¥å¤ªç½‘æ•°æ®å¸§é¦–éƒ¨ä¸­çš„æºMACåœ°å€å’ŒARPæŠ¥æ–‡ä¸­sender macåœ°å€ä¸åŒçš„ARPæ”»å‡»ã€‚</p>
<p>åœ¨é…ç½®è¢«ç‰¹æ€§åï¼Œç½‘å…³è®¾å¤‡åœ¨è¿›è¡ŒARPå­¦ä¹ å‰å°†å¯¹ARPæŠ¥æ–‡è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœä»¥å¤ªç½‘æ•°æ®å¸§é¦–éƒ¨ä¸­çš„æºMACåœ°å€å’ŒARPæŠ¥æ–‡ä¸­sender macåœ°å€ä¸åŒï¼Œåˆ™è®¤ä¸ºæ˜¯æ”»å‡»æŠ¥æ–‡ï¼Œå°†å…¶ä¸¢å¼ƒï¼Œå¦åˆ™ï¼Œç»§ç»­è¿›è¡ŒARPå­¦ä¹ ã€‚</p>
<h3 id="ARPä¸»åŠ¨ç¡®è®¤åŠŸèƒ½"><a href="#ARPä¸»åŠ¨ç¡®è®¤åŠŸèƒ½" class="headerlink" title="ARPä¸»åŠ¨ç¡®è®¤åŠŸèƒ½"></a>ARPä¸»åŠ¨ç¡®è®¤åŠŸèƒ½</h3><p>ARPçš„ä¸»åŠ¨ç¡®è®¤åŠŸèƒ½ä¸»è¦åº”ç”¨äºç½‘å…³è®¾å¤‡ä¸Šï¼Œé˜²æ­¢æ”»å‡»è€…ä»¿å†’ç”¨æˆ·æ¬ºéª—ç½‘å…³è®¾å¤‡ã€‚</p>
<p>å¯ç”¨ARPä¸»åŠ¨ç¡®è®¤åŠŸèƒ½åï¼Œè®¾å¤‡åœ¨æ–°å»ºæˆ–æ›´æ–°ARPè¡¨é¡¹å‰éœ€è¿›è¡Œä¸»åŠ¨ç¡®è®¤ï¼Œé˜²æ­¢äº§ç”Ÿé”™è¯¯çš„ARPè¡¨é¡¹ã€‚</p>
<h2 id="MLAGç»“åˆVARPå®ç°VRRP"><a href="#MLAGç»“åˆVARPå®ç°VRRP" class="headerlink" title="MLAGç»“åˆVARPå®ç°VRRP"></a>MLAGç»“åˆVARPå®ç°VRRP</h2><p>VRRP(virtual router redundancy protocolï¼Œè™šæ‹Ÿè·¯ç”±å™¨å†—ä½™åè®®)å°†å¯ä»¥æ‰¿æ‹…ç½‘å…³åŠŸèƒ½çš„ä¸€ç»„è·¯ç”±å™¨åŠ å…¥åˆ°å¤‡ä»½ç»„ä¸­ï¼Œå½¢æˆä¸€å°è™šæ‹Ÿè·¯ç”±å™¨ï¼Œå±€åŸŸç½‘å†…çš„ç»ˆç«¯è®¾å¤‡åªéœ€å°†è™šæ‹Ÿè·¯ç”±å™¨é…ç½®ä¸ºç¼ºçœç½‘å…³å³å¯ã€‚VRRPæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼ŒVRRPv2åŸºäºIPv4, VRRPv3åŸºäºIPv6ã€‚æ­£ç»Ÿçš„VRRPå®ç°èµ·æ¥å¯èƒ½æœ‰äº›å¤æ‚ï¼Œé€šè¿‡MLAGç»“åˆVARPå¯ä»¥è¾ƒä¸ºç®€å•çš„å®ç°VRRPçš„åŠŸèƒ½ã€‚æ‹“æ‰‘å¦‚ä¸‹ã€‚<br><img src="https://rancho333.github.io/pictures/varp_mlag_vrrp.png"></p>
<p>åŸç†è¯´æ˜ï¼šdeviceä½œä¸ºleaf switch, ä¸‹è¡Œæ¥hostï¼Œä¸Šè¡Œé€šè¿‡mlagè¿æ¥åˆ°ä¸¤å°ç½‘å…³ã€‚ç­–ç•¥é…ç½®ä¹‹åï¼Œhostå‘å¾€ç½‘å…³çš„æµé‡åªä¼šé€šè¿‡mlagä¸­çš„ä¸€ä¸ªç«¯å£å‘å¾€switch Aæˆ–switch B, å½“mlagä¸­ä¸€æ¡çº¿è·¯downæ‰æ—¶ï¼Œé€šè¿‡å¦ä¸€æ¡çº¿è·¯é€šä¿¡ï¼Œåœ¨switch Aå’Œswitch Bä¸Šè¿è¡ŒVARPåè®®ï¼Œé€šè¿‡é…ç½®ç›¸åŒçš„VIPå’ŒVMACå®ç°ç½‘å…³è™šæ‹ŸåŒ–ã€‚è¿™é‡Œé¢æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ã€‚</p>
<ul>
<li>ä¸»æœºæµé‡åŒä¸€æ—¶é—´åªä¼šå‘å¾€ä¸€å°ç‰©ç†ç½‘å…³</li>
<li>ç‰©ç†ç½‘å…³ä¸Šé…ç½®ç›¸åŒçš„VIPå’ŒVMACå®ç°ç½‘å…³è™šæ‹ŸåŒ–</li>
</ul>
<p>å¯¹äºVARPè¯´æ˜ï¼Œå¯ä»¥é€šè¿‡ipåœ°å€/macåœ°å€ç¡®å®šå”¯ä¸€ä¸‰å±‚æ¥å£ï¼Œä½†æ˜¯ä¸‰å±‚æ¥å£å¯ä»¥è¢«å¤šä¸ªipåœ°å€/macåœ°å€å®šä½åˆ°ã€‚å¯¹äºè™šæ‹Ÿç½‘å…³ï¼Œç‰©ç†ç½‘å…³é™¤äº†æ­£å¸¸é…ç½®çš„ipä¸macåœ°å€ï¼Œè¿˜ä¼šé…ç½®ä¸€ç»„ç›¸åŒçš„vip/vmacï¼Œä¸»æœºå°†vipä½œä¸ºç½‘å…³ipã€‚å¯¹äºç‰©ç†ç½‘å…³ï¼š</p>
<ul>
<li>åªæœ‰å½“ä¸»æœºè¯·æ±‚vipæ—¶æ‰å›å¤vmac</li>
<li>ä¸»åŠ¨å‘é€arpæˆ–è€…è½¬å‘ä¸‰å±‚æŠ¥æ–‡æ—¶ï¼Œsrc macä½¿ç”¨çš„éƒ½æ˜¯è‡ªå·±çœŸå®çš„router mac</li>
</ul>
<p>å¯¹äºä¸»æœºè€Œè¨€ï¼Œç½‘å…³æ˜¯è™šæ‹Ÿçš„ï¼Œæ‰€ä»¥ä½¿ç”¨è™šæ‹Ÿç½‘å…³ipè¿›è¡Œé€šä¿¡<br>å¯¹äºäº¤æ¢æœºè€Œè¨€ï¼Œè‡ªå·±ä¸å¤–ç•Œé€šä¿¡éœ€è¦ä½¿ç”¨è‡ªå·±çœŸå®çš„ipå’Œmac, è¿™æ ·å¯¹æ–¹æ‰èƒ½æ ¹æ®çœŸå®çš„ipå’Œmacå®šä½åˆ°è‡ªå·±ã€‚</p>
<p>å½“MLAGäº¤æ¢æœºé…ç½®äº†VARPä¹‹åï¼Œhosté€šè¿‡arpå»è¯·æ±‚VARPè™šæ‹Ÿç½‘å…³ipçš„macåœ°å€ï¼Œåˆ™MLAG-VARPäº¤æ¢æœºå›åº”çš„è‡ªç„¶æ˜¯è™šæ‹Ÿç½‘å…³çš„mac;hostå‘é€icmp requestç»™è™šæ‹Ÿç½‘å…³ï¼Œè™šæ‹Ÿç½‘å…³ä½¿ç”¨çœŸå®çš„router-macå»å›å¤ã€‚</p>
]]></content>
      <tags>
        <tag>é€šä¿¡åè®®</tag>
      </tags>
  </entry>
  <entry>
    <title>IPSecç®€è¿°</title>
    <url>/2022/08/01/IPSec%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>åœ¨<a href="https://rancho333.github.io/2022/07/29/GRE%E7%AE%80%E8%BF%B0/">GREç®€è¿°</a>ä¸­æè¿°äº†ä¸€ç§vpnçš„å®ç°ï¼Œä½†æ˜¯GREæ²¡æœ‰è®¤è¯ï¼ŒåŠ å¯†ï¼Œæ•°æ®å®Œæ•´æ€§éªŒè¯ç­‰ç‰¹æ€§ï¼Œæ˜¯ä¸€ä¸ªä¸å®‰å…¨çš„å°è£…åè®®ï¼Œæ‰€ä»¥å®é™…ä½¿ç”¨ä¸­éƒ½æ˜¯ç»“åˆIPSecä¸€èµ·ã€‚æœ¬æ–‡ä»‹ç»VPNçš„ç¬¬äºŒç§å¸¸è§å®ç°â€”â€”IPSec.</p>
<span id="more"></span>

<h1 id="IPSecç®€ä»‹"><a href="#IPSecç®€ä»‹" class="headerlink" title="IPSecç®€ä»‹"></a>IPSecç®€ä»‹</h1><p>IPSecé€šè¿‡è®¤è¯å¤´AH(authentication header, åè®®å·51)å’Œå°è£…å®‰å…¨è½½è·ESP(encapsulating security payload)è¿™ä¸¤ä¸ªå®‰å…¨åè®®æ¥å®ç°ã€‚æ­¤å¤–å¯ä»¥é€šè¿‡IKE(internet key exchange)å®Œæˆå¯†é’¥äº¤æ¢ã€‚ä¸€èˆ¬åœºæ™¯ä½¿ç”¨IKEè‡ªåŠ¨ç®¡ç†å¯†é’¥äº¤æ¢ï¼ŒSAå»ºç«‹ï¼Œä½¿ç”¨ESPè¿›è¡ŒæŠ¥æ–‡éªŒè¯å’ŒåŠ å¯†ã€‚</p>
<p>IPSecæœ‰ä¸¤ç§å°è£…æ¨¡å¼ï¼š</p>
<ul>
<li>ä¼ è¾“æ¨¡å¼ï¼šåœ¨ä¼ è¾“æ¨¡å¼ä¸‹ï¼ŒAHæˆ–ESPè¢«æ’å…¥åˆ°IPå¤´ä¹‹åä½†åœ¨æ‰€æœ‰ä¼ è¾“å±‚åè®®ä¹‹å‰ï¼Œæˆ–æ‰€æœ‰å…¶å®ƒIPSecåè®®ä¹‹å‰ã€‚</li>
<li>éš§é“æ¨¡å¼ï¼šåœ¨éš§é“æ¨¡å¼ä¸‹ï¼ŒAHæˆ–ESPæ’åœ¨åŸå§‹IPå¤´ä¹‹å‰ï¼Œå¦å¤–ç”Ÿæˆä¸€ä¸ªæ–°çš„IPå¤´æ”¾åœ¨AHæˆ–ESPä¹‹å‰ã€‚</li>
</ul>
<p>ä¼ è¾“æ¨¡å¼ç”¨äºä¸¤å°ä¸»æœºä¹‹é—´çš„é€šè®¯ï¼Œæˆ–è€…ä¸€å°ä¸»æœºå’Œä¸€ä¸ªå®‰å…¨ç½‘å…³ä¹‹é—´çš„é€šè®¯ã€‚åœ¨ä¼ è¾“æ¨¡å¼ä¸‹ï¼Œå¯¹æŠ¥æ–‡åŠ å¯†å’Œè§£å¯†çš„ä¸¤å°è®¾å¤‡æœ¬èº«å¿…é¡»æ˜¯æŠ¥æ–‡çš„åŸå§‹å‘é€è€…å’Œæœ€ç»ˆæ¥æ”¶è€…ã€‚</p>
<p>é€šå¸¸ï¼Œåœ¨ä¸¤ä¸ªå®‰å…¨ç½‘å…³ä¹‹é—´çš„æ•°æ®æµé‡ï¼Œç»å¤§éƒ¨åˆ†éƒ½ä¸æ˜¯å®‰å…¨ç½‘å…³æœ¬èº«çš„æµé‡ï¼Œå› æ­¤å®‰å…¨ç½‘å…³ä¹‹é—´ä¸€èˆ¬ä¸ä½¿ç”¨ä¼ è¾“æ¨¡å¼ï¼Œè€Œæ˜¯ä½¿ç”¨éš§é“æ¨¡å¼ã€‚åœ¨ä¸€ä¸ªå®‰å…¨ç½‘å…³è¢«åŠ å¯†çš„æŠ¥æ–‡ï¼Œåªæœ‰å¦ä¸€ä¸ªå®‰å…¨ç½‘å…³æ‰èƒ½è¢«è§£å¯†ã€‚</p>
<p>IPSecçš„ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½åˆ†åˆ«æ˜¯<em>åŠ å¯†</em>å’Œ<em>è®¤è¯</em>ï¼Œipsecä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä¸»è¦åŒ…æ‹¬DESã€3DESå’ŒAESã€‚å¯¹äºè®¤è¯ï¼Œåœ¨å‘é€æ¶ˆæ¯ä¹‹å‰ä¼šå…ˆä½¿ç”¨éªŒè¯ç®—æ³•å’ŒéªŒè¯å¯†é’¥å¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¾—åˆ°æŠ¥æ–‡æ‘˜è¦ï¼›å¦ä¸€æ–¹æ”¶åˆ°æ¶ˆæ¯ååŒæ ·è®¡ç®—æ‘˜è¦ï¼Œç„¶åå¯¹æ¯”ä¸¤ç«¯çš„æ‘˜è¦ï¼Œå¦‚æœç›¸åŒåˆ™æ¶ˆæ¯æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚å¸¸ç”¨çš„éªŒè¯ç®—æ³•æœ‰MD5å’ŒSHAç³»åˆ—ã€‚</p>
<p>AH(IPåè®®å·51)å¯æä¾›æ•°æ®æºéªŒè¯å’Œæ•°æ®å®Œæ•´æ€§æ ¡éªŒåŠŸèƒ½ï¼›<br>ESP(IPåè®®å·50)é™¤æä¾›æ•°æ®æºéªŒè¯å’Œæ•°æ®å®Œæ•´æ€§æ ¡éªŒåŠŸèƒ½å¤–ï¼Œè¿˜æä¾›å¯¹IPæŠ¥æ–‡çš„åŠ å¯†åŠŸèƒ½ã€‚ESPçš„å·¥ä½œåŸç†æ˜¯åœ¨æ¯ä¸€ä¸ªæ•°æ®åŒ…çš„æ ‡å‡†IPåŒ…å¤´åé¢æ·»åŠ ä¸€ä¸ªESPæŠ¥æ–‡å¤´ï¼Œå¹¶åœ¨æ•°æ®åŒ…åé¢è¿½åŠ ä¸€ä¸ªESPå°¾ã€‚ä¸AHåè®®ä¸åŒçš„æ˜¯ï¼ŒESPå°†éœ€è¦ä¿æŠ¤çš„æŠ¥æ–‡è¿›è¡ŒåŠ å¯†åå†å°è£…åˆ°IPåŒ…ä¸­ï¼Œä»¥ä¿è¯æ•°æ®çš„æœºå¯†æ€§ã€‚</p>
<p>ä¸¤è€…å‡å¯å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä¸€èµ·é…åˆä½¿ç”¨ã€‚å„è‡ªä½œç”¨èŒƒå›´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/ipsec_range.png"></p>
<p>å¯è§ï¼ŒAHæä¾›çš„è®¤è¯æœåŠ¡è¦å¼ºäºESPï¼ŒåŒæ—¶ä½¿ç”¨AHå’ŒESPæ—¶ï¼Œè®¾å¤‡æ”¯æŒçš„AHå’ŒESPè”åˆä½¿ç”¨æ–¹å¼ä¸ºï¼šå…ˆå¯¹æŠ¥æ–‡è¿›è¡ŒESPå°è£…ï¼Œå†å¯¹æŠ¥æ–‡è¿›è¡ŒAHå°è£…ï¼Œå°è£…ä¹‹åçš„æŠ¥æ–‡ä»å†…åˆ°å¤–ä¸€æ¬¡æ˜¯åŸå§‹IPæŠ¥æ–‡ï¼ŒESPæŠ¥æ–‡å¤´ï¼ŒAHæŠ¥æ–‡å¤´å’Œå¤–éƒ¨IPå¤´ã€‚</p>
<p>IPSecé™¤äº†èƒ½ä¸ºå…¶å®ƒéš§é“åè®®æä¾›æ•°æ®ä¿æŠ¤å¤–ï¼ŒIPSecä¹Ÿå¯è‡ªå·±å•ç‹¬ä½œä¸ºéš§é“åè®®æ¥æä¾›éš§é“çš„å»ºç«‹ã€‚å¦‚æœIPSecè‡ªå·±å•ç‹¬ä½œä¸ºéš§é“åè®®æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆIPsecå°±ä¸éœ€è¦ä»»ä½•å…¶å®ƒéš§é“åè®®å°±èƒ½ç‹¬ç«‹å®ç°VPNåŠŸèƒ½ã€‚è¿™ä¸¤ç§ä½¿ç”¨æ–¹å¼ç”±ç®¡ç†å‘˜çš„é…ç½®æ¥å†³å®šã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒIPSecç›®å‰åªæ”¯æŒipv4å•æ’­ã€‚</p>
<p>IPSecé€šè¿‡å®šä¹‰ä¸€äº›æ–¹æ³•æ¥ä¿æŠ¤ç‰¹å®šçš„IPæ•°æ®æŠ¥ï¼Œè¿™äº›æµé‡å¦‚ä½•è¢«ä¿æŠ¤ï¼Œè¿˜æœ‰æµé‡å‘ç»™è°ã€‚</p>
<h3 id="å®‰å…¨è”ç›Ÿ"><a href="#å®‰å…¨è”ç›Ÿ" class="headerlink" title="å®‰å…¨è”ç›Ÿ"></a>å®‰å…¨è”ç›Ÿ</h3><p>IPSecåœ¨ä¸¤ä¸ªç«¯ç‚¹ä¹‹é—´æä¾›å®‰å…¨é€šä¿¡ï¼Œç«¯ç‚¹è¢«ç§°ä¸ºIPSecå¯¹ç­‰ä½“ã€‚<br>IPSecä¸­é€šä¿¡åŒæ–¹å»ºç«‹çš„è¿æ¥å«åšå®‰å…¨è”ç›Ÿ(security association)ï¼Œé¡¾åæ€ä¹‰ï¼Œé€šä¿¡åŒæ–¹ç»“æˆç›Ÿå‹ï¼Œä½¿ç”¨ç›¸åŒçš„åè®®(AHã€ESPè¿˜æ˜¯ä¸¤è€…ç»“åˆ)ã€å°è£…æ¨¡å¼(ä¼ è¾“æ¨¡å¼è¿˜æ˜¯éš§é“æ¨¡å¼)ã€åŠ å¯†ç®—æ³•(DESã€3DESã€AES)ã€åŠ å¯†å¯†é’¥ã€éªŒè¯ç®—æ³•ã€éªŒè¯å¯†é’¥ã€å¯†é’¥å‘¨æœŸã€‚SAæ˜¯IPSecçš„åŸºç¡€ï¼Œä¹Ÿæ˜¯IPSecçš„<em>æœ¬è´¨</em>. SAå¹¶ä¸æ˜¯éš§é“ï¼Œå½¢è±¡çš„è¯´æ˜¯ä¸€ä»½åˆçº¦ï¼Œåå•†åŒæ–¹å…±åŒéµå®ˆçš„åˆçº¦ã€‚</p>
<p>å»ºç«‹SAçš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œæ‰‹å·¥é…ç½®å’ŒIKEè‡ªåŠ¨åå•†ã€‚</p>
<p>å®‰å…¨è”ç›Ÿæ˜¯å•å‘çš„é€»è¾‘è¿æ¥ï¼Œåœ¨ä¸¤ä¸ªå¯¹ç­‰ä½“ä¹‹é—´çš„åŒå‘é€šä¿¡ï¼Œæœ€å°‘éœ€è¦ä¸¤ä¸ªSAæ¥åˆ†åˆ«å¯¹ä¸¤ä¸ªæ–¹å‘çš„æ•°æ®æµè¿›è¡Œå®‰å…¨ä¿æŠ¤ã€‚åŒæ—¶ï¼Œå¦‚æœä¸¤ä¸ªå¯¹ç­‰ä½“å¸Œæœ›åŒæ—¶ä½¿ç”¨AHå’ŒESPæ¥è¿›è¡Œå®‰å…¨é€šä¿¡ï¼Œåˆ™æ¯ä¸ªå¯¹ç­‰ä½“éƒ½ä¼šé’ˆå¯¹æ¯ä¸€ç§åè®®æ¥æ„å»ºä¸€ä¸ªç‹¬ç«‹çš„SAã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/ipsec_security.png"></p>
<p>SAç”±ä¸€ä¸ªä¸‰å…ƒç»„æ¥å”¯ä¸€æ ‡è¯†ï¼Œè¿™ä¸ªä¸‰å…ƒç»„åŒ…æ‹¬SPI(security parameter index, å®‰å…¨å‚æ•°ç´¢å¼•)ã€ç›®çš„IPåœ°å€ã€å®‰å…¨åè®®å·(AHæˆ–ESP)ã€‚</p>
<p>SPIæ˜¯ç”¨äºå”¯ä¸€æ ‡è¯†SAçš„ä¸€ä¸ª32æ¯”ç‰¹æ•°å€¼ï¼Œä»–åœ¨AHå’ŒESPå¤´ä¸­ä¼ è¾“ã€‚åœ¨æ‰‹å·¥é…ç½®SAæ—¶ï¼Œéœ€è¦æ‰‹å·¥æŒ‡å®šSPIçš„å–å€¼ã€‚ä½¿ç”¨IKEåå•†äº§ç”ŸSAæ—¶ï¼ŒSPIå°†éšæœºç”Ÿæˆã€‚</p>
<p>é€šè¿‡IKEåå•†å»ºç«‹çš„SAå…·æœ‰ç”Ÿå­˜å‘¨æœŸï¼Œæ‰‹å·¥æ–¹å¼å»ºç«‹çš„SAæ°¸ä¸è€åŒ–ã€‚IKEåå•†å»ºç«‹çš„SAçš„ç”Ÿå­˜å‘¨æœŸæœ‰ä¸¤ç§å®šä¹‰æ–¹å¼ï¼š</p>
<ul>
<li>åŸºäºæ—¶é—´çš„ç”Ÿå­˜å‘¨æœŸï¼Œå®šä¹‰äº†ä¸€ä¸ªSAä»å»ºç«‹åˆ°å¤±æ•ˆçš„æ—¶é—´</li>
<li>åŸºäºæµé‡çš„ç”Ÿå­˜å‘¨æœŸï¼Œå®šä¹‰äº†ä¸€ä¸ªSAå…è®¸å¤„ç†çš„æœ€å¤§æµé‡</li>
</ul>
<p>ç”Ÿå­˜å‘¨æœŸåˆ°è¾¾æŒ‡å®šçš„æ—¶é—´æˆ–æŒ‡å®šçš„æµé‡ï¼ŒSAå°±ä¼šå¤±æ•ˆã€‚SAå¤±æ•ˆå‰ï¼ŒIKEå°†ä¸ºIPSecåå•†å»ºç«‹æ–°çš„SAï¼Œè¿™æ ·ï¼Œåœ¨æ—§çš„SAå¤±æ•ˆå‰æ–°çš„SAå°±å·²ç»å‡†å¤‡å¥½äº†ã€‚</p>
<p>å»ºç«‹å®‰å…¨è”ç›Ÿæœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯åˆ†åˆ«åœ¨ä¸¤ç«¯è®¤ä¸ºè®¾å®šå¥½å°è£…æ¨¡å¼ã€åŠ å¯†ç®—æ³•ã€åŠ å¯†å¯†é’¥ã€éªŒè¯ç®—æ³•ã€éªŒè¯å¯†é’¥ã€‚</p>
<h3 id="IPSecè™šæ‹Ÿéš§é“æ¥å£"><a href="#IPSecè™šæ‹Ÿéš§é“æ¥å£" class="headerlink" title="IPSecè™šæ‹Ÿéš§é“æ¥å£"></a>IPSecè™šæ‹Ÿéš§é“æ¥å£</h3><p>IPSecè™šæ‹Ÿéš§é“æ¥å£æ˜¯ä¸€ç§æ”¯æŒè·¯ç”±çš„ä¸‰å±‚é€»è¾‘æ¥å£ï¼Œå®ƒå¯ä»¥æ”¯æŒåŠ¨æ€è·¯ç”±åè®®ï¼Œæ‰€æœ‰è·¯ç”±åˆ°IPSecè™šæ‹Ÿéš§é“æ¥å£çš„æŠ¥æ–‡éƒ½å°†è¿›è¡ŒIPSecä¿æŠ¤ï¼ŒåŒæ—¶è¿˜å¯ä»¥æ”¯æŒå¯¹ç»„æ’­æµé‡çš„ä¿æŠ¤ï¼Œå’Œå®ç°GREçš„tunnelæ¥å£ç±»ä¼¼ã€‚ä½¿ç”¨è™šæ‹Ÿéš§é“æ¥å£æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç®€åŒ–é…ç½®ï¼šé€šè¿‡è·¯ç”±æ¥ç¡®å®šé‚£äº›æ•°æ®æµè¿›è¡ŒIPSecä¿æŠ¤ã€‚</li>
<li>å‡å°‘å¼€é”€ï¼šåœ¨ä¿æŠ¤è¿œç¨‹æ¥å…¥ç”¨æˆ·æµé‡çš„ç»„ç½‘åº”ç”¨ä¸­ï¼Œåœ¨IPSecè™šæ‹Ÿéš§é“æ¥å£å¤„è¿›è¡ŒæŠ¥æ–‡å°è£…ï¼Œä¸IPSec over GREæˆ–è€…IPSec over L2TPæ–¹å¼çš„éš§é“å°è£…ç›¸æ¯”ï¼Œæ— éœ€é¢å¤–ä¸ºå…¥éš§é“æµé‡åŠ å°è£…GREæˆ–è€…L2TPå¤´ï¼Œå‡å°‘äº†æŠ¥æ–‡å°è£…å±‚æ¬¡ï¼ŒèŠ‚çœäº†å¸¦å®½ã€‚</li>
<li>ä¸šåŠ¡åº”ç”¨æ›´åŠ çµæ´»ï¼šIPsecè™šæ‹Ÿéš§é“æ¥å£åœ¨å®æ–½è¿‡ç¨‹ä¸­æ˜ç¡®åœ°åŒºåˆ†å‡ºâ€œåŠ å¯†å‰â€å’Œâ€œåŠ å¯†åâ€ä¸¤ä¸ªé˜¶æ®µï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®ä¸åŒçš„ç»„ç½‘éœ€æ±‚çµæ´»é€‰æ‹©å…¶å®ƒä¸šåŠ¡ï¼ˆä¾‹å¦‚NATã€QoSï¼‰å®æ–½çš„é˜¶æ®µã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·å¸Œæœ›å¯¹IPsecå°è£…å‰çš„æŠ¥æ–‡åº”ç”¨QoSï¼Œåˆ™å¯ä»¥åœ¨IPsecè™šæ‹Ÿéš§é“æ¥å£ä¸Šåº”ç”¨QoSç­–ç•¥ï¼›å¦‚æœå¸Œæœ›å¯¹IPsecå°è£…åçš„æŠ¥æ–‡åº”ç”¨QoSï¼Œåˆ™å¯ä»¥åœ¨ç‰©ç†æ¥å£ä¸Šåº”ç”¨QoSç­–ç•¥ã€‚</li>
</ul>
<p>ä½¿ç”¨IPSecè™šæ‹Ÿéš§é“å£å°è£…è§£å°è£…æŠ¥æ–‡å¦‚å›¾æ‰€ç¤ºï¼š<br><img src="https://rancho333.github.io/pictures/ipsec_enca.png"></p>
<h3 id="IKE"><a href="#IKE" class="headerlink" title="IKE"></a>IKE</h3><p>åœ¨å®æ–½IPSecçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨IKE(internet key exchange)åè®®æ¥å»ºç«‹SA<br>IKEæ˜¯ä¸ªæ··ä¸ªåè®®ï¼Œå…¶ä¸­åŒ…å«éƒ¨åˆ†Oakleyåè®®ï¼Œå†…ç½®åœ¨ISAKMP(internet security association and key management protocol)åè®®ä¸­çš„éƒ¨åˆ†SKEMEåè®®ï¼Œæ‰€ä»¥IKEä¹Ÿå¯ä»¥å†™ä¸ºISAKMP/Oakleyï¼Œå®ƒæ˜¯é’ˆå¯¹å¯†é’¥å®‰å…¨ï¼Œç”¨æ¥ä¿è¯å¯†é’¥çš„å®‰å…¨ä¼ è¾“ã€äº¤æ¢ä»¥åŠå­˜å‚¨ï¼Œä¸»è¦æ˜¯å¯¹å¯†é’¥è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸å¯¹ç”¨æˆ·çš„å®é™…æ•°æ®è¿›è¡Œæ“ä½œã€‚</p>
<p>IKEä¸æ˜¯åœ¨ç½‘ç»œä¸Šç›´æ¥ä¼ è¾“å¯†é’¥ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç³»åˆ—æ•°æ®çš„äº¤æ¢ï¼Œæœ€ç»ˆè®¡ç®—å‡ºåŒæ–¹å…±äº«çš„å¯†é’¥ï¼Œå¹¶ä¸”å³ä½¿ç¬¬ä¸‰è€…æˆªè·äº†åŒæ–¹ç”¨äºè®¡ç®—å¯†é’¥çš„æ‰€æœ‰äº¤æ¢æ•°æ®ï¼Œä¹Ÿä¸è¶³ä»¥è®¡ç®—å‡ºçœŸæ­£çš„å¯†é’¥ã€‚</p>
<p>IKEå…·æœ‰ä¸€å¥—è‡ªä¿æŠ¤æœºåˆ¶ï¼Œå¯ä»¥åœ¨ä¸å®‰å…¨çš„ç½‘ç»œä¸Šå®‰å…¨çš„è®¤è¯èº«ä»½ã€åˆ†å‘å¯†é’¥ã€å»ºç«‹IPSec SAã€‚</p>
<p>æ•°æ®è®¤è¯æœ‰å¦‚ä¸‹ä¸¤æ–¹é¢æ¦‚å¿µï¼š</p>
<ul>
<li>èº«ä»½è®¤è¯ï¼šèº«ä»½è®¤è¯ç¡®è®¤é€šä¿¡åŒæ–¹çš„èº«ä»½ã€‚æ”¯æŒä¸¤ç§è®¤è¯æ–¹æ³•ï¼šé¢„å…±äº«å¯†é’¥(pre-shared-key)è®¤è¯åŸºäºPKIçš„æ•°å­—ç­¾å(rsa-signature)è®¤è¯ã€‚</li>
<li>èº«ä»½ä¿æŠ¤ï¼šèº«ä»½æ•°æ®åœ¨å¯†é’¥äº§ç”Ÿä¹‹ååŠ å¯†ä¼ é€ï¼Œå®ç°äº†å¯¹èº«ä»½æ•°æ®çš„ä¿æŠ¤ã€‚</li>
</ul>
<p>DH(Diffie-Hellmanï¼Œäº¤æ¢åŠå¯†é’¥åˆ†å‘)ç®—æ³•æ˜¯ä¸€ç§å…¬å…±å¯†é’¥ç®—æ³•ã€‚é€šä¿¡åŒæ–¹åœ¨ä¸ä¼ è¾“å¯†é’¥çš„æƒ…å†µä¸‹é€šè¿‡äº¤æ¢ä¸€äº›æ•°æ®ï¼Œè®¡ç®—å‡ºå…±äº«çš„å¯†é’¥ã€‚å³ä½¿ç¬¬ä¸‰è€…æˆªè·äº†åŒæ–¹ç”¨äºè®¡ç®—å¯†é’¥çš„æ‰€æœ‰äº¤æ¢æ•°æ®ï¼Œç”±äºå…¶å¤æ‚åº¦å¾ˆé«˜ï¼Œä¸è¶³ä»¥è®¡ç®—å‡ºçœŸæ­£çš„å¯†é’¥ã€‚æ‰€ä»¥ï¼ŒDHäº¤æ¢æŠ€æœ¯å¯ä»¥ä¿è¯åŒæ–¹èƒ½å¤Ÿå®‰å…¨åœ°è·å¾—å…¬æœ‰ä¿¡æ¯ã€‚</p>
<p>PFS(perfect forward secrecyï¼Œå®Œå–„çš„å‰å‘å®‰å…¨æ€§)ç‰¹æ€§æ˜¯ä¸€ç§å®‰å…¨ç‰¹æ€§ï¼ŒæŒ‡ä¸€ä¸ªå¯†é’¥è¢«ç ´è§£ï¼Œå¹¶ä¸å½±å“å…¶å®ƒå¯†é’¥çš„å®‰å…¨æ€§ï¼Œå› ä¸ºè¿™äº›å¯†é’¥ä¹‹é—´æ²¡æœ‰æ´¾ç”Ÿå…³ç³»ã€‚å¯¹äºIPSecï¼Œæ˜¯é€šè¿‡åœ¨IKEé˜¶æ®µ2åå•†ä¸­å¢åŠ ä¸€æ¬¡å¯†é’¥äº¤æ¢æ¥å®ç°çš„ã€‚PFSç‰¹æ€§æ—¶DHç®—æ³•ä¿éšœçš„ã€‚</p>
<p>IKEçš„äº¤æ¢è¿‡ç¨‹ï¼š<br>é€šè¿‡IKEæ–¹å¼å»ºç«‹çš„SAå®é™…æœ‰ä¸¤ç»„ï¼Œåˆ†åˆ«ä¸ºIKE SAå’ŒIPSec SA, ä¸¤ä¸ªSAåˆ†åˆ«å®šä¹‰äº†å¦‚ä½•ä¿æŠ¤å¯†é’¥åŠå¦‚ä½•ä¿æŠ¤æ•°æ®ï¼Œå…¶å®è¿™ä¸¤ä¸ªSAéƒ½æ˜¯IKEå»ºç«‹èµ·æ¥çš„ï¼Œæ‰€ä»¥IKEçš„æ•´ä¸ªè¿è¡Œè¿‡ç¨‹æ‹†åˆ†æˆä¸¤ä¸ªphaseã€‚</p>
<ul>
<li><p>phase oneï¼šé€šä¿¡å„æ–¹å½¼æ­¤é—´å»ºç«‹ä¸€ä¸ªå·²é€šè¿‡èº«ä»½è®¤è¯å’Œå®‰å…¨ä¿æŠ¤çš„é€šé“ï¼Œå³å»ºç«‹ä¸€ä¸ªISAKMP SAã€‚ç¬¬ä¸€é˜¶æ®µæœ‰ä¸»æ¨¡å¼(main mode)å’Œé‡è›®æ¨¡å¼(aggressive mode)ä¸¤ç§IKEäº¤æ¢æ–¹å¼ã€‚åå•†çš„å®‰å…¨ç­–ç•¥åŒ…æ‹¬ï¼š</p>
<ul>
<li>è®¤è¯æ–¹å¼(authentication)ï¼špre-shard keys, public key infrastructureï¼ŒRSA encrypted nonceï¼Œé»˜è®¤æ˜¯PKI</li>
<li>åŠ å¯†ç®—æ³•ï¼šåŠ å¯†æ•°æ®</li>
<li>Hashç®—æ³•(HMAC)ï¼šç”Ÿæˆæ‘˜è¦ï¼Œå®Œæ•´æ€§è®¤è¯</li>
<li>å¯†é’¥ç®—æ³•ï¼šè®¡ç®—å¯†é’¥çš„æ–¹å¼</li>
<li>lifetime</li>
<li>NATç©¿è¶Š(NAT traversal): é»˜è®¤å¼€å¯ï¼Œæ— é¡»æ‰‹å·¥é…ç½®</li>
</ul>
</li>
<li><p>phase twoï¼šç”¨åœ¨ç¬¬ä¸€é˜¶æ®µå»ºç«‹çš„å®‰å…¨éš§é“ä¸ºIPSecåå•†å®‰å…¨æœåŠ¡ï¼Œå³ä¸ºIPSecåå•†å…·ä½“çš„SAï¼Œå»ºç«‹æœ€ç»ˆçš„IPæ•°æ®å®‰å…¨ä¼ è¾“çš„IPSec SAã€‚åŒæ ·éœ€è¦åå•†å‡ºä¸€å¥—å®‰å…¨ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>åŠ å¯†ç®—æ³•</li>
<li>hashç®—æ³•(HMAC)</li>
<li>lifetime</li>
<li>IPSec modeï¼štunnel modeå’Œtransport modeï¼Œé»˜è®¤æ˜¯tunnel modeå’Œtransport</li>
</ul>
</li>
</ul>
<p>ä»ä¸Šå¯çœ‹å‡ºIPSec SAä¸­æ²¡æœ‰åå•†è®¤è¯æ–¹å¼å’Œå¯†é’¥ç®—æ³•ï¼Œå› ä¸ºIKE SAä¸­å·²ç»è®¤è¯è¿‡äº†ï¼Œæ‰€ä»¥åé¢ä¸éœ€è¦å†è®¤è¯ï¼Œå¹¶ä¸”å¯†é’¥æ˜¯åœ¨IKE SAå·²ç»å®Œæˆçš„ã€‚</p>
<p>IPSecä¸IKEçš„å…³ç³»å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/ipsec_ike.png"></p>
<ul>
<li>IKEæ˜¯UDPä¹‹ä¸Šçš„ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œæ˜¯IPSecçš„ä¿¡ä»¤åè®®</li>
<li>IKEä¸ºIPSecåå•†å»ºç«‹SAï¼Œå¹¶æŠŠå»ºç«‹çš„å‚æ•°åŠç”Ÿæˆçš„å¯†é’¥äº¤ç»™IPSec</li>
<li>IPSecä½¿ç”¨IKEå»ºç«‹çš„SAå¯¹IPæŠ¥æ–‡åŠ å¯†æˆ–è®¤è¯å¤„ç†</li>
</ul>
<h1 id="IPSecå®éªŒ"><a href="#IPSecå®éªŒ" class="headerlink" title="IPSecå®éªŒ"></a>IPSecå®éªŒ</h1><h2 id="IOSä¸­å…³äºIPSecçš„ä¸€äº›é…ç½®æ¦‚å¿µ"><a href="#IOSä¸­å…³äºIPSecçš„ä¸€äº›é…ç½®æ¦‚å¿µ" class="headerlink" title="IOSä¸­å…³äºIPSecçš„ä¸€äº›é…ç½®æ¦‚å¿µ"></a>IOSä¸­å…³äºIPSecçš„ä¸€äº›é…ç½®æ¦‚å¿µ</h2><ul>
<li><p>transform set<br>transform setæ˜¯ä¸€ç»„ç®—æ³•é›†åˆï¼Œé€šè¿‡å®ƒæ¥å®šä¹‰ä½¿ç”¨æ€æ ·çš„ç®—æ³•æ¥å°è£…æ•°æ®åŒ…ï¼Œæ¯”å¦‚ä¹‹å‰æ‰€è¯´çš„ESPå°è£…ï¼ŒAHå°è£…éƒ½éœ€è¦é€šè¿‡transform setæ¥å®šä¹‰ï¼Œè¿˜å¯ä»¥å®šä¹‰å…¶å®ƒä¸€äº›åŠ å¯†ç®—æ³•ä»¥åŠHMACç®—æ³•ã€‚é€šè¿‡transform setï¼Œå°±å¯ä»¥è®©ç”¨æˆ·æ¥é€‰æ‹©ä¿æŠ¤æ•°æ®çš„å¼ºåº¦ï¼Œå› æ­¤transform setå°±æ˜¯å®šä¹‰æ•°æ®åŒ…æ˜¯å—åˆ°æ€æ ·çš„ä¿æŠ¤ã€‚ä¹Ÿå°±æ˜¯ipsecçš„åŠ å¯†ã€å®Œæ•´æ€§ç®—æ³•ï¼Œä»¥åŠipsecçš„æ¨¡å¼ã€‚</p>
</li>
<li><p>crypto isakmp<br>  å®šä¹‰IKE SAçš„åå•†å‚æ•°</p>
</li>
<li><p>crypto map<br>Crypto mapæ˜¯æ€ç§‘çš„IOSä¸­é…ç½®IPSecçš„ç»„ä»¶ï¼Œæ‰§è¡Œä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li>é€‰æ‹©éœ€è¦åŠ å¯†å¤„ç†çš„æ•°æ®ï¼ˆé€šè¿‡ACLåŒ¹é…ï¼‰</li>
<li>å®šä¹‰æ•°æ®åŠ å¯†çš„ç­–ç•¥ä»¥åŠæ•°æ®å‘å¾€çš„å¯¹ç«¯<br>crypto mapå°†ä¹‹å‰å®šä¹‰å¥½çš„transform setå’Œisakmpç»‘å®šèµ·æ¥ï¼Œå½¢æˆå®Œæ•´çš„ipsecé…ç½®ï¼Œåº”ç”¨åˆ°æ¥å£å°±å®Œæˆé…ç½®äº†ã€‚</li>
</ul>
</li>
</ul>
<p>crypto mapä¸­çš„ç­–ç•¥æ˜¯åˆ†ç»„å­˜æ”¾çš„ï¼Œä»¥åºå·åŒºåˆ†ï¼Œå¦‚æœä¸€ä¸ªcrypto mapæœ‰å¤šä¸ªç­–ç•¥ç»„ï¼Œåˆ™æœ€ä½å·ç çš„ç»„æœ‰é™ã€‚å½“é…ç½®å®Œcrypto mapåï¼Œéœ€è¦åº”ç”¨åˆ°æ¥å£ä¸Šæ‰èƒ½ç”Ÿæ•ˆï¼Œå¹¶ä¸”ä¸€ä¸ªæ¥å£åªèƒ½åº”ç”¨ä¸€ä¸ªcrypto map.</p>
<p>crypto mapè¿˜åˆ†ä¸ºé™æ€mapå’ŒåŠ¨æ€mapï¼Œç®€å•åŒºåˆ†ï¼Œå°±æ˜¯æ•°æ®å‘å¾€çš„å¯¹ç«¯æ˜¯å¦å›ºå®šï¼Œå¦‚æœæ˜¯åŠ¨æ€mapï¼Œé‚£ä¹ˆå¯¹ç«¯æ˜¯ä¸å›ºå®šçš„ï¼Œåœ¨å­˜åœ¨éš§é“æ—¶ï¼Œä¹Ÿå°±è¡¨ç¤ºéš§é“çš„ç»ˆç‚¹æ—¶ä¸å›ºå®šçš„ï¼Œä½†æºå§‹ç»ˆæ˜¯è‡ªå·±ã€‚</p>
<h2 id="evengä»¿çœŸå®éªŒ"><a href="#evengä»¿çœŸå®éªŒ" class="headerlink" title="evengä»¿çœŸå®éªŒ"></a>evengä»¿çœŸå®éªŒ</h2><p>IPSec vpné…ç½®æ—¶ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š</p>
<ul>
<li>é…ç½®IKE(ISAKMP)ç­–ç•¥</li>
<li>å®šä¹‰è®¤è¯æ ‡è¯†</li>
<li>é…ç½®IPSec transform</li>
<li>å®šä¹‰æ„Ÿå…´è¶£æµé‡</li>
<li>åˆ›å»ºcrypto map</li>
<li>å°†crypto mapåº”ç”¨äºæ¥å£</li>
</ul>
<p>å®éªŒæ‹“æ‰‘å¦‚å›¾æ‰€ç¤º(lan-to-lan vpn)ï¼š<br><img src="https://rancho333.github.io/pictures/ipsec_topology.png"></p>
<p>æ‹“æ‰‘è¯´æ˜å¦‚ä¸‹ï¼š<br>vpc4å’Œvpc5åˆ†åˆ«å±äºä¸¤ä¸ªç§ç½‘ï¼Œç½‘å…³åˆ†åˆ«æŒ‡å‘R1å’ŒR3, R2ä»¿çœŸinternet, R2ä¸Šä¸é…ç½®ä»»ä½•è·¯ç”±ï¼Œåªè´Ÿè´£å’ŒR1ã€R3ä¹‹é—´ç›´è¿é“¾è·¯çš„é€šä¿¡ã€‚R1å’ŒR3ä¸Šé…ç½®é»˜è®¤è·¯ç”±æŒ‡å‘R2ã€‚å› ä¸ºR2ä¸Šæ²¡æœ‰VPC4ã€VPC5ç½‘æ®µçš„è·¯ç”±ï¼Œæ‰€ä»¥ä¸¤è€…ä¹‹é—´ä¸é€šã€‚</p>
<p>åŸºç¡€ç½‘ç»œç¯å¢ƒé…ç½®å¦‚ä¸‹(ipå’Œé»˜è®¤è·¯ç”±)ï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">VPC4</a></li><li class="tab"><a href="#tab-2">R1</a></li><li class="tab"><a href="#tab-3">R2</a></li><li class="tab"><a href="#tab-4">R3</a></li><li class="tab"><a href="#tab-5">VPC5</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPC4&gt; show</span><br><span class="line"></span><br><span class="line">NAME   IP&#x2F;MASK              GATEWAY                             GATEWAY</span><br><span class="line">VPC4   14.1.1.4&#x2F;24          14.1.1.1</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 14.1.1.1 255.255.255.0</span><br><span class="line">!</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 12.1.1.2       &#x2F;&#x2F; é»˜è®¤è·¯ç”±æŒ‡å‘internet</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-3"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 12.1.1.2 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 23.1.1.2 255.255.255.0</span><br><span class="line">!</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-4"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 23.1.1.3 255.255.255.0</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 35.1.1.3 255.255.255.0</span><br><span class="line">!</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 23.1.1.2       &#x2F;&#x2F; é»˜è®¤è·¯ç”±æŒ‡å‘internet</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-5"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPC5&gt; show</span><br><span class="line"></span><br><span class="line">NAME   IP&#x2F;MASK              GATEWAY                             GATEWAY</span><br><span class="line">VPC5   35.1.1.5&#x2F;24          35.1.1.3</span><br></pre></td></tr></table></figure></div></div></div>

<p>æ£€æµ‹ç½‘ç»œçš„è¿é€šæ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPC5&gt; ping 35.1.1.3 -c 1</span><br><span class="line"></span><br><span class="line">84 bytes from 35.1.1.3 icmp_seq&#x3D;1 ttl&#x3D;255 time&#x3D;0.356 ms</span><br><span class="line"></span><br><span class="line">VPC5&gt; ping 23.1.1.2 -c 1</span><br><span class="line"></span><br><span class="line">23.1.1.2 icmp_seq&#x3D;1 timeout         &#x2F;&#x2F; R2ä¸Šæ²¡æœ‰VPC5çš„å›ç¨‹è·¯ç”±ï¼Œæ‰€ä»¥ä¸é€š</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥é…ç½®IPSec vpnï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab active"><a href="#tab-1">R1</a></li><li class="tab"><a href="#tab-2">R3</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-1"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; é…ç½®IKE SAç­–ç•¥</span><br><span class="line">crypto isakmp policy 1            &#x2F;&#x2F; ç­–ç•¥ä¼˜å…ˆçº§</span><br><span class="line"> encr 3des                         &#x2F;&#x2F; åŠ å¯†æ–¹å¼</span><br><span class="line"> hash md5                           &#x2F;&#x2F; æŠ¥æ–‡æ‘˜è¦ç®—æ³•ï¼ŒæŠ¥æ–‡å®Œæ•´æ€§éªŒè¯</span><br><span class="line"> authentication pre-share           &#x2F;&#x2F; è®¤è¯æ–¹å¼</span><br><span class="line"> group 2                            &#x2F;&#x2F; å¯†é’¥ç®—æ³•</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å®šä¹‰è®¤è¯æ ‡è¯†</span><br><span class="line">crypto isakmp key 0 rancho address 23.1.1.3       &#x2F;&#x2F; å› ä¸ºè®¤è¯æ–¹å¼ä¸ºpre-share, æ‰€ä»¥éœ€è¦å®šä¹‰è®¤è¯å¯†ç ï¼Œæ­¤å¤„å¯†ç ä¸º&#96;rancho&#96;ï¼Œ å¯¹ç«¯åœ°å€ä¸º23.1.1.3ï¼ŒåŒæ–¹å¯†ç å¿…é¡»ä¸€è‡´ã€‚0è¡¨ç¤ºå¯†ç åœ¨show runä¸­æ˜æ–‡æ˜¾ç¤º</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  å®šä¹‰ ipsec transform</span><br><span class="line">crypto ipsec transform-set rancho esp-3des esp-sha-hmac     &#x2F;&#x2F; transformç»„åå­—ä¸º&#96;rancho&#96;ï¼Œåªé‡‡ç”¨espåè®®åŠ å¯†è®¤è¯ï¼ŒåŠ å¯†æ–¹å¼ä¸º3desï¼Œæ ¡éªŒæ–¹å¼ä¸ºsha-hmac</span><br><span class="line"> mode tunnel            &#x2F;&#x2F; IPSecé»˜è®¤æ¨¡å¼å°±æ˜¯tunnelï¼Œä¸éœ€è¦é…ç½®</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å®šä¹‰æ„Ÿå…´è¶£çš„æ•°æ®æµ</span><br><span class="line">access-list 100 permit ip 14.1.1.0 0.0.0.255 35.1.1.0 0.0.0.255     &#x2F;&#x2F; ä¸¤ç«¯çš„ç§ç½‘ç½‘æ®µ</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; å®šä¹‰crypto map</span><br><span class="line">crypto map rancho 1 ipsec-isakmp    &#x2F;&#x2F; mapåå­—å«&#96;rancho&#96;ï¼Œåºå·ä¸º1ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œè¶Šå°è¶Šä¼˜</span><br><span class="line"> set peer 23.1.1.3                  &#x2F;&#x2F; éš§é“å¯¹ç«¯ä¸º23.1.1.3</span><br><span class="line"> set transform-set rancho           &#x2F;&#x2F; è°ƒç”¨åä¸ºranchoçš„transform ç»„</span><br><span class="line"> match address 100                  &#x2F;&#x2F; æŒ‡å®šACL 100ä¸ºä¿æŠ¤çš„æµé‡</span><br><span class="line"> </span><br><span class="line"> &#x2F;&#x2F; å°†cryptoåº”ç”¨åœ¨æ¥å£ä¸Š</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> crypto map rancho                  &#x2F;&#x2F; åœ¨eth0&#x2F;0ä¸Šåº”ç”¨åä¸ºranchoçš„crypto map</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tab-2"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crypto isakmp policy 1</span><br><span class="line"> encr 3des</span><br><span class="line"> hash md5</span><br><span class="line"> authentication pre-share</span><br><span class="line"> group 2</span><br><span class="line">crypto isakmp key rancho address 12.1.1.1       </span><br><span class="line">!</span><br><span class="line">crypto ipsec transform-set rancho esp-3des esp-sha-hmac </span><br><span class="line"> mode tunnel</span><br><span class="line">!</span><br><span class="line">crypto map rancho 1 ipsec-isakmp </span><br><span class="line"> set peer 12.1.1.1</span><br><span class="line"> set transform-set rancho </span><br><span class="line"> match address 100</span><br><span class="line">!</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> crypto map rancho</span><br><span class="line">!</span><br><span class="line">access-list 100 permit ip 35.1.1.0 0.0.0.255 14.1.1.0 0.0.0.255</span><br></pre></td></tr></table></figure></div></div></div>

<p>è‡³æ­¤ï¼ŒIPSecéš§é“ä¸¤ç«¯çš„é…ç½®å°±å®Œæˆäº†ã€‚ä½†æ˜¯IKE SAå¹¶æ²¡æœ‰å»ºç«‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1#show crypto isakmp peers </span><br><span class="line">R1#show crypto isakmp sa    </span><br><span class="line">IPv4 Crypto ISAKMP SA</span><br><span class="line">dst             src             state          conn-id status</span><br><span class="line"></span><br><span class="line">IPv6 Crypto ISAKMP SA</span><br><span class="line"></span><br><span class="line">R1#</span><br></pre></td></tr></table></figure>
<p>éœ€è¦ä¸šåŠ¡æµé‡æ¥è§¦å‘IKE SAçš„å»ºç«‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">VPC4&gt; ping 35.1.1.5</span><br><span class="line">35.1.1.5 icmp_seq&#x3D;1 timeout</span><br><span class="line">84 bytes from 35.1.1.5 icmp_seq&#x3D;2 ttl&#x3D;62 time&#x3D;2.828 ms</span><br></pre></td></tr></table></figure>
<p>åœ¨R2çš„eth0ä¸ŠæŠ“åŒ…ï¼š<br><img src="https://rancho333.github.io/pictures/ipsec_esp_packet.png"></p>
<p>å¯ä»¥çœ‹åˆ°å…ˆé€šè¿‡IKEå»ºç«‹SAï¼Œä¹‹åçš„ICMPæŠ¥æ–‡å°è£…åœ¨ESPæŠ¥æ–‡ä¸­ï¼Œåœ¨éš§é“ä¸¤ç«¯ä¼ é€’ã€‚</p>
<p>æœ€åæŸ¥çœ‹ä¸€ä¸‹é…ç½®å’ŒçŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; æŸ¥çœ‹isakmp policyç­–ç•¥</span><br><span class="line">R1#show crypto isakmp policy </span><br><span class="line"></span><br><span class="line">Global IKE policy</span><br><span class="line">Protection suite of priority 1</span><br><span class="line">	encryption algorithm:	Three key triple DES</span><br><span class="line">	hash algorithm:		Message Digest 5</span><br><span class="line">	authentication method:	Pre-Shared Key</span><br><span class="line">	Diffie-Hellman group:	#2 (1024 bit)</span><br><span class="line">	lifetime:		86400 seconds, no volume limit</span><br><span class="line"></span><br><span class="line">R1#show crypto isakmp key           &#x2F;&#x2F; æŸ¥çœ‹phase oneè®¤è¯å¯†ç </span><br><span class="line">R1#show crypto isakmp sa            &#x2F;&#x2F; æŸ¥çœ‹IKE SA</span><br><span class="line">R1#show crypto isakmp peers         &#x2F;&#x2F; æŸ¥çœ‹IKE peers</span><br><span class="line">R1#show crypto ipsec transform-set      &#x2F;&#x2F; æŸ¥çœ‹IPSec transform</span><br><span class="line">R1#show crypto ipsec sa                 &#x2F;&#x2F; æŸ¥çœ‹IPSec SA</span><br><span class="line">R1#show crypto map                  &#x2F;&#x2F; æŸ¥çœ‹crypto map</span><br></pre></td></tr></table></figure>

<h1 id="å…³äºIPSecä½¿ç”¨çš„ä¸€äº›æ€è€ƒ"><a href="#å…³äºIPSecä½¿ç”¨çš„ä¸€äº›æ€è€ƒ" class="headerlink" title="å…³äºIPSecä½¿ç”¨çš„ä¸€äº›æ€è€ƒ"></a>å…³äºIPSecä½¿ç”¨çš„ä¸€äº›æ€è€ƒ</h1><p>IPsecå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ”¯æŒIKEï¼Œå¯å®ç°å¯†é’¥çš„è‡ªåŠ¨åå•†åŠŸèƒ½ï¼Œå‡å°‘å¯†é’¥åå•†çš„å¼€é”€ã€‚å¯ä»¥é€šè¿‡IKEå»ºç«‹å’Œç»´æŠ¤SAçš„æœåŠ¡ï¼Œç®€åŒ–äº†IPsecçš„ä½¿ç”¨å’Œç®¡ç†</li>
<li>æ‰€æœ‰ä½¿ç”¨IPåè®®è¿›è¡Œæ•°æ®ä¼ è¾“çš„åº”ç”¨ç³»ç»Ÿå’ŒæœåŠ¡éƒ½å¯ä»¥ä½¿ç”¨IPsecï¼Œè€Œä¸å¿…å¯¹è¿™äº›åº”ç”¨ç³»ç»Ÿå’ŒæœåŠ¡æœ¬èº«åšä»»ä½•ä¿®æ”¹</li>
</ul>
<p>IPsecå…·æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š</p>
<ul>
<li>å®‰å…¨æœåŠ¡åè®®AHå’ŒESPæ‰€æä¾›çš„åŠŸèƒ½é‡å ç‡éå¸¸é«˜ï¼Œè™½ç„¶IPsecæœ€æ–°ç‰ˆæœ¬è§„å®šAHä¸ºå¯é€‰åè®®ï¼Œä½†å¹¶æ²¡æœ‰è§£å†³IPsecç»„åˆå¤æ‚åº¦çš„é—®é¢˜ã€‚ä»è€Œå¯¼è‡´IPsecçš„å·¥ç¨‹å®ç°ä»¥åŠéƒ¨ç½²ç»´æŠ¤çš„æˆæœ¬ä¾æ—§éå¸¸é«˜ã€‚</li>
<li>å®‰å…¨æœåŠ¡åè®®çš„å·¥ä½œæ¨¡å¼ä¼—å¤šï¼šä¼ è¾“æ¨¡å¼ã€éš§é“æ¨¡å¼ï¼Œåœ¨åŠ ä¸Šä¸¤ç§åè®®çš„ç»„åˆï¼Œå¯¼è‡´IPsecçš„å¤æ‚åº¦é«˜ã€‚</li>
</ul>
<p>åè®®åŒ…å«æœ‰å¤ªå¤šçš„é€‰é¡¹å’Œå¤ªå¤šçš„çµæ´»æ€§ï¼ŒåšåŒæ ·æˆ–ç±»ä¼¼çš„äº‹æœ‰å‡ ç§æ–¹å¼ï¼Œä»è€Œå¼•å…¥çš„å¤æ‚åº¦ä¼šå¯¼è‡´å·¥ç¨‹å®ç°çš„ç³»ç»Ÿéå¸¸å¤æ‚ï¼Œå­˜åœ¨çš„å®‰å…¨æ¼æ´ä¹Ÿå°±éå¸¸å¤šï¼Œå®‰å…¨è¯„ä¼°ä¹Ÿå°±éå¸¸å›°éš¾ï¼Œä»æŸç§æ„ä¹‰ä¸Šè®²ï¼Œå¤æ‚æ˜¯å®‰å…¨æœ€å¤§çš„æ•Œäººã€‚</p>
<p>  ä»å·¥ä½œæ¨¡å¼çš„è§’åº¦ä¸Šçœ‹ï¼ŒIPsecçš„å·¥ä½œæ¨¡å¼åˆ†ä¸ºä¼ è¾“æ¨¡å¼å’Œéš§é“æ¨¡å¼ï¼Œè€Œè¿™ä¸¤ç§å·¥ä½œæ¨¡å¼ç»“åˆAHä¸ESPä»¥åŠAHå’ŒESPçš„ç»„åˆï¼Œåˆä¼šè¡ç”Ÿå‡ºæ›´å¤šçš„å·¥ä½œæ¨¡å¼ï¼Œå¯¼è‡´IPsecåœ¨å·¥ç¨‹å®ç°ã€ç»´æŠ¤ä¸Šå¤§å¤§åŠ é‡äº†å…¶å¤æ‚åº¦ã€‚</p>
<p>  å¯¹äºIPsecçš„ä½¿ç”¨åœºæ™¯ä¸ä¼ è¾“æ¨¡å¼ï¼š</p>
<ul>
<li>ä¼ è¾“æ¨¡å¼é€‚ç”¨äºä¸»æœºé—´åº”ç”¨åœºæ™¯(å¦‚æœåœ¨ç½‘å…³ä¸Šä½¿ç”¨ï¼Œé‚£ä¹ˆç½‘å…³è§†ä½œä¸»æœºï¼Œæ­¤æ—¶ç”¨äºç½‘ç»œç®¡ç†)</li>
<li>éš§é“æ¨¡å¼ä½¿ç”¨ä¸å¸¦æœ‰ç½‘å…³çš„åº”ç”¨åœºæ™¯</li>
</ul>
<p>  ä¼ è¾“æ¨¡å¼æ˜¯ä¸ºé«˜çº§åè®®(IPçš„payload)æä¾›ä¿æŠ¤è€Œè®¾è®¡çš„ï¼Œéš§é“æ¨¡å¼æ˜¯ä¸ºæ•´ä¸ªIPåˆ†ç»„æä¾›ä¿æŠ¤è®¾è®¡çš„ã€‚</p>
<p>  å¯ä»¥æ·˜æ±°ä¼ è¾“æ¨¡å¼ã€‚</p>
]]></content>
      <tags>
        <tag>vpn</tag>
      </tags>
  </entry>
  <entry>
    <title>NATç®€è¿°åŠä»¿çœŸå®éªŒ</title>
    <url>/2021/09/29/NAT%E7%AE%80%E8%BF%B0%E5%8F%8A%E4%BB%BF%E7%9C%9F%E5%AE%9E%E9%AA%8C/</url>
    <content><![CDATA[<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

<ul>
<li><a href="#%E5%85%B3%E4%BA%8Enat%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E9%97%AE%E9%A2%98">å…³äºNATçš„ä¸€äº›åŸºæœ¬é—®é¢˜</a><ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFnat">ä»€ä¹ˆæ˜¯NAT?</a></li>
<li><a href="#nat%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F">NATçš„å·¥ä½œæ–¹å¼</a></li>
<li><a href="#nat%E7%9A%84%E5%BC%8A%E7%AB%AF%E5%8F%8A%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F">NATçš„å¼Šç«¯åŠå¤„ç†æ–¹å¼</a><ul>
<li><a href="#alg">ALG</a></li>
<li><a href="#icmp%E6%8A%A5%E6%96%87%E7%9A%84%E7%89%B9%E6%AE%8A%E5%A4%84%E7%90%86">ICMPæŠ¥æ–‡çš„ç‰¹æ®Šå¤„ç†</a></li>
<li><a href="#ip%E5%88%86%E7%89%87%E7%9A%84%E7%89%B9%E6%AE%8A%E5%A4%84%E7%90%86">IPåˆ†ç‰‡çš„ç‰¹æ®Šå¤„ç†</a><span id="more"></span></li>
</ul>
</li>
</ul>
</li>
<li><a href="#nat%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B">NATçš„åŸºæœ¬å·¥ä½œæ¨¡å‹</a><ul>
<li><a href="#%E4%BC%A0%E7%BB%9Fnat">ä¼ ç»ŸNAT</a><ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2basic-nat">åŸºæœ¬åœ°å€è½¬æ¢(Basic NAT)</a></li>
<li><a href="#naptnetwork-address-port-translation">NAPT(network address port translation)</a></li>
<li><a href="#%E5%85%B3%E4%BA%8E%E9%9D%99%E6%80%81nat%E5%92%8C%E5%8A%A8%E6%80%81nat">å…³äºé™æ€NATå’ŒåŠ¨æ€NAT</a></li>
</ul>
</li>
<li><a href="#bi-directional-nat-or-two-way-nat">Bi-directional NAT or Two-Way NAT</a></li>
<li><a href="#twice-nat">Twice NAT</a></li>
</ul>
</li>
<li><a href="#nat%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BA%94%E7%94%A8%E6%96%B9%E6%A1%88">NATçš„ä¸€äº›åº”ç”¨æ–¹æ¡ˆ</a><ul>
<li><a href="#nat%E7%9A%84%E5%8F%8C%E7%83%AD%E6%9C%BA%E5%A4%87%E4%BB%BDnat%E5%A4%9A%E5%87%BA%E5%8F%A3%E7%AD%96%E7%95%A5">NATçš„åŒçƒ­æœºå¤‡ä»½/NATå¤šå‡ºå£ç­–ç•¥</a></li>
<li><a href="#nat%E7%A9%BF%E8%B6%8A%E6%8A%80%E6%9C%AF">NATç©¿è¶ŠæŠ€æœ¯</a></li>
<li><a href="#nat%E4%B8%8Evpn">NATä¸VPN</a></li>
<li><a href="#nat%E4%B8%8E%E8%B7%AF%E7%94%B1%E7%9A%84%E5%85%B3%E7%B3%BB%E5%8F%8A%E4%B8%80%E4%BA%9B%E5%A4%84%E7%90%86%E7%BB%86%E8%8A%82">NATä¸è·¯ç”±çš„å…³ç³»åŠä¸€äº›å¤„ç†ç»†èŠ‚</a></li>
<li><a href="#sonic%E4%B8%ADnat%E7%9A%84%E5%AE%9E%E7%8E%B0">SONiCä¸­NATçš„å®ç°</a></li>
<li><a href="#nat-ptv4v6%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2">NAT-PT(V4/V6åœ°å€è½¬æ¢)</a></li>
</ul>
</li>
<li><a href="#gns3%E4%B8%8Anat%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%AE%9E%E9%AA%8C">GNS3ä¸ŠNATçš„åŸºæœ¬å®éªŒ</a><ul>
<li><a href="#%E9%9D%99%E6%80%81nat%E5%AE%9E%E9%AA%8C">é™æ€NATå®éªŒ</a></li>
<li><a href="#%E5%8A%A8%E6%80%81nat%E5%AE%9E%E9%AA%8C">åŠ¨æ€NATå®éªŒ</a></li>
<li><a href="#pat%E5%AE%9E%E9%AA%8C">PATå®éªŒ</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<h1 id="å…³äºNATçš„ä¸€äº›åŸºæœ¬é—®é¢˜"><a href="#å…³äºNATçš„ä¸€äº›åŸºæœ¬é—®é¢˜" class="headerlink" title="å…³äºNATçš„ä¸€äº›åŸºæœ¬é—®é¢˜"></a>å…³äºNATçš„ä¸€äº›åŸºæœ¬é—®é¢˜</h1><p>æœ¬æ–‡æ—¨åœ¨å¯¹NATæœ‰ä¸€ä¸ªå…¨å±€çš„äº†è§£ï¼ŒåŒ…æ‹¬NATæŠ€æœ¯çš„èµ·å› ï¼ŒæŠ€æœ¯çš„å®ç°æ–¹å¼ä»¥åŠåº”ç”¨åœºæ™¯ï¼ŒæŠ€æœ¯å­˜åœ¨çš„ç¼ºç‚¹ä»¥åŠè§£å†³æ–¹å¼ï¼Œæœ€åä»¥å‡ ä¸ªåŸºæœ¬çš„å®éªŒè¿›è¡ŒéªŒè¯æ”¶å°¾ï¼Œå¯¹äºæŸäº›å¤æ‚çš„åº”ç”¨åœºæ™¯æˆ–æŠ€æœ¯ç»†èŠ‚ï¼Œä¼šç®€è¿°è€Œä¸æ·±ç©¶ï¼Œè¿™äº›ç­‰åˆ°çœŸå®çš„åº”ç”¨ä¸­å»æ‰“ç£¨ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯NAT"><a href="#ä»€ä¹ˆæ˜¯NAT" class="headerlink" title="ä»€ä¹ˆæ˜¯NAT?"></a>ä»€ä¹ˆæ˜¯NAT?</h2><p>NATçš„åå­—å¾ˆå‡†ç¡®ï¼ŒNetwork Address Translator(ç½‘ç»œåœ°å€è½¬æ¢)ï¼Œå°±æ˜¯æ›¿æ¢ç§ç½‘IPæŠ¥æ–‡å¤´éƒ¨çš„åœ°å€ä¿¡æ¯ï¼Œä»è€Œæä¾›å…¬ç½‘å¯è¾¾æ€§å’Œä¸Šå±‚åè®®çš„è¿æ¥èƒ½åŠ›ã€‚æŒ‰ç…§rfc2663çš„è¯´æ³•ï¼ŒNATæ˜¯ä»ä¸€ä¸ªIPåœ°å€èŒƒå›´æ˜ å°„åˆ°å¦ä¸€ä¸ªèŒƒå›´çš„æ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™ç§è¯´æ³•æ›´åŠ æ¦‚æ‹¬<br>NATçš„ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ç§ç½‘åˆ°å…¬ç½‘çš„ç¿»è¯‘</li>
<li>é‡å åœ°å€ä¹‹é—´çš„ç¿»è¯‘</li>
<li>ä¿æŠ¤å†…ç½‘IPè®¾å¤‡</li>
</ul>
<p>å…³äºç§ç½‘ï¼ŒRFC1918è§„å®šäº†ä¸‰ä¸ªä¿ç•™åœ°å€æ®µè½ï¼š10.0.0.0-10.255.255.255ï¼›172.16.0.0-172.31.255.255ï¼›192.168.0.0-192.168.255.255ã€‚</p>
<h2 id="NATçš„å·¥ä½œæ–¹å¼"><a href="#NATçš„å·¥ä½œæ–¹å¼" class="headerlink" title="NATçš„å·¥ä½œæ–¹å¼"></a>NATçš„å·¥ä½œæ–¹å¼</h2><p>NATåŠŸèƒ½åœ¨ç½‘ç»œå‡ºå£è·¯ç”±å™¨ä¸Šä½¿èƒ½ï¼Œåœ¨æŠ¥æ–‡ç¦»å¼€ç§ç½‘è¿›å…¥å…¬ç½‘æ—¶ï¼Œå°†æºIPæ›¿æ¢ä¸ºå…¬ç½‘IPï¼ŒæŠ¥æ–‡ä»å…¬ç½‘è¿›å…¥ç§ç½‘æ—¶ï¼Œåšç›¸åçš„æ›¿æ¢ã€‚NATå¤„ç†æŠ¥æ–‡çš„å‡ ä¸ªå…³é”®ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç½‘ç»œè¢«åˆ†ä¸ºç§ç½‘å’Œå…¬ç½‘ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒNATç½‘å…³è®¾ç½®åœ¨ç§ç½‘åˆ°å…¬ç½‘çš„è·¯ç”±å‡ºå£ä½ç½®ï¼ŒåŒå‘æµé‡å¿…é¡»éƒ½ç»è¿‡NATç½‘å…³</li>
<li>NATç½‘å…³åœ¨ä¸¤ä¸ªè®¿é—®æ–¹å‘ä¸Šå®Œæˆä¸¤æ¬¡åœ°å€è½¬æ¢ï¼Œå‡ºæ–¹å‘ä¸Šåšæºä¿¡æ¯æ›¿æ¢ï¼Œå…¥æ–¹å‘ä¸Šåšç›®çš„åœ°å€æ›¿æ¢</li>
<li><em>NATç½‘å…³çš„å­˜åœ¨å¯¹é€šä¿¡åŒæ–¹æ˜¯é€æ˜çš„</em>(è¿™æ˜¯NATè‡´åŠ›äºè¾¾åˆ°çš„ï¼Œä½†åšçš„ä¸å¥½ï¼Œå› ä¸ºæœ‰äº›ä¸Šå±‚åè®®ä¼šåœ¨å†…éƒ¨æºå¸¦IPåœ°å€ä¿¡æ¯)</li>
<li>NATç½‘å…³ä¸ºäº†å®ç°åŒå‘ç¿»è¯‘ï¼Œéœ€è¦ç»´æŠ¤ä¸€å¼ å…³è”è¡¨ï¼ŒæŠŠä¼šè¯ä¿¡æ¯è®°å½•ä¸‹æ¥</li>
</ul>
<h2 id="NATçš„å¼Šç«¯åŠå¤„ç†æ–¹å¼"><a href="#NATçš„å¼Šç«¯åŠå¤„ç†æ–¹å¼" class="headerlink" title="NATçš„å¼Šç«¯åŠå¤„ç†æ–¹å¼"></a>NATçš„å¼Šç«¯åŠå¤„ç†æ–¹å¼</h2><p>NATç¼“è§£å…¬ç½‘IPä¸å¤Ÿç”¨çš„åŒæ—¶å¸¦æ¥äº†ä¸€äº›ä¸å¥½çš„å½±å“ï¼Œéœ€è¦é€šè¿‡å¦ä¸€äº›æŠ€æœ¯å»è§£å†³ã€‚</p>
<ul>
<li>NATæ— æ³•åšåˆ°é€æ˜ä¼ è¾“ï¼ŒALGæŠ€æœ¯æ¥è§£å†³</li>
<li>NATç ´ç¯äº†IPåè®®æ¶æ„ç«¯åˆ°ç«¯çš„é€šä¿¡æ¨¡å‹ï¼Œç ´åäº†èŠ‚ç‚¹åœ¨é€šè®¯ä¸­çš„å¯¹ç­‰åœ°ä½ã€‚NATç©¿é€æŠ€æœ¯è¿›è¡Œè§£å†³</li>
<li>NATä½¿IPä¼šè¯çš„æ—¶æ•ˆå˜çŸ­ï¼Œå› ä¸ºIPå’Œç«¯å£èµ„æºæœ‰é™ï¼Œè€Œé€šä¿¡çš„éœ€æ±‚æ— é™ï¼ŒNATç½‘å…³ä¼šå¯¹å…³è”è¡¨è¿›è¡Œè€åŒ–æ“ä½œ(ç‰¹åˆ«æ˜¯UDPé€šä¿¡)ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·å¯æ„ŸçŸ¥çš„è¿æ¥ä¸­æ–­ï¼Œé€šè¿‡ä¸Šå±‚åè®®è®¾ç½®è¿æ¥ä¿æ´»æœºåˆ¶æ¥è§£å†³</li>
<li>ä½¿ä¾èµ–IPè¿›è¡Œä¸»æœºè·Ÿè¸ªçš„æœºåˆ¶å¤±æ•ˆï¼Œå¦‚ï¼šåŸºäºç”¨æˆ·è¡Œä¸ºçš„æ—¥å¿—åˆ†æï¼ŒåŸºäºIPçš„ç”¨æˆ·æˆæƒï¼ŒæœåŠ¡å™¨è¿æ¥è®¾ç½®åŒä¸€æ—¶é—´åªæ¥æ”¶åŒä¸€IPçš„æœ‰é™è®¿é—®ï¼Œæ€»ä¹‹NATå±è”½äº†é€šä¿¡çš„ä¸€ç«¯ï¼ŒæŠŠç®€å•çš„äº‹æƒ…å¤æ‚åŒ–äº†</li>
<li>ICMPå¤ç”¨å’Œè§£å¤ç”¨éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœICMP payloadæ— æ³•æä¾›è¶³å¤Ÿä¿¡æ¯ï¼Œè§£å¤ç”¨ä¼šå¤±è´¥</li>
<li>IPåˆ†ç‰‡ï¼Œå› ä¸ºåªæœ‰ç¬¬ä¸€ä¸ªåˆ†ç‰‡æœ‰ä¼ è¾“å±‚ä¿¡æ¯ï¼ŒNATå¾ˆéš¾è¯†åˆ«åç»­åˆ†ç‰‡ä¸å…³è”è¡¨çš„å¯¹åº”å…³ç³»ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†</li>
</ul>
<h3 id="ALG"><a href="#ALG" class="headerlink" title="ALG"></a>ALG</h3><p>NATå·¥ä½œåœ¨L3å’ŒL4ï¼ŒALG(application level gateways)æ˜¯ç”¨ä»¥è§£å†³NATå¯¹åº”ç”¨å±‚æ— æ„ŸçŸ¥çš„å¸¸ç”¨æ–¹å¼ã€‚NATç½‘å…³åŸºäºä¼ è¾“å±‚ç«¯å£ä¿¡æ¯æ¥è¯†åˆ«è¿æ¥æ˜¯å¦ä¸ºå·²çŸ¥çš„åº”ç”¨ç±»å‹ï¼Œåœ¨è¯†åˆ«ä¸ºå·²çŸ¥åº”ç”¨æ—¶ï¼Œä¼šå¯¹å…¶æŠ¥æ–‡å†…å®¹è¿›è¡Œæ£€æŸ¥ï¼Œå½“å‘ç°ä»»ä½•å½¢å¼è¡¨è¾¾çš„IPåœ°å€å’Œç«¯å£æ—¶ï¼Œä¼šæŠŠè¿™äº›ä¿¡æ¯åŒæ­¥è½¬æ¢ã€‚</p>
<p>ä½†æ˜¯ï¼Œåº”ç”¨å±‚åè®®å¾ˆå¤šè€Œä¸”åœ¨ä¸æ–­å˜åŒ–ï¼Œè€Œè®¾å¤‡ä¸­çš„ALGéƒ½æ˜¯é’ˆå¯¹ç‰¹å®šåè®®ç‰¹å®šç‰ˆæœ¬å¼€å‘çš„ï¼Œå°½ç®¡Linuxå…è®¸åŠ¨æ€åŠ è½½ALGç‰¹æ€§ï¼Œå…¶ç®¡ç†ç»´æŠ¤æˆæœ¬ä¾ç„¶å¾ˆé«˜ã€‚å› æ­¤ï¼ŒALGåªèƒ½è§£å†³å¸¸ç”¨çš„ç”¨æˆ·éœ€æ±‚ï¼Œè€Œä¸”ï¼Œæœ‰äº›æŠ¥æ–‡ä»æºç«¯å‘å‡ºå°±å·²ç»åŠ å¯†ï¼ŒALGä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚</p>
<h3 id="ICMPæŠ¥æ–‡çš„ç‰¹æ®Šå¤„ç†"><a href="#ICMPæŠ¥æ–‡çš„ç‰¹æ®Šå¤„ç†" class="headerlink" title="ICMPæŠ¥æ–‡çš„ç‰¹æ®Šå¤„ç†"></a>ICMPæŠ¥æ–‡çš„ç‰¹æ®Šå¤„ç†</h3><p>NATç½‘å…³é€šå¸¸é‡‡ç”¨äº”å…ƒç»„è¿›è¡ŒNATæ˜ å°„ï¼Œå³æºåœ°å€ã€æºç«¯å£ã€IPåè®®ç±»å‹ã€ç›®çš„åœ°å€ã€ç›®çš„ç«¯å£ã€‚ICMPæŠ¥æ–‡ç›´æ¥æ‰¿è½½åœ¨IPæŠ¥æ–‡ä¹‹ä¸Šï¼Œæ²¡æœ‰L4ä¿¡æ¯ã€‚ä»¥pingä¸ºä¾‹ï¼Œå¯¹äºICMPè¯·æ±‚æŠ¥æ–‡ï¼ŒTYPE+CODEå­—æ®µä½œä¸ºæºç«¯å£ï¼Œidentifierä½œä¸ºç›®çš„ç«¯å£è®°å½•ï¼Œåä¹‹äº¦ç„¶ã€‚windowsä¸Šå‘å‡ºçš„ICMPæŠ¥æ–‡identifierå­—æ®µå…¨éƒ¨æ˜¯0x0400ï¼Œå¤„ç†ä¸Šæœ‰äº›å·®åˆ«ã€‚<br>è¿™æ®µè¯æ¥è‡ªåä¸‰çš„ã€ŠNATä¸“é¢˜ã€‹ï¼Œåœ¨æ€ç§‘çš„c3600ä¸Šå®éªŒæ—¶ï¼Œå‘ç°å…¶åªä½¿ç”¨identifieræ ‡è¯†ä¸€ä¸ªICMPä¼šè¯ï¼Œå³ICMPçš„src portå’Œdst portéƒ½æ˜¯identifierçš„å€¼ã€‚è¿™é‡Œè¡¨ç¤ºç†è§£ï¼Œåªè¦NATè®¾å¤‡èƒ½å¤ŸåŒºåˆ«å‡ºä¸åŒå†…éƒ¨ä¸»æœºå‘çš„æŠ¥æ–‡å³å¯ï¼Œå…·ä½“å®ç°å‚å®¶å¯èƒ½æœ‰æ‰€å·®å¼‚ã€‚</p>
<h3 id="IPåˆ†ç‰‡çš„ç‰¹æ®Šå¤„ç†"><a href="#IPåˆ†ç‰‡çš„ç‰¹æ®Šå¤„ç†" class="headerlink" title="IPåˆ†ç‰‡çš„ç‰¹æ®Šå¤„ç†"></a>IPåˆ†ç‰‡çš„ç‰¹æ®Šå¤„ç†</h3><p>å½“è¿›è¡ŒIPåˆ†ç‰‡æ—¶ï¼Œè¿™äº›ä¿¡æ¯åªæœ‰é¦–ç‰‡æŠ¥æ–‡ä¼šæºå¸¦(åªæœ‰é¦–ç‰‡ä¸­æœ‰ç«¯å£å·ï¼Œåªæœ‰é¦–ç‰‡ä¸­æœ‰icmpçš„identifier)ï¼Œåç»­åˆ†ç‰‡æŠ¥æ–‡ä¾é æŠ¥æ–‡IDã€åˆ†ç‰‡æ ‡å¿—ä½ã€åˆ†ç‰‡åç§»é‡ä¾æ¬¡å…³è”åˆ°å‰ä¸€ä¸ªåˆ†ç‰‡ã€‚åœ¨PATè½¬æ¢ç±»å‹ä¸­ï¼Œé™¤äº†å¯¹IPåœ°å€è¿›è¡Œå¤„ç†ï¼Œè¿˜ä¼šå¤„ç†L4çš„ç«¯å£å·ï¼ŒICMPæŠ¥æ–‡å¤´ä¸­çš„identifierå­—æ®µä¿¡æ¯ã€‚å› æ­¤ï¼Œé™¤é¦–ç‰‡å¤–çš„æŠ¥æ–‡æ— æ³•è¿›è¡Œè½¬æ¢ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>å…ˆç¼“å­˜ï¼Œç­‰æ‰€æœ‰æŠ¥æ–‡åˆ°è¾¾åï¼Œè¿›è¡Œè™šæ‹Ÿé‡ç»„ï¼Œå†è¿›è¡ŒNATè½¬æ¢ï¼Œå°†è½¬æ¢åçš„æŠ¥æ–‡å†é¡ºåºå‘å‡º</li>
<li>åœ¨é¦–ç‰‡åˆ°è¾¾å¹¶è½¬æ¢åï¼Œä¿å­˜è½¬æ¢é¦–ç‰‡ä½¿ç”¨çš„IPä»¥åŠidentifierä¿¡æ¯ï¼Œåœ¨åç»­åˆ†ç‰‡åˆ°è¾¾åä½¿ç”¨åŒæ ·è¡¨é¡¹è¿›è¡Œè½¬æ¢ã€‚</li>
</ul>
<h1 id="NATçš„åŸºæœ¬å·¥ä½œæ¨¡å‹"><a href="#NATçš„åŸºæœ¬å·¥ä½œæ¨¡å‹" class="headerlink" title="NATçš„åŸºæœ¬å·¥ä½œæ¨¡å‹"></a>NATçš„åŸºæœ¬å·¥ä½œæ¨¡å‹</h1><p>NATæ˜¯ç½‘ç»œåœ°å€è½¬æ¢çš„æ€»ç§°ï¼ŒåŸºäºä¸åŒçš„åº”ç”¨åœºæ™¯å®ƒæœ‰ä¸åŒçš„é…ç½®ã€‚å¤§çš„åˆ†ç±»ä¸Šå¯ä»¥åˆ†ä¸ºä¼ ç»ŸNATå’Œtwo-way NATä»¥åŠtwice NATã€‚</p>
<h2 id="ä¼ ç»ŸNAT"><a href="#ä¼ ç»ŸNAT" class="headerlink" title="ä¼ ç»ŸNAT"></a>ä¼ ç»ŸNAT</h2><p>ä¼ ç»ŸNATåªèƒ½ç”±å†…ç½‘ä¸»æœºå‘èµ·é€šä¿¡ï¼Œæ˜¯å•å‘çš„ã€‚ä¼ ç»ŸNATæœ‰ä¸¤ç§å®ç°ã€‚</p>
<h3 id="åŸºæœ¬åœ°å€è½¬æ¢-Basic-NAT"><a href="#åŸºæœ¬åœ°å€è½¬æ¢-Basic-NAT" class="headerlink" title="åŸºæœ¬åœ°å€è½¬æ¢(Basic NAT)"></a>åŸºæœ¬åœ°å€è½¬æ¢(Basic NAT)</h3><p>NATè®¾å¤‡æ‹¥æœ‰å¤šä¸ªå…¬ç½‘ipï¼Œæ•°é‡è¿œå°‘äºå†…ç½‘ä¸»æœºçš„æ•°é‡ï¼Œå½“æœ‰å†…ç½‘ä¸»æœºè®¿é—®å¤–ç½‘æ—¶åˆ†é…å…¬ç½‘ipï¼Œè®¿é—®ç»“æŸæ—¶é‡Šæ”¾ã€‚NATè®¾å¤‡æ‹¥æœ‰å…¬ç½‘IPåœ°å€çš„æ•°ç›®ï¼Œåº”è¯¥æ ¹æ®ç½‘ç»œé«˜å³°å¯èƒ½è®¿é—®å¤–ç½‘çš„å†…ç½‘ä¸»æœºæ•°ç›®çš„ç»Ÿè®¡å€¼æ¥ç¡®å®šã€‚</p>
<p>ä¸Šé¢è¿™æ®µè¯æ˜¯å¯¹rfc2663 4.1.1ç« èŠ‚çš„ä¸€ä¸ªç¿»è¯‘ï¼Œç»“åˆå®é™…çš„åº”ç”¨ï¼ŒBasic NATå°±æ˜¯åªè¿›è¡ŒIPåœ°å€è½¬æ¢çš„NATæ¨¡å¼ã€‚</p>
<h3 id="NAPT-network-address-port-translation"><a href="#NAPT-network-address-port-translation" class="headerlink" title="NAPT(network address port translation)"></a>NAPT(network address port translation)</h3><p>ä¸€ä¸ªå¤–ç½‘åœ°å€å¯ä»¥åŒæ—¶åˆ†é…ç»™å¤šä¸ªå†…ç½‘åœ°å€å…¬ç”¨ã€‚è¯¥æ¨¡å¼ä¸‹ï¼ŒNAPTä¼šè½¬æ¢æºIPï¼Œæºç«¯å£ä»¥åŠç›¸å…³çš„ipï¼Œtcp/udpå’Œicmpçš„header checksums.è½¬æ¢çš„idå¯ä»¥æ˜¯ tcp/udpçš„ç«¯å£å·æˆ–è€…icmpçš„query IDã€‚å…¶è½¬æ¢çš„åŸºæœ¬åŸç†å¯å½¢å®¹ä¸ºï¼š<br>(iAddr;iPort) &lt;â€”â€”&gt; (eAddr; ePort)<br>ä¸æ­¤ç›¸å…³å¯ç§°ä¹‹ä¸ºPAT(port address translation)æ¨¡å¼ï¼ŒNATä½¿ç”¨æœ€å¤šçš„æ¨¡å¼å°±æ˜¯PATæ¨¡å¼ã€‚ç›¸åçš„ä¸ä½¿ç”¨portè¿›è¡Œåœ°å€è½¬æ¢ç§°ä¸ºNO-PAT(not port address translation)ï¼Œè€ŒNAPTæ ¹æ®æ˜¯å¦å…³å¿ƒå¯¹ç«¯çš„ä¿¡æ¯å¯ä»¥åˆ†ä¸ºä¸‹é¢ä¸¤ç§ï¼š</p>
<ol>
<li><p>endpoint-independent mapping(ä¸å…³å¿ƒå¯¹ç«¯åœ°å€å’Œç«¯å£çš„è½¬æ¢æ¨¡å¼)<br>NATè®¾å¤‡é€šè¿‡å»ºç«‹ä¸‰å…ƒç»„(æºåœ°å€ã€æºç«¯å£å·ã€åè®®ç±»å‹)è¡¨é¡¹æ¥è¿›è¡Œåœ°å€åˆ†é…å’ŒæŠ¥æ–‡è¿‡æ»¤ã€‚å³ï¼Œåªè¦æ¥è‡ªç›¸åŒæºåœ°å€å’Œæºç«¯å£å·çš„æŠ¥æ–‡ï¼Œä¸è®ºå…¶ç›®çš„åœ°å€æ˜¯å¦ç›¸åŒï¼Œé€šè¿‡NAPTæ˜ å°„åï¼Œå…¶æºåœ°å€å’Œæºç«¯å£å·éƒ½è¢«è½¬æ¢æˆåŒä¸€ä¸ªå¤–éƒ¨åœ°å€å’Œç«¯å£å·ï¼Œå¹¶ä¸”NATè®¾å¤‡å…è®¸å¤–éƒ¨ç½‘ç»œçš„ä¸»æœºé€šè¿‡è¯¥è½¬æ¢åçš„åœ°å€å’Œç«¯å£æ¥è®¿é—®è¿™äº›å†…éƒ¨ç½‘ç»œçš„ä¸»æœºã€‚è¿™ç§æ¨¡å¼å¯ä»¥å¾ˆå¥½çš„æ”¯æŒä½äºä¸åŒNATè®¾å¤‡ä¹‹åçš„ä¸»æœºè¿›è¡Œäº’è®¿ã€‚</p>
</li>
<li><p>address and port-dependent mapping(å…³å¿ƒå¯¹ç«¯åœ°å€å’Œç«¯å£è½¬æ¢æ¨¡å¼)<br>NATè®¾å¤‡é€šè¿‡å»ºç«‹äº”å…ƒç»„(æºåœ°å€ã€æºç«¯å£å·ã€åè®®ç±»å‹ã€ç›®çš„åœ°å€ã€ç›®çš„ç«¯å£å·)è¿›è¡Œåœ°å€åˆ†é…å’ŒæŠ¥æ–‡è¿‡æ»¤ã€‚å³ï¼Œå¯¹äºæ¥è‡ªç›¸åŒæºåœ°å€å’Œæºç«¯å£å·çš„æŠ¥æ–‡ï¼Œè‹¥å…¶ç›®çš„åœ°å€å’Œç›®çš„ç«¯å£å·ä¸åŒï¼Œé€šè¿‡NAPTæ˜ å°„åï¼Œä¼šè¢«è½¬æ¢æˆä¸åŒçš„å¤–éƒ¨åœ°å€å’Œç«¯å£å·ï¼Œå¹¶ä¸”NATè®¾å¤‡åªå…è®¸è¿™äº›ç›®çš„åœ°å€å¯¹åº”çš„å¤–éƒ¨ç½‘ç»œçš„ä¸»æœºæ‰å¯ä»¥è®¿é—®å¯¹åº”çš„å†…éƒ¨ä¸»æœºã€‚è¿™ç§æ¨¡å¼å®‰å…¨æ€§å¥½ï¼Œä½†æ˜¯ä¸ä¾¿äºä½äºä¸åŒNATè®¾å¤‡ä¹‹åçš„ä¸»æœºé—´çš„äº’è®¿ã€‚</p>
</li>
</ol>
<p>è€Œé€šè¿‡å¯¹å¤–éƒ¨ä¸»æœºåœ°å€+ç«¯å£çš„é™åˆ¶ï¼Œåˆå¯ä»¥åˆ†ä¸ºï¼š</p>
<ul>
<li>å…¨é”¥å½¢ï¼šå¯¹äºinbound,åªè¦NATè¡¨é¡¹ä¸­å­˜åœ¨ï¼Œä¸å…³å¿ƒsrc ip</li>
<li>é™åˆ¶é”¥å½¢ï¼šå¯¹äºinbound, å…³å¿ƒsrc ip</li>
<li>ç«¯å£é™åˆ¶é”¥å½¢: å¯¹äºinbound, å…³å¿ƒsrc ip + src port</li>
<li>å¯¹ç§°å½¢: å¯¹äºoutboundå’Œinbound, åªæœ‰src ip, src port, dst ip, dst portå®Œå…¨ä¸€è‡´æ‰è®¤ä¸ºæ˜¯ä¸€ä¸ªä¼šè¯ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„è¡¨é¡¹<br>è¿™äº›éƒ½æ˜¯æœ¬è´¨æ˜¯NATçš„åº”ç”¨ï¼Œæ›´åŠ ç»†ç²’åº¦çš„è¿›è¡Œæ§åˆ¶è¿‡æ»¤ï¼Œæ˜¯NATçš„ä¸€ç§å·¥ä½œæ–¹å¼, å¯ä»¥ç§°ä¹‹ä¸º<em>policy NAT</em>ã€‚</li>
</ul>
<h3 id="å…³äºé™æ€NATå’ŒåŠ¨æ€NAT"><a href="#å…³äºé™æ€NATå’ŒåŠ¨æ€NAT" class="headerlink" title="å…³äºé™æ€NATå’ŒåŠ¨æ€NAT"></a>å…³äºé™æ€NATå’ŒåŠ¨æ€NAT</h3><p>è¿™æ˜¯å¦ä¸€ç§åˆ†ç±»æ–¹å¼ï¼Œé™æ€NATå³å†…å¤–ç½‘åœ°å€ä¿¡æ¯é™æ€ç»‘å®šï¼Œæ˜¯ä¸€ä¸€æ˜ å°„ï¼Œè¿™ç§å¾ˆå°‘ä½¿ç”¨ï¼Œå¯ç”¨æ¥éšè—ç§ç½‘ipå’Œé‡å åœ°å€ç½‘ç»œçš„é€šä¿¡ã€‚åŠ¨æ€NATåˆ™æ˜¯ä½¿ç”¨å¤–ç½‘åœ°å€æ± ï¼Œæœ‰èµ„æºå›æ”¶æœºåˆ¶ï¼Œè¿™ç§ç”¨æ³•ä¹Ÿå°‘ï¼Œåœ°ä¸»å®¶ä¹Ÿä¸èƒ½ä¹°è¿™ä¹ˆå¤šå…¬ç½‘IPåœ°å€ã€‚</p>
<h2 id="Bi-directional-NAT-or-Two-Way-NAT"><a href="#Bi-directional-NAT-or-Two-Way-NAT" class="headerlink" title="Bi-directional NAT or Two-Way NAT"></a>Bi-directional NAT or Two-Way NAT</h2><p>å¤–éƒ¨ç½‘ç»œèƒ½å¤Ÿæœ‰ä¸»åŠ¨è®¿é—®å†…ç½‘ä¸»æœºçš„æœºä¼šï¼Œå¦‚ç»™å¤–ç½‘æä¾›ä¸€å°WebæœåŠ¡å™¨ï¼Œæˆ–æ˜¯ä¸€å°FTPæœåŠ¡å™¨ã€‚å®ç°åŒå‘NATçš„å…³é”®åœ¨äºDNS-ALGçš„å¼•å…¥ï¼Œå€ŸåŠ©DNS-ALG,å®ç°å¤„äºä¸åŒç½‘ç»œä¸­çš„ä¸»æœºç›´æ¥é€šè¿‡åŸŸåæ¥ç›¸äº’è®¿é—®ã€‚<br>é™æ€NATä¸€èˆ¬å°±æ˜¯åŒå‘NAT.</p>
<h2 id="Twice-NAT"><a href="#Twice-NAT" class="headerlink" title="Twice NAT"></a>Twice NAT</h2><p>ç›¸å¯¹äºtraditional NATå’Œbi-directional NATä¸­NATè®¾å¤‡åªä¼šå¯¹æŠ¥æ–‡çš„æºæˆ–è€…ç›®çš„è¿›è¡Œä¿®æ”¹ï¼Œtwice NATåˆ™å¯¹æŠ¥æ–‡çš„src/dståŒæ—¶è¿›è¡Œä¿®æ”¹ã€‚ä¾‹å¦‚å½“å¤–ç½‘ä¸»æœºä½¿ç”¨çš„å¤–ç½‘çš„ipå·²ç»åˆ†é…ç»™åˆ«çš„ç»„ç»‡åœ°å€ï¼Œè¿™æ—¶éœ€è¦å°†dstä¹Ÿæ”¹æ‰ã€‚è¿™ç§æ–¹å¼å¸¸ç”¨äºæ”¯æŒå†…ç½‘ç”¨æˆ·ä¸»åŠ¨è®¿é—®ä¸ä¹‹åœ°å€é‡å (overlap)çš„å¤–ç½‘èµ„æºã€‚</p>
<p>å½“å†…ç½‘ä¸»æœºAå‘å¤–ç½‘ä¸»æœºBå‘èµ·é€šä¿¡æ—¶ï¼Œä½†æ˜¯å†…ç½‘ä¸­æœ‰ä¸»æœºDä½¿ç”¨çš„æ˜¯å’ŒBä¸€æ ·çš„IPåœ°å€ï¼ˆå¦‚ä¹‹å‰ISPåˆ†é…çš„ï¼Œç°åœ¨æ”¶å›äº†ï¼›å¦‚åŒä¸€å…¬å¸çš„å¼‚åœ°ç»„ç½‘ï¼‰ï¼Œå¦‚æœAç›´æ¥å’ŒBè¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆæŠ¥æ–‡ä¼šè½¬å‘ç»™Dã€‚A é€šè¿‡å‘é€DNSè¯·æ±‚Bçš„ipï¼ŒDNS-ALGæ¥æ”¶åˆ°ä¹‹åç»™å…¶åˆ†é…ä¸€ä¸ªå¯è·¯ç”±çš„å†…ç½‘åœ°å€Cï¼Œç°åœ¨Aå‘Cé€šä¿¡ï¼ŒNATè®¾å¤‡æ”¶åˆ°ä¹‹åï¼Œå¯¹äºsrc ip,æŒ‰ä¼ ç»ŸNATè½¬æ¢ï¼Œå¯¹äºdest ipï¼Œå°†åœ°å€Cæ”¹ä¸ºBçš„åœ°å€ï¼Œå‘ç»™å¤–ç½‘ï¼Œæ”¶åˆ°ä¹‹åï¼Œåä¹‹äº¦ç„¶ã€‚<br>Twice NAT would not be allowed to advertise local networks to the external network or vice versa.</p>
<p>NATå¯åˆ†ä¸ºSNATã€DNATå’Œtwice NAT, å¯¹äºinsideâ€”â€”&gt;outsideçš„æµé‡ï¼ŒåšSNATï¼Œå¯¹äºoutsideâ€”â€”&gt;insideçš„æµé‡ï¼ŒåšDNATã€‚</p>
<h1 id="NATçš„ä¸€äº›åº”ç”¨æ–¹æ¡ˆ"><a href="#NATçš„ä¸€äº›åº”ç”¨æ–¹æ¡ˆ" class="headerlink" title="NATçš„ä¸€äº›åº”ç”¨æ–¹æ¡ˆ"></a>NATçš„ä¸€äº›åº”ç”¨æ–¹æ¡ˆ</h1><h2 id="NATçš„åŒçƒ­æœºå¤‡ä»½-NATå¤šå‡ºå£ç­–ç•¥"><a href="#NATçš„åŒçƒ­æœºå¤‡ä»½-NATå¤šå‡ºå£ç­–ç•¥" class="headerlink" title="NATçš„åŒçƒ­æœºå¤‡ä»½/NATå¤šå‡ºå£ç­–ç•¥"></a>NATçš„åŒçƒ­æœºå¤‡ä»½/NATå¤šå‡ºå£ç­–ç•¥</h2><p>ä¸å‡ºå£ç½‘å…³ä¸€æ ·ï¼ŒNATå­˜åœ¨å•ç‚¹æ•…éšœçš„é—®é¢˜ã€‚è¿›è¡ŒåŒçƒ­æœºå¤‡ä»½å½“ç„¶æ˜¯å¾ˆå¥½çš„æ–¹å¼ã€‚åŒçƒ­æœºå¤‡ä»½åˆ†ä¸ºå¯¹ç§°å¼å’Œéå¯¹ç§°å¼ï¼Œå¯¹ç§°å¼å³è¿›å‡ºæµé‡åªèƒ½èµ°ç›¸åŒçš„è®¾å¤‡ï¼Œéå¯¹ç§°å¼åˆ™æ²¡æœ‰è¿™ä¸ªè¦æ±‚ï¼Œå¯ä»¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚è¿™é‡Œç®€å•åˆ—ä¸¾ä¸€ä¸‹å¯¹ç§°å¼çš„å®ç°æ–¹å¼ï¼š</p>
<ul>
<li>åˆ©ç”¨VRRPå®ç°æµé‡åˆ‡æ¢</li>
<li>åˆ©ç”¨åŠ¨æ€è·¯ç”±å®ç°æµé‡åˆ‡æ¢</li>
</ul>
<h2 id="NATç©¿è¶ŠæŠ€æœ¯"><a href="#NATç©¿è¶ŠæŠ€æœ¯" class="headerlink" title="NATç©¿è¶ŠæŠ€æœ¯"></a>NATç©¿è¶ŠæŠ€æœ¯</h2><p>è¿™é‡Œåªæ˜¯æ’ä¸ªçœ¼ï¼Œä¸åšæ·±å…¥ç ”ç©¶ï¼ŒNATç©¿è¶ŠæŠ€æœ¯æœ‰ï¼š</p>
<ul>
<li>ALG</li>
<li>æ¢é’ˆæŠ€æœ¯STUNä¸TURN</li>
<li>ä¸­é—´ä»¶æŠ€æœ¯</li>
<li>ä¸­ç»§ä»£ç†æŠ€æœ¯</li>
<li>ç‰¹å®šåè®®çš„è‡ªç©¿è¶ŠæŠ€æœ¯</li>
</ul>
<h2 id="NATä¸VPN"><a href="#NATä¸VPN" class="headerlink" title="NATä¸VPN"></a>NATä¸VPN</h2><p>å¸¸è§çš„VPNæœ‰ï¼šGREã€L2TPã€IPsecã€SSL VPNç­‰ã€‚NATåœ¨å·¥ä½œè¿‡ç¨‹ä¸­ä¼šä¿®æ”¹L3å’ŒL4çš„ä¿¡æ¯ï¼Œåœ¨åˆ†æVPNä¸NATå…±å­˜æ—¶ï¼Œé¦–å…ˆéœ€è¦åˆ†æè¯¥VPNéš§é“çš„å°è£…æ–¹å¼ï¼Œçœ‹æœ‰æ²¡æœ‰ä¼ è¾“å±‚ç«¯å£ï¼Œå…¶æ¬¡è¦åˆ†æVPNéš§é“çš„åå•†è¿‡ç¨‹ä¸­æ˜¯å¦ä½¿ç”¨æŠ¥æ–‡çš„IPåœ°å€ã€‚å…·ä½“åˆ†æåœ¨è¿™é‡Œä¸å±•å¼€äº†ï¼Œè¯´ä¸ªç»“è®ºï¼šSSL VPNä¸L2TP VPNä¸NATå¯ä»¥å¤©ç„¶å…±å­˜ï¼ŒIPsec VPNåœ¨éƒ¨åˆ†æ¨¡å¼ä¸‹å¯ä¸NATå…±å­˜ï¼Œè€ŒGREæ— æ³•ç©¿è¶ŠNAT.</p>
<h2 id="NATä¸è·¯ç”±çš„å…³ç³»åŠä¸€äº›å¤„ç†ç»†èŠ‚"><a href="#NATä¸è·¯ç”±çš„å…³ç³»åŠä¸€äº›å¤„ç†ç»†èŠ‚" class="headerlink" title="NATä¸è·¯ç”±çš„å…³ç³»åŠä¸€äº›å¤„ç†ç»†èŠ‚"></a>NATä¸è·¯ç”±çš„å…³ç³»åŠä¸€äº›å¤„ç†ç»†èŠ‚</h2><p>å¯¹ciscoçš„å®ç°ï¼Œå‚è§ä¸‹å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/cisco_nat_seq.png"><br>å¯¹äºinside-&gt;outsideçš„æµé‡ï¼ŒNATè½¬åŒ–å‘ç”Ÿåœ¨routingä¹‹åï¼›å¯¹äºoutside-&gt;insideçš„æµé‡ï¼ŒNATè½¬æ¢å‘ç”Ÿåœ¨è·¯ç”±ä¹‹å‰.æ‰€ä»¥è‡ªciscoçš„å®ç°ä¸­ï¼ŒNATä¸è·¯ç”±çš„å…³ç³»åªå–å†³äºæµé‡çš„æ–¹å‘ï¼Œé€šè¿‡inside/outsideä¿®é¥°æ¥å£åˆ†å‰²å‡ºä¸¤ä¸ªåŒºåŸŸï¼Œé€šè¿‡source/destè¡¨æ˜æµé‡çš„æ–¹å‘ã€‚</p>
<p>Ciscoä¼šåœ¨ç‰¹å®šçš„æ—¶é—´å°†â€œä¸€æ¡NATæ˜ å°„ç­–ç•¥â€å®‰è£…åˆ°ç³»ç»Ÿçš„inside NATè¡¨æˆ–è€…outside NATè¡¨ä¸­ï¼Œå¯¹äºä»ç½‘å£è¿›å…¥çš„æ•°æ®åŒ…ï¼Œä¼šæ ¹æ®ç½‘å£æ˜¯insideè¿˜æ˜¯outsideå»åŒ¹é…inside NATè¡¨æˆ–è€…outside NATè¡¨ä¸­çš„NATè§„åˆ™ï¼Œä»…æ­¤è€Œå·²ã€‚ä¸ç®¡æ˜¯inside NATè¡¨è¿˜æ˜¯outside NATè¡¨ï¼Œéƒ½å„æœ‰ä¸¤å¼ ï¼Œä¸€å¼ æ˜¯SNATè¡¨ï¼Œå¦ä¸€å¼ æ˜¯DNATè¡¨ã€‚å¯¹äºæ¯ä¸€ä¸ªæ•°æ®åŒ…ï¼Œéƒ½è¦ç”¨æºIPåœ°å€å»æŸ¥è¯¢SNATè¡¨ï¼Œç”¨ç›®æ ‡IPåœ°å€å»æŸ¥è¯¢DNATè¡¨ã€‚è¿™åœ¨ä¸‹é¢çš„é™æ€NATå®éªŒä¸­å°†æœ‰å¾ˆå¥½çš„ä½“ç°ã€‚</p>
<p>å¯¹Linuxçš„å®ç°ï¼Œå‚è§ä¸‹å›¾ï¼š<br><img src="https://rancho333.github.io/pictures/linux_nat_seq.jpg"><br>Linuxä¸­å¹¶æ²¡æœ‰å°†NATåº”ç”¨äºæ¥å£çš„è¯´æ³•ï¼ŒNATçš„é…ç½®æ˜¯å…¨å±€çš„ã€‚æ­¤æ—¶æ¥å£å°±æ˜¯ä¸€ä¸ªmatchï¼Œå†™match/targetå»åŒ¹é…æ‰§è¡Œå°±å¥½ã€‚SNATä½äºpost-routingåŸŸï¼ŒDNATä½äºpre-routingåŸŸã€‚SNATæŒ‡çš„æ˜¯å†…ç½‘å‘å¾€å¤–ç½‘çš„æµé‡ä¿®æ”¹src ip, DNATæŒ‡çš„æ˜¯å¤–ç½‘å‘å¾€å†…ç½‘çš„æµé‡ä¿®æ”¹dest ipã€‚Linuxä¸­çš„NATæ˜¯åŸºäºäº”å…ƒç»„çš„ï¼Œä¹Ÿå°±æ˜¯NATç»“æœå’Œä¸€ä¸ªæµ(conntrack)å…³è”åœ¨ä¸€èµ·ã€‚</p>
<p>Linuxçš„natä¸­ï¼Œå¾…è½¬æ¢çš„IPåœ°å€æ˜¯ä¸€ä¸ªmatchï¼Œå› æ­¤ä¸ç®¡æ˜¯ä¸€å¯¹ä¸€çš„è½¬æ¢è¿˜æ˜¯ä¸€å¯¹å¤šçš„è½¬æ¢ï¼ŒåŸç†éƒ½æ˜¯ä¸€æ ·çš„ã€‚Linuxå¹¶ä¸åŒºåˆ†é™æ€è½¬æ¢å’ŒåŠ¨æ€è½¬æ¢ã€‚åœ¨å†…æ ¸ä¸­ï¼Œæ°¸è¿œéƒ½ä¸ä¼šå‡ºç°æ‰€è°“çš„NATæ˜ å°„è¡¨ï¼Œiptablesæ·»åŠ çš„NATè§„åˆ™ä¸ä¼šç”Ÿæˆæ˜ å°„ï¼Œæ•°æ®åŒ…è¿›å…¥åŒ¹é…natæˆåŠŸï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ˜ å°„ï¼Œnatç»“æœä»…ä»…å­˜åœ¨äºconntrackä¸­ä½œä¸ºtupleçš„ä¸€éƒ¨åˆ†ä½“ç°ã€‚</p>
<p>Linuxçš„natæŸ¥è¯¢å¯¹äºç¬¬ä¸€ä¸ªåŒ…æ˜¯é€æ¡åŒ¹é…iptables natè¡¨è§„åˆ™ï¼Œå¯¹äºåç»­çš„åŒ…ï¼Œåˆ™è½¬åŒ–ä¸ºé’ˆå¯¹äº”å…ƒç»„çš„conntrackå“ˆå¸ŒæŸ¥è¯¢ã€‚</p>
<p>å€Ÿç”¨ä¸€ä¸‹SONiCä¸­å¯¹NATçš„é…ç½®ï¼š<br><img src="https://rancho333.github.io/pictures/sonic_nat_config.png"><br>å‘½ä»¤è¡Œé‡Œé¢é»˜è®¤çš„NATç±»å‹æ˜¯dnatï¼Œè¿™é‡Œä¸ç†è§£ï¼Œç­‰å¾…åç»­ä½¿ç”¨å»éªŒè¯ã€‚è¿™ä¸ªNATæ¡ç›®åªæœ‰å¤–ç½‘å‘åˆ°å†…ç½‘çš„æµé‡æ‰ä¼šè§¦å‘å‘€ï¼Ÿè¿™ä¸ç¬¦åˆNATä½¿ç”¨æœ€å¤šçš„åœºæ™¯å‘€ï¼</p>
<p>æ€ç§‘å¼ºè°ƒä½¿ç”¨è€…å¾—ä½¿ç”¨åŸŸï¼ŒLinuxå¼ºè°ƒæŠ€æœ¯æœ¬èº«çš„åˆç†æ€§.</p>
<h2 id="SONiCä¸­NATçš„å®ç°"><a href="#SONiCä¸­NATçš„å®ç°" class="headerlink" title="SONiCä¸­NATçš„å®ç°"></a>SONiCä¸­NATçš„å®ç°</h2><p><a href="https://github.com/Azure/SONiC/blob/master/doc/nat/nat_design_spec.md">SONiCä¸­NAT</a>æ˜¯SONiCå¯¹NATçš„è®¾è®¡æ–‡æ¡£ã€‚é‰´äºTH4ä¸æ”¯æŒNATï¼ŒSONiCçš„ä¸ŠNATçš„å®éªŒåç»­å†è¿›è¡Œã€‚</p>
<h2 id="NAT-PT-V4-V6åœ°å€è½¬æ¢"><a href="#NAT-PT-V4-V6åœ°å€è½¬æ¢" class="headerlink" title="NAT-PT(V4/V6åœ°å€è½¬æ¢)"></a>NAT-PT(V4/V6åœ°å€è½¬æ¢)</h2><p>IPv4ä¸IPv6çš„è¿‡æ¸¡æŠ€æœ¯æœ‰åŒæ ˆã€éš§é“å’Œç¿»è¯‘ã€‚å…¶ä¸­ç¿»è¯‘å°±æ˜¯ä½¿ç”¨çš„NAT-PTæŠ€æœ¯ã€‚è¿™é‡Œæ’ä¸ªçœ¼ï¼Œåç»­æœ‰éœ€è¦åœ¨æ·±å…¥ã€‚</p>
<h1 id="GNS3ä¸ŠNATçš„åŸºæœ¬å®éªŒ"><a href="#GNS3ä¸ŠNATçš„åŸºæœ¬å®éªŒ" class="headerlink" title="GNS3ä¸ŠNATçš„åŸºæœ¬å®éªŒ"></a>GNS3ä¸ŠNATçš„åŸºæœ¬å®éªŒ</h1><p>ä»¥ä¸Šéƒ½æ˜¯çœ‹çš„ä¸€äº›æ–‡æ¡£èµ„æ–™ï¼Œå®éªŒçœ‹çœ‹æ•ˆæœæ‰å¥½ï¼Œå®éªŒç¯å¢ƒä¸ºGNS3+c3600ï¼Œåšä¸‰ä¸ªåŸºæœ¬åœºæ™¯çš„å®éªŒï¼š</p>
<ul>
<li>é™æ€NATå®éªŒ</li>
<li>åŠ¨æ€NATå®éªŒ</li>
<li>PATå®éªŒ</li>
</ul>
<h2 id="é™æ€NATå®éªŒ"><a href="#é™æ€NATå®éªŒ" class="headerlink" title="é™æ€NATå®éªŒ"></a>é™æ€NATå®éªŒ</h2><p>åŸºæœ¬å‘½ä»¤ä¸º<code>ip nat inside static a b</code>, ç³»ç»Ÿä¼šå°†aâ€”â€”&gt;bçš„æºåœ°å€è½¬æ¢åŠ å…¥åˆ°insideçš„SNATè¡¨ä¸­ï¼ŒåŒæ—¶å°†bâ€”â€”&gt;açš„ç›®çš„åœ°å€è½¬æ¢åŠ å…¥åˆ°outsideçš„DNATè¡¨ä¸­ã€‚é’ˆå¯¹åé¢æ‰€æœ‰çš„æ•°æ®åŒ…ï¼Œä¸ç®¡æ˜¯å†…éƒ¨å‘èµ·çš„ï¼Œè¿˜æ˜¯å¤–éƒ¨å‘èµ·çš„ï¼Œéƒ½ä¼šæ ¹æ®æ¥å£ä½¿èƒ½çš„inside natè¿˜æ˜¯outside natæ¥æŸ¥è¡¨åŒ¹é…ã€‚<br>æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/topo_nat.png"><br>é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1:</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 192.168.1.2 255.255.255.0</span><br><span class="line">router ospf 1</span><br><span class="line"> network 192.168.1.0 0.0.0.255 area 0</span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 192.168.1.1 255.255.255.0</span><br><span class="line"> ip nat inside</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 202.100.10.1 255.255.255.0</span><br><span class="line"> ip nat outside</span><br><span class="line">router ospf 1</span><br><span class="line"> network 192.168.1.0 0.0.0.255 area 0</span><br><span class="line"> network 202.100.10.0 0.0.0.255 area 0</span><br><span class="line">ip nat inside source static 192.168.1.2 202.100.10.3</span><br><span class="line"></span><br><span class="line">R3:</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 202.100.10.2 255.255.255.0</span><br><span class="line">router ospf 1</span><br><span class="line"> network 202.100.10.0 0.0.0.255 area 0</span><br></pre></td></tr></table></figure>
<p>åœ¨R1ä¸Šping R3ï¼Œåˆ†åˆ«åœ¨R2çš„å·¦å³ä¸¤ä¾§è¿›è¡ŒæŠ“åŒ…ï¼Œå·¦ä¾§ä¸ºNATä¹‹å‰çš„æŠ¥æ–‡ï¼š<br><img src="https://rancho333.github.io/pictures/before_nat.png"><br>å³ä¾§ä¸ºNATä¹‹åçš„æŠ¥æ–‡ï¼Œå‘ç°src ipå·²ç»å‘ç”Ÿæ”¹å˜ï¼š<br><img src="https://rancho333.github.io/pictures/after_nat.png"></p>
<p>æ³¨æ„æˆ‘ä»¬åªé…ç½®äº†<code>ip nat inside source</code>, å³æˆ‘ä»¬åªåœ¨insideæ¥å£ä¸Šä½¿èƒ½äº†SNATï¼Œä½†æ˜¯å¯¹äºR4è¿”å›çš„æ•°æ®åŒ…ï¼Œæ˜¯åœ¨outsideæ¥å£ä¸ŠåšDNATï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åšè¿™ä¸ªé…ç½®ï¼Œè¿™æ˜¯å› ä¸ºciscoè‡ªåŠ¨è¿›è¡Œäº†è¿™ç§å…³è”ï¼Œåœ¨å‘½ä»¤è¡Œä¸­æˆ‘ä»¬ä¹Ÿä¼šå‘ç°ciscoåœ¨outsideä¸Šåªæœ‰<code>ip nat outside source</code>ã€‚ä»NATè½¬æ¢è¡¨ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ç§è‡ªåŠ¨å…³è”çš„åŠ¨ä½œã€‚<br><img src="https://rancho333.github.io/pictures/inside_source.png"><br>åœ¨pingåŠ¨ä½œä¹‹å‰ï¼Œè¡¨ä¸­å…¶å®åªæœ‰ç¬¬äºŒè¡Œï¼Œç¬¬ä¸€è¡Œçš„icmpæ˜¯pingä¹‹åæµé‡è§¦å‘æ—¶å»ºç«‹ï¼Œå‘ç°å¤šäº†outside globalå’Œoutside localå­—æ®µã€‚</p>
<p><code>ip nat outside source</code>è¡¨ç¤ºä»outsideå‘å¾€insideçš„æŠ¥æ–‡åšSNATã€‚è¿›ä¸€æ­¥çš„æ€»ç»“ä¸‹ï¼Œcisco NATçš„å››ç§ç±»å‹ï¼š</p>
<ol>
<li>ä»insideåˆ°outsideæ—¶åšSNAT</li>
<li>ä»insideåˆ°outsideæ—¶åšDNAT</li>
<li>ä»outsideåˆ°insideæ—¶åšSNAT</li>
<li>ä»outsideåˆ°insideæ—¶åšDNAT<br>å…¶ä¸­1,4æ˜¯æˆå¯¹çš„ï¼Œ2,3æ˜¯æˆå¯¹çš„ã€‚å³é…1äº†4ä¼šè‡ªåŠ¨éƒ¨ç½²ï¼Œé…3äº†2ä¼šè‡ªåŠ¨éƒ¨ç½²ï¼ŒéªŒè¯ä¸€ä¸‹2,3çš„æˆå¯¹å…³ç³»ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip nat outside source static 202.100.10.2 192.168.1.3</span><br></pre></td></tr></table></figure>
ç„¶åä½¿ç”¨R3 ping R1ï¼ŒæŠ“åŒ…ç»“æœä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/outside_ping.png"><br>å¯ä»¥çœ‹åˆ°R1ç»™192.168.1.3å›äº†icmp replyæŠ¥æ–‡ï¼Œä½†æ˜¯R3å¹¶æ²¡æœ‰æ”¶åˆ°åœ°å€è½¬æ¢åçš„æŠ¥æ–‡ã€‚</li>
</ol>
<p>NATè¡¨é¡¹è½¬æ¢ä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/outside_dest.png"><br>åŒæ ·ç¬¬ä¸€è¡Œä¸ºæˆ‘ä»¬é…ç½®çš„ï¼Œç¬¬äºŒè¡Œä¸ºæµé‡è§¦å‘çš„ï¼Œå¯ä»¥å‘ç°å¢åŠ äº†<code>inside local</code>å’Œ<code>inside local</code></p>
<p>è¿™é‡Œéœ€è¦ç»“åˆciscoä¸­NATä¸è·¯ç”±çš„å…³ç³»æ¥å›ç­”è¿™ä¸ªé—®é¢˜ï¼š<br>æ˜¾ç„¶è¿™é‡Œæ˜¯æ­¥éª¤<code>2</code>å‡ºäº†é—®é¢˜ï¼Œinside-&gt;outsideæµé‡æ˜¯åœ¨è·¯ç”±ä¹‹åå®Œæˆçš„ï¼Œå³R1ç»™R3çš„icmp replyæŠ¥æ–‡æ˜¯é’ˆå¯¹192.168.1.3åšçš„è·¯ç”±ï¼ŒR3è‡ªç„¶æ”¶ä¸åˆ°æŠ¥æ–‡<br>æ‰€ä»¥éœ€è¦åœ¨R2ä¸Šé…ç½®ä¸€æ¡é™æ€è·¯ç”±ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip route 192.168.1.3 255.255.255.255 202.100.10.2</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…åœ¨outsideä¸Šé¢é…ç½®sourceæ—¶æ·»åŠ add-routeé€‰é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip nat outside source static 202.100.10.2 192.168.1.3 add-route # add-routeä¼šç»™prefix 192.168.1.3æ·»åŠ next-hopä¸º202.100.10.2</span><br></pre></td></tr></table></figure>
<p><em>è¯´æ˜ä¸€ä¸‹ï¼šè¿™é‡Œçš„SNATå•çº¯è¡¨ç¤ºæ›¿æ¢source ipï¼ŒDNATå•çº¯è¡¨ç¤ºæ›¿æ¢dest ipï¼ŒSNATå’ŒDNATåœ¨Linuxä¸­ä¸è·¯ç”±çš„å…³ç³»åœ¨è¿™é‡Œä¸é€‚ç”¨</em></p>
<h2 id="åŠ¨æ€NATå®éªŒ"><a href="#åŠ¨æ€NATå®éªŒ" class="headerlink" title="åŠ¨æ€NATå®éªŒ"></a>åŠ¨æ€NATå®éªŒ</h2><p>å¯¹äºåŠ¨æ€NATï¼Œé…ç½®å®Œå‘½ä»¤åç³»ç»Ÿä¸ä¼šæ·»åŠ ä»»ä½•NATè§„åˆ™åªæœ‰å½“æŸä¸€ä¸ªåŒ…åŒ¹é…åˆ°äº†ACLï¼Œè¦å¼•å‘NATæ—¶ï¼Œç³»ç»Ÿä¼šåŠ¨æ€çš„ä»poolä¸­é€‰å–ä¸€ä¸ªè¦è½¬æ¢çš„IPåœ°å€ï¼ŒåŠ å…¥åˆ°insideçš„SNATè¡¨é¡¹ä¸­ï¼ŒåŒæ—¶é’ˆå¯¹åæ–¹å‘çš„ç›®çš„åœ°å€è½¬æ¢è§„åˆ™å°†å…¶åŠ å…¥åˆ°outsideçš„DNATè¡¨é¡¹ä¸­ã€‚<br>å› æ­¤ï¼Œciscoçš„åŠ¨æ€NATæ˜¯å•å‘çš„ï¼Œå› ä¸ºåå‘çš„æ•°æ®åŒ…è¿›å…¥æ—¶ä¸ä¼šåŒ¹é…åˆ°ACLï¼Œä¸ä¼šå¼•å‘NATè§„åˆ™ï¼Œä¹Ÿå°±ä¸ä¼šç”Ÿæˆä»»ä½•NATè¡¨é¡¹ã€‚åœ¨æ­¤ä¾‹ä¸­ï¼Œå¦‚æœR3å…ˆping R1æ˜¯ä¸é€šçš„ï¼Œå¿…é¡»å…ˆè®©R1 ping R3ç”ŸæˆNATè¡¨é¡¹åï¼ŒåŒæ–¹æ‰èƒ½äº’é€šã€‚</p>
<p>å®éªŒæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/topo_d_nat.png"></p>
<p>æœ¬æ¬¡å®éªŒé€šè¿‡é…ç½®ä¸€ä¸ªNATåœ°å€æ± ï¼Œè®©R1ã€R4ä¸R3é€šä¿¡æ—¶å‘ç”ŸNATè½¬æ¢ã€‚è®¾å¤‡é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R1ï¼š</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 192.168.1.2 255.255.255.0</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 192.168.1.1            #R1æ¨¡æ‹Ÿç§ç½‘ä¸»æœºï¼Œé…ç½®ç½‘å…³</span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">interface Ethernet0&#x2F;0</span><br><span class="line"> ip address 192.168.1.1 255.255.255.0</span><br><span class="line"> ip nat inside                  # é…ç½®NAT insideåŸŸ</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 202.100.10.1 255.255.255.0</span><br><span class="line"> ip nat outside                 # é…ç½®NAT outsideåŸŸ</span><br><span class="line">interface Ethernet0&#x2F;2</span><br><span class="line"> ip address 192.168.2.1 255.255.255.0</span><br><span class="line"> ip nat inside                  # é…ç½®NAT insideåŸŸ</span><br><span class="line">ip nat pool rancho-test 202.100.10.3 202.100.10.10 prefix-length 24   # è®¾ç½®NATåœ°å€æ± </span><br><span class="line">ip nat inside source list 1 pool rancho-test                          # è®¾ç½®åœ°å€æ± ä¸ACLçš„æ˜ å°„  </span><br><span class="line">access-list 1 permit 192.168.2.2                                      # è®¾ç½®ACLè§„åˆ™ï¼Œæ ‡å‡†aclåªåŒ¹é…source</span><br><span class="line">access-list 1 permit 192.168.1.2                                    </span><br><span class="line">access-list 1 deny any</span><br><span class="line"></span><br><span class="line">R3ï¼š</span><br><span class="line">interface Ethernet0&#x2F;1</span><br><span class="line"> ip address 202.100.10.2 255.255.255.0</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 202.100.10.1</span><br><span class="line"></span><br><span class="line">R4:</span><br><span class="line">interface Ethernet0&#x2F;2</span><br><span class="line"> ip address 192.168.2.2 255.255.255.0</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 192.168.2.1</span><br></pre></td></tr></table></figure>

<p>åœ¨R2å·¦å³ä¸¤ä¾§æŠ“åŒ…ï¼Œå¯¹åº”ä¸ºNATè½¬æ¢å‰åçš„åŒ…ï¼Œå¯¹äºR1 ping R3çš„æŠ“åŒ…ï¼š<br><img src="https://rancho333.github.io/pictures/r1_d_nat.png"><br>é…ç½®çš„NATåœ°å€æ± ä»202.100.10.3å¼€å§‹ï¼Œç¬¬ä¸€ä¸ªå‘½ä¸­NATè§„åˆ™çš„åˆ†é…start ipã€‚</p>
<p>å¯¹äºR4 ping R3çš„æŠ“åŒ…ï¼š<br><img src="https://rancho333.github.io/pictures/r4_d_nat.png"><br>åç»­å‘½ä¸­NATè§„åˆ™çš„ä¾æ¬¡åˆ†é…ï¼Œå¯¹äº192.168.2.2åˆ†é…å¤–ç½‘IPï¼š202.100.10.4</p>
<p>åœ¨R2ä¸ŠæŸ¥çœ‹ç”Ÿæˆçš„NATè½¬æ¢è¡¨é¡¹(åœ¨pingä¹‹å‰ä¸ºç©ºï¼Œåªæœ‰å½“å‘½ä¸­ACLè§„åˆ™ï¼Œè§¦å‘NATè½¬æ¢æ‰ä¼šç”Ÿæˆï¼Œè¿™æ˜¯å’Œé™æ€NATè¡¨é¡¹çš„åŒºåˆ«)ï¼š<br><img src="https://rancho333.github.io/pictures/nat_tran.png"><br>è½¬æ¢è¡¨é¡¹å’ŒæŠ“åŒ…çš„å¯¹æ¯”æ˜¯å»åˆçš„ã€‚</p>
<p>æŸ¥çœ‹ä¸‹R2ä¸Šå…³äºNATçš„ç»Ÿè®¡æ•°æ®ä»¥åŠä½¿èƒ½çš„NATçš„é…ç½®ï¼š<br><img src="https://rancho333.github.io/pictures/nat_stat.png"></p>
<h2 id="PATå®éªŒ"><a href="#PATå®éªŒ" class="headerlink" title="PATå®éªŒ"></a>PATå®éªŒ</h2><p>å¤ç”¨<code>åŠ¨æ€NAtå®éªŒ</code>çš„æ‹“æ‰‘å’ŒåŸºæœ¬é…ç½®ï¼Œåªéœ€è¦å°†<code>R2</code>ä¸Šçš„NATé…ç½®åšä¸€äº›ä¿®æ”¹ï¼Œä½¿R1ã€R4è®¿é—®R3æ—¶ä½¿ç”¨R2ä¸Šå³ä¾§ç«¯å£çš„IPã€‚R2ä¸Šçš„é…ç½®ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- ip nat pool rancho-test 202.100.10.3 202.100.10.10 prefix-length 24   # è®¾ç½®NATåœ°å€æ± </span><br><span class="line">- ip nat inside source list 1 pool rancho-test                          # è®¾ç½®åœ°å€æ± ä¸ACLçš„æ˜ å°„</span><br><span class="line">+ ip nat inside source list 1 interface Ethernet0&#x2F;1 overload            # ACL 1çš„æµé‡å¤ç”¨ 0&#x2F;1ç«¯å£çš„IPåœ°å€</span><br></pre></td></tr></table></figure>
<p>åŒæ ·åœ¨R2å·¦å³ä¸¤ä¾§æŠ“åŒ…ï¼Œå¯¹åº”PATè½¬æ¢å‰åçš„åŒ…ï¼Œå¯¹äºR1 telnet R3ï¼Œå‘å‡ºå»çš„åŒ…ä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/r1_pat_to.png"><br>R3å¯¹R1çš„è¿”å›åŒ…ä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/r1_pat_from.png"></p>
<p>å¯¹äºR4 telnet R3, å‘å‡ºå»çš„åŒ…ä¸º:<br><img src="https://rancho333.github.io/pictures/r4_pat_to.png"><br>R3å¯¹R4çš„è¿”å›åŒ…ä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/r4_pat_from.png"></p>
<p>æŸ¥çœ‹R2ä¸Šçš„NATè½¬æ¢è¡¨ï¼Œä¸æŠ“åŒ…å†…å®¹ç¬¦åˆï¼š<br><img src="https://rancho333.github.io/pictures/pat_tran.png"></p>
<p>è¿™é‡Œå¯ä»¥å‘ç°PATè½¬æ¢å‰åsrc portå¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜(ç›´æ¥ä½¿ç”¨çš„å°±æ˜¯æºTCPåŒ…ä¸­çš„port)ï¼Œåœ¨å‘½ä»¤é‡Œé¢ä¹Ÿæ²¡æœ‰çœ‹åˆ°é…ç½®portèŒƒå›´çš„å‘½ä»¤ï¼Œä¸çŸ¥é“è¿™æ˜¯ä¸æ˜¯æ€ç§‘çš„ç‰¹æ®Šå®ç°, å¦‚æœNATè®¾å¤‡å‘ç°ç›¸åŒçš„ç«¯å£å†å¤„ç†ï¼Ÿ<em>æ­¤å¤„å­˜ç–‘ï¼Œæ€ç§‘è‚¯å®šä¼šæœ‰å¤„ç†çš„æ–¹å¼</em></p>
<p>å¯¹äºICMPæŠ¥æ–‡çš„ç‰¹æ®Šå¤„ç†ï¼Œä»¥R1 ping R3ä¸ºä¾‹ï¼ŒICMP requestæŠ¥æ–‡ä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/r1_pat_ping_to.png"><br>ICMP replyæŠ¥æ–‡ä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/r1_pat_ping_from.png"><br>R2ä¸Šçš„NATè½¬æ¢è¡¨ä¸ºï¼š<br><img src="https://rancho333.github.io/pictures/pat_tran_ping.png"><br>è¿™é‡Œè¿™çœ‹åˆ°åœ¨PATæ¨¡å¼ä¸­ï¼ŒNATè®¾å¤‡é€šè¿‡ICMPæŠ¥æ–‡ä¸­çš„identifierå­—æ®µæ¥æ ‡è¯†ä¸€ä¸ªICMPçš„NATè½¬æ¢ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://datatracker.ietf.org/doc/html/rfc2663">rfc2663</a><br><a href="https://datatracker.ietf.org/doc/html/rfc3022">rfc3022</a><br><a href="https://datatracker.ietf.org/doc/html/rfc4787">rfc4787</a><br><a href="https://blog.csdn.net/armlinuxww/article/details/113541634">å½»åº•ç†è§£Cisco NATå†…éƒ¨çš„ä¸€äº›äº‹</a><br><a href="http://www.h3c.com/cn/d_201904/1175248_30005_0.htm#_Toc7355633">H3C NATé…ç½®</a><br><a href="https://www.firewall.cx/cisco-technical-knowledgebase/cisco-routers/260-cisco-router-nat-overload.html">CONFIGURING NAT OVERLOAD ON A CISCO ROUTER</a><br><a href="https://github.com/Azure/SONiC/blob/master/doc/nat/nat_design_spec.md#221-snat-and-dnat">SONiC NAT design</a></p>
]]></content>
      <tags>
        <tag>NAT</tag>
      </tags>
  </entry>
  <entry>
    <title>Systemdå­¦ä¹ </title>
    <url>/2021/01/26/Systemd%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>Systemdæ˜¯ç°ä»£Linuxçš„æœåŠ¡å¯åŠ¨ç®¡ç†ã€‚Linuxçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹å·²ç»ç”±<code>init</code>å˜æˆ<code>systemd</code>äº†ã€‚</p>
<span id="more"></span>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[rancho sonic-buildimage]$ ps -ef | grep root | grep init</span><br><span class="line">root         1     0  0  2020 ?        00:19:51 &#x2F;sbin&#x2F;init splash</span><br><span class="line">[rancho sonic-buildimage]$ file &#x2F;sbin&#x2F;init</span><br><span class="line">&#x2F;sbin&#x2F;init: symbolic link to &#x2F;lib&#x2F;systemd&#x2F;systemd</span><br></pre></td></tr></table></figure>
<p>initçš„ä¸¤ä¸ªç¼ºç‚¹:</p>
<ol>
<li>å¯åŠ¨æ—¶é—´é•¿ã€‚initæ˜¯ä¸²è¡Œå¯åŠ¨ã€‚</li>
<li>å¯åŠ¨è„šæœ¬å¤æ‚ã€‚initè¿›ç¨‹åªæ˜¯æ‰§è¡Œå¯åŠ¨è„šæœ¬ï¼Œä¸ç®¡å…¶å®ƒäº‹æƒ…ã€‚æ‰€ä»¥è„šæœ¬é‡Œé¢è¦å¤„ç†å„ç§æƒ…å†µï¼Œå¦‚ä¾èµ–å…³ç³»ç­‰ï¼Œè¿™ä½¿å¾—è„šæœ¬å˜å¾—å¤æ‚ä¸”é•¿ã€‚</li>
</ol>
<h1 id="Systemdæ¦‚è¿°"><a href="#Systemdæ¦‚è¿°" class="headerlink" title="Systemdæ¦‚è¿°"></a>Systemdæ¦‚è¿°</h1><p>Linuxä¸€ç›´æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„ç®¡ç†å¹³å°ï¼Œæ‰€ä»¥å„ç§èµ„æ–™ä¸å­¦ä¹ éƒ½å¾ˆé›¶æ•£ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªåˆ†æ•£çš„ç®¡ç†ç³»ç»Ÿã€‚Systemdæ˜¯ä¸€ä¸ªè¶‹åŠ¿ï¼Œä¸ç„¶è¿™ä¹ˆå¤šå‘è¡Œç‰ˆ(Arch Linuxã€Debianç³»ã€Red Hatç³»)ä¹Ÿä¸ä¼šå»é›†æˆå®ƒäº†ã€‚</p>
<p>Systemdçš„è®¾è®¡ç›®æ ‡æ˜¯ï¼šä¸ºç³»ç»Ÿçš„å¯åŠ¨å’Œç®¡ç†æä¾›ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>Systemdçš„ä¼˜ç‚¹æ˜¯åŠŸèƒ½å¼ºå¤§ï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚ç¼ºç‚¹æ˜¯ä½“ç³»åºå¤§ï¼Œéå¸¸å¤æ‚ï¼Œä¸æ“ä½œç³»ç»Ÿå…¶å®ƒéƒ¨åˆ†å¼ºè€¦åˆã€‚<br><img src="https://rancho333.github.io/pictures/arch_of_systemd.png"></p>
<h1 id="Systemdå‘½ä»¤æ—"><a href="#Systemdå‘½ä»¤æ—" class="headerlink" title="Systemdå‘½ä»¤æ—"></a>Systemdå‘½ä»¤æ—</h1><p>Systemdæ˜¯ä¸€ç»„å‘½ä»¤çš„é›†åˆï¼Œæ¶‰åŠåˆ°ç³»ç»Ÿç®¡ç†çš„å„ä¸ªæ–¹é¢ã€‚</p>
<h2 id="systemctl"><a href="#systemctl" class="headerlink" title="systemctl"></a>systemctl</h2><p><code>systemctl</code>æ˜¯Systemdçš„ä¸»å‘½ä»¤ï¼Œç”¨äºç³»ç»Ÿç®¡ç†ã€‚systemctlæ¥å—æœåŠ¡ï¼ˆ.serviceï¼‰ï¼ŒæŒ‚è½½ç‚¹ï¼ˆ.mountï¼‰,å¥—æ¥å£ï¼ˆ.socketï¼‰å’Œè®¾å¤‡ï¼ˆ.deviceï¼‰ä½œä¸ºå•å…ƒã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl --version                 #æŸ¥çœ‹systemdçš„ç‰ˆæœ¬</span><br><span class="line">systemctl reboot                    #é‡å¯ç³»ç»Ÿ</span><br><span class="line">systemctl poweroff                  #æ‰ç”µ</span><br><span class="line">systemctl halt                      #CPUåœæ­¢å·¥ä½œ</span><br><span class="line">systemctl suspend                   #æš‚åœç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">systemctl list-unit-files           #åˆ—å‡ºæ‰€æœ‰å¯ç”¨å•å…ƒ</span><br><span class="line">            [--type&#x3D;service]        #æ‰€æœ‰æœåŠ¡</span><br><span class="line">            [--type&#x3D;mount]          #æ‰€æœ‰ç³»ç»ŸæŒ‚è½½ç‚¹</span><br><span class="line">            [--type&#x3D;socket]         #æ‰€æœ‰å¯ç”¨ç³»ç»Ÿå¥—æ¥å£</span><br><span class="line">systemctl list-units                #åˆ—å‡ºæ‰€æœ‰è¿è¡Œä¸­çš„å•å…ƒ</span><br><span class="line">systemctl --failed                  #åˆ—å‡ºæ‰€æœ‰å¤±è´¥çš„å•å…ƒ</span><br><span class="line"></span><br><span class="line">systemctl status                    #æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€</span><br><span class="line">            [XX.service]            #æ£€æŸ¥æŸä¸ªæœåŠ¡çŠ¶æ€</span><br><span class="line">systemctl start XX.service          </span><br><span class="line">systemctl restart XX.service</span><br><span class="line">systemctl stop XX.service</span><br><span class="line">systemctl reload XX.service         #å¯åŠ¨ã€é‡å¯ã€åœæ­¢ã€é‡è½½æœåŠ¡</span><br><span class="line"></span><br><span class="line">systemctl is-active XX.service      #æ£€æŸ¥æŸä¸ªå•å…ƒæ˜¯å¦æ­£åœ¨è¿è¡Œ</span><br><span class="line">systemctl is-enabled XX.service     #æ£€æŸ¥æŸä¸ªå•å…ƒæ˜¯å¦å¯ç”¨</span><br><span class="line">systemctl is-failed XX.service      #æ£€æŸ¥æŸä¸ªå•å…ƒæ˜¯å¦å¯åŠ¨å¤±è´¥</span><br><span class="line"></span><br><span class="line">systemctl enable XX.service         #åœ¨å¯åŠ¨æ—¶å¯ç”¨æœåŠ¡</span><br><span class="line">systemctl disable XX.service        #åœ¨å¯åŠ¨æ—¶ç¦æ­¢æœåŠ¡</span><br><span class="line">systemctl kill XX.service           #æ€æ­»æœåŠ¡</span><br><span class="line">systemctl show XX                   #æ£€æŸ¥æŸä¸ªæœåŠ¡çš„æ‰€æœ‰é…ç½®ç»†èŠ‚</span><br><span class="line"></span><br><span class="line">systemctl mask XX.service           #å±è”½æœåŠ¡</span><br><span class="line">systemctl unmask XX.service         #æ˜¾ç¤ºæœåŠ¡</span><br><span class="line"></span><br><span class="line">systemctl list-dependencies XX.service      #è·å–æŸä¸ªæœåŠ¡çš„ä¾èµ–æ€§åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">systemctl get-default               #æŸ¥çœ‹å¯åŠ¨æ—¶çš„é»˜è®¤target</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload             # é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶</span><br><span class="line">systemctl restart foobar            # é‡å¯ç›¸å…³æœåŠ¡</span><br></pre></td></tr></table></figure>

<h2 id="systemd-analyze"><a href="#systemd-analyze" class="headerlink" title="systemd-analyze"></a>systemd-analyze</h2><p>æœåŠ¡åˆ†æå·¥å…·ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemd-analyze                     #æŸ¥çœ‹å¯åŠ¨è€—æ—¶</span><br><span class="line">systemd-analyze plot                #ç”Ÿæˆæ›´ç›´è§‚çš„å›¾è¡¨</span><br><span class="line">systemd-analyze blame               #æŸ¥çœ‹å„ä¸ªè¿›ç¨‹è€—è´¹æ—¶é—´</span><br><span class="line">systemd-analyze critical-chain      #åˆ†æå¯åŠ¨æ—¶çš„å…³é”®é“¾</span><br><span class="line">systemd-analyze critical-chain XX.service   #åˆ†ææŸä¸ªæœåŠ¡çš„å…³é”®é“¾</span><br></pre></td></tr></table></figure>

<h2 id="ä¸å¸¸ç”¨å‘½ä»¤"><a href="#ä¸å¸¸ç”¨å‘½ä»¤" class="headerlink" title="ä¸å¸¸ç”¨å‘½ä»¤"></a>ä¸å¸¸ç”¨å‘½ä»¤</h2><p>systemdçš„æœ‰äº›å‘½ä»¤åŠŸèƒ½ä¼šå’ŒæŸäº›å‘½ä»¤é‡åˆï¼Œè¿˜æœ‰ä¸€äº›ä¸å¸¸è§çš„å‘½ä»¤ï¼Œå¦‚ï¼šhostnamectlã€localectlã€timedatectlã€loginctlã€‚</p>
<h1 id="Unit"><a href="#Unit" class="headerlink" title="Unit"></a>Unit</h1><p>Systemdå¯ä»¥ç®¡ç†æ‰€æœ‰çš„ç³»ç»Ÿèµ„æºï¼Œä¸åŒçš„èµ„æºç»Ÿç§°ä¸ºunit(å•å…ƒ)ã€‚<br>unitä¸€å…±åˆ†æˆ12ç§.   </p>
<ul>
<li>service : ç³»ç»ŸæœåŠ¡</li>
<li>target : å¤šä¸ªunitæ„æˆçš„ä¸€ä¸ªç»„</li>
<li>device : ç¡¬ä»¶è®¾å¤‡</li>
<li>mount : æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹</li>
<li>automount : è‡ªåŠ¨æŒ‚è½½ç‚¹</li>
<li>path ï¼š æ–‡ä»¶æˆ–è·¯å¾„</li>
<li>scope ï¼š ä¸æ˜¯ç”±systemdå¯åŠ¨çš„å¤–éƒ¨è¿›ç¨‹</li>
<li>slice ï¼š è¿›ç¨‹ç»„</li>
<li>snapshot : systemdå¿«ç…§ï¼Œå¯ä»¥åˆ‡å›æŸä¸ªå¿«ç…§</li>
<li>socket : è¿›ç¨‹é—´é€šä¿¡çš„socket</li>
<li>swap : swapæ–‡ä»¶</li>
<li>timer : å®šæ—¶å™¨</li>
</ul>
<h2 id="unité…ç½®æ–‡ä»¶"><a href="#unité…ç½®æ–‡ä»¶" class="headerlink" title="unité…ç½®æ–‡ä»¶"></a>unité…ç½®æ–‡ä»¶</h2><p>æ¯ä¸€ä¸ªunitéƒ½æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰systemdæ€ä¹ˆå¯åŠ¨è¿™ä¸ªunitã€‚<br>systemdé»˜è®¤ä»<code>/etc/systemd/system</code>è¯»å–é…ç½®æ–‡ä»¶ã€‚è¿™é‡Œé¢éƒ¨åˆ†æ–‡ä»¶æ˜¯ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘<code>/lib/systemd/system</code>æˆ–è€…<code>/usr/lib/systemd/system</code>ã€‚</p>
<p><code>systemctl enable</code>çš„æœ¬è´¨å°±æ˜¯åœ¨ä¸Šé¢ä¸¤ä¸ªç›®å½•çš„æ–‡ä»¶ä¹‹é—´å»ºç«‹ç¬¦å·é“¾æ¥å…³ç³»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable XX.service</span><br><span class="line">ç­‰åŒäº</span><br><span class="line">ln -s &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;XX.service &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;XX.service</span><br></pre></td></tr></table></figure>
<p><img src="https://rancho333.github.io/pictures/systemd_enable.png"></p>
<p>å¦‚æœé…ç½®æ–‡ä»¶é‡Œé¢è®¾ç½®äº†å¼€æœºå¯åŠ¨ï¼Œ<code>systemctl enable</code>å‘½ä»¤ç›¸å½“äºæ¿€æ´»å¼€æœºå¯åŠ¨ã€‚</p>
<p>é…ç½®æ–‡ä»¶çš„åç¼€åå°±æ˜¯è¯¥unitçš„ç§ç±»ï¼Œsystemdé»˜è®¤åç¼€åæ˜¯<code>.service</code>ï¼Œæ‰€ä»¥<code>bluetooth</code>ç­‰æ•ˆäº<code>bluetooth.service</code>ã€‚</p>
<p><code>systemctl list-unit-files</code>ä¼šæ˜¾ç¤ºæ¯ä¸ªunitçš„çŠ¶æ€ï¼Œä¸€å…±æœ‰å››ç§ï¼š</p>
<ul>
<li>enabledï¼šå·²å»ºç«‹å¯åŠ¨è¿æ¥</li>
<li>disabledï¼šæœªå»ºç«‹å¯åŠ¨é“¾æ¥</li>
<li>static: è¯¥é…ç½®æ–‡ä»¶æ²¡æœ‰[install]éƒ¨åˆ†ï¼Œæ— æ³•é€šè¿‡enableå‘½ä»¤è¿›è¡Œå®‰è£…ã€‚åªèƒ½åšä¸ºå…¶å®ƒunitçš„ä¾èµ–(Afterå­—æ®µæˆ–Requireså­—æ®µ)æˆ–è€…æ‰‹åŠ¨å¼€å¯ã€‚ç›¸åçš„ï¼ŒåŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œå®ƒæ— æ³•é€šè¿‡disableå…³é—­ï¼Œä¸€èˆ¬ç”¨åœ¨å¿…é¡»å¯åŠ¨çš„unitä¸Šã€‚å¦‚å†™ä¸€ä¸ªrc-local.serviceï¼Œå®ç°å¼€æœºåè‡ªåŠ¨å®ç°æŸäº›åŠŸèƒ½ã€‚</li>
<li>maskedï¼šè¯¥é…ç½®æ–‡ä»¶è¢«ç¦æ­¢å»ºç«‹å¯åŠ¨é“¾æ¥</li>
</ul>
<h2 id="é…ç½®æ–‡ä»¶çš„æ ¼å¼"><a href="#é…ç½®æ–‡ä»¶çš„æ ¼å¼" class="headerlink" title="é…ç½®æ–‡ä»¶çš„æ ¼å¼"></a>é…ç½®æ–‡ä»¶çš„æ ¼å¼</h2><p>é…ç½®æ–‡ä»¶ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><img src="https://rancho333.github.io/pictures/systemd_config_file.png"></p>
<p>é…ç½®æ–‡ä»¶åˆ†ä¸ºUnitã€Serviceã€Installç­‰åŒºå—ï¼Œæ¯ä¸ªåŒºå—ä¸­éƒ½æ˜¯key-valueå½¢å¼çš„é…ç½®ã€‚</p>
<p><code>[Unit]</code>æ˜¯é…ç½®æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰Unitçš„å…ƒæ•°æ®ï¼Œä»¥åŠé…ç½®ä¸å…¶ä»–Unitçš„å…³ç³»ï¼Œä¸»è¦å­—æ®µå¦‚ä¸‹ï¼š</p>
<ul>
<li>Description: ç®€çŸ­æè¿°</li>
<li>Documentation: æ–‡æ¡£åœ°å€</li>
<li>Requires: å½“å‰ Unit ä¾èµ–çš„å…¶ä»– Unitï¼Œå¦‚æœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¼šå¯åŠ¨å¤±è´¥</li>
<li>Wantsï¼šä¸å½“å‰ Unit é…åˆçš„å…¶ä»– Unitï¼Œå¦‚æœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¸ä¼šå¯åŠ¨å¤±è´¥</li>
<li>BindsToï¼šä¸Requiresç±»ä¼¼ï¼Œå®ƒæŒ‡å®šçš„ Unit å¦‚æœé€€å‡ºï¼Œä¼šå¯¼è‡´å½“å‰ Unit åœæ­¢è¿è¡Œ</li>
<li>Beforeï¼šå¦‚æœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹åå¯åŠ¨</li>
<li>Afterï¼šå¦‚æœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹å‰å¯åŠ¨</li>
<li>Conflictsï¼šè¿™é‡ŒæŒ‡å®šçš„ Unit ä¸èƒ½ä¸å½“å‰ Unit åŒæ—¶è¿è¡Œ</li>
<li>Conditionâ€¦ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¸ä¼šè¿è¡Œ</li>
<li>Assertâ€¦ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥å¯åŠ¨å¤±è´¥</li>
</ul>
<p><code>[Service]</code>åŒºå—ç”¨æ¥Serviceé…ç½®ï¼Œåªæœ‰Serviceç±»å‹çš„Unitæ‰ä¼šæœ‰è¿™ä¸ªåŒºå—ï¼Œå®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ï¼š</p>
<ul>
<li>Typeï¼šå®šä¹‰å¯åŠ¨æ—¶çš„è¿›ç¨‹è¡Œä¸ºã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§å€¼<ul>
<li>Type=simpleï¼šé»˜è®¤å€¼ï¼Œæ‰§è¡ŒExecStartæŒ‡å®šçš„å‘½ä»¤ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹</li>
<li>Type=forkingï¼šä»¥ fork æ–¹å¼ä»çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œåˆ›å»ºåçˆ¶è¿›ç¨‹ä¼šç«‹å³é€€å‡º</li>
<li>Type=oneshotï¼šä¸€æ¬¡æ€§è¿›ç¨‹ï¼ŒSystemd ä¼šç­‰å½“å‰æœåŠ¡é€€å‡ºï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li>
<li>Type=dbusï¼šå½“å‰æœåŠ¡é€šè¿‡D-Buså¯åŠ¨</li>
<li>Type=notifyï¼šå½“å‰æœåŠ¡å¯åŠ¨å®Œæ¯•ï¼Œä¼šé€šçŸ¥Systemdï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li>
<li>Type=idleï¼šè‹¥æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æœåŠ¡æ‰ä¼šè¿è¡Œ</li>
</ul>
</li>
<li>ExecStartï¼šå¯åŠ¨å½“å‰æœåŠ¡çš„å‘½ä»¤</li>
<li>ExecStartPreï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤</li>
<li>ExecStartPostï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤</li>
<li>ExecReloadï¼šé‡å¯å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤</li>
<li>ExecStopï¼šåœæ­¢å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤</li>
<li>ExecStopPostï¼šåœæ­¢å½“å…¶æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤</li>
<li>RestartSecï¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡é—´éš”çš„ç§’æ•°</li>
<li>Restartï¼šå®šä¹‰ä½•ç§æƒ…å†µ Systemd ä¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬alwaysï¼ˆæ€»æ˜¯é‡å¯ï¼‰ã€on-successã€on-failureã€on-abnormalã€on-abortã€on-watchdog</li>
<li>TimeoutSecï¼šå®šä¹‰ Systemd åœæ­¢å½“å‰æœåŠ¡ä¹‹å‰ç­‰å¾…çš„ç§’æ•°</li>
<li>Environmentï¼šæŒ‡å®šç¯å¢ƒå˜é‡</li>
</ul>
<p><code>[Install]</code>é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„æœ€åä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰å¦‚ä½•å¯åŠ¨ï¼Œä»¥åŠæ˜¯å¦å¼€æœºå¯åŠ¨ï¼Œå®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ï¼š</p>
<ul>
<li>WantedByï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼ˆenableï¼‰ç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .wantsåç¼€æ„æˆçš„å­ç›®å½•ä¸­</li>
<li>RequiredByï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼Œç¬¦å·é“¾æ¥ä¼šæ”¾å…¥/etc/systemd/systemç›®å½•ä¸‹é¢ä»¥ Target å + .requiredåç¼€æ„æˆçš„å­ç›®å½•ä¸­</li>
<li>Aliasï¼šå½“å‰ Unit å¯ç”¨äºå¯åŠ¨çš„åˆ«å</li>
<li>Alsoï¼šå½“å‰ Unit æ¿€æ´»ï¼ˆenableï¼‰æ—¶ï¼Œä¼šè¢«åŒæ—¶æ¿€æ´»çš„å…¶ä»– Unit</li>
</ul>
<p>Unité…ç½®æ–‡ä»¶çš„å®Œæ•´key-valueæ¸…å•ï¼Œå‚è§<a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h1 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h1><p>è®¡ç®—æœºå¯åŠ¨çš„æ—¶å€™ï¼Œéœ€è¦å¯åŠ¨å¤§é‡çš„Unitã€‚å¦‚æœæ¯ä¸€æ¬¡å¯åŠ¨ï¼Œéƒ½è¦ä¸€ä¸€å†™æ˜æœ¬æ¬¡å¯åŠ¨éœ€è¦é‚£äº›Unitï¼Œæ˜¾ç„¶éå¸¸ä¸æ–¹ä¾¿ã€‚Systemdçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯Targetã€‚</p>
<p>Targetå°±æ˜¯ä¸€ä¸ªUnitç»„ï¼ŒåŒ…å«è®¸å¤šç›¸å…³çš„Unitã€‚å¯åŠ¨æŸä¸ªTargetçš„æ—¶å€™ï¼ŒSystemdå°±ä¼šå¯åŠ¨é‡Œé¢æ‰€æœ‰çš„Unitã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒTargetè¿™ä¸ªæ¦‚å¿µç±»ä¼¼äºâ€œçŠ¶æ€ç‚¹â€ï¼Œå¯åŠ¨æŸä¸ªTargetå°±å¥½æ¯”å¯åŠ¨åˆ°æŸç§çŠ¶æ€ã€‚</p>
<p>ä¼ ç»Ÿçš„Initå¯åŠ¨æ¨¡å¼ä¸­ï¼Œæœ‰Runlevleçš„æ¦‚å¿µï¼Œå’ŒTargetçš„ä½œç”¨å¾ˆç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼ŒRunlevelæ˜¯äº’æ–¥çš„ï¼Œä½†æ˜¯å¤šä¸ªTargetæ˜¯å¯ä»¥åŒæ—¶å¯åŠ¨çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl get-default           #æŸ¥çœ‹å¯åŠ¨æ—¶çš„é»˜è®¤ Target</span><br><span class="line">systemctl list-dependencies multi-user.target   #æŸ¥çœ‹ä¸€ä¸ª Target åŒ…å«çš„æ‰€æœ‰ Unit</span><br></pre></td></tr></table></figure>

<p>å®ƒä¸Initçš„ä¸»è¦å·®åˆ«å¦‚ä¸‹ï¼š</p>
<ol>
<li>é»˜è®¤çš„ RunLevelï¼ˆåœ¨/etc/inittabæ–‡ä»¶è®¾ç½®ï¼‰ç°åœ¨è¢«é»˜è®¤çš„ Target å–ä»£ï¼Œä½ç½®æ˜¯/etc/systemd/system/default.targetï¼Œé€šå¸¸ç¬¦å·é“¾æ¥åˆ°graphical.targetï¼ˆå›¾å½¢ç•Œé¢ï¼‰æˆ–è€…multi-user.targetï¼ˆå¤šç”¨æˆ·å‘½ä»¤è¡Œï¼‰ã€‚</li>
<li>å¯åŠ¨è„šæœ¬çš„ä½ç½®ï¼Œä»¥å‰æ˜¯/etc/init.dç›®å½•ï¼Œç¬¦å·é“¾æ¥åˆ°ä¸åŒçš„ RunLevel ç›®å½• ï¼ˆæ¯”å¦‚/etc/rc3.dã€/etc/rc5.dç­‰ï¼‰ï¼Œç°åœ¨åˆ™å­˜æ”¾åœ¨/lib/systemd/systemå’Œ/etc/systemd/systemç›®å½•ã€‚</li>
<li>é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œä»¥å‰initè¿›ç¨‹çš„é…ç½®æ–‡ä»¶æ˜¯/etc/inittabï¼Œå„ç§æœåŠ¡çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨/etc/sysconfigç›®å½•ã€‚ç°åœ¨çš„é…ç½®æ–‡ä»¶ä¸»è¦å­˜æ”¾åœ¨/lib/systemdç›®å½•ï¼Œåœ¨/etc/systemdç›®å½•é‡Œé¢çš„ä¿®æ”¹å¯ä»¥è¦†ç›–åŸå§‹è®¾ç½®ã€‚</li>
</ol>
<h1 id="æ—¥å¿—ç®¡ç†"><a href="#æ—¥å¿—ç®¡ç†" class="headerlink" title="æ—¥å¿—ç®¡ç†"></a>æ—¥å¿—ç®¡ç†</h1><p>Systemdç»Ÿä¸€ç®¡ç†Unitçš„å¯åŠ¨æ—¥å¿—ï¼Œé€šè¿‡<code>journalctl</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼Œæ—¥å¿—çš„é…ç½®æ–‡ä»¶æ˜¯<code>/etc/systemd/journald.conf</code>ã€‚å®ƒçš„åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œç”¨æ³•ä¹Ÿå¾ˆå¤šã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">journalctl                      # æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆé»˜è®¤æƒ…å†µä¸‹ ï¼Œåªä¿å­˜æœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼‰</span><br><span class="line"></span><br><span class="line">journalctl -k                   # æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼ˆä¸æ˜¾ç¤ºåº”ç”¨æ—¥å¿—ï¼‰</span><br><span class="line"></span><br><span class="line">journalctl -b                    # æŸ¥çœ‹ç³»ç»Ÿæœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—</span><br><span class="line">journalctl -b -0</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æŒ‡å®šæ—¶é—´çš„æ—¥å¿—</span><br><span class="line">journalctl --since&#x3D;&quot;2012-10-30 18:17:16&quot;</span><br><span class="line">journalctl --since &quot;20 min ago&quot;</span><br><span class="line">journalctl --since yesterday</span><br><span class="line">journalctl --since &quot;2015-01-10&quot; --until &quot;2015-01-11 03:00&quot;</span><br><span class="line">journalctl --since 09:00 --until &quot;1 hour ago&quot;</span><br><span class="line"></span><br><span class="line">journalctl -n                   # æ˜¾ç¤ºå°¾éƒ¨çš„æœ€æ–°10è¡Œæ—¥å¿—</span><br><span class="line">journalctl -n 20                # æ˜¾ç¤ºå°¾éƒ¨æŒ‡å®šè¡Œæ•°çš„æ—¥å¿—</span><br><span class="line"></span><br><span class="line">journalctl -f                   # å®æ—¶æ»šåŠ¨æ˜¾ç¤ºæœ€æ–°æ—¥å¿—</span><br><span class="line"></span><br><span class="line">journalctl &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;systemd    # æŸ¥çœ‹æŒ‡å®šæœåŠ¡çš„æ—¥å¿—</span><br><span class="line"></span><br><span class="line">journalctl _PID&#x3D;1               # æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ—¥å¿—</span><br><span class="line"></span><br><span class="line">journalctl &#x2F;usr&#x2F;bin&#x2F;bash        # æŸ¥çœ‹æŸä¸ªè·¯å¾„çš„è„šæœ¬çš„æ—¥å¿—</span><br><span class="line"></span><br><span class="line">journalctl _UID&#x3D;33 --since today    # æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„æ—¥å¿—</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æŸä¸ª Unit çš„æ—¥å¿—</span><br><span class="line">journalctl -u nginx.service</span><br><span class="line">journalctl -u nginx.service --since today</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æŒ‡å®šä¼˜å…ˆçº§ï¼ˆåŠå…¶ä»¥ä¸Šçº§åˆ«ï¼‰çš„æ—¥å¿—ï¼Œå…±æœ‰8çº§</span><br><span class="line"># 0: emerg</span><br><span class="line"># 1: alert</span><br><span class="line"># 2: crit</span><br><span class="line"># 3: err</span><br><span class="line"># 4: warning</span><br><span class="line"># 5: notice</span><br><span class="line"># 6: info</span><br><span class="line"># 7: debug</span><br><span class="line">journalctl -p err -b</span><br><span class="line"></span><br><span class="line">journalctl --disk-usage                  # æ˜¾ç¤ºæ—¥å¿—å æ®çš„ç¡¬ç›˜ç©ºé—´</span><br><span class="line"></span><br><span class="line">journalctl --vacuum-size&#x3D;1G            # æŒ‡å®šæ—¥å¿—æ–‡ä»¶å æ®çš„æœ€å¤§ç©ºé—´</span><br><span class="line"></span><br><span class="line">journalctl --vacuum-time&#x3D;1years             # æŒ‡å®šæ—¥å¿—æ–‡ä»¶ä¿å­˜å¤šä¹…</span><br></pre></td></tr></table></figure>

<h1 id="å‡ ä¸ªé—®é¢˜"><a href="#å‡ ä¸ªé—®é¢˜" class="headerlink" title="å‡ ä¸ªé—®é¢˜"></a>å‡ ä¸ªé—®é¢˜</h1><p>åˆ—ä¸¾å‡ ä¸ªåœ¨systemdä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚</p>
<h2 id="å¼€æœºå¯åŠ¨ä¸å¯åŠ¨æœåŠ¡"><a href="#å¼€æœºå¯åŠ¨ä¸å¯åŠ¨æœåŠ¡" class="headerlink" title="å¼€æœºå¯åŠ¨ä¸å¯åŠ¨æœåŠ¡"></a>å¼€æœºå¯åŠ¨ä¸å¯åŠ¨æœåŠ¡</h2><p><code>systemctl enable</code>è®¾ç½®æœåŠ¡å¼€æœºå¯åŠ¨ï¼Œè¯¥æœåŠ¡éœ€è¦ç­‰åˆ°ä¸‹ä¸€æ¬¡å¼€æœºæ‰ä¼šå¯åŠ¨ã€‚<code>systemctl start</code>è¡¨æ˜ç«‹å³å¯åŠ¨è¯¥æœåŠ¡ã€‚</p>
<h2 id="UnitåŒºå—ä¸­çš„å¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³»"><a href="#UnitåŒºå—ä¸­çš„å¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³»" class="headerlink" title="UnitåŒºå—ä¸­çš„å¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³»"></a>UnitåŒºå—ä¸­çš„å¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³»</h2><p>å¯åŠ¨é¡ºåºç”±<code>Before</code>å’Œ<code>After</code>å­—æ®µè¡¨ç¤ºã€‚Beforeè¡¨æ˜åº”è¯¥åœ¨valueè¡¨ç¤ºçš„æœåŠ¡<em>ä¹‹å‰</em>å¯åŠ¨ï¼ŒAfterè¡¨ç¤ºåº”è¯¥åœ¨valueè¡¨ç¤ºçš„æœåŠ¡<em>ä¹‹å</em>å¯åŠ¨ã€‚è¿™ä¸¤ä¸ªå­—æ®µåªæ¶‰åŠåˆ°å¯åŠ¨é¡ºåºè€Œä¸è®¾è®¡ä¾èµ–å…³ç³»ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼ŒSONiCä¸­çš„bgpæœåŠ¡éœ€è¦ç”¨redisæ•°æ®åº“å­˜å‚¨æ•°æ®ã€‚å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­åªå®šä¹‰åœ¨redisä¹‹åå¯åŠ¨ï¼Œè€Œæ²¡æœ‰å®šä¹‰ä¾èµ–å…³ç³»ã€‚è®¾å¤‡å¯åŠ¨åï¼Œç”±äºæŸäº›åŸå› ï¼ŒredisæŒ‚æ‰äº†ï¼Œè¿™ä¹‹åbgpå°±ä¼šæ— æ³•å»ºç«‹æ•°æ®åº“è¿æ¥ã€‚</p>
<p>è®¾ç½®ä¾èµ–å…³ç³»ï¼Œéœ€è¦ä½¿ç”¨<code>Wants</code>å’Œ<code>Requires</code>å­—æ®µã€‚Wantså­—æ®µè¡¨æ˜ä¸¤è€…ä¹‹é—´å­˜åœ¨<em>å¼±ä¾èµ–</em>å…³ç³»ï¼Œå³å¦‚æœvalueè¡¨æ˜çš„æœåŠ¡å¯åŠ¨å¤±è´¥æˆ–è€…åœæ­¢è¿è¡Œï¼Œä¸å½±å“ä¸»æœåŠ¡çš„ç»§ç»­æ‰§è¡Œã€‚Requireså­—æ®µåˆ™è¡¨æ˜ä¸¤è€…ä¹‹é—´å­˜åœ¨<em>å¼ºä¾èµ–</em>å…³ç³»ï¼Œå³å¦‚æœvalueè¡¨æ˜çš„æœåŠ¡å¯åŠ¨å¤±è´¥æˆ–è€…å¼‚å¸¸é€€å‡ºï¼Œé‚£ä¹ˆä¸»æœåŠ¡ä¹Ÿå¿…é¡»é€€å‡ºã€‚æ³¨æ„è¿™ä¸¤ä¸ªå­—æ®µåªæ¶‰åŠä¾èµ–å…³ç³»ï¼Œä¸å¯åŠ¨é¡ºåºæ— å…³ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸æ˜¯åŒæ—¶å¯åŠ¨çš„ã€‚</p>
<p>ä¾èµ–äºæŸä¸€æœåŠ¡æ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥åŒæ—¶å®šä¹‰Requireså’ŒAfterå­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚<br><img src="https://rancho333.github.io/pictures/requires_after.png"></p>
<h2 id="ServicesåŒºå—çš„å°é—®é¢˜"><a href="#ServicesåŒºå—çš„å°é—®é¢˜" class="headerlink" title="ServicesåŒºå—çš„å°é—®é¢˜"></a>ServicesåŒºå—çš„å°é—®é¢˜</h2><p>ServicesåŒºå—å®šä¹‰å¦‚ä½•å¯åŠ¨å½“å‰æœåŠ¡ã€‚</p>
<p>åœ¨æ‰€æœ‰çš„å¯åŠ¨è®¾ç½®ä¹‹å‰åŠ ä¸Šä¸€ä¸ªè¿è¯å·(-),è¡¨ç¤º<em>æŠ‘åˆ¶é”™è¯¯</em>ï¼Œå³é”™è¯¯å‘ç”Ÿçš„æ—¶å€™ï¼Œä¸å½±å“å…¶å®ƒå‘½ä»¤çš„æ‰§è¡Œã€‚æ¯”å¦‚ï¼Œ<code>EnvironmentFile=-/etc/sysconfig/sshd</code>ï¼ˆæ³¨æ„ç­‰å·åé¢çš„é‚£ä¸ªè¿è¯å·ï¼‰ï¼Œå°±è¡¨ç¤ºå³ä½¿<code>/etc/sysconfig/sshd</code>æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚</p>
<p><code>KillMode</code>å­—æ®µå®šä¹‰äº†Systemdå¦‚ä½•åœæ­¢æœåŠ¡ï¼Œvalueå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">control-groupï¼ˆé»˜è®¤å€¼ï¼‰ï¼šå½“å‰æ§åˆ¶ç»„é‡Œé¢çš„æ‰€æœ‰å­è¿›ç¨‹ï¼Œéƒ½ä¼šè¢«æ€æ‰</span><br><span class="line">processï¼šåªæ€ä¸»è¿›ç¨‹</span><br><span class="line">mixedï¼šä¸»è¿›ç¨‹å°†æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå­è¿›ç¨‹æ”¶åˆ° SIGKILL ä¿¡å·</span><br><span class="line">noneï¼šæ²¡æœ‰è¿›ç¨‹ä¼šè¢«æ€æ‰ï¼Œåªæ˜¯æ‰§è¡ŒæœåŠ¡çš„ stop å‘½ä»¤ã€‚</span><br></pre></td></tr></table></figure>

<p><code>Restart</code>å­—æ®µå®šä¹‰äº†æœåŠ¡é€€å‡ºåï¼Œsystemdé‡å¯è¯¥æœåŠ¡çš„æ–¹å¼ï¼Œvalueå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">noï¼ˆé»˜è®¤å€¼ï¼‰ï¼šé€€å‡ºåä¸ä¼šé‡å¯</span><br><span class="line">on-successï¼šåªæœ‰æ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç ä¸º0ï¼‰ï¼Œæ‰ä¼šé‡å¯</span><br><span class="line">on-failureï¼šéæ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç é0ï¼‰ï¼ŒåŒ…æ‹¬è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯</span><br><span class="line">on-abnormalï¼šåªæœ‰è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯</span><br><span class="line">on-abortï¼šåªæœ‰åœ¨æ”¶åˆ°æ²¡æœ‰æ•æ‰åˆ°çš„ä¿¡å·ç»ˆæ­¢æ—¶ï¼Œæ‰ä¼šé‡å¯</span><br><span class="line">on-watchdogï¼šè¶…æ—¶é€€å‡ºï¼Œæ‰ä¼šé‡å¯</span><br><span class="line">alwaysï¼šä¸ç®¡æ˜¯ä»€ä¹ˆé€€å‡ºåŸå› ï¼Œæ€»æ˜¯é‡å¯</span><br></pre></td></tr></table></figure>
<p>SONiCä¸­å¾ˆå¤šæœåŠ¡Restartéƒ½è®¾ç½®ä¸ºalwaysï¼Œå¦‚swssæœåŠ¡ã€‚<code>RestartSec</code>å­—æ®µè¡¨ç¤ºsystemdé‡å¯æœåŠ¡ä¹‹å‰ï¼Œéœ€è¦ç­‰å¾…çš„ç§’æ•°ã€‚</p>
<h2 id="InstallåŒºå—çš„å°é—®é¢˜"><a href="#InstallåŒºå—çš„å°é—®é¢˜" class="headerlink" title="InstallåŒºå—çš„å°é—®é¢˜"></a>InstallåŒºå—çš„å°é—®é¢˜</h2><p>InstallåŒºå—å®šä¹‰å¦‚ä½•å®‰è£…è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå³æ€æ ·åšåˆ°å¼€æœºå¯åŠ¨ã€‚</p>
<p><code>WanteBy</code>å­—æ®µè¡¨ç¤ºè¯¥æœåŠ¡æ‰€åœ¨çš„Targetã€‚systemdé»˜è®¤å¯åŠ¨çš„Targetå¯ä»¥é€šè¿‡<code>systemctl get-default</code>æŸ¥çœ‹åˆ°ã€‚æœåŠ¡å¿…é¡»åŠ åˆ°è¿™ä¸ªTargetæˆ–è¿™ä¸ªTargetçš„å­Targetä¸­æ‰èƒ½å¼€æœºå¯åŠ¨ã€‚</p>
<p>å¸¸ç”¨çš„Targetæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯<code>multi-user.target</code>ï¼Œè¡¨ç¤ºå¤šç”¨æˆ·å‘½ä»¤è¡ŒçŠ¶æ€ï¼›å¦ä¸€ä¸ªæ˜¯<code>graphical.target</code>ï¼Œè¡¨ç¤ºå›¾å½¢ç”¨æˆ·çŠ¶æ€ï¼Œå®ƒä¾èµ–äº<code>multi-user.target</code>ï¼ŒSONiCä½¿ç”¨çš„æ˜¯åè€…ã€‚å®˜æ–¹æ–‡æ¡£æœ‰ä¸€å¼ éå¸¸æ¸…æ™°çš„<a href="https://www.freedesktop.org/software/systemd/man/bootup.html#System%20Manager%20Bootup">Targetä¾èµ–å…³ç³»å›¾</a></p>
<h2 id="Targetçš„é…ç½®æ–‡ä»¶"><a href="#Targetçš„é…ç½®æ–‡ä»¶" class="headerlink" title="Targetçš„é…ç½®æ–‡ä»¶"></a>Targetçš„é…ç½®æ–‡ä»¶</h2><p>åœ¨<code>/lib/systemd/system</code>ä¸‹å¯ä»¥æ‰¾åˆ°Targetçš„é…ç½®æ–‡ä»¶,ä»¥<code>graphical.target</code>ä¸ºä¾‹ï¼š<br><img src="https://rancho333.github.io/pictures/graphical_target.png"><br>å…¶ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Requireså­—æ®µï¼šè¦æ±‚basic.targetä¸€èµ·è¿è¡Œã€‚</span><br><span class="line">Conflictså­—æ®µï¼šå†²çªå­—æ®µã€‚å¦‚æœrescue.serviceæˆ–rescue.targetæ­£åœ¨è¿è¡Œï¼Œmulti-user.targetå°±ä¸èƒ½è¿è¡Œï¼Œåä¹‹äº¦ç„¶ã€‚</span><br><span class="line">Afterï¼šè¡¨ç¤ºmulti-user.targetåœ¨basic.target ã€ rescue.serviceã€ rescue.targetä¹‹åå¯åŠ¨ï¼Œå¦‚æœå®ƒä»¬æœ‰å¯åŠ¨çš„è¯ã€‚</span><br><span class="line">AllowIsolateï¼šå…è®¸ä½¿ç”¨systemctl isolateå‘½ä»¤åˆ‡æ¢åˆ°multi-user.targetã€‚</span><br></pre></td></tr></table></figure>

<h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>ä¸€èˆ¬è€Œè¨€ï¼Œé…ç½®æ–‡ä»¶å­˜æ”¾åœ¨<code>/lib/systemd/system</code>å’Œ<code>/usr/lib/systemd/system</code>ç›®å½•ä¸‹ï¼Œé€šè¿‡<code>systemctl enable</code>åœ¨<code>/etc/systemd/system</code>åˆ›å»ºç¬¦å·é“¾æ¥æŒ‡å‘å‰è€…ï¼ŒSystemdä¼šæ‰§è¡Œetcä¸‹çš„æ–‡ä»¶ï¼Œå‰ææ˜¯æ–‡ä»¶ä¸­çš„Installé…å¯¹äº†Targetã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">Systemdå…¥é—¨æ•™ç¨‹ï¼šå‘½ä»¤ç¯‡</a><br><a href="https://linux.cn/article-5926-1.html">systemctl å‘½ä»¤å®Œå…¨æŒ‡å—</a></p>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>Systemd</tag>
      </tags>
  </entry>
  <entry>
    <title>sonic-testbed</title>
    <url>/2020/12/18/sonic-testbed/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ€åˆï¼ŒSONiCçš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½æ˜¯ç”¨ansible playbookå†™çš„ã€‚2019å¹´å¼€å§‹ä½¿ç”¨pytestï¼Œ 2020å¹´9æœˆä»½ä¹‹åï¼Œåªæœ‰ç”¨pytestå†™çš„æµ‹è¯•ç”¨ä¾‹æ‰è¢«é‡‡çº³ã€‚<br>ä½†æ˜¯ansibleä¾ç„¶å¾ˆé‡è¦ï¼Œpytest-ansibleæ’ä»¶è¿æ¥pytestä¸ansibleã€‚pytesté€šè¿‡ansibleè¿›è¡Œå¤šè®¾å¤‡ååŒå·¥ä½œã€‚</p>
<span id="more"></span>
<h2 id="ç‰©ç†æ‹“æ‰‘"><a href="#ç‰©ç†æ‹“æ‰‘" class="headerlink" title="ç‰©ç†æ‹“æ‰‘"></a>ç‰©ç†æ‹“æ‰‘</h2><p><img src="https://rancho333.github.io/pictures/physical-topology.png"></p>
<ol>
<li>DUTå’Œleaf fanoutçš„ç«¯å£ä¸€ä¸€äº’è”</li>
<li>leaf fanoutä¸DUTç›¸è¿çš„ç«¯å£è¿›è¡ŒVLANéš”ç¦»</li>
<li>root fanoutè¿æ¥leaf fanoutä¸testbed server</li>
<li>root fanoutçš„ç«¯å£å·¥ä½œåœ¨vlan trunkæ¨¡å¼ä¸‹</li>
<li>ä»»ä¸€testbed serverå¯ä»¥å‘é€å¸¦æœ‰vlan tagçš„åŒ…åˆ°è¾¾DUTç«¯å£ï¼ˆroot fanoutçš„trunkå£éœ€è¦ä½¿èƒ½è¯¥vlan tagï¼‰</li>
</ol>
<h3 id="Fanout-switch"><a href="#Fanout-switch" class="headerlink" title="Fanout switch"></a>Fanout switch</h3><p><em>Fanout switchæ˜¯ä½¿èƒ½äº†vlan trunkingçš„ç‰©ç†äº¤æ¢æœº</em></p>
<ul>
<li>Et33æ˜¯ä¸€ä¸ªvlan trunkingç«¯å£ï¼Œå¹¶ä¸”å’Œlinux hostçš„eth0è¿æ¥</li>
<li>Et1-Et32æ˜¯vlan accessç«¯å£ï¼Œå¹¶ä¸”ä¸DUTè¿æ¥</li>
<li>ä½¿èƒ½LACP/LLDP</li>
<li>å…³é—­STPåŠŸèƒ½</li>
</ul>
<h3 id="Testbed-server"><a href="#Testbed-server" class="headerlink" title="Testbed server"></a>Testbed server</h3><p><img src="https://rancho333.github.io/pictures/testbed-server.png"></p>
<h4 id="ç½‘ç»œè¿æ¥"><a href="#ç½‘ç»œè¿æ¥" class="headerlink" title="ç½‘ç»œè¿æ¥"></a>ç½‘ç»œè¿æ¥</h4><ul>
<li>testbed serveræœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£<ul>
<li>trunkç«¯å£è¿æ¥root fanout</li>
<li>management portç®¡ç†æœåŠ¡å™¨ä»¥åŠæœåŠ¡å™¨ä¸Šçš„VMså’ŒPTFå®¹å™¨</li>
</ul>
</li>
</ul>
<h3 id="VMs"><a href="#VMs" class="headerlink" title="VMs"></a>VMs</h3><p>VMsä½¿ç”¨çš„æ˜¯Aristaçš„vEOSã€‚å®ƒä»¬ç”¨æ¥è®¾ç½®æµ‹è¯•åè®®ï¼Œä¾‹å¦‚BGPã€LACPã€LLDPç­‰ã€‚å®ƒä»¬é€šè¿‡<code>testbed-cli.sh start-vms</code>è¿›è¡Œåˆ›å»ºã€‚æ¯ä¸€ä¸ªVMä½¿ç”¨2Gå†…å­˜å¹¶ä¸”æ‹¥æœ‰10ä¸ªç½‘ç»œæ¥å£ã€‚<br>    * 8ä¸ªå‰é¢æ¿ç«¯å£ã€‚è¿™äº›ç«¯å£ç”¨æ¥è¿æ¥åˆ°openvswitchç½‘æ¡¥ï¼Œè¿æ¥åˆ°vlan interfaces.vlan interfaceé€šè¿‡ç‰©ç†æ¥å£è¿æ¥åˆ°fanoutã€‚<br>    * ä¸€ä¸ªåèƒŒæ¿ç«¯å£ã€‚æ‰€æœ‰VMsé€šè¿‡è¿™ä¸ªèƒŒæ¿å£äº’è”ã€‚<br>    * ä¸€ä¸ªç®¡ç†ç½‘å£ã€‚ç”¨æ¥ç®¡ç†VMs.</p>
<h3 id="PTF"><a href="#PTF" class="headerlink" title="PTF"></a>PTF</h3><p>PTFå®¹å™¨é€šè¿‡å‘é€å’Œæ¥æ”¶æ•°æ®åŒ…æ¥éªŒè¯DUTçš„æ•°æ®é¢ã€‚<br>PTF with direct port<br><img src="https://rancho333.github.io/pictures/testbed-direct.png"></p>
<p>DUTçš„å‰é¢æ¿å£ç›´è¿åˆ°ä¸€ä¸ªPTFå®¹å™¨çš„ç«¯å£ã€‚ä¸€èˆ¬çš„PTFå®¹å™¨çš„eth0è¿æ¥åˆ°DUTçš„Ethernet0ï¼Œeth1è¿æ¥åˆ°Ethernet4ã€‚è¿™ä¸€èˆ¬åœ¨PTFæ‹“æ‰‘ä¸­ç”¨æ¥è¿æ¥DUTç«¯å£å’ŒPTFå®¹å™¨ç«¯å£ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/testbed-injected.png"></p>
<p>DUTçš„å‰é¢æ¿å£å’Œä¸€ä¸ªVMçš„æ¥å£ç›´è¿ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªè¿æ¥ä¸Šæœ‰ä¸ªtapã€‚ä»vlan interfaceä¸­æ”¶åˆ°çš„åŒ…è¢«å‘é€ç»™VMså’ŒPTFå®¹å™¨ã€‚ä»VMå’ŒPTFå®¹å™¨ä¸­å‘å‡ºçš„åŒ…è¢«é€åˆ°vlan interfaceã€‚è¿™å…è®¸æˆ‘ä»¬å¯ä»¥åŒæ—¶ä»PTF hostå¾€DUTæ³¨å…¥åŒ…å’Œç»´æŒVMä¸DUTä¹‹é—´çš„BGPä¼šè¯ã€‚</p>
<h3 id="SONiC-Tested-with-keysight-IxNetwork-as-Traffic-Generator"><a href="#SONiC-Tested-with-keysight-IxNetwork-as-Traffic-Generator" class="headerlink" title="SONiC Tested with keysight IxNetwork as Traffic Generator"></a>SONiC Tested with keysight IxNetwork as Traffic Generator</h3><p>TO BE DONEï¼ï¼</p>
<h2 id="Testbedè®¾ç½®"><a href="#Testbedè®¾ç½®" class="headerlink" title="Testbedè®¾ç½®"></a>Testbedè®¾ç½®</h2><p>ä¸‹é¢è®²è¿°testbedçš„è®¾ç½®æ­¥éª¤ä»¥åŠæ‹“æ‰‘çš„éƒ¨ç½²ã€‚</p>
<h3 id="å‡†å¤‡testbedæœåŠ¡å™¨"><a href="#å‡†å¤‡testbedæœåŠ¡å™¨" class="headerlink" title="å‡†å¤‡testbedæœåŠ¡å™¨"></a>å‡†å¤‡testbedæœåŠ¡å™¨</h3><ul>
<li>ç³»ç»Ÿè¦æ±‚ï¼šubuntu 18.04 amd64</li>
<li>è®¾ç½®ç®¡ç†å£ï¼Œä½¿ç”¨å¦‚ä¸‹ç¤ºä¾‹ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@server-1:~# cat &#x2F;etc&#x2F;network&#x2F;interfaces</span><br><span class="line"># The management network interface</span><br><span class="line">auto ma0</span><br><span class="line">iface ma0 inet manual</span><br><span class="line"></span><br><span class="line"># Server, VM and PTF management interface</span><br><span class="line">auto br1</span><br><span class="line">iface br1 inet static</span><br><span class="line">    bridge_ports ma0</span><br><span class="line">    bridge_stp off</span><br><span class="line">    bridge_maxwait 0</span><br><span class="line">    bridge_fd 0</span><br><span class="line">    address 10.250.0.245</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    network 10.250.0.0</span><br><span class="line">    broadcast 10.250.0.255</span><br><span class="line">    gateway 10.250.0.1</span><br><span class="line">    dns-nameservers 10.250.0.1 10.250.0.2</span><br><span class="line">    # dns-* options are implemented by the resolvconf package, if installed</span><br></pre></td></tr></table></figure></li>
<li>å®‰è£…python2.7ï¼ˆAnsibleéœ€è¦ï¼‰</li>
<li>æ·»åŠ Dockerçš„å®˜æ–¹GPG keyï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ curl -fsSL https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;ubuntu&#x2F;gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ä¸ºdocker-pthè®¾ç½®dockerä»“åº“"><a href="#ä¸ºdocker-pthè®¾ç½®dockerä»“åº“" class="headerlink" title="ä¸ºdocker-pthè®¾ç½®dockerä»“åº“"></a>ä¸º<code>docker-pth</code>è®¾ç½®dockerä»“åº“</h3><ol>
<li>build <code>docker-pth</code>é•œåƒ<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone --recursive https:&#x2F;&#x2F;github.com&#x2F;Azure&#x2F;sonic-buildimage.git</span><br><span class="line">cd sonic-buildimage</span><br><span class="line">make configure PLATFORM&#x3D;generic</span><br><span class="line">make target&#x2F;docker-ptf.gz</span><br></pre></td></tr></table></figure></li>
<li>è®¾ç½®è‡ªå·±çš„dockerä»“åº“å¹¶å°†<code>docker-ptf</code>ä¸Šä¼ </li>
</ol>
<h3 id="åˆ›å»ºå¹¶ä¸”è¿è¡Œdocker-sonic-mgmt"><a href="#åˆ›å»ºå¹¶ä¸”è¿è¡Œdocker-sonic-mgmt" class="headerlink" title="åˆ›å»ºå¹¶ä¸”è¿è¡Œdocker-sonic-mgmt"></a>åˆ›å»ºå¹¶ä¸”è¿è¡Œ<code>docker-sonic-mgmt</code></h3><p>ç®¡ç†testbedå’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹éœ€è¦å¾ˆå¤šä¾èµ–ã€‚å°†æ‰€æœ‰çš„ä¾èµ–éƒ¨ç½²åˆ°<code>docker-sonic-mgmt</code>ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨<code>ansible-playbook</code>ï¼Œ<code>pytest</code>ï¼Œ<code>spytest</code>ã€‚</p>
<ol>
<li><p>æ„å»º<code>docker-sonic-mgmt</code>é•œåƒ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone --recursive https:&#x2F;&#x2F;github.com&#x2F;Azure&#x2F;sonic-buildimage.git</span><br><span class="line">cd sonic-buildimage</span><br><span class="line">make configure PLATFORM&#x3D;generic</span><br><span class="line">make target&#x2F;docker-sonic-mgmt.gz</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä»<a href="https://sonic-jenkins.westus2.cloudapp.azure.com/job/bldenv/job/docker-sonic-mgmt/lastSuccessfulBuild/artifact/sonic-buildimage/target/docker-sonic-mgmt.gz">è¿™é‡Œ</a>ä¸‹è½½äº‹å…ˆç¼–è¯‘å¥½çš„é•œåƒã€‚</p>
</li>
<li><p>å…‹éš†<code>sonic-mgmt</code>åº“åˆ°testbed serverçš„å·¥ä½œç›®å½•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;Azure&#x2F;sonic-mgmt</span><br></pre></td></tr></table></figure></li>
<li><p>åˆ›å»º<code>docker-sonic-mgmt</code>å®¹å™¨ï¼Œæ³¨æ„éœ€è¦å°†ä¸Šé¢å…‹éš†çš„<code>sonic-mgmt</code>æŒ‚è½½åˆ°å®¹å™¨ä¸­å»:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker load &lt; docker-sonic-mgmt.gz</span><br><span class="line">docker run -v $PWD:&#x2F;data -it docker-sonic-mgmt bash</span><br><span class="line">cd ~&#x2F;sonic-mgmt</span><br></pre></td></tr></table></figure></li>
</ol>
<p><em>æ³¨æ„ï¼šä¹‹åçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åœ¨<code>docker-sonic-mgmt</code>å®¹å™¨ä¸­æ“ä½œ</em></p>
<h3 id="å‡†å¤‡Testbedé…ç½®"><a href="#å‡†å¤‡Testbedé…ç½®" class="headerlink" title="å‡†å¤‡Testbedé…ç½®"></a>å‡†å¤‡Testbedé…ç½®</h3><p>è¿›å…¥åˆ°å®¹å™¨ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹testbedçš„é…ç½®æ–‡ä»¶ä½¿ä¹‹ä¸å®éªŒæ‹“æ‰‘æ˜ å°„èµ·æ¥ã€‚</p>
<ul>
<li><p>Testbed Server</p>
<ul>
<li>åœ¨<code>ansible/veos</code>ä¸­æ›´æ–°serverçš„ç®¡ç†IP</li>
<li>åœ¨<code>ansible/group_vars/vm_host/creds.yml</code>ä¸­æ›´æ–°serverçš„å‡­è¯</li>
<li>åœ¨<code>ansible/host_vars/STA-ACS-SERV-01.yml</code>ä¸­æ›´æ–°serverçš„ç½‘ç»œé…ç½®ï¼ˆfor VMså’ŒPTF managementï¼‰<ul>
<li><code>external_port</code>ï¼šserverçš„trunkå£åç§°ï¼ˆè¿æ¥åˆ°fanout switchï¼‰</li>
<li><code>mgmt_gw</code>ï¼šVMç®¡ç†ç«¯å£çš„ç½‘å…³IP</li>
<li><code>mgmt_prefixlen</code>: ç®¡ç†ç½‘å£å­ç½‘æ©ç </li>
</ul>
</li>
<li>æ£€æŸ¥ansibleå¯ä»¥ä¸è¿™ä¸ªhostè¿æ¥<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible -m ping -i veos vm_host_1 </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>VMs</p>
<ul>
<li>ä»Aristaä¸‹è½½<a href="https://www.arista.com/en/support/software-download">vEOS</a></li>
<li>å°†é•œåƒæ–‡ä»¶æ‹·è´åˆ°<code>ansible/veos</code><ul>
<li><code>Aboot-veos-serial-8.0.0.iso</code></li>
<li><code>vEOS-lab-4.20.15M.vmdk</code></li>
</ul>
</li>
<li>å°†VMçš„IPåœ°å€æ›´æ–°åˆ°<code>ansible/veos</code>. è¿™ä¸ªIPåœ°å€åº”è¯¥å’Œå®šä¹‰çš„ç®¡ç†IPåœ¨åŒä¸€ä¸ªå­ç½‘ä¸­</li>
<li>åœ¨<code>ansible/group_vars/eos/creds.yml</code>ä¸­æ›´æ–°VMçš„å‡­è¯</li>
</ul>
</li>
<li><p>PTFå®¹å™¨</p>
<ul>
<li>åœ¨<code>vars/docker_registry.yml</code>ä¸­æ›´æ–°dockerä»“åº“ä¿¡æ¯</li>
</ul>
</li>
</ul>
<h3 id="è®¾ç½®VMs"><a href="#è®¾ç½®VMs" class="headerlink" title="è®¾ç½®VMs"></a>è®¾ç½®VMs</h3><ol>
<li>å¼€å¯VMsï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;testbed-cli.sh start-vms server_1 password.txt</span><br></pre></td></tr></table></figure>
<code>password.txt</code>æ˜¯ansibleçš„å¯†ç æ–‡ä»¶ï¼Œå¦‚æœä¸ä½¿ç”¨ç›´æ¥åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å³å¯ã€‚</li>
</ol>
<ol start="2">
<li>æ£€æŸ¥æ‰€æœ‰çš„VMsæ˜¯å¦å¯åŠ¨å¹¶ä¸”åœ¨è¿è¡Œä¸­<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible -m ping -i veos server_1</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="éƒ¨ç½²Fanoutäº¤æ¢æœºçš„Vlan"><a href="#éƒ¨ç½²Fanoutäº¤æ¢æœºçš„Vlan" class="headerlink" title="éƒ¨ç½²Fanoutäº¤æ¢æœºçš„Vlan"></a>éƒ¨ç½²Fanoutäº¤æ¢æœºçš„Vlan</h3><p>åœ¨éƒ¨ç½²Fanoutå’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹ä¹‹å‰éœ€è¦æ˜ç¡®ç¯å¢ƒä¸­çš„æ‰€æœ‰ç‰©ç†è¿æ¥ã€‚<br>åœ¨<code>roles/fanout</code>ä¸‹çš„playbookåªæ˜¯ç”¨æ¥éƒ¨ç½²Aristaçš„Vlané…ç½®ã€‚å¦‚æœä½¿ç”¨å…¶å®ƒç±»å‹çš„äº¤æ¢æœºï¼Œè¯·æ‰‹åŠ¨é…ç½®Vlanï¼Œæˆ–è€…éƒ¨ç½²ä¸€ä¸ª2å±‚äº¤æ¢æœºã€‚</p>
<h3 id="éƒ¨ç½²æ‹“æ‰‘"><a href="#éƒ¨ç½²æ‹“æ‰‘" class="headerlink" title="éƒ¨ç½²æ‹“æ‰‘"></a>éƒ¨ç½²æ‹“æ‰‘</h3><ul>
<li>ä½¿ç”¨è‡ªå·±çš„æ•°æ®æ›´æ–°<code>testbed.csv</code>ã€‚è‡³å°‘éœ€è¦æ›´æ–°PTFç®¡ç†æ¥å£çš„é…ç½®ã€‚</li>
<li>éƒ¨ç½²æ‹“æ‰‘è¯·è¿è¡Œï¼š<code>/testbed-cli.sh add-topo vms-t1 ~/.password</code></li>
<li>ç§»é™¤æ‹“æ‰‘è¯·è¿è¡Œ: <code>./testbed-cli.sh remove-topo vms-t1 ~/.password</code></li>
</ul>
<p>æ³¨æ„ï¼š<code>testbed-cli.sh</code>çš„æœ€åä¸€æ­¥è¯•å›¾åœ¨root fanoutä¸­é‡æ–°éƒ¨ç½²vlanèŒƒå›´ï¼ˆä¸æ‹“æ‰‘ä¸­è§„å®šçš„ç›¸åŒ¹é…ï¼‰ã€‚Aristaçš„æ­£å¸¸å·¥ä½œï¼Œå…¶å®ƒå‹å·çš„éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ï¼Ÿ</p>
<h2 id="Dockerå®¹å™¨è®¾ç½®"><a href="#Dockerå®¹å™¨è®¾ç½®" class="headerlink" title="Dockerå®¹å™¨è®¾ç½®"></a>Dockerå®¹å™¨è®¾ç½®</h2><p>ä½¿ç”¨<code>setup-container.sh</code>è„šæœ¬å»è‡ªåŠ¨åˆ›å»ºå’Œé…ç½®sonic-mgmtçš„dockerå®¹å™¨ã€‚ä½¿ç”¨æ™®é€šç”¨æˆ·useråˆ›å»ºå³å¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;setuo-container.sh -n container_name -i image_id -d directory</span><br><span class="line">image_idæ˜¯åœ¨sonic-buildimageä¸­åˆ›å»ºçš„docker-sonic-mgmt.tar</span><br><span class="line">directoryæ˜¯ä¸»æœºä¸dockerè¿›è¡Œmountçš„æ–‡ä»¶å¤¹</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå®Œdokcerå®¹å™¨ä¹‹åï¼Œå¯ä»¥è¿›å…¥å®¹å™¨ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker exec -u &lt;user&gt; -it &lt;container name&gt; bash</span><br></pre></td></tr></table></figure>

<h2 id="KVM-testbedè®¾ç½®"><a href="#KVM-testbedè®¾ç½®" class="headerlink" title="KVM testbedè®¾ç½®"></a>KVM testbedè®¾ç½®</h2><p>å¯ä»¥ç»™testbedåˆ›å»ºè™šæ‹Ÿçš„äº¤æ¢æœºï¼Œåœ¨ä¸Šé¢éƒ¨ç½²T0æ‹“æ‰‘ï¼Œè¿è¡Œä¸€ä¸ªå¿«é€Ÿæµ‹è¯•å»éªŒè¯æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚<br>å³ç‰©ç†è®¾å¤‡éƒ½è™šæ‹ŸåŒ–åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¯¹å†…å­˜èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨ç‰©ç†è®¾å¤‡è¿æ¥ï¼Œæš‚ä¸ç ”ç©¶è¿™å—å†…å®¹ã€‚<br>è¿™é‡Œé¢æœ‰vEOSä¸cEOSçš„ä»‹ç»ï¼Œåˆ†åˆ«æ˜¯åŸºäºKVMå’Œdockerçš„æŠ€æœ¯ã€‚</p>
<h2 id="cEOS"><a href="#cEOS" class="headerlink" title="cEOS"></a>cEOS</h2><p>å¦‚ä½•ä½¿ç”¨cEOSä½œä¸ºDUTçš„é‚»å±…è®¾å¤‡ã€‚<br>cEOSæ˜¯å®¹å™¨åŒ–çš„EOSã€‚æ‰€æœ‰çš„è½¯ä»¶åœ¨å®¹å™¨ä¸­è¿è¡Œã€‚ä¸vEOSç›¸æ¯”ï¼ŒcEOSå†…å­˜æš‚ç”¨æ›´å°‘ã€‚</p>
<h3 id="ç½‘ç»œè®¾ç½®"><a href="#ç½‘ç»œè®¾ç½®" class="headerlink" title="ç½‘ç»œè®¾ç½®"></a>ç½‘ç»œè®¾ç½®</h3><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŸºå®¹å™¨<code>net_$&#123;testbed_name&#125;_$&#123;vm_name&#125;</code>ï¼Œåœ¨åŸºå®¹å™¨ä¸­åˆ›å»º6ä¸ªä»¥å¤ªå£ã€‚ç„¶ååœ¨åŸºå®¹å™¨åŸºç¡€ä¸Šå¯åŠ¨cEOS<code>ceos_$&#123;testbed_name&#125;_$&#123;vm_name&#125;</code>å®¹å™¨ã€‚è¿™6ä¸ªç½‘å£åˆ†åˆ«ç”¨æ¥ï¼š</p>
<ul>
<li>ä¸€ä¸ªç®¡ç†ç½‘å£</li>
<li>4ä¸ªå‰é¢æ¿ç«¯å£ç”¨æ¥è¿æ¥DUT</li>
<li>ä¸€ä¸ªèƒŒæ¿å£è¿æ¥PTFå®¹å™¨<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+                      +----+</span><br><span class="line">|  cEOS  Ma0 +--------- VM0100-m ---+ br |</span><br><span class="line">|            |                      +----+</span><br><span class="line">|            |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|        Et1 +----------VM0100-t0---+  br-VM0100-0 |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|            |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|        Et2 +----------VM0100-t1---+  br-VM0100-1 |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|            |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|        Et3 +----------VM0100-t2---+  br-VM0100-2 |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|            |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|        Et4 +----------VM0100-t3---+  br-VM0100-3 |</span><br><span class="line">|            |                      +--------------+</span><br><span class="line">|            |</span><br><span class="line">|            |                       +--------------+</span><br><span class="line">|        Et5 +----------VM0100-back--+  br-b-vms6-1 |</span><br><span class="line">|            |                       +--------------+</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>cEOSå®¹å™¨ä¸­çš„<code>/mnt/flash</code>æŒ‚è½½åˆ°ä¸»æœºçš„<code>/data/ceos/ceos_$&#123;testbed_name&#125;_$&#123;vm_name&#125;</code>ã€‚</p>
<h3 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h3><p>ä¸¤ç§æ–¹å¼ç™»å½•åˆ°cEOSå®¹å™¨ã€‚</p>
<ol>
<li><p>docker exec</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker exec -it ceos_vms6-1_VM0100 Cli</span><br></pre></td></tr></table></figure></li>
<li><p>ssh</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lgh@jenkins-worker-15:~$ ssh admin@10.250.0.51</span><br><span class="line">Password: </span><br><span class="line">ARISTA01T1&gt;show int status</span><br><span class="line">Port       Name      Status       Vlan     Duplex Speed  Type            Flags Encapsulation</span><br><span class="line">Et1                  connected    in Po1   full   unconf EbraTestPhyPort                    </span><br><span class="line">Et2                  connected    1        full   unconf EbraTestPhyPort                    </span><br><span class="line">Et3                  connected    1        full   unconf EbraTestPhyPort                    </span><br><span class="line">Et4                  connected    1        full   unconf EbraTestPhyPort                    </span><br><span class="line">Et5        backplane connected    routed   full   unconf EbraTestPhyPort                    </span><br><span class="line">Ma0                  connected    routed   full   10G    10&#x2F;100&#x2F;1000                        </span><br><span class="line">Po1                  connected    routed   full   unconf N&#x2F;A                                </span><br><span class="line"></span><br><span class="line">ARISTA01T1&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="testbedè·¯ç”±è®¾è®¡"><a href="#testbedè·¯ç”±è®¾è®¡" class="headerlink" title="testbedè·¯ç”±è®¾è®¡"></a>testbedè·¯ç”±è®¾è®¡</h2><p>ä¸‹é¢è¯´æ˜testbedä¸­çš„BGPè·¯ç”±è®¾è®¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">              +------+</span><br><span class="line">              +  VM  +---------+</span><br><span class="line">              +------+         |</span><br><span class="line">                               |</span><br><span class="line">              +------+         |</span><br><span class="line">              +  VM  +---------+</span><br><span class="line">              +------+         |</span><br><span class="line">+-------+                  +---+---+     </span><br><span class="line">|  PTF  +------------------+  DUT  |</span><br><span class="line">+-------+                  +---+---+</span><br><span class="line">              +------+         |</span><br><span class="line">              +  VM  +---------+</span><br><span class="line">              +------+         |</span><br><span class="line">                               |</span><br><span class="line">              +------+         |</span><br><span class="line">              +  VM  +---------+</span><br><span class="line">              +------+</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ‹“æ‰‘ä¸­ï¼ŒVMsï¼ˆvEOSï¼‰å……å½“DUTçš„BGPé‚»å±…ã€‚VMsç”Ÿæˆå¹¶ä¸”å®£å‘ŠBGPè·¯ç”±ç»™DUT.è¿™ç§æ–¹å¼æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>åœ¨vEOSå¾ˆéš¾ç”Ÿæˆä»»æ„è·¯ç”±ï¼Œä¾‹å¦‚ï¼Œå†™ä¸€ä¸ªå¤æ‚çš„è·¯ç”±è¡¨ï¼Œè¿‡æ»¤ç”Ÿæˆéœ€è¦çš„è·¯ç”±</li>
<li>æ¶ˆè€—å¾ˆå¤šå†…å­˜åœ¨vENOSä¸­</li>
<li>ç‰¹å®šçš„NOSè§„åˆ™ã€‚å¦‚æœæˆ‘ä»¬æ‰“ç®—ä»VNåˆ‡æ¢åˆ°SONiCï¼Œæˆ‘ä»¬éœ€è¦é‡å†™æ‰€æœ‰çš„è·¯ç”±è¡¨ã€‚<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">              +------+</span><br><span class="line">    +---------+  VM  +---------+</span><br><span class="line">    |         +------+         |</span><br><span class="line">    |                          |</span><br><span class="line">    |         +------+         |</span><br><span class="line">    +---------+  VM  +---------+</span><br><span class="line">    |         +------+         |</span><br><span class="line">+---+---+                  +---+---+     </span><br><span class="line">|  PTF  |                  |  DUT  |</span><br><span class="line">+---+---+                  +---+---+</span><br><span class="line">    |         +------+         |</span><br><span class="line">    +---------+  VM  +---------+</span><br><span class="line">    |         +------+         |</span><br><span class="line">    |                          |</span><br><span class="line">    |         +------+         |</span><br><span class="line">    +---------+  VM  +---------+</span><br><span class="line">              +------+</span><br></pre></td></tr></table></figure>
æ–°çš„æ–¹æ³•æ˜¯å°†VMä½œä¸ºä¸€ä¸ªé€ä¼ è®¾å¤‡ï¼Œæˆ‘ä»¬åœ¨PTFå®¹å™¨ä¸Šè¿è¡Œexabgp,exabgpé€šå‘Šå¦‚æœ‰ä¿¡æ¯ç»™VMï¼ŒVMå†å°†è·¯ç”±ä¿¡æ¯é€šå‘Šç»™DUTã€‚è¿™ç§æ–¹å¼æœ‰å‡ ä¸ªå¥½å¤„ï¼š</li>
<li>VMæ¨¡æ¿å˜å¾—ç®€å•å¾ˆå¤šã€‚åªæœ‰åŸºç¡€çš„ç«¯å£ï¼Œlagï¼ŒBGPé…ç½®</li>
<li>VMçš„å†…å­˜å¼€é”€å˜å°</li>
<li>exbgpå¯ä»¥ç”Ÿæˆå¤æ‚è·¯ç”±æ¡ç›®</li>
<li>å®¹æ˜“æ”¯æŒä¸åŒçš„NOSä½œä¸ºé‚»å±…è®¾å¤‡ï¼Œä¾‹å¦‚SONiC vm</li>
</ul>
<h2 id="æ‹“æ‰‘"><a href="#æ‹“æ‰‘" class="headerlink" title="æ‹“æ‰‘"></a>æ‹“æ‰‘</h2><ol>
<li>é…ç½®testbedçš„æ‹“æ‰‘å®šä¹‰åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼š<code>testbed.csv</code></li>
<li>ä¸€ä¸ªè„šæœ¬å»æ“ä½œæ‰€æœ‰çš„testbed:<code>testbed-cli.sh</code></li>
<li>çµæ´»çš„æ‹“æ‰‘å…è®¸å°†VM_SETå’ŒPTFå®¹å™¨ä½œä¸ºä¸€ä¸ªå®ä½“çœ‹å¾…</li>
<li>æ‰€æœ‰çš„VMç®¡ç†ç½‘å£ipå®šä¹‰åœ¨ï¼š<code>veos</code></li>
<li>PTFå®¹å™¨åœ¨æ‰€æœ‰æ‹“æ‰‘ä¸­è¢«ä½¿ç”¨</li>
<li>è‡ªåŠ¨æ„å»ºfanout switchçš„é…ç½®ï¼ˆéœ€è¦è¢«é‡æ„ï¼‰</li>
<li>è¯·çœ‹ç¤ºä¾‹æ¨¡å—å¦‚æœä½ æƒ³è®¾ç½®ä»»æ„çš„testbedçš„æ‹“æ‰‘</li>
</ol>
<h3 id="testbedæ‹“æ‰‘é…ç½®"><a href="#testbedæ‹“æ‰‘é…ç½®" class="headerlink" title="testbedæ‹“æ‰‘é…ç½®"></a>testbedæ‹“æ‰‘é…ç½®</h3><ul>
<li><code>testbed.csv</code>æ–‡ä»¶ç”±ä»¥ä¸‹ç»„æˆï¼š<ul>
<li>ç‰©ç†æ‹“æ‰‘ï¼›VMså’ŒPTFå®¹å™¨çš„ç«¯å£å¦‚ä½•ä¸DUTè¿æ¥</li>
<li>VMsçš„é…ç½®æ¨¡æ¿</li>
</ul>
</li>
<li>æ‹“æ‰‘åœ¨<code>vars/topo_*.yml</code>æ–‡ä»¶ä¸­</li>
<li>å½“å‰çš„æ‹“æ‰‘æœ‰ï¼š<ul>
<li>t1:32ä¸ªVMs + ç”¨æ¥ç«¯å£æ³¨å…¥çš„PTFå®¹å™¨</li>
<li>t1-lagï¼š24ä¸ªVMs + ç”¨æ¥ç«¯å£æ³¨å…¥çš„PTFå®¹å™¨ã€‚å…¶ä¸­8ä¸ªVMsåœ¨æ¯ä¸€LAGä¸­æœ‰ä¸¤ä¸ªç«¯å£</li>
<li>ptf32: æ‹¥æœ‰32ä¸ªä¸ªç«¯å£çš„PTFå®¹å™¨ä¸DUTç«¯å£ç›´è¿</li>
<li>ptf64: å’Œptf32ç›¸åŒï¼Œä½†æ˜¯æ‹¥æœ‰64ä¸ªç«¯å£</li>
<li>t0ï¼š4ä¸ªVMs + PTFå®¹å™¨ï¼ˆ4ä¸ªç”¨æ¥ç«¯å£æ³¨å…¥ï¼Œ28ä¸ªç”¨æ¥ç›´è¿DUTï¼‰</li>
</ul>
</li>
</ul>
<h3 id="å½“å‰çš„æ‹“æ‰‘"><a href="#å½“å‰çš„æ‹“æ‰‘" class="headerlink" title="å½“å‰çš„æ‹“æ‰‘"></a>å½“å‰çš„æ‹“æ‰‘</h3><h4 id="t1"><a href="#t1" class="headerlink" title="t1"></a>t1</h4><p><img src="https://rancho333.github.io/pictures/testbed-t1.png"></p>
<ul>
<li>éœ€è¦32ä¸ªVMs</li>
<li>æ‰€æœ‰çš„DUTç«¯å£ç›´è¿VMs</li>
<li>PTFå®¹å™¨åªæœ‰æ³¨å…¥ç«¯å£</li>
</ul>
<h4 id="t1-lag"><a href="#t1-lag" class="headerlink" title="t1-lag"></a>t1-lag</h4><p><img src="https://rancho333.github.io/pictures/testbed-t1-lag.png"></p>
<ul>
<li>éœ€è¦24ä¸ªVMs</li>
<li>æ‰€æœ‰çš„DUTç«¯å£ç›´è¿VMs</li>
<li>PTFå®¹å™¨åªæœ‰æ³¨å…¥ç«¯å£</li>
</ul>
<h4 id="ptf32"><a href="#ptf32" class="headerlink" title="ptf32"></a>ptf32</h4><p><img src="https://rancho333.github.io/pictures/testbed-ptf32.png"></p>
<ul>
<li>ä¸éœ€è¦VMs</li>
<li>æ‰€æœ‰çš„DUTç«¯å£ç›´è¿PTFå®¹å™¨</li>
<li>PTFå®¹å™¨æ²¡æœ‰æ³¨å…¥ç«¯å£</li>
</ul>
<h4 id="ptf64"><a href="#ptf64" class="headerlink" title="ptf64"></a>ptf64</h4><p><img src="https://rancho333.github.io/pictures/testbed-ptf64.png"><br>å’Œptf32ä¸€æ ·</p>
<h4 id="t0"><a href="#t0" class="headerlink" title="t0"></a>t0</h4><p><img src="https://rancho333.github.io/pictures/testbed-t0.png"></p>
<ul>
<li>éœ€è¦4ä¸ªVMs</li>
<li>4ä¸ªDUTç«¯å£è¿æ¥åˆ°VMs</li>
<li>PTFå®¹å™¨æœ‰4ä¸ªæ³¨å…¥ç«¯å£ä¸28ä¸ªç›´è¿ç«¯å£</li>
</ul>
<h2 id="testbedé…ç½®"><a href="#testbedé…ç½®" class="headerlink" title="testbedé…ç½®"></a>testbedé…ç½®</h2><h3 id="testbedæ¸…å•"><a href="#testbedæ¸…å•" class="headerlink" title="testbedæ¸…å•"></a>testbedæ¸…å•</h3><ul>
<li><code>ansible/lab</code>ï¼šåŒ…å«å®éªŒçš„æ‰€æœ‰DUTsï¼Œ fanout switch, testbed serveræ‹“æ‰‘</li>
<li><code>ansible/veos</code>ï¼šæ‰€æœ‰çš„serverå’ŒVMs</li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="Sonic-Mgmt-testbedè®¾ç½®"><a href="#Sonic-Mgmt-testbedè®¾ç½®" class="headerlink" title="Sonic-Mgmt testbedè®¾ç½®"></a>Sonic-Mgmt testbedè®¾ç½®</h2><p>ä»githubä¸Šå°†sonic testbedè®¾ç½®åˆ°è‡ªå·±çš„ç¯å¢ƒä¸­å°†ä¼šæ˜¯ä¸€ä¸ªå†—é•¿çš„è¿‡ç¨‹ã€‚åœ¨å°†æµ‹è¯•ç”¨ä¾‹è·‘èµ·æ¥ä¹‹å‰æœ‰åå¤šä¸ªæ–‡ä»¶éœ€è¦æ›´æ–°ã€‚<br>ç„¶è€Œï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡testbed.yamlå’ŒTestbedProcessing.pyè‡ªåŠ¨å®Œæˆã€‚testbed.yamlæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆç¼–è¯‘æ‰€æœ‰éœ€è¦è¿è¡Œtestcaseçš„æ•°æ®åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼‰ã€‚TestbedProcess.pyçš„å·¥ä½œåŸç†æ˜¯ï¼šä»é…ç½®æ–‡ä»¶æ‹‰å–ä¿¡æ¯ï¼Œç„¶åå°†ä¿¡æ¯æ¨é€åˆ°å®ƒä»¬å±äºçš„æ–‡ä»¶ä¸­å»ã€‚è¿™ç¯‡æŒ‡å—å°†ä¼šå‹¾å‹’å¹¶ç®€æ˜“åŒ–testbedçš„è®¾ç½®ã€‚</p>
<h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>é€šè¿‡ä½¿ç”¨testbed.yamlå’ŒTestbedProcessing.pyæ¥å®Œæˆtestbedçš„è®¾ç½®ã€‚è¿™ç¯‡æŒ‡å—ç»“æŸåï¼Œåº”è¯¥å®Œæˆsonic-mgmt testbedçš„è®¾ç½®å¹¶ä¸”å°†testcasesè·‘èµ·æ¥ã€‚</p>
<h3 id="é¢„è¿ç§»è®¾ç½®"><a href="#é¢„è¿ç§»è®¾ç½®" class="headerlink" title="é¢„è¿ç§»è®¾ç½®"></a>é¢„è¿ç§»è®¾ç½®</h3><p> sonic-mgmtå¯åŠ¨å¹¶è¿è¡Œæµ‹è¯•ç”¨ä¾‹éœ€è¦ä¸‹è¿°çš„è®¾å¤‡ï¼š</p>
<ul>
<li>LinuxæœåŠ¡å™¨</li>
<li>root fanout</li>
<li>leaf fanout</li>
<li>DUT (device under test)<br>testbedçš„ä¿¡æ¯å’Œæ‹“æ‰‘å¯ä»¥ä»overviewä¸­è·å–åˆ°ã€‚</li>
</ul>
<h3 id="ä¿®æ”¹-Testbed-yamlé…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹-Testbed-yamlé…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ Testbed.yamlé…ç½®æ–‡ä»¶"></a>ä¿®æ”¹ Testbed.yamlé…ç½®æ–‡ä»¶</h3><p>åœ¨testbed.yamlä¸­æœ‰7ä¸ªä¸»è¦çš„éƒ¨åˆ†éœ€è¦ç¼–è¾‘ï¼š</p>
<ol>
<li>device_groups</li>
<li>devices</li>
<li>host_vars</li>
<li>veos_groups</li>
<li>veos</li>
<li>testbed</li>
<li>topology<br>æ¯ä¸€éƒ¨åˆ†æ–‡ä»¶çš„ä½œç”¨éƒ½éœ€è¦æŒ‰é¡ºåºçš„å†™å¥½ã€‚å…·ä½“ä¿¡æ¯åœ¨Sonic-Mgmt testbed Configurationä¸­æœ‰æè¿°</li>
</ol>
<p>å¯¹äºtestbed.yamlæ–‡ä»¶ï¼ˆåœ¨ansibleä¸‹é¢æœ‰ä¸ªtestbed-new.yamlæ–‡ä»¶ï¼‰ï¼š</p>
<h4 id="ï¼ˆå¯é€‰ï¼‰testbed-configéƒ¨åˆ†ï¼š"><a href="#ï¼ˆå¯é€‰ï¼‰testbed-configéƒ¨åˆ†ï¼š" class="headerlink" title="ï¼ˆå¯é€‰ï¼‰testbed_configéƒ¨åˆ†ï¼š"></a>ï¼ˆå¯é€‰ï¼‰testbed_configéƒ¨åˆ†ï¼š</h4><ul>
<li>name - ç»™testbedé…ç½®æ–‡ä»¶é€‰æ‹©ä¸€ä¸ªåå­—</li>
<li>alias - ç»™testbedé…ç½®æ–‡ä»¶é€‰æ‹©ä¸€ä¸ªåˆ«å</li>
</ul>
<h5 id="device-groupséƒ¨åˆ†"><a href="#device-groupséƒ¨åˆ†" class="headerlink" title="device_groupséƒ¨åˆ†"></a>device_groupséƒ¨åˆ†</h5><p>ç”¨æ³•ï¼šlab</p>
<p>device_groupéƒ¨åˆ†ç”Ÿæˆlabæ–‡ä»¶ï¼Œæ˜¯ç”¨æ¥è®¾ç½®testbedçš„çš„å¿…é¡»æ¸…å•æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶çš„æ ¼å¼æ˜¯yamlæ ¼å¼ï¼Œè„šæœ¬ä¼šå°†ä¹‹è½¬æ¢æˆINIæ ¼å¼ã€‚device_groupéƒ¨åˆ†åŒ…å«å®éªŒå®¤ä¸­æ‰€æœ‰DUTs, fanout switchsï¼Œtestbed serveræ‹“æ‰‘ã€‚ç»„å­èŠ‚ç‚¹ä»ä¸‹é¢çš„deviceéƒ¨åˆ†ä»‹ç»ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ä¸ç”¨ç®¡è¿™ä¸€éƒ¨åˆ†ã€‚</p>
<h4 id="deviceséƒ¨åˆ†"><a href="#deviceséƒ¨åˆ†" class="headerlink" title="deviceséƒ¨åˆ†"></a>deviceséƒ¨åˆ†</h4><p>ç”¨æ³•ï¼šfiles/sonic_lab_devices, group_vars/fanout/secrets, group_vars/lab/secrets, lab</p>
<p>deviceéƒ¨åˆ†æ˜¯åŒ…å«æ‰€æœ‰è®¾å¤‡å’Œä¸»æœºçš„å­—å…¸ã€‚è¿™éƒ¨åˆ†ä¸åŒ…å«PTFå®¹å™¨çš„ä¿¡æ¯ã€‚å…³äºPTFå®¹å™¨çš„ä¿¡æ¯ï¼ŒæŸ¥çœ‹testbed.csvæ–‡ä»¶ã€‚<br>å¯¹æ¯ä¸€ä¸ªä½ æ·»åŠ çš„è®¾å¤‡ï¼Œæ·»åŠ ä¸‹é¢çš„ä¿¡æ¯ï¼š</p>
<table>
<thead>
<tr>
<th>Hostname</th>
<th>ansible_host</th>
<th>ansible_ssh_user</th>
<th>ansible_ssh_pass</th>
<th>HwSKU</th>
<th>device_type</th>
</tr>
</thead>
<tbody><tr>
<td>str-msn2700-01</td>
<td>[IP Address]</td>
<td>[username]</td>
<td>[password]</td>
<td>DevSonic</td>
<td>DevSonic</td>
</tr>
<tr>
<td>str-7260-10</td>
<td>[IP Address]</td>
<td>[username]</td>
<td>[password]</td>
<td>Arista-7260QX-64</td>
<td>FanoutRoot</td>
</tr>
<tr>
<td>str-7260-10</td>
<td>[IP Address]</td>
<td>[username]</td>
<td>[password]</td>
<td>Arista-7260QX-64</td>
<td>FanoutLeaf</td>
</tr>
<tr>
<td>str-acs-serv-01</td>
<td>[IP Address]</td>
<td>[username]</td>
<td>[password]</td>
<td>TestServ</td>
<td>Server</td>
</tr>
</tbody></table>
<ul>
<li>hostname - è®¾å¤‡åç§°</li>
<li>ansible_host - è®¾å¤‡çš„ç®¡ç†IP</li>
<li>ansible_ssh_user - è®¾å¤‡ç™»å½•åç§°</li>
<li>ansible_ssh_pass - è®¾å¤‡ç™»å½•å¯†ç </li>
<li>hesku - è¿™æ˜¯ç”¨æ¥æŸ¥é˜…éªŒè¯çš„å€¼ï¼ˆåœ¨/group_vars/all/labinfo.jsonï¼‰ã€‚æ²¡æœ‰è¿™éƒ¨åˆ†ï¼Œå°±çˆ±é‚£ä¸ªä¼šå¤±è´¥ã€‚ç¡®ä¿è¿™éƒ¨åˆ†åœ¨labinfo.jsonä¸­æœ‰å‡†ç¡®çš„æ•°æ®ã€‚</li>
<li>device_type - è®¾å¤‡ç±»å‹ã€‚å¦‚æœåªæœ‰4ç§è®¾å¤‡ï¼Œå¯ä»¥å°†æä¾›æ ‡ç­¾ç•™ç™½ä¸å¡«å†™ã€‚</li>
</ul>
<p>lab serveréƒ¨åˆ†éœ€è¦ä¸åŒçš„å­—æ®µè¾“å…¥ï¼šansible_become_pass, sonicadmin_user(ç”¨æˆ·å), sonicadmin_password, sonic_inital_password. è¿™äº›å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ç›´æ¥ä»group_var/lab/secrets.ymlä¸­è·å–çš„å˜é‡ã€‚æ‰€ä»¥ä¸ºäº†ä¾¿åˆ©ï¼Œè¿™éƒ¨åˆ†çš„é…ç½®æ–‡ä»¶ä½œä¸ºä¸€ä¸ªæ‹·è´ã€‚</p>
<h4 id="host-varséƒ¨åˆ†"><a href="#host-varséƒ¨åˆ†" class="headerlink" title="host_varséƒ¨åˆ†"></a>host_varséƒ¨åˆ†</h4><p>ç”¨æ³•ï¼šæ‰€æœ‰çš„host_valæ•°æ®</p>
<p>hostçš„å‚æ•°åœ¨æ­¤å¤„è®¾ç½®ã€‚åœ¨è¿™ç¯‡æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬åœ¨æ­¤å¤„å®šä¹‰serverï¼ˆstr-acs-serv-01ï¼‰ï¼š<br>å¯¹äºæ¯ä¸€ä¸ªä½ æ·»åŠ çš„hostï¼Œå®šä¹‰æˆ–ç¡®è®¤å¦‚ä¸‹æ•°æ®ï¼š</p>
<ul>
<li>mgmt_bridge</li>
<li>mgmt_prefixlen (è¿™ä¸ªåº”è¯¥å’Œmgmt_subnet_mask_lengthåŒ¹é…)</li>
<li>mgmt_gw</li>
<li>external_about</li>
</ul>
<h4 id="veos-groupséƒ¨åˆ†"><a href="#veos-groupséƒ¨åˆ†" class="headerlink" title="veos_groupséƒ¨åˆ†"></a>veos_groupséƒ¨åˆ†</h4><p>ç”¨æ³•ï¼šveos</p>
<h4 id="veoséƒ¨åˆ†"><a href="#veoséƒ¨åˆ†" class="headerlink" title="veoséƒ¨åˆ†"></a>veoséƒ¨åˆ†</h4><p>ç”¨æ³•ï¼šgroup_vars/eos/cred, main.yml, group_vars/vm_host/creds</p>
<h4 id="testbedéƒ¨åˆ†"><a href="#testbedéƒ¨åˆ†" class="headerlink" title="testbedéƒ¨åˆ†"></a>testbedéƒ¨åˆ†</h4><p>ç”¨æ³•ï¼š testbed.csv</p>
<h4 id="æ‹“æ‰‘éƒ¨åˆ†"><a href="#æ‹“æ‰‘éƒ¨åˆ†" class="headerlink" title="æ‹“æ‰‘éƒ¨åˆ†"></a>æ‹“æ‰‘éƒ¨åˆ†</h4><p>ç”¨æ³•ï¼š files/sonic_lab_links.csv</p>
<h4 id="docker-registryéƒ¨åˆ†"><a href="#docker-registryéƒ¨åˆ†" class="headerlink" title="docker_registryéƒ¨åˆ†"></a>docker_registryéƒ¨åˆ†</h4><p>ç”¨æ³•ï¼š /vars/docker_registry.yml</p>
<h3 id="testbedè¿è¡Œè„šæœ¬"><a href="#testbedè¿è¡Œè„šæœ¬" class="headerlink" title="testbedè¿è¡Œè„šæœ¬"></a>testbedè¿è¡Œè„šæœ¬</h3><p>å½“testbed.yamlæ–‡ä»¶é…ç½®å¥½åï¼Œå°†TestbedProcess.pyå’Œtestbed.yamlæ–‡ä»¶æ”¾åœ¨sonic-mgmt/ansibleä¸‹é¢ã€‚</p>
<p>è¿è¡ŒTestbedProcessing.pyè„šæœ¬ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python TestbedProcessing.py -i testbed.yaml</span><br><span class="line">options:</span><br><span class="line">-i &#x3D; è§£ætestbed.yamlæ–‡ä»¶</span><br><span class="line">-basedir &#x3D; é¡¹ç›®çš„æ ¹ç›®å½•</span><br><span class="line">-backup &#x3D; æ–‡ä»¶çš„å¤‡ä»½æ–‡ä»¶å¤¹</span><br></pre></td></tr></table></figure>

<h4 id="VMSå‘½ä»¤"><a href="#VMSå‘½ä»¤" class="headerlink" title="VMSå‘½ä»¤"></a>VMSå‘½ä»¤</h4><p>å¼€å¯VMSï¼ˆä½¿ç”¨vms_1ï¼‰:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;testbed-cli.sh start-vms vms_1 password.txt</span><br></pre></td></tr></table></figure>
<p>åœæ­¢VMSï¼ˆä½¿ç”¨vms_1ï¼‰:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;testbed-cli.sh stop-vms vms_1 password.txt</span><br></pre></td></tr></table></figure>

<h3 id="éƒ¨ç½²ï¼ˆPTF32ï¼‰æ‹“æ‰‘å®¹å™¨"><a href="#éƒ¨ç½²ï¼ˆPTF32ï¼‰æ‹“æ‰‘å®¹å™¨" class="headerlink" title="éƒ¨ç½²ï¼ˆPTF32ï¼‰æ‹“æ‰‘å®¹å™¨"></a>éƒ¨ç½²ï¼ˆPTF32ï¼‰æ‹“æ‰‘å®¹å™¨</h3><p>åœ¨è¿™ç¯‡æŒ‡å—ä¸­ï¼Œå°†ä¼šä½¿ç”¨testbed-cli.shæ·»åŠ ptf32-1ä½œä¸ºç¤ºä¾‹</p>
<p>ç§»é™¤æ‹“æ‰‘ ptf32-1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;testbed-cli.sh remove-topo ptf32-1 password.txt</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ æ‹“æ‰‘ ptf32-1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;testbed-cli.sh add-topo ptf32-1 password.txt</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨â€docker psâ€æˆ–è€…â€dokcer container lsâ€å‘½ä»¤å»æ£€æŸ¥æ˜¯å¦æ·»åŠ æˆ–ç§»é™¤ã€‚</p>
<h3 id="è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆNeighbourï¼‰"><a href="#è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆNeighbourï¼‰" class="headerlink" title="è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆNeighbourï¼‰"></a>è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆNeighbourï¼‰</h3><p>å½“VMså’Œptf32-1æ‹“æ‰‘æˆåŠŸæ·»åŠ åï¼Œç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹â€œneighbourâ€å°±å¯ä»¥è¿è¡Œèµ·æ¥äº†ã€‚testbedçš„åå­—å’Œæµ‹è¯•ç”¨ä¾‹çš„åå­—éœ€è¦é€šè¿‡å˜é‡å£°æ˜å‡ºæ¥ã€‚è¯·æ£€æŸ¥ä¸€ä¸‹ï¼Œä¹‹åï¼Œplaybookå°±å¯ä»¥è¿è¡Œäº†ã€‚<br>è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export TESTBED_NAME&#x3D;ptf32-1</span><br><span class="line">export TESTCASE_NAME&#x3D;neighbour</span><br><span class="line">echo $TESTBED_NAME</span><br><span class="line">echo $TESTCASE_NAME</span><br><span class="line">ansible-playbook -i lab -l sonic-ag9032 test_sonic.ynl -e testbed_name&#x3D;$TESTBED_NAME -e testcase_name&#x3D;$TESTCASE_NAME</span><br></pre></td></tr></table></figure>

<h2 id="æ’é”™"><a href="#æ’é”™" class="headerlink" title="æ’é”™"></a>æ’é”™</h2><p>é—®é¢˜ï¼šTestbedå‘½ä»¤è¡Œæç¤ºæ²¡æœ‰passwordæ–‡ä»¶<br>è§£å†³æ–¹å¼ï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„passwordæ–‡ä»¶å»ç»•è¿‡è¿™ä¸ªé—®é¢˜</p>
<p>é—®é¢˜ï¼šå³ä½¿åœ¨æˆ‘è¿è¡Œå®Œstop-vmså‘½ä»¤åIPsä¸å¯è¾¾<br>è§£å†³æ–¹å¼ï¼šå¦‚æœè¿è¡Œäº†stop-vmså‘½ä»¤åè¿™ä¸ªé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">virsh</span><br><span class="line">list</span><br><span class="line">destory VM_Name (åˆ é™¤å ç”¨è¿™ä¸ªIPçš„VM)</span><br><span class="line">exit(é€€å‡ºvirsh)ï¼Œåœ¨æ°¸ä¹…åˆ é™¤è¿™ä¸ªIPså‰è¯·ç¡®ä¿æ²¡æœ‰å…¶å®ƒVMä½¿ç”¨è¿™ä¸ªIPs</span><br></pre></td></tr></table></figure>

<p>é—®é¢˜ï¼šä»»åŠ¡è®¾ç½®å¤±è´¥ã€‚SSH Errorï¼šdata could not be sent to the remote host<br>è§£å†³æ–¹å¼ï¼šå¯¼è‡´è¿™ä¸ªç°è±¡çš„é—®é¢˜å¯èƒ½æœ‰å¾ˆå¤šã€‚<br>    1. ç¡®ä¿è¿™å°ä¸»æœºå¯ä»¥é€šè¿‡SSHåˆ°è¾¾<br>    2. group_vars/all/lab_info.jsonæ–‡ä»¶ä¸­åŒ…å«äº†æ­£ç¡®çš„å‡­è¯å—ï¼Ÿ<br>    3. è®¾å¤‡åœ¨files/sonic_lab_devices.cavä¸­æœ‰æ­£ç¡®çš„hwskuå—ï¼Ÿ<br>    4. ç¡®ä¿labæ–‡ä»¶ä¸­åœ¨IPsåé¢æ²¡æœ‰â€/â€œï¼ŒINIæ–‡ä»¶æ— æ³•è¯†åˆ«<br>    5. é‡æ–°æ£€æŸ¥testbed.yamlé…ç½®æ–‡ä»¶ï¼Œæ˜¯å¦è·å–äº†IPså’Œæ­£ç¡®çš„å‡­è¯</p>
]]></content>
      <tags>
        <tag>SONiC</tag>
      </tags>
  </entry>
  <entry>
    <title>vxlanå­¦ä¹ </title>
    <url>/2021/02/03/vxlan%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>vxlanæ˜¯overlayå±‚çš„åº”ç”¨ï¼Œvlanæ˜¯underlayå±‚çš„åº”ç”¨ã€‚è¿™ç¯‡æ–‡æ¡£æ˜¯vxlançš„å­¦ä¹ æ–‡æ¡£ï¼Œåœ¨å­¦ä¹ vxlanä¹‹å‰ï¼Œä¼šç®€å•ä»‹ç»ä¸‹vlanï¼Œä¹‹åè¿›å…¥vxlanå­¦ä¹ ã€‚å­¦ä¹ å®Œæˆåï¼Œåº”è¯¥ææ˜ç™½ä»¥ä¸‹çš„å‡ ä¸ªé—®é¢˜ï¼š</p>
<span id="more"></span>
<ul>
<li>ä»€ä¹ˆæ˜¯vxlan</li>
<li>vxlanè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œåº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆ</li>
<li>vxlanæŠ¥æ–‡çš„å°è£…æ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„</li>
<li>ä»€ä¹ˆæ˜¯VTEPå’ŒVNI</li>
<li>å“ªäº›VTEPä¹‹é—´éœ€è¦å»ºç«‹vxlanéš§é“<ul>
<li>ä»€ä¹ˆæ˜¯<code>åŒä¸€å¤§äºŒå±‚åŸŸ</code></li>
</ul>
</li>
<li>vxlanéš§é“æ˜¯å¦‚ä½•å»ºç«‹çš„<ul>
<li>å¦‚ä½•ç¡®å®šæŠ¥æ–‡å±äºé‚£ä¸ªBDï¼Œå“ªäº›æŠ¥æ–‡è¿›å…¥vxlanéš§é“</li>
<li>å¦‚ä½•ç¡®å®šæŠ¥æ–‡èµ°é‚£æ¡éš§é“</li>
</ul>
</li>
<li>ä»€ä¹ˆæ˜¯vxlanäºŒå±‚ç½‘å…³å’Œä¸‰å±‚ç½‘å…³</li>
<li>ä»€ä¹ˆæ˜¯vxlané›†ä¸­å¼ç½‘å…³ä¸åˆ†å¸ƒå¼ç½‘å…³<ul>
<li>é›†ä¸­å¼ç½‘å…³ä¸­åŒå­ç½‘äº’é€šæµç¨‹æ˜¯æ€æ ·çš„</li>
<li>é›†ä¸­å¼ç½‘å…³ä¸­ä¸åŒå­ç½‘äº’é€šæµç¨‹æ˜¯æ€æ ·çš„</li>
</ul>
</li>
<li>ä»€ä¹ˆæ˜¯BGP EVPN<ul>
<li>åˆ†å¸ƒå¼ç½‘å…³ä¸­æŠ¥æ–‡çš„è½¬å‘æµç¨‹æ˜¯æ€æ ·çš„</li>
</ul>
</li>
</ul>
<h1 id="vlanä»‹ç»"><a href="#vlanä»‹ç»" class="headerlink" title="vlanä»‹ç»"></a>vlanä»‹ç»</h1><p>VLAN(virtual local area network)å³è™šæ‹Ÿå±€åŸŸç½‘ï¼Œæ˜¯å°†ä¸€ä¸ªç‰©ç†çš„LANåœ¨é€»è¾‘ä¸Šåˆ’åˆ†å¤šä¸ªå¹¿æ’­åŸŸçš„é€šä¿¡æŠ€æœ¯ã€‚æ ¹æ®IEEE 802.1Qåè®®è§„å®šï¼Œåœ¨ä»¥å¤ªç½‘æ•°æ®å¸§çš„ç›®çš„MACåœ°å€å’ŒæºMACåœ°å€å­—æ®µä¹‹åã€åè®®å­—æ®µä¹‹å‰åŠ å…¥4ä¸ªå­—èŠ‚çš„VLAN tagï¼Œç”¨ä»¥æ ‡è¯†VLANä¿¡æ¯ï¼ŒVLANæ•°æ®å¸§æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://rancho333.github.io/pictures/vlan_frame.png"></p>
<p>å¯¹äºäº¤æ¢æœºè€Œè¨€ï¼Œå…¶å†…éƒ¨å¤„ç†çš„æ•°æ®å¸§éƒ½å¸¦æœ‰VLAN tagï¼Œç°ç½‘ä¸­äº¤æ¢æœºè¿æ¥çš„è®¾å¤‡åªä¼šæ¥æ”¶Untaggedå¸§ã€‚äº¤æ¢æœºéœ€è¦æœ‰è¯†åˆ«Untaggedå¸§å¹¶åœ¨æ”¶å‘æ—¶ç»™å¸§æ·»åŠ ã€å‰¥ç¦»VLANæ ‡ç­¾çš„èƒ½åŠ›ï¼Œäº¤æ¢æœºé—´çš„æ¥å£éœ€è¦æœ‰åŒæ—¶è¯†åˆ«å’Œå‘é€å¤šä¸ªvlanæ•°æ®å¸§çš„èƒ½åŠ›ã€‚</p>
<p>æ ¹æ®æ¥å£å¯¹è±¡å’Œæ”¶å‘æ•°æ®å¸§å¤„ç†çš„ä¸åŒï¼Œä¸‹é¢ä»‹ç»4ä¸­é“¾è·¯ç±»å‹ï¼Œç”¨ä»¥é€‚åº”ä¸åŒçš„è¿æ¥å’Œç»„ç½‘ï¼š</p>
<ul>
<li>Accessæ¥å£ï¼šä¸€èˆ¬ç”¨äºäº¤æ¢æœºä¸ç”¨æˆ·ç»ˆç«¯ç›¸è¿ã€‚Accessæ¥å£å¤§éƒ¨åˆ†æƒ…å†µåªèƒ½æ”¶å‘Untaggedå¸§ï¼Œä¸”åªèƒ½ä¸ºUntaggedå¸§æ·»åŠ å”¯ä¸€çš„VLAN tagã€‚</li>
<li>Trunkæ¥å£ï¼šä¸€èˆ¬ç”¨äºäº¤æ¢æœºä¹‹é—´ç›¸è¿ã€‚å…è®¸å¤šä¸ªVLANçš„å¸§å¸¦tagé€šè¿‡ï¼Œä½†åªå…è®¸ä¸€ä¸ªVLANçš„å¸§(é»˜è®¤vlan)ä»è¯¥ç±»å‹æ¥å£ä¸Šå‘å‡ºæ—¶ä¸å¸¦tagã€‚</li>
<li>Hybriddæ¥å£ï¼šAccesså’ŒTrunkçš„æ··åˆã€‚</li>
<li>ä½¿ç”¨QinQ(802.1Q-in-802.1Q)åè®®ï¼Œä¸€èˆ¬ç”¨äºç§ç½‘ä¸å…¬ç½‘ä¹‹é—´çš„è¿æ¥ï¼Œä¹Ÿè¢«ç§°ä¸ºDot1q-tunnelæ¥å£ï¼Œå®ƒå¯ä»¥ç»™vlanåŠ ä¸ŠåŒå±‚Tagï¼Œæœ€å¤šæ”¯æŒ4094*4094ä¸ªVLANã€‚</li>
</ul>
<p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹vlanåˆ’åˆ†çš„æ–¹å¼åŠä½¿ç”¨åœºæ™¯ï¼š</p>
<table>
<thead>
<tr>
<th align="left">åˆ’åˆ†æ–¹å¼</th>
<th align="left">ç®€ä»‹</th>
<th align="left">é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td align="left">åŸºäºæ¥å£</td>
<td align="left">æ ¹æ®äº¤æ¢æœºçš„æ¥å£æ¥åˆ’åˆ†vlan</td>
<td align="left">ä½¿ç”¨ä¸ä»»ä½•å¤§å°ä½†æ˜¯ä½ç½®æ¯”è¾ƒå›ºå®šçš„ç½‘ç»œ</td>
</tr>
<tr>
<td align="left">åŸºäºMACåœ°å€</td>
<td align="left">æ ¹æ®æ•°æ®å¸§çš„æºMACåœ°å€æ¥åˆ’åˆ†VLAN</td>
<td align="left">é€‚ç”¨äºä½ç½®ç»å¸¸ç§»åŠ¨ä½†ç½‘å¡ä¸ç»å¸¸æ›´æ¢çš„å°å‹ç½‘ç»œ</td>
</tr>
<tr>
<td align="left">åŸºäºå­ç½‘</td>
<td align="left">æ ¹æ®æ•°æ®å¸§ä¸­çš„æºIPåœ°å€å’Œå­ç½‘æ©ç æ¥åˆ’åˆ†VLAN</td>
<td align="left">é€‚ç”¨äºå®‰å…¨éœ€æ±‚ä¸é«˜ã€å¯¹ç§»åŠ¨æ€§å’Œç®€æ˜“ç®¡ç†éœ€æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯</td>
</tr>
<tr>
<td align="left">åŸºäºç½‘ç»œå±‚åè®®</td>
<td align="left">æ ¹æ®æ•°æ®å¸§æ‰€å±çš„åè®®(æ—)ç±»å‹åŠå°è£…æ ¼å¼</td>
<td align="left">é€‚ç”¨äºéœ€è¦åŒæ—¶è¿è¡Œå¤šåè®®çš„ç½‘ç»œ</td>
</tr>
<tr>
<td align="left">åŸºäºåŒ¹é…ç­–ç•¥</td>
<td align="left">æ ¹æ®é…ç½®çš„ç­–ç•¥åˆ’åˆ†VLAN,èƒ½å®ç°ä¸Šè¿°çš„å¤šç§ç»„åˆ</td>
<td align="left">ä½¿ç”¨ä¸éœ€æ±‚æ¯”è¾ƒå¤æ‚çš„ç¯å¢ƒ</td>
</tr>
</tbody></table>
<p>ä¸¤ä¸ªæ¦‚å¿µï¼Œvlançš„é€ä¼ å’Œç»ˆç»“ï¼Œvlançš„é€ä¼ å°±æ˜¯æŸä¸ªvlanä¸ä»…åœ¨ä¸€å°äº¤æ¢æœºä¸Šæœ‰æ•ˆï¼Œå®ƒè¿˜è¦é€šè¿‡æŸç§æ–¹å¼å»¶ä¼¸åˆ°åˆ«çš„ä»¥å¤ªç½‘äº¤æ¢æœºä¸Šï¼Œåœ¨åˆ«çš„è®¾å¤‡ä¸Šç…§æ ·æœ‰æ•ˆï¼Œvlançš„é€ä¼ å¯ä»¥ä½¿ç”¨802.1Qåè®®ï¼Œtrunké“¾è·¯ä¸Šä½¿ç”¨ã€‚vlançš„ç»ˆç»“æ„æ€ç›¸å¯¹ï¼ŒæŸä¸ªvlançš„æœ‰æ•ˆåŸŸä¸èƒ½å†å»¶ä¼¸åˆ°åˆ«çš„è®¾å¤‡ï¼Œæˆ–è€…ä¸èƒ½é€šè¿‡æŸæ¡é“¾è·¯å»¶ä¼¸åˆ°åˆ«çš„è®¾å¤‡ï¼Œå¯ä»¥ä½¿ç”¨pvlanæŠ€æœ¯å®ç°ï¼Œä¸»è¦åœ¨vlanæ•°æ®å‡ºç«¯å£åˆ°ç»ˆç«¯è®¾å¤‡ï¼Œæˆ–è€…ä¸Šä¸‰å±‚è½¬å‘æ—¶å‰¥ç¦»ã€‚è¿™ä¸¤è€…çš„æœ¬è´¨å°±æ˜¯ä¿ç•™vlan tagå’Œå»é™¤vlan tagã€‚</p>
<h1 id="vxlanå­¦ä¹ "><a href="#vxlanå­¦ä¹ " class="headerlink" title="vxlanå­¦ä¹ "></a>vxlanå­¦ä¹ </h1><h2 id="ä»€ä¹ˆæ˜¯vxlan"><a href="#ä»€ä¹ˆæ˜¯vxlan" class="headerlink" title="ä»€ä¹ˆæ˜¯vxlan"></a>ä»€ä¹ˆæ˜¯vxlan</h2><p>vxlan(virtual extensible local area network)è™šæ‹Ÿæ‰©å±•å±€åŸŸç½‘ï¼Œæ˜¯æœ‰IETFå®šä¹‰çš„NVO3(network virtualization over layer 3)æ ‡å‡†æŠ€æœ¯ä¹‹ä¸€ã€‚vxlançš„æœ¬è´¨æ˜¯ä¸€ç§éš§é“æŠ€æœ¯ï¼Œå°†L2çš„ä»¥å¤ªå¸§å°è£…åˆ°UDPæŠ¥æ–‡ä¸­åœ¨L3ç½‘ç»œä¸­ä¼ è¾“ã€‚è™½ç„¶ä»åå­—ä¸Šçœ‹ï¼Œvxlanæ˜¯vlançš„ä¸€ç§æ‰©å±•åè®®ï¼Œä½†æ˜¯vxlanæ„å»ºè™šæ‹Ÿéš§é“çš„æœ¬é¢†å·²ç»å’Œvlanè¿¥ç„¶ä¸åŒäº†ã€‚vxlanæŠ¥æ–‡æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_tag.png"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒVTEPå¯¹VMå‘é€çš„åŸå§‹ä»¥å¤ªå¸§ï¼ˆoriginal L2 frameï¼‰è¿›è¡Œäº†å¦‚ä¸‹çš„å°è£…ï¼š</p>
<table>
<thead>
<tr>
<th align="left">å°è£…</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">vxaln header</td>
<td align="left">å¢åŠ vxlanå¤´(8å­—èŠ‚),å…¶ä¸­24bitsçš„VNIç”¨æ¥æ ‡è¯†vxlan</td>
</tr>
<tr>
<td align="left">udp header</td>
<td align="left">vxlanå¤´å’ŒåŸå§‹ä»¥å¤ªå¸§ä¸€èµ·ä½œä¸ºUDPçš„æ•°æ®ã€‚UDPä¸­ï¼Œç›®çš„ç«¯å£å·(vxlan port)å›ºå®šä¸º4789</td>
</tr>
<tr>
<td align="left">outer ip header</td>
<td align="left">src ipä¸ºæºVMæ‰€å±VTEPçš„IPåœ°å€ï¼Œç›®çš„IPåœ°å€ä¸ºç›®çš„VMæ‰€å±VTEPçš„IPåœ°å€</td>
</tr>
<tr>
<td align="left">outer mac header</td>
<td align="left">src macä¸ºæºVMæ‰€å±VTEPçš„macåœ°å€ï¼Œç›®çš„macåœ°å€ä¸ºåˆ°è¾¾VTEPçš„è·¯å¾„çš„ä¸‹ä¸€è·³è®¾å¤‡çš„macåœ°å€</td>
</tr>
</tbody></table>
<h2 id="vxlançš„åº”ç”¨åœºæ™¯"><a href="#vxlançš„åº”ç”¨åœºæ™¯" class="headerlink" title="vxlançš„åº”ç”¨åœºæ™¯"></a>vxlançš„åº”ç”¨åœºæ™¯</h2><p>vxlançš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯æ•°æ®ä¸­å¿ƒã€‚vxlanå¯ä»¥æ»¡è¶³æ•°æ®ä¸­å¿ƒçš„ä¸‰ä¸ªå…³é”®éœ€æ±‚ï¼š</p>
<ol>
<li>æ•°æ®ä¸­å¿ƒæœåŠ¡å™¨ä¾§è™šæ‹ŸåŒ–åå‡ºç°äº†è™šæ‹ŸæœºåŠ¨æ€è¿ç§»ï¼Œè¦æ±‚æä¾›ä¸€ä¸ªæ— éšœç¢æ¥å…¥çš„ç½‘ç»œ</li>
<li>æ•°æ®ä¸­å¿ƒè§„æ¨¡åºå¤§ï¼Œç§Ÿæˆ·æ•°é‡æ¿€å¢ï¼Œè¦æ±‚ç½‘ç»œæä¾›éš”ç¦»æµ·é‡ç§Ÿæˆ·çš„èƒ½åŠ›</li>
<li>é’ˆå¯¹è™šæ‹Ÿæœºè§„æ¨¡å—ç½‘ç»œè§„æ ¼é™åˆ¶çš„è§£å†³æ–¹æ¡ˆã€‚å¯¹æ¥å…¥äº¤æ¢æœºï¼ŒMACåœ°å€è§„æ ¼éœ€æ±‚æå¤§é™ä½ï¼Œä½†æ˜¯å¯¹æ ¸å¿ƒç½‘å…³è¦æ±‚æé«˜ã€‚ä¸¤ä¸ªvxlanå¯ä»¥å…·æœ‰ç›¸åŒçš„MACåœ°å€ï¼Œä½†åœ¨ä¸€ä¸ªvxlanå†…ä¸èƒ½æœ‰é‡å¤çš„macåœ°å€</li>
</ol>
<p>å¯¹äºè™šæ‹ŸæœºåŠ¨æ€è¿ç§»ï¼Œä¸ä»…è™šæ‹Ÿæœºçš„IPåœ°å€ä¸å˜ï¼Œè€Œä¸”è™šæ‹Ÿæœºçš„è¿è¡ŒçŠ¶æ€ä¹Ÿå¿…é¡»ä¿æŒåŸçŠ¶ï¼ˆå¦‚TCPä¼šè¯çŠ¶æ€ï¼‰ï¼Œæ‰€ä»¥è™šæ‹ŸæœºåŠ¨æ€è¿ç§»åªèƒ½åœ¨ä¸€ä¸ªäºŒå±‚åŸŸä¸­è¿›è¡Œã€‚vxlanå¯ä»¥å°†æ•´ä¸ªæ•°æ®ä¸­å¿ƒåŸºç¡€ç½‘ç»œè™šæ‹ŸåŒ–æˆä¸€å°å·¨å¤§çš„â€œäºŒå±‚äº¤æ¢æœºâ€ï¼Œæ‰€æœ‰çš„æœåŠ¡å™¨éƒ½è¿ç»“åœ¨è¿™å°äºŒå±‚äº¤æ¢æœºä¸Šã€‚underlayç½‘è·¯å…·ä½“å¦‚ä½•è½¬å‘ï¼ŒæœåŠ¡å™¨å®Œå…¨æ— éœ€å…³å¿ƒã€‚å°†è™šæ‹Ÿæœºä»â€œäºŒå±‚äº¤æ¢æœºâ€çš„ä¸€ä¸ªç«¯å£æ¢åˆ°å¦ä¸€ä¸ªç«¯å£ï¼Œå®Œå…¨æ— éœ€å˜æ›´IPåœ°å€ã€‚<br>ä½¿ç”¨è¿™ç§ç†å¿µçš„æŠ€æœ¯åè®®ï¼Œé™¤äº†vxlanå¤–ï¼Œè¿˜æœ‰NVGREã€STTç­‰ã€‚</p>
<p>ä¼ ç»Ÿç½‘ç»œä¸­ï¼Œvlanæ•°é‡åªæœ‰4000ä¸ªå·¦å³ï¼Œvxlanç†è®ºä¸Šå¯ä»¥æ”¯æŒ16Mçš„vxlanæ®µï¼Œä»è€Œæ»¡è¶³å¤§è§„æ¨¡ä¸åŒç½‘ç»œä¹‹é—´çš„æ ‡è¯†ã€éš”ç¦»éœ€æ±‚ã€‚</p>
<h2 id="vxlançš„éš§é“æ˜¯å¦‚ä½•å»ºç«‹çš„"><a href="#vxlançš„éš§é“æ˜¯å¦‚ä½•å»ºç«‹çš„" class="headerlink" title="vxlançš„éš§é“æ˜¯å¦‚ä½•å»ºç«‹çš„"></a>vxlançš„éš§é“æ˜¯å¦‚ä½•å»ºç«‹çš„</h2><h3 id="vxlanä¸­çš„VTEPå’ŒVNI"><a href="#vxlanä¸­çš„VTEPå’ŒVNI" class="headerlink" title="vxlanä¸­çš„VTEPå’ŒVNI"></a>vxlanä¸­çš„VTEPå’ŒVNI</h3><p>ä¸‹é¢äº†è§£ä¸€ä¸‹vxlanç½‘ç»œæ¨¡å‹ä»¥åŠä¸€äº›å¸¸è§çš„æ¦‚å¿µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸¤å°æœåŠ¡å™¨ä¹‹é—´é€šè¿‡vxlançš„ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_network_module.png"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒvxlanæŠ¥æ–‡åœ¨vtepä¸¤ç«¯æœ‰ä¸€ä¸ªå°è£…å’Œè§£å°è£…çš„æ“ä½œã€‚</p>
<p>VTEP(vxlan tunnel endpoints, vxlanéš§é“ç«¯ç‚¹)æ˜¯vxlanç½‘ç»œçš„è¾¹ç¼˜è®¾å¤‡ï¼Œæ˜¯vxlanéš§é“çš„èµ·ç‚¹ä¸ªç»ˆç‚¹ï¼Œvxlanå¯¹ç”¨æˆ·åŸå§‹æ•°æ®å¸§çš„å°è£…å’Œè§£å°è£…å‡åœ¨VTEPä¸Šè¿›è¡Œã€‚VTEPæ—¢å¯ä»¥æ˜¯ä¸€å°ç‹¬ç«‹çš„ç½‘ç»œè®¾å¤‡ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨ä¸­çš„è™šæ‹Ÿäº¤æ¢æœºã€‚</p>
<p>VNI(vxlan network identifier, vxlanç½‘ç»œæ ‡è¯†ç¬¦)æ˜¯ä¸€ç§ç±»ä¼¼VLAN IDçš„ç”¨æˆ·æ ‡è¯†ï¼Œä¸€ä¸ªVNIä»£è¡¨äº†ä¸€ä¸ªç§Ÿæˆ·ï¼Œå±äºä¸åŒçš„VNIè™šæ‹Ÿæœºä¹‹é—´ä¸èƒ½ç›´æ¥è¿›è¡ŒäºŒå±‚é€šä¿¡ã€‚åœ¨åˆ†å¸ƒå¼ç½‘å…³çš„éƒ¨ç½²åœºæ™¯ä¸‹ï¼ŒVNIå¯ä»¥åˆ†ä¸ºäºŒå±‚VNIå’Œä¸‰å±‚VNIï¼š</p>
<ul>
<li>äºŒå±‚VNIæ˜¯æ™®é€šVNIï¼Œä»¥1:1æ–¹å¼æ˜ å°„åˆ°å¹¿æ’­åŸŸBDï¼Œå®ç°vxlanæŠ¥æ–‡åŒå­ç½‘çš„è½¬å‘</li>
<li>ä¸‰å±‚VNIå’ŒVPNå®ä¾‹è¿›è¡Œå…³è”ï¼Œç”¨äºvxlanæŠ¥æ–‡è·¨å­ç½‘çš„è½¬å‘ï¼Œå‚è§EVPNç›¸å…³</li>
</ul>
<h3 id="é‚£äº›VTEPä¹‹é—´éœ€è¦å»ºç«‹vxlanéš§é“"><a href="#é‚£äº›VTEPä¹‹é—´éœ€è¦å»ºç«‹vxlanéš§é“" class="headerlink" title="é‚£äº›VTEPä¹‹é—´éœ€è¦å»ºç«‹vxlanéš§é“"></a>é‚£äº›VTEPä¹‹é—´éœ€è¦å»ºç«‹vxlanéš§é“</h3><p>è¿æ¥åœ¨ä¸åŒçš„VTEPä¸Šçš„VMä¹‹é—´å¦‚æœæœ‰â€œå¤§äºŒå±‚â€äº’é€šçš„éœ€æ±‚ï¼Œè¿™ä¸¤ä¸ªVTEPä¹‹é—´å°±éœ€è¦å»ºç«‹vxlanéš§é“ã€‚æ¢è¨€ä¹‹ï¼ŒåŒä¸€ä¸ªå¤§äºŒå±‚åŸŸå†…çš„VTEPä¹‹é—´éƒ½éœ€è¦å»ºç«‹VTEPéš§é“ã€‚</p>
<p><code>åŒä¸€ä¸ªå¤§äºŒå±‚åŸŸ</code>ç±»ä¼¼äºä¼ ç»Ÿç½‘ç»œä¸­VLAN(è™šæ‹Ÿå±€åŸŸç½‘)çš„æ¦‚å¿µï¼Œåœ¨vxlanä¸­å®ƒæœ‰å¦ä¸€ä¸ªåå­—ï¼Œå«åšBridge-Domainï¼Œç®€ç§°BDã€‚vlanæ˜¯é€šè¿‡vlan idæ¥æ ‡è¯†çš„ï¼ŒBDåˆ™æ˜¯é€šè¿‡VNIæ¥æ ‡è¯†çš„ï¼ŒBDä¸VNIæ˜¯1:1çš„æ˜ å°„å…³ç³»ã€‚ä»¥åä¸ºCloudEngineç³»åˆ—äº¤æ¢æœºè€Œè¨€ï¼Œå¯ä»¥å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bridge-domain 10        #è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªå¤§äºŒå±‚å¹¿æ’­åŸŸï¼Œç¼–å·æ˜¯10</span><br><span class="line">  vxlan vni 5000        #è¡¨ç¤ºåœ¨BDä¸‹ï¼ŒæŒ‡å®šä¸ä¹‹å…³è”çš„VNIæ˜¯5000</span><br></pre></td></tr></table></figure>
<p>æœ‰äº†æ˜ å°„ä¹‹åï¼Œè¿›å…¥VTEPçš„æŠ¥æ–‡å°±å¯ä»¥æ ¹æ®è‡ªå·±æ‰€å±çš„BDæ¥ç¡®å®šæŠ¥æ–‡å°è£…æ—¶æ·»åŠ çš„VNIã€‚é‚£ä¹ˆæ€ä¹ˆç¡®å®šæŠ¥æ–‡å±äºé‚£ä¸ªBDå‘¢ï¼Ÿ</p>
<p>VTEPåªæ˜¯äº¤æ¢æœºæ‰¿æ‹…çš„ä¸€ä¸ªè§’è‰²ï¼Œåªæ˜¯äº¤æ¢æœºåŠŸèƒ½çš„ä¸€éƒ¨åˆ†ã€‚å¹¶éæ‰€æœ‰è¿›å…¥äº¤æ¢æœºçš„æŠ¥æ–‡éƒ½ä¼šèµ°Vxlanéš§é“ï¼ˆä¹Ÿå¯èƒ½æŠ¥æ–‡å°±æ˜¯èµ°æ™®é€šäºŒä¸‰å±‚è½¬å‘æµç¨‹ï¼‰ã€‚</p>
<p>åœ¨vlançš„æ¥å£å¯¹æŠ¥æ–‡å¤„ç†çš„æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>æ ¹æ®é…ç½®æ¥æ£€æŸ¥å“ªäº›æŠ¥æ–‡æ—¶å…è®¸é€šè¿‡çš„</li>
<li>åˆ¤æ–­å¯¹æ£€æŸ¥é€šè¿‡çš„æŠ¥æ–‡åšæ€æ ·çš„å¤„ç†</li>
</ol>
<p>åœ¨vxlanç½‘ç»œä¸­ï¼ŒVTEPä¸Šçš„æ¥å£æ‰¿æ‹…ç±»ä¼¼çš„ä»»åŠ¡ï¼Œè¿™ä¸ªæ¥å£æ˜¯ä¸ªå«åš<code>äºŒå±‚å­æ¥å£</code>çš„é€»è¾‘æ¥å£ã€‚äºŒå±‚å­æ¥å£å¯¹æŠ¥æ–‡çš„å¤„ç†æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>æ ¹æ®é…ç½®æ¥æ£€æŸ¥å“ªäº›æŠ¥æ–‡éœ€è¦è¿›å…¥vxlanéš§é“</li>
<li>åˆ¤æ–­å¯¹æ£€æŸ¥é€šè¿‡çš„æŠ¥æ–‡åšæ€æ ·çš„å¤„ç†</li>
</ol>
<p>åœ¨äºŒå±‚å­æ¥å£ä¸Šï¼Œå¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„æµå°è£…ç±»å‹ï¼ˆç±»ä¼¼ä¼ ç»Ÿç½‘ç»œä¸­ä¸åŒçš„æ¥å£ç±»å‹ï¼‰ï¼Œä¸€èˆ¬æœ‰dot1qã€untagã€qinqå’Œdefaultå››ç§ç±»å‹ï¼š</p>
<ul>
<li>dot1q:å¯¹äºå¸¦ä¸€å±‚vlan tagçš„æŠ¥æ–‡ï¼Œè¯¥ç±»å‹çš„æ¥å£åªæ¥å—ä¸æŒ‡å®švlan tagåŒ¹é…çš„æŠ¥æ–‡ï¼›å¯¹äºå¸¦æœ‰ä¸¤å±‚vlan tagçš„æŠ¥æ–‡ï¼Œè¯¥ç±»å‹æ¥å£åªæ¥æ”¶å¤–å±‚vlan tagä¸æŒ‡å®šVLAN tagåŒ¹é…çš„æŠ¥æ–‡</li>
<li>untagï¼šåªæ¥æ”¶ä¸å¸¦vlan tagçš„æŠ¥æ–‡</li>
<li>qinqï¼šåªæ¥æ”¶å¸¦æœ‰æŒ‡å®šä¸¤å±‚vlan tagçš„æŠ¥æ–‡</li>
<li>default: å…è®¸æ¥å£æ¥æ”¶æ‰€æœ‰çš„æŠ¥æ–‡ï¼Œä¸åŒºåˆ†æŠ¥æ–‡ä¸­æ˜¯å¦å¸¦æœ‰vlan tagã€‚ä¸è®ºæ˜¯å¯¹åŸå§‹æŠ¥æ–‡è¿›è¡Œvxlanå°è£…è¿˜æ˜¯è§£å°è£…ï¼Œè¯¥ç±»å‹æ¥å£éƒ½ä¸ä¼šå¯¹åŸå§‹æŠ¥æ–‡è¿›è¡Œä»»ä½•vlan tagå¤„ç†ï¼ŒåŒ…æ‹¬æ·»åŠ ã€æ›¿æ¢å’Œå‰¥ç¦»ã€‚</li>
</ul>
<p>vxlanéš§é“ä¸¤ç«¯äºŒå±‚å­æ¥å£çš„é…ç½®å¹¶ä¸ä¸€å®šæ˜¯å®Œå…¨ç›¸ç­‰çš„ã€‚æ­£å› ä¸ºè¿™æ ·ï¼Œæ‰å¯èƒ½å®ç°å±äºåŒä¸€ç½‘æ®µä½†æ˜¯ä¸åŒvlançš„ä¸¤ä¸ªvmé€šè¿‡vxlanéš§é“è¿›è¡Œé€šä¿¡ã€‚</p>
<p>é™¤äºŒå±‚å­æ¥å£å¤–ï¼Œè¿˜å¯ä»¥å°†vlanä½œä¸ºä¸šåŠ¡æ¥å…¥ç‚¹ã€‚å°†vlanç»‘å®šåˆ°BDåï¼ŒåŠ å…¥è¯¥vlançš„æ¥å£å³ä¸ºvxlanä¸šåŠ¡æ¥å…¥ç‚¹ï¼Œè¿›å…¥æ¥å£çš„æŠ¥æ–‡ç”±vxlanéš§é“å¤„ç†ã€‚</p>
<p>åªè¦å°†äºŒå±‚å­æ¥å£åŠ å…¥æŒ‡å®šçš„BDï¼Œç„¶åæ ¹æ®äºŒå±‚å­æ¥å£ä¸Šçš„é…ç½®ï¼Œè®¾å¤‡å°±å¯ä»¥ç¡®å®šæŠ¥æ–‡å±äºé‚£ä¸ªBDå•¦ï¼</p>
<h3 id="vxlanéš§é“æ˜¯æ€ä¹ˆå»ºç«‹çš„"><a href="#vxlanéš§é“æ˜¯æ€ä¹ˆå»ºç«‹çš„" class="headerlink" title="vxlanéš§é“æ˜¯æ€ä¹ˆå»ºç«‹çš„"></a>vxlanéš§é“æ˜¯æ€ä¹ˆå»ºç«‹çš„</h3><p>ä¸¤ç§æ–¹å¼ï¼Œæ‰‹åŠ¨æˆ–è‡ªåŠ¨ã€‚</p>
<h4 id="æ‰‹åŠ¨å»ºç«‹"><a href="#æ‰‹åŠ¨å»ºç«‹" class="headerlink" title="æ‰‹åŠ¨å»ºç«‹"></a>æ‰‹åŠ¨å»ºç«‹</h4><p>è¿™ç§æ–¹å¼éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®švxlanéš§é“æºIPä¸ºæœ¬ç«¯VTEPçš„IPã€ç›®çš„IPä¸ºå¯¹ç«¯VTEPçš„IPï¼Œä¹Ÿå°±æ˜¯äººä¸ºåœ¨æœ¬ç«¯VTEPå’Œå¯¹ç«¯VTEPä¹‹é—´å»ºç«‹é™æ€VXLANéš§é“ã€‚</p>
<p>ä»¥åä¸ºCloudEngineç³»åˆ—äº¤æ¢æœºä¸ºä¾‹ï¼Œåœ¨NVE(network virtualization edge)æ¥å£ä¸‹å®Œæˆé…ç½®ï¼Œé…ç½®ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface Nve1          #åˆ›å»ºé€»è¾‘æ¥å£NVE 1</span><br><span class="line">    source 1.1.1.1          #é…ç½®æºVTEPçš„IPåœ°å€ï¼ˆæ¨èä½¿ç”¨Loopbackæ¥å£çš„IPåœ°å€ï¼‰</span><br><span class="line">    vni 5000 head-end peer-list 2.2.2.2</span><br><span class="line">    vni 5000 head-end peer-list 2.2.2.3</span><br></pre></td></tr></table></figure>
<p>ä¸¤æ¡vniå‘½ä»¤è¡¨ç¤ºVNI 5000çš„å¯¹ç«¯VTEPæœ‰ä¸¤ä¸ªã€‚æ ¹æ®è¿™ä¸¤æ¡é…ç½®ï¼ŒVTEPä¸Šä¼šç”Ÿæˆå¦‚ä¸‹æ‰€ç¤ºçš„ä¸€å¼ è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;HUAWEI&gt; display vxlan vni 5000 verbose</span><br><span class="line">BD ID : 10</span><br><span class="line">State : up</span><br><span class="line">NVE : 288</span><br><span class="line">Source Address : 1.1.1.1</span><br><span class="line">Source IPv6 Address : -</span><br><span class="line">UDP Port : 4789</span><br><span class="line">BUM Mode : head-end</span><br><span class="line">Group Address : -</span><br><span class="line">Peer List : 2.2.2.2 2.2.2.3</span><br><span class="line">IPv6 Peer List : -</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®è¿™å¼ è¡¨çš„Peer Listï¼Œæœ¬ç«¯VTEPå°±å¯ä»¥çŸ¥é“å±äºåŒä¸€BDçš„å¯¹ç«¯VTEPæœ‰å“ªäº›ï¼Œè¿™ä¹Ÿå†³å®šäº†åŒä¸€å¤§äºŒå±‚å¹¿æ’­åŸŸçš„èŒƒå›´ã€‚å½“VTEPæ”¶åˆ°BUM(broadcast&amp;unknown-unicast&amp;multicast)æŠ¥æ–‡æ—¶ï¼Œä¼šå°†æŠ¥æ–‡å¤åˆ¶å¹¶å‘é€ç»™peer listä¸­æ‰€åˆ—çš„æ‰€æœ‰å¯¹ç«¯VTEPï¼ˆç±»ä¼¼å¹¿æ’­æŠ¥æ–‡åœ¨VLAnå†…å¹¿æ’­ï¼‰ã€‚å› æ­¤ï¼Œè¿™å¼ è¡¨ä¹Ÿè¢«ç§°ä¸ºâ€å¤´ç«¯å¤åˆ¶åˆ—è¡¨â€ã€‚å½“VTEPæ”¶åˆ°ä¸€è‡´å•æ’­æŠ¥æ–‡æ—¶ï¼Œä¼šæ ¹æ®VTEPä¸Šçš„MACè¡¨æ¥ç¡®å®šæŠ¥æ–‡è¦ä»é‚£æ¡vxlanéš§é“èµ°ã€‚è€Œæ­¤æ—¶Peer Listä¸­æ‰€åˆ—å‡ºçš„å¯¹ç«¯ï¼Œåˆ™å……å½“äº†MACè¡¨ä¸­â€å‡ºæ¥å£â€çš„è§’è‰²ã€‚</p>
<h4 id="è‡ªåŠ¨å»ºç«‹"><a href="#è‡ªåŠ¨å»ºç«‹" class="headerlink" title="è‡ªåŠ¨å»ºç«‹"></a>è‡ªåŠ¨å»ºç«‹</h4><p>è‡ªåŠ¨å»ºç«‹åˆ™éœ€è¦å€ŸåŠ©EVPN(Ethernet VPN)åè®®ã€‚</p>
<h4 id="å¦‚ä½•ç¡®å®šæŠ¥æ–‡èµ°é‚£æ¡éš§é“"><a href="#å¦‚ä½•ç¡®å®šæŠ¥æ–‡èµ°é‚£æ¡éš§é“" class="headerlink" title="å¦‚ä½•ç¡®å®šæŠ¥æ–‡èµ°é‚£æ¡éš§é“"></a>å¦‚ä½•ç¡®å®šæŠ¥æ–‡èµ°é‚£æ¡éš§é“</h4><p>å‚è§<code>vxlanç½‘ç»œä¸­æŠ¥æ–‡æ—¶å¦‚ä½•è½¬å‘çš„</code>ç« èŠ‚ã€‚</p>
<h2 id="vxlanç½‘å…³æœ‰å“ªäº›ç§ç±»"><a href="#vxlanç½‘å…³æœ‰å“ªäº›ç§ç±»" class="headerlink" title="vxlanç½‘å…³æœ‰å“ªäº›ç§ç±»"></a>vxlanç½‘å…³æœ‰å“ªäº›ç§ç±»</h2><h3 id="vxlanäºŒå±‚ç½‘å…³ä¸ä¸‰å±‚ç½‘å…³"><a href="#vxlanäºŒå±‚ç½‘å…³ä¸ä¸‰å±‚ç½‘å…³" class="headerlink" title="vxlanäºŒå±‚ç½‘å…³ä¸ä¸‰å±‚ç½‘å…³"></a>vxlanäºŒå±‚ç½‘å…³ä¸ä¸‰å±‚ç½‘å…³</h3><p>å’Œvlanç±»ä¼¼ï¼Œä¸åŒVNIä¹‹é—´çš„ä¸»æœºï¼Œä»¥åŠvxlanç½‘ç»œå’Œévxlanç½‘ç»œä¸­çš„ä¸»æœºä¸èƒ½ç›´æ¥ç›¸äº’é€šä¿¡ï¼Œä¸ºäº†æ»¡è¶³è¿™äº›é€šä¿¡éœ€æ±‚ï¼Œvxlanå¼•å…¥äº†vxlanç½‘å…³çš„æ¦‚å¿µã€‚vxlanç½‘å…³åˆ†ä¸ºäºŒå±‚ç½‘å…³å’Œä¸‰å±‚ç½‘å…³ï¼š</p>
<ul>
<li>äºŒå±‚ç½‘å…³ï¼šç”¨äºç»ˆç«¯æ¥å…¥vxlanç½‘ç»œï¼Œä¹Ÿå¯ç”¨äºåŒä¸€vxlanç½‘ç»œçš„å­ç½‘é€šä¿¡</li>
<li>ä¸‰å±‚ç½‘å…³ï¼šç”¨äºvxlanç½‘ç»œä¸­è·¨å­ç½‘é€šä¿¡ä»¥åŠè®¿é—®å¤–éƒ¨ç½‘ç»œ</li>
</ul>
<p>å…·ä½“è¯´æ˜ä¸‹ã€‚<br>vxlanä¸‰å±‚ç½‘å…³ã€‚ç”¨äºç»ˆç»“vxlanç½‘ç»œï¼Œå°†vxlanæŠ¥æ–‡è½¬æ¢æˆä¼ ç»Ÿä¸‰å±‚æŠ¥æ–‡å‘é€è‡³IPç½‘ç»œï¼Œé€‚ç”¨äºvxlanç½‘ç»œå†…æœåŠ¡å™¨ä¸è¿œç«¯ä¹‹é—´çš„ä¸‰å±‚äº’è®¿ï¼›åŒæ—¶ä¹Ÿä½œä¸åŒvxlanç½‘ç»œäº’é€šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º.å½“æœåŠ¡å™¨è®¿é—®å¤–éƒ¨ç½‘ç»œæ—¶ï¼Œvxlanä¸‰å±‚ç½‘å…³å‰¥ç¦»å¯¹åº”vxlanæŠ¥æ–‡å°è£…ï¼Œé€å…¥IPç½‘ç»œï¼›å½“å¤–éƒ¨ç»ˆç«¯è®¿é—®vxlanå†…çš„æœåŠ¡å™¨æ—¶ï¼Œvxlanæ ¹æ®ç›®çš„IPåœ°å€æ‰€å±vxlanåŠæ‰€å±çš„VTEPï¼ŒåŠ ä¸Šå¯¹åº”çš„vxlanæŠ¥æ–‡å¤´å°è£…è¿›å…¥vxlanç½‘ç»œã€‚vxlanä¹‹é—´çš„äº’è®¿æµé‡ä¸æ­¤ç±»ä¼¼ï¼Œvxlanç½‘å…³å‰¥ç¦»vxlanæŠ¥æ–‡å¤´ï¼Œå¹¶åŸºäºç›®çš„IPåœ°å€æ‰€å±vxlanåŠæ‰€å±çš„VTEPï¼Œé‡æ–°å°è£…åé€å…¥å¦å¤–çš„vxlanç½‘ç»œã€‚<br><img src="https://rancho333.github.io/pictures/vxlan_l3_gateway.png"></p>
<p>vxlanäºŒå±‚ç½‘å…³ã€‚ç”¨äºç»ˆç»“vxlanç½‘ç»œã€‚å°†vxlanæŠ¥æ–‡è½¬æ¢æˆå¯¹åº”çš„ä¼ ç»ŸäºŒå±‚ç½‘ç»œé€åˆ°ä¼ ç»Ÿä»¥å¤ªç½‘è·¯ï¼Œé€‚ç”¨äºvxlanç½‘ç»œå†…æœåŠ¡å™¨ä¸è¿œç«¯ç»ˆç«¯æˆ–è¿œç«¯æœåŠ¡å™¨çš„äºŒå±‚äº’è”ã€‚å¦‚åœ¨ä¸åŒç½‘ç»œä¸­åšè™šæ‹Ÿæœºè¿ç§»æ—¶ï¼Œå½“ä¸šåŠ¡éœ€è¦ä¼ ç»Ÿç½‘ç»œä¸­æœåŠ¡å™¨ä¸vxlanç½‘ç»œä¸­æœåŠ¡å™¨åœ¨åŒä¸€ä¸ªäºŒå±‚ä¸­ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨vxlanäºŒå±‚ç½‘å…³æ‰“é€švxlanç½‘ç»œå’ŒäºŒå±‚ç½‘ç»œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚vxlan10ç½‘ç»œä¸­çš„æœåŠ¡å™¨è¦å’ŒIPç½‘ç»œä¸­vlan100çš„ä¸šåŠ¡äºŒå±‚äº’é€šï¼Œæ­¤æ—¶å°±éœ€è¦é€šè¿‡vxlançš„äºŒå±‚ç½‘å…³è¿›è¡Œäº’è”ã€‚vxlan10çš„æŠ¥æ–‡è¿›å…¥IPç½‘ç»œçš„æµé‡ï¼Œå‰¥ç¦»vxlanæŠ¥æ–‡å¤´ï¼Œæ ¹æ®vxlançš„æ ‡ç­¾æŸ¥è¯¢å¯¹åº”çš„vlanç½‘ç»œï¼Œå¹¶æ®æ­¤åœ¨äºŒå±‚æŠ¥æ–‡ä¸­åŠ å…¥vlançš„802.1QæŠ¥æ–‡é€å…¥IPç½‘ç»œï¼›ç›¸åvlan100çš„ä¸šåŠ¡æµé‡è¿›å…¥vxlanä¹Ÿéœ€è¦æ ¹æ®vlanè·çŸ¥å¯¹åº”çš„vxlançš„vniï¼Œæ ¹æ®ç›®çš„macåœ°å€è·çŸ¥è¿œç«¯vtepçš„IPåœ°å€ï¼ŒåŸºäºä»¥ä¸Šä¿¡æ¯è¿›è¡Œvxlanå°è£…åé€å…¥å¯¹åº”çš„vxlanç½‘ç»œã€‚</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_l2_gateway.png"></p>
<h3 id="vxlané›†ä¸­å¼ç½‘å…³ä¸åˆ†å¸ƒå¼ç½‘å…³"><a href="#vxlané›†ä¸­å¼ç½‘å…³ä¸åˆ†å¸ƒå¼ç½‘å…³" class="headerlink" title="vxlané›†ä¸­å¼ç½‘å…³ä¸åˆ†å¸ƒå¼ç½‘å…³"></a>vxlané›†ä¸­å¼ç½‘å…³ä¸åˆ†å¸ƒå¼ç½‘å…³</h3><p>é›†ä¸­å¼ç½‘å…³æŒ‡å°†ä¸‰å±‚ç½‘å…³é›†ä¸­éƒ¨ç½²åœ¨ä¸€å°è®¾å¤‡ä¸Š,å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ‰€æœ‰è·¨å­ç½‘çš„æµé‡éƒ½ç»è¿‡è¿™ä¸ªä¸‰å±‚ç½‘å…³è½¬å‘ï¼Œå®ç°æµé‡çš„é›†ä¸­ç®¡ç†ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_gateway.png"></p>
<p>é›†ä¸­å¼ç½‘å…³çš„ä¼˜ç‚¹å’Œç¼ºç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå¯¹è·¨å­ç½‘æµé‡è¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œç½‘å…³éƒ¨ç½²å’Œç®¡ç†æ¯”è¾ƒç®€å•</li>
<li>ç¼ºç‚¹ï¼š<ul>
<li>è½¬å‘è·¯å¾„ä¸æ˜¯æœ€ä¼˜</li>
<li>ARPè¡¨é¡¹è§„æ ¼ç“¶é¢ˆã€‚é€šè¿‡ä¸‰å±‚ç½‘å…³è½¬å‘çš„ç»ˆç«¯çš„ARPè¡¨é¡¹éƒ½éœ€è¦åœ¨ä¸‰å±‚ç½‘å…³ä¸Šç”Ÿæˆã€‚</li>
</ul>
</li>
</ul>
<p>vxlanåˆ†å¸ƒå¼ç½‘å…³æ˜¯æŒ‡åœ¨å…¸å‹çš„â€spine-leafâ€ç»„ç½‘ç»“æ„ä¸‹ï¼Œå°†leafèŠ‚ç‚¹ä½œä¸ºvxlanéš§é“æ–­ç‚¹VTEPï¼Œæ¯ä¸ªleafèŠ‚ç‚¹éƒ½å¯ä½œä¸ºvxlanä¸‰å±‚ç½‘å…³(åŒæ—¶ä¹Ÿæ˜¯vxlanäºŒå±‚ç½‘å…³)ï¼ŒspineèŠ‚ç‚¹ä¸æ„ŸçŸ¥vxlanéš§é“ï¼Œåªä½œä¸ºvxlanæŠ¥æ–‡çš„è½¬å‘èŠ‚ç‚¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_gateway_2.png"></p>
<p>éƒ¨ç½²åˆ†å¸ƒå¼ç½‘å…³æ—¶ï¼š</p>
<ul>
<li>spineèŠ‚ç‚¹ï¼šå…³æ³¨äºé«˜é€ŸIPè½¬å‘ï¼Œå¼ºè°ƒçš„æ˜¯è®¾å¤‡çš„é«˜é€Ÿè½¬å‘èƒ½åŠ›</li>
<li>leafèŠ‚ç‚¹ï¼š<ul>
<li>ä½œä¸ºvxlanç½‘ç»œçš„äºŒå±‚ç½‘å…³ï¼Œä¸ç‰©ç†æœåŠ¡å™¨æˆ–vmå¯¹æ¥ï¼Œç”¨äºè§£å†³ç»ˆç«¯ç§Ÿæˆ·æ¥å…¥vxlanè™šæ‹Ÿç½‘ç»œçš„é—®é¢˜</li>
<li>ä½œä¸ºvxlanç½‘ç»œçš„ä¸‰å±‚ç½‘å…³ï¼Œè¿›è¡ŒvxlanæŠ¥æ–‡å°è£…ä¸è§£å°è£…ï¼Œå®ç°è·¨å­ç½‘çš„ç»ˆç«¯ç§Ÿæˆ·é€šä¿¡ï¼Œä»¥åŠå¤–éƒ¨ç½‘ç»œçš„è®¿é—®</li>
</ul>
</li>
</ul>
<p>vxlanåˆ†å¸ƒå¼ç½‘å…³å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>åŒä¸€ä¸ªleafèŠ‚ç‚¹æ—¢å¯ä»¥åšvxlanäºŒå±‚ç½‘å…³ï¼Œä¹Ÿå¯ä»¥åšvxlanä¸‰å±‚ç½‘å…³</li>
<li>leafèŠ‚ç‚¹åªéœ€è¦å­¦ä¹ è‡ªèº«è¿æ¥æœåŠ¡å™¨çš„ARPè¡¨é¡¹ï¼Œè€Œä¸å¿…åƒé›†ä¸­ä¸‰å±‚ç½‘å…³ä¸€æ ·ï¼Œéœ€è¦å­¦ä¹ æ‰€æœ‰æœåŠ¡å™¨çš„ARPè¡¨é¡¹ï¼Œè§£å†³äº†é›†ä¸­å¼ä¸‰å±‚ç½‘å…³å¸¦æ¥çš„ARPè¡¨é¡¹ç“¶é¢ˆé—®é¢˜ï¼Œç½‘ç»œè§„æ¨¡æ‰©å±•èƒ½åŠ›å¼º</li>
</ul>
<h2 id="vxlanç½‘ç»œä¸­æŠ¥æ–‡æ—¶å¦‚ä½•è½¬å‘çš„"><a href="#vxlanç½‘ç»œä¸­æŠ¥æ–‡æ—¶å¦‚ä½•è½¬å‘çš„" class="headerlink" title="vxlanç½‘ç»œä¸­æŠ¥æ–‡æ—¶å¦‚ä½•è½¬å‘çš„"></a>vxlanç½‘ç»œä¸­æŠ¥æ–‡æ—¶å¦‚ä½•è½¬å‘çš„</h2><p>è¿™é‡Œä»‹ç»é›†ä¸­å¼vxlanä¸­ç›¸åŒå­ç½‘å†…ã€ä¸åŒå­ç½‘é—´æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡çš„ã€‚å¯¹äºåˆ†å¸ƒå¼vxlanç½‘ç»œï¼Œåœ¨EVPNä¸­ä»‹ç»ã€‚<br>å¯¹äºäºŒä¸‰å±‚è½¬å‘é€šä¿¡ç»†èŠ‚ä¸æ˜¯å¾ˆæ¸…æ¥šçš„åŒå­¦ï¼Œå»ºè®®å­¦ä¹ ä¸‹äºŒå±‚ä¸ä¸‰å±‚pingä¸­arpä¸icmpæŠ¥æ–‡çš„äº¤äº’ç»†èŠ‚ã€‚</p>
<h3 id="é›†ä¸­å¼vxlanä¸­åŒå­ç½‘äº’é€šæµç¨‹"><a href="#é›†ä¸­å¼vxlanä¸­åŒå­ç½‘äº’é€šæµç¨‹" class="headerlink" title="é›†ä¸­å¼vxlanä¸­åŒå­ç½‘äº’é€šæµç¨‹"></a>é›†ä¸­å¼vxlanä¸­åŒå­ç½‘äº’é€šæµç¨‹</h3><p><img src="https://rancho333.github.io/pictures/vxlan_l2_ct.png"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒVM_Aã€VM_Bã€VM_Cå±äºç›¸åŒç½‘æ®µï¼Œä¸”åŒå±VNI 5000ã€‚Cè¦ä¸Aè¿›è¡Œé€šä¿¡ï¼Œå¯¹äºé¦–æ¬¡é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ARPè·å–å¯¹æ–¹MACã€‚åœ¨vlanå­ç½‘é€šä¿¡ä¸­ï¼ŒarpæŠ¥æ–‡åœ¨vlanå†…å¹¿æ’­ã€‚åœ¨vxlanç›¸åŒå­ç½‘ä¸­ï¼ŒARPè¯·æ±‚æŠ¥æ–‡è½¬å‘æµç¨‹è§ä¸‹å›¾</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_l2_arp_request.png"></p>
<p>Aå‘Cè¿›è¡ŒMACè¯·æ±‚çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>Aå‘é€ARPè¯·æ±‚æŠ¥æ–‡è¯·æ±‚Cçš„MAC</li>
<li>VTEP_1æ”¶åˆ°ARPè¯·æ±‚å<ol>
<li>æ ¹æ®äºŒå±‚å­æ¥å£ä¸Šçš„é…ç½®åˆ¤æ–­æŠ¥æ–‡éœ€è¦è¿›å…¥vxlanéš§é“ï¼Œç¡®å®šæŠ¥æ–‡æ‰€å±BDï¼ŒVNI</li>
<li>VTEP_1å­¦ä¹ Açš„MACã€VNIå’ŒæŠ¥æ–‡å…¥æ¥å£çš„å¯¹åº”å…³ç³»ï¼Œè®°å½•åˆ°MACåœ°å€è¡¨ä¸­</li>
<li>VTEP_1æ ¹æ®å¤´ç«¯å¤åˆ¶åˆ—è¡¨å¯¹æŠ¥æ–‡è¿›è¡Œå¤åˆ¶ï¼Œå¹¶åˆ†åˆ«è¿›è¡Œå°è£…ï¼Œå…¶ä¸­ï¼š<ol>
<li>å¤–å±‚æºIPä¸ºæœ¬åœ°VTEP_1çš„IPåœ°å€ï¼Œå¤–å±‚ç›®çš„IPåœ°å€ä¸ºå¯¹ç«¯VTEP(VTEP_2ã€VTEP_3)çš„IPåœ°å€</li>
<li>å¤–å±‚æºMACåœ°å€ä¸ºæœ¬åœ°VTEPçš„macåœ°å€ï¼Œå¤–å±‚ç›®çš„macåœ°å€ä¸ºå»å¾€ç›®çš„IPç½‘ç»œçš„ä¸‹ä¸€è·³è®¾å¤‡macåœ°å€</li>
<li>å°è£…å®Œæˆä¹‹åå°±æ˜¯åœ¨underlayç½‘ç»œä¸­å°†vxlanæŠ¥æ–‡ä¼ é€åˆ°å¯¹ç«¯VTEP</li>
</ol>
</li>
</ol>
</li>
<li>VTEP_2å’ŒVTEP_3æ”¶åˆ°æŠ¥æ–‡åï¼Œå¯¹æŠ¥æ–‡è¿›è¡Œè§£å°è£…ï¼Œå¾—åˆ°Aå‘é€çš„åŸå§‹æŠ¥æ–‡<ol>
<li>VTEP_2å’ŒVTEP_3å­¦ä¹ Açš„MACåœ°å€ã€VNIå’Œè¿œç«¯VTEP_1IPåœ°å€çš„å¯¹åº”å…³ç³»ï¼Œå¹¶è®°å½•åœ¨æœ¬åœ°MACè¡¨ä¸­</li>
<li>VTEP_2å’ŒVTEP_3æ ¹æ®äºŒå±‚å­æ¥å£ä¸Šçš„é…ç½®è¿›è¡Œç›¸åº”çš„å¤„ç†å¹¶åœ¨å¯¹åº”çš„äºŒå±‚åŸŸå†…å¹¿æ’­</li>
</ol>
</li>
<li>Bå’ŒCæ”¶åˆ°arpæŠ¥æ–‡åï¼ŒæŒ‰ç…§arpæŠ¥æ–‡å¤„ç†æ–¹å¼è¿›è¡Œä¸¢å¼ƒæˆ–åº”ç­”ã€‚è¿™é‡ŒCå‘Aå‘é€ARPåº”ç­”ã€‚</li>
</ol>
<p>ARPåº”ç­”æŠ¥æ–‡è½¬å‘æµç¨‹è§ä¸‹å›¾</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_l2_arp_reply.png"></p>
<p>Cå‘Aå‘é€ARP åº”ç­”æŠ¥æ–‡çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>Aå‘Cå‘é€ARPåº”ç­”æŠ¥æ–‡</li>
<li>VTEP_3æ”¶åˆ°ARPåº”ç­”æŠ¥æ–‡å<ol>
<li>ç¡®å®šæŠ¥æ–‡æ‰€å±çš„BDã€VNI</li>
<li>VTEP_3å­¦ä¹ Cçš„MACã€VNIå’ŒæŠ¥æ–‡å…¥æ¥å£çš„å¯¹åº”å…³ç³»ï¼Œè®°å½•åˆ°MACåœ°å€è¡¨ä¸­</li>
<li>VTEP_3å¯¹æŠ¥æ–‡è¿›è¡Œå°è£…ï¼Œå…¶ä¸­ï¼š<ol>
<li>å¤–å±‚æºIPä¸ºæœ¬åœ°VTEP_3çš„IPåœ°å€ï¼Œå¤–å±‚ç›®çš„IPåœ°å€ä¸ºå¯¹ç«¯VTEP_1çš„IPåœ°å€</li>
<li>å¤–å±‚æºMACåœ°å€ä¸ºæœ¬åœ°VTEPçš„macåœ°å€ï¼Œå¤–å±‚ç›®çš„macåœ°å€ä¸ºå»å¾€ç›®çš„IPç½‘ç»œçš„ä¸‹ä¸€è·³è®¾å¤‡macåœ°å€</li>
<li>å°è£…å®Œæˆä¹‹åå°±æ˜¯åœ¨underlayç½‘ç»œä¸­å°†vxlanæŠ¥æ–‡ä¼ é€åˆ°å¯¹ç«¯VTEP</li>
</ol>
</li>
</ol>
</li>
<li>VTEP_1æ”¶åˆ°æŠ¥æ–‡åï¼Œå¯¹æŠ¥æ–‡è¿›è¡Œè§£å°è£…ï¼Œå¾—åˆ°Cå‘é€çš„åŸå§‹æŠ¥æ–‡<ol>
<li>VTEP_1å­¦ä¹ Cçš„MACåœ°å€ã€VNIå’Œè¿œç«¯VTEP_3IPåœ°å€çš„å¯¹åº”å…³ç³»ï¼Œå¹¶è®°å½•åœ¨æœ¬åœ°MACè¡¨ä¸­</li>
<li>VTE_1å°†è§£å°åçš„æŠ¥æ–‡å‘é€ç»™A</li>
</ol>
</li>
</ol>
<p>è‡³æ­¤ï¼ŒAå’ŒCå‡å·²å­¦ä¹ åˆ°äº†å¯¹æ–¹çš„MACåœ°å€ã€‚</p>
<h3 id="é›†ä¸­å¼vxlanä¸åŒå­ç½‘äº’é€šæµç¨‹"><a href="#é›†ä¸­å¼vxlanä¸åŒå­ç½‘äº’é€šæµç¨‹" class="headerlink" title="é›†ä¸­å¼vxlanä¸åŒå­ç½‘äº’é€šæµç¨‹"></a>é›†ä¸­å¼vxlanä¸åŒå­ç½‘äº’é€šæµç¨‹</h3><p><img src="https://rancho333.github.io/pictures/vxlan_l3_ct.png"></p>
<p>Aã€Båˆ†å±ä¸åŒç½‘æ®µï¼Œä¸”åˆ†åˆ«å±äºVNI 5000å’ŒVNI 6000ã€‚Aã€Bå¯¹åº”çš„ä¸‰å±‚ç½‘å…³åˆ†åˆ«æ˜¯VTEP_3ä¸Šçš„BDIF 10å’ŒBDIF 20çš„IPåœ°å€ã€‚VTEP_3ä¸Šå­˜åœ¨åˆ°ä¸¤ä¸ªç½‘æ®µçš„è·¯ç”±ã€‚</p>
<p>BDIFæ¥å£çš„åŠŸèƒ½ä¸VLAN IFæ¥å£ç±»ä¼¼ï¼Œæ˜¯åŸºäºBDåˆ›å»ºçš„ä¸‰å±‚é€»è¾‘æ¥å£ï¼Œç”¨ä»¥å®ç°ä¸åŒå­ç½‘ä¹‹é—´çš„é€šä¿¡ï¼Œæˆ–vxlanç½‘ç»œä¸évxlanç½‘ç»œä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>å¯¹äºé¦–æ¬¡é€šä¿¡ï¼Œç±»æ¯”ä¸underlayç½‘ç»œä¸­è·¨ç½‘æ®µé€šä¿¡ã€‚Aè¯·æ±‚ç½‘å…³BDIF 10 MACï¼Œç„¶åå°†æ•°æ®åŒ…å‘é€ç»™ç½‘å…³BDIF 10ï¼ŒBDIF 10å°†æ•°æ®åŒ…è·¯ç”±è‡³BDIF 20ï¼ŒBDIF 20è¯·æ±‚Bçš„MACï¼Œç„¶åå°†æ•°æ®åŒ…å‘é€ç»™Bã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_l3_arp.png"></p>
<p>æ•°æ®æŠ¥æ–‡è½¬å‘æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>Aå°†æ•°æ®æŠ¥æ–‡å‘é€ç»™ç½‘å…³ã€‚æŠ¥æ–‡çš„æºMACæ˜¯A MACï¼Œç›®çš„MACæ˜¯ç½‘ç®¡BDIF 10çš„MACï¼›æŠ¥æ–‡çš„æºIPæ˜¯Açš„IPï¼Œç›®çš„IPæ˜¯Bçš„IP</li>
<li>VTEP_1æ”¶åˆ°æ•°æ®æŠ¥æ–‡ä¹‹åï¼Œè¯†åˆ«æŠ¥æ–‡æ‰€å±çš„VNIï¼Œå¹¶æ ¹æ®MACè¡¨é¡¹å¯¹æŠ¥æ–‡è¿›è¡Œå°è£…<ol>
<li>å¤–å±‚æºIPåœ°å€ä¸ºæœ¬åœ°VTEPçš„IPï¼Œå¤–å±‚ç›®çš„IPåœ°å€ä¸ºå¯¹ç«¯VTEPçš„IP</li>
<li>å¤–å±‚æºMACåœ°å€ä¸ºæœ¬åœ°VTEPçš„MACåœ°å€ï¼Œå¤–å±‚ç›®çš„MACåœ°å€ä¸ºä¸‹ä¸€è·³è®¾å¤‡çš„IPåœ°å€</li>
<li>å°è£…ä¹‹åå†underlayç½‘ç»œä¸­ä¼ é€è‡³ç›®çš„VTEP</li>
</ol>
</li>
<li>VTEP_3æ”¶åˆ°æŠ¥æ–‡ä¹‹åï¼Œå¯¹æŠ¥æ–‡è¿›è¡Œè§£å°è£…ã€‚å¾—åˆ°Aå‘é€çš„åŸå§‹æŠ¥æ–‡ï¼ŒVTEP_3ä¼šæŠ¥æ–‡ä¼šåšå¦‚ä¸‹å¤„ç†ï¼š<ol>
<li>VTEP_3å‘ç°è¯¥æŠ¥æ–‡çš„ç›®çš„MACä¸ºæœ¬æœºBDIF 10æ¥å£çš„MACï¼Œè€Œç›®çš„IPä¸ºBçš„IPï¼Œæ‰€ä»¥ä¼šæ ¹æ®è·¯ç”±è¡¨æŸ¥æ‰¾Bçš„ä¸‹ä¸€è·³</li>
<li>å‘ç°ä¸‹ä¸€è·³çš„å‡ºæ¥å£ä¸ºBDIF 20ã€‚VETP_3æŸ¥è¯¢ARPè¡¨é¡¹ï¼Œå°†åŸå§‹æŠ¥æ–‡çš„æºMACä¿®æ”¹ä¸ºBDIF 20æ¥å£çš„MACï¼Œå°†ç›®çš„MACä¿®æ”¹ä¸ºBçš„MAC</li>
<li>æŠ¥æ–‡åˆ°BDIF 20åï¼Œè¯†åˆ«éœ€è¦è¿›å…¥vxlanéš§é“ï¼Œæ‰€ä»¥æ ¹æ®MACè¡¨å¯¹æŠ¥æ–‡è¿›è¡Œå°è£…ã€‚<ol>
<li>å¤–å±‚æºIPä¸ºæœ¬åœ°VTEPçš„IPï¼Œå¤–å±‚ç›®çš„IPåœ°å€ä¸ºå¯¹ç«¯VTEPçš„IP</li>
<li>å¤–å±‚æºMACåœ°å€ä¸ºæœ¬åœ°VTEPçš„MACï¼Œå¤–å±‚ç›®çš„MACä¸ºå»å¾€ç›®çš„IPç½‘ç»œçš„ä¸‹ä¸€è·³è®¾å¤‡çš„MACåœ°å€</li>
<li>å°è£…ä¹‹åå†underlayç½‘ç»œä¸­ä¼ é€è‡³ç›®çš„VTEP</li>
</ol>
</li>
</ol>
</li>
<li>VETP_2æ”¶åˆ°æŠ¥æ–‡ä¹‹åï¼Œå¯¹æŠ¥æ–‡è¿›è¡Œè§£å°è£…ï¼Œå°†overlayæŠ¥æ–‡å‘é€ç»™B</li>
</ol>
<p>vxlanç½‘ç»œä¸évxlanç½‘ç»œä¹‹é—´çš„äº’é€šï¼Œä¹Ÿéœ€è¦å€ŸåŠ©ä¸‰å±‚ç½‘å…³ï¼Œä½†æ˜¯ä¸åŒåœ¨äºï¼šæŠ¥æ–‡åœ¨vxlanç½‘ç»œä¾§ä¼šè¿›è¡Œå°è£…ï¼Œè€Œåœ¨évxlanç½‘ç»œä¾§ä¸éœ€è¦è¿›è¡Œå°è£…ã€‚æŠ¥æ–‡ä»vxlanä¾§è¿›å…¥ç½‘å…³å¹¶è§£å°åï¼Œå°±æŒ‰ç…§æ™®é€šå•æ’­æŠ¥æ–‡çš„å‘é€æ–¹å¼è¿›è¡Œè½¬å‘ã€‚</p>
<h2 id="overlayç½‘ç»œçš„ä¸‰ç§æ„å»ºæ¨¡å¼"><a href="#overlayç½‘ç»œçš„ä¸‰ç§æ„å»ºæ¨¡å¼" class="headerlink" title="overlayç½‘ç»œçš„ä¸‰ç§æ„å»ºæ¨¡å¼"></a>overlayç½‘ç»œçš„ä¸‰ç§æ„å»ºæ¨¡å¼</h2><p>åœ¨æ•°æ®ä¸­å¿ƒï¼Œéƒ¨åˆ†ä¸šåŠ¡ä¸é€‚åˆè¿›è¡Œè™šæ‹ŸåŒ–(å¦‚å°æœºæœåŠ¡å™¨ï¼Œé«˜æ€§èƒ½æ•°æ®åº“æœåŠ¡å™¨),è¿™äº›æœåŠ¡å™¨ä¼šç›´æ¥ä¸ç‰©ç†äº¤æ¢æœºäº’è”ï¼›å¯¹äºæœåŠ¡å™¨(è™šæ‹Ÿæœº)ï¼Œæ¥å…¥çš„å¯ä»¥æ˜¯è™šæ‹Ÿäº¤æ¢æœº(OpenvSwitch),ä¹Ÿå¯ä»¥æ˜¯ç‰©ç†äº¤æ¢æœºï¼Œå› æ­¤å­˜åœ¨å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä¸‰ç§æ¥å…¥æ¨¡å‹ã€‚</p>
<p><img src="https://rancho333.github.io/pictures/vxlan_network_module_2.png"></p>
<p>ä»¥ä¸Šï¼Œåœ¨network overlayæ–¹æ¡ˆä¸­ï¼Œæ‰€æœ‰ç»ˆç«¯å‡é‡‡ç”¨ç‰©ç†äº¤æ¢æœºä½œä¸ºVTEPèŠ‚ç‚¹ï¼›host overlayæ–¹æ¡ˆä¸­ï¼Œæ‰€æœ‰ç»ˆç«¯å‡é‡‡ç”¨è™šæ‹Ÿäº¤æ¢æœºä½œä¸ºVTEPèŠ‚ç‚¹ï¼›hybird overlayæ–¹æ¡ˆä¸­ï¼Œæ—¢æœ‰ç‰©ç†äº¤æ¢æœºæ¥å…¥ï¼Œåˆæœ‰è™šæ‹Ÿäº¤æ¢æœºæ¥å…¥ï¼Œä¸”è½¯ä»¶VTEPå’Œç¡¬ä»¶VTEPä¹‹é—´å¯ä»¥åŸºäºæ ‡å‡†åè®®äº’é€šã€‚</p>
<h2 id="vxlanä¸SDN"><a href="#vxlanä¸SDN" class="headerlink" title="vxlanä¸SDN"></a>vxlanä¸SDN</h2><p>vxlanåªå®šä¹‰äº†è½¬å‘å¹³é¢çš„æµç¨‹ï¼Œå¯¹äºæ§åˆ¶å¹³é¢è¿˜æ²¡æœ‰è§„èŒƒï¼Œä¸€èˆ¬é‡‡å–ä¸‰ç§æ–¹å¼ï¼š</p>
<ol>
<li>ç»„æ’­ã€‚ç”±ç‰©ç†ç½‘ç»œçš„ç»„æ’­åè®®å½¢æˆç»„æ’­è¡¨é¡¹ï¼Œé€šè¿‡æ‰‹å·¥æ–¹å¼å°†ä¸åŒçš„vxlanä¸ç»„æ’­ç»„ä¸€ä¸€ç»‘å®šã€‚vxlançš„æŠ¥æ–‡é€šè¿‡ç»‘å®šçš„ç»„æ’­ç»„åœ¨ç»„æ’­å¯¹åº”çš„èŒƒå›´å†…è¿›è¡Œæ³›æ´ª</li>
<li>è‡ªå®šä¹‰åè®®ã€‚é€šè¿‡è‡ªå®šä¹‰çš„é‚»å±…å‘ç°åè®®å­¦ä¹ overlayç½‘ç»œçš„æ‹“æ‰‘ç»“æ„å¹¶å»ºç«‹éš§é“ç®¡ç†æœºåˆ¶ï¼Œæ¯”å¦‚ç°åœ¨å¹¿æ³›åº”ç”¨çš„BGP-EVPN</li>
<li>SDNæ§åˆ¶å™¨ã€‚é€šè¿‡SDNæ§åˆ¶å™¨é›†ä¸­æ§åˆ¶vxlançš„è½¬å‘ï¼Œç»ç”±openflowåè®®ä¸‹å‘è¡¨é¡¹æ˜¯ç›®å‰ä¸šç•Œçš„ä¸»æµæ–¹å¼</li>
</ol>
<h1 id="EVPNå­¦ä¹ "><a href="#EVPNå­¦ä¹ " class="headerlink" title="EVPNå­¦ä¹ "></a>EVPNå­¦ä¹ </h1><h2 id="EVPNçš„ä½œç”¨"><a href="#EVPNçš„ä½œç”¨" class="headerlink" title="EVPNçš„ä½œç”¨"></a>EVPNçš„ä½œç”¨</h2><p>æœ€åˆçš„vxlanæ–¹æ¡ˆ(RFC7348)ä¸­æ²¡æœ‰å®šä¹‰æ§åˆ¶å¹³é¢ï¼Œæ˜¯æ‰‹å·¥é…ç½®éš§é“ï¼Œç„¶åé€šè¿‡æµé‡æ³›æ´ªçš„æ–¹å¼è¿›è¡Œä¸»æœºåœ°å€çš„å­¦ä¹ ã€‚è¿™ä¼šå¯¼è‡´ç½‘ç»œä¸­å­˜åœ¨å¾ˆå¤šæ³›æ´ªæµé‡ã€ç½‘ç»œæ‰©å±•èµ·æ¥å¾ˆéš¾ã€‚</p>
]]></content>
      <tags>
        <tag>é€šä¿¡åè®®</tag>
        <tag>vxlan</tag>
      </tags>
  </entry>
</search>
